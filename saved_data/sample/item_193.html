<!DOCTYPE html><html><div class="item-title">
        Item 193
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [FLINK-5542][yarn] Use YarnCluster vcores setting to do MaxVCore validation.
                </div><div><b>message:</b> [FLINK-5542][yarn] Use YarnCluster vcores setting to do MaxVCore validation.

This closes #6775.

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li><li><div><div><b>title:</b> [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
                </div><div><b>body:</b> ## What is the purpose of the change

See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)

use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.


## Brief change log

- *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*

## Verifying this change

This change is a trivial rework / code cleanup without any test coverage.
But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
	

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
  - The S3 file system connector: (no)

## Documentation

  - Does this pull request introduce a new feature? (no)
  - If yes, how is the feature documented? (not documented)

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                cc @rehevkor5 @tillrohrmann 
              </div></li><li><div>
                Thanks for your review. @tillrohrmann 
Resolved your comment. Looking forward for further work at FLINK community. About the proposal you mentioned on having a exhaustive check on job submission, I will try go through more submit scenarios and see what we can do to achieve the exhaustive check goal and create a new follow up issue, thanks.
              </div></li><li><div>
                All checks passed, ready to merge. @tillrohrmann @GJL 
              </div></li><li><div>
                Hi, I am taking a look now.
              </div></li><li><div>
                @GJL resolved yours comments.
              </div></li><li><div>
                LGTM, merging as soon as build is green.
              </div></li><li><div>
                @GJL Kindly remind. Build is ready to go.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Maybe reword: "The number of requested virtual cores per node %d exceeds the maximum number virtual cores %d available in the Yarn cluster."
              </div></li><li><div>
                How about:
```
		final int numYarnMaxVcores;
		try {
			numYarnMaxVcores = yarnClient.getNodeReports(NodeState.RUNNING)
				.stream()
				.mapToInt(report -&gt; report.getCapability().getVirtualCores())
				.max()
				.orElse(0);
		} catch (Exception e) {
			throw new YarnDeploymentException("Couldn't get cluster description, please check on the YarnConfiguration", e);
		}
```
?

Pros of doing so:
- `numYarnMaxVcores` is final
- If no NodeManagers are running at all, we would log `0` vcores instead of `Integer.MIN_VALUE`
- Concise &amp; easy to read
              </div></li><li><div>
                I think it  should be: [...] _maximum number **of** virtual cores_ [...]
              </div></li><li><div>
                this way sure better than mine. I will do the update, thanks @GJL 
              </div></li><li><div><div><b>body:</b> resolved exception msg typo
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                update done and passed local verification
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> YARN client incorrectly uses local YARN config to check vcore capacity
                </div><div><b>description:</b> See http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html

When using bin/yarn-session.sh, AbstractYarnClusterDescriptor line 271 in 1.1.4 is comparing the user's selected number of vcores to the vcores configured in the local node's YARN config (from YarnConfiguration eg. yarn-site.xml and yarn-default.xml). It incorrectly prevents Flink from launching even if there is sufficient vcore capacity on the cluster.

That is not correct, because the application will not necessarily run on the local node. For example, if running the yarn-session.sh client from the AWS EMR master node, the vcore count there may be different from the vcore count on the core nodes where Flink will actually run.

A reasonable way to fix this would probably be to reuse the logic from "yarn-session.sh -q" (FlinkYarnSessionCli line 550) which knows how to get vcore information from the real worker nodes.  Alternatively, perhaps we could remove the check entirely and rely on YARN's Scheduler to determine whether sufficient resources exist.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                leanken opened a new pull request #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775
 
 
   ## What is the purpose of the change
   
   See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)
   
   use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.
   
   
   ## Brief change log
   
   - *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*
   
   ## Verifying this change
   
   This change is a trivial rework / code cleanup without any test coverage.
   But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
   	
   
   ## Does this pull request potentially affect one of the following parts:
   
     - Dependencies (does it add or upgrade a dependency): (no)
     - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
     - The serializers: (no)
     - The runtime per-record code paths (performance sensitive): (no)
     - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
     - The S3 file system connector: (no)
   
   ## Documentation
   
     - Does this pull request introduce a new feature? (no)
     - If yes, how is the feature documented? (not documented)
   

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                Hi.

[~rehevkor5]&nbsp; and [~till.rohrmann], Please help review on this&nbsp;minimal PR. Thanks in advanced.
              </div></li><li><div>
                leanken commented on issue #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#issuecomment-425609144
 
 
   cc @rehevkor5 @tillrohrmann 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                tillrohrmann commented on a change in pull request #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#discussion_r223209376
 
 

 ##########
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
 ##########
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr
 		}
 
 		// Check if we don't exceed YARN's maximum virtual cores.
-		// The number of cores can be configured in the config.
-		// If not configured, it is set to the number of task slots
-		int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient
+		int numYarnMaxVcores = Integer.MIN_VALUE;
+		try {
+			List&lt;NodeReport&gt; nodes = yarnClient.getNodeReports(NodeState.RUNNING);
+			for (NodeReport rep : nodes) {
+				final Resource res = rep.getCapability();
+				if (res.getVirtualCores() &gt; numYarnMaxVcores) {
+					numYarnMaxVcores = res.getVirtualCores();
+				}
+			}
+		} catch (Exception e) {
+			throw new YarnDeploymentException("Couldn't get cluster description, please check on the YarnConfiguration", e);
+		}
+
 		int configuredVcores = flinkConfiguration.getInteger(YarnConfigOptions.VCORES, clusterSpecification.getSlotsPerTaskManager());
 		// don't configure more than the maximum configured number of vcores
-		if (configuredVcores &gt; numYarnVcores) {
+		if (configuredVcores &gt; numYarnMaxVcores) {
 			throw new IllegalConfigurationException(
 				String.format("The number of virtual cores per node were configured with %d" +
-						" but Yarn only has %d virtual cores available. Please note that the number" +
+						" already exceeds the max vcores %d set on Yarn Cluster. Please note that the number" +
 
 Review comment:
   Maybe reword: "The number of requested virtual cores per node %d exceeds the maximum number virtual cores %d available in the Yarn cluster."

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                leanken commented on issue #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#issuecomment-427659457
 
 
   Thanks for your review. @tillrohrmann 
   Resolved your comment. Looking forward for further work at FLINK community. About the proposal you mentioned on having a exhaustive check on job submission, I will try go through more submit scenarios and see if what we can do to achieve the exhaustive check goal and create a new follow up issue, thanks.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                leanken edited a comment on issue #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#issuecomment-427659457
 
 
   Thanks for your review. @tillrohrmann 
   Resolved your comment. Looking forward for further work at FLINK community. About the proposal you mentioned on having a exhaustive check on job submission, I will try go through more submit scenarios and see what we can do to achieve the exhaustive check goal and create a new follow up issue, thanks.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                leanken commented on issue #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#issuecomment-427707833
 
 
   All checks passed, ready to merge. @tillrohrmann @GJL 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                GJL commented on issue #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#issuecomment-427761358
 
 
   Hi, I am taking a look again.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                GJL closed pull request #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775
 
 
   

This is a PR merged from a forked repository.
As GitHub hides the original diff on merge, it is displayed below for
the sake of provenance:

As this is a foreign pull request (from a fork), the diff is supplied
below (as it won't show otherwise due to GitHub magic):

diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java b/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
index c3ad9f7f42c..31aaadfbfb8 100644
--- a/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
@@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr
 		}
 
 		// Check if we don't exceed YARN's maximum virtual cores.
-		// The number of cores can be configured in the config.
-		// If not configured, it is set to the number of task slots
-		int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient
+		int numYarnMaxVcores = Integer.MIN_VALUE;
+		try {
+			List&lt;NodeReport&gt; nodes = yarnClient.getNodeReports(NodeState.RUNNING);
+			for (NodeReport rep : nodes) {
+				final Resource res = rep.getCapability();
+				if (res.getVirtualCores() &gt; numYarnMaxVcores) {
+					numYarnMaxVcores = res.getVirtualCores();
+				}
+			}
+		} catch (Exception e) {
+			throw new YarnDeploymentException("Couldn't get cluster description, please check on the YarnConfiguration", e);
+		}
+
 		int configuredVcores = flinkConfiguration.getInteger(YarnConfigOptions.VCORES, clusterSpecification.getSlotsPerTaskManager());
 		// don't configure more than the maximum configured number of vcores
-		if (configuredVcores &gt; numYarnVcores) {
+		if (configuredVcores &gt; numYarnMaxVcores) {
 			throw new IllegalConfigurationException(
-				String.format("The number of virtual cores per node were configured with %d" +
-						" but Yarn only has %d virtual cores available. Please note that the number" +
-						" of virtual cores is set to the number of task slots by default unless configured" +
-						" in the Flink config with '%s.'",
-					configuredVcores, numYarnVcores, YarnConfigOptions.VCORES.key()));
+				String.format("The number of requested virtual cores per node %d" +
+						" exceeds the maximum number virtual cores %d available in the Yarn Cluster." +
+						" Please note that the number of virtual cores is set to the number of task slots by default" +
+						" unless configured in the Flink config with '%s.'",
+					configuredVcores, numYarnMaxVcores, YarnConfigOptions.VCORES.key()));
 		}
 
 		// check if required Hadoop environment variables are set. If not, warn user


 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                leanken opened a new pull request #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775
 
 
   ## What is the purpose of the change
   
   See. [FLINK-5542](https://issues.apache.org/jira/browse/FLINK-5542)
   
   use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.
   
   
   ## Brief change log
   
   - *Fetch MaxVCore num via yarnClient instead of using the local yarn conf*
   
   ## Verifying this change
   
   This change is a trivial rework / code cleanup without any test coverage.
   But I already reproduced the [Error/Exception](http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html), after the fix, it's working as expected.
   	
   
   ## Does this pull request potentially affect one of the following parts:
   
     - Dependencies (does it add or upgrade a dependency): (no)
     - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)
     - The serializers: (no)
     - The runtime per-record code paths (performance sensitive): (no)
     - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)
     - The S3 file system connector: (no)
   
   ## Documentation
   
     - Does this pull request introduce a new feature? (no)
     - If yes, how is the feature documented? (not documented)
   

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                GJL edited a comment on issue #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#issuecomment-427761358
 
 
   Hi, I am taking a looking.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                GJL edited a comment on issue #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#issuecomment-427761358
 
 
   Hi, I am taking a look.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                GJL edited a comment on issue #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#issuecomment-427761358
 
 
   Hi, I am taking a look now.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                GJL commented on a change in pull request #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#discussion_r223300816
 
 

 ##########
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
 ##########
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr
 		}
 
 		// Check if we don't exceed YARN's maximum virtual cores.
-		// The number of cores can be configured in the config.
-		// If not configured, it is set to the number of task slots
-		int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient
+		int numYarnMaxVcores = Integer.MIN_VALUE;
 
 Review comment:
   How about:
   ```
   		final int numYarnMaxVcores;
   		try {
   			numYarnMaxVcores = yarnClient.getNodeReports(NodeState.RUNNING)
   				.stream()
   				.mapToInt(report -&gt; report.getCapability().getVirtualCores())
   				.max()
   				.orElse(0);
   		} catch (Exception e) {
   			throw new YarnDeploymentException("Couldn't get cluster description, please check on the YarnConfiguration", e);
   		}
   ```
   ?
   
   Pros of doing so:
   - `numYarnMaxVcores` is final
   - If no NodeManagers are running at all, we would log `0` vcores instead of `Integer.MIN_VALUE`
   - Concise &amp; easy to read

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                GJL commented on a change in pull request #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#discussion_r223301904
 
 

 ##########
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
 ##########
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr
 		}
 
 		// Check if we don't exceed YARN's maximum virtual cores.
-		// The number of cores can be configured in the config.
-		// If not configured, it is set to the number of task slots
-		int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient
+		int numYarnMaxVcores = Integer.MIN_VALUE;
+		try {
+			List&lt;NodeReport&gt; nodes = yarnClient.getNodeReports(NodeState.RUNNING);
+			for (NodeReport rep : nodes) {
+				final Resource res = rep.getCapability();
+				if (res.getVirtualCores() &gt; numYarnMaxVcores) {
+					numYarnMaxVcores = res.getVirtualCores();
+				}
+			}
+		} catch (Exception e) {
+			throw new YarnDeploymentException("Couldn't get cluster description, please check on the YarnConfiguration", e);
+		}
+
 		int configuredVcores = flinkConfiguration.getInteger(YarnConfigOptions.VCORES, clusterSpecification.getSlotsPerTaskManager());
 		// don't configure more than the maximum configured number of vcores
-		if (configuredVcores &gt; numYarnVcores) {
+		if (configuredVcores &gt; numYarnMaxVcores) {
 			throw new IllegalConfigurationException(
-				String.format("The number of virtual cores per node were configured with %d" +
-						" but Yarn only has %d virtual cores available. Please note that the number" +
-						" of virtual cores is set to the number of task slots by default unless configured" +
-						" in the Flink config with '%s.'",
-					configuredVcores, numYarnVcores, YarnConfigOptions.VCORES.key()));
+				String.format("The number of requested virtual cores per node %d" +
+						" exceeds the maximum number virtual cores %d available in the Yarn Cluster." +
 
 Review comment:
   I think it  should be: [...] _maximum number **of** virtual cores_ [...]

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                leanken commented on a change in pull request #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#discussion_r223303030
 
 

 ##########
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
 ##########
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr
 		}
 
 		// Check if we don't exceed YARN's maximum virtual cores.
-		// The number of cores can be configured in the config.
-		// If not configured, it is set to the number of task slots
-		int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient
+		int numYarnMaxVcores = Integer.MIN_VALUE;
 
 Review comment:
   this way sure better than mine. I will do the update, thanks @GJL 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                leanken commented on a change in pull request #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#discussion_r223309660
 
 

 ##########
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
 ##########
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr
 		}
 
 		// Check if we don't exceed YARN's maximum virtual cores.
-		// The number of cores can be configured in the config.
-		// If not configured, it is set to the number of task slots
-		int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient
+		int numYarnMaxVcores = Integer.MIN_VALUE;
+		try {
+			List&lt;NodeReport&gt; nodes = yarnClient.getNodeReports(NodeState.RUNNING);
+			for (NodeReport rep : nodes) {
+				final Resource res = rep.getCapability();
+				if (res.getVirtualCores() &gt; numYarnMaxVcores) {
+					numYarnMaxVcores = res.getVirtualCores();
+				}
+			}
+		} catch (Exception e) {
+			throw new YarnDeploymentException("Couldn't get cluster description, please check on the YarnConfiguration", e);
+		}
+
 		int configuredVcores = flinkConfiguration.getInteger(YarnConfigOptions.VCORES, clusterSpecification.getSlotsPerTaskManager());
 		// don't configure more than the maximum configured number of vcores
-		if (configuredVcores &gt; numYarnVcores) {
+		if (configuredVcores &gt; numYarnMaxVcores) {
 			throw new IllegalConfigurationException(
-				String.format("The number of virtual cores per node were configured with %d" +
-						" but Yarn only has %d virtual cores available. Please note that the number" +
-						" of virtual cores is set to the number of task slots by default unless configured" +
-						" in the Flink config with '%s.'",
-					configuredVcores, numYarnVcores, YarnConfigOptions.VCORES.key()));
+				String.format("The number of requested virtual cores per node %d" +
+						" exceeds the maximum number virtual cores %d available in the Yarn Cluster." +
 
 Review comment:
   resolved exception msg typo

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                leanken commented on a change in pull request #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#discussion_r223309773
 
 

 ##########
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
 ##########
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr
 		}
 
 		// Check if we don't exceed YARN's maximum virtual cores.
-		// The number of cores can be configured in the config.
-		// If not configured, it is set to the number of task slots
-		int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient
+		int numYarnMaxVcores = Integer.MIN_VALUE;
 
 Review comment:
   update done and passed local verification

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                leanken commented on issue #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#issuecomment-427780528
 
 
   @GJL resolved yours comments.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                GJL commented on issue #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#issuecomment-427871290
 
 
   LGTM, merging as soon as build is green.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                leanken commented on issue #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775#issuecomment-428093652
 
 
   @GJL Kindly remind. Build is ready to go.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                asfgit closed pull request #6775: [FLINK-5542] use YarnCluster vcores setting to do MaxVCore validation
URL: https://github.com/apache/flink/pull/6775
 
 
   

This is a PR merged from a forked repository.
As GitHub hides the original diff on merge, it is displayed below for
the sake of provenance:

As this is a foreign pull request (from a fork), the diff is supplied
below (as it won't show otherwise due to GitHub magic):

diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java b/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
index c3ad9f7f42c..c161e227577 100644
--- a/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java
@@ -282,18 +282,27 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr
 		}
 
 		// Check if we don't exceed YARN's maximum virtual cores.
-		// The number of cores can be configured in the config.
-		// If not configured, it is set to the number of task slots
-		int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient
+		final int numYarnMaxVcores;
+		try {
+			numYarnMaxVcores = yarnClient.getNodeReports(NodeState.RUNNING)
+				.stream()
+				.mapToInt(report -&gt; report.getCapability().getVirtualCores())
+				.max()
+				.orElse(0);
+		} catch (Exception e) {
+			throw new YarnDeploymentException("Couldn't get cluster description, please check on the YarnConfiguration", e);
+		}
+
 		int configuredVcores = flinkConfiguration.getInteger(YarnConfigOptions.VCORES, clusterSpecification.getSlotsPerTaskManager());
 		// don't configure more than the maximum configured number of vcores
-		if (configuredVcores &gt; numYarnVcores) {
+		if (configuredVcores &gt; numYarnMaxVcores) {
 			throw new IllegalConfigurationException(
-				String.format("The number of virtual cores per node were configured with %d" +
-						" but Yarn only has %d virtual cores available. Please note that the number" +
-						" of virtual cores is set to the number of task slots by default unless configured" +
-						" in the Flink config with '%s.'",
-					configuredVcores, numYarnVcores, YarnConfigOptions.VCORES.key()));
+				String.format("The number of requested virtual cores per node %d" +
+						" exceeds the maximum number of virtual cores %d available in the Yarn Cluster." +
+						" Please note that the number of virtual cores is set to the number of task slots by default" +
+						" unless configured in the Flink config with '%s.'",
+					configuredVcores, numYarnMaxVcores, YarnConfigOptions.VCORES.key()));
 		}
 
 		// check if required Hadoop environment variables are set. If not, warn user


 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                fixed via

1.5: 5fb67abd51aca277d1140c274001e89f4bd7cf9a
1.6: 5b3211c6f02cf935308e3ff9ebf9cd1deff24d73
1.7: e959e6d0cd42f0c5b21c0f03ce547f2025ac58d5



              </div></li></ol></div></div></html>