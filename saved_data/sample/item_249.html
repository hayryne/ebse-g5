<!DOCTYPE html><html><div class="item-title">
        Item 249
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> fix: single node state (#2574)
                </div><div><b>message:</b> fix: single node state (#2574)


                </div></div></li></ol></div><div><b>github_issues:</b> <ol><li><div><div><b>title:</b> Unexpected cluster state for single node config
                </div><div><b>body:</b> [NOTE]: # ( ^^ Provide a general summary of the issue in the title above. ^^ )

## Description

With CouchDB 3.x (#2296) we have the option to setup a node as "single node" via config setting. I expected this to have the same effect like using the Fauxton cluster setup UI from CouchDB 2.x.

[NOTE]: # ( Describe the problem you're encountering. )
[TIP]:  # ( Do NOT give us access or passwords to your actual CouchDB! )

Using the new config setting we get the following cluster state at `/_cluster_setup`:

```{"state":"cluster_finished"}```

When using the Fauxton based single node setup, the `/_cluster_setup` endpoint returns:

```{"state":"single_node_enabled"}```

## Steps to Reproduce

[NOTE]: # ( Include commands to reproduce, if possible. curl is preferred. )

```
git clone https://github.com/apache/couchdb-docker
cd couchdb-docker/
echo -e "\n[couchdb]\nsingle_node = true\n" &gt;&gt; dev/local.ini 
docker build -t couchdb:3 dev
docker run --rm -it --env COUCHDB_USER=admin --env COUCHDB_PASSWORD=password -p 5984:5984 couchdb:3
curl --user admin:password -X GET "http://localhost:5984/_cluster_setup" 
```

## Expected Behaviour

[NOTE]: # ( Tell us what you expected to happen. )

`GET /_cluster_setup` should return `single_node_enabled` when the new `couchdb.single_node=true` setting has been used.

## Your Environment

[TIP]:  # ( Include as many relevant details about your environment as possible. )
[TIP]:  # ( You can paste the output of curl http://YOUR-COUCHDB:5984/ here. )

* CouchDB version used: `CouchDB/3.0.0-8748310 (Erlang OTP/21)`
* Operating system and version: Docker image based on [docker-couchdb](https://github.com/apache/couchdb-docker) (`docker build -t couchdb:3 dev`)

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Unexpected cluster state for single node config
                </div><div><b>body:</b> [NOTE]: # ( ^^ Provide a general summary of the issue in the title above. ^^ )

## Description

With CouchDB 3.x (#2296) we have the option to setup a node as "single node" via config setting. I expected this to have the same effect like using the Fauxton cluster setup UI from CouchDB 2.x.

[NOTE]: # ( Describe the problem you're encountering. )
[TIP]:  # ( Do NOT give us access or passwords to your actual CouchDB! )

Using the new config setting we get the following cluster state at `/_cluster_setup`:

```{"state":"cluster_finished"}```

When using the Fauxton based single node setup, the `/_cluster_setup` endpoint returns:

```{"state":"single_node_enabled"}```

## Steps to Reproduce

[NOTE]: # ( Include commands to reproduce, if possible. curl is preferred. )

```
git clone https://github.com/apache/couchdb-docker
cd couchdb-docker/
echo -e "\n[couchdb]\nsingle_node = true\n" &gt;&gt; dev/local.ini 
docker build -t couchdb:3 dev
docker run --rm -it --env COUCHDB_USER=admin --env COUCHDB_PASSWORD=password -p 5984:5984 couchdb:3
curl --user admin:password -X GET "http://localhost:5984/_cluster_setup" 
```

## Expected Behaviour

[NOTE]: # ( Tell us what you expected to happen. )

`GET /_cluster_setup` should return `single_node_enabled` when the new `couchdb.single_node=true` setting has been used.

## Your Environment

[TIP]:  # ( Include as many relevant details about your environment as possible. )
[TIP]:  # ( You can paste the output of curl http://YOUR-COUCHDB:5984/ here. )

* CouchDB version used: `CouchDB/3.0.0-8748310 (Erlang OTP/21)`
* Operating system and version: Docker image based on [docker-couchdb](https://github.com/apache/couchdb-docker) (`docker build -t couchdb:3 dev`)

                </div></div></li><li><div><div><b>title:</b> Unexpected cluster state for single node config
                </div><div><b>body:</b> [NOTE]: # ( ^^ Provide a general summary of the issue in the title above. ^^ )

## Description

With CouchDB 3.x (#2296) we have the option to setup a node as "single node" via config setting. I expected this to have the same effect like using the Fauxton cluster setup UI from CouchDB 2.x.

[NOTE]: # ( Describe the problem you're encountering. )
[TIP]:  # ( Do NOT give us access or passwords to your actual CouchDB! )

Using the new config setting we get the following cluster state at `/_cluster_setup`:

```{"state":"cluster_finished"}```

When using the Fauxton based single node setup, the `/_cluster_setup` endpoint returns:

```{"state":"single_node_enabled"}```

## Steps to Reproduce

[NOTE]: # ( Include commands to reproduce, if possible. curl is preferred. )

```
git clone https://github.com/apache/couchdb-docker
cd couchdb-docker/
echo -e "\n[couchdb]\nsingle_node = true\n" &gt;&gt; dev/local.ini 
docker build -t couchdb:3 dev
docker run --rm -it --env COUCHDB_USER=admin --env COUCHDB_PASSWORD=password -p 5984:5984 couchdb:3
curl --user admin:password -X GET "http://localhost:5984/_cluster_setup" 
```

## Expected Behaviour

[NOTE]: # ( Tell us what you expected to happen. )

`GET /_cluster_setup` should return `single_node_enabled` when the new `couchdb.single_node=true` setting has been used.

## Your Environment

[TIP]:  # ( Include as many relevant details about your environment as possible. )
[TIP]:  # ( You can paste the output of curl http://YOUR-COUCHDB:5984/ here. )

* CouchDB version used: `CouchDB/3.0.0-8748310 (Erlang OTP/21)`
* Operating system and version: Docker image based on [docker-couchdb](https://github.com/apache/couchdb-docker) (`docker build -t couchdb:3 dev`)

                </div></div></li><li><div><div><b>title:</b> Unexpected cluster state for single node config
                </div><div><b>body:</b> [NOTE]: # ( ^^ Provide a general summary of the issue in the title above. ^^ )

## Description

With CouchDB 3.x (#2296) we have the option to setup a node as "single node" via config setting. I expected this to have the same effect like using the Fauxton cluster setup UI from CouchDB 2.x.

[NOTE]: # ( Describe the problem you're encountering. )
[TIP]:  # ( Do NOT give us access or passwords to your actual CouchDB! )

Using the new config setting we get the following cluster state at `/_cluster_setup`:

```{"state":"cluster_finished"}```

When using the Fauxton based single node setup, the `/_cluster_setup` endpoint returns:

```{"state":"single_node_enabled"}```

## Steps to Reproduce

[NOTE]: # ( Include commands to reproduce, if possible. curl is preferred. )

```
git clone https://github.com/apache/couchdb-docker
cd couchdb-docker/
echo -e "\n[couchdb]\nsingle_node = true\n" &gt;&gt; dev/local.ini 
docker build -t couchdb:3 dev
docker run --rm -it --env COUCHDB_USER=admin --env COUCHDB_PASSWORD=password -p 5984:5984 couchdb:3
curl --user admin:password -X GET "http://localhost:5984/_cluster_setup" 
```

## Expected Behaviour

[NOTE]: # ( Tell us what you expected to happen. )

`GET /_cluster_setup` should return `single_node_enabled` when the new `couchdb.single_node=true` setting has been used.

## Your Environment

[TIP]:  # ( Include as many relevant details about your environment as possible. )
[TIP]:  # ( You can paste the output of curl http://YOUR-COUCHDB:5984/ here. )

* CouchDB version used: `CouchDB/3.0.0-8748310 (Erlang OTP/21)`
* Operating system and version: Docker image based on [docker-couchdb](https://github.com/apache/couchdb-docker) (`docker build -t couchdb:3 dev`)

                </div></div></li><li><div><div><b>title:</b> Unexpected cluster state for single node config
                </div><div><b>body:</b> [NOTE]: # ( ^^ Provide a general summary of the issue in the title above. ^^ )

## Description

With CouchDB 3.x (#2296) we have the option to setup a node as "single node" via config setting. I expected this to have the same effect like using the Fauxton cluster setup UI from CouchDB 2.x.

[NOTE]: # ( Describe the problem you're encountering. )
[TIP]:  # ( Do NOT give us access or passwords to your actual CouchDB! )

Using the new config setting we get the following cluster state at `/_cluster_setup`:

```{"state":"cluster_finished"}```

When using the Fauxton based single node setup, the `/_cluster_setup` endpoint returns:

```{"state":"single_node_enabled"}```

## Steps to Reproduce

[NOTE]: # ( Include commands to reproduce, if possible. curl is preferred. )

```
git clone https://github.com/apache/couchdb-docker
cd couchdb-docker/
echo -e "\n[couchdb]\nsingle_node = true\n" &gt;&gt; dev/local.ini 
docker build -t couchdb:3 dev
docker run --rm -it --env COUCHDB_USER=admin --env COUCHDB_PASSWORD=password -p 5984:5984 couchdb:3
curl --user admin:password -X GET "http://localhost:5984/_cluster_setup" 
```

## Expected Behaviour

[NOTE]: # ( Tell us what you expected to happen. )

`GET /_cluster_setup` should return `single_node_enabled` when the new `couchdb.single_node=true` setting has been used.

## Your Environment

[TIP]:  # ( Include as many relevant details about your environment as possible. )
[TIP]:  # ( You can paste the output of curl http://YOUR-COUCHDB:5984/ here. )

* CouchDB version used: `CouchDB/3.0.0-8748310 (Erlang OTP/21)`
* Operating system and version: Docker image based on [docker-couchdb](https://github.com/apache/couchdb-docker) (`docker build -t couchdb:3 dev`)

                </div></div></li><li><div><div><b>title:</b> Unexpected cluster state for single node config
                </div><div><b>body:</b> [NOTE]: # ( ^^ Provide a general summary of the issue in the title above. ^^ )

## Description

With CouchDB 3.x (#2296) we have the option to setup a node as "single node" via config setting. I expected this to have the same effect like using the Fauxton cluster setup UI from CouchDB 2.x.

[NOTE]: # ( Describe the problem you're encountering. )
[TIP]:  # ( Do NOT give us access or passwords to your actual CouchDB! )

Using the new config setting we get the following cluster state at `/_cluster_setup`:

```{"state":"cluster_finished"}```

When using the Fauxton based single node setup, the `/_cluster_setup` endpoint returns:

```{"state":"single_node_enabled"}```

## Steps to Reproduce

[NOTE]: # ( Include commands to reproduce, if possible. curl is preferred. )

```
git clone https://github.com/apache/couchdb-docker
cd couchdb-docker/
echo -e "\n[couchdb]\nsingle_node = true\n" &gt;&gt; dev/local.ini 
docker build -t couchdb:3 dev
docker run --rm -it --env COUCHDB_USER=admin --env COUCHDB_PASSWORD=password -p 5984:5984 couchdb:3
curl --user admin:password -X GET "http://localhost:5984/_cluster_setup" 
```

## Expected Behaviour

[NOTE]: # ( Tell us what you expected to happen. )

`GET /_cluster_setup` should return `single_node_enabled` when the new `couchdb.single_node=true` setting has been used.

## Your Environment

[TIP]:  # ( Include as many relevant details about your environment as possible. )
[TIP]:  # ( You can paste the output of curl http://YOUR-COUCHDB:5984/ here. )

* CouchDB version used: `CouchDB/3.0.0-8748310 (Erlang OTP/21)`
* Operating system and version: Docker image based on [docker-couchdb](https://github.com/apache/couchdb-docker) (`docker build -t couchdb:3 dev`)

                </div></div></li><li><div><div><b>title:</b> Unexpected cluster state for single node config
                </div><div><b>body:</b> [NOTE]: # ( ^^ Provide a general summary of the issue in the title above. ^^ )

## Description

With CouchDB 3.x (#2296) we have the option to setup a node as "single node" via config setting. I expected this to have the same effect like using the Fauxton cluster setup UI from CouchDB 2.x.

[NOTE]: # ( Describe the problem you're encountering. )
[TIP]:  # ( Do NOT give us access or passwords to your actual CouchDB! )

Using the new config setting we get the following cluster state at `/_cluster_setup`:

```{"state":"cluster_finished"}```

When using the Fauxton based single node setup, the `/_cluster_setup` endpoint returns:

```{"state":"single_node_enabled"}```

## Steps to Reproduce

[NOTE]: # ( Include commands to reproduce, if possible. curl is preferred. )

```
git clone https://github.com/apache/couchdb-docker
cd couchdb-docker/
echo -e "\n[couchdb]\nsingle_node = true\n" &gt;&gt; dev/local.ini 
docker build -t couchdb:3 dev
docker run --rm -it --env COUCHDB_USER=admin --env COUCHDB_PASSWORD=password -p 5984:5984 couchdb:3
curl --user admin:password -X GET "http://localhost:5984/_cluster_setup" 
```

## Expected Behaviour

[NOTE]: # ( Tell us what you expected to happen. )

`GET /_cluster_setup` should return `single_node_enabled` when the new `couchdb.single_node=true` setting has been used.

## Your Environment

[TIP]:  # ( Include as many relevant details about your environment as possible. )
[TIP]:  # ( You can paste the output of curl http://YOUR-COUCHDB:5984/ here. )

* CouchDB version used: `CouchDB/3.0.0-8748310 (Erlang OTP/21)`
* Operating system and version: Docker image based on [docker-couchdb](https://github.com/apache/couchdb-docker) (`docker build -t couchdb:3 dev`)

                </div></div></li><li><div><div><b>title:</b> Unexpected cluster state for single node config
                </div><div><b>body:</b> [NOTE]: # ( ^^ Provide a general summary of the issue in the title above. ^^ )

## Description

With CouchDB 3.x (#2296) we have the option to setup a node as "single node" via config setting. I expected this to have the same effect like using the Fauxton cluster setup UI from CouchDB 2.x.

[NOTE]: # ( Describe the problem you're encountering. )
[TIP]:  # ( Do NOT give us access or passwords to your actual CouchDB! )

Using the new config setting we get the following cluster state at `/_cluster_setup`:

```{"state":"cluster_finished"}```

When using the Fauxton based single node setup, the `/_cluster_setup` endpoint returns:

```{"state":"single_node_enabled"}```

## Steps to Reproduce

[NOTE]: # ( Include commands to reproduce, if possible. curl is preferred. )

```
git clone https://github.com/apache/couchdb-docker
cd couchdb-docker/
echo -e "\n[couchdb]\nsingle_node = true\n" &gt;&gt; dev/local.ini 
docker build -t couchdb:3 dev
docker run --rm -it --env COUCHDB_USER=admin --env COUCHDB_PASSWORD=password -p 5984:5984 couchdb:3
curl --user admin:password -X GET "http://localhost:5984/_cluster_setup" 
```

## Expected Behaviour

[NOTE]: # ( Tell us what you expected to happen. )

`GET /_cluster_setup` should return `single_node_enabled` when the new `couchdb.single_node=true` setting has been used.

## Your Environment

[TIP]:  # ( Include as many relevant details about your environment as possible. )
[TIP]:  # ( You can paste the output of curl http://YOUR-COUCHDB:5984/ here. )

* CouchDB version used: `CouchDB/3.0.0-8748310 (Erlang OTP/21)`
* Operating system and version: Docker image based on [docker-couchdb](https://github.com/apache/couchdb-docker) (`docker build -t couchdb:3 dev`)

                </div></div></li><li><div><div><b>title:</b> Unexpected cluster state for single node config
                </div><div><b>body:</b> [NOTE]: # ( ^^ Provide a general summary of the issue in the title above. ^^ )

## Description

With CouchDB 3.x (#2296) we have the option to setup a node as "single node" via config setting. I expected this to have the same effect like using the Fauxton cluster setup UI from CouchDB 2.x.

[NOTE]: # ( Describe the problem you're encountering. )
[TIP]:  # ( Do NOT give us access or passwords to your actual CouchDB! )

Using the new config setting we get the following cluster state at `/_cluster_setup`:

```{"state":"cluster_finished"}```

When using the Fauxton based single node setup, the `/_cluster_setup` endpoint returns:

```{"state":"single_node_enabled"}```

## Steps to Reproduce

[NOTE]: # ( Include commands to reproduce, if possible. curl is preferred. )

```
git clone https://github.com/apache/couchdb-docker
cd couchdb-docker/
echo -e "\n[couchdb]\nsingle_node = true\n" &gt;&gt; dev/local.ini 
docker build -t couchdb:3 dev
docker run --rm -it --env COUCHDB_USER=admin --env COUCHDB_PASSWORD=password -p 5984:5984 couchdb:3
curl --user admin:password -X GET "http://localhost:5984/_cluster_setup" 
```

## Expected Behaviour

[NOTE]: # ( Tell us what you expected to happen. )

`GET /_cluster_setup` should return `single_node_enabled` when the new `couchdb.single_node=true` setting has been used.

## Your Environment

[TIP]:  # ( Include as many relevant details about your environment as possible. )
[TIP]:  # ( You can paste the output of curl http://YOUR-COUCHDB:5984/ here. )

* CouchDB version used: `CouchDB/3.0.0-8748310 (Erlang OTP/21)`
* Operating system and version: Docker image based on [docker-couchdb](https://github.com/apache/couchdb-docker) (`docker build -t couchdb:3 dev`)

                </div></div></li></ol></div><div><b>github_issues_comments:</b> <ol><li><div><div><b>body:</b> Good find! Agreed that this is a little confusing. CouchDB internals don’t really care about cluster vs. single node. A single node just happens to be a cluster of one, hence the confusion. The introduction of the new setting requires one more clause in this function:

https://github.com/apache/couchdb/blob/3f64ef2b98796ba8e0391fb80483502fdafc6a8c/src/setup/src/setup_httpd.erl#L30-L54

It should be easy enough to add, using `config:get_boolean()` like here https://github.com/apache/couchdb/blob/3f64ef2b98796ba8e0391fb80483502fdafc6a8c/src/setup/src/setup_sup.erl#L38

@gesellix wanna try a PR?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                &gt; wanna try a PR?

Oh yes, the code pointers help a lot. I'll try!

              </div></li><li><div>
                Fixed with #2574 - thx @janl!
              </div></li><li><div>
                Not sure if #2574 fixes this issue.

@janl can you confirm that `is_single_node_enabled` will be called in case of a single_node-configured instance?

I think that it won't be called, because `GET /_node/_local/_config` yields `cluster.n = 3` for me. `is_single_node_enabled` will only be called in case of `cluster.n = 1`.

              </div></li><li><div>
                Ah shoot, you're right! Cc @wohali 
              </div></li><li><div>
                Thanks @gesellix 
              </div></li><li><div>
                🙏 you're welcome
              </div></li></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> fix: single node state
                </div><div><b>body:</b> Fixes #2557 sorry @gesellix :)
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>