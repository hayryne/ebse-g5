<!DOCTYPE html><html><div class="item-title">
        Item 340
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
   * Closes up the instance to free up all associated resources. You should try to reuse an Instance as much as you can because there is some location caching
   * stored which will enhance performance.
   * @throws AccumuloException 
   
              </div></li><li><div><div><b>comment:</b>  This method intentionally left blank. Users need to explicitly close Instances if they want things cleaned up nicely.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 NOOP
              </div></li><li><div>
                 NOOP
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> ACCUMULO-1858 Backport ZooKeeper clean up to 1.4 and 1.5.
                </div><div><b>message:</b> ACCUMULO-1858 Backport ZooKeeper clean up to 1.4 and 1.5.

Fix cherry picks two commits:

ACCUMULO-1379 - Adding close() to Instance to assist in freeing up resources

(cherry picked from commit 7da1164d87227960d3e0cfc841f753067e2c0304)

Reason: bugfix
Author: John Vines &lt;jvines@gmail.com&gt;

Differs from original by path changes and leaving out ConditionalWriterTest, which is only in 1.6.0+

----

ACCUMULO-1379 Fix edge cases if error in closing ZooKeeperInstance

(cherry picked from commit 3f6c66ede52cb1fb5a122d7bad06d7978ff0a671)

Reason: bugfix
Author: Christopher Tubbs &lt;ctubbsii@apache.org&gt;

Signed-off-by: Bill Slacum &lt;ujustgotbilld@apache.org&gt;

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Backport fix for Accumulo-1379 PermGen Leak to 1.4 and 1.5
                </div><div><b>description:</b> Apply bug fix for the way zookeeper client is handled in ACCUMULO-1379 to Accumulo versions 1.4 and 1.5.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                attaching review board for backport of patches related to ACCUMULO-1379 to 1.4.

I'm inclined to squash these into a single commit when submitting the patch. People wanting to trace history will have to use the "cherry picked from commit..." links to follow it manually either way. Please let me know if leaving them as two commits is preferable.

Once the 1.4 version is fine by reviewboard, I'll attach it here and work out what's still needed after merging forward to 1.5.

              </div></li><li><div>
                We should not be backporting this until its behavior is actually finalized in a release.
              </div></li><li><div>
                It was a bugfix originally reported against 1.4 and 1.5. Shouldn't we be targeting the fix of said bug against all supported versions as we go?
              </div></li><li><div>
                Attaching patch that provides ACCUMULO-1379 against 1.4 as single commit.
              </div></li><li><div>
                Targeting the bugfix for an older version is fine. No objections here. However, ACCUMULO-1379 is only marked as fixed for 1.6.0, so it is not clear that the fix is appropriate or applicable for the older versions.

The bugfix probably should have been applied to 1.4 and merged forward to 1.6. The important thing is that we need to be consistent. I'd hate to have only a partially complete fix in 1.4 and 1.5, and the implementation we really want only in the latest branch.
              </div></li><li><div><div><b>body:</b> Right exactly. I think originally the work on ACCUMULO-1379 was going to be some retooling of our ZooKeeper stuff, so it targetted 1.6.0. That ended up not happening. Instead it's a much more straightforward bugfix that probably should have targetted 1.4 and been merged forward to 1.6.

I think treating that omission as a bug and then applying future fixes (like ACCUMULO-1889) properly is the easiest way to make sure we remain consistent.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Patch updated per Chris' suggestion. Review board also updated, restarting functional tests.
              </div></li><li><div>
                (patch removed. wrong ticket. :/ )
              </div></li><li><div>
                The ticket is marked as fixed for 1.6, but also as affecting 1.4 and 1.5. The same fix that has been applied to 1.6 may not apply to 1.4/5, but 1.4/5 still have the issue, and so will need _a_ fix, if not the one in 1.6.
              </div></li><li><div>
                So, what's the actual hold up? It seems more appropriate that this is a bug fix overlapping with work done in another ticket. [~ctubbsii] are you concerned about clean history and ticket management, or the efficacy of this fix?
              </div></li><li><div>
                IMO, if we're backporting &amp; improving, just change the ticket name.. If we're splitting up the backport and then improvement, make a new ticket for the improvement portion.
              </div></li><li><div>
                [~bills], I have no outstanding concerns. I was just confused about what was applied when and on which branch, and which ticket was trying to do what.
              </div></li><li><div>
                I have successfully tested Sean's patch today using the simple web application found at https://github.com/jaredwinick/accumulo-1858-test/. The testing applied the patch to the 1.4.3 tag as that is the version currently being used by a customer. I was using Zookeeper 3.3.6 and JBoss 7.1.1. 

The attached ACCUMULO-1858-no-patch.png shows the behavior, prior to the patch being applied, of successive redeploys (https://github.com/jaredwinick/accumulo-1858-test/blob/master/redeploy.sh) until JBoss finally dies with the OOM error. ACCUMULO-1858-patch-close.png shows the behavior with the patch applied. You can see the thread count holding steady over time and GC cleaning up space/classes when needed.

The one caveat we found is that the close() method doesn't block until the ZK threads have actually been shutdown (nor does this look possible with the ZK API). If close() is called and the SevletContextListener.contextDestoryed() method returns immediately, the container starts to clean up resources. There appears to be a race condition between the container cleaning up resources and the ZK SendThread actually shutting down and we have thus repeatedly seen "java.lang.NoClassDefFoundError: org/apache/zookeeper/server/ZooTrace" errors when the ZK thread tries to log a message after the container has already unloaded the ZooTrace class. It appears this situation can be avoided by sleeping for a few seconds after calling close() as seen in https://github.com/jaredwinick/accumulo-1858-test/blob/master/src/main/java/com/koverse/ApplicationServletContextListener.java 

              </div></li><li><div>
                Forgot to mention that this testing was done with the patch for ACCUMULO-1889 applied as well.
              </div></li><li><div><div><b>body:</b> [~jaredwinick] sleeping is a solution for the short term.  Do you have any thoughts on a more long term solution?  Do you think a zookeeper ticket needs to be opened?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> If there's no way for us to ensure the threads have exited before we return, then we should file a ZooKeeper ticket.

Is the sleep really necessary? [~jaredwinick] does the NoClassDefFoundError cause an error in undeploying? Could the work-around for now involve a sleep on the part of the person calling close() if they want to avoid the log message?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                No, the NoClassDefFoundError doesn't seem to cause a problem besides the log message. I definitely agree the sleep should be the responsibility of the user and not the ZooKeeperInstance.

I think this would be a reasonable Zookeeper ticket which I am happy to write up. Without intimate knowledge of their code, it seems like a sendThread.join() and eventThread.join() after line 1304 http://svn.apache.org/viewvc/zookeeper/tags/release-3.3.6/src/java/main/org/apache/zookeeper/ClientCnxn.java?revision=1368082&amp;view=markup would do the trick, right? Either way, the fix I think we would want is to make the ZooKeeper.close() (and internally the ClientCnxn.close()) block until the threads have stopped.

BTW, someone brought this up on the ZK mailing list this summer but didn't get a response http://mail-archives.apache.org/mod_mbox/zookeeper-user/201306.mbox/%3CBAY174-W21494DF40247669DA7B719A89B0@phx.gbl%3E

If you guys think this sounds right, I can write up a ZooKeeper issue referencing the testing done here. I will also verify the behavior on v3.4.5. 
              </div></li><li><div>
                That all sounds correct.
              </div></li><li><div>
                Until this issue is fixed in ZooKeeper, users running an Accumulo client inside a container such as JBoss or Tomcat will need to sleep momentarily after closing the ZooKeeperInstance and before letting the container finishing undeploying the application to avoid potentially seeing a "java.lang.NoClassDefFoundError: org/apache/zookeeper/server/ZooTrace"
              </div></li><li><div><div><b>body:</b> Previous comment was referring to the link to ZOOKEEPER-1816
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                Commit 79d686faa1e477b9cbd80c6f833ece402050b490 in branch refs/heads/1.4.5-SNAPSHOT from [~busbey]
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=79d686f ]

ACCUMULO-1858 Backport ZooKeeper clean up to 1.4 and 1.5.

Fix cherry picks two commits:

ACCUMULO-1379 - Adding close() to Instance to assist in freeing up resources

(cherry picked from commit 7da1164d87227960d3e0cfc841f753067e2c0304)

Reason: bugfix
Author: John Vines &lt;jvines@gmail.com&gt;

Differs from original by path changes and leaving out ConditionalWriterTest, which is only in 1.6.0+

----

ACCUMULO-1379 Fix edge cases if error in closing ZooKeeperInstance

(cherry picked from commit 3f6c66ede52cb1fb5a122d7bad06d7978ff0a671)

Reason: bugfix
Author: Christopher Tubbs &lt;ctubbsii@apache.org&gt;

Signed-off-by: Bill Slacum &lt;ujustgotbilld@apache.org&gt;

              </div></li><li><div>
                Commit 79d686faa1e477b9cbd80c6f833ece402050b490 in branch refs/heads/1.5.1-SNAPSHOT from [~busbey]
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=79d686f ]

ACCUMULO-1858 Backport ZooKeeper clean up to 1.4 and 1.5.

Fix cherry picks two commits:

ACCUMULO-1379 - Adding close() to Instance to assist in freeing up resources

(cherry picked from commit 7da1164d87227960d3e0cfc841f753067e2c0304)

Reason: bugfix
Author: John Vines &lt;jvines@gmail.com&gt;

Differs from original by path changes and leaving out ConditionalWriterTest, which is only in 1.6.0+

----

ACCUMULO-1379 Fix edge cases if error in closing ZooKeeperInstance

(cherry picked from commit 3f6c66ede52cb1fb5a122d7bad06d7978ff0a671)

Reason: bugfix
Author: Christopher Tubbs &lt;ctubbsii@apache.org&gt;

Signed-off-by: Bill Slacum &lt;ujustgotbilld@apache.org&gt;

              </div></li><li><div>
                Commit a7c5b72d3b5b28775106adf87dab2f76f5c1430e in branch refs/heads/1.5.1-SNAPSHOT from Bill Slacum
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=a7c5b72 ]

ACCUMULO-1858 Fixed compilation error from bad merge.

The old merge&amp;push bit me as I was missing a '}'.

              </div></li><li><div>
                Commit a7c5b72d3b5b28775106adf87dab2f76f5c1430e in branch refs/heads/1.6.0-SNAPSHOT from Bill Slacum
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=a7c5b72 ]

ACCUMULO-1858 Fixed compilation error from bad merge.

The old merge&amp;push bit me as I was missing a '}'.

              </div></li><li><div>
                Commit c10ccf375b97c1882d5b89decd701bbdae7f71ef in branch refs/heads/1.6.0-SNAPSHOT from Bill Slacum
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=c10ccf3 ]

Merge remote-tracking branch 'apache-committers/1.5.1-SNAPSHOT' into 1.6.0-SNAPSHOT

Did a merge for ACCUMULO-1858 and picked some "Elser" slack.

Conflicts:
	core/src/main/java/org/apache/accumulo/core/client/ZooKeeperInstance.java
	server/base/src/main/java/org/apache/accumulo/server/client/HdfsZooInstance.java

              </div></li><li><div>
                Commit c10ccf375b97c1882d5b89decd701bbdae7f71ef in branch refs/heads/master from Bill Slacum
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=c10ccf3 ]

Merge remote-tracking branch 'apache-committers/1.5.1-SNAPSHOT' into 1.6.0-SNAPSHOT

Did a merge for ACCUMULO-1858 and picked some "Elser" slack.

Conflicts:
	core/src/main/java/org/apache/accumulo/core/client/ZooKeeperInstance.java
	server/base/src/main/java/org/apache/accumulo/server/client/HdfsZooInstance.java

              </div></li><li><div>
                I believe this can be marked closed now?
              </div></li><li><div>
                Marking resolved.
              </div></li><li><div>
                Commit e946ba052c3fcce8d07815b9daf51bcdc3febbd3 in branch refs/heads/1.4.5-SNAPSHOT from [~keith_turner]
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=e946ba0 ]

ACCUMULO-1858 revert commits that added ZooKeeperInstance.close()

Revert "ACCUMULO-2027 Synchronized access to ZooKeeperInstance methods that mutated state"

This reverts commit 975e8c05e8d11f3848e6c800f4d2772026f6c3a3.

Revert "ACCUMULO-1984 Rework interruption for instance implementations."

This reverts commit 0d0bc4643a8680593e2cf5f828b7566c30fcb345.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooReader.java

Revert "ACCUMULO-1889 mark ZKI as closed once close() is called."

This reverts commit ada4180379d46297c1531cf8065de5030d12953d.

Revert "ACCUMULO-1858 Backport ZooKeeper clean up to 1.4 and 1.5."

This reverts commit 79d686faa1e477b9cbd80c6f833ece402050b490.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java

              </div></li><li><div>
                Commit e946ba052c3fcce8d07815b9daf51bcdc3febbd3 in branch refs/heads/1.4.5-SNAPSHOT from [~keith_turner]
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=e946ba0 ]

ACCUMULO-1858 revert commits that added ZooKeeperInstance.close()

Revert "ACCUMULO-2027 Synchronized access to ZooKeeperInstance methods that mutated state"

This reverts commit 975e8c05e8d11f3848e6c800f4d2772026f6c3a3.

Revert "ACCUMULO-1984 Rework interruption for instance implementations."

This reverts commit 0d0bc4643a8680593e2cf5f828b7566c30fcb345.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooReader.java

Revert "ACCUMULO-1889 mark ZKI as closed once close() is called."

This reverts commit ada4180379d46297c1531cf8065de5030d12953d.

Revert "ACCUMULO-1858 Backport ZooKeeper clean up to 1.4 and 1.5."

This reverts commit 79d686faa1e477b9cbd80c6f833ece402050b490.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java

              </div></li><li><div>
                Commit e946ba052c3fcce8d07815b9daf51bcdc3febbd3 in branch refs/heads/1.5.1-SNAPSHOT from [~keith_turner]
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=e946ba0 ]

ACCUMULO-1858 revert commits that added ZooKeeperInstance.close()

Revert "ACCUMULO-2027 Synchronized access to ZooKeeperInstance methods that mutated state"

This reverts commit 975e8c05e8d11f3848e6c800f4d2772026f6c3a3.

Revert "ACCUMULO-1984 Rework interruption for instance implementations."

This reverts commit 0d0bc4643a8680593e2cf5f828b7566c30fcb345.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooReader.java

Revert "ACCUMULO-1889 mark ZKI as closed once close() is called."

This reverts commit ada4180379d46297c1531cf8065de5030d12953d.

Revert "ACCUMULO-1858 Backport ZooKeeper clean up to 1.4 and 1.5."

This reverts commit 79d686faa1e477b9cbd80c6f833ece402050b490.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java

              </div></li><li><div>
                Commit e946ba052c3fcce8d07815b9daf51bcdc3febbd3 in branch refs/heads/1.5.1-SNAPSHOT from [~keith_turner]
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=e946ba0 ]

ACCUMULO-1858 revert commits that added ZooKeeperInstance.close()

Revert "ACCUMULO-2027 Synchronized access to ZooKeeperInstance methods that mutated state"

This reverts commit 975e8c05e8d11f3848e6c800f4d2772026f6c3a3.

Revert "ACCUMULO-1984 Rework interruption for instance implementations."

This reverts commit 0d0bc4643a8680593e2cf5f828b7566c30fcb345.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooReader.java

Revert "ACCUMULO-1889 mark ZKI as closed once close() is called."

This reverts commit ada4180379d46297c1531cf8065de5030d12953d.

Revert "ACCUMULO-1858 Backport ZooKeeper clean up to 1.4 and 1.5."

This reverts commit 79d686faa1e477b9cbd80c6f833ece402050b490.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java

              </div></li><li><div>
                Commit e946ba052c3fcce8d07815b9daf51bcdc3febbd3 in branch refs/heads/1.6.0-SNAPSHOT from [~keith_turner]
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=e946ba0 ]

ACCUMULO-1858 revert commits that added ZooKeeperInstance.close()

Revert "ACCUMULO-2027 Synchronized access to ZooKeeperInstance methods that mutated state"

This reverts commit 975e8c05e8d11f3848e6c800f4d2772026f6c3a3.

Revert "ACCUMULO-1984 Rework interruption for instance implementations."

This reverts commit 0d0bc4643a8680593e2cf5f828b7566c30fcb345.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooReader.java

Revert "ACCUMULO-1889 mark ZKI as closed once close() is called."

This reverts commit ada4180379d46297c1531cf8065de5030d12953d.

Revert "ACCUMULO-1858 Backport ZooKeeper clean up to 1.4 and 1.5."

This reverts commit 79d686faa1e477b9cbd80c6f833ece402050b490.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java

              </div></li><li><div>
                Commit e946ba052c3fcce8d07815b9daf51bcdc3febbd3 in branch refs/heads/1.6.0-SNAPSHOT from [~keith_turner]
[ https://git-wip-us.apache.org/repos/asf?p=accumulo.git;h=e946ba0 ]

ACCUMULO-1858 revert commits that added ZooKeeperInstance.close()

Revert "ACCUMULO-2027 Synchronized access to ZooKeeperInstance methods that mutated state"

This reverts commit 975e8c05e8d11f3848e6c800f4d2772026f6c3a3.

Revert "ACCUMULO-1984 Rework interruption for instance implementations."

This reverts commit 0d0bc4643a8680593e2cf5f828b7566c30fcb345.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooReader.java

Revert "ACCUMULO-1889 mark ZKI as closed once close() is called."

This reverts commit ada4180379d46297c1531cf8065de5030d12953d.

Revert "ACCUMULO-1858 Backport ZooKeeper clean up to 1.4 and 1.5."

This reverts commit 79d686faa1e477b9cbd80c6f833ece402050b490.

Conflicts:
	src/core/src/main/java/org/apache/accumulo/core/client/Instance.java
	src/core/src/main/java/org/apache/accumulo/core/zookeeper/ZooCache.java

              </div></li></ol></div></div></html>