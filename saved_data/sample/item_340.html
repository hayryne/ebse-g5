<!DOCTYPE html><html><div class="item-title">
        Item 340
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Check Dataflow Job Status Before Terminate
                </div><div><b>message:</b> Check Dataflow Job Status Before Terminate

This closes #951

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> Check Dataflow Job Status Before Terminate
                </div><div><b>body:</b> Be sure to do all of the following to help us incorporate your contribution
quickly and easily:
- [x] Make sure the PR title is formatted like:
  `[BEAM-&lt;Jira issue #&gt;] Description of pull request`
- [x] Make sure tests pass via `mvn clean verify`. (Even better, enable
     Travis-CI on your fork and ensure the whole test matrix passes).
- [x] Replace `&lt;Jira issue #&gt;` in the title with the actual Jira issue
     number, if there is one.
- [ ] If this contribution is large, please file an Apache
     [Individual Contributor License Agreement](https://www.apache.org/licenses/icla.txt).

---

Add job status check before canceling job in order to avoid cancel terminated job and throw exception.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                +R: @peihe

              </div></li><li><div>
                PTAL: @peihe 

              </div></li><li><div>
                LGTM

R: @lukecwik to merge

              </div></li><li><div>
                PTAL @lukecwik

              </div></li><li><div>
                Its easier to review the diff if you make new commits instead of squashing, just mark them with !fixup at the beginning as per the Beam dev guide and they will be squashed when merging

              </div></li><li><div>
                LGTM, merging

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                jobs.update() is not supposed to be called, right?

could you add Mockito.verify()?

              </div></li><li><div>
                Yes, job status should return immediately after status check. But still need to verify Jobs.update() will not be called.

done.

              </div></li><li><div>
                sorry, I meant:
1. remove the mock setup for update.
2. verify all other mocks are executed (also in testCancelUnterminatedJob()).
3. verify(mockJobs, never()).update(any(...), any(...), any(...));

              </div></li><li><div>
                thanks for clarify :)
done.

              </div></li><li><div>
                Are you able to look at the failure reason in addition to checking job state?

This way it closes a race condition where the job reaches a terminal condition between the fetching state and cancel calls

              </div></li><li><div>
                Do you mean that look at the IOException from execute() calls? Got confused how it will help to stop the race condition since the race condition is already happened. Or the "failure reason" means other messages?

              </div></li><li><div>
                It's possible that job status can be changed between fetching state and execute() calls. So one suggestion to avoid this race condition is to make cancel calls whatever job state is and fetching state when Exception is thrown. Return current state if it's terminated, otherwise throw exception. 

              </div></li><li><div>
                Yes, look at the IOException, if it is a failure to cancel because the job is already in a terminal state then you know you don't have to rethrow and can just do the warn message.

              </div></li><li><div>
                done.

              </div></li><li><div>
                you can drop times(1), it is the default

              </div></li><li><div>
                I don't think this is needed for your test anymore since the state check is only done on failure now nor the mocking of job state higher above

              </div></li><li><div>
                I don't think you need this line for your test anymore

              </div></li><li><div>
                add verifyNoMoreInteractions(mockJobs)

              </div></li><li><div>
                add verifyNoMoreInteractions(mockJobs)

              </div></li><li><div>
                You shouldn't need this line anymore

              </div></li><li><div>
                Move this line to be after the execute(), this will prevent coding bugs where default fallthrough returns cancelled status

              </div></li><li><div>
                The concern of keeping it is to make sure the initial state of job is desired. But yes, state check will not be reached in this case. Remove it and the mocking of job state may be better.

              </div></li><li><div>
                done

              </div></li><li><div>
                thanks! done

              </div></li><li><div>
                see, will pay attention to it in future.
done.

              </div></li><li><div>
                done

              </div></li><li><div>
                done

              </div></li><li><div>
                done

              </div></li><li><div>
                see. Thanks for pointed out.
done

              </div></li><li><div>
                When using "when" clauses they are not strict and use functions like any(Job.class)/anyString only using something specific if a different result needs to be returned based upon an input parameter. The "verify" clauses should be the strict ones.

This helps make tests not fail due to NPEs since a null would be returned if the mock call wasn't satisfied and will instead fail with a much cleaner message saying parameters X, Y, and Z were expected but got A, B, and C

This applies to this test and the ones you added below

              </div></li><li><div>
                It's a very good explanation for "when" use case! I spend more time reading about "verify" and "when", and become more clear when/how to use them.

              </div></li><li><div>
                But "verify" can't be used to mock function return. 

How about using any(Job.class)/anyString in "when" clauses and verify the function parameters using "verify" with eq. I think this is what you suggest right?

              </div></li><li><div>
                Yes, that is what I was getting at that you need to use both when and verify. You should use when+any+anyString+... to setup what should be returned and verify+eq+... to ensure that the correct parameters were given.

              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>