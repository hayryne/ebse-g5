<!DOCTYPE html><html><div class="item-title">
        Item 109
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>message:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine

Author: Prateek Maheshwari &lt;pmaheshwari@linkedin.com&gt;

Reviewers: Cameron Lee &lt;calee@linkedin.com&gt;, Shanthoosh Venkatraman &lt;svenkatr@linkedin.com&gt;

Closes #539 from prateekm/store-metrics

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div><div><b>label:</b> test
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>body:</b> 
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                cc @vjagadish1989 @xinyuiscool @sborya for review.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                This prevents deletes from incrementing put metrics.
              </div></li><li><div>
                If someone calls put(key, null) directly, do you still count that as a "put"? If you want to count that as a delete, could you move the "metrics.deletes.inc" into the null case for put(), and just have delete delegate to put(key, null). Or switch the null case for put() to delegate to delete now.
              </div></li><li><div>
                Should the rawStore.putAll() be updating the same metrics as wrappedStore.putAll()? Probably ok since restore just happens during bootstrapping, but just want to double check.
              </div></li><li><div>
                There are multiple places where the putAll metrics are being updated in the same way. Could you consolidate into a "rawPutAll"? Or even have a doPutAll(keyValueStore, batch) which covers the regular putAll also.

              </div></li><li><div><div><b>body:</b> Minor: Should this be "get-alls" for consistency?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Yeah, only happens during bootstrap. We can think of it as counting putAll operations from the KeyValueStorageEngine. Raw store currently does not have any timers, and this class is missing a putAll timer, so I updated it here.
              </div></li><li><div>
                Good catch, thanks.
              </div></li><li><div>
                Either way is fine. One way to interpret these metrics is as call counts to put/delete methods (this PR). Another is to interpret them as DB operations (your suggestion). I can update them to be db operations to be consistent with putAll (it increments puts and deletes as well).
              </div></li><li><div>
                Sure, will do.
              </div></li><li><div>
                Does it makes sense to add metric assertions for new counters to existing `TestKeyValueStorageEngine` test
              </div></li><li><div>
                Does it make sense to update `wrote` counter only in the else part of `putAll` api where we update keys(similar to your change in put api).
              </div></li><li><div><div><b>body:</b> There are no existing tests for getAll/putAll etc. Since this change doesn't change the existing logic, and IMHO metrics update isn't something worth testing by itself, I'd prefer to skip those for now.
                </div><div><b>label:</b> test
                </div></div></li><li><div>
                I was trying to avoid changing existing metrics in this PR, but sure, will change to make it consistent.
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>description:</b> Some of the batch operations (get/put/delete) don't have corresponding counters and timers. We should add them for completeness and consistency with other metrics.

Specifically, a putAll Timer is useful for monitoring changelog restore performance.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine
                </div><div><b>description:</b> Some of the batch operations (get/put/delete) don't have corresponding counters and timers. We should add them for completeness and consistency with other metrics.

Specifically, a putAll Timer is useful for monitoring changelog restore performance.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                GitHub user prateekm opened a pull request:

    https://github.com/apache/samza/pull/539

    SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/prateekm/samza store-metrics

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/samza/pull/539.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #539
    
----
commit 2f6ffb4e1fd482278899e072823980119ca344c3
Author: Prateek Maheshwari &lt;pmaheshwari@...&gt;
Date:   2018-05-30T18:48:40Z

    SAMZA-1736: Add counters and timers for batch get/put/delete operations in KeyValueStorageEngine

----

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/samza/pull/539

              </div></li></ol></div></div></html>