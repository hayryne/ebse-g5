<!DOCTYPE html><html><div class="item-title">
        Item 121
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> CAMEL-6476: Introducing StreamCachingStrategy SPI to make it easier to configure and allow 3rd party to plugin custom strategies.
                </div><div><b>message:</b> CAMEL-6476: Introducing StreamCachingStrategy SPI to make it easier to configure and allow 3rd party to plugin custom strategies.

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> StreamCachingStrategy - A better strategy
                </div><div><b>description:</b> The old stream caching has some flaws such as
- copying the existing stream into an internal buffer/type
- spool to disk by default
- a bit confusing to configure
- wrap based
- not exposed in JMX
- not easy to implement custom strategies

Working on a new strategy that supports
- reusing existing stream if it supports marks *done* (added special for byte array input streams)
- memory based only by default *wontfix* (we leave it backwards compatible as is, ppl can easily turn off overflow to disk now)
- threshold for spooling to disk based on memory usage, and payload sizes *done*
- use the internal camel processor to avoid wrapping *done*
- exposed in JMX with runtime stats *done*
- only enabled if explicit turned on *done*
- log at INFO level on startup if enabled and what settings is in use *done*
- configuring in the DSL with a xxxDefinition to make it stand out in the XML DSLs *done*
- configuring of spool directory supporting ENV and JVM system properties *done*
- avoid the leak from CAMEL-6452 *done*



                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                For streams with no mark support, we could maybe do a copy on-demand, so when we reset, we can read from the copy, and if we didn't read it all, we just switch over to the original stream at point of break. 
              </div></li><li><div>
                
I'm -1 to having it only memory based by default.  That introduces an immediate DOS attack.   64K is likely way too small now, but there definitely needs to be some sort of point at which it either flips to disk or completely stops buffering and throws an IOException.   Waiting for the OutOfMemoryException is not a good idea.



              </div></li><li><div>
                I guess having a configurable threshold value for when to spool would be the best. And to expose this in the DSL when activating streaming for a context.
              </div></li><li><div><div><b>body:</b> Configuration of stream caching is now much easier and more exposed and easier for end users to see/understand.
Update the docs at http://camel.apache.org/stream-caching.html with examples and details.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> There is now a stream caching strategy in place that is backwards compatible.

It has more options and configurations documented at the stream caching docs.
And when starting up Camel we get better INFO logging that its in use (or not) etc.

And there is JMX stats at runtime, and you can alter the threshold at runtime etc.
And you can add your own rules to determine if spooling to disk or not.

The spool to disk is using the existing CachedOutputStream class from 2.11.
Its java.io.File based.

We may in the future look at adding a SPI so ppl can plugin custom stores, if there is faster impls than using the java.io.File and its FileInputStreams.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div></div></html>