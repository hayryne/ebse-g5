<!DOCTYPE html><html><div class="item-title">
        Item 231
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 This is called from the initTransactions method in the producer as the first order of business.
 It finds the coordinator and then gets a PID.
              </div></li><li><div>
                 Send AddOffsetsToTxnRequest
              </div></li><li><div>
                 Send AddPartitionsRequest
              </div></li><li><div>
                 find coordinator
              </div></li><li><div>
                 get pid.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> KAFKA-5260; Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>message:</b> KAFKA-5260; Producer should not send AbortTxn unless transaction has actually begun

Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`

Author: Damian Guy &lt;damian.guy@gmail.com&gt;

Reviewers: Apurva Mehta &lt;apurva@confluent.io&gt;, Guozhang Wang &lt;wangguoz@gmail.com&gt;, Jason Gustafson &lt;jason@confluent.io&gt;

Closes #3126 from dguy/kafka-5260

(cherry picked from commit a8794d8a5d18bb4eaafceac1ef675243af945862)
Signed-off-by: Jason Gustafson &lt;jason@confluent.io&gt;

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>body:</b> Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                @apurvam @hachikuji - This seems to work, though i'm not entirely sure it is correct!
              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/kafka-pr-jdk7-scala2.11/4304/
Test FAILed (JDK 7 and Scala 2.11).

              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/kafka-pr-jdk8-scala2.12/4291/
Test FAILed (JDK 8 and Scala 2.12).

              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/kafka-pr-jdk7-scala2.11/4306/
Test PASSed (JDK 7 and Scala 2.11).

              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/kafka-pr-jdk8-scala2.12/4293/
Test PASSed (JDK 8 and Scala 2.12).

              </div></li><li><div><div><b>body:</b> @apurvam i did start adding another state as you've suggested, though it seemed to be getting pretty messy due to having to check if the currentState is either `STARTED_TRANSACTION` or `IN_TRANSACTION` in multiple places. I'll have another look, but it wasn't really filling me with joy hence the boolean
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                @apurvam i don't think this works by adding another state. The state transitions are happening on the Producers thread, yet we don't know we have successfully completed a transactional request until we get an `AddPartitionsToTxnResponse` or an `AddOffsetsToPartitionResponse`, which is happening on the sender thread. In the meantime the current state may have transitioned to subsequent states _before_ we get these responses. So when it comes to the time when we need to decide if we should send the `EndTxnRequest` we don't have any idea if the transaction was previously in the `STARTING_TRANSACTION` state. I thought adding a `previousState` might help, but no. As there may have been multiple transitions
              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/kafka-pr-jdk7-scala2.11/4385/
Test PASSed (JDK 7 and Scala 2.11).

              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/kafka-pr-jdk8-scala2.12/4371/
Test PASSed (JDK 8 and Scala 2.12).

              </div></li><li><div><div><b>body:</b> @dguy I started typing a really long response, but deleted it. I guess the key point is that if we never transitioned from `STARTING_TRANSACTION` to `IN_TRANSACTION`  at the time of commit or abort, it means that either there are no `send` or `sendOffset` calls attempted, or they have failed. In the former, the additional state will do what we want: if we are committing or aborting in this state, we know there is nothing to do. 

HOwever, if the `AddPartitions` or `AddOffsets` RPCs failed fatally, or have never been successfully acknowledged, we would --correctly-- be in an error state, and hence have no record of whether we ever got out of `STARTING_TRANSACTION` to `IN_TRANSACTION`. 

So either we hack the transitions to the error state, or just maintain the separate variable. I think the separate variable is preferable.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/kafka-pr-jdk7-scala2.11/4444/
Test PASSed (JDK 7 and Scala 2.11).

              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/kafka-pr-jdk8-scala2.12/4430/
Test PASSed (JDK 8 and Scala 2.12).

              </div></li><li><div>
                Actually, it seems that currently `FATAL_ERROR` and `ABORTABLE_ERROR` states are not distinguished. I'm wondering if we can just use `FATAL_ERROR` state and in that state do not send abortTxn?
              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/kafka-pr-jdk7-scala2.11/4479/
Test PASSed (JDK 7 and Scala 2.11).

              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/kafka-pr-jdk8-scala2.12/4465/
Test PASSed (JDK 8 and Scala 2.12).

              </div></li><li><div>
                @guozhangwang The difference between `FATAL_ERROR` and `ABORTABLE_ERROR` is that the former state will throw an exception back at the user even if they try to call `abortTransaction()`. The only possible recovery is closing the producer (see related issue https://issues.apache.org/jira/browse/KAFKA-5342). In some cases, we may reach an abortable error before any partition has been successfully added to the transaction (this is unfortunately the consequence of not having a BeginTxn request). We want the user to call `abortTransaction()` in this case, but we want to avoid sending EndTxn since this would cause an invalid transaction state.

I've been thinking about the current patch for a while and finally it LGTM. The subtle thing is the fact that we'll keep retrying AddPartition failures as long as we get retriable errors. If we receive an abortable error, we'll stop retrying and the EndTxn should reach the head of the queue. Luckily we made the AddPartitions request have all or nothing semantics, so any failure would mean we haven't started the transaction (assuming there were no previous successes).
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                shall we also assert that the result is successful?
              </div></li><li><div>
                Should we also add a test case where there is a real authorization failure and yet the transaction can be aborted?
              </div></li><li><div>
                By authorization failure do you mean topic authorization?

              </div></li><li><div>
                Was this required to get your authorization integration test to work? If so, why?
              </div></li><li><div><div><b>body:</b> Oops, that was me debugging. Will remove it
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>description:</b> When there is an authorization error in AddOffsets or AddPartitions, the producer will raise an authorization exception. When that happens, the user should abort the transaction. The problem is that in an authorization error, the coordinator will not have transitioned to a new state, so if it suddenly receives an AbortTxnRequest, that request will fail with an InvalidTxnState, which will be propagated to the error. The suggested solution is to keep track locally when we are certain that no transaction has been officially begun and to skip sending the AbortTxnRequest in that case.
                </div></div></li><li><div><div><b>summary:</b> Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>description:</b> When there is an authorization error in AddOffsets or AddPartitions, the producer will raise an authorization exception. When that happens, the user should abort the transaction. The problem is that in an authorization error, the coordinator will not have transitioned to a new state, so if it suddenly receives an AbortTxnRequest, that request will fail with an InvalidTxnState, which will be propagated to the error. The suggested solution is to keep track locally when we are certain that no transaction has been officially begun and to skip sending the AbortTxnRequest in that case.
                </div></div></li><li><div><div><b>summary:</b> Producer should not send AbortTxn unless transaction has actually begun
                </div><div><b>description:</b> When there is an authorization error in AddOffsets or AddPartitions, the producer will raise an authorization exception. When that happens, the user should abort the transaction. The problem is that in an authorization error, the coordinator will not have transitioned to a new state, so if it suddenly receives an AbortTxnRequest, that request will fail with an InvalidTxnState, which will be propagated to the error. The suggested solution is to keep track locally when we are certain that no transaction has been officially begun and to skip sending the AbortTxnRequest in that case.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                GitHub user dguy opened a pull request:

    https://github.com/apache/kafka/pull/3126

    KAFKA-5260: Producer should not send AbortTxn unless transaction has actually begun

    Keep track of when a transaction has begun by setting a flag, `transactionStarted` when a successfull `AddPartitionsToTxnResponse` or `AddOffsetsToTxnResponse` had been received. If an `AbortTxnRequest` about to be sent and `transactionStarted` is false, don't send the request and transition the state to `READY`

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/dguy/kafka kafka-5260

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/kafka/pull/3126.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #3126
    
----
commit e8e86e764ddc24d193bcaf0c2ba440a92d0a2534
Author: Damian Guy &lt;damian.guy@gmail.com&gt;
Date:   2017-05-23T11:33:23Z

    don't send AbortTxn unless a transaction is Ongoing

----

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/kafka/pull/3126

              </div></li><li><div>
                Issue resolved by pull request 3126
[https://github.com/apache/kafka/pull/3126]
              </div></li></ol></div></div></html>