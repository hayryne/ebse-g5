<!DOCTYPE html><html><div class="item-title">
        Item 280
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Available for testing
              </div></li><li><div>
                 set replication required parameter
              </div></li><li><div>
                 metadata configs
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> PHOENIX-4575 Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
                </div><div><b>message:</b> PHOENIX-4575 Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
                </div><div><b>description:</b> This is to cater for&nbsp;circumstances where we need to alter state of KEEP_DELETED_CELLS/VERSION on Phoenix meta tables.
                </div></div></li><li><div><div><b>summary:</b> Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
                </div><div><b>description:</b> This is to cater for&nbsp;circumstances where we need to alter state of KEEP_DELETED_CELLS/VERSION on Phoenix meta tables.
                </div></div></li><li><div><div><b>summary:</b> Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
                </div><div><b>description:</b> This is to cater for&nbsp;circumstances where we need to alter state of KEEP_DELETED_CELLS/VERSION on Phoenix meta tables.
                </div></div></li><li><div><div><b>summary:</b> Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
                </div><div><b>description:</b> This is to cater for&nbsp;circumstances where we need to alter state of KEEP_DELETED_CELLS/VERSION on Phoenix meta tables.
                </div></div></li><li><div><div><b>summary:</b> Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
                </div><div><b>description:</b> This is to cater for&nbsp;circumstances where we need to alter state of KEEP_DELETED_CELLS/VERSION on Phoenix meta tables.
                </div></div></li><li><div><div><b>summary:</b> Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
                </div><div><b>description:</b> This is to cater for&nbsp;circumstances where we need to alter state of KEEP_DELETED_CELLS/VERSION on Phoenix meta tables.
                </div></div></li><li><div><div><b>summary:</b> Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
                </div><div><b>description:</b> This is to cater for&nbsp;circumstances where we need to alter state of KEEP_DELETED_CELLS/VERSION on Phoenix meta tables.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
                </div><div><b>description:</b> This is to cater for&nbsp;circumstances where we need to alter state of KEEP_DELETED_CELLS/VERSION on Phoenix meta tables.
                </div></div></li><li><div><div><b>summary:</b> Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
                </div><div><b>description:</b> This is to cater for&nbsp;circumstances where we need to alter state of KEEP_DELETED_CELLS/VERSION on Phoenix meta tables.
                </div></div></li><li><div><div><b>summary:</b> Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
                </div><div><b>description:</b> This is to cater for&nbsp;circumstances where we need to alter state of KEEP_DELETED_CELLS/VERSION on Phoenix meta tables.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Attached patch adds 2 new properties that can be set in hbase-site.xml:&nbsp;
 # phoenix.metadata.keep.deleted.cells
 # phoenix.metadata.max.versions

&nbsp;
              </div></li><li><div>
                Thanks for the patch. Here's some feedback:
- Can we define these new properties attributes in QueryServices and their defaults in QueryServicesOptions instead?
- How about instead of META_DATA_KEEP_DELETED_CELLS we use a name of DEFAULT_SYSTEM_KEEP_DELETED_CELLS_ATTRIB (phoenix.system.default.keep.deleted.cells) as the property name and DEFAULT_SYSTEM_KEEP_DELETED_CELLS = false?
- How about a name of DEFAULT_SYSTEM_MAX_VERSIONS_ATTRIB (phoenix.system.default.max.versions) as the property name and DEFAULT_SYSTEM_MAX_VERSIONS = 1?
- I think you want to set the value of KEEP_DELETED_CELLS to the value of the new DEFAULT_SYSTEM_KEEP_DELETED_CELLS_ATTRIB (i.e. you don't want to set it to the string of property):
{code}
-            HConstants.VERSIONS + "=" + MetaDataProtocol.DEFAULT_MAX_META_DATA_VERSIONS + ",\n" +
-            HColumnDescriptor.KEEP_DELETED_CELLS + "="  + MetaDataProtocol.DEFAULT_META_DATA_KEEP_DELETED_CELLS + ",\n"+
+            HConstants.VERSIONS + "=" + MetaDataProtocol.MAX_META_DATA_VERSIONS + ",\n" +
+            HColumnDescriptor.KEEP_DELETED_CELLS + "="  + MetaDataProtocol.META_DATA_KEEP_DELETED_CELLS + ",\n"+
{code}
- Instead, put %s placeholders in the QueryConstant constant like this:
{code}
    public static final String CREATE_TABLE_METADATA =
            // Do not use IF NOT EXISTS as we sometimes catch the TableAlreadyExists
            // exception and add columns to the SYSTEM.TABLE dynamically.
            "CREATE TABLE " + SYSTEM_CATALOG_SCHEMA + ".\"" + SYSTEM_CATALOG_TABLE + "\"(\n" +
            ...
            HConstants.VERSIONS + "=" + %s + ",\n" +
            HColumnDescriptor.KEEP_DELETED_CELLS + "="  + %s + ",\n" +
            ...
{code}
and modify this method in ConnectionQueryServiceImpl (and ConnectionlessQueryServiceImpl):
{code}
    // Available for testing
    protected String getSystemCatalogDML() {
        return String.format(QueryConstants.CREATE_TABLE_METADATA, 
            props.getInt(DEFAULT_SYSTEM_MAX_VERSIONS_ATTRIB, DEFAULT_SYSTEM_MAX_VERSIONS),
            props.getBoolean(DEFAULT_SYSTEM_KEEP_DELETED_CELLS_ATTRIB, DEFAULT_SYSTEM_KEEP_DELETED_CELLS));
    }
{code}
- Do the same as above for the CREATE_FUNCTION_METADATA constant.
- Remove KEEP_DELETED_CELLS and VERSIONS from CREATE_SEQUENCE_METADATA and CREATE_STATS_TABLE_METADATA as it doesn't make sense for keep deleted cells to be on for these tables.
- Remove this code from ConnectionQueryServicesImpl as it'll like cause issues (and doesn't make sense):
{code}
            if(props.get(QueryServices.DEFAULT_KEEP_DELETED_CELLS_ATTRIB) != null){
                columnDesc.setKeepDeletedCells(props.getBoolean(
                        QueryServices.DEFAULT_KEEP_DELETED_CELLS_ATTRIB, QueryServicesOptions.DEFAULT_KEEP_DELETED_CELLS));
            }
{code}
- Remove the QueryServices.DEFAULT_KEEP_DELETED_CELLS_ATTRIB and QueryServicesOptions.DEFAULT_KEEP_DELETED_CELLS as they won't be referenced any more.
- Remove these properties from MetaDataProtocol:
{code}
    public static final int DEFAULT_MAX_META_DATA_VERSIONS = 1000;
    public static final boolean DEFAULT_META_DATA_KEEP_DELETED_CELLS = true;
    public static final int DEFAULT_MAX_STAT_DATA_VERSIONS = 1;
    public static final boolean DEFAULT_STATS_KEEP_DELETED_CELLS = false;
{code} 

              </div></li><li><div>
                Thanks for the review [~jamestaylor]. Iâ€™ll work on the changes.&nbsp;
              </div></li><li><div>
                [~jamestaylor]&nbsp;FYI attached v2 patch.
              </div></li><li><div>
                [~jamestaylor]
              </div></li><li><div>
                Looks good, except for this change, keep the call to {{scan.setMaxVersions();}}, but just use the empty argument version of it (b/c we want to process all versions):
{code}
--- a/phoenix-core/src/main/java/org/apache/phoenix/util/UpgradeUtil.java
+++ b/phoenix-core/src/main/java/org/apache/phoenix/util/UpgradeUtil.java
@@ -223,7 +223,6 @@ public class UpgradeUtil {
 
         Scan scan = new Scan();
         scan.setRaw(true);
-        scan.setMaxVersions(MetaDataProtocol.DEFAULT_MAX_META_DATA_VERSIONS);
         ResultScanner scanner = null;
         HTableInterface source = null;
         HTableInterface target = null;
@@ -696,7 +695,6 @@ public class UpgradeUtil {
                 boolean success = false;
                 Scan scan = new Scan();
                 scan.setRaw(true);
-                scan.setMaxVersions(MetaDataProtocol.DEFAULT_MAX_META_DATA_VERSIONS);
                 HTableInterface seqTable = conn.getQueryServices().getTable(PhoenixDatabaseMetaData.SYSTEM_SEQUENCE_NAME_BYTES);
                 try {
                     boolean committed = false;
{code}
              </div></li><li><div><div><b>body:</b> [~ckulkarni] - would you mind taking this over? It's ready to go except for one minor nit above (and may need to be rebased). We can get this in with the other couple of JIRAs you've been working on.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                GitHub user ChinmaySKulkarni opened a pull request:

    https://github.com/apache/phoenix/pull/297

    PHOENIX-4575: Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven

    Adds configurable properties for KEEP_DELETED_CELLS and VERSIONS.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/ChinmaySKulkarni/phoenix PHOENIX-4575

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/phoenix/pull/297.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #297
    
----
commit f501bfacde19282cb2084b3afefc52c51b6951cb
Author: Chinmay Kulkarni &lt;chinmayskulkarni@...&gt;
Date:   2018-04-12T07:29:50Z

    PHOENIX-4575: Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be property driven
    
    Adds configurable properties for KEEP_DELETED_CELLS and VERSIONS.

----

              </div></li><li><div>
                Github user ChinmaySKulkarni commented on the issue:

    https://github.com/apache/phoenix/pull/297
  
    @JamesRTaylor please review. Thanks @mujtabachohan for your initial patches. 
    
    - Added nit changes as suggested by James on JIRA
    - Rebased with master
    - @ankitsinghal please check that this does not break anything related to your recent contributions  corresponding to Query Log [PHOENIX-2715](https://issues.apache.org/jira/browse/PHOENIX-2715). 
    Changes are made to SYSLOG ddl statement. "KEEP_DELETED_CELLS" is by default false now (before the default value was true).
    - Ran all UTs in the that are part of PHOENIX-2715 and ran UTs that are relevant to sys table creation and upgrade -&gt; All passed.


              </div></li><li><div>
                Sure [~jamestaylor]. Please review my PR. Thanks!
              </div></li><li><div>
                Github user ChinmaySKulkarni commented on the issue:

    https://github.com/apache/phoenix/pull/297
  
    @JamesRTaylor rebased. @ankitsinghal phoenix build seems to be failing after commit 70c9c6bb2d2073bb40640a0a794032b166c4b63b for PHOENIX-4496. Please take a look.

              </div></li><li><div>
                Github user JamesRTaylor commented on the issue:

    https://github.com/apache/phoenix/pull/297
  
    +1. Thanks for taking this to the finish line, @ChinmaySKulkarni. Is this on top of your patch for PHOENIX-4579? What order should I commit them?

              </div></li><li><div>
                FAILURE: Integrated in Jenkins build Phoenix-4.x-HBase-0.98 #1858 (See [https://builds.apache.org/job/Phoenix-4.x-HBase-0.98/1858/])
PHOENIX-4575 Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be (jtaylor: rev fce9af53423d1804f5dc8daf8f28f9f7b38bbff5)
* (edit) phoenix-core/src/main/java/org/apache/phoenix/util/UpgradeUtil.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/query/QueryServicesOptions.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/coprocessor/MetaDataProtocol.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/query/QueryConstants.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionlessQueryServicesImpl.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/query/QueryServices.java

              </div></li><li><div>
                FAILURE: Integrated in Jenkins build PreCommit-PHOENIX-Build #1930 (See [https://builds.apache.org/job/PreCommit-PHOENIX-Build/1930/])
PHOENIX-4575 Phoenix metadata KEEP_DELETED_CELLS and VERSIONS should be (jtaylor: rev 2a8f0c0fe5b0afd2f154bbf0ad0932abfebdeda8)
* (edit) phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionlessQueryServicesImpl.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/query/QueryServices.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/query/ConnectionQueryServicesImpl.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/query/QueryServicesOptions.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/util/UpgradeUtil.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/coprocessor/MetaDataProtocol.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/query/QueryConstants.java

              </div></li><li><div>
                Github user ChinmaySKulkarni closed the pull request at:

    https://github.com/apache/phoenix/pull/297

              </div></li></ol></div></div></html>