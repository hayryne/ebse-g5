<!DOCTYPE html><html><div class="item-title">
        Item 17
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HBASE-21479 Individual tests in TestHRegionReplayEvents class are failing
                </div><div><b>message:</b> HBASE-21479 Individual tests in TestHRegionReplayEvents class are failing

Signed-off-by: Michael Stack &lt;stack@apache.org&gt;

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Individual tests in TestHRegionReplayEvents class are failing
                </div><div><b>description:</b> The test fails in both master branch and branch-2 :
{code}
testSkippingEditsWithSmallerSeqIdAfterRegionOpenEvent(org.apache.hadoop.hbase.regionserver.TestHRegionReplayEvents)  Time elapsed: 3.74 sec  &lt;&lt;&lt; ERROR!
java.lang.IndexOutOfBoundsException: Index: 2, Size: 1
	at org.apache.hadoop.hbase.regionserver.TestHRegionReplayEvents.testSkippingEditsWithSmallerSeqIdAfterRegionOpenEvent(TestHRegionReplayEvents.java:1042)
{code}
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Progressively stepping back.
At :
9012a0b123b3eea8b08c8687cef812e83e9b491d

Still failing the same way.
              </div></li><li><div><div><b>body:</b> On&nbsp;what environment did you run into this failure? I'm unable to reproduce it using MacOS on branch-2 and master. I can't find&nbsp;TestHRegionReplayEvents on the flaky lists either.
                </div><div><b>label:</b> test
                </div></div></li><li><div>
                {code}
Apache Maven 3.5.4 (1edded0938998edf8bf061f1ceb3cfdeccf443fe; 2018-06-17T18:33:14Z)
Maven home: /apache-maven-3.5.4
Java version: 1.8.0_161, vendor: Oracle Corporation, runtime: /jdk1.8.0_161/jre
Default locale: en_US, platform encoding: UTF-8
OS name: "linux", version: "3.10.0-327.28.3.el7.x86_64", arch: "amd64", family: "unix"
{code}
Here is the command which I used to produce the failure:

mvn clean test -Dtest=TestHRegionReplayEvents#testSkippingEditsWithSmallerSeqIdAfterRegionOpenEvent
              </div></li><li><div>
                Interesting... running the single test method fails but the whole test class succeeds. I'll look into this.
              </div></li><li><div>
                The single test used to pass.
e.g.
243e6cc5293dc1e2a4dfd3af4ee29087c84184c8
              </div></li><li><div>
                My progress so far:

Not only&nbsp;testSkippingEditsWithSmallerSeqIdAfterRegionOpenEvent fails when executed alone but I also found&nbsp;testReplayRegionOpenEventAfterFlushStart which does the same. When these tests are executed after&nbsp;testReplayingFlushRestoresReadsEnabledState both of these tests succeed. When testReplayRegionOpenEventAfterFlushStart started after&nbsp;testSkippingEditsWithSmallerSeqIdAfterRegionOpenEvent the second test passes, first fails.

I mostly debugged&nbsp;testReplayRegionOpenEventAfterFlushStart where I noticed when the WAL entries are replayed the WAL does not have all the events. The test&nbsp;puts 100 rows to table, flushes, puts another 100 records and closes the region. At this point the WAL has records up to 194, 195-199 are missing.
{noformat:title=WAL file last lines, single test execution}
Sequence=200 , region=ba46b889d8a45a1eea5fa23849f788ea at write timestamp=Sun Nov 18 17:06:24 CET 2018
row=193, column=cf1:cq
cell total size sum: 80
row=193, column=cf2:cq
cell total size sum: 80
row=193, column=cf3:cq
cell total size sum: 80
edit heap size: 280
position: 36668
Sequence=201 , region=ba46b889d8a45a1eea5fa23849f788ea at write timestamp=Sun Nov 18 17:06:24 CET 2018
row=194, column=cf1:cq
cell total size sum: 80
row=194, column=cf2:cq
cell total size sum: 80
row=194, column=cf3:cq
cell total size sum: 80
edit heap size: 280
position: 36853{noformat}
&nbsp;
{noformat:title=WAL file last lines, execution with testReplayingFlushRestoresReadsEnabledState}
Sequence=206 , region=1cc10247dac9b10b67635edd2d05d032 at write timestamp=Sun Nov 18 17:01:05 CET 2018
row=199, column=cf1:cq
cell total size sum: 80
row=199, column=cf2:cq
cell total size sum: 80
row=199, column=cf3:cq
cell total size sum: 80
edit heap size: 280
position: 37778
Sequence=208 , region=1cc10247dac9b10b67635edd2d05d032 at write timestamp=Sun Nov 18 17:01:05 CET 2018
row=\x00, column=METAFAMILY:HBASE::FLUSH
cell total size sum: 304
edit heap size: 344
position: 38122
Sequence=209 , region=1cc10247dac9b10b67635edd2d05d032 at write timestamp=Sun Nov 18 17:01:05 CET 2018
row=\x00, column=METAFAMILY:HBASE::FLUSH
cell total size sum: 408
edit heap size: 448
position: 38568
Sequence=210 , region=1cc10247dac9b10b67635edd2d05d032 at write timestamp=Sun Nov 18 17:01:05 CET 2018
row=\x00, column=METAFAMILY:HBASE::REGION_EVENT
cell total size sum: 320
edit heap size: 360
position: 38930
Sequence=212 , region=1cc10247dac9b10b67635edd2d05d032 at write timestamp=Sun Nov 18 17:01:05 CET 2018
row=\x00, column=METAFAMILY:HBASE::REGION_EVENT
cell total size sum: 528
edit heap size: 568
position: 39496
{noformat}
              </div></li><li><div>
                We should log what the filesystem we're writing to is at the stat of each test.

I think these tests are relying on the local filesystem instead of the mini DFS cluster and then falling prey to the fact that the local filesystem implementation from Hadoop doesn't actually flush/sync to disk when you ask it to.
              </div></li><li><div>
                | (/) *{color:green}+1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 12s{color} | {color:blue} Docker mode activated. {color} |
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} hbaseanti {color} | {color:green}  0m  0s{color} | {color:green} Patch does not have any anti-patterns. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 1 new or modified test files. {color} |
|| || || || {color:brown} master Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m 32s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m 57s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  1m  7s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} shadedjars {color} | {color:green}  3m 46s{color} | {color:green} branch has no errors when building our shaded downstream artifacts. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m  3s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 40s{color} | {color:green} master passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  4m  0s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m 47s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  1m 47s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  1m  5s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} shadedjars {color} | {color:green}  3m 49s{color} | {color:green} patch has no errors when building our shaded downstream artifacts. {color} |
| {color:green}+1{color} | {color:green} hadoopcheck {color} | {color:green}  8m 25s{color} | {color:green} Patch does not cause any errors with Hadoop 2.7.4 or 3.0.0. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m  6s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 29s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:green}+1{color} | {color:green} unit {color} | {color:green}131m  3s{color} | {color:green} hbase-server in the patch passed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 28s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black}169m 58s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hbase:b002b0b |
| JIRA Issue | HBASE-21479 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12950173/HBASE-21479-v1.patch |
| Optional Tests |  dupname  asflicense  javac  javadoc  unit  findbugs  shadedjars  hadoopcheck  hbaseanti  checkstyle  compile  |
| uname | Linux 73c4491be61a 4.4.0-138-generic #164-Ubuntu SMP Tue Oct 2 17:16:02 UTC 2018 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /home/jenkins/jenkins-slave/workspace/PreCommit-HBASE-Build/component/dev-support/hbase-personality.sh |
| git revision | master / dfeab9f5c9 |
| maven | version: Apache Maven 3.5.4 (1edded0938998edf8bf061f1ceb3cfdeccf443fe; 2018-06-17T18:33:14Z) |
| Default Java | 1.8.0_181 |
| findbugs | v3.1.0-RC3 |
|  Test Results | https://builds.apache.org/job/PreCommit-HBASE-Build/15158/testReport/ |
| Max. process+thread count | 4934 (vs. ulimit of 10000) |
| modules | C: hbase-server U: hbase-server |
| Console output | https://builds.apache.org/job/PreCommit-HBASE-Build/15158/console |
| Powered by | Apache Yetus 0.8.0   http://yetus.apache.org |


This message was automatically generated.


              </div></li><li><div>
                +1 Try it.
              </div></li><li><div>
                Thanks for reviewing [~stack]!
              </div></li><li><div>
                I did not push it to branch-2.0 because it is not a critical fix, only causing failure when single test method is executed.
              </div></li><li><div>
                Ran TestHRegionReplayEvents#testSkippingEditsWithSmallerSeqIdAfterRegionOpenEvent locally which passed
              </div></li><li><div>
                Results for branch branch-2.1
	[build #651 on builds.a.o|https://builds.apache.org/job/HBase%20Nightly/job/branch-2.1/651/]: (/) *{color:green}+1 overall{color}*
----
details (if available):

(/) {color:green}+1 general checks{color}
-- For more information [see general report|https://builds.apache.org/job/HBase%20Nightly/job/branch-2.1/651//General_Nightly_Build_Report/]




(/) {color:green}+1 jdk8 hadoop2 checks{color}
-- For more information [see jdk8 (hadoop2) report|https://builds.apache.org/job/HBase%20Nightly/job/branch-2.1/651//JDK8_Nightly_Build_Report_(Hadoop2)/]


(/) {color:green}+1 jdk8 hadoop3 checks{color}
-- For more information [see jdk8 (hadoop3) report|https://builds.apache.org/job/HBase%20Nightly/job/branch-2.1/651//JDK8_Nightly_Build_Report_(Hadoop3)/]


(/) {color:green}+1 source release artifact{color}
-- See build output for details.


(/) {color:green}+1 client integration test{color}

              </div></li><li><div>
                Results for branch branch-2
	[build #1535 on builds.a.o|https://builds.apache.org/job/HBase%20Nightly/job/branch-2/1535/]: (x) *{color:red}-1 overall{color}*
----
details (if available):

(/) {color:green}+1 general checks{color}
-- For more information [see general report|https://builds.apache.org/job/HBase%20Nightly/job/branch-2/1535//General_Nightly_Build_Report/]




(x) {color:red}-1 jdk8 hadoop2 checks{color}
-- For more information [see jdk8 (hadoop2) report|https://builds.apache.org/job/HBase%20Nightly/job/branch-2/1535//JDK8_Nightly_Build_Report_(Hadoop2)/]


(/) {color:green}+1 jdk8 hadoop3 checks{color}
-- For more information [see jdk8 (hadoop3) report|https://builds.apache.org/job/HBase%20Nightly/job/branch-2/1535//JDK8_Nightly_Build_Report_(Hadoop3)/]


(/) {color:green}+1 source release artifact{color}
-- See build output for details.


(/) {color:green}+1 client integration test{color}

              </div></li><li><div>
                Results for branch master
	[build #641 on builds.a.o|https://builds.apache.org/job/HBase%20Nightly/job/master/641/]: (x) *{color:red}-1 overall{color}*
----
details (if available):

(/) {color:green}+1 general checks{color}
-- For more information [see general report|https://builds.apache.org/job/HBase%20Nightly/job/master/641//General_Nightly_Build_Report/]




(x) {color:red}-1 jdk8 hadoop2 checks{color}
-- For more information [see jdk8 (hadoop2) report|https://builds.apache.org/job/HBase%20Nightly/job/master/641//JDK8_Nightly_Build_Report_(Hadoop2)/]


(x) {color:red}-1 jdk8 hadoop3 checks{color}
-- For more information [see jdk8 (hadoop3) report|https://builds.apache.org/job/HBase%20Nightly/job/master/641//JDK8_Nightly_Build_Report_(Hadoop3)/]


(/) {color:green}+1 source release artifact{color}
-- See build output for details.


(/) {color:green}+1 client integration test{color}

              </div></li></ol></div></div></html>