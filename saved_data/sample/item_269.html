<!DOCTYPE html><html><div class="item-title">
        Item 269
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 task already deleted from DAG, skip it
              </div></li><li><div>
                 Create an SlaMiss where notification was sent, but email was not
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [AIRFLOW-6576] Fix scheduler crash caused by deleted task with sla misses (#7187)
                </div><div><b>message:</b> [AIRFLOW-6576] Fix scheduler crash caused by deleted task with sla misses (#7187)

When a task with SLA is deleted from a DAG after the SLA miss is logged
but before the notification was sent, scheduler will crash with an
AirflowException

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [AIRFLOW-6576] fix scheduler crash caused by deleted task with sla misses
                </div><div><b>body:</b> ---
Issue link: [AIRFLOW-6576](https://issues.apache.org/jira/browse/AIRFLOW-6576)

Make sure to mark the boxes below before creating PR: [x]

- [x] Description above provides context of the change
- [x] Commit message/PR title starts with `[AIRFLOW-NNNN]`. AIRFLOW-NNNN = JIRA ID&lt;sup&gt;*&lt;/sup&gt;
- [x] Unit tests coverage for changes (not needed for documentation changes)
- [x] Commits follow "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)"
- [x] Relevant documentation is updated including usage instructions.
- [x] I will engage committers as explained in [Contribution Workflow Example](https://github.com/apache/airflow/blob/master/CONTRIBUTING.rst#contribution-workflow-example).

&lt;sup&gt;*&lt;/sup&gt; For document-only changes commit message can start with `[AIRFLOW-XXXX]`.

---
In case of fundamental code change, Airflow Improvement Proposal ([AIP](https://cwiki.apache.org/confluence/display/AIRFLOW/Airflow+Improvements+Proposals)) is needed.
In case of a new dependency, check compliance with the [ASF 3rd Party License Policy](https://www.apache.org/legal/resolved.html#category-x).
In case of backwards incompatible changes please leave a note in [UPDATING.md](https://github.com/apache/airflow/blob/master/UPDATING.md).
Read the [Pull Request Guidelines](https://github.com/apache/airflow/blob/master/CONTRIBUTING.rst#pull-request-guidelines) for more information.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                # [Codecov](https://codecov.io/gh/apache/airflow/pull/7187?src=pr&amp;el=h1) Report
&gt; Merging [#7187](https://codecov.io/gh/apache/airflow/pull/7187?src=pr&amp;el=desc) into [master](https://codecov.io/gh/apache/airflow/commit/59c8a826b8d5d365db68e800cea3de59256530c9?src=pr&amp;el=desc) will **increase** coverage by `0.18%`.
&gt; The diff coverage is `100%`.

[![Impacted file tree graph](https://codecov.io/gh/apache/airflow/pull/7187/graphs/tree.svg?width=650&amp;token=WdLKlKHOAU&amp;height=150&amp;src=pr)](https://codecov.io/gh/apache/airflow/pull/7187?src=pr&amp;el=tree)

```diff
@@            Coverage Diff             @@
##           master    #7187      +/-   ##
==========================================
+ Coverage   84.91%   85.09%   +0.18%     
==========================================
  Files         723      723              
  Lines       39546    39555       +9     
==========================================
+ Hits        33581    33660      +79     
+ Misses       5965     5895      -70
```


| [Impacted Files](https://codecov.io/gh/apache/airflow/pull/7187?src=pr&amp;el=tree) | Coverage Δ | |
|---|---|---|
| [airflow/jobs/scheduler\_job.py](https://codecov.io/gh/apache/airflow/pull/7187/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9qb2JzL3NjaGVkdWxlcl9qb2IucHk=) | `89.45% &lt;100%&gt; (+0.69%)` | :arrow_up: |
| [airflow/kubernetes/volume\_mount.py](https://codecov.io/gh/apache/airflow/pull/7187/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9rdWJlcm5ldGVzL3ZvbHVtZV9tb3VudC5weQ==) | `44.44% &lt;0%&gt; (-55.56%)` | :arrow_down: |
| [airflow/kubernetes/volume.py](https://codecov.io/gh/apache/airflow/pull/7187/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9rdWJlcm5ldGVzL3ZvbHVtZS5weQ==) | `52.94% &lt;0%&gt; (-47.06%)` | :arrow_down: |
| [airflow/kubernetes/pod\_launcher.py](https://codecov.io/gh/apache/airflow/pull/7187/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9rdWJlcm5ldGVzL3BvZF9sYXVuY2hlci5weQ==) | `45.25% &lt;0%&gt; (-46.72%)` | :arrow_down: |
| [airflow/kubernetes/refresh\_config.py](https://codecov.io/gh/apache/airflow/pull/7187/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9rdWJlcm5ldGVzL3JlZnJlc2hfY29uZmlnLnB5) | `50.98% &lt;0%&gt; (-23.53%)` | :arrow_down: |
| [...rflow/contrib/operators/kubernetes\_pod\_operator.py](https://codecov.io/gh/apache/airflow/pull/7187/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9jb250cmliL29wZXJhdG9ycy9rdWJlcm5ldGVzX3BvZF9vcGVyYXRvci5weQ==) | `76.47% &lt;0%&gt; (-22.33%)` | :arrow_down: |
| [airflow/models/connection.py](https://codecov.io/gh/apache/airflow/pull/7187/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9tb2RlbHMvY29ubmVjdGlvbi5weQ==) | `68.78% &lt;0%&gt; (+0.97%)` | :arrow_up: |
| [airflow/jobs/backfill\_job.py](https://codecov.io/gh/apache/airflow/pull/7187/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9qb2JzL2JhY2tmaWxsX2pvYi5weQ==) | `91.88% &lt;0%&gt; (+1.44%)` | :arrow_up: |
| [airflow/providers/apache/hive/hooks/hive.py](https://codecov.io/gh/apache/airflow/pull/7187/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9wcm92aWRlcnMvYXBhY2hlL2hpdmUvaG9va3MvaGl2ZS5weQ==) | `77.55% &lt;0%&gt; (+1.53%)` | :arrow_up: |
| ... and [9 more](https://codecov.io/gh/apache/airflow/pull/7187/diff?src=pr&amp;el=tree-more) | |

------

[Continue to review full report at Codecov](https://codecov.io/gh/apache/airflow/pull/7187?src=pr&amp;el=continue).
&gt; **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)
&gt; `Δ = absolute &lt;relative&gt; (impact)`, `ø = not affected`, `? = missing data`
&gt; Powered by [Codecov](https://codecov.io/gh/apache/airflow/pull/7187?src=pr&amp;el=footer). Last update [59c8a82...23dc8c1](https://codecov.io/gh/apache/airflow/pull/7187?src=pr&amp;el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).

              </div></li><li><div>
                @potiuk added logging, ready for review again.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                We need to write a warning here. It's really dangerous to swallow exceptions silently and it makes it easier to debug any kind of problems you might see in production.
              </div></li><li><div>
                I was going to suggest maybe catching a more specific exception subclass (like `AirflowNotFoundException`, `TaskNotFound`, or `TaskInstanceNotFound` as appropriate), but it looks like we really do just throw `AirflowException` in the method: https://github.com/apache/airflow/blob/master/airflow/models/dag.py#L1214. Changing the exception that `get_task` method raises might be out of scope for this PR and have other unanticipated consequences, but it's something to think about...
              </div></li><li><div>
                Yeah, that's the first thing came to my mind, I expected that method to throw a more specific exception. I think we should have a clean up PR to change that method's behavior.

Ideally, i think it should just return None if the task is not found just like a dictionary. Then the caller can explicitly check for the return and handle the edge-case. This way, we won't run into issues like this going forward.
              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>