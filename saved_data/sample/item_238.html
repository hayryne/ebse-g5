<!DOCTYPE html><html><div class="item-title">
        Item 238
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                * 
              </div></li><li><div>
                * Attribute name. 
              </div></li><li><div>
                *
     * Defines a predicate which returns {@code true} if a node is acceptable for a backup
     * or {@code false} otherwise. An acceptable node is one where its attribute value
     * is exact match with previously selected nodes. If an attribute does not
     * exist on candidate node, then the attribute matches any attribute values of previously
     * selected nodes. If the attribute does not exist on primary node, then the attribute matches
     * any attribute value of candidate node.
     *
     * @param candidate          A node that is a candidate for becoming a backup node for a partition.
     * @param previouslySelected A list of primary/backup nodes already chosen for a partition.
     *                           The primary is first.
     
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
     * @param attrName The attribute name for the attribute to compare.
     
              </div></li><li><div>
                *
 * This class can be used as a {@link RendezvousAffinityFunction#affinityBackupFilter } to create
 * cache templates in Spring that force each partition's primary and backup to be co-located on nodes with the same
 * attribute value.
 * &lt;p&gt;
 *
 * Partition copies co-location can be helpful to group nodes into cells when fixed baseline topology is used. If all
 * copies of each partition are located inside only one cell, in case of {@code backup + 1} nodes leave the cluster
 * there will be data lost only if all leaving nodes belong to the same cell. Without partition copies co-location
 * within a cell, most probably there will be data lost if any {@code backup + 1} nodes leave the cluster.
 *
 * Note: Baseline topology change can lead to inter-cell partitions migration, i.e. rebalance can affect all copies
 * of some partitions even if only one node is changed in the baseline topology.
 * &lt;p&gt;
 *
 * This implementation will discard backups rather than place copies on nodes with different attribute values. This
 * avoids trying to cram more data onto remaining nodes when some have failed.
 * &lt;p&gt;
 * A node attribute to compare is provided on construction. Attribute name shouldn't be null.
 *
 * Note: All cluster nodes, on startup, automatically register all the environment and system properties as node
 * attributes.
 *
 * Note: All nodes should have not an empty co-location attribute value. The absence of the attribute on some nodes
 * will trigger the failure handler.
 *
 * Note: Node attributes persisted in baseline topology at the time of baseline topology change. If the co-location
 * attribute of some node was updated, but the baseline topology wasn't changed, the outdated attribute value can be
 * used by the backup filter when this node left the cluster. To avoid this, the baseline topology should be updated
 * after changing the co-location attribute.
 * &lt;p&gt;
 * This class is constructed with a node attribute name, and a candidate node will be rejected if previously selected
 * nodes for a partition have a different value for attribute on the candidate node.
 * &lt;/pre&gt;
 * &lt;h2 class="header"&gt;Spring Example&lt;/h2&gt;
 * Create a partitioned cache template plate with 1 backup, where the backup will be placed in the same cell
 * as the primary.   Note: This example requires that the environment variable "CELL" be set appropriately on
 * each node via some means external to Ignite.
 * &lt;pre name="code" class="xml"&gt;
 * &amp;lt;property name="cacheConfiguration"&amp;gt;
 *     &amp;lt;list&amp;gt;
 *         &amp;lt;bean id="cache-template-bean" abstract="true" class="org.apache.ignite.configuration.CacheConfiguration"&amp;gt;
 *             &amp;lt;property name="name" value="JobcaseDefaultCacheConfig*"/&amp;gt;
 *             &amp;lt;property name="cacheMode" value="PARTITIONED" /&amp;gt;
 *             &amp;lt;property name="backups" value="1" /&amp;gt;
 *             &amp;lt;property name="affinity"&amp;gt;
 *                 &amp;lt;bean class="org.apache.ignite.cache.affinity.rendezvous.RendezvousAffinityFunction"&amp;gt;
 *                     &amp;lt;property name="affinityBackupFilter"&amp;gt;
 *                         &amp;lt;bean class="org.apache.ignite.cache.affinity.rendezvous.ClusterNodeAttributeColocatedBackupFilter"&amp;gt;
 *                             &amp;lt;!-- Backups must go to the same CELL as primary --&amp;gt;
 *                             &amp;lt;constructor-arg value="CELL" /&amp;gt;
 *                         &amp;lt;/bean&amp;gt;
 *                     &amp;lt;/property&amp;gt;
 *                 &amp;lt;/bean&amp;gt;
 *             &amp;lt;/property&amp;gt;
 *         &amp;lt;/bean&amp;gt;
 *     &amp;lt;/list&amp;gt;
 * &amp;lt;/property&amp;gt;
 * &lt;/pre&gt;
 * &lt;p&gt;
 
              </div></li><li><div>
                *
 * Tests of {@link AffinityFunction} implementations with {@link ClusterNodeAttributeColocatedBackupFilter}.
 
              </div></li><li><div>
                 Join of non-BLT node with the empty attribute should not trigger failure handler.
              </div></li><li><div>
                 Check that not BLT nodes do not affect distribution.
              </div></li><li><div>
                 Include node with the empty attribute to the BLT should trigger failure handler on all nodes.
              </div></li><li><div>
                * {@inheritDoc} 
              </div></li><li><div>
                * 
              </div></li><li><div>
                 Check that we have the same distribution if some BLT nodes are offline.
              </div></li><li><div>
                *
     * Determine split attribute value for each partition and check that this value is the same for all nodes for
     * this partition.
     
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                 Check that distribution is recalculated after BLT change.
              </div></li><li><div>
                 Join of BLT node with the empty attribute should trigger failure handler on this node.
              </div></li><li><div>
                 Wait for rebalance and assignment change to ideal assignment.
              </div></li><li><div>
                * Ignite instance. 
              </div></li><li><div>
                *
     * Start grid with split attribute value.
     *
     * @param gridIdx Grid index.
     * @param splitAttrVal Split attribute value.
     
              </div></li><li><div>
                * Value for filtering nodes by backup filter. 
              </div></li><li><div>
                * Checks that exclude neighbors flag and backup filter works together. 
              </div></li><li><div>
                * With backup filter flag. 
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> IGNITE-13560 Add node attribute colocated affinity backup filter - Fixes #8668.
                </div><div><b>message:</b> IGNITE-13560 Add node attribute colocated affinity backup filter - Fixes #8668.

Signed-off-by: Aleksey Plekhanov &lt;plehanov.alex@gmail.com&gt;

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li><li><div><div><b>title:</b> IGNITE-13560 Add node attribute colocated affinity backup filter
                </div><div><b>body:</b> Thank you for submitting the pull request to the Apache Ignite.

In order to streamline the review of the contribution 
we ask you to ensure the following steps have been taken:

### The Contribution Checklist
- [ ] There is a single JIRA ticket related to the pull request. 
- [ ] The web-link to the pull request is attached to the JIRA ticket.
- [ ] The JIRA ticket has the _Patch Available_ state.
- [ ] The pull request body describes changes that have been made. 
The description explains _WHAT_ and _WHY_ was made instead of _HOW_.
- [ ] The pull request title is treated as the final commit message. 
The following pattern must be used: `IGNITE-XXXX Change summary` where `XXXX` - number of JIRA issue.
- [ ] A reviewer has been mentioned through the JIRA comments 
(see [the Maintainers list](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute#HowtoContribute-ReviewProcessandMaintainers)) 
- [ ] The pull request has been checked by the Teamcity Bot and 
the `green visa` attached to the JIRA ticket (see [TC.Bot: Check PR](https://mtcga.gridgain.com/prs.html))

### Notes
- [How to Contribute](https://cwiki.apache.org/confluence/display/IGNITE/How+to+Contribute)
- [Coding abbreviation rules](https://cwiki.apache.org/confluence/display/IGNITE/Abbreviation+Rules)
- [Coding Guidelines](https://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines)
- [Apache Ignite Teamcity Bot](https://cwiki.apache.org/confluence/display/IGNITE/Apache+Ignite+Teamcity+Bot)

If you need any help, please email dev@ignite.apache.org or ask anу advice on http://asf.slack.com _#ignite_ channel.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                This can be simplfied to 
`return Objects.equals(candidate.attribute(attrName), previouslySelected.get(0).attribute(attrName));`
              </div></li><li><div><div><b>body:</b> Method abbreviations are not allowed by code style.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I strongly suggest to deny null attributes in this filter and add the validation of attribute value existence, otherwise it's possible to lose data if a node was restarted without an attribute due to loss of owners.

Checking not null value and throwing an error to trigger failure handler in case of absence will do.

Javadoc should be modified to reflect a requirement of the attribute.

Even better would be to replace attribute filter closure with something like this for correct attribute validation:
```
/**
 * A basic class for node attribute aware backup filter implementations.
 * Listed attributes are required to be configured on new cluster node joining or first activation.
 */
public abstract class NodeAttributeAwareBackupFilter implements IgniteBiPredicate&lt;ClusterNode, List&lt;ClusterNode&gt;&gt; {
    /** Attribute names. */
    protected final Set&lt;String&gt; attributeNames;

    /**
     * @param attributeNames The list of attribute names for the set of attributes to compare. Must be at least one.
     */
    protected NodeAttributeAwareBackupFilter(String... attributeNames) {
        A.ensure(attributeNames.length &gt; 0, "attributeNames.length &gt; 0");

        this.attributeNames = Collections.unmodifiableSet(new HashSet&lt;&gt;(Arrays.asList(attributeNames)));
    }

    /**
     * @return The set of used cluster node attributes for this filter.
     */
    public Set&lt;String&gt; attributeNames() {
        return attributeNames;
    }
}
```

Ideally attribute values for backup filter should be persisted in the node's metastore to avoid accidental changes (without direct user request), or maybe persisted in cache configuration after cache creation.

These improvements can be done in separate tickets.
              </div></li><li><div>
                Fixed
              </div></li><li><div>
                Fixed
              </div></li><li><div>
                If a node was restarted without an attribute value it will be treated as another cell with an empty attribute value, so, there will be no data lost (but sometimes rebalance). If we will shutdown the nodes by failure handler in case of a node with an empty attribute value joined then all cluster nodes will be failed one by one in some, unexpected to user moment (when the coordinator is changed, or when a new cache is started, or when baseline topology is changed, but not when the node with wrong attribute value joined the cluster). I think it's even worse than allow null attribute values.

I didn't get how the code in this snippet will help to avoid null attribute values. It checks attribute names at construction time, but not attribute values of joined nodes. 

If we will store attribute value in the metastore it will be unclear to the user how to reconfigure it (even with documentation it will be complicated and risky).

              </div></li><li><div><div><b>body:</b> 1. Not agreed on this. I've attached a test reproducing data loss then null attribute is allowed. I want to have some way of protection from this. Data loss or stopped grid, obviously second is "better". Javadoc must contain clear statement on avoiding null values. Not setting it always a user mistake. You should add some tests for FH triggering. It must trigger FH for any case of affinity recalculation on affected cache. Of course, better to have some way for eager validation , see p2.
2. This filter provides a method _attributeNames_, which can be used for attribute value validation on node joining or grid activation.
3. Not true. We have a tool for managing grid called _control.sh_. Attribute management can be implemented here in clear way. 
4. I've attached a test reproducing broken affinity calculation due to absence of proper attribute lifecycle.

I'm ok if 2, 3, 4 will be addressed later, in separate tickets.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Agreed, with null attribute value data loss can happen in some circumstances. But null attribute value it's only one special case of misconfiguration, there are much more such cases exist when misconfiguration can lead to data loss (wrong attribute value for example). 
Also, I think we should not shut down the cluster at some unexpected moment due to misconfigured node joined some time ago. For example, the node with the empty attribute can join during maintenance time and nothing will happen. Later, during high load time coordinator can leave the cluster and at this time all cluster nodes will be stopped by the failure handler one by one.
If we want to handle only a special case of "null attribute value" I have another proposal: allow collocation on null attribute value nodes and any other attribute value nodes, for example, like this:
```
        String primaryAttrVal = previouslySelected.get(0).attribute(attrName);
        String candidateAttrVal = candidate.attribute(attrName);

        return (primaryAttrVal == null || candidateAttrVal == null) || primaryAttrVal.equals(candidateAttrVal);
``` 
In this case, there will be no data loss and the cluster will be available. What do you think? 
              </div></li><li><div>
                This solution doesn't look good to me because it ruins the whole idea of cells.
A user may detect broken data placement later and will be forced to stop grid and reload data to fix it.
From my point of view, the grid stopping is quite predictable, and should only happen on grid activation and node joining (with automatic baseline change) or node addition to baseline. For me, better fail fast in this case when pretend everything is good.
              </div></li><li><div>
                Of course, we should note about avoiding such misconfiguration in javadoc, but, I think, delayed cluster failure is even worse than ruining the cell. It's not necessary to reload the data in case of broken data placement, data will be rebalanced after fixing the configuration. AFAIK node joining without cluster deactivation and baseline change it's a common case, in this case, there will be no affinity recalculation and node failure due to failure handler, but nodes will fail when the coordinator is suddenly changed. Coordinator failure is unpredictable (it can be hardware or software failure), and the whole cluster failure caused by one node failure it's a very undesirable case. Also, there are other cases exist. For example, if there was no attribute defined for some nodes in baseline, but it was defined for online nodes, when such nodes left the grid and coordinator changed there will be the whole cluster failure again. So, if it's happened during high load hours I think it's better to have unexpected rebalancing than unexpected cluster failure. WDYT?
              </div></li><li><div>
                "AFAIK node joining without cluster deactivation and baseline change it's a common case, in this case, there will be no affinity recalculation" - this statement doesn't look correct to me.

Overall, I see no point in arguing further. 
For me, better fail fast when have a grid in unpredictable state.

My statement is the grid will fail fast due to FH on activation if some nodes are misconfigured, or if a new misconfigured node is added to baseline. 

Can you validate this statement? If it's true better stick with my proposal, if not - I'll be ok to have misconfigured nodes grouped with others.
              </div></li><li><div>
                I have just consulted with some Ignite administrators and they confirmed that usually they join nodes to the cluster without deactivation. So at least on some deployments it's possible to get delayed cluster failure.
              </div></li><li><div>
                I've done some tests and found that affinity calculation is also called on a joined node. In case of an empty attribute, it will be detected by the new node first.
So, I've changed the implementation to trigger failure handler in case of the empty attribute value, it will shut down the joined node and there will be no delayed cluster failure.
Please have a look again.
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Add cluster node attribute colocated BackupFilter
                </div><div><b>description:</b> 
                </div></div></li><li><div><div><b>summary:</b> Add cluster node attribute colocated BackupFilter
                </div><div><b>description:</b> 
                </div></div></li><li><div><div><b>summary:</b> Add cluster node attribute colocated BackupFilter
                </div><div><b>description:</b> 
                </div></div></li><li><div><div><b>summary:</b> Add cluster node attribute colocated BackupFilter
                </div><div><b>description:</b> 
                </div></div></li><li><div><div><b>summary:</b> Add cluster node attribute colocated BackupFilter
                </div><div><b>description:</b> 
                </div></div></li><li><div><div><b>summary:</b> Add cluster node attribute colocated BackupFilter
                </div><div><b>description:</b> 
                </div></div></li><li><div><div><b>summary:</b> Add cluster node attribute colocated BackupFilter
                </div><div><b>description:</b> 
                </div></div></li><li><div><div><b>summary:</b> Add cluster node attribute colocated BackupFilter
                </div><div><b>description:</b> 
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                [~ascherbakov], can you please review the patch?
              </div></li><li><div>
                {panel:title=Branch: [pull/8668/head] Base: [master] : No blockers found!|borderStyle=dashed|borderColor=#ccc|titleBGColor=#D6F7C1}{panel}
{panel:title=Branch: [pull/8668/head] Base: [master] : New Tests (4)|borderStyle=dashed|borderColor=#ccc|titleBGColor=#D6F7C1}
{color:#00008b}Cache 2{color} [[tests 4|https://ci.ignite.apache.org/viewLog.html?buildId=5832080]]
* {color:#013220}IgniteCacheTestSuite2: ClusterNodeAttributeColocatedBackupFilterSelfTest.testBackupFilterWithBaseline - PASSED{color}
* {color:#013220}IgniteCacheTestSuite2: ClusterNodeAttributeColocatedBackupFilterSelfTest.testPartitionDistribution - PASSED{color}
* {color:#013220}IgniteCacheTestSuite2: ClusterNodeAttributeColocatedBackupFilterSelfTest.testBackupFilterWithNullAttribute - PASSED{color}
* {color:#013220}IgniteCacheTestSuite2: ClusterNodeAttributeColocatedBackupFilterSelfTest.testPartitionDistributionWithAffinityBackupFilter - PASSED{color}

{panel}
[TeamCity *--&amp;gt; Run :: All* Results|https://ci.ignite.apache.org/viewLog.html?buildId=5828768&amp;amp;buildTypeId=IgniteTests24Java8_RunAll]
              </div></li><li><div>
                [~rynffoll]&nbsp;hi, seems you have been interesting of this.
              </div></li><li><div>
                [~alex_pl]

I've left a few comments in PR.
              </div></li><li><div>
                [~alex_pl]

LGTM
              </div></li><li><div>
                [~ascherbakov], thanks for the review!&nbsp;

Merged to master.
              </div></li></ol></div></div></html>