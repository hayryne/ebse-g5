<!DOCTYPE html><html><div class="item-title">
        Item 42
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
 * Classy class class.
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
 * Classy class class.
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
 * * Buffer index requests into sets to send,
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
     * put request into buffer, retu
     *
     * @param container
     
              </div></li><li><div>
                *
 * Classy class class.
 
              </div></li><li><div>
                
 *
 *  * Licensed to the Apache Software Foundation (ASF) under one or more
 *  *  contributor license agreements.  The ASF licenses this file to You
 *  * under the Apache License, Version 2.0 (the "License"); you may not
 *  * use this file except in compliance with the License.
 *  * You may obtain a copy of the License at
 *  *
 *  *     http://www.apache.org/licenses/LICENSE-2.0
 *  *
 *  * Unless required by applicable law or agreed to in writing, software
 *  * distributed under the License is distributed on an "AS IS" BASIS,
 *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  * See the License for the specific language governing permissions and
 *  * limitations under the License.  For additional information regarding
 *  * copyright in this work, please see the NOTICE file in the top level
 *  * directory of this distribution.
 *
 
              </div></li><li><div>
                *
 * Classy class class.
 
              </div></li><li><div>
                
 *
 *  * Licensed to the Apache Software Foundation (ASF) under one or more
 *  *  contributor license agreements.  The ASF licenses this file to You
 *  * under the Apache License, Version 2.0 (the "License"); you may not
 *  * use this file except in compliance with the License.
 *  * You may obtain a copy of the License at
 *  *
 *  *     http://www.apache.org/licenses/LICENSE-2.0
 *  *
 *  * Unless required by applicable law or agreed to in writing, software
 *  * distributed under the License is distributed on an "AS IS" BASIS,
 *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  * See the License for the specific language governing permissions and
 *  * limitations under the License.  For additional information regarding
 *  * copyright in this work, please see the NOTICE file in the top level
 *  * directory of this distribution.
 *
 
              </div></li><li><div>
                *
     * return operations for the message
     * @return
     
              </div></li><li><div>
                *
     * return the promise
     * @return
     
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
 * Container for index operations.
 
              </div></li><li><div>
                batch shard operations into a bulk request
              </div></li><li><div>
                
 *
 *  * Licensed to the Apache Software Foundation (ASF) under one or more
 *  *  contributor license agreements.  The ASF licenses this file to You
 *  * under the Apache License, Version 2.0 (the "License"); you may not
 *  * use this file except in compliance with the License.
 *  * You may obtain a copy of the License at
 *  *
 *  *     http://www.apache.org/licenses/LICENSE-2.0
 *  *
 *  * Unless required by applicable law or agreed to in writing, software
 *  * distributed under the License is distributed on an "AS IS" BASIS,
 *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  * See the License for the specific language governing permissions and
 *  * limitations under the License.  For additional information regarding
 *  * copyright in this work, please see the NOTICE file in the top level
 *  * directory of this distribution.
 *
 
              </div></li><li><div>
                process and flatten all the messages to builder requests
              </div></li><li><div>
                *
     * initialize request
     * @return
     
              </div></li><li><div>
                *
 * Consumer for IndexOperationMessages
 
              </div></li><li><div>
                *
     * send bulk request
     * @param bulkRequest
     
              </div></li><li><div>
                batch up sets of some size and send them in batch
              </div></li><li><div>
                call back all futures
              </div></li><li><div>
                
 *
 *  * Licensed to the Apache Software Foundation (ASF) under one or more
 *  *  contributor license agreements.  The ASF licenses this file to You
 *  * under the Apache License, Version 2.0 (the "License"); you may not
 *  * use this file except in compliance with the License.
 *  * You may obtain a copy of the License at
 *  *
 *  *     http://www.apache.org/licenses/LICENSE-2.0
 *  *
 *  * Unless required by applicable law or agreed to in writing, software
 *  * distributed under the License is distributed on an "AS IS" BASIS,
 *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  * See the License for the specific language governing permissions and
 *  * limitations under the License.  For additional information regarding
 *  * copyright in this work, please see the NOTICE file in the top level
 *  * directory of this distribution.
 *
 
              </div></li><li><div>
                *
 * Producer for index operation messages
 
              </div></li><li><div>
                *
 * Contains the REST methods to interacting with the ManagementEndpoints
 * and the user feeds
 
              </div></li><li><div>
                
 *
 *  * Licensed to the Apache Software Foundation (ASF) under one or more
 *  *  contributor license agreements.  The ASF licenses this file to You
 *  * under the Apache License, Version 2.0 (the "License"); you may not
 *  * use this file except in compliance with the License.
 *  * You may obtain a copy of the License at
 *  *
 *  *     http://www.apache.org/licenses/LICENSE-2.0
 *  *
 *  * Unless required by applicable law or agreed to in writing, software
 *  * distributed under the License is distributed on an "AS IS" BASIS,
 *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  * See the License for the specific language governing permissions and
 *  * limitations under the License.  For additional information regarding
 *  * copyright in this work, please see the NOTICE file in the top level
 *  * directory of this distribution.
 *
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
 * Relations to the following endpoint
 * /management/users/"username"/password
 * Allows admin users to change their passwords
 
              </div></li><li><div>
                *
 * Relations to the following endpoint
 * /management/users/"username"
 * Store endpoints relating to specific users
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div><div><b>comment:</b>  TODO, in this case we're "optimizing" due to the limitations of collection scope.
 Go through the candidates and group them by scope for more efficient retrieval.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                now everything is ordered, and older versions are removed.  Batch fetch versions to verify
 Get the collection scope and batch load all the versions.  We put all entities in
 app/app for easy retrieval/ unless persistence changes, we never want to read from
              </div></li><li><div>
                 Groups all candidate results by types.  When search connections there will be multiple
              </div></li><li><div>
                 NOTE DO NOT execute the batch here.
              </div></li><li><div>
                need to track all batches then resolve promises
              </div></li><li><div>
                *
     * Request batch size for ES
     * @return
     
              </div></li><li><div>
                *
     * size of the buffer to build up before you send results
     * @return
     
              </div></li><li><div>
                *
     * how long to wait before the buffer flushes to send
     * @return
     
              </div></li><li><div>
                constrained
              </div></li><li><div>
                loop through all batches and retrieve promises and call get
              </div></li><li><div><div><b>comment:</b>  TODO: make this configurable when you add Chop
 number of threads = orgCount x appCount
                </div><div><b>label:</b> requirement
                </div></div></li><li><div>
                this.app().token().post(new Token(username, "testPassword"));
Check that we cannot get the token using the old password
              </div></li><li><div>
                *
     * Check that we cannot change the password by using an older password
     
              </div></li><li><div>
                user_org.apache.usergrid.rest.management.AdminUsersIT.mgmtUserFeed4c3e53e0-acc7-11e4-b527-0b8af3c5813f@usergrid.com"&gt;user_org.apache.usergrid.rest.management.AdminUsersIT.mgmtUserFeed4c3e53e0-acc7-11e4-b527-0b8af3c5813f (user_org.apache.usergrid.rest.management.AdminUsersIT.mgmtUserFeed4c3e53e0-acc7-11e4-b527-0b8af3c5813f@usergrid.com)&lt;/a&gt; created a new organization account named org_org.apache.usergrid.rest.management.AdminUsersIT.mgmtUserFeed4c3ec910-acc7-11e4-94c8-33f0d48a5559
              </div></li><li><div>
                assertNull( getError( node ) );
Get the token using the new password
              </div></li><li><div>
                 Check that we can't change the password using the old password.
              </div></li><li><div>
                Check that we cannot get the token using the old password
              </div></li><li><div>
                        UserInfo mixcaseUser = setup.getMgmtSvc()
                                    .createAdminUser( "AKarasulu", "Alex Karasulu", "AKarasulu@Apache.org", "test", true, false );

        refreshIndex(context.getOrgName(), context.getAppName());

        AuthPrincipalInfo adminPrincipal = new AuthPrincipalInfo(
                AuthPrincipalType.ADMIN_USER, mixcaseUser.getUuid(), UUIDUtils.newTimeUUID() );
        OrganizationInfo organizationInfo =
                setup.getMgmtSvc().createOrganization( "MixedCaseOrg", mixcaseUser, true );

        refreshIndex(context.getOrgName(), context.getAppName());

        String tokenStr = mgmtToken( "akarasulu@apache.org", "test" );
 Should succeed even when we use all lowercase
        JsonNode node = mapper.readTree( resource().path( "/management/users/akarasulu@apache.org" )
                                                   .queryParam( "access_token", tokenStr )
                                                   .accept( MediaType.APPLICATION_JSON )
                                                   .type( MediaType.APPLICATION_JSON_TYPE )
                                                   .get( String.class ));


    @Test
    public void testUnconfirmedAdminLogin() throws Exception {

        // Setup properties to require confirmation of users
        // -------------------------------------------

        Map&lt;String, String&gt; originalProperties = getRemoteTestProperties();

        try {
            setTestProperty( PROPERTIES_SYSADMIN_APPROVES_ADMIN_USERS, "false" );
            setTestProperty( PROPERTIES_SYSADMIN_APPROVES_ORGANIZATIONS, "false" );
            setTestProperty( PROPERTIES_ADMIN_USERS_REQUIRE_CONFIRMATION, "true" );
            setTestProperty( PROPERTIES_SYSADMIN_EMAIL, "sysadmin-1@mockserver.com" );
            setTestProperty( PROPERTIES_NOTIFY_ADMIN_OF_ACTIVATION, "true" );

            assertTrue( setup.getMgmtSvc().newAdminUsersRequireConfirmation() );
            assertFalse( setup.getMgmtSvc().newAdminUsersNeedSysAdminApproval() );

            // Setup org/app/user variables and create them
            // -------------------------------------------
            String orgName = this.getClass().getName();
            String appName = "testUnconfirmedAdminLogin";
            String userName = "TestUser";
            String email = "test-user-46@mockserver.com";
            String passwd = "testpassword";
            OrganizationOwnerInfo orgOwner;

            orgOwner = setup.getMgmtSvc().createOwnerAndOrganization(
                    orgName, userName, appName, email, passwd, false, false );
            assertNotNull( orgOwner );
            String returnedUsername = orgOwner.getOwner().getUsername();
            assertEquals( userName, returnedUsername );

            UserInfo adminUserInfo = setup.getMgmtSvc().getAdminUserByUsername( userName );
            assertNotNull( adminUserInfo );
            assertFalse( "adminUser should not be activated yet", adminUserInfo.isActivated() );
            assertFalse( "adminUser should not be confirmed yet", adminUserInfo.isConfirmed() );

            // Attempt to authenticate but this should fail
            // -------------------------------------------
            JsonNode node;
            try {
                node = mapper.readTree( resource().path( "/management/token" )
                                                  .queryParam( "grant_type", "password" )
                                                  .queryParam( "username", userName )
                                                  .queryParam( "password", passwd )
                                                  .accept( MediaType.APPLICATION_JSON ).get( String.class ));

                fail( "Unconfirmed users should not be authorized to authenticate." );
            }
            catch ( UniformInterfaceException e ) {
                node = mapper.readTree( e.getResponse().getEntity( String.class ));
                assertEquals( "invalid_grant", node.get( "error" ).textValue() );
                assertEquals( "User must be confirmed to authenticate",
                        node.get( "error_description" ).textValue() );
                LOG.info( "Unconfirmed user was not authorized to authenticate!" );
            }

            // Confirm the getting account confirmation email for unconfirmed user
            // -------------------------------------------
            List&lt;Message&gt; inbox = Mailbox.get( email );
            assertFalse( inbox.isEmpty() );

            MockImapClient client = new MockImapClient( "mockserver.com", "test-user-46", "somepassword" );
            client.processMail();

            Message confirmation = inbox.get( 0 );
            assertEquals( "User Account Confirmation: " + email, confirmation.getSubject() );

            // Extract the token to confirm the user
            // -------------------------------------------
            String token = getTokenFromMessage( confirmation );
            LOG.info( token );

            ActivationState state = setup.getMgmtSvc().handleConfirmationTokenForAdminUser(
                    orgOwner.getOwner().getUuid(), token );
            assertEquals( ActivationState.ACTIVATED, state );

            Message activation = inbox.get( 1 );
            assertEquals( "User Account Activated", activation.getSubject() );

            client = new MockImapClient( "mockserver.com", "test-user-46", "somepassword" );
            client.processMail();

            refreshIndex(orgName, appName);

            // Attempt to authenticate again but this time should pass
            // -------------------------------------------

            node = mapper.readTree( resource().path( "/management/token" )
                                              .queryParam( "grant_type", "password" )
                                              .queryParam( "username", userName )
                                              .queryParam( "password", passwd )
                                              .accept( MediaType.APPLICATION_JSON ).get( String.class ));

            assertNotNull( node );
            LOG.info( "Authentication succeeded after confirmation: {}.", node.toString() );
        }
        finally {
            setTestProperties( originalProperties );
        }
    }


    @Test
    public void testSystemAdminNeedsNoConfirmation() throws Exception {

        Map&lt;String, String&gt; originalProperties = getRemoteTestProperties();

        try {
            // require comfirmation of new admin users
            setTestProperty( PROPERTIES_SYSADMIN_APPROVES_ADMIN_USERS, "false" );
            setTestProperty( PROPERTIES_SYSADMIN_APPROVES_ORGANIZATIONS, "false" );
            setTestProperty( PROPERTIES_ADMIN_USERS_REQUIRE_CONFIRMATION, "true" );

            assertTrue( setup.getMgmtSvc().newAdminUsersRequireConfirmation() );
            assertFalse( setup.getMgmtSvc().newAdminUsersNeedSysAdminApproval() );

            String sysadminUsername = ( String ) setup.getMgmtSvc().getProperties()
                                                      .get( AccountCreationProps.PROPERTIES_SYSADMIN_LOGIN_EMAIL );

            String sysadminPassword = ( String ) setup.getMgmtSvc().getProperties()
                                                      .get( AccountCreationProps.PROPERTIES_SYSADMIN_LOGIN_PASSWORD );

            // sysadmin login should suceed despite confirmation setting
            JsonNode node;
            try {
                node = mapper.readTree( resource().path( "/management/token" ).queryParam( "grant_type", "password" )
                                                  .queryParam( "username", sysadminUsername ).queryParam( "password", sysadminPassword )
                                                  .accept( MediaType.APPLICATION_JSON ).get( String.class ));
            }
            catch ( UniformInterfaceException e ) {
                fail( "Sysadmin should need no confirmation" );
            }
        }
        finally {
            setTestProperties( originalProperties );
        }
    }


    @Test
    public void testTestUserNeedsNoConfirmation() throws Exception {

        Map&lt;String, String&gt; originalProperties = getRemoteTestProperties();

        try {
            // require comfirmation of new admin users
            setTestProperty( PROPERTIES_SYSADMIN_APPROVES_ADMIN_USERS, "false" );
            setTestProperty( PROPERTIES_SYSADMIN_APPROVES_ORGANIZATIONS, "false" );
            setTestProperty( PROPERTIES_ADMIN_USERS_REQUIRE_CONFIRMATION, "true" );

            assertTrue( setup.getMgmtSvc().newAdminUsersRequireConfirmation() );
            assertFalse( setup.getMgmtSvc().newAdminUsersNeedSysAdminApproval() );

            String testUserUsername = ( String ) setup.getMgmtSvc().getProperties()
                                                      .get( AccountCreationProps
                                                              .PROPERTIES_TEST_ACCOUNT_ADMIN_USER_EMAIL );

            String testUserPassword = ( String ) setup.getMgmtSvc().getProperties()
                                                      .get( AccountCreationProps
                                                              .PROPERTIES_TEST_ACCOUNT_ADMIN_USER_PASSWORD );

            // test user login should suceed despite confirmation setting
            JsonNode node;
            try {
                node = mapper.readTree( resource().path( "/management/token" ).queryParam( "grant_type", "password" )
                                                  .queryParam( "username", testUserUsername ).queryParam( "password", testUserPassword )
                                                  .accept( MediaType.APPLICATION_JSON ).get( String.class ));
            }
            catch ( UniformInterfaceException e ) {
                fail( "Test User should need no confirmation" );
            }
        }
        finally {
            setTestProperties( originalProperties );
        }
    }


    private String getTokenFromMessage( Message msg ) throws IOException, MessagingException {
        String body = ( ( MimeMultipart ) msg.getContent() ).getBodyPart( 0 ).getContent().toString();
        return StringUtils.substringAfterLast( body, "token=" );
    }


    @Test
    public void updateManagementUser() throws Exception {
        Map&lt;String, String&gt; payload =
                hashMap( "email", "uort-user-1@apigee.com" ).map( "username", "uort-user-1" ).map( "name", "Test User" )
                                                            .map( "password", "password" ).map( "organization", "uort-org" ).map( "company", "Apigee" );

        JsonNode node = mapper.readTree( resource().path( "/management/organizations" ).accept( MediaType.APPLICATION_JSON )
                                                   .type( MediaType.APPLICATION_JSON_TYPE ).post( String.class, payload ));
        logNode( node );
        String userId = node.get( "data" ).get( "owner" ).get( "uuid" ).asText();

        assertEquals( "Apigee", node.get( "data" ).get( "owner" ).get( "properties" ).get( "company" ).asText() );

        String token = mgmtToken( "uort-user-1@apigee.com", "password" );

        node = mapper.readTree( resource().path( String.format( "/management/users/%s", userId ) ).queryParam( "access_token", token )
                                          .type( MediaType.APPLICATION_JSON_TYPE ).get( String.class ));

        logNode( node );

        payload = hashMap( "company", "Usergrid" );
        LOG.info( "sending PUT for company update" );
        node = mapper.readTree( resource().path( String.format( "/management/users/%s", userId ) ).queryParam( "access_token", token )
                                          .type( MediaType.APPLICATION_JSON_TYPE ).put( String.class, payload ));
        assertNotNull( node );
        node = mapper.readTree( resource().path( String.format( "/management/users/%s", userId ) ).queryParam( "access_token", token )
                                          .type( MediaType.APPLICATION_JSON_TYPE ).get( String.class ));
        assertEquals( "Usergrid", node.get( "data" ).get( "properties" ).get( "company" ).asText() );


        logNode( node );
    }


    @Test
    public void getUser() throws Exception {

        // set an organization property
        HashMap&lt;String, Object&gt; payload = new HashMap&lt;String, Object&gt;();
        Map&lt;String, Object&gt; properties = new HashMap&lt;String, Object&gt;();
        properties.put( "securityLevel", 5 );
        payload.put( OrganizationsResource.ORGANIZATION_PROPERTIES, properties );


        /**
         * Get the original org admin before we overwrite the property as a super user
         */
        final TestUser orgAdmin = context.getActiveUser();
        final String orgName = context.getOrgName();
        final String superAdminToken = superAdminToken();

        TestAdminUser superAdmin = new TestAdminUser( "super", "super", "superuser@usergrid.com" );
        superAdmin.setToken( superAdminToken );

        Organization org = context.withUser( superAdmin ).management().orgs().organization( orgName );

        org.put( payload );


        //now get the org
        JsonNode node = context.withUser( orgAdmin ).management().users().user( orgAdmin.getUser() ).get();

        logNode( node );

        JsonNode applications = node.findValue( "applications" );
        assertNotNull( applications );
        JsonNode users = node.findValue( "users" );
        assertNotNull( users );

        JsonNode securityLevel = node.findValue( "securityLevel" );
        assertNotNull( securityLevel );
        assertEquals( 5L, securityLevel.asLong() );
    }


    @Test
    public void getUserShallow() throws Exception {


        // set an organization property
        HashMap&lt;String, Object&gt; payload = new HashMap&lt;String, Object&gt;();
        Map&lt;String, Object&gt; properties = new HashMap&lt;String, Object&gt;();
        properties.put( "securityLevel", 5 );
        payload.put( OrganizationsResource.ORGANIZATION_PROPERTIES, properties );


        /**
         * Get the original org admin before we overwrite the property as a super user
         */
        final TestUser orgAdmin = context.getActiveUser();
        final String orgName = context.getOrgName();
        final String superAdminToken  = superAdminToken();

        TestAdminUser superAdmin = new TestAdminUser( "super", "super", "superuser@usergrid.com" );
        superAdmin.setToken( superAdminToken );

        Organization org = context.withUser( superAdmin ).management().orgs().organization( orgName );

        org.put( payload );


        //now get the org
        JsonNode node = context.withUser( orgAdmin ).management().users().user( orgAdmin.getUser() ).withParam(
                "shallow", "true" ).get();

        logNode( node );

        JsonNode applications = node.findValue( "applications" );
        assertNull( applications );
        JsonNode users = node.findValue( "users" );
        assertNull( users );

        JsonNode securityLevel = node.findValue( "securityLevel" );
        assertNotNull( securityLevel );
        assertEquals( 5L, securityLevel.asLong() );
    }


    @Test
    public void reactivateMultipleSend() throws Exception {

        JsonNode node = mapper.readTree( resource().path( "/management/organizations" ).accept( MediaType.APPLICATION_JSON )
                                                   .type( MediaType.APPLICATION_JSON_TYPE ).post( String.class, buildOrgUserPayload( "reactivate" ) ));

        logNode( node );
        String email = node.get( "data" ).get( "owner" ).get( "email" ).asText();
        String uuid = node.get( "data" ).get( "owner" ).get( "uuid" ).asText();
        assertNotNull( email );
        assertEquals( "MUUserResourceIT-reactivate@apigee.com", email );

        refreshIndex(context.getOrgName(), context.getAppName());

        // reactivate should send activation email

        node = mapper.readTree( resource().path( String.format( "/management/users/%s/reactivate", uuid ) )
                                          .queryParam( "access_token", adminAccessToken ).accept( MediaType.APPLICATION_JSON )
                                          .type( MediaType.APPLICATION_JSON_TYPE ).get( String.class ));

        refreshIndex(context.getOrgName(), context.getAppName());

        List&lt;Message&gt; inbox = org.jvnet.mock_javamail.Mailbox.get( email );

        assertFalse( inbox.isEmpty() );
        logNode( node );
    }


    private Map&lt;String, String&gt; buildOrgUserPayload( String caller ) {
        String className = this.getClass().getSimpleName();
        Map&lt;String, String&gt; payload = hashMap( "email", String.format( "%s-%s@apigee.com", className, caller ) )
                .map( "username", String.format( "%s-%s-user", className, caller ) )
                .map( "name", String.format( "%s %s", className, caller ) ).map( "password", "password" )
                .map( "organization", String.format( "%s-%s-org", className, caller ) );
        return payload;
    }


    @Test
    public void checkPasswordReset() throws Exception {

        refreshIndex(context.getOrgName(), context.getAppName());

        TestUser user = context.getActiveUser();

        String email = user.getEmail();
        UserInfo userInfo = setup.getMgmtSvc().getAdminUserByEmail( email );
        String resetToken = setup.getMgmtSvc().getPasswordResetTokenForAdminUser( userInfo.getUuid(), 15000 );

        assertTrue( setup.getMgmtSvc().checkPasswordResetTokenForAdminUser( userInfo.getUuid(), resetToken ) );

        refreshIndex(context.getOrgName(), context.getAppName());

        Form formData = new Form();
        formData.add( "token", resetToken );
        formData.add( "password1", "sesame" );
        formData.add( "password2", "sesame" );

        String html = resource().path( "/management/users/" + userInfo.getUsername() + "/resetpw" )
                                .type( MediaType.APPLICATION_FORM_URLENCODED_TYPE ).post( String.class, formData );

        assertTrue( html.contains( "password set" ) );

        refreshIndex(context.getOrgName(), context.getAppName());

        assertFalse( setup.getMgmtSvc().checkPasswordResetTokenForAdminUser( userInfo.getUuid(), resetToken ) );

        html = resource().path( "/management/users/" + userInfo.getUsername() + "/resetpw" )
                         .type( MediaType.APPLICATION_FORM_URLENCODED_TYPE ).post( String.class, formData );

        assertTrue( html.contains( "invalid token" ) );
    }


    @Test
    @Ignore( "causes problems in build" )
    public void passwordResetIncorrectUserName() throws Exception {

        String email = "test2@usergrid.com";
        setup.getMgmtSvc().createAdminUser( "test2", "test2", "test2@usergrid.com", "sesa2me", false, false );
        UserInfo userInfo = setup.getMgmtSvc().getAdminUserByEmail( email );
        String resetToken = setup.getMgmtSvc().getPasswordResetTokenForAdminUser( userInfo.getUuid(), 15000 );

        assertTrue( setup.getMgmtSvc().checkPasswordResetTokenForAdminUser( userInfo.getUuid(), resetToken ) );

        Form formData = new Form();
        formData.add( "token", resetToken );
        formData.add( "password1", "sesa2me" );
        formData.add( "password2", "sesa2me" );

        String html = resource().path( "/management/users/" + "noodle" + userInfo.getUsername() + "/resetpw" )
                                .type( MediaType.APPLICATION_FORM_URLENCODED_TYPE ).post( String.class, formData );

        assertTrue( html.contains( "Incorrect username entered" ) );

        html = resource().path( "/management/users/" + userInfo.getUsername() + "/resetpw" )
                         .type( MediaType.APPLICATION_FORM_URLENCODED_TYPE ).post( String.class, formData );

        assertTrue( html.contains( "password set" ) );
    }


    @Test
    public void checkPasswordHistoryConflict() throws Exception {

        String[] passwords = new String[] { "password1", "password2", "password3", "password4" };

        UserInfo user =
                setup.getMgmtSvc().createAdminUser( "edanuff", "Ed Anuff", "ed@anuff.com", passwords[0], true, false );
        assertNotNull( user );

        refreshIndex(context.getOrgName(), context.getAppName());

        OrganizationInfo organization = setup.getMgmtSvc().createOrganization( "ed-organization", user, true );
        assertNotNull( organization );

        refreshIndex(context.getOrgName(), context.getAppName());

        // set history to 1
        Map&lt;String, Object&gt; props = new HashMap&lt;String, Object&gt;();
        props.put( OrganizationInfo.PASSWORD_HISTORY_SIZE_KEY, 1 );
        organization.setProperties( props );
        setup.getMgmtSvc().updateOrganization( organization );

        refreshIndex(context.getOrgName(), context.getAppName());

        UserInfo userInfo = setup.getMgmtSvc().getAdminUserByEmail( "ed@anuff.com" );

        Map&lt;String, String&gt; payload = hashMap( "oldpassword", passwords[0] ).map( "newpassword", passwords[0] ); // fail

        try {
            JsonNode node = mapper.readTree( resource().path( "/management/users/edanuff/password" )
                                                       .accept( MediaType.APPLICATION_JSON )
                                                       .type( MediaType.APPLICATION_JSON_TYPE ).post( String.class, payload ));
            fail( "should fail with conflict" );
        }
        catch ( UniformInterfaceException e ) {
            assertEquals( 409, e.getResponse().getStatus() );
        }

        payload.put( "newpassword", passwords[1] ); // ok
        JsonNode node = mapper.readTree( resource().path( "/management/users/edanuff/password" )
                                                   .accept( MediaType.APPLICATION_JSON )
                                                   .type( MediaType.APPLICATION_JSON_TYPE ).post( String.class, payload ));
        payload.put( "oldpassword", passwords[1] );

        refreshIndex(context.getOrgName(), context.getAppName());

        payload.put( "newpassword", passwords[0] ); // fail
        try {
            node = mapper.readTree( resource().path( "/management/users/edanuff/password" )
                                              .accept( MediaType.APPLICATION_JSON )
                                              .type( MediaType.APPLICATION_JSON_TYPE ).post( String.class, payload ));
            fail( "should fail with conflict" );
        }
        catch ( UniformInterfaceException e ) {
            assertEquals( 409, e.getResponse().getStatus() );
        }
    }


    @Test
    public void checkPasswordChangeTime() throws Exception {

        final TestUser user = context.getActiveUser();
        String email = user.getEmail();
        UserInfo userInfo = setup.getMgmtSvc().getAdminUserByEmail( email );
        String resetToken = setup.getMgmtSvc().getPasswordResetTokenForAdminUser( userInfo.getUuid(), 15000 );

        refreshIndex(context.getOrgName(), context.getAppName());

        Form formData = new Form();
        formData.add( "token", resetToken );
        formData.add( "password1", "sesame" );
        formData.add( "password2", "sesame" );

        String html = resource().path( "/management/users/" + userInfo.getUsername() + "/resetpw" )
                                .type( MediaType.APPLICATION_FORM_URLENCODED_TYPE ).post( String.class, formData );
        assertTrue( html.contains( "password set" ) );

        refreshIndex(context.getOrgName(), context.getAppName());

        JsonNode node = mapper.readTree( resource().path( "/management/token" )
                                                   .queryParam( "grant_type", "password" )
                                                   .queryParam( "username", email ).queryParam( "password", "sesame" )
                                                   .accept( MediaType.APPLICATION_JSON )
                                                   .get( String.class ));

        Long changeTime = node.get( "passwordChanged" ).longValue();
        assertTrue( System.currentTimeMillis() - changeTime &lt; 2000 );

        Map&lt;String, String&gt; payload = hashMap( "oldpassword", "sesame" ).map( "newpassword", "test" );
        node = mapper.readTree( resource().path( "/management/users/" + userInfo.getUsername() + "/password" )
                                          .accept( MediaType.APPLICATION_JSON ).type( MediaType.APPLICATION_JSON_TYPE )
                                          .post( String.class, payload ));

        refreshIndex(context.getOrgName(), context.getAppName());

        node = mapper.readTree( resource().path( "/management/token" )
                                          .queryParam( "grant_type", "password" )
                                          .queryParam( "username", email )
                                          .queryParam( "password", "test" )
                                          .accept( MediaType.APPLICATION_JSON )
                                          .get( String.class ));

        Long changeTime2 = node.get( "passwordChanged" ).longValue();
        assertTrue( changeTime &lt; changeTime2 );
        assertTrue( System.currentTimeMillis() - changeTime2 &lt; 2000 );

        node = mapper.readTree( resource().path( "/management/me" ).queryParam( "grant_type", "password" )
                                          .queryParam( "username", email ).queryParam( "password", "test" ).accept( MediaType.APPLICATION_JSON )
                                          .get( String.class ));

        Long changeTime3 = node.get( "passwordChanged" ).longValue();
        assertEquals( changeTime2, changeTime3 );
    }


    /** USERGRID-1960 */
    @Test
    @Ignore( "Depends on other tests" )
    public void listOrgUsersByName() {
        JsonNode response = context.management().orgs().organization( context.getOrgName() ).users().get();

        //get the response and verify our user is there
        JsonNode adminNode = response.get( "data" ).get( 0 );
        assertEquals( context.getActiveUser().getEmail(), adminNode.get( "email" ).asText() );
        assertEquals( context.getActiveUser().getUser(), adminNode.get( "username" ).asText() );
    }

    @Test
    public void createOrgFromUserConnectionFail() throws Exception {


        Map&lt;String, String&gt; payload = hashMap( "email", "orgfromuserconn@apigee.com" ).map( "password", "password" )
                                                                                      .map( "organization", "orgfromuserconn" );

        JsonNode node = mapper.readTree( resource().path( "/management/organizations" ).accept( MediaType.APPLICATION_JSON )
                                                   .type( MediaType.APPLICATION_JSON_TYPE ).post( String.class, payload ));

        String userId = node.get( "data" ).get( "owner" ).get( "uuid" ).asText();

        assertNotNull( node );

        String token = mgmtToken( "orgfromuserconn@apigee.com", "password" );

        node = mapper.readTree( resource().path( String.format( "/management/users/%s/", userId ) ).queryParam( "access_token", token )
                                          .type( MediaType.APPLICATION_JSON_TYPE ).get( String.class ));

        logNode( node );

        payload = hashMap( "organization", "Orgfromuserconn" );

        // try to create the same org again off the connection
        try {
            node = mapper.readTree( resource().path( String.format( "/management/users/%s/organizations", userId ) )
                                              .queryParam( "access_token", token ).accept( MediaType.APPLICATION_JSON )
                                              .type( MediaType.APPLICATION_JSON_TYPE ).post( String.class, payload ));
            fail( "Should have thrown unique exception on org name" );
        }
        catch ( Exception ex ) {
        }
    }
              </div></li><li><div>
                create adminUser
Entity adminUserResponse = restClient.management().orgs().organization( clientSetup.getOrganizationName() ).users().post( adminUserPayload );
              </div></li><li><div>
                *
     * Get the management user feed and check that it has the correct title.
     * @throws Exception
     
              </div></li><li><div>
                 change the password as admin. The old password isn't required
entity( username ).password().post;
              </div></li><li><div>
                Create adminUser values
              </div></li><li><div>
                Get the token using the new password
              </div></li><li><div>
                *
     * Checks that as a superuser (i.e with a superuser token ) we can change the password of a admin.
     * @throws IOException
     
              </div></li><li><div><div><b>comment:</b> TODO: change this when we upgrade to new version of jersey
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 use string type so we can log actual response from server
              </div></li><li><div><div><b>comment:</b> TODO: add error checking to each of the REST calls.
                </div><div><b>label:</b> requirement
                </div></div></li><li><div>
                 Seems like an apiresponse can't handle what gets returned from the from urlended media type
              </div></li><li><div>
                 use string type so we can log actual response from server
              </div></li><li><div>
                 Seems like an ApiResponse can't handle what gets returned from the from URL encoded media type
 use string type so we can log actual response from server
              </div></li><li><div>
                 create and post notification
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Merge branch 'two-dot-o' of https://github.com/apache/incubator-usergrid into USERGRID-422
                </div><div><b>message:</b> Merge branch 'two-dot-o' of https://github.com/apache/incubator-usergrid into USERGRID-422

# By Shawn Feldman (15) and others
# Via Shawn Feldman (9) and others
* 'two-dot-o' of https://github.com/apache/incubator-usergrid: (24 commits)
  This fixes many tests in ApplicationResourceIT.  This is a technically a merge but Usergrid 333 was already merged into two-dot-o.
  Removing unnecessary test class and commented out dependencies.
  Exclude Codehaus Jackson JAX-RS dependency, plus some better logging &amp; test improvements.
  compilation
  fix compilation
  indexbuffer: update method names
  index message comments
  undo change
  change config
  add batching
  Add futures to batch and refresh
  Add batch of batches
  add batches of batches
  removing future, moving around some initialization code
  add comments
  add blocking queue
  Adding metrics to cp
  adding index buffer
  Added test for user feeds and started testCaseSensitivity test.
  Fixed another test that uses the superuser token, and added a different endpoint to facilitate using the superuser token or the default endpoint.
  ...

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Create test that proves the issue before making any rest tier changes
                </div><div><b>description:</b> Make a rest test that shows when calling system/database/setup twice returns an exception.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div><div><b>body:</b> Problem with this is that we would have to change how the ConcurrentProcessSingleton automatically sets up the database. Since this step is done in a completely different package (test-utils), we would have to refactor the way we think about the system/*/setup steps to make it work in the rest tier. Currently we don't check to make sure they work in our testing suite. While writing a test that proves the issue is trivial, actually testing the system endpoints should be something we worry about in the future. 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Needs the superuser token to issue this call. Until then we can't test that the system database setup call is properly issued.
              </div></li><li><div>
                This was merged into 418 branch.
              </div></li></ol></div></div></html>