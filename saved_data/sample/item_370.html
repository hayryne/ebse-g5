<!DOCTYPE html><html><div class="item-title">
        Item 370
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Init the cluster if required znodes not exist in Zookeeper.
 Use ephemeral zk node as lock to keep initialize atomic.
              </div></li><li><div>
                 create ephemeral zk node bkInitLock, initiator who this node, then do init; other initiators will wait.
              </div></li><li><div>
                 bkInitLock created success, this is the successor to do znode init
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> ISSUE #881: use initialize insteadof format in docker image
                </div><div><b>message:</b> ISSUE #881: use initialize insteadof format in docker image

Descriptions of the changes in this PR:

Currently docker image uses format during startup to initialize the cluster. It would be good to separate initialize from format. The initialize command should only create znodes for brand new environment. It should not involve any logic on reformatting.

- use initialize insteadof format in docker image.
- make initialize an atomic operation.
- add initialize and nuke command in makefile.
- fix error for non root user running.

This PR tested by local build, since 4.7 is not released, will bump bk version in Dockerfile once 4.7 released.

Master Issue: #881

Author: Jia Zhai &lt;zhaijia@apache.org&gt;

Reviewers: Sijie Guo &lt;sijie@apache.org&gt;

This closes #1263 from jiazhai/issue_881, closes #881

                </div></div></li></ol></div><div><b>github_issues:</b> <ol><li><div><div><b>title:</b> Separate initialize from format in docker image
                </div><div><b>body:</b> 


**FEATURE REQUEST**

1. Please describe the feature you are requesting.

Currently docker image uses `format` during startup to initialize the cluster. It would be good to separate `initialize` from `format`. The `initialize` command should only *create* znodes for brand new environment. It should not involve any logic on `reformatting`. 

Also make `initialize` an atomic operation.

2. Indicate the importance of this issue to you (blocker, must-have, should-have, nice-to-have). Are you currently using any workarounds to address this issue?

*should-have*

3. Provide any additional detail on your proposed use case for this feature.

N/A


                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Separate initialize from format in docker image
                </div><div><b>body:</b> 


**FEATURE REQUEST**

1. Please describe the feature you are requesting.

Currently docker image uses `format` during startup to initialize the cluster. It would be good to separate `initialize` from `format`. The `initialize` command should only *create* znodes for brand new environment. It should not involve any logic on `reformatting`. 

Also make `initialize` an atomic operation.

2. Indicate the importance of this issue to you (blocker, must-have, should-have, nice-to-have). Are you currently using any workarounds to address this issue?

*should-have*

3. Provide any additional detail on your proposed use case for this feature.

N/A


                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Separate initialize from format in docker image
                </div><div><b>body:</b> 


**FEATURE REQUEST**

1. Please describe the feature you are requesting.

Currently docker image uses `format` during startup to initialize the cluster. It would be good to separate `initialize` from `format`. The `initialize` command should only *create* znodes for brand new environment. It should not involve any logic on `reformatting`. 

Also make `initialize` an atomic operation.

2. Indicate the importance of this issue to you (blocker, must-have, should-have, nice-to-have). Are you currently using any workarounds to address this issue?

*should-have*

3. Provide any additional detail on your proposed use case for this feature.

N/A


                </div></div></li></ol></div><div><b>github_issues_comments:</b> <ol><li><div><div><b>body:</b> The `metaformat` command has been implemented with two commands `initnewcluster ` and `nukeexistingcluster` in #978. we should update the docker file to use `initnewcluster` command.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>