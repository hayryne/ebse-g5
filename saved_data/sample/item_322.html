<!DOCTYPE html><html><div class="item-title">
        Item 322
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> SOLR-15081: Metrics for core: isLeader, replicaState (#2198)
                </div><div><b>message:</b> SOLR-15081: Metrics for core: isLeader, replicaState (#2198)

Note that getLastPublished returns an Enum type.  TextWriter.writeVal should probably support Enums, which would simplify this code.

(cherry picked from commit a233ed2fd1bc7e0f6366f74d33ec21007aec90bc)

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> SOLR-15081: Metrics for core: isLeader, status
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/SOLR-15081
Copying the description: 

&gt; The core level metrics hold some interesting information, but I don't see information pertaining to the SolrCloud status of the core.  In particular, I'd like to see the leader status here, and also the replica state.  The use-case I have in mind is enabling the Prometheus Exporter to get the doc count (and maybe other basics) of only the leader replicas, thereby counting unique documents instead of a fully replicated figure.  This is an approximation to doing a match-all-docs query on all collections, but is a more sound approach when one has orders of magnitude more collections than nodes.
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Since we do reference coreContainer on like 1215 should we keep this check?
              </div></li><li><div>
                I removed the check for CoreContainer nullness as it seemed impossible for it to be null.  SolrCores hang off of a CoreContainer.
              </div></li><li><div>
                *NULLPTR_DEREFERENCE:*  accessing memory that is the null pointer on line 1215 indirectly during the call to `ClusterState.getCollectionOrNull(...)`.
              </div></li><li><div>
                *NULLPTR_DEREFERENCE:*  accessing memory that is the null pointer on line 1216 indirectly during the call to `DocCollection.getLeader(...)`.
              </div></li><li><div>
                *NULLPTR_DEREFERENCE:*  accessing memory that is the null pointer on line 1220 indirectly during the call to `ClusterState.getCollectionOrNull(...)`.
              </div></li><li><div>
                *NULLPTR_DEREFERENCE:*  accessing memory that is the null pointer on line 1221 indirectly during the call to `DocCollection.getReplica(...)`.
              </div></li><li><div>
                *NULL_DEREFERENCE:*  object `myReplica` last assigned on line 1221 could be null and is dereferenced at line 1222.
              </div></li><li><div>
                I wrote these notes and code months ago, shelved it and nearly forgotten, and today I remembered it and submitted it.  The TODO here was kind of a note-to-self that can be removed.  I'd welcome anyone's thoughts on this though.  There appears, to me, to be overlap in scope between metrics and "status" type requests.  Years ago I thought Metrics was just numbers, but lately I've seen it can have all sorts of strings and basically completely compete with "status".
              </div></li><li><div>
                Maybe use `cloudDescriptor.isLeader()`, it's simpler...
              </div></li><li><div>
                Similarly `cloudDescriptor.getLastPublished()`.
              </div></li><li><div>
                Yeah, metrics today overlap a lot with "status" requests... something to clean up in 9x.

Initially the metrics API wasn't able to properly report complex values (esp. when reported via JMX) but this has been fixed around 7.0 or so - support for non-numeric values had to be added specifically to report things like paths, non-numeric state, etc. and for complex properties like eg. system properties, caches, etc. Now it can report basically anything you want.
              </div></li><li><div>
                I don't think it's inherently wrong to have overlap between status and metrics, as long as the overlapping information is coming from the same source.
              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>