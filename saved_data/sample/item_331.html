<!DOCTYPE html><html><div class="item-title">
        Item 331
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Don't consider inflight replication while calculating excess here.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen… (#1162)
                </div><div><b>message:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen… (#1162)

(cherry picked from commit 59771684d25f3f75ce4d97bc877335e9e5897e03)

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div></div></li><li><div><div><b>title:</b> HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen…
                </div><div><b>body:</b> https://issues.apache.org/jira/browse/HDDS-3921
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                Thanks for this change. I also wonder if there is a bug in the method `isContainerUnderReplicated(...)` which leads to this problem, and results in more processing that necessary for mis-replicated containers with inFlight Additions.

In `isContainerUnderReplicated` is uses only the live replicas to check for mis-replication, but then it considers inflight add and delete for under replication. Should we also include the inflightAdds when considering mis-replication in that method?

For `isContainerOverReplicated` it also uses the inflightAdds and deletes to check for over replication.
              </div></li><li><div>
                


&gt; Thanks @ChenSammi for reporting the issue and propose the fix. The change LGTM.
&gt; 
&gt; I have a question wrt the excess calculation in handleOverReplicationContainer where we only consider inflightDeletion without inflightReplication at around line 615. Could this contribute the over replication issue as we will break out when a smaller excess value reaches 0 but the inflighreplication is still going?

@xiaoyuyao , I think inflightReplication not considered here is safer since replication has the change to fail.  Imaging we have 2 healthy replicas and 2 inflight replications, this case, send the command to delete the extra 1 replica until we are sure that we have 4 healthy replicas in hand. 
              </div></li><li><div>
                &gt; Thanks for this change. I also wonder if there is a bug in the method `isContainerUnderReplicated(...)` which leads to this problem, and results in more processing that necessary for mis-replicated containers with inFlight Additions.
&gt; 
&gt; In `isContainerUnderReplicated` is uses only the live replicas to check for mis-replication, but then it considers inflight add and delete for under replication. Should we also include the inflightAdds when considering mis-replication in that method?
&gt; 
&gt; For `isContainerOverReplicated` it also uses the inflightAdds and deletes to check for over replication.

It's a good point. I don't think it's a real bug, but we can improve it.  HDDS-3942 to track it. 
              </div></li><li><div>
                testDeleteKeyWithSlowFollower failed at leader membership check step. The test passed locally. It seems a timing issue, not relevant to this patch. 
              </div></li><li><div>
                Thanks @sodonnel  and @xiaoyuyao for the review. 
              </div></li><li><div>
                LGTM, +1. Thanks @ChenSammi for the contribution and all for the reviews. I will merge the PR shortly. 
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div><div><b>body:</b> NIT: this line to move the line to calculate delta from 547-&gt;549 is not needed.  Only the line 550 is the core change that breaks out when we've already handle the under replicate container via inflight replication. 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> Rather than this new IF block here, would it make sense to simply add:

```
if (replicasNeeded &lt;= 0) {
  LOG.debug(...);
  return;
}
```

At line 554 / 558, just after the line:

```
        final int replicasNeeded
            = delta &lt; misRepDelta ? misRepDelta : delta;
```

That would avoid needing to check call `placementStatus.isPolicySatisfied()` and then `placementStatus.misReplicationCount()` afterwards, as `misReplicationCount()` calls `isPolicySatisfied()` anyway.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                This delta calculation and check in line 550 is required.  Currenlty placementStatus.isPolicySatisfied() only checks whether topology requirement is satisfied or not. It doesn't check whether it has enough replicas. 




              </div></li><li><div>
                Make sense. 
              </div></li><li><div>
                Got it. I agree delta calculation is needed. I mean move delta calculation after placementStatus is not necessary. 
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> IllegalArgumentException triggered in SCMContainerPlacementRackAware.chooseDatanodes
                </div><div><b>description:</b> The root cause is existing replicas plus replicas in replicationInFlight meet the crossing rack requriement, for this case, we should check 
if misReplicated again. 

2020-07-04 16:25:01,496 [ReplicationMonitor] INFO org.apache.hadoop.hdds.scm.SCMCommonPlacementPolicy: currentRackCount 1, replicas 3, requiredRacks 2, numRacks 4
2020-07-04 16:25:01,496 [ReplicationMonitor] INFO org.apache.hadoop.hdds.scm.container.ReplicationManager: misReplicated = true, replicas size = 1
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: Handling underreplicated container: 250499
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: replicas of container {}#250499
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: 9.179.142.198 CLOSED
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: deletionInFlight of container {}#250499
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: replicationInFlight of container {}#250499
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: 9.180.19.147
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: 100.76.61.31
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: source of container {}#250499
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: 9.179.142.198
2020-07-04 16:25:01,496 [ReplicationMonitor] INFO org.apache.hadoop.hdds.scm.container.ReplicationManager: Container #250499 expected replica count 3, but found 3, delta 0.
2020-07-04 16:25:01,496 [ReplicationMonitor] INFO org.apache.hadoop.hdds.scm.SCMCommonPlacementPolicy: currentRackCount 2, replicas 3, requiredRacks 2, numRacks 4
2020-07-04 16:25:01,496 [ReplicationMonitor] WARN org.apache.hadoop.hdds.scm.container.ReplicationManager: Process container #250499 error:
java.lang.IllegalArgumentException
        at com.google.common.base.Preconditions.checkArgument(Preconditions.java:128)
        at org.apache.hadoop.hdds.scm.container.placement.algorithms.SCMContainerPlacementRackAware.chooseDatanodes(SCMContainerPlacementRackAware.java:101)
        at org.apache.hadoop.hdds.scm.container.ReplicationManager.handleUnderReplicatedContainer(ReplicationManager.java:578)
        at org.apache.hadoop.hdds.scm.container.ReplicationManager.processContainer(ReplicationManager.java:331)
        at java.util.concurrent.ConcurrentHashMap$KeySetView.forEach(ConcurrentHashMap.java:4649)
        at java.util.Collections$UnmodifiableCollection.forEach(Collections.java:1082)
        at org.apache.hadoop.hdds.scm.container.ReplicationManager.run(ReplicationManager.java:238)
        at java.lang.Thread.run(Thread.java:748)
                </div></div></li><li><div><div><b>summary:</b> IllegalArgumentException triggered in SCMContainerPlacementRackAware.chooseDatanodes
                </div><div><b>description:</b> The root cause is existing replicas plus replicas in replicationInFlight meet the crossing rack requriement, for this case, we should check 
if misReplicated again. 

2020-07-04 16:25:01,496 [ReplicationMonitor] INFO org.apache.hadoop.hdds.scm.SCMCommonPlacementPolicy: currentRackCount 1, replicas 3, requiredRacks 2, numRacks 4
2020-07-04 16:25:01,496 [ReplicationMonitor] INFO org.apache.hadoop.hdds.scm.container.ReplicationManager: misReplicated = true, replicas size = 1
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: Handling underreplicated container: 250499
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: replicas of container {}#250499
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: 9.179.142.198 CLOSED
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: deletionInFlight of container {}#250499
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: replicationInFlight of container {}#250499
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: 9.180.19.147
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: 100.76.61.31
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: source of container {}#250499
2020-07-04 16:25:01,496 [ReplicationMonitor] DEBUG org.apache.hadoop.hdds.scm.container.ReplicationManager: 9.179.142.198
2020-07-04 16:25:01,496 [ReplicationMonitor] INFO org.apache.hadoop.hdds.scm.container.ReplicationManager: Container #250499 expected replica count 3, but found 3, delta 0.
2020-07-04 16:25:01,496 [ReplicationMonitor] INFO org.apache.hadoop.hdds.scm.SCMCommonPlacementPolicy: currentRackCount 2, replicas 3, requiredRacks 2, numRacks 4
2020-07-04 16:25:01,496 [ReplicationMonitor] WARN org.apache.hadoop.hdds.scm.container.ReplicationManager: Process container #250499 error:
java.lang.IllegalArgumentException
        at com.google.common.base.Preconditions.checkArgument(Preconditions.java:128)
        at org.apache.hadoop.hdds.scm.container.placement.algorithms.SCMContainerPlacementRackAware.chooseDatanodes(SCMContainerPlacementRackAware.java:101)
        at org.apache.hadoop.hdds.scm.container.ReplicationManager.handleUnderReplicatedContainer(ReplicationManager.java:578)
        at org.apache.hadoop.hdds.scm.container.ReplicationManager.processContainer(ReplicationManager.java:331)
        at java.util.concurrent.ConcurrentHashMap$KeySetView.forEach(ConcurrentHashMap.java:4649)
        at java.util.Collections$UnmodifiableCollection.forEach(Collections.java:1082)
        at org.apache.hadoop.hdds.scm.container.ReplicationManager.run(ReplicationManager.java:238)
        at java.lang.Thread.run(Thread.java:748)
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>