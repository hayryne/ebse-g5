<!DOCTYPE html><html><div class="item-title">
        Item 202
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> ARROW-5473: [C++] Fix googletest_ep build failure on windows+ninja
                </div><div><b>message:</b> ARROW-5473: [C++] Fix googletest_ep build failure on windows+ninja

Fix proposed by @rip-nsk

Closes #6816 from bkietz/5473-Build-failure-on-googlete

Authored-by: Benjamin Kietzman &lt;bengilgit@gmail.com&gt;
Signed-off-by: Wes McKinney &lt;wesm+git@apache.org&gt;

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> ARROW-5473: [C++] Fix googletest_ep build failure on windows+ninja
                </div><div><b>body:</b> Fix proposed by @rip-nsk 
                </div></div></li><li><div><div><b>title:</b> ARROW-5473: [C++] Fix googletest_ep build failure on windows+ninja
                </div><div><b>body:</b> Fix proposed by @rip-nsk 
                </div></div></li><li><div><div><b>title:</b> ARROW-5473: [C++] Fix googletest_ep build failure on windows+ninja
                </div><div><b>body:</b> Fix proposed by @rip-nsk 
                </div></div></li><li><div><div><b>title:</b> ARROW-5473: [C++] Fix googletest_ep build failure on windows+ninja
                </div><div><b>body:</b> Fix proposed by @rip-nsk 
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                https://issues.apache.org/jira/browse/ARROW-5473
              </div></li><li><div>
                Appveyor failure ( https://ci.appveyor.com/project/ApacheSoftwareFoundation/arrow/builds/31912909/job/6gbhp9sitv7nab9b#L1085 ) is https://issues.apache.org/jira/browse/ARROW-8323

Python 3.5 failure ( https://github.com/apache/arrow/pull/6816/checks?check_run_id=555807185#step:6:2218 ) is https://issues.apache.org/jira/browse/ARROW-8315
              </div></li><li><div>
                The build didn't run to completion, but I'll check in my local environment whether this resolves the Ninja failure I was experiencing
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> [C++] Build failure on googletest_ep on Windows when using Ninja
                </div><div><b>description:</b> I consistently get this error when trying to use Ninja locally:

{code}
-- extracting...
     src='C:/Users/wesmc/code/arrow/cpp/build/googletest_ep-prefix/src/release-1.8.1.tar.gz'
     dst='C:/Users/wesmc/code/arrow/cpp/build/googletest_ep-prefix/src/googletest_ep'
-- extracting... [tar xfz]
-- extracting... [analysis]
-- extracting... [rename]
CMake Error at googletest_ep-stamp/extract-googletest_ep.cmake:51 (file):
  file RENAME failed to rename

    C:/Users/wesmc/code/arrow/cpp/build/googletest_ep-prefix/src/ex-googletest_ep1234/googletest-release-1.8.1

  to

    C:/Users/wesmc/code/arrow/cpp/build/googletest_ep-prefix/src/googletest_ep

  because: Directory not empty



[179/623] Building CXX object src\arrow\CMakeFiles\arrow_static.dir\array\builder_dict.cc.obj
ninja: build stopped: subcommand failed.
{code}

I'm running within cmdr terminal emulator so it's conceivable there's some path modifications that are causing issues.

The CMake invocation is

{code}
cmake -G "Ninja" ^          -DCMAKE_BUILD_TYPE=Release ^          -DARROW_BUILD_TESTS=on ^          -DARROW_CXXFLAGS="/WX /MP" ^
     -DARROW_FLIGHT=off -DARROW_PARQUET=on -DARROW_GANDIVA=ON -DARROW_VERBOSE_THIRDPARTY_BUILD=on     ..
{code}

                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                The suspicious line is https://github.com/apache/arrow/blob/master/cpp/cmake_modules/ThirdpartyToolchain.cmake#L1259
              </div></li><li><div><div><b>body:</b> I think that line is necessary to workaround a CMake bug when non-existent directories are referenced.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                See e.g. https://gitlab.kitware.com/cmake/cmake/issues/15052
              </div></li><li><div>
                I've seen this too, I can usually work around it by explicitly building just googletest_ep then building the rest of the project
              </div></li><li><div>
                This is still an issue AFAICT. 
              </div></li><li><div>
                As Ben said the workaround of doing

{code}
ninja googletest_ep
ninja
{code}

works. It definitely suggests there is something misconfigured in CMake, though
              </div></li><li><div>
                the following change fixes issue for me:

--- a/cpp/cmake_modules/ThirdpartyToolchain.cmake
+++ b/cpp/cmake_modules/ThirdpartyToolchain.cmake
@@ -1412,7 +1412,7 @@ macro(build_gtest)
 set(GTEST_CMAKE_CXX_FLAGS "${GTEST_CMAKE_CXX_FLAGS} -DGTEST_CREATE_SHARED_LIBRARY=1")
 endif()
 
- set(GTEST_PREFIX "${CMAKE_CURRENT_BINARY_DIR}/googletest_ep-prefix/src/googletest_ep")
+ set(GTEST_PREFIX "${CMAKE_CURRENT_BINARY_DIR}/googletest_ep-prefix")
 set(GTEST_INCLUDE_DIR "${GTEST_PREFIX}/include")
 
 set(_GTEST_RUNTIME_DIR ${BUILD_OUTPUT_ROOT_DIRECTORY})
              </div></li><li><div>
                This has been occurring in the last week, seen in build failures here

https://github.com/apache/arrow/pull/6813

We should try [~rip.nsk@gmail.com]'s proposed fix
              </div></li><li><div>
                Issue resolved by pull request 6816
[https://github.com/apache/arrow/pull/6816]
              </div></li></ol></div></div></html>