<!DOCTYPE html><html><div class="item-title">
        Item 95
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [SPARK-9651] Fix UnsafeExternalSorterSuite.
                </div><div><b>message:</b> [SPARK-9651] Fix UnsafeExternalSorterSuite.

First, it's probably a bad idea to call generated Scala methods
from Java. In this case, the method being called wasn't actually
"Utils.createTempDir()", but actually the method that returns the
first default argument to the actual createTempDir method, which
is just the location of java.io.tmpdir; meaning that all tests in
the class were using the same temp dir, and thus affecting each
other.

Second, spillingOccursInResponseToMemoryPressure was not writing
enough records to actually cause a spill.

Author: Marcelo Vanzin &lt;vanzin@cloudera.com&gt;

Closes #7970 from vanzin/SPARK-9651 and squashes the following commits:

74d357f [Marcelo Vanzin] Clean up temp dir on test tear down.
a64f36a [Marcelo Vanzin] [SPARK-9651] Fix UnsafeExternalSorterSuite.

(cherry picked from commit 4399b7b0903d830313ab7e69731c11d587ae567c)
Signed-off-by: Reynold Xin &lt;rxin@databricks.com&gt;

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [SPARK-9651] Fix UnsafeExternalSorterSuite.
                </div><div><b>body:</b> First, it's probably a bad idea to call generated Scala methods
from Java. In this case, the method being called wasn't actually
"Utils.createTempDir()", but actually the method that returns the
first default argument to the actual createTempDir method, which
is just the location of java.io.tmpdir; meaning that all tests in
the class were using the same temp dir, and thus affecting each
other.

Second, spillingOccursInResponseToMemoryPressure was not writing
enough records to actually cause a spill.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                /cc @rxin @JoshRosen 

              </div></li><li><div>
                Seems fine to me, pending Jenkins.

              </div></li><li><div>
                  [Test build #39903 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/39903/console) for   PR 7970 at commit [`a64f36a`](https://github.com/apache/spark/commit/a64f36a13f5ee6cdeaa09f65e55b8a08bd0936b2).
- This patch **fails Spark unit tests**.
- This patch merges cleanly.
- This patch adds no public classes.

              </div></li><li><div>
                Well the test being changed did pass... retest this please.

              </div></li><li><div>
                **[Test build #39909 timed out](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/39909/console)**     for PR 7970 at commit [`74d357f`](https://github.com/apache/spark/commit/74d357fa8f60318d795da8a5f6ce601cad33a731)     after a configured wait of `175m`.

              </div></li><li><div>
                  [Test build #239 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SlowSparkPullRequestBuilder/239/console) for   PR 7970 at commit [`74d357f`](https://github.com/apache/spark/commit/74d357fa8f60318d795da8a5f6ce601cad33a731).
- This patch **fails PySpark unit tests**.
- This patch merges cleanly.
- This patch adds the following public classes _(experimental)_:
  - `class BlockMatrix(DistributedMatrix):`
  - `// class DataFrame`

              </div></li><li><div>
                I'm going to merge this.

              </div></li><li><div>
                  [Test build #39930 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/39930/console) for   PR 7970 at commit [`74d357f`](https://github.com/apache/spark/commit/74d357fa8f60318d795da8a5f6ce601cad33a731).
- This patch **fails PySpark unit tests**.
- This patch merges cleanly.
- This patch adds no public classes.

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                This has to be deleted in `tearDown` too I presume in order to fix this? or else it's still reusing a same dir? 

I checked and there is a similar problem in some other Java tests:

```
JavaSaveLoadSuite
JavaMetastoreDataSourcesSuite
JavaAPISuite
```

              </div></li><li><div>
                In this case no; setUp and tearDown are per-test, so each test gets a separate temp dir.

I'll take a look at the other tests. Might be worth it to add the temp dir helper method in some common java class.

              </div></li><li><div>
                Oh right it makes a subdir every time anyway. Well, it'd be better to clean up the temp dir in `tearDown` if possible.

              </div></li><li><div>
                This didn't fail for me locally, which is kind of odd.

              </div></li><li><div>
                Fails for me consistently if I use `100000`.

```
Running org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorterSuite
Tests run: 2, Failures: 2, Errors: 0, Skipped: 0, Time elapsed: 0.99 sec &lt;&lt;&lt; FAILURE! - in org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorterSuite
spillingOccursInResponseToMemoryPressure(org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorterSuite)  Time elapsed: 0.426 sec  &lt;&lt;&lt; FAILURE!
java.lang.AssertionError: 
Expected: a value equal to or greater than &lt;1&gt;
     got: &lt;0&gt;

        at org.junit.Assert.assertThat(Assert.java:780)
        at org.junit.Assert.assertThat(Assert.java:738)
        at org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorterSuite.spillingOccursInResponseToMemoryPressure(UnsafeExternalSorterSuite.java:243)

spillingOccursInResponseToMemoryPressure(org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorterSuite)  Time elapsed: 0.429 sec  &lt;&lt;&lt; FAILURE!
java.lang.AssertionError: expected:&lt;0&gt; but was:&lt;69206016&gt;
        at org.junit.Assert.fail(Assert.java:93)
        at org.junit.Assert.failNotEquals(Assert.java:647)
        at org.junit.Assert.assertEquals(Assert.java:128)
        at org.junit.Assert.assertEquals(Assert.java:472)
        at org.junit.Assert.assertEquals(Assert.java:456)
        at org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorterSuite.tearDown(UnsafeExternalSorterSuite.java:150)


Results :

Failed tests: 
org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorterSuite.spillingOccursInResponseToMemoryPressure(org.apache.spark.util.collection.unsafe.sort.UnsafeExternalSorterSuite)
  Run 1: UnsafeExternalSorterSuite.spillingOccursInResponseToMemoryPressure:243 
Expected: a value equal to or greater than &lt;1&gt;
     got: &lt;0&gt;

  Run 2: UnsafeExternalSorterSuite.tearDown:150 expected:&lt;0&gt; but was:&lt;69206016&gt;
```

              </div></li><li><div>
                Ok, I'll do this. I'll fix this test this way, then file a separate bug to have a shared, Java createTempDir() and use it from everywhere. How does that sound?

This is the only unit test that consistently fails in our builds so I'd like to at least unblock it.

              </div></li><li><div>
                Actually all the other tests you mention do the right thing. This is the only place that was calling the wrong Scala method.

              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>