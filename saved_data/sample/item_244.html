<!DOCTYPE html><html><div class="item-title">
        Item 244
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> remove lock files not accessed after 7 days. INFRA-15692
                </div><div><b>message:</b> remove lock files not accessed after 7 days. INFRA-15692

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> lock files not being removed on tools-vm
                </div><div><b>description:</b> Lock files being created on tools-vm but ar enot being removed, so are building up.

gmcdonald@tools-vm:~$ ls -al /tmp/mailinglist-*.json.lock | wc -l
44

Here is where lock files were introduced:-

https://github.com/apache/infrastructure-puppet/commit/7d7367d47a8e2ff6bacaa1a29c44535f73eae8d2


                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                [~sebb@apache.org] the commit that introduced these lock files was yours, do you have any opinion on cleaning them up?
              </div></li><li><div><div><b>body:</b> Looks like I assumed that the files would be automatically cleaned up on reboot or by age.
How old is the oldest?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                12 Sept 12:33 UTC
              </div></li><li><div><div><b>body:</b> That is quite a while ago, so it looks like /tmp is not being cleaned up regularly.
Might be worth looking at enabling cleanups?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> /tmp is cleaned up on reboot, but there is no reason for a tool to leave droppings behind when they are not needed. 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> uptime for tools-vm is 272 days, we tend not to reboot often, unless neccessary, especially for multi-service hosts.

Preferred would be to have the script cleanup, especially .lock files which should be super-temporary, released upon exit of file.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> [~sebb@apache.org] can you fix this please? scripts should not be relying on reboots to clean temp files.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I've had a look at this.

If the code deletes the lock file after use it can allow two processes to have the lock at the same time:
Process 1 grabs lock
Process 2 waits on lock
Process 1 deletes lock
Process 3 creates and grabs new lock

The window between process 1 deleting the lock and process 2 completing its work is quite small but not zero, so process 3 can grab the new lock and write the file whilst it is still open in process 2.

I assume there must be a way to get round this, but have yet to find it.
              </div></li><li><div><div><b>body:</b> What about a workaround with a crontab that removes stale locks?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> Unfortunately that does not help.
The window is still there; it's just a different process doing the delete.

Are there really so many lock files that they are causing a problem?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Implemented a cron job to run once a week to delete mailing list json tmp files that have not been accessed in 7 days. As good as we are going to get and I think good enough.
              </div></li></ol></div></div></html>