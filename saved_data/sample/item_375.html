<!DOCTYPE html><html><div class="item-title">
        Item 375
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Echo Access-Control-Request-Headers as Access-Control-Allow-Headers instead of hardcoding value for header. (#2771)
                </div><div><b>message:</b> Echo Access-Control-Request-Headers as Access-Control-Allow-Headers instead of hardcoding value for header. (#2771)


                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol><li><div><div><b>title:</b> Default CORS handling doesn't handle headers well
                </div><div><b>body:</b> Given this web action:

```php
&lt;?php
function main(array $args) : array
{
    return [
        'hello' =&gt; 'world'
    ];
}
```

This JS call in a browser will fail:

```html
&lt;!doctype html&gt;
&lt;html&gt;
    &lt;head&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Test&lt;/h1&gt;

        &lt;pre id="data"&gt;
        &lt;/pre&gt;

        &lt;script src="https://code.jquery.com/jquery-3.2.1.min.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript"&gt;
            $(document).ready(function() {
                jQuery.ajax({
                    url: "https://openwhisk.eu-gb.bluemix.net/api/v1/web/19FT_dev/default/cors.json",
                    type: "GET",
                    headers: {
                        'X-Clacks-Overhead': 'GNU Terry Pratchett'
                    },
                    contentType: 'application/json; charset=utf-8',
                    success: function(resultData) {
                        console.log(resultData)
                        $('#data').html("Action result is: " + JSON.stringify(resultData))
                    },
                    error : function(jqXHR, textStatus, errorThrown) {
                        console.log("Error: " + textStatus)
                        console.log(errorThrown)
                        console.log(jqXHR)
                        $('#data').html("Error")
                    },
                    timeout: 120000,
                });
            });
        &lt;/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;
```

With an error message in the Chrome console of:

&gt; XMLHttpRequest cannot load https://openwhisk.eu-gb.bluemix.net/api/v1/web/19FT_dev/default/cors.json. Request header field X-Clacks-Overhead is not allowed by Access-Control-Allow-Headers in preflight response.

This is because [`defaultCorsResponse`](https://github.com/apache/incubator-openwhisk/blob/master/core/controller/src/main/scala/whisk/core/controller/WebActions.scala#L354)  sends back `Access-Control-Allow-Headers` of `Authorization ` and `Content-Type` only.

What should happen is that `Access-Control-Allow-Headers` should be whatever was sent in `Access-Control-Request-Headers`.
                </div></div></li><li><div><div><b>title:</b> Default CORS handling doesn't handle headers well
                </div><div><b>body:</b> Given this web action:

```php
&lt;?php
function main(array $args) : array
{
    return [
        'hello' =&gt; 'world'
    ];
}
```

This JS call in a browser will fail:

```html
&lt;!doctype html&gt;
&lt;html&gt;
    &lt;head&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Test&lt;/h1&gt;

        &lt;pre id="data"&gt;
        &lt;/pre&gt;

        &lt;script src="https://code.jquery.com/jquery-3.2.1.min.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript"&gt;
            $(document).ready(function() {
                jQuery.ajax({
                    url: "https://openwhisk.eu-gb.bluemix.net/api/v1/web/19FT_dev/default/cors.json",
                    type: "GET",
                    headers: {
                        'X-Clacks-Overhead': 'GNU Terry Pratchett'
                    },
                    contentType: 'application/json; charset=utf-8',
                    success: function(resultData) {
                        console.log(resultData)
                        $('#data').html("Action result is: " + JSON.stringify(resultData))
                    },
                    error : function(jqXHR, textStatus, errorThrown) {
                        console.log("Error: " + textStatus)
                        console.log(errorThrown)
                        console.log(jqXHR)
                        $('#data').html("Error")
                    },
                    timeout: 120000,
                });
            });
        &lt;/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;
```

With an error message in the Chrome console of:

&gt; XMLHttpRequest cannot load https://openwhisk.eu-gb.bluemix.net/api/v1/web/19FT_dev/default/cors.json. Request header field X-Clacks-Overhead is not allowed by Access-Control-Allow-Headers in preflight response.

This is because [`defaultCorsResponse`](https://github.com/apache/incubator-openwhisk/blob/master/core/controller/src/main/scala/whisk/core/controller/WebActions.scala#L354)  sends back `Access-Control-Allow-Headers` of `Authorization ` and `Content-Type` only.

What should happen is that `Access-Control-Allow-Headers` should be whatever was sent in `Access-Control-Request-Headers`.
                </div></div></li><li><div><div><b>title:</b> Default CORS handling doesn't handle headers well
                </div><div><b>body:</b> Given this web action:

```php
&lt;?php
function main(array $args) : array
{
    return [
        'hello' =&gt; 'world'
    ];
}
```

This JS call in a browser will fail:

```html
&lt;!doctype html&gt;
&lt;html&gt;
    &lt;head&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Test&lt;/h1&gt;

        &lt;pre id="data"&gt;
        &lt;/pre&gt;

        &lt;script src="https://code.jquery.com/jquery-3.2.1.min.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript"&gt;
            $(document).ready(function() {
                jQuery.ajax({
                    url: "https://openwhisk.eu-gb.bluemix.net/api/v1/web/19FT_dev/default/cors.json",
                    type: "GET",
                    headers: {
                        'X-Clacks-Overhead': 'GNU Terry Pratchett'
                    },
                    contentType: 'application/json; charset=utf-8',
                    success: function(resultData) {
                        console.log(resultData)
                        $('#data').html("Action result is: " + JSON.stringify(resultData))
                    },
                    error : function(jqXHR, textStatus, errorThrown) {
                        console.log("Error: " + textStatus)
                        console.log(errorThrown)
                        console.log(jqXHR)
                        $('#data').html("Error")
                    },
                    timeout: 120000,
                });
            });
        &lt;/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;
```

With an error message in the Chrome console of:

&gt; XMLHttpRequest cannot load https://openwhisk.eu-gb.bluemix.net/api/v1/web/19FT_dev/default/cors.json. Request header field X-Clacks-Overhead is not allowed by Access-Control-Allow-Headers in preflight response.

This is because [`defaultCorsResponse`](https://github.com/apache/incubator-openwhisk/blob/master/core/controller/src/main/scala/whisk/core/controller/WebActions.scala#L354)  sends back `Access-Control-Allow-Headers` of `Authorization ` and `Content-Type` only.

What should happen is that `Access-Control-Allow-Headers` should be whatever was sent in `Access-Control-Request-Headers`.
                </div></div></li><li><div><div><b>title:</b> Default CORS handling doesn't handle headers well
                </div><div><b>body:</b> Given this web action:

```php
&lt;?php
function main(array $args) : array
{
    return [
        'hello' =&gt; 'world'
    ];
}
```

This JS call in a browser will fail:

```html
&lt;!doctype html&gt;
&lt;html&gt;
    &lt;head&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Test&lt;/h1&gt;

        &lt;pre id="data"&gt;
        &lt;/pre&gt;

        &lt;script src="https://code.jquery.com/jquery-3.2.1.min.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript"&gt;
            $(document).ready(function() {
                jQuery.ajax({
                    url: "https://openwhisk.eu-gb.bluemix.net/api/v1/web/19FT_dev/default/cors.json",
                    type: "GET",
                    headers: {
                        'X-Clacks-Overhead': 'GNU Terry Pratchett'
                    },
                    contentType: 'application/json; charset=utf-8',
                    success: function(resultData) {
                        console.log(resultData)
                        $('#data').html("Action result is: " + JSON.stringify(resultData))
                    },
                    error : function(jqXHR, textStatus, errorThrown) {
                        console.log("Error: " + textStatus)
                        console.log(errorThrown)
                        console.log(jqXHR)
                        $('#data').html("Error")
                    },
                    timeout: 120000,
                });
            });
        &lt;/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;
```

With an error message in the Chrome console of:

&gt; XMLHttpRequest cannot load https://openwhisk.eu-gb.bluemix.net/api/v1/web/19FT_dev/default/cors.json. Request header field X-Clacks-Overhead is not allowed by Access-Control-Allow-Headers in preflight response.

This is because [`defaultCorsResponse`](https://github.com/apache/incubator-openwhisk/blob/master/core/controller/src/main/scala/whisk/core/controller/WebActions.scala#L354)  sends back `Access-Control-Allow-Headers` of `Authorization ` and `Content-Type` only.

What should happen is that `Access-Control-Allow-Headers` should be whatever was sent in `Access-Control-Request-Headers`.
                </div></div></li></ol></div><div><b>github_issues_comments:</b> <ol><li><div>
                I think this is important for the `OPTIONS` preflight, it looks like client can specify the headers that the valid requests are intended to send.
              </div></li><li><div>
                https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS#Access-Control-Request-Headers
```
The Access-Control-Request-Headers header is used when issuing a preflight request to let the server know what HTTP headers will be used when the actual request is made.
```
              </div></li></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> Echo Access-Control-Request-Headers as Access-Control-Allow-Headers 
                </div><div><b>body:</b> Instead of hardcoding the header value for `Access-Control-Allow-Headers`, echo back the request headers from the request when `Access-Control-Request-Headers` is present.

Closes #2653.
FYI @akrabat 
                </div></div></li><li><div><div><b>title:</b> Echo Access-Control-Request-Headers as Access-Control-Allow-Headers 
                </div><div><b>body:</b> Instead of hardcoding the header value for `Access-Control-Allow-Headers`, echo back the request headers from the request when `Access-Control-Request-Headers` is present.

Closes #2653.
FYI @akrabat 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Echo Access-Control-Request-Headers as Access-Control-Allow-Headers 
                </div><div><b>body:</b> Instead of hardcoding the header value for `Access-Control-Allow-Headers`, echo back the request headers from the request when `Access-Control-Request-Headers` is present.

Closes #2653.
FYI @akrabat 
                </div></div></li><li><div><div><b>title:</b> Echo Access-Control-Request-Headers as Access-Control-Allow-Headers 
                </div><div><b>body:</b> Instead of hardcoding the header value for `Access-Control-Allow-Headers`, echo back the request headers from the request when `Access-Control-Request-Headers` is present.

Closes #2653.
FYI @akrabat 
                </div></div></li><li><div><div><b>title:</b> Echo Access-Control-Request-Headers as Access-Control-Allow-Headers 
                </div><div><b>body:</b> Instead of hardcoding the header value for `Access-Control-Allow-Headers`, echo back the request headers from the request when `Access-Control-Request-Headers` is present.

Closes #2653.
FYI @akrabat 
                </div></div></li><li><div><div><b>title:</b> Echo Access-Control-Request-Headers as Access-Control-Allow-Headers 
                </div><div><b>body:</b> Instead of hardcoding the header value for `Access-Control-Allow-Headers`, echo back the request headers from the request when `Access-Control-Request-Headers` is present.

Closes #2653.
FYI @akrabat 
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                PG3 1114 ðŸ”µ 
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Should explicitly state that the `Access-Control-Request-Headers` is not echoed back when `web-custom-options` is enabled.
              </div></li><li><div>
                Need test that ensures `Access-Control-Request-Headers` isn't echoed back when `web-custom-options` is enabled.
              </div></li><li><div>
                The next paragraph states:

```
Alternatively, OPTIONS requests can be handled manually by a web action. To enable this option add a
`web-custom-options` annotation with a value of `true` to a web action. When this feature is enabled, CORS headers will
not automatically be added to the request response. Instead, it is the developer's responsibility to append their
desired headers programmatically. Below is an example of creating custom responses to OPTIONS requests.
```

Sufficient?
              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>