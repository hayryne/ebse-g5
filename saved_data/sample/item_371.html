<!DOCTYPE html><html><div class="item-title">
        Item 371
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 registration paths
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                 re-read the bookie list
              </div></li><li><div>
                 construct the zookeeper
              </div></li><li><div>
                *
 * ZooKeeper based {@link RegistrationClient}.
 
              </div></li><li><div>
                 initialize resources
              </div></li><li><div>
                 initialize registration client
              </div></li><li><div>
                 initialize feature provider
              </div></li><li><div>
                 create readonly bookies node if not exists
              </div></li><li><div>
                 this callback is already not executed in zookeeper thread
              </div></li><li><div>
                *
     * Set registration manager class
     *
     * @param regClientClass
     *            ClientClass
     
              </div></li><li><div>
                *
     * Get Registration Client Class.
     *
     * @return registration manager class.
     
              </div></li><li><div>
                 Registration Client
              </div></li><li><div>
                *
     * Initialize the registration client with provided resources.
     *
     * &lt;p&gt;The existence of &lt;i&gt;zkSupplier&lt;/i&gt; is for backward compatability.
     * @param conf client configuration
     * @param statsLogger stats logger
     * @param zkOptional a supplier to supply zookeeper client.
     * @return
    RegistrationClient initialize(ClientConfiguration conf,
                                  ScheduledExecutorService scheduler,
                                  StatsLogger statsLogger,
                                  Optional&lt;ZooKeeper&gt; zkOptional)
        throws BKException;
    @Override
    void close();

    /**
     * Get the list of writable bookie identifiers.
     *
     * @return a future represents the list of writable bookies.
     
              </div></li><li><div>
                *
     * Watch the changes of bookies.
     *
     * &lt;p&gt;The topology changes of bookies will be propagated to the provided &lt;i&gt;listener&lt;/i&gt;.
     *
     * @param listener listener to receive the topology changes of bookies.
     
              </div></li><li><div>
                *
     * Get the list of readonly bookie identifiers.
     *
     * @return a future represents the list of readonly bookies.
     
              </div></li><li><div>
                *
     * Unwatch the changes of bookies.
     *
     * @param listener listener to receive the topology changes of bookies.
     
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> ISSUE #666: Introduce registration client for bookkeeper client to do bookie discover
                </div><div><b>message:</b> ISSUE #666: Introduce registration client for bookkeeper client to do bookie discover

Descriptions of the changes in this PR:
while in BOOKKEEPER-628, It is trying to improve/generalize the bookie registration process.

This PR follows the work of #663, which provide bookie side registration, and it is for client side work, it tries to introduce RegistrationClient for bookkeeper client to do bookie discover.

This PR follows the work of #663, which provide bookie side registration,

Author: Jia Zhai &lt;zhaijia@apache.org&gt;

Reviewers: Sijie Guo &lt;sijie@apache.org&gt;

This closes #667 from zhaijack/client_registration2, closes #666

                </div></div></li></ol></div><div><b>github_issues:</b> <ol><li><div><div><b>title:</b> Introduce registration client for bookkeeper client
                </div><div><b>body:</b> while in [BOOKKEEPER-628](https://issues.apache.org/jira/browse/BOOKKEEPER-628), It is trying to improve/generalize the bookie registration process.

This issue is for client side work, it tries to introduce RegistrationClient for bookkeeper client to do bookie discover.
And this follows the work of #662.


                </div></div></li><li><div><div><b>title:</b> Introduce registration client for bookkeeper client
                </div><div><b>body:</b> while in [BOOKKEEPER-628](https://issues.apache.org/jira/browse/BOOKKEEPER-628), It is trying to improve/generalize the bookie registration process.

This issue is for client side work, it tries to introduce RegistrationClient for bookkeeper client to do bookie discover.
And this follows the work of #662.


                </div></div></li></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Improve bookie registration interface
                </div><div><b>description:</b> The idea is to improve/generalize the bookie registration process
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                I've created a patch to showcase the interfaces. Tries to generalize interfaces, these will be used by bkserver &amp; bkclient.
              </div></li><li><div>
                thanks [~rakeshr]

since bookie registration involve zookeeper session expire handling, how you could make it generic? 

general comments on your patch:

1. please involve version in this interface. you could refere LedgerManager interface.
2. this abstraction consider both client and server side change. so you need to ensure client and bookie agrees on using same implementation of this interface. check LedgerManagerFactory. it would be better to separate client-only, server-only and common part into different interfaces and managed by one factory.
              </div></li><li><div>
                UnKnown should be Unknown. It's a single word.

This stuff has a good bit of overlap with the rack awareness stuff sijie did. Have you looked at that patch?

I agree with Sijie that something needs to be done about session expire handling. Perhaps register could take a callback, and you watch on the registered node. If it disappears, then you trigger the callback.

Generally I like this idea of this though.
              </div></li><li><div>
                Thanks [~hustlmsp], [~ivank@yahoo-inc.com] for the reviews. 
I've separated out the client/server interfaces and if agrees, I'll integrate this to our code base.

bq.zookeeper session expire handling
Presently ZooKeeperWatcherBase callback is doing the Expiry handling. I'm thinking to move the zookeeper instantiation to the RegistrationManager#init() method, and returns zk object. In bkclient, if user doesn't pass zk object will do the zk instantiation and returns the object? How does it sound?
              </div></li><li><div>
                {code}
I'm thinking to move the zookeeper instantiation to the RegistrationManager#init() method, and returns zk object.
{code}

in general, the interface is to allow different implementations. returning a zk object against its purpose. this interface should be something like HubServerManager interface in hedwig. https://github.com/apache/bookkeeper/blob/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/HubServerManager.java 


              </div></li><li><div>
                I've attached modified interfaces, added ManagerListener to listen for zk connection events. [~ikelly] [~hustlmsp] please have a look at this and if ok, will start implementing the idea.
              </div></li><li><div>
                the interface looks good.

but I would step back asking the question: what is the goal of this interface? it sounds to me that the interface is to hide zookeeper specific implementations. but from the interface, it is already tight with zookeeper (RegistrationManager#init(AbstractConfiguration conf, ZooKeeper zk, int managerVersion)).

As this interface doesn't block other tickets and all these stuffs (e.g. bookie registration, cookies) are quite zookeeper specific operations, I'd prefer generifying the interface after fixed zookeeper session handling in BOOKEEPER-537. so we could get clearer how the interface would look like. Thoughts?
              </div></li><li><div><div><b>body:</b> There's two reasons to provide an interface. Firstly to create well defined isolated contracts between the components of your system, and secondly to allow multiple implementations of this contract to coexist. In this case, we only want the first, as there's no driving usecase to move away from zookeeper for bookie registration. Following from this, RegistrationManagerFactory is unneeded. The interfaces in RegistrationManager are mostly fine though. I don't think that BookieRegistrationManager should have separate calls for the Cookie. bookieId &lt;-&gt; cookie is a 1-1 relationship. Why does ClientRegistrationManager have a createBookieInstance call? Also, the placement policy should have nothing to do with this interface.It's a decision that can be taken in total isolation on the client.

I agree with Sijie that it would be good to sort out the session handling before doing this work though. Or doing it in tandem. At least for the listener part.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Thanks for the comments.

Here my idea was to unify the zk usage in bookie server operations, also in client side operations through one registration interface. Presently the zk apis usage are scattered in Bookie, Cookie. IMHO, this will be helpful to focus at common place for any ZK related logics like - ZK session handling, ZK acls. 

bq.Why does ClientRegistrationManager have a createBookieInstance call? 
Yeah, this should be at server side, which will be used by bookie format logic.
              </div></li><li><div>
                Thanks for the comments.

Here my idea was to unify the zk usage in bookie server operations, also in client side operations through one registration interface. Presently the zk apis usage are scattered in Bookie, Cookie. IMHO, this will be helpful to focus at common place for any ZK related logics like - ZK session handling, ZK acls. 

bq.Why does ClientRegistrationManager have a createBookieInstance call? 
Yeah, this should be at server side, which will be used by bookie format logic.
              </div></li><li><div>
                bq.I agree with Sijie that it would be good to sort out the session handling before doing this work though. Or doing it in tandem. At least for the listener part.
I agree with both of you taking up this after pushing BOOKEEPER-537. 
[~hustlmsp] whats your opinion about pushing listener part separately with this JIRA. 
              </div></li><li><div>
                [~rakeshr] [~ikelly] isn't ManagerListener related to zookeeper session handling? could we think of it after handling session expires?
              </div></li><li><div>
                Yeah, zk session handling. Sure will revist after BOOKEEPER-537, I'will add dependency tag.
              </div></li><li><div>
                Do you mean push the listener stuff in a different JIRA?
              </div></li><li><div>
                I thought of pushing smaller chunk through subtask, but its overlapping with BOOKEEPER-537 and postponed my plans. Any thoughts?
              </div></li><li><div>
                which smaller chunk though?
              </div></li><li><div>
                bq.which smaller chunk though?
I meant, RegistrationManager#ManagerListener part, which will be used to listen for zk connection events.
              </div></li><li><div>
                Hmm, actually looking at this again, perhaps it could go in before BOOKKEEPER-537, if the previous comments are addressed. Then BOOKKEEPER-537 could build on top.
              </div></li><li><div>
                I don't think it is a good idea to refactor things that would be changed in future. since you don't actually know whether the refactor meets the changes or not. if this is really really need to be in, I would suggest doing the metadata related part (not session expire part), like Cookies. And we could iterate the session part later.
              </div></li><li><div>
                moved to 4.4.0 as session expire handling moved to 4.4.0
              </div></li><li><div>
                [~zhaijia] Have you seen this? You're working on something similar now, no?
              </div></li><li><div>
                Migrated to github https://github.com/apache/bookkeeper/issues/621
              </div></li></ol></div></div></html>