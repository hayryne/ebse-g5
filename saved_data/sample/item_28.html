<!DOCTYPE html><html><div class="item-title">
        Item 28
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> TServerSocket.cpp: Ensure the server is really listening (via helper variable listening_)
                </div><div><b>message:</b> TServerSocket.cpp: Ensure the server is really listening (via helper variable listening_)
Client: cpp
Patch: Mario Emmenlauer

This closes #2232

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> TServerSocket.cpp: Ensure the server is really listening
                </div><div><b>body:</b> Currently the C++ server does not ensure that `listening_` is `true` in `isOpen()`. I think this is incorrect because in multi-threaded environments, the socket may not be open or listening yet. Also, `listening_` should only be set to `true` when the socket is fully set up and listening.

This PR adds a minor change: it respects `listening_` for `isOpen()`, and sets `listening_` to `true` only at the end of spcket initialization. In heavy stress tests, we found this makes the server method `isOpen()` more reliable.

Thanks for consideration.

- [ ] Did you create an [Apache Jira](https://issues.apache.org/jira/projects/THRIFT/issues/) ticket?  (not required for trivial changes)
- [ ] If a ticket exists: Does your pull request title follow the pattern "THRIFT-NNNN: describe my issue"?
- [x] Did you squash your changes to a single commit?  (not required, but preferred)
- [x] Did you do your best to avoid breaking changes?  If one was needed, did you label the Jira ticket with "Breaking-Change"?
- [x] If your change does not involve any code, include `[skip ci]` anywhere in the commit message to free up build resources.
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                &gt; LGTM â€” eventhough, I think, people should pick the `TNonBlockingServer` for multithreaded environments, as it has at least some synchronization and is in general more suitable for threadpools and the like.

I'm very curious about this! We did not try it yet, was it a simple drop-in replacement for you? It uses libevent, correct? Did you compare it with the new fbthrift c++ server?
              </div></li><li><div>
                Checked, the build errors in Travis are all unrelated. Ready for review and merge...
              </div></li><li><div>
                &gt; was it a simple drop-in replacement for you?

Not sure about this...

&gt; It uses libevent, correct?

Better to check the source, but I think not. It just expects to be used from multiple threads, and does appropriate locking.

&gt; Did you compare it with the new fbthrift c++ server?

No; what's that?
              </div></li><li><div>
                &gt; &gt; Did you compare it with the new fbthrift c++ server?
&gt; 
&gt; No; what's that?

Apparently Facebook has continued development on thrift in a separate project. I think it has less features and supports less languages, but it seems to have a cool new async c++ server. I've always wondered if this server could not be backported to Apache thrift, but that seems to involve complicated discussion of licenses. But for end-users, things may be simpler: possibly the server could just be used with Apache thrift if one would manage to take it out and build it against Apache thrift. No idea if this is possible, though :-) 
See https://github.com/facebook/fbthrift/blob/master/thrift/doc/Cpp2.md for more details.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>