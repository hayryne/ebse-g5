<!DOCTYPE html><html><div class="item-title">
        Item 372
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Make activation response truncation length configurable  (#4909)
                </div><div><b>message:</b> Make activation response truncation length configurable  (#4909)

* Make activation payload truncation length configurable
* Update tests
* Change configuration to use HOCON
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> Make activation response truncation length configurable 
                </div><div><b>body:</b> ## Description
By default activation responses can be 1MB in size and they will be truncated to 1MB in case the size is bigger. 
This PR makes the truncation length configurable too. This means that the response size could be configured to 1MB for example, but the truncation length can be 512KB. 
The reason for this change is the fact that once the response is truncated, it does not make a lot of sense to store the entire payload to the database. 

As an example, for the following configuration:
```
whisk {
    activation {
        payload {
            max = 512
            truncation = 10
        }
    }
}
```
the response of a truncated activation result will have the following format:
```
{
    "error": "The action produced a response that exceeded the allowed length: 600 &gt; 512 bytes. The truncated response was: {\"body\":\"H"
}
```
and the database will store only 10 bytes of the response. 

## My changes affect the following components
&lt;!--- Select below all system components are affected by your change. --&gt;
&lt;!--- Enter an `x` in all applicable boxes. --&gt;
- [ ] API
- [ ] Controller
- [ ] Message Bus (e.g., Kafka)
- [ ] Loadbalancer
- [ ] Invoker
- [ ] Intrinsic actions (e.g., sequences, conductors)
- [x] Data stores (e.g., CouchDB)
- [ ] Tests
- [ ] Deployment
- [ ] CLI
- [ ] General tooling
- [ ] Documentation

## Types of changes
&lt;!--- What types of changes does your code introduce? Use `x` in all the boxes that apply: --&gt;
- [ ] Bug fix (generally a non-breaking change which closes an issue).
- [x] Enhancement or new feature (adds new functionality).
- [ ] Breaking change (a bug fix or enhancement which changes existing behavior).

## Checklist:
&lt;!--- Please review the points below which help you make sure you've covered all aspects of the change you're making. --&gt;

- [x] I signed an [Apache CLA](https://github.com/apache/openwhisk/blob/master/CONTRIBUTING.md).
- [x] I reviewed the [style guides](https://github.com/apache/openwhisk/wiki/Contributing:-Git-guidelines#code-readiness) and followed the recommendations (Travis CI will check :).
- [x] I added tests to cover my changes.
- [ ] My changes require further changes to the documentation.
- [ ] I updated the documentation where necessary.


                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                # [Codecov](https://codecov.io/gh/apache/openwhisk/pull/4909?src=pr&amp;el=h1) Report
&gt; Merging [#4909](https://codecov.io/gh/apache/openwhisk/pull/4909?src=pr&amp;el=desc) into [master](https://codecov.io/gh/apache/openwhisk/commit/97c9f7aff7ac58f2230d0fc76849621f1604c233&amp;el=desc) will **decrease** coverage by `5.94%`.
&gt; The diff coverage is `78.26%`.

[![Impacted file tree graph](https://codecov.io/gh/apache/openwhisk/pull/4909/graphs/tree.svg?width=650&amp;height=150&amp;src=pr&amp;token=l0YmsiSAso)](https://codecov.io/gh/apache/openwhisk/pull/4909?src=pr&amp;el=tree)

```diff
@@            Coverage Diff             @@
##           master    #4909      +/-   ##
==========================================
- Coverage   83.24%   77.30%   -5.95%     
==========================================
  Files         201      201              
  Lines        9356     9454      +98     
  Branches      392      401       +9     
==========================================
- Hits         7788     7308     -480     
- Misses       1568     2146     +578     
```


| [Impacted Files](https://codecov.io/gh/apache/openwhisk/pull/4909?src=pr&amp;el=tree) | Coverage Œî | |
|---|---|---|
| [...whisk/core/containerpool/AkkaContainerClient.scala](https://codecov.io/gh/apache/openwhisk/pull/4909/diff?src=pr&amp;el=tree#diff-Y29tbW9uL3NjYWxhL3NyYy9tYWluL3NjYWxhL29yZy9hcGFjaGUvb3BlbndoaXNrL2NvcmUvY29udGFpbmVycG9vbC9Ba2thQ29udGFpbmVyQ2xpZW50LnNjYWxh) | `78.72% &lt;50.00%&gt; (√∏)` | |
| [.../containerpool/ApacheBlockingContainerClient.scala](https://codecov.io/gh/apache/openwhisk/pull/4909/diff?src=pr&amp;el=tree#diff-Y29tbW9uL3NjYWxhL3NyYy9tYWluL3NjYWxhL29yZy9hcGFjaGUvb3BlbndoaXNrL2NvcmUvY29udGFpbmVycG9vbC9BcGFjaGVCbG9ja2luZ0NvbnRhaW5lckNsaWVudC5zY2FsYQ==) | `71.66% &lt;50.00%&gt; (+0.48%)` | :arrow_up: |
| [...sk/core/containerpool/docker/DockerContainer.scala](https://codecov.io/gh/apache/openwhisk/pull/4909/diff?src=pr&amp;el=tree#diff-Y29yZS9pbnZva2VyL3NyYy9tYWluL3NjYWxhL29yZy9hcGFjaGUvb3BlbndoaXNrL2NvcmUvY29udGFpbmVycG9vbC9kb2NrZXIvRG9ja2VyQ29udGFpbmVyLnNjYWxh) | `95.60% &lt;85.71%&gt; (-0.87%)` | :arrow_down: |
| [...pache/openwhisk/core/containerpool/Container.scala](https://codecov.io/gh/apache/openwhisk/pull/4909/diff?src=pr&amp;el=tree#diff-Y29tbW9uL3NjYWxhL3NyYy9tYWluL3NjYWxhL29yZy9hcGFjaGUvb3BlbndoaXNrL2NvcmUvY29udGFpbmVycG9vbC9Db250YWluZXIuc2NhbGE=) | `88.50% &lt;100.00%&gt; (+0.85%)` | :arrow_up: |
| [.../openwhisk/core/entity/ActivationEntityLimit.scala](https://codecov.io/gh/apache/openwhisk/pull/4909/diff?src=pr&amp;el=tree#diff-Y29tbW9uL3NjYWxhL3NyYy9tYWluL3NjYWxhL29yZy9hcGFjaGUvb3BlbndoaXNrL2NvcmUvZW50aXR5L0FjdGl2YXRpb25FbnRpdHlMaW1pdC5zY2FsYQ==) | `100.00% &lt;100.00%&gt; (√∏)` | |
| [...core/database/cosmosdb/RxObservableImplicits.scala](https://codecov.io/gh/apache/openwhisk/pull/4909/diff?src=pr&amp;el=tree#diff-Y29tbW9uL3NjYWxhL3NyYy9tYWluL3NjYWxhL29yZy9hcGFjaGUvb3BlbndoaXNrL2NvcmUvZGF0YWJhc2UvY29zbW9zZGIvUnhPYnNlcnZhYmxlSW1wbGljaXRzLnNjYWxh) | `0.00% &lt;0.00%&gt; (-100.00%)` | :arrow_down: |
| [...ore/database/cosmosdb/cache/CacheInvalidator.scala](https://codecov.io/gh/apache/openwhisk/pull/4909/diff?src=pr&amp;el=tree#diff-Y29yZS9jb3Ntb3NkYi9jYWNoZS1pbnZhbGlkYXRvci9zcmMvbWFpbi9zY2FsYS9vcmcvYXBhY2hlL29wZW53aGlzay9jb3JlL2RhdGFiYXNlL2Nvc21vc2RiL2NhY2hlL0NhY2hlSW52YWxpZGF0b3Iuc2NhbGE=) | `0.00% &lt;0.00%&gt; (-100.00%)` | :arrow_down: |
| [...e/database/cosmosdb/cache/ChangeFeedConsumer.scala](https://codecov.io/gh/apache/openwhisk/pull/4909/diff?src=pr&amp;el=tree#diff-Y29yZS9jb3Ntb3NkYi9jYWNoZS1pbnZhbGlkYXRvci9zcmMvbWFpbi9zY2FsYS9vcmcvYXBhY2hlL29wZW53aGlzay9jb3JlL2RhdGFiYXNlL2Nvc21vc2RiL2NhY2hlL0NoYW5nZUZlZWRDb25zdW1lci5zY2FsYQ==) | `0.00% &lt;0.00%&gt; (-100.00%)` | :arrow_down: |
| [...core/database/cosmosdb/CosmosDBArtifactStore.scala](https://codecov.io/gh/apache/openwhisk/pull/4909/diff?src=pr&amp;el=tree#diff-Y29tbW9uL3NjYWxhL3NyYy9tYWluL3NjYWxhL29yZy9hcGFjaGUvb3BlbndoaXNrL2NvcmUvZGF0YWJhc2UvY29zbW9zZGIvQ29zbW9zREJBcnRpZmFjdFN0b3JlLnNjYWxh) | `0.00% &lt;0.00%&gt; (-96.23%)` | :arrow_down: |
| [...sk/core/database/cosmosdb/CosmosDBViewMapper.scala](https://codecov.io/gh/apache/openwhisk/pull/4909/diff?src=pr&amp;el=tree#diff-Y29tbW9uL3NjYWxhL3NyYy9tYWluL3NjYWxhL29yZy9hcGFjaGUvb3BlbndoaXNrL2NvcmUvZGF0YWJhc2UvY29zbW9zZGIvQ29zbW9zREJWaWV3TWFwcGVyLnNjYWxh) | `0.00% &lt;0.00%&gt; (-93.90%)` | :arrow_down: |
| ... and [18 more](https://codecov.io/gh/apache/openwhisk/pull/4909/diff?src=pr&amp;el=tree-more) | |

------

[Continue to review full report at Codecov](https://codecov.io/gh/apache/openwhisk/pull/4909?src=pr&amp;el=continue).
&gt; **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)
&gt; `Œî = absolute &lt;relative&gt; (impact)`, `√∏ = not affected`, `? = missing data`
&gt; Powered by [Codecov](https://codecov.io/gh/apache/openwhisk/pull/4909?src=pr&amp;el=footer). Last update [97c9f7a...70e3774](https://codecov.io/gh/apache/openwhisk/pull/4909?src=pr&amp;el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).

              </div></li><li><div>
                This is OK but a better approach is to reduce the log limit units from MB to B and then apply lower defaults. We've done this and will open a PR. At which point, I think this knob becomes obsolete in the future (which is OK, just making a note of it).
              </div></li><li><div>
                &gt; This is OK but a better approach is to reduce the log limit units from MB to B and then apply lower defaults. We've done this and will open a PR. At which point, I think this knob becomes obsolete in the future (which is OK, just making a note of it).

@rabbah log limits have not been changed, this only refers to truncation for the large activation responses that need to be stored in the database. But even better if log limits and activation payload limits are being take care of in a separate PR üëç 
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                nit: I think it is easier to read if these are (both) changed to "m" units (mebibytes per hocon), e.g.
```
            max = 1 m
            truncation = 1 m
```
              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>