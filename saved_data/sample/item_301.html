<!DOCTYPE html><html><div class="item-title">
        Item 301
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Returns OK if the path exists.
              </div></li><li><div>
                 Checks if the file is a directory. Returns an error if it doesn't
 exist, otherwise writes true or false into 'is_dir' appropriately.
              </div></li><li><div>
                 Canonicalize 'path' by applying the following conversions:
 - Converts a relative path into an absolute one using the cwd.
 - Converts '.' and '..' references.
 - Resolves all symbolic links.

 All directory entries in 'path' must exist on the filesystem.
              </div></li><li><div>
                 namespace doris
              </div></li><li><div>
                 DEPRECATED: Use gscoped_ptr&lt;C, doris::FreeDeleter&gt; instead.
              </div></li><li><div>
                 gscoped_ptr&lt;int, doris::FreeDeleter&gt; foo_ptr(
              </div></li><li><div>
                 It's a normal directory.
              </div></li><li><div>
                 Maybe a file or a symlink. Let's try to follow the symlink.
              </div></li><li><div>
                 It's a symlink to a directory.
              </div></li><li><div>
                 Create directory of dir_path with default Env, 
 Create directory of dir_path, 
 This function will create directory recursively,
 if dir's parent directory doesn't exist

 RETURNS:
  Status::OK()      if create directory success or directory already exists
              </div></li><li><div>
                 check path(file or directory) exist with default env
              </div></li><li><div>
                 Delete dir or file, failed when there are files or dirs under the path
              </div></li><li><div>
                 check path(file or directory) exist with env
              </div></li><li><div>
                 Check the file_path is not exist with default env, or is not a dir, return false.
              </div></li><li><div>
                 List all dirs and files in the specified directory
              </div></li><li><div>
                 remove 
              </div></li><li><div>
                 remove paths
              </div></li><li><div>
                 normal
              </div></li><li><div>
                 remove_all
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Refactor and reorganize the file utils  (#2089)
                </div><div><b>message:</b> Refactor and reorganize the file utils  (#2089)


                </div></div></li></ol></div><div><b>github_issues:</b> <ol><li><div><div><b>title:</b> Use Env to do file operation
                </div><div><b>body:</b> Now, in many place, we use posix interface or boost function to do file operation. We have abstract an Env interface to do file operation. 
We should change it to use Env to do file operation for following reason.
1. we can unify all file operation in one place, it is easy for us to do some work later, for example audit.
2. we can use one copy of code to do the same things to avoid duplicated code.
3. If we want to our code to access remote file, we will do it without logical code modify.

There are too many places to be changed, so this work will be split into some smaller job to finish.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Use Env to do file operation
                </div><div><b>body:</b> Now, in many place, we use posix interface or boost function to do file operation. We have abstract an Env interface to do file operation. 
We should change it to use Env to do file operation for following reason.
1. we can unify all file operation in one place, it is easy for us to do some work later, for example audit.
2. we can use one copy of code to do the same things to avoid duplicated code.
3. If we want to our code to access remote file, we will do it without logical code modify.

There are too many places to be changed, so this work will be split into some smaller job to finish.
                </div></div></li></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li><li><div><div><b>title:</b> Change refactor and reorganize the file utils 
                </div><div><b>body:</b> Change remove unused file method (#2001 )
Change refactor and reorganize the create_file method (#2001 )
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                @Seaven LGTM, however you should rebase the master branch to resolve the conflicts.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div><div><b>body:</b> This interface is to create a directory, not create a directory recursively.
And create directory recursively should be implemented in file_utils, because it's the same logic for different types of Env.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Thanks, will modify it.


              </div></li><li><div>
                ```suggestion
        std::unique_ptr&lt;char[], kudu::FreeDeleter&gt; r(realpath(path.c_str(), nullptr));
```
kudu?
              </div></li><li><div>
                ```suggestion
        if (is_dot_or_dotdot(name)) {
```
              </div></li><li><div>
                ```suggestion
        auto st = env-&gt;is_directory(temp_path, &amp;is_dir);
        if (st.ok()) {
```
              </div></li><li><div><div><b>body:</b> better to print st's error message
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                ```suggestion
                if (dirs != nullptr) {
```
              </div></li><li><div>
                ```suggestion
        RETURN_IF_ERROR(remove(p));
```
              </div></li><li><div>
                ```suggestion
    RETURN_IF_ERROR(env-&gt;is_directory(path, &amp;is_dir));
```
              </div></li><li><div>
                ```suggestion
        if (r == nullptr) {
```
              </div></li><li><div>
                ```suggestion
        RETURN_IF_ERROR(env-&gt;is_directory(partial_path, &amp;is_dir));
```
better to return instantly when meeting error.
              </div></li><li><div>
                Yeah, the namespace is kudu in gutil/gscoped_ptr.h , maybe we should modify to doris?
              </div></li><li><div><div><b>body:</b> better to change it to doris for easy use
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                We can't return here because the path maybe isn't exists.
              </div></li><li><div><div><b>body:</b> better to get status, and print error message.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> I think you should refactor this function to make it return error if status is no NOT_FOUND.
And this may lead many changes, you can resolve this in another ISSUE

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                If this path is normal file, we should return ERROR. No need to call another create_dir
              </div></li><li><div>
                get the status and log it if it is not OK
we prefer not do operation and check in `if` clause
              </div></li><li><div>
                Recorded ISSUE #2166. Will modify later
              </div></li><li><div>
                ```suggestion
Status FileUtils::list_dirs_files(const std::string&amp; path, std::set&lt;std::string&gt;* dirs,
```
              </div></li><li><div>
                ```suggestion
                             std::set&lt;std::string&gt;* files, Env* env) {
```
              </div></li><li><div>
                ```suggestion
            } else if (files != nullptr) {
```
              </div></li><li><div>
                ```suggestion
bool FileUtils::is_dir(const std::string&amp; file_path, Env* env) {
```
              </div></li><li><div>
                ```suggestion
    for (auto&amp; p : paths) {
```
To avoid memory copy
              </div></li><li><div>
                ```suggestion
Status FileUtils::remove(const std::string&amp; path, doris::Env* env) {
```
              </div></li><li><div><div><b>body:</b> I think we can call `env-&gt;delete_dir()` directly. If calling `FileUtils::remove`, it will check that it is a directory or ordinal file, which is unnecessary.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Better to check this function's result
              </div></li><li><div>
                should set ret to an ERROR
              </div></li><li><div>
                set res to error
              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>