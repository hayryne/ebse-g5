<!DOCTYPE html><html><div class="item-title">
        Item 203
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div><div><b>comment:</b>  clean up
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                *
   * Consume decoder data and write into {@link VectorSchemaRoot}.
   
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
 * Composite consumer which hold all consumers.
 * It manages the consume and cleanup process.
 
              </div></li><li><div><div><b>comment:</b> *
   * Close this consumer when occurs exception to avoid potential leak.
   
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> ARROW-6199: [Java] Avro adapter avoid potential resource leak.
                </div><div><b>message:</b> ARROW-6199: [Java] Avro adapter avoid potential resource leak.

Related to [ARROW-6199](https://issues.apache.org/jira/browse/ARROW-6199).

Currently, avro consumer interface has no close API, which may cause resource leak like AvroBytesConsumer#cacheBuffer.
To resolve this, make consumer extends AutoCloseable and create CompositeAvroConsumer to encompasses consume and close logic.

Closes #5059 from tianchen92/ARROW-6199 and squashes the following commits:

d60d94c48 &lt;tianchen&gt; fix
42f22da7c &lt;tianchen&gt; clear vectors in close
5b91da75f &lt;tianchen&gt; fix comments
3ffc07600 &lt;tianchen&gt; ARROW-6199:  Avro adapter avoid potential resource leak.

Authored-by: tianchen &lt;niki.lj@alibaba-inc.com&gt;
Signed-off-by: Micah Kornfield &lt;emkornfield@gmail.com&gt;

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> ARROW-6199: [Java] Avro adapter avoid potential resource leak.
                </div><div><b>body:</b> Related to [ARROW-6199](https://issues.apache.org/jira/browse/ARROW-6199).

Currently, avro consumer interface has no close API, which may cause resource leak like AvroBytesConsumer#cacheBuffer.
To resolve this, make consumer extends AutoCloseable and create CompositeAvroConsumer to encompasses consume and close logic. 
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                # [Codecov](https://codecov.io/gh/apache/arrow/pull/5059?src=pr&amp;el=h1) Report
&gt; Merging [#5059](https://codecov.io/gh/apache/arrow/pull/5059?src=pr&amp;el=desc) into [master](https://codecov.io/gh/apache/arrow/commit/3cc12abdbac324cb2e6a93fd2da0ff41929b6cac?src=pr&amp;el=desc) will **increase** coverage by `2.11%`.
&gt; The diff coverage is `n/a`.

[![Impacted file tree graph](https://codecov.io/gh/apache/arrow/pull/5059/graphs/tree.svg?width=650&amp;token=LpTCFbqVT1&amp;height=150&amp;src=pr)](https://codecov.io/gh/apache/arrow/pull/5059?src=pr&amp;el=tree)

```diff
@@            Coverage Diff             @@
##           master    #5059      +/-   ##
==========================================
+ Coverage   87.63%   89.75%   +2.11%     
==========================================
  Files        1014      674     -340     
  Lines      144947   100382   -44565     
  Branches     1437        0    -1437     
==========================================
- Hits       127030    90093   -36937     
+ Misses      17555    10289    -7266     
+ Partials      362        0     -362
```


| [Impacted Files](https://codecov.io/gh/apache/arrow/pull/5059?src=pr&amp;el=tree) | Coverage Δ | |
|---|---|---|
| [r/src/recordbatch.cpp](https://codecov.io/gh/apache/arrow/pull/5059/diff?src=pr&amp;el=tree#diff-ci9zcmMvcmVjb3JkYmF0Y2guY3Bw) | | |
| [r/R/Table.R](https://codecov.io/gh/apache/arrow/pull/5059/diff?src=pr&amp;el=tree#diff-ci9SL1RhYmxlLlI=) | | |
| [js/src/util/fn.ts](https://codecov.io/gh/apache/arrow/pull/5059/diff?src=pr&amp;el=tree#diff-anMvc3JjL3V0aWwvZm4udHM=) | | |
| [go/arrow/array/bufferbuilder.go](https://codecov.io/gh/apache/arrow/pull/5059/diff?src=pr&amp;el=tree#diff-Z28vYXJyb3cvYXJyYXkvYnVmZmVyYnVpbGRlci5nbw==) | | |
| [r/src/symbols.cpp](https://codecov.io/gh/apache/arrow/pull/5059/diff?src=pr&amp;el=tree#diff-ci9zcmMvc3ltYm9scy5jcHA=) | | |
| [rust/datafusion/src/execution/projection.rs](https://codecov.io/gh/apache/arrow/pull/5059/diff?src=pr&amp;el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9leGVjdXRpb24vcHJvamVjdGlvbi5ycw==) | | |
| [rust/datafusion/src/execution/filter.rs](https://codecov.io/gh/apache/arrow/pull/5059/diff?src=pr&amp;el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9leGVjdXRpb24vZmlsdGVyLnJz) | | |
| [rust/arrow/src/csv/writer.rs](https://codecov.io/gh/apache/arrow/pull/5059/diff?src=pr&amp;el=tree#diff-cnVzdC9hcnJvdy9zcmMvY3N2L3dyaXRlci5ycw==) | | |
| [rust/datafusion/src/bin/main.rs](https://codecov.io/gh/apache/arrow/pull/5059/diff?src=pr&amp;el=tree#diff-cnVzdC9kYXRhZnVzaW9uL3NyYy9iaW4vbWFpbi5ycw==) | | |
| [go/arrow/ipc/file\_reader.go](https://codecov.io/gh/apache/arrow/pull/5059/diff?src=pr&amp;el=tree#diff-Z28vYXJyb3cvaXBjL2ZpbGVfcmVhZGVyLmdv) | | |
| ... and [332 more](https://codecov.io/gh/apache/arrow/pull/5059/diff?src=pr&amp;el=tree-more) | |

------

[Continue to review full report at Codecov](https://codecov.io/gh/apache/arrow/pull/5059?src=pr&amp;el=continue).
&gt; **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)
&gt; `Δ = absolute &lt;relative&gt; (impact)`, `ø = not affected`, `? = missing data`
&gt; Powered by [Codecov](https://codecov.io/gh/apache/arrow/pull/5059?src=pr&amp;el=footer). Last update [3cc12ab...d60d94c](https://codecov.io/gh/apache/arrow/pull/5059?src=pr&amp;el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).

              </div></li><li><div>
                @emkornfield Hi Micah, Please help take a look on this. About avro adapter there are Array, Map, Fixed type left, I would like to start follow-ups(support all types and iterator) as soon as possible to merge it before 0.15 branch cut together with Jdbc iterator. Many thanks :)
              </div></li><li><div>
                @emkornfield Please help take a look at this one :)
              </div></li><li><div>
                @emkornfield build passed, and I am curious about which time zone you are in?
              </div></li><li><div>
                +1 thank you.  US/Pacific.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Is this necessary, reading the javado it just seems like this resets the value but doesn't free any resources?  It seems like if anything we should be closing the vectors in the consumers?  But maybe that is a decision for when we support reading only a set number of rows?
              </div></li><li><div>
                Thanks, you are right, unnecessary here.
1. close should release vectors but only when exception occurs, otherwise vectors should release by users.
2. the same for iterator API later.

PR updated now.
              </div></li><li><div>
                lets fix in one of the follow-ups.  but I think looping should be done outside of the consumer interfaces.
              </div></li><li><div>
                Thank you Micah, will fix in next PR. I plan to start two PRs one by one(support all type, iterator API), then I think i could be called a initial version and hope to catch up 0.15 branch cut.
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> [Java] Avro adapter avoid potential resource leak.
                </div><div><b>description:</b> Currently, avro consumer interface has no close API, which may cause resource leak like {{AvroBytesConsumer#cacheBuffer}}.

To resolve this, make consumer extends {{AutoCloseable}}&nbsp;and create {{CompositeAvroConsumer}}&nbsp;to encompasses consume and close logic.&nbsp;
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Issue resolved by pull request 5059
[https://github.com/apache/arrow/pull/5059]
              </div></li></ol></div></div></html>