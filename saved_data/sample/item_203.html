<!DOCTYPE html><html><div class="item-title">
        Item 203
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function
                </div><div><b>message:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function

This PR adds:
1. An implementation of the 1 argument form of the `TO_TIMESTAMP` function that takes a single argument (string) and converts it into a nanosecond precision timestamp, as described in the proposal [doc](https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit#heading=h.2nfzn4ggyl34)
2. An explicit dependence on the `chrono` library. Note that this does not add any *actual* new dependencies for datafusion because depends on `arrow` which already depends on chrono [source link](https://github.com/apache/arrow/blob/master/rust/arrow/Cargo.toml#L49).

fyi @jorgecarleitao @andygrove @emkornfield @jhorstmann

Closes #8142 from alamb/alamb/timestamp-casts

Authored-by: alamb &lt;andrew@nerdnetworks.org&gt;
Signed-off-by: Andy Grove &lt;andygrove73@gmail.com&gt;

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function
                </div><div><b>body:</b> This PR adds:
1. An implementation of the 1 argument form of the `TO_TIMESTAMP` function that takes a single argument (string) and converts it into a nanosecond precision timestamp, as described in the proposal [doc](https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit#heading=h.2nfzn4ggyl34)
2. An explicit dependence on the `chrono` library. Note that this does not add any *actual* new dependencies for datafusion because depends on `arrow` which already depends on chrono [source link](https://github.com/apache/arrow/blob/master/rust/arrow/Cargo.toml#L49).

fyi @jorgecarleitao @andygrove @emkornfield @jhorstmann 
                </div></div></li><li><div><div><b>title:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function
                </div><div><b>body:</b> This PR adds:
1. An implementation of the 1 argument form of the `TO_TIMESTAMP` function that takes a single argument (string) and converts it into a nanosecond precision timestamp, as described in the proposal [doc](https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit#heading=h.2nfzn4ggyl34)
2. An explicit dependence on the `chrono` library. Note that this does not add any *actual* new dependencies for datafusion because depends on `arrow` which already depends on chrono [source link](https://github.com/apache/arrow/blob/master/rust/arrow/Cargo.toml#L49).

fyi @jorgecarleitao @andygrove @emkornfield @jhorstmann 
                </div></div></li><li><div><div><b>title:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function
                </div><div><b>body:</b> This PR adds:
1. An implementation of the 1 argument form of the `TO_TIMESTAMP` function that takes a single argument (string) and converts it into a nanosecond precision timestamp, as described in the proposal [doc](https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit#heading=h.2nfzn4ggyl34)
2. An explicit dependence on the `chrono` library. Note that this does not add any *actual* new dependencies for datafusion because depends on `arrow` which already depends on chrono [source link](https://github.com/apache/arrow/blob/master/rust/arrow/Cargo.toml#L49).

fyi @jorgecarleitao @andygrove @emkornfield @jhorstmann 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function
                </div><div><b>body:</b> This PR adds:
1. An implementation of the 1 argument form of the `TO_TIMESTAMP` function that takes a single argument (string) and converts it into a nanosecond precision timestamp, as described in the proposal [doc](https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit#heading=h.2nfzn4ggyl34)
2. An explicit dependence on the `chrono` library. Note that this does not add any *actual* new dependencies for datafusion because depends on `arrow` which already depends on chrono [source link](https://github.com/apache/arrow/blob/master/rust/arrow/Cargo.toml#L49).

fyi @jorgecarleitao @andygrove @emkornfield @jhorstmann 
                </div></div></li><li><div><div><b>title:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function
                </div><div><b>body:</b> This PR adds:
1. An implementation of the 1 argument form of the `TO_TIMESTAMP` function that takes a single argument (string) and converts it into a nanosecond precision timestamp, as described in the proposal [doc](https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit#heading=h.2nfzn4ggyl34)
2. An explicit dependence on the `chrono` library. Note that this does not add any *actual* new dependencies for datafusion because depends on `arrow` which already depends on chrono [source link](https://github.com/apache/arrow/blob/master/rust/arrow/Cargo.toml#L49).

fyi @jorgecarleitao @andygrove @emkornfield @jhorstmann 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function
                </div><div><b>body:</b> This PR adds:
1. An implementation of the 1 argument form of the `TO_TIMESTAMP` function that takes a single argument (string) and converts it into a nanosecond precision timestamp, as described in the proposal [doc](https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit#heading=h.2nfzn4ggyl34)
2. An explicit dependence on the `chrono` library. Note that this does not add any *actual* new dependencies for datafusion because depends on `arrow` which already depends on chrono [source link](https://github.com/apache/arrow/blob/master/rust/arrow/Cargo.toml#L49).

fyi @jorgecarleitao @andygrove @emkornfield @jhorstmann 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function
                </div><div><b>body:</b> This PR adds:
1. An implementation of the 1 argument form of the `TO_TIMESTAMP` function that takes a single argument (string) and converts it into a nanosecond precision timestamp, as described in the proposal [doc](https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit#heading=h.2nfzn4ggyl34)
2. An explicit dependence on the `chrono` library. Note that this does not add any *actual* new dependencies for datafusion because depends on `arrow` which already depends on chrono [source link](https://github.com/apache/arrow/blob/master/rust/arrow/Cargo.toml#L49).

fyi @jorgecarleitao @andygrove @emkornfield @jhorstmann 
                </div></div></li><li><div><div><b>title:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function
                </div><div><b>body:</b> This PR adds:
1. An implementation of the 1 argument form of the `TO_TIMESTAMP` function that takes a single argument (string) and converts it into a nanosecond precision timestamp, as described in the proposal [doc](https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit#heading=h.2nfzn4ggyl34)
2. An explicit dependence on the `chrono` library. Note that this does not add any *actual* new dependencies for datafusion because depends on `arrow` which already depends on chrono [source link](https://github.com/apache/arrow/blob/master/rust/arrow/Cargo.toml#L49).

fyi @jorgecarleitao @andygrove @emkornfield @jhorstmann 
                </div></div></li><li><div><div><b>title:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function
                </div><div><b>body:</b> This PR adds:
1. An implementation of the 1 argument form of the `TO_TIMESTAMP` function that takes a single argument (string) and converts it into a nanosecond precision timestamp, as described in the proposal [doc](https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit#heading=h.2nfzn4ggyl34)
2. An explicit dependence on the `chrono` library. Note that this does not add any *actual* new dependencies for datafusion because depends on `arrow` which already depends on chrono [source link](https://github.com/apache/arrow/blob/master/rust/arrow/Cargo.toml#L49).

fyi @jorgecarleitao @andygrove @emkornfield @jhorstmann 
                </div></div></li><li><div><div><b>title:</b> ARROW-9944: [Rust][DataFusion] Implement to_timestamp function
                </div><div><b>body:</b> This PR adds:
1. An implementation of the 1 argument form of the `TO_TIMESTAMP` function that takes a single argument (string) and converts it into a nanosecond precision timestamp, as described in the proposal [doc](https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit#heading=h.2nfzn4ggyl34)
2. An explicit dependence on the `chrono` library. Note that this does not add any *actual* new dependencies for datafusion because depends on `arrow` which already depends on chrono [source link](https://github.com/apache/arrow/blob/master/rust/arrow/Cargo.toml#L49).

fyi @jorgecarleitao @andygrove @emkornfield @jhorstmann 
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                https://issues.apache.org/jira/browse/ARROW-9944
              </div></li><li><div>
                @andygrove  -- I have rebased this PR and I believe I have implemented all suggestions. There is one more lingering thing regarding parsing local timestamps that I want to check out but I can also do that after merge if you prefer. 
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div><div><b>body:</b> nit: Although the planner and type coercion logic should prevent errors here, we could actually return an `Err` result rather than panic.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                add `s` that failed, or just a slice of it, here?
              </div></li><li><div><div><b>body:</b> I think that we get a massive performance boost if we build `ArrayData` here (learning from @nevi-me :P). 

@nevi-me did this recently [here](https://github.com/apache/arrow/commit/9ea24092064205b9966c4e08da50ea344bf042e5#diff-084bc9b19a2397f6ba80602e2d136833R33), e.g.

```rust

let num_rows = args[0].len();
let string_args = &amp;args[0]
    .as_any()
    .downcast_ref::&lt;StringArray&gt;()
    .expect("input cast to StringArray failed");

let result = (0..num_rows).map(|i| string_to_timestamp_nanos(string_args.value(i))).collect::&lt;Result&lt;Vec&lt;i64&gt;&gt;&gt;()?;

let data = ArrayData::new(
    DataType::Timestamp(TimeUnit::Nanosecond, None),
    num_rows,
    Some(string_args.null_count()),
    string_args.data().null_buffer().cloned(),
    0,
    vec![Buffer::from(result.to_byte_slice())],
    vec![],
);
Ok(make_array(Arc::new(data)))
```
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> I'd be interested in a benchmark of this function or the kernel, maybe one for the happy case with `T` and `Z` and one for the last fallback. From my experience with Java, [parsing timestamps can be rather slow][1] and it might be worth writing a specialized implementation.

The behaviour regarding time zones should also be documented, does it default to a local time zone or to always to UTC?

Lastly, storing nanoseconds as i64 gives a range of about year 1677 to 2262, this might be a limitation for currently very few usecases but should also be mentioned.

 [1]: https://github.com/jhorstmann/packedtime#benchmarks
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Will do
              </div></li><li><div>
                good idea -- I will do so
              </div></li><li><div>
                I filed https://issues.apache.org/jira/browse/ARROW-9955 to track the (excellent) suggestion for benchmark and possible improvement based on results. I agree efficient timestamp parsing is a bit of an art form. 

I will also document both the timezone behavior as well as the date range limitations
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> [Rust] Implement TO_TIMESTAMP function
                </div><div><b>description:</b> Implement the TO_TIMESTAMP function, as described in https://docs.google.com/document/d/18O9YPRyJ3u7-58J02NtNVYb6TDWBzi3mIQC58VhwxUk/edit
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Issue resolved by pull request 8142
[https://github.com/apache/arrow/pull/8142]
              </div></li></ol></div></div></html>