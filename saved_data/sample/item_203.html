<!DOCTYPE html><html><div class="item-title">
        Item 203
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                * The default limit of concurrently happening checkpoints: one 
              </div></li><li><div>
                * The default timeout of a checkpoint attempt: 10 minutes 
              </div></li><li><div>
                *
	 * Gets the maximum time that a checkpoint may take before being discarded.
	 * 
	 * @return The checkpoint timeout, in milliseconds.
	 
              </div></li><li><div>
                 ------------------------------------------------------------------------
              </div></li><li><div>
                * Periodic checkpoint triggering interval 
              </div></li><li><div>
                *
	 * Gets the minimal pause between checkpointing attempts. This setting defines how soon the
	 * checkpoint coordinator may trigger another checkpoint after it becomes possible to trigger
	 * another checkpoint with respect to the maximum number of concurrent checkpoints
	 * (see {@link #getMaxConcurrentCheckpoints()}).
	 *
	 * @return The minimal pause before the next checkpoint is triggered.
	 
              </div></li><li><div>
                *
	 * Sets the interval in which checkpoints are periodically scheduled.
	 *
	 * &lt;p&gt;This setting defines the base interval. Checkpoint triggering may be delayed by the settings
	 * {@link #setMaxConcurrentCheckpoints(int)} and {@link #setMinPauseBetweenCheckpoints(long)}.
	 *
	 * @param checkpointInterval The checkpoint interval, in milliseconds.
	 
              </div></li><li><div>
                *
	 * Gets the maximum number of checkpoint attempts that may be in progress at the same time. If this
	 * value is &lt;i&gt;n&lt;/i&gt;, then no checkpoints will be triggered while &lt;i&gt;n&lt;/i&gt; checkpoint attempts are
	 * currently in flight. For the next checkpoint to be triggered, one checkpoint attempt would need
	 * to finish or expire.
	 * 
	 * @return The maximum number of concurrent checkpoint attempts.
	 
              </div></li><li><div>
                *
	 * Checks whether checkpointing is enabled.
	 * 
	 * @return True if checkpointing is enables, false otherwise.
	 
              </div></li><li><div>
                *
	 * Sets the maximum number of checkpoint attempts that may be in progress at the same time. If this
	 * value is &lt;i&gt;n&lt;/i&gt;, then no checkpoints will be triggered while &lt;i&gt;n&lt;/i&gt; checkpoint attempts are
	 * currently in flight. For the next checkpoint to be triggered, one checkpoint attempt would need
	 * to finish or expire.
	 * 
	 * @param maxConcurrentCheckpoints The maximum number of concurrent checkpoint attempts.
	 
              </div></li><li><div>
                *
	 * Checks whether checkpointing is forced, despite currently non-checkpointable iteration feedback.
	 * 
	 * @return True, if checkpointing is forced, false otherwise.
	 * 
	 * @deprecated This will be removed once iterations properly participate in checkpointing.
	 
              </div></li><li><div>
                * Maximum time checkpoint may take before being discarded 
              </div></li><li><div>
                *
	 * Checks whether checkpointing is forced, despite currently non-checkpointable iteration feedback.
	 * 
	 * @param forceCheckpointing The flag to force checkpointing. 
	 * 
	 * @deprecated This will be removed once iterations properly participate in checkpointing.
	 
              </div></li><li><div>
                * Maximum number of checkpoint attempts in progress at the same time 
              </div></li><li><div>
                * Flag to force checkpointing in iterative jobs 
              </div></li><li><div>
                * The default minimum pause to be made between checkpoints: none 
              </div></li><li><div>
                *
	 * Gets the checkpointing mode (exactly-once vs. at-least-once).
	 * 
	 * @return The checkpointing mode.
	 
              </div></li><li><div>
                * The default checkpoint mode: exactly once 
              </div></li><li><div>
                	/**
	 * Sets the minimal pause between checkpointing attempts. This setting defines how soon the
	 * checkpoint coordinator may trigger another checkpoint after it becomes possible to trigger
	 * another checkpoint with respect to the maximum number of concurrent checkpoints
	 * (see {@link #setMaxConcurrentCheckpoints(int)}).
	 * 
	 * &lt;p&gt;If the maximum number of concurrent checkpoints is set to one, this setting makes effectively sure
	 * that a minimum amount of time passes where no checkpoint is in progress at all.
	 * 
	 * @param minPauseBetweenCheckpoints The minimal pause before the next checkpoint is triggered.
	 */
	public void setMinPauseBetweenCheckpoints(long minPauseBetweenCheckpoints) {
		if (minPauseBetweenCheckpoints &lt; 0) {
			throw new IllegalArgumentException("Pause value must be zero or positive");
		}
		this.minPauseBetweenCheckpoints = minPauseBetweenCheckpoints;
	}
              </div></li><li><div>
                * Minimal pause between checkpointing attempts 
              </div></li><li><div>
                *
 * Configuration that captures all checkpointing related settings.
 
              </div></li><li><div>
                *
	 * Sets the maximum time that a checkpoint may take before being discarded.
	 * 
	 * @param checkpointTimeout The checkpoint timeout, in milliseconds.
	 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                * Checkpointing mode (exactly-once vs. at-least-once). 
              </div></li><li><div>
                *
	 * Gets the interval in which checkpoints are periodically scheduled.
	 * 
	 * &lt;p&gt;This setting defines the base interval. Checkpoint triggering may be delayed by the settings
	 * {@link #getMaxConcurrentCheckpoints()} and {@link #getMinPauseBetweenCheckpoints()}.
	 * 
	 * @return The checkpoint interval, in milliseconds.
	 
              </div></li><li><div>
                *
	 * Sets the checkpointing mode (exactly-once vs. at-least-once).
	 * 
	 * @param checkpointingMode The checkpointing mode.
	 
              </div></li><li><div>
                * The min time(in ms) to delay after a checkpoint could be triggered. Allows to 
	 * enforce minimum processing time between checkpoint attempts 
              </div></li><li><div>
                * Map from checkpoint ID to the pending checkpoint 
              </div></li><li><div>
                * The max time (in ms) that a checkpoint may take 
              </div></li><li><div>
                 make sure all prior timers are cancelled 
              </div></li><li><div>
                * The base checkpoint interval. Actual trigger time may be affected by the
	 * max concurrent checkpoints and minimum-pause values 
              </div></li><li><div>
                * The number of consecutive failed trigger attempts 
              </div></li><li><div>
                 guard the map against concurrent modifications
              </div></li><li><div>
                 if too many checkpoints are currently in progress, we need to mark that a request is queued
              </div></li><li><div>
                 ------------------------------------------------------------------------
              </div></li><li><div>
                * Completed checkpoints. Implementations can be blocking. Make sure calls to methods
	 * accessing this don't block the job manager actor and run asynchronously. 
              </div></li><li><div>
                * The maximum number of checkpoints that may be in progress at the same time 
              </div></li><li><div>
                 abort if the coordinator has been shutdown in the meantime
              </div></li><li><div>
                * A list of recent checkpoint IDs, to identify late messages (vs invalid ones) 
              </div></li><li><div>
                * Flag whether a triggered checkpoint should immediately schedule the next checkpoint.
	 * Non-volatile, because only accessed in synchronized scope 
              </div></li><li><div>
                 shut down the thread that handles the timeouts and pending triggers
              </div></li><li><div>
                 re-acquire the lock
 since we released the lock in the meantime, we need to re-check
 that the conditions still hold. this is clumsy, but it allows us to
 release the lock in the meantime while calls to external services are
 blocking progress, and still gives us early checks that skip work
 if no checkpoint can happen anyways
              </div></li><li><div>
                 trigger the checkpoint from the trigger timer, to finish the work of this thread before
 starting with the next checkpoint
              </div></li><li><div>
                * Actor that receives status updates from the execution graph this coordinator works for 
              </div></li><li><div>
                 ------------------------------------------------------------------------
  job status listener that schedules / cancels periodic checkpoints 
 ------------------------------------------------------------------------
              </div></li><li><div>
                 end of lock scope
              </div></li><li><div>
                * Class loader used to deserialize the state handles (as they may be user-defined) 
              </div></li><li><div>
                * Flag marking the coordinator as shut down (not accepting any messages any more) 
              </div></li><li><div>
                 make some eager pre-checks
              </div></li><li><div>
                *
	 * Triggers the queued request, if there is one.
	 * 
	 * &lt;p&gt;NOTE: The caller of this method must hold the lock when invoking the method!
	 
              </div></li><li><div>
                 this must happen outside the locked scope, because it communicates
 with external services (in HA mode) and may block for a while.
              </div></li><li><div>
                 we will actually trigger this checkpoint!
              </div></li><li><div>
                * Checkpoint ID counter to ensure ascending IDs. In case of job manager failures, these
	 * need to be ascending across job managers. 
              </div></li><li><div>
                * Flag whether a trigger request could not be handled immediately. Non-volatile, because only
	 * accessed in synchronized scope 
              </div></li><li><div>
                 sanity check: there should never be more than one trigger request queued
              </div></li><li><div>
                 create the coordinator that triggers and commits checkpoints and holds the state
              </div></li><li><div>
                 sanity checks
              </div></li><li><div>
                 periodic interval is 10 ms
 timeout is very long (200 s)
 no extra delay
 max two concurrent checkpoints
              </div></li><li><div>
                 do the final check
              </div></li><li><div>
                 validate that the pending checkpoints are there
              </div></li><li><div>
                 now we acknowledge the second checkpoint, which should subsume the first checkpoint
 and allow two more checkpoints to be triggered
 now, once we acknowledge one checkpoint, it should trigger the next one
              </div></li><li><div>
                 the coordinator should start checkpointing now
              </div></li><li><div>
                 after a while, there should be exactly as many checkpoints
 as concurrently permitted
              </div></li><li><div>
                 no checkpoint should have started so far
              </div></li><li><div>
                 for 400 ms, no further calls may come.
 there may be the case that one trigger was fired and about to
 acquire the lock, such that after cancelling it will still do
 the remainder of its work
              </div></li><li><div>
                 now, once we acknowledge one checkpoint, it should trigger the next one
              </div></li><li><div>
                 this should have immediately triggered a new checkpoint
              </div></li><li><div>
                 create some mock execution vertices and trigger some checkpoint
              </div></li><li><div>
                 periodic interval is 10 ms
 timeout is very long (200 s)
              </div></li><li><div>
                 ------------------------------------------------------------------------
  Utilities
 ------------------------------------------------------------------------
              </div></li><li><div>
                 for 400 ms, no further calls may come
 there may be the case that one trigger was fired and about to
 acquire the lock, such that after cancelling it will still do
 the remainder of its work
              </div></li><li><div>
                 periodic interval is 10 ms
 timeout is very long (200 s)
 no extra delay
              </div></li><li><div>
                 now move the state to RUNNING
              </div></li><li><div>
                 no further checkpoints should happen
              </div></li><li><div>
                 after a while, there should be exactly as many checkpoints
 as concurrently permitted 
              </div></li><li><div>
                 after a while, there should be the new checkpoints
              </div></li><li><div>
                 start another sequence of periodic scheduling
              </div></li><li><div>
                * Settings that control the checkpointing behavior 
              </div></li><li><div>
                *
	 * Gets the checkpoint config, which defines values like checkpoint interval, delay between
	 * checkpoints, etc.
	 * 
	 * @return The checkpoint config.
	 
              </div></li><li><div>
                 currently, these are all vertices
              </div></li><li><div>
                 the "at-least-once" input handler is slightly cheaper (in the absence of checkpoints),
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [FLINK-3051] [streaming] Add mechanisms to control the maximum number of concurrent checkpoints
                </div><div><b>message:</b> [FLINK-3051] [streaming] Add mechanisms to control the maximum number of concurrent checkpoints

This closes #1408

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [FLINK-3051] Control the maximum number of concurrent checkpoints
                </div><div><b>body:</b> This change introduces a parameter that lets users control at most how many checkpoints
should be in progress at any given point in time. This is very useful for
cases where the best checkpoint interval is not easy to determine, or where once in
a while checkpoints may take long. Previously, such situations lead to checkpoint
queue-up, where the system ended up being more busy with checkpoints than with processing.

After this change, the checkpoint rate will by default sort of self-regulate: The checkpoint interval is the most frequent time at which checkpoints will occur, but they will occur slower if they take longer than that interval.
### Checkpoint Config

This also introduces the CheckpointConfig class that holds all checkpointing related parameters to more simply pass them between environment, streamgraph, etc...
### Default number of concurrent checkpoints

Previously, the maximum number of concurrent checkpoints was implicitly infinite.
I would suspect that most people will want to run the system such that only one checkpoint is ever concurrently active, so I set the default value for this to 1.

In some corner cases, it may be interesting to set that value higher.
### WIP for delay between checkpoints

This also contains some WIP to define a minimum time between checkpoint attempts. That flag would tell the system not only to not do more than one checkpoint concurrently, but to leave at least a certain time between completion of one checkpoint, and the triggering of the next. It basically defines a guaranteed time that is "work only" between checkpoints.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                Good addition! More control over our checkpointing is something people were asking me at talks.

Could you add a few sentences to the documentation about this?

              </div></li><li><div>
                Where is the docs would be the best place for that?
- A new entry in the "Programing Guides" menu?
- Or a section in the streaming guide?

I would vote for the first

              </div></li><li><div>
                I think it fits best into the "Fault Tolerance" section of the Streaming Guide: https://ci.apache.org/projects/flink/flink-docs-release-0.10/apis/streaming_guide.html#fault-tolerance

If you think that section will grow to big, we could move it to a new page and link it from the streaming guide.

              </div></li><li><div>
                Should we pull that into a separate document? It becomes quite large...

              </div></li><li><div>
                +1

              </div></li><li><div>
                Will do this in a separate pull request as follow up.

Any concerns about merging this?

              </div></li><li><div>
                Please give me an hour or so to look at this :)

              </div></li><li><div>
                Looks good and the minimum delay between checkpoints would be an extremely useful feature. What's missing for that?

              </div></li><li><div>
                Missing for that is a bit of code in the checkpoint coordinator that marks the time when checkpoints become possible again and adds that delay to the time when the next checkpoint is scheduled.

I'd suggest to add that as a followup...

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Define a maximum number of concurrent inflight checkpoints
                </div><div><b>description:</b> The checkpoint coordinator should define an option to limit the maximum number of current inflight checkpoints, as well as the checkpoint timeouts.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                As part of this feature, I also started adding a config object that allows to define more checkpoint properties, like timeouts, delays between checkpoint attempts, maximum number of in-flight checkpoints...
              </div></li><li><div>
                GitHub user StephanEwen opened a pull request:

    https://github.com/apache/flink/pull/1408

    [FLINK-3051] Control the maximum number of concurrent checkpoints

    This change introduces a parameter that lets users control at most how many checkpoints
    should be in progress at any given point in time. This is very useful for
    cases where the best checkpoint interval is not easy to determine, or where once in
    a while checkpoints may take long. Previously, such situations lead to checkpoint
    queue-up, where the system ended up being more busy with checkpoints than with processing.
    
    After this change, the checkpoint rate will by default sort of self-regulate: The checkpoint interval is the most frequent time at which checkpoints will occur, but they will occur slower if they take longer than that interval.
    
    ### Checkpoint Config
    
    This also introduces the CheckpointConfig class that holds all checkpointing related parameters to more simply pass them between environment, streamgraph, etc...
    
    ### Default number of concurrent checkpoints
    
    Previously, the maximum number of concurrent checkpoints was implicitly infinite.
    I would suspect that most people will want to run the system such that only one checkpoint is ever concurrently active, so I set the default value for this to 1.
    
    In some corner cases, it may be interesting to set that value higher.
    
    ### WIP for delay between checkpoints
    
    This also contains some WIP to define a minimum time between checkpoint attempts. That flag would tell the system not only to not do more than one checkpoint concurrently, but to leave at least a certain time between completion of one checkpoint, and the triggering of the next. It basically defines a guaranteed time that is "work only" between checkpoints.


You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/StephanEwen/incubator-flink checkpoints_configure

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/flink/pull/1408.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #1408
    
----
commit e4d063867ac09cbec6666ecbca92816cfb6faf6c
Author: Stephan Ewen &lt;sewen@apache.org&gt;
Date:   2015-11-19T17:03:55Z

    [hotfix] Java-7-ify the ExecutionConfig class

commit 79def44a2e973c8b6817821d5d7342731f7e7aa2
Author: Stephan Ewen &lt;sewen@apache.org&gt;
Date:   2015-11-19T18:05:47Z

    [FLINK-3051] [streaming] Add mechanisms to control the maximum number of concurrent checkpoints

----

              </div></li><li><div>
                Github user rmetzger commented on the pull request:

    https://github.com/apache/flink/pull/1408#issuecomment-159851509
  
    Good addition! More control over our checkpointing is something people were asking me at talks.
    
    Could you add a few sentences to the documentation about this?

              </div></li><li><div>
                Github user StephanEwen commented on the pull request:

    https://github.com/apache/flink/pull/1408#issuecomment-159866582
  
    Where is the docs would be the best place for that?
      - A new entry in the "Programing Guides" menu?
      - Or a section in the streaming guide?
    
    I would vote for the first

              </div></li><li><div>
                Github user rmetzger commented on the pull request:

    https://github.com/apache/flink/pull/1408#issuecomment-159868163
  
    I think it fits best into the "Fault Tolerance" section of the Streaming Guide: https://ci.apache.org/projects/flink/flink-docs-release-0.10/apis/streaming_guide.html#fault-tolerance
    
    If you think that section will grow to big, we could move it to a new page and link it from the streaming guide.

              </div></li><li><div>
                Github user StephanEwen commented on the pull request:

    https://github.com/apache/flink/pull/1408#issuecomment-159872110
  
    Should we pull that into a separate document? It becomes quite large...

              </div></li><li><div>
                Github user rmetzger commented on the pull request:

    https://github.com/apache/flink/pull/1408#issuecomment-159872462
  
    +1

              </div></li><li><div>
                Github user StephanEwen commented on the pull request:

    https://github.com/apache/flink/pull/1408#issuecomment-159876995
  
    Will do this in a separate pull request as follow up.
    
    Any concerns about merging this?

              </div></li><li><div>
                Github user gyfora commented on the pull request:

    https://github.com/apache/flink/pull/1408#issuecomment-159910663
  
    Please give me an hour or so to look at this :)

              </div></li><li><div>
                Github user gyfora commented on the pull request:

    https://github.com/apache/flink/pull/1408#issuecomment-159915515
  
    Looks good and the minimum delay between checkpoints would be an extremely useful feature. What's missing for that?

              </div></li><li><div>
                Github user StephanEwen commented on the pull request:

    https://github.com/apache/flink/pull/1408#issuecomment-159932475
  
    Missing for that is a bit of code in the checkpoint coordinator that marks the time when checkpoints become possible again and adds that delay to the time when the next checkpoint is scheduled.
    
    I'd suggest to add that as a followup...

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/flink/pull/1408

              </div></li><li><div>
                Fixed via 55fd5f32d7ef0292a01192ab08456fae49b91791
              </div></li></ol></div></div></html>