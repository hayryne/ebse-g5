<!DOCTYPE html><html><div class="item-title">
        Item 84
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> LUCENE-1654: Fix UOE with old-style user-data indexes.
                </div><div><b>message:</b> LUCENE-1654: Fix UOE with old-style user-data indexes.

git-svn-id: https://svn.apache.org/repos/asf/lucene/java/trunk@779686 13f79535-47bb-0310-9956-ffa450edef68

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Include diagnostics per-segment when writing a new segment
                </div><div><b>description:</b> It would be very helpful if each segment in an index included
diagnostic information, such as the current version of Lucene.

EG, in LUCENE-1474 this would be very helpful to see if certain
segments were written under 2.4.0.

We can start with just the current version.

We could also consider making this extensible, so you could provide
your own arbitrary diagnostics, but SegmentInfo/s is not public so I
think such an API would be "one-way" in that you'd have to use
CheckIndex to check on it later.  Or we could wait on such extensibility
until we provide some consistent way to access per-segment details
in the index.

                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Let's have string key-value pairs per-segment, per-commit, per-index?
Lucene can store debugging data there, user can add something if he needs.

We can design some unified metadata interface available through IndexReader and won't expose SegmentInfo (doing this with our current back-compat policies is akin to suicide)
              </div></li><li><div>
                bq. Let's have string key-value pairs per-segment, per-commit, per-index?

This would be great, but it's quite a bit more work than having IW include its own diagnostics per-segment.

Can you open a separate issue for that?
              </div></li><li><div>
                We can start with string key-value pairs per-segment that are created only from inside Lucene and leave everything else for the latter.

What I'm trying to avoid is writing a partial solution, then a more generic one (with different implementation) and having to keep that partial solution around because it was already released. I.e. you're going to extend segment file format, right? Let it be key-value pairs from the start, instead of a single Int that is predetermined to be Lucene's version.
              </div></li><li><div>
                OK I'll start with that.
              </div></li><li><div>
                OK I added per-segment private storage of diagnostics within IW.  It
records the current Lucene version plus OS &amp; Java version details, and
the reason for the segment (flush or merge) as a Map&lt;String, String&gt;.

I also changed the commitUserData to be a Map&lt;String,String&gt; too.
This API has not yet been released so we are free to change it.

CheckIndex now prints both the commit level and per-segment level
maps.

I added Constants.LUCENE_VERSION to record the current version.  I try
to look up the impl version from the manifest and use that, else I
fallback to a String constant (now 2.9-dev).  I also added a unit test
that asserts this value matches what's in common-build.xml.

When I commit I'll update ReleaseTodo on the wiki to remember to
update this value.

I plan to commit in a day or two.

              </div></li><li><div><div><b>body:</b> Let's use Collections.EMPTY_MAP instead of new HashMap() for empty maps?
If I correctly read the patch, you retained HasUserData/CommitUserData in file format description, while it was totally removed from the code (except for back-compat read).
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Excellent catches Earwin, thanks!  New patch attached.
              </div></li><li><div>
                This seems useful for including debug info?
              </div></li><li><div><div><b>body:</b> bq. This seems useful for including debug info?

You mean making the API public?

It's the reading side of that API that makes me nervous (SegmentInfo/s is not public).

Or do you think it'd be useful to allow one to "setDiagnostics(Map&lt;String,String&gt;)" in IW, but only see such diagnostics on running CheckIndex?  That'd be a much smaller change.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> bq. It's the reading side of that API that makes me nervous (SegmentInfo/s is not public).
No-no-no, don't open it up, it's suicidal :)

We can theoretically allow access to per-segment data from segment readers, as they have 1-1 relation.
So, when I finish always-use-MSR patch, you should be able to get per-commit data from MSR and per-segment from SR using the same API. Sounds somewhat dirty, but would work well... needs more thought.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> bq. You mean making the API public?

I was thinking it could be (not sure) useful for debugging or
assertions in LUCENE-1313. I wasn't sure if this was an intended
use or would simply be extra noise?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                OK let's hold off on the public API.

Jason can you give an example of how you'd use this in LUCENE-1313?  I don't see the connection.  The initial intention was exactly cases like LUCENE-1474 where I'd really like to know which Lucene version wrote a given segment, in helping to debug.
              </div></li><li><div>
                I found a bug for indexes with the string-based userdata:
{code}
      if (format &lt;= FORMAT_USER_DATA) {
        if (format &lt;= FORMAT_DIAGNOSTICS) {
          userData = input.readStringStringMap();
        } else {
          userData = Collections.EMPTY_MAP;
          if (0 != input.readByte()) {
            userData.put("userData", input.readString());
          }
        }
      } else {
        userData = Collections.EMPTY_MAP;
      }
{code}

But the empty maps of Collections are read-only, so put() throws UOE.

I fix this and commit: userData should be a singleton map, if 0!=readByte(), otherwise EMPTY_MAP. 
              </div></li><li><div>
                Woops -- thanks Uwe!
              </div></li></ol></div></div></html>