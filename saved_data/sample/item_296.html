<!DOCTYPE html><html><div class="item-title">
        Item 296
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
    * The DataSource to use to store Artemis data in the data store (can be {@code null} if {@code jdbcConnectionUrl} and {@code jdbcDriverClassName} are used instead).
    *
    * @return the DataSource used to store Artemis data in the JDBC data store.
    
              </div></li><li><div>
                *
    * The {@link SQLProvider.Factory} used to communicate with the JDBC data store.
    * It can be {@code null}. If the value is {@code null} and {@code dataSource} is set, the {@code {@link org.apache.activemq.artemis.jdbc.store.sql.GenericSQLProvider.Factory} will be user,
    * else the type of the factory will be determined based on the {@code jdbcDriverClassName).
    *
    * @return the factory used to communicate with the JDBC data store.
    
              </div></li><li><div>
                *
    * Configure the DataSource to use to store Artemis data in the data store.
    *
    * @param dataSource
    
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> ARTEMIS-714 Add suport for DataSource and SQLProvider
                </div><div><b>message:</b> ARTEMIS-714 Add suport for DataSource and SQLProvider

* add DataSource property to DatabaseStorageConfiguration to be able to
  communicate with the data store using this DataSource instance instead
  of relying on the creation the SQL connnection using the JDBC connection
  URL/driver class name tuple.
* add SQLProvider.Factory property to DatabaseStorageConfiguration to
  externalize the choice of the SQLProvider instead of relying on
  hard-coded choices. If the property is null, the current behaviour will
  be used (determing the SQLProvider based on the driver class name)
* bindingsJournal and messageJournal are already started in the start()
  method. Remove redundant calls that were creating unused JDBC
  connections that are never closed.

JIRA: https://issues.apache.org/jira/browse/ARTEMIS-714

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> JDBC Store improvement
                </div><div><b>description:</b> We plan to integrate with Artemis JDBC store in our application server.

After a code review, we saw 2 main improvements that would make the code more flexible and easier to maintain.

First, in our app server, we have our sophisticated way to configure access to databases. We would like to be able to pass a DataSource instance to Artemis JDBC store instead of a (driver class name / URL) tuple. 
If the DataSource object is set, we create a Connection from it, otherwise we use the current code to create the connection from a class name + URL. This will introduce no changes to use of standalone Artemis broker.

The second improvement is to make the SQLProvider injectable instead of relying on hard-coded class provided by Artemis jars.
We would create an instance of the SQLProvider in our integration code and pass it to Artemis JDBC store. This will make it simpler to support new types of databases (or fix issues in the SQLProvider implementations) without requiring a new release of Artemis for that.
If the SQLProvider instance injected in the JDBC store is null, the current code will be executed.

Does these improvements sound correct?

                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                GitHub user jmesnil opened a pull request:

    https://github.com/apache/activemq-artemis/pull/771

    ARTEMIS-714 Improve JDBC Store

    add DataSource and SQLProvider.Factory properties to DataStorageConfiguration to externalize the configuration of the communication with the JDBC data store instead of relying on global class path to load the SQL connection and hard-coded values for the SQL provider choice
    
    JIRA: https://issues.apache.org/jira/browse/ARTEMIS-714

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/jmesnil/activemq-artemis ARTEMIS-714_JDBC_store

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/activemq-artemis/pull/771.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #771
    
----
commit c2113b018177c3806c7dbad1f5ca8d2a0d383469
Author: Jeff Mesnil &lt;jmesnil@gmail.com&gt;
Date:   2016-09-08T15:46:09Z

    ARTEMIS-714 Improve JDBC Store
    
    add DataSource property to DatabaseStorageConfiguration to be able to
    communicate with the data store using this DataSource instance instead
    of relying on the creation the SQL connnection using the JDBC connection
    URL/driver class name tuple.
    
    JIRA: https://issues.apache.org/jira/browse/ARTEMIS-714

commit 84328f070b928d353ce81153c1b86a4f287db6cc
Author: Jeff Mesnil &lt;jmesnil@gmail.com&gt;
Date:   2016-09-09T14:47:03Z

    ARTEMIS-714 Improve JDBC store
    
    bindingsJournal and messageJournal are already started in the start()
    method. Remove redundant calls that were creating unused JDBC
    connections that are never closed.
    
    JIRA: https://issues.apache.org/jira/browse/ARTEMIS-714

commit 94dc242d5374e51a3ee854faaaa305df399ed9c3
Author: Jeff Mesnil &lt;jmesnil@gmail.com&gt;
Date:   2016-09-12T09:17:53Z

    ARTEMIS-714 Improve JDBC store
    
    add SQLProvider.Factory property to DatabaseStorageConfiguration to
    externalize the choice of the SQLProvider instead of relying on
    hard-coded choices. If the property is null, the current behaviour will
    be used (determing the SQLProvider based on the driver class name)
    
    JIRA: https://issues.apache.org/jira/browse/ARTEMIS-714

----

              </div></li><li><div>
                Github user jmesnil commented on the issue:

    https://github.com/apache/activemq-artemis/pull/771
  
    rebased

              </div></li><li><div>
                Github user clebertsuconic commented on the issue:

    https://github.com/apache/activemq-artemis/pull/771
  
    @jmesnil there was some changes I made to JDBC that are conflicting with this. Do you mine looking at them?
    
    Also.. this is showing 3 commits.. shouldn't you squash them and push -f to your branch?

              </div></li><li><div>
                Github user jmesnil commented on the issue:

    https://github.com/apache/activemq-artemis/pull/771
  
    retest this please

              </div></li><li><div>
                Github user clebertsuconic commented on the issue:

    https://github.com/apache/activemq-artemis/pull/771
  
    @jmesnil I don't think the retest works...
    
    When I need that I do:
    
    git commit --amend
    git push origin -f
    
    (and don't change anything.. just to change the commit ID)

              </div></li><li><div>
                Github user clebertsuconic commented on the issue:

    https://github.com/apache/activemq-artemis/pull/771
  
    @jmesnil  but the failure is real.
    
    try it yourself:
    
    
    # We disable checkstyles unless you are using the dev profile
    mvn install -Pdev

              </div></li><li><div>
                Github user mtaylor commented on the issue:

    https://github.com/apache/activemq-artemis/pull/771
  
    @jmesnil Could you please update the commit message to something more descriptive. e.g. Adds support for DataSource and SQL providers.

              </div></li><li><div>
                Github user clebertsuconic commented on the issue:

    https://github.com/apache/activemq-artemis/pull/771
  
    @jmesnil Can you take a look into  org.apache.activemq.artemis.tests.integration.client.LargeMessage
    
    If you run any JDBC test, there's a NPE happening:
    
    
    ```java
    [main] 15:27:39,377 WARN  [org.apache.activemq.artemis.core.server] AMQ222010: Critical IO Error, shutting down the server. file=NULL, message=null: java.lang.NullPointerException
    	at org.apache.activemq.artemis.core.persistence.impl.journal.JDBCJournalStorageManager.init(JDBCJournalStorageManager.java:89) [:]
    	at org.apache.activemq.artemis.core.persistence.impl.journal.AbstractJournalStorageManager.&lt;init&gt;(AbstractJournalStorageManager.java:208) [:]
    	at org.apache.activemq.artemis.core.persistence.impl.journal.JournalStorageManager.&lt;init&gt;(JournalStorageManager.java:97) [:]
    	at org.apache.activemq.artemis.core.persistence.impl.journal.JDBCJournalStorageManager.&lt;init&gt;(JDBCJournalStorageManager.java:47) [:]
    	at org.apache.activemq.artemis.core.server.impl.ActiveMQServerImpl.createStorageManager(ActiveMQServerImpl.java:1799) [:]
    	at org.apache.activemq.artemis.core.server.impl.ActiveMQServerImpl.initialisePart1(ActiveMQServerImpl.java:1930) [:]
    	at org.apache.activemq.artemis.core.server.impl.LiveOnlyActivation.run(LiveOnlyActivation.java:61) [:]
    	at org.apache.activemq.artemis.core.server.impl.ActiveMQServerImpl.start(ActiveMQServerImpl.java:447) [:]
    	at org.apache.activemq.artemis.tests.integration.client.LargeMessageTest.testBufferMultipleLargeMessages(LargeMessageTest.java:1655) [:]
    	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) [rt.jar:1.8.0_73]
    	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) [rt.jar:1.8.0_73]
    	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) [rt.jar:1.8.0_73]
    	at java.lang.reflect.Method.invoke(Method.java:497) [rt.jar:1.8.0_73]
    	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47) [junit-4.11.jar:]
    	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12) [junit-4.11.jar:]
    	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44) [junit-4.11.jar:]
    	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17) [junit-4.11.jar:]
    	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26) [junit-4.11.jar:]
    	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27) [junit-4.11.jar:]
    	at org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48) [junit-4.11.jar:]
    	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55) [junit-4.11.jar:]
    	at org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48) [junit-4.11.jar:]
    	at org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48) [junit-4.11.jar:]
    	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55) [junit-4.11.jar:]
    	at org.junit.rules.RunRules.evaluate(RunRules.java:20) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271) [junit-4.11.jar:]
    	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70) [junit-4.11.jar:]
    	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner.run(ParentRunner.java:309) [junit-4.11.jar:]
    	at org.junit.runners.Suite.runChild(Suite.java:127) [junit-4.11.jar:]
    	at org.junit.runners.Suite.runChild(Suite.java:26) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:63) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:236) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:53) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:229) [junit-4.11.jar:]
    	at org.junit.runners.ParentRunner.run(ParentRunner.java:309) [junit-4.11.jar:]
    	at org.junit.runner.JUnitCore.run(JUnitCore.java:160) [junit-4.11.jar:]
    	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69) [junit-rt.jar:]
    	at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:234) [junit-rt.jar:]
    	at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:74) [junit-rt.jar:]
    	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) [rt.jar:1.8.0_73]
    	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) [rt.jar:1.8.0_73]
    	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) [rt.jar:1.8.0_73]
    	at java.lang.reflect.Method.invoke(Method.java:497) [rt.jar:1.8.0_73]
    	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:144) [idea_rt.jar:]
    ```
    
    
    I tried to fix it myself but I couldn't figure out your intention here. I guess you can fix it faster than I could.
    
    
    I found this running the whole testsuite. The tests will hang after this failure.

              </div></li><li><div>
                Github user clebertsuconic commented on the issue:

    https://github.com/apache/activemq-artemis/pull/771
  
    one last regressions:
    
    org.apache.activemq.artemis.tests.integration.jdbc.store.journal.JDBCJournalTest

              </div></li><li><div><div><b>body:</b> Commit c33f29631f9556e3a28140e0d14a99e0101b8e03 in activemq-artemis's branch refs/heads/master from [~jmesnil]
[ https://git-wip-us.apache.org/repos/asf?p=activemq-artemis.git;h=c33f296 ]

ARTEMIS-714 Add suport for DataSource and SQLProvider

* add DataSource property to DatabaseStorageConfiguration to be able to
  communicate with the data store using this DataSource instance instead
  of relying on the creation the SQL connnection using the JDBC connection
  URL/driver class name tuple.
* add SQLProvider.Factory property to DatabaseStorageConfiguration to
  externalize the choice of the SQLProvider instead of relying on
  hard-coded choices. If the property is null, the current behaviour will
  be used (determing the SQLProvider based on the driver class name)
* bindingsJournal and messageJournal are already started in the start()
  method. Remove redundant calls that were creating unused JDBC
  connections that are never closed.

JIRA: https://issues.apache.org/jira/browse/ARTEMIS-714

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> Commit c33f29631f9556e3a28140e0d14a99e0101b8e03 in activemq-artemis's branch refs/heads/master from [~jmesnil]
[ https://git-wip-us.apache.org/repos/asf?p=activemq-artemis.git;h=c33f296 ]

ARTEMIS-714 Add suport for DataSource and SQLProvider

* add DataSource property to DatabaseStorageConfiguration to be able to
  communicate with the data store using this DataSource instance instead
  of relying on the creation the SQL connnection using the JDBC connection
  URL/driver class name tuple.
* add SQLProvider.Factory property to DatabaseStorageConfiguration to
  externalize the choice of the SQLProvider instead of relying on
  hard-coded choices. If the property is null, the current behaviour will
  be used (determing the SQLProvider based on the driver class name)
* bindingsJournal and messageJournal are already started in the start()
  method. Remove redundant calls that were creating unused JDBC
  connections that are never closed.

JIRA: https://issues.apache.org/jira/browse/ARTEMIS-714

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/activemq-artemis/pull/771

              </div></li><li><div>
                [~jmesnil] Is this now complete?
              </div></li><li><div>
                [~martyntaylor] I think so, I was able to write a POC that pass the DataSource from our app server to Artemis and it worked fine.
              </div></li><li><div>
                Great.  I'll close this out then.
              </div></li></ol></div></div></html>