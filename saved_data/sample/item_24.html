<!DOCTYPE html><html><div class="item-title">
        Item 24
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 This should never happen. But as the pool is provided by the end user,
 let's secure this a little.
              </div></li><li><div>
                 see #HBASE-14359 for more details
              </div></li><li><div>
                 We're likely to fail again, but this will increment the attempt counter,
 so it will finish.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HBASE-14359 HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction (Victor Xu)
                </div><div><b>message:</b> HBASE-14359 HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction (Victor Xu)

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction
                </div><div><b>description:</b> Currently in AsyncProcess#sendMultiAction, we only catch the RejectedExecutionException and let other error/exception go, which will cause decTaskCounter not invoked. Meanwhile, the recommendation for using HTable is to close the table in the finally clause, and HTable#close will call flushCommits and wait until all task done.

The problem is when unchecked error/exception like OutOfMemoryError thrown, taskSent will never be equal to taskDone, so AsyncProcess#waitUntilDone will never return. Especially, if autoflush is set thus no data to flush during table close, there would be no rpc call so rpcTimeOut will not break the call, and thread will wait there forever.

In our product env, the unchecked error we observed is "java.lang.OutOfMemoryError: unable to create new native thread", and we observed the client thread hang for hours
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Submit patches for master, branch-1.X and 0.98.
              </div></li><li><div>
                Add jstack output for this issue:
{noformat}
"Thread-14" daemon prio=10 tid=0x00007fc9f7c0d800 nid=0x125b in Object.wait() [0x0000000043acc000]
   java.lang.Thread.State: TIMED_WAITING (on object monitor)
        at java.lang.Object.wait(Native Method)
        at org.apache.hadoop.hbase.client.AsyncProcess.waitForNextTaskDone(AsyncProcess.java:988)
        - locked &lt;0x0000000788126080&gt; (a java.util.concurrent.atomic.AtomicLong)
        at org.apache.hadoop.hbase.client.AsyncProcess.waitForMaximumCurrentTasks(AsyncProcess.java:1014)
        at org.apache.hadoop.hbase.client.AsyncProcess.waitUntilDone(AsyncProcess.java:1027)
        at org.apache.hadoop.hbase.client.HTable.backgroundFlushCommits(HTable.java:1092)
        - locked &lt;0x0000000788126168&gt; (a java.lang.Object)
        at org.apache.hadoop.hbase.client.HTable.flushCommits(HTable.java:1424)
        at org.apache.hadoop.hbase.client.HTable.close(HTable.java:1461)
        at com.alibaba.search.offline.sync.common.hbase.HBaseTable.returnHTable(HBaseTable.java:136)
        at com.alibaba.search.offline.sync.common.hbase.HBaseTable.batchPut(HBaseTable.java:185)
        at com.alibaba.search.offline.sync.common.hbase.HBaseTable.batchPut(HBaseTable.java:159)
        at com.alibaba.search.offline.sync.sync.storage.HBaseStorageHandler.multiPut(HBaseStorageHandler.java:80)
        at com.alibaba.search.offline.sync.sync.LoaderProcessor.doEveryTable(LoaderProcessor.java:130)
        at com.alibaba.search.offline.sync.sync.LoaderProcessor.execute(LoaderProcessor.java:50)
        at com.alibaba.search.offline.sync.sync.ProcessorRunner.perform(ProcessorRunner.java:58)
        at com.alibaba.search.offline.sync.sync.DaemonWorker.daemonWork(DaemonWorker.java:51)
        - locked &lt;0x00000007809c4e48&gt; (a com.alibaba.search.offline.sync.sync.ProcessorRunner)
        at com.alibaba.search.offline.sync.sync.DaemonWorker.run(DaemonWorker.java:31)
{noformat}
All user processes hang in the while loop of AsyncProcess#waitForNextTaskDone.
              </div></li><li><div>
                Looks good. 
Does this solve the problem in your cluster ?

QA can only apply one patch to one branch. There is no need to label patch with two branch names. 
Also, it should be branch-1, not branch1. 
              </div></li><li><div>
                Resubmit patches for master and branch-1.
              </div></li><li><div>
                Yes, it does. It's not easy to reproduce this issue in UT, so I tested this patch on production cluster.
              </div></li><li><div><div><b>body:</b> {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12753980/HBASE-14359-branch-1-v1.patch
  against branch-1 branch at commit 3341f13e71a25bf3f8eb5a6a57ce330b3d8a3495.
  ATTACHMENT ID: 12753980

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 hadoop versions{color}. The patch compiles with all supported hadoop versions (2.4.0 2.4.1 2.5.0 2.5.1 2.5.2 2.6.0 2.7.0 2.7.1)

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 protoc{color}.  The applied patch does not increase the total number of protoc compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 checkstyle{color}.  The applied patch does not increase the total number of checkstyle errors

    {color:green}+1 findbugs{color}.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 lineLengths{color}.  The patch does not introduce lines longer than 100

  {color:green}+1 site{color}.  The mvn post-site goal succeeds with this patch.

     {color:red}-1 core tests{color}.  The patch failed these unit tests:
     

     {color:red}-1 core zombie tests{color}.  There are 5 zombie test(s): 	at org.apache.hadoop.hbase.security.access.TestAccessControlFilter.testQualifierAccess(TestAccessControlFilter.java:96)

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/15405//testReport/
Release Findbugs (version 2.0.3) 	warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/15405//artifact/patchprocess/newFindbugsWarnings.html
Checkstyle Errors: https://builds.apache.org/job/PreCommit-HBASE-Build/15405//artifact/patchprocess/checkstyle-aggregate.html

  Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/15405//console

This message is automatically generated.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12753973/HBASE-14359-master-branch1-v1.patch
  against master branch at commit 3341f13e71a25bf3f8eb5a6a57ce330b3d8a3495.
  ATTACHMENT ID: 12753973

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 hadoop versions{color}. The patch compiles with all supported hadoop versions (2.4.0 2.4.1 2.5.0 2.5.1 2.5.2 2.6.0 2.7.0 2.7.1)

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 protoc{color}.  The applied patch does not increase the total number of protoc compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 checkstyle{color}.  The applied patch does not increase the total number of checkstyle errors

    {color:green}+1 findbugs{color}.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 lineLengths{color}.  The patch does not introduce lines longer than 100

  {color:green}+1 site{color}.  The mvn post-site goal succeeds with this patch.

    {color:green}+1 core tests{color}.  The patch passed unit tests in .

     {color:red}-1 core zombie tests{color}.  There are 1 zombie test(s): 

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/15404//testReport/
Release Findbugs (version 2.0.3) 	warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/15404//artifact/patchprocess/newFindbugsWarnings.html
Checkstyle Errors: https://builds.apache.org/job/PreCommit-HBASE-Build/15404//artifact/patchprocess/checkstyle-aggregate.html

  Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/15404//console

This message is automatically generated.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                lgtm

Committing shortly after running some local tests unless objection
              </div></li><li><div>
                Nice bit of sleuthing here [~victorunique]. Could be a reason our tests hang over on builds.apache.org when resources get tight.
              </div></li><li><div>
                bq. Could be a reason our tests hang over on builds.apache.org when resources get tight.

For sure we were seeing cases of OOME can't create native threads lately. Some of this has been ameliorated by our spinning up less threads when testing but still work to do.
              </div></li><li><div>
                This online issue has been bothering us for a week and now it's a release of suffer. Hope it could cure the zombie tests here also. :-)
              </div></li><li><div>
                Pushed to 0.98 and up. 
              </div></li><li><div>
                FAILURE: Integrated in HBase-1.0 #1039 (See [https://builds.apache.org/job/HBase-1.0/1039/])
HBASE-14359 HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction (Victor Xu) (apurtell: rev 0564bfc81a7b035eb49a3d016d094ce9ab2ebb90)
* hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncProcess.java

              </div></li><li><div>
                FAILURE: Integrated in HBase-TRUNK #6777 (See [https://builds.apache.org/job/HBase-TRUNK/6777/])
HBASE-14359 HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction (Victor Xu) (apurtell: rev 2481b7f76fa7e4f2b120f8dc96004790b357e569)
* hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncProcess.java

              </div></li><li><div>
                FAILURE: Integrated in HBase-1.2 #150 (See [https://builds.apache.org/job/HBase-1.2/150/])
HBASE-14359 HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction (Victor Xu) (apurtell: rev 1e411c8ead80067bc4c57c4d357b05e161d29eed)
* hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncProcess.java

              </div></li><li><div>
                SUCCESS: Integrated in HBase-1.1 #649 (See [https://builds.apache.org/job/HBase-1.1/649/])
HBASE-14359 HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction (Victor Xu) (apurtell: rev beaecd11398f465c05d742b49e496133179dbb09)
* hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncProcess.java

              </div></li><li><div>
                SUCCESS: Integrated in HBase-1.2-IT #126 (See [https://builds.apache.org/job/HBase-1.2-IT/126/])
HBASE-14359 HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction (Victor Xu) (apurtell: rev 1e411c8ead80067bc4c57c4d357b05e161d29eed)
* hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncProcess.java

              </div></li><li><div>
                FAILURE: Integrated in HBase-1.3 #148 (See [https://builds.apache.org/job/HBase-1.3/148/])
HBASE-14359 HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction (Victor Xu) (apurtell: rev 513b37603dec42e54a7ea4add0254c71ba6c87b6)
* hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncProcess.java

              </div></li><li><div>
                FAILURE: Integrated in HBase-0.98 #1110 (See [https://builds.apache.org/job/HBase-0.98/1110/])
HBASE-14359 HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction (Victor Xu) (apurtell: rev 3e68b1e9957df83173730b00bdf8dd5159e1a1a9)
* hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncProcess.java

              </div></li><li><div>
                FAILURE: Integrated in HBase-0.98-on-Hadoop-1.1 #1063 (See [https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/1063/])
HBASE-14359 HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction (Victor Xu) (apurtell: rev 3e68b1e9957df83173730b00bdf8dd5159e1a1a9)
* hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncProcess.java

              </div></li><li><div>
                SUCCESS: Integrated in HBase-1.3-IT #132 (See [https://builds.apache.org/job/HBase-1.3-IT/132/])
HBASE-14359 HTable#close will hang forever if unchecked error/exception thrown in AsyncProcess#sendMultiAction (Victor Xu) (apurtell: rev 513b37603dec42e54a7ea4add0254c71ba6c87b6)
* hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncProcess.java

              </div></li><li><div>
                Attaching addendum patch for adding UT for this case. The patch for trunk also applies for branch-1, while branch-0.98 needs a different one.
              </div></li><li><div>
                Tests Done:
Reverted patch of this JIRA on trunk/branch-1/branch-0.98 and confirmed all failed the newly added test case, while all could pass with current code base.
              </div></li><li><div>
                Bulk closing 1.1.3 issues.
              </div></li></ol></div></div></html>