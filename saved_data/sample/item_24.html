<!DOCTYPE html><html><div class="item-title">
        Item 24
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 We do not need to do a column reset since we are carefully changing the output.
              </div></li><li><div>
                *
 * Base class for vectorized implementation of GenericUDFMurmurHash. See subclasses for int/string
 * parameter variations.
 
              </div></li><li><div>
                *
   * The actual hash method for an item in the input vectors. This implementation is supposed to be
   * in line with non-vectorized one (ObjectInspectorUtils.getBucketHashCode) for multiple fields.
   * The method is abstract and is supposed to be implemented in subclasses.
   
              </div></li><li><div>
                 if any of the first element is not null, calculate hash
              </div></li><li><div>
                 otherwise, hash is 0
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                 return immediately if batch is empty
              </div></li><li><div>
                 output of hash will never be null
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
 * Vectorized expression for hash(Column[int], Column[int]).
 
              </div></li><li><div>
                 hash of value from 1. column
              </div></li><li><div>
                 hash of value from 2. column
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
 * Vectorized expression for hash(Column[string], Column[int]).
 
              </div></li><li><div>
                 hash of value from 1. column
              </div></li><li><div>
                 hash of value from 2. column
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
 * Vectorized expression for hash(Column[string], Column[string]).
 
              </div></li><li><div>
                 hash of value from 1. column
              </div></li><li><div>
                 hash of value from 2. column
              </div></li><li><div>
                 both of the inputs were repeating
              </div></li><li><div>
                 output's first element is 0, which is hash of null elements
              </div></li><li><div>
                 output's first element is the hash of first input elements
              </div></li><li><div>
                 if isRepeating, vectorization logic is not supposed to touch other elements than 0th
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                 fake output value to test short-circuiting
              </div></li><li><div>
                 non-repeating
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HIVE-23976: Enable vectorization for multi-col semi join reducers (Laszlo Bodor, reviewed by Stamatis Zampetakis, Jesus Camacho Rodriguez)
                </div><div><b>message:</b> HIVE-23976: Enable vectorization for multi-col semi join reducers (Laszlo Bodor, reviewed by Stamatis Zampetakis, Jesus Camacho Rodriguez)

Closes apache/hive#1458
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> HIVE-23976: Enable vectorization for multi-col semi join reducers
                </div><div><b>body:</b> ### What changes were proposed in this pull request?
Implement vectorized expression for murmur hash.

### Why are the changes needed?
Implement vectorized expression for murmur hash in order to stay vectorized for multi-key bloom filter path.


### Does this PR introduce _any_ user-facing change?
No, but this is an improvement change, which appears in the explain plan.

### How was this patch tested?
Unit test attached.
Explain plan shows expected results.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                @t3rmin4t0r , @zabetak , @ramesh0201: could you please take a look? good-old vectorization coverage patch, murmurhash with 2 column params
              </div></li><li><div>
                This pull request has been automatically marked as stale because it has not had recent activity. It will be closed if no further activity occurs.
Feel free to reach out on the dev@hive.apache.org list if the patch is in need of reviews.
              </div></li><li><div>
                @abstractdog , @zabetak , this PR has been labeled as stale and is about to be closed automatically. What is the status: Does it need more work or is it ready to be pushed?

              </div></li><li><div>
                There are some comments in the JIRA case but we could possibly treat them as follow-ups if necessary. This PR is in good shape already so I think it can be merged as is.
              </div></li><li><div>
                @abstractdog , can you trigger tests again?
              </div></li><li><div>
                &gt; @abstractdog , can you trigger tests again?

yeah, rebased to master, and pushed for new tests
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Enable vectorization for multi-col semi join reducers
                </div><div><b>description:</b> HIVE-21196 introduces multi-column semi-join reducers in the query engine. However, the implementation relies on GenericUDFMurmurHash which is not vectorized thus the respective operators cannot be executed in vectorized mode. 
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Hey [~abstractdog], thanks for taking over this :)

I had a quick look on the PR and noticed that the vectorized hash implementation seems to be a binary operator (two inputs, one output) while the non-vectorized alternative (GenericUDFMurmurHash) is an n-ary operator. 

Can we make the vectorized implementation n-ary or we should rather transform an expression {{hash(a,b,c,d)}} to something like {{hash(hash(hash(a,b),c),d)}}?

In any case if we don't treat this now we should create a follow-up JIRA.
              </div></li><li><div>
                [~zabetak]: thanks for taking a look. I think we should go the latter way, as we don't have n-ary vectorized expressions. It used to be a performance decision + now the descriptors don't let us match expression on an "arbitrary" number of input arguments.
              </div></li><li><div>
                Hi [~abstractdog],

While working on HIVE-24221, I got some further questions/ideas regarding this issue.

It seems that we make use of n-ary vectorized expressions for the evaluation of AND and OR operators; its true it is not done with the descriptor but through {{VectorizationContext}}. I am not sure what this mean in terms of efficiency, but it looks like we are saving at least some memory since I get the impression that we can reuse the output vector and not have a different output vector per pair of binary operations. We could employ something similar for an n-ary hash function.

Assuming that we cannot/should not treat the hash as n-ary operator then I think it makes more sense to make it unary (single input, single output), instead of binary, being only a kind of wrapper around Murmur for the different datatypes. By doing this the implementation will be simpler and we can cover more use-cases as the combine step is delegated to another abstraction.

+Currently+ 
{noformat}
hash(a,b) = 31*murmur(a) + murmur(b)
{noformat}

+After+
{noformat}
hash(a) = murmur(a)
{noformat}

What do you think?
              </div></li><li><div>
                Pushed to master, thanks [~abstractdog]!
              </div></li><li><div>
                thanks [~jcamachorodriguez]! as agreed, we will address further improvements in follow-up tickets with [~zabetak]

              </div></li></ol></div></div></html>