<!DOCTYPE html><html><div class="item-title">
        Item 93
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 set to its original status
              </div></li><li><div>
                 If it's message for PR and needs 2 messages, let the distribution message not to
 trigger callback
              </div></li><li><div>
                 if there's one secondary bucket holder needs two messages, then send two messages to all
 the secondary bcukets
              </div></li><li><div>
                 inhibitAllNotifications should not be interpreted as
 hasDelta
              </div></li><li><div>
                 create an UpdateMessage for a bucket region
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> GEODE-5729: when DistributedCacheOperation needs 2 messages, should let (#2458)
                </div><div><b>message:</b> GEODE-5729: when DistributedCacheOperation needs 2 messages, should let (#2458)

the notifyOnly message to trigger callbacks
            And computeCompressedShort should not pack inhibitAllNotifications
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> GEODE-5729: when DistributedCacheOperation needs 2 messages, should let
                </div><div><b>body:</b>             the notifyOnly message to trigger callbacks
            And computeCompressedShort should not pack inhibitAllNotifications

Thank you for submitting a contribution to Apache Geode.

In order to streamline the review of the contribution we ask you
to ensure the following steps have been taken:

### For all changes:
- [ ] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?

- [ ] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?

- [ ] Is your initial contribution a single, squashed commit?

- [ ] Does `gradlew build` run cleanly?

- [ ] Have you written or updated unit tests to verify your changes?

- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?

### Note:
Please ensure that once the PR is submitted, you check travis-ci for build issues and
submit an update to your PR as soon as possible. If you need help, please send an
email to dev@geode.apache.org.

                </div></div></li><li><div><div><b>title:</b> GEODE-5729: when DistributedCacheOperation needs 2 messages, should let
                </div><div><b>body:</b>             the notifyOnly message to trigger callbacks
            And computeCompressedShort should not pack inhibitAllNotifications

Thank you for submitting a contribution to Apache Geode.

In order to streamline the review of the contribution we ask you
to ensure the following steps have been taken:

### For all changes:
- [ ] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?

- [ ] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?

- [ ] Is your initial contribution a single, squashed commit?

- [ ] Does `gradlew build` run cleanly?

- [ ] Have you written or updated unit tests to verify your changes?

- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?

### Note:
Please ensure that once the PR is submitted, you check travis-ci for build issues and
submit an update to your PR as soon as possible. If you need help, please send an
email to dev@geode.apache.org.

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> when DistributedCacheOperation needs 2 messages, should let the notifyOnly message to trigger callback
                </div><div><b>description:</b> When one of the secondary bucket is still initializing (in middle of GII), the primary member call adviseRequiresTwoMessages() will return not null, i.e. PutAll will send both PutAllMessage and PutAllPRMessage(notifyOnly==true) to that member.

Then it might cause to send the same event 2 times to the secondary serial gateway queue. There's race that the primary serial gateway queue finished processing the event before one of (or all of) the 2 duplicated events at secondary serial gateway queue, the one was enqueued after the processing primary event will be replayed.

When considering the fix, we have to keep the twoMessage design, and we cannot guarantee that when the PutAllPRMessage(notifyOnly==true) is sent, the secondary bucket will be ready.

I find a work around:

The reason we need to send both PutAllMessage and PutAllPRMessage to the member is: we need the PutAllMessage to do apply distribution if region is ready, and also trigger call back if region is ready. But the PutAllPRMessage will trigger callbacks anyway even region is not ready
So when I detect there're overlap in the 2 sets of recipients, I can set event to be inhibitAllNotifications for PutAllMessage to let it only apply distribution.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Another issue is:

CacheOperationMessage's toData() will pack bits via&nbsp;computeCompressedShort(bits), pack&nbsp;extendedBits via&nbsp;computeCompressedExtBits(extendedBits), which will save&nbsp;inhibitAllNotifications.&nbsp;

&nbsp;

But&nbsp;computeCompressedShort() also saved&nbsp;inhibitAllNotifications, which will be interpreted as hasDelta() if it's set.&nbsp;
              </div></li><li><div>
                Commit b926be4db111fe2119216321cb99d53248377ef8 in geode's branch refs/heads/feature/GEODE-5729 from zhouxh
[ https://gitbox.apache.org/repos/asf?p=geode.git;h=b926be4 ]

GEODE-5729: when DistributedCacheOperation needs 2 messages, should let
            the notifyOnly message to trigger callbacks
            And computeCompressedShort should not pack inhibitAllNotifications

              </div></li><li><div>
                Commit 49eb1c5fd13aefff0995d76ec7864c82d5730dd8 in geode's branch refs/heads/develop from Xiaojian Zhou
[ https://gitbox.apache.org/repos/asf?p=geode.git;h=49eb1c5 ]

GEODE-5729: when DistributedCacheOperation needs 2 messages, should let (#2458)

the notifyOnly message to trigger callbacks
            And computeCompressedShort should not pack inhibitAllNotifications
              </div></li><li><div>
                Commit 49eb1c5fd13aefff0995d76ec7864c82d5730dd8 in geode's branch refs/heads/feature/GEODE-5338 from Xiaojian Zhou
[ https://gitbox.apache.org/repos/asf?p=geode.git;h=49eb1c5 ]

GEODE-5729: when DistributedCacheOperation needs 2 messages, should let (#2458)

the notifyOnly message to trigger callbacks
            And computeCompressedShort should not pack inhibitAllNotifications
              </div></li><li><div>
                Commit e9ea18e18c85b977b91192d4edbb9a4e18b2643e in geode's branch refs/heads/develop from [~mcmellawatt]
[ https://gitbox.apache.org/repos/asf?p=geode.git;h=e9ea18e ]

Revert "GEODE-5729: when DistributedCacheOperation needs 2 messages, should let (#2458)" (#2801)

This reverts commit 49eb1c5fd13aefff0995d76ec7864c82d5730dd8.
              </div></li><li><div>
                It was found that the fix for this issue caused a higher frequency data inconsistency than the one it resolved.  Reopening this ticket for further investigation.  Closing GEODE-5972 as it was fixed by reverting the commit for this fix.
              </div></li><li><div>
                Removing fix version, since this was reverted and reopened
              </div></li><li><div>
                Commit 70902b09b3ca17699f4b85b5151f989903b9c0de in geode's branch refs/heads/release/1.8.0 from [~mcmellawatt]
[ https://gitbox.apache.org/repos/asf?p=geode.git;h=70902b0 ]

Revert "GEODE-5729: when DistributedCacheOperation needs 2 messages, should let (#2458)" (#2801)

This reverts commit 49eb1c5fd13aefff0995d76ec7864c82d5730dd8.
              </div></li><li><div>
                Commit 70902b09b3ca17699f4b85b5151f989903b9c0de in geode's branch refs/heads/master from [~mcmellawatt]
[ https://gitbox.apache.org/repos/asf?p=geode.git;h=70902b0 ]

Revert "GEODE-5729: when DistributedCacheOperation needs 2 messages, should let (#2458)" (#2801)

This reverts commit 49eb1c5fd13aefff0995d76ec7864c82d5730dd8.
              </div></li></ol></div></div></html>