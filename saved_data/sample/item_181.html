<!DOCTYPE html><html><div class="item-title">
        Item 181
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> GROOVY-8579, GROOVY-8930: check static interface method for direct calls
                </div><div><b>message:</b> GROOVY-8579, GROOVY-8930: check static interface method for direct calls

- calling a static interface method requires Java 1.8+ bytecode

(cherry picked from commit fedc791efd562ed1fe74e3887340c38cabfcbb19)

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> No bytecode level check is done before producing JDK8+ bytecodes
                </div><div><b>description:</b> Create a file using a JDK8 static interface method, e.g. {{MyScript.groovy}}:
{code:java}
import groovy.transform.CompileStatic

@CompileStatic
Comparator myMethod() {
    Map.Entry.comparingByKey()
}
{code}
Compile using JDK8. On Groovy 3.0, use {{-Dgroovy.target.bytecode=1.7}} (not required for 2.5/6).

Note from {{javap -v}} that the bytecode version is:
{noformat}
 major version: 51
{noformat}
and that an InterfaceMethodref to the {{Map.Entry}} static interface method exists:
{noformat}
   #48 = InterfaceMethodref #45.#47       // java/util/Map$Entry.comparingByKey:()Ljava/util/Comparator;
{noformat}
Now try to use that class in another script, e.g.:
{code:java}
println new MyScript().myMethod()
{code}
You will note this error:
{noformat}
java.lang.VerifyError: Illegal type at constant pool entry 48 in class MyScript
Exception Details:
  Location:
    MyScript.myMethod()Ljava/util/Comparator; @0: invokestatic
  Reason:
    Constant pool index 48 is invalid
{noformat}
For Groovy 2.5/6 you can just run {{groovy MyScript.groovy}} to see the VerifyError, though using groovyc will let you see the generated bytecode.

So there are two problems:
* we should not set bytecode level to be the minimum level for the Groovy version (7 is default for 2.5/6) when producing bytecode requiring JDK8+.
* we should probably just complain if {{groovy.target.bytecode}} is ever set below the minimum value for the particular Groovy version.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                GitHub user paulk-asert opened a pull request:

    https://github.com/apache/groovy/pull/709

    GROOVY-8579: No bytecode level check is done before producing JDK8+ b…

    …ytecode

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/paulk-asert/groovy groovy8579

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/groovy/pull/709.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #709
    
----
commit a237b8e11483ceef63ff5895de6d60d219cff58d
Author: Paul King &lt;paulk@...&gt;
Date:   2018-05-17T09:00:18Z

    GROOVY-8579: No bytecode level check is done before producing JDK8+ bytecode

----

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/groovy/pull/709

              </div></li><li><div>
                Partially fixed. It now attempts to automatically set the class version to JDK8 when producing JDK8 specfiic bytecode even if the default minimum bytecode version is say 1.7. What remains is a warning/error when the target bytecode is explicitly set to 1.7 and JDK8 specific bytecodes are needed.
              </div></li><li><div><div><b>body:</b> I'll close this off. If we need further warning messages we can do the changes under a separate ticket.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div></div></html>