<!DOCTYPE html><html><div class="item-title">
        Item 172
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                * fn:replace 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                      Not 5.6.4 fn:tokenize - returns a sequence.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Merge commit 'refs/pull/156/head' of github.com:apache/jena
                </div><div><b>message:</b> Merge commit 'refs/pull/156/head' of github.com:apache/jena

This closes #156.

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> JENA-508: fn:replace
                </div><div><b>body:</b> fn:replace, which is REPLACE, as a custom function.

                </div></div></li><li><div><div><b>title:</b> JENA-508: fn:replace
                </div><div><b>body:</b> fn:replace, which is REPLACE, as a custom function.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Add support for XPath 3 Functions
                </div><div><b>description:</b> XPath 3 is now a Candidate Recommendation - http://www.w3.org/TR/xpath-functions-30/

It contains many new functions and operators (particularly in the mathematical space) which we should consider adding into future versions of ARQ.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Hi,
I'm Dimuthu Upeksha , a Computer Engineering Undergraduate from University of Moratuwa - Sri Lanka. I participate to GSoC 2013 and 2014 with Apache Software Foundation and I am willing to participate GSoC this time also. I have been working with XPath 2 for some of my university and open source projects. I believe that this is a area which is comfortable with me. Please let me know how to proceed.
              </div></li><li><div>
                Hi

That is great, firstly please make sure you have read http://community.apache.org/gsoc.html#applying-for-gsoc

Your next steps are twofold:

* Start reading the relevant documentation and code to understand how extension functions are implemented - see https://jena.apache.org/documentation/query/extension.html#valueFunctions and https://github.com/apache/jena/tree/master/jena-arq/src/main/java/com/hp/hpl/jena/sparql/function and https://github.com/apache/jena/tree/master/jena-arq/src/main/java/com/hp/hpl/jena/sparql/expr
* Based on your understanding start proposing a list of potential deliverables and discuss them with the Jena community to see if they match our expectations for this project

For the latter I'd be interested in your assessment of how much you can get done.  XPath 3 is a large spec with many functions but at the same time implementing new extension functions in Jena ARQ is a relatively easy task so it would be useful to understand what you think you can achieve in the time frame (and why)

What would your time availability be, my understanding was that many Asian countries including Sri Lanka don't have a summer break for universities, does this apply to you and if so how much time do you expect to be able to devote to GSoC
              </div></li><li><div>
                Hi Rob,

Thank you for the explanation. I went through the documents you have provided and that gave a good idea about how to implement extension functions. Now I'm working on cloning Jena source and trying to implement some custom functions to make sure that I have grasped the details mentioned in those documents.

However I'm bit confused about the relevance with project idea (Xpath 3) and extension functions. As far as I have understood project idea is to port functions mentioned in XPath 3 spec to Jena functions in order to give support in SPARQL queries. Am I right? 

About my availability. Yes usually we don't have summer in our university. However our final exams finish at the end of April. So after April I can spend a significant amount of time (35 -50 hours per week) with the project because academic works are almost over after final exams.

Should we move this conversation to mailing list?
              </div></li><li><div>
                Just to have and idea about the project I wrote a simple function for Floor operation
https://github.com/DImuthuUpe/Jena-Sample/blob/master/src/main/java/com/hp/hpl/jena/sparql/xpath3/XPath3_Floor.java

And tested it with 
https://github.com/DImuthuUpe/Jena-Sample/blob/master/src/main/java/com/hp/hpl/jena/sparql/xpath3/Main.java

Is this the way it should be designed?
              </div></li><li><div>
                List of Xpath3 functions and current supported functions in Jena
https://docs.google.com/spreadsheets/d/16J2n0hwXwzxsNzv4fDzPqVSDHYVKXkJEWxWwCnWgDbw/edit?usp=sharing
              </div></li><li><div>
                Good spreadsheet.

There are implementations of many XSD operators ("op:") in XSDFuncOp -- they back the syntax operations like "+".  There is no namespace for op: -- the operations back operators in the language like "+", but making namespace(op) == namespace(fn) then it is just wiring needed, the functionality exists.

Anything returning a sequence presents problems in SPARQL and is meaningless e.g.  fn:tokenize and the higher order functions. It may be possible to have similar functionality but not as functions in teh form XPath3 has them. Functions in SPARQL take RDF terms as arguments and return RDF terms; an RDF list isn't a single RDF term.

Aggregate functions (e.g. fn:count) also operate on sequence in XPath/XQuery but SPARQL has a separate aggregation mechanism somewhat like SQL.

Anything working on XML types, like elements and nodes, don't have a natural meaning in SPARQL.

xs:yearMonthDuration and xs;dayTimeDuration are now implemented datatypes and operators shoudl already work on them.  xsd:dateTime-xsd:dateTime -&gt; xsd:duration.

              </div></li><li><div><div><b>body:</b> Andy raises a lot of good points, in general a lot of stuff on that spreadsheet already has some equivalent in SPARQL.  I would read through the SPARQL 1.1 specification carefully, particularly [Section 17|http://www.w3.org/TR/sparql11-query/#expressions] which details all the available operators and functions and update your spreadsheet accordingly.

It is also worth noting that a bunch of the numerical functions already have implementations on the JENA-507 and so for some functions it would just be a case of wrapping the existing implementation so that it is available under the XPath namespace as well
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                See JENA-1155 for the {{math:}}
              </div></li><li><div>
                After JENA-1155 ({{math:}}), the following atomic valued functions missing are: (RDF does not have XQuery/XPath sequences as a datatype).

{noformat}
fn:normalize-space
fn:normalize-unicode
fn:format-number
fn:round-half-to-even
fn:adjust-dateTime-to-timezone
fn:adjust-date-to-timezone
fn:adjust-time-to-timezone
fn:format-dateTime
fn:format-date
fn:format-time
{noformat}

              </div></li><li><div>
                In progress : see [this email (2016-05-02)|http://mail-archives.apache.org/mod_mbox/jena-dev/201605.mbox/%3CCAEdfCohGpqOJj-oFazbykKNzhHWqWrdL2e8b6QSs8yCB%3D8PGug%40mail.gmail.com%3E]
              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/jena/pull/144

              </div></li><li><div>
                Github user afs commented on the pull request:

    https://github.com/apache/jena/pull/144#issuecomment-219678956
  
    Tests: exprStrNormalizeUnicode10, exprStrNormalizeUnicode11
    
    I don't know why they are failing either. May be it's because the version of Unicodein Java is not new enough.
    
    I've commented these out for the moment.

              </div></li><li><div>
                GitHub user ales004 opened a pull request:

    https://github.com/apache/jena/pull/148

    JENA-508: implemented fn:adjust-datetime-to-timezone and fn:adjust-date-to-timezone

    I implemented two new XPath 3 functions: fn:adjust-datetime-to-timezone and fn:adjust-date-to-timezone. I used the examples of the specification for the tests + I decided to implement both using the same underlying function as it seems to me that in jena there is no distinction between date and datetime (both are using the same object).

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/ales004/jena master

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/jena/pull/148.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #148
    
----
commit da73e967b19f00f4d5f8b245079b9894331715db
Author: ales004 &lt;cicerone54@hotmail.com&gt;
Date:   2016-05-29T17:13:47Z

    First implementation of fn:adjust-dateTime-to-timezone.

commit 807d50feff9b300e81253e3306778863f78444c1
Author: ales004 &lt;cicerone54@hotmail.com&gt;
Date:   2016-05-29T17:33:42Z

    Add the error conditions.

commit 8de4216c0cb96f098a84d765db6cf1bf3e2b3956
Author: ales004 &lt;cicerone54@hotmail.com&gt;
Date:   2016-05-29T21:04:25Z

    Implemented adjust-date-to-timezone

commit d786344dca85fcedeaa43ae7b211621fa9998afc
Author: ales004 &lt;cicerone54@hotmail.com&gt;
Date:   2016-06-03T18:43:31Z

    Merge remote-tracking branch 'upstream/master'

commit 77ddf08758c37efc15410e938b65e3d379f83dd8
Author: ales004 &lt;cicerone54@hotmail.com&gt;
Date:   2016-06-03T18:53:02Z

    Simplified the checking of the input timezone.

commit 5dcb82b67a20e56d1e9476e34c288b36eec69152
Author: ales004 &lt;cicerone54@hotmail.com&gt;
Date:   2016-06-03T19:00:18Z

    Reverted changes made to the dtGetTimezone function.

----

              </div></li><li><div>
                Github user afs commented on the issue:

    https://github.com/apache/jena/pull/148
  
    Same function that checks for xsd:dateTime, xsd:date or xsd:time is the right thing to do.

              </div></li><li><div>
                Github user afs commented on the issue:

    https://github.com/apache/jena/pull/148
  
    It's a good thing it's summer where I am (British Summer Time)!
    
    My reading of https://www.w3.org/TR/xpath-functions-3/#timezone.functions is that conversions where there is no provided timezone use local time, including daylight savings time.
    
    In the tests `TimeZone.getDefault().getRawOffset()` returns the offset without regard for the local daylight savings time.
    
    Also allowing for timezones which are negative offsets, I came up with:
    ```
     private String getDynamicDurationString(){
            int tzOffset = TimeZone.getDefault().getOffset(new Date().getTime())/(1000*60) ; 
            String x = "PT"+Math.abs(tzOffset)+"M";
            if ( tzOffset &lt; 0 )
                x = "-"+x ;
            return x ;
        }
    ```
    
    `XSDFuncOp.adjustDatetimeToTimezone` also needs this.

              </div></li><li><div>
                Github user afs commented on a diff in the pull request:

    https://github.com/apache/jena/pull/148#discussion_r66244619
  
    --- Diff: jena-arq/src/main/java/org/apache/jena/sparql/expr/nodevalue/XSDFuncOp.java ---
    @@ -1554,4 +1551,55 @@ private static Duration valueCanonicalDuration(NodeValue nv) {
     //            dur = ... 
             return dur ;
         }
    +
    +    public static NodeValue adjustDatetimeToTimezone(NodeValue nv1,NodeValue nv2){
    +        if(nv1 == null)
    +            return null;
    +
    +        if(!nv1.isDateTime() &amp;&amp; !nv1.isDate() &amp;&amp; !nv1.isTime()){
    +            throw new ExprEvalException("Not a valid date, datetime or time:"+nv1);
    +        }
    +
    +        XMLGregorianCalendar calValue = nv1.getDateTime();
    +        Boolean hasTz = calValue.getTimezone() != DatatypeConstants.FIELD_UNDEFINED;
    +        int inputOffset = 0;
    +        if(hasTz){
    +            inputOffset = calValue.getTimezone();
    +        }
    +
    +        int tzOffset = TimeZone.getDefault().getRawOffset() / (1000*60);
    +        if(nv2 != null){
    --- End diff --
    
    `int tzOffset = TimeZone.getDefault().getOffset(new Date().getTime())/(1000*60) ;`
    
    Ideally, don't set this with a call to `new Date()` until later -- see below.

              </div></li><li><div>
                Github user afs commented on a diff in the pull request:

    https://github.com/apache/jena/pull/148#discussion_r66244682
  
    --- Diff: jena-arq/src/main/java/org/apache/jena/sparql/expr/nodevalue/XSDFuncOp.java ---
    @@ -1554,4 +1551,55 @@ private static Duration valueCanonicalDuration(NodeValue nv) {
     //            dur = ... 
             return dur ;
         }
    +
    +    public static NodeValue adjustDatetimeToTimezone(NodeValue nv1,NodeValue nv2){
    +        if(nv1 == null)
    +            return null;
    +
    +        if(!nv1.isDateTime() &amp;&amp; !nv1.isDate() &amp;&amp; !nv1.isTime()){
    +            throw new ExprEvalException("Not a valid date, datetime or time:"+nv1);
    +        }
    +
    +        XMLGregorianCalendar calValue = nv1.getDateTime();
    +        Boolean hasTz = calValue.getTimezone() != DatatypeConstants.FIELD_UNDEFINED;
    +        int inputOffset = 0;
    +        if(hasTz){
    +            inputOffset = calValue.getTimezone();
    +        }
    +
    +        int tzOffset = TimeZone.getDefault().getRawOffset() / (1000*60);
    +        if(nv2 != null){
    +            if(!nv2.isDuration()) {
    +                String nv2StrValue = nv2.getString();
    +                if(nv2StrValue.equals("")){
    +                    calValue.setTimezone(DatatypeConstants.FIELD_UNDEFINED);
    +                    if(nv1.isDateTime())
    +                        return NodeValue.makeDateTime(calValue);
    +                    else if(nv1.isTime())
    +                        return NodeValue.makeNode(calValue.toXMLFormat(),XSDDatatype.XSDtime);
    +                    else
    +                        return NodeValue.makeDate(calValue);
    +                }
    +                throw new ExprEvalException("Not a valid duration:" + nv2);
    +            }
    +            Duration tzDuration = nv2.getDuration();
    --- End diff --
    
    ```} else {
                tzOffset = TimeZone.getDefault().getOffset(new Date().getTime())/(1000*60) ;
            }
    ```
    so `new Date` is only called if needed.

              </div></li><li><div>
                Github user afs commented on a diff in the pull request:

    https://github.com/apache/jena/pull/148#discussion_r66245039
  
    --- Diff: jena-arq/src/main/java/org/apache/jena/sparql/expr/nodevalue/XSDFuncOp.java ---
    @@ -1554,4 +1551,55 @@ private static Duration valueCanonicalDuration(NodeValue nv) {
     //            dur = ... 
             return dur ;
         }
    +
    +    public static NodeValue adjustDatetimeToTimezone(NodeValue nv1,NodeValue nv2){
    +        if(nv1 == null)
    +            return null;
    +
    +        if(!nv1.isDateTime() &amp;&amp; !nv1.isDate() &amp;&amp; !nv1.isTime()){
    +            throw new ExprEvalException("Not a valid date, datetime or time:"+nv1);
    +        }
    +
    +        XMLGregorianCalendar calValue = nv1.getDateTime();
    +        Boolean hasTz = calValue.getTimezone() != DatatypeConstants.FIELD_UNDEFINED;
    +        int inputOffset = 0;
    +        if(hasTz){
    +            inputOffset = calValue.getTimezone();
    +        }
    +
    +        int tzOffset = TimeZone.getDefault().getRawOffset() / (1000*60);
    +        if(nv2 != null){
    +            if(!nv2.isDuration()) {
    +                String nv2StrValue = nv2.getString();
    +                if(nv2StrValue.equals("")){
    +                    calValue.setTimezone(DatatypeConstants.FIELD_UNDEFINED);
    +                    if(nv1.isDateTime())
    +                        return NodeValue.makeDateTime(calValue);
    +                    else if(nv1.isTime())
    +                        return NodeValue.makeNode(calValue.toXMLFormat(),XSDDatatype.XSDtime);
    +                    else
    +                        return NodeValue.makeDate(calValue);
    +                }
    +                throw new ExprEvalException("Not a valid duration:" + nv2);
    +            }
    +            Duration tzDuration = nv2.getDuration();
    +            tzOffset = tzDuration.getSign()*(tzDuration.getMinutes() + 60*tzDuration.getHours());
    +            if(tzDuration.getSeconds() &gt; 0)
    +                throw new ExprEvalException("The timezone duration should be an integral number of minutes");
    +            int absTzOffset = java.lang.Math.abs(tzOffset);
    +            if(absTzOffset &gt; 14*60)
    +                throw new ExprEvalException("The timezone should be a duration between -PT14H and PT14H.");
    +        }
    +        String tzSign = (tzOffset-inputOffset) &gt; 0 ? "" : "-";
    +        Duration durToAdd = NodeValue.makeDuration(tzSign+"PT"+java.lang.Math.abs(tzOffset-inputOffset)+"M").getDuration();
    --- End diff --
    
    Could this be done with something like `NodeValue.xmlDatatypeFactory.createDurationDayTime(tzOffset-inputOffset)`?
    
    It avoids string parsing.

              </div></li><li><div>
                Github user afs commented on the issue:

    https://github.com/apache/jena/pull/148
  
    Other than my comments above - this looks good to include.

              </div></li><li><div>
                Github user ales004 commented on the issue:

    https://github.com/apache/jena/pull/148
  
    Andy,
    you are right! I was not thinking that with daylight savings the timezone offset can change. Thank you for your input!
    
    
    I just push the changes you requested and all tests are passing.
    


              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/jena/pull/148

              </div></li><li><div>
                The full list of the XPath Functions and operators in {{StandardFunctions}} and we have a nearly complete set.

Summary notes for tracking purposes: I think we have only these missing (sequence operations do not make sense in SPARQL):

{noformat}
fn:format-number
fn:format-dateTime
fn:format-date
fn:format-time
{noformat}

It would be nice to have {{op:}} mapping (but there are a lot of them) and adapters to SPARQL operations that have keywords:
{noformat}
fn:replace
fn:matches
{noformat}

{{fn:format-number}} : Java {{NumberFormat}} picture strings.

{{fn:format-dateTime}}/{{fn:format-time}}/{{fn:format-date}} : These have their own picture string syntax not provided in the JDK.

              </div></li><li><div>
                Commit a117b293e00879c4fe2d0a8b67257eebfc62f0f1 in jena's branch refs/heads/master from [~andy.seaborne]
[ https://git-wip-us.apache.org/repos/asf?p=jena.git;h=a117b29 ]

JENA-508: Notes on implementation status.
              </div></li><li><div>
                GitHub user afs opened a pull request:

    https://github.com/apache/jena/pull/155

    JENA-508:  fn:format-number

    Implementation and tests for `fn:format-number`.
    
    For the "decimal-format-name	" third argument.  F&amp;O says it is something defined in the static context but does not provide any more guidance.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/afs/jena functions

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/jena/pull/155.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #155
    
----
commit 679129ce6fa4c87f477e69b28b7b59edbe41bd22
Author: Andy Seaborne &lt;andy@apache.org&gt;
Date:   2016-07-15T16:45:28Z

    fn:format-number

----

              </div></li><li><div><div><b>body:</b> With PR #155 and #156 we have the complete set except the 3 date/time formatters : fn:format-dateTime etc.

Unless I'm missing something, Java8 does not include code to implement the picture format defined in Xpath/Xquery Functions and Operators. So, even for just the ISO 8601 calendar, it's a significant piece of implementation.

See https://www.w3.org/TR/xpath-functions-3/#rules-for-datetime-formatting

Examples (from F&amp;O 3.1):
{noformat}
2002-12-31	format-date($d, "[Y0001]-[M01]-[D01]")
12-31-2002	format-date($d, "[M]-[D]-[Y]")
31-12-2002	format-date($d, "[D]-[M]-[Y]")
31 XII 2002	format-date($d, "[D1] [MI] [Y]")
{noformat}

(Saxon-HE may have the code : it is Mozilla Public License which is category B / weak copyleft)

Jena provides {{afn:sprintf}} and that has some date/time formatting capabilities and a picture format that users wil probably expect.

Therefore, I propose we close this JIRA with many thanks to ales004 for his contributions.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Commit 6d308ff9833a5bbeb70365f579fe6dc5c6b6a1c6 in jena's branch refs/heads/master from [~andy.seaborne]
[ https://git-wip-us.apache.org/repos/asf?p=jena.git;h=6d308ff ]

JENA-508: fn:format-number

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/jena/pull/155

              </div></li><li><div>
                GitHub user afs opened a pull request:

    https://github.com/apache/jena/pull/156

    JENA-508: fn:replace

    fn:replace, which is REPLACE, as a custom function.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/afs/jena fn-replace

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/jena/pull/156.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #156
    
----
commit 0e36d5340373d48d72fcde65827f2b7e59857543
Author: Andy Seaborne &lt;andy@apache.org&gt;
Date:   2016-07-16T12:35:26Z

    JENA-508: fn:replace

----

              </div></li><li><div>
                Commit 0e36d5340373d48d72fcde65827f2b7e59857543 in jena's branch refs/heads/master from [~andy.seaborne]
[ https://git-wip-us.apache.org/repos/asf?p=jena.git;h=0e36d53 ]

JENA-508: fn:replace

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/jena/pull/156

              </div></li><li><div>
                We have as complete a set of XPath3.1 functions as makes sense and is practical (no sequence based functions, no formatting date/times with F&amp;O unique picture format).

              </div></li><li><div><div><b>body:</b> Andy,
I was studying how we can implement the missing functions (format-date/time). The main problem with these is:
* the convention required in XPath3 is not the same as the one used in the DatetimeFormatter in java
* the DateTimeFormatter has a lot less options than the one required by Xpath3

thus in my opinion the work involved to fully implement these functions could be quite big and I am not sure that it is worth :)

Regards,
Alessandro
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div></div></html>