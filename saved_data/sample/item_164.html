<!DOCTYPE html><html><div class="item-title">
        Item 164
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 check if the file is in an EC zone
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HDFS-8479. Erasure coding: fix striping related logic in FSDirWriteFileOp to sync with HDFS-8421. Contributed by Zhe Zhang.
                </div><div><b>message:</b> HDFS-8479. Erasure coding: fix striping related logic in FSDirWriteFileOp to sync with HDFS-8421. Contributed by Zhe Zhang.

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Erasure coding: fix striping related logic in FSDirWriteFileOp to sync with HDFS-8421
                </div><div><b>description:</b> 
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div><div><b>body:</b> The patch is actually simpler than I expected. Through all EC patches we have changed several times the way to check whether a file is striped / erasure coded. This patch just applies the latest version to {{FSDirWriteFileOp}}. It also fixes a test failure because {{ThreadLocalRandom.current().nextLong()}} could generate negative block IDs (but the block info is contiguous).
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Thanks for the merge, Zhe! The patch looks pretty good to me. +1. I will commit it shortly.
              </div></li><li><div>
                Thanks Jing for the review!
              </div></li><li><div>
                BTW, while running tests after the merge, I got this test failure:
{code}
Running org.apache.hadoop.hdfs.TestDFSStripedInputStream
Tests run: 4, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 24.727 sec &lt;&lt;&lt; FAILURE! - in org.apache.hadoop.hdfs.TestDFSStripedInputStream
testPreadWithDNFailure(org.apache.hadoop.hdfs.TestDFSStripedInputStream)  Time elapsed: 3.329 sec  &lt;&lt;&lt; ERROR!
org.apache.hadoop.HadoopIllegalArgumentException: Inputs not fully corresponding to erasedIndexes in null places
	at org.apache.hadoop.io.erasurecode.rawcoder.RSRawDecoder.doDecode(RSRawDecoder.java:132)
	at org.apache.hadoop.io.erasurecode.rawcoder.AbstractRawErasureDecoder.decode(AbstractRawErasureDecoder.java:113)
	at org.apache.hadoop.hdfs.util.StripedBlockUtil.decodeAndFillBuffer(StripedBlockUtil.java:291)
	at org.apache.hadoop.hdfs.DFSStripedInputStream.fetchOneStripe(DFSStripedInputStream.java:594)
	at org.apache.hadoop.hdfs.DFSStripedInputStream.fetchBlockByteRange(DFSStripedInputStream.java:520)
	at org.apache.hadoop.hdfs.DFSInputStream.pread(DFSInputStream.java:1472)
	at org.apache.hadoop.hdfs.DFSInputStream.read(DFSInputStream.java:1435)
	at org.apache.hadoop.hdfs.TestDFSStripedInputStream.testPreadWithDNFailure(TestDFSStripedInputStream.java:242)
{code}

Zhe, Do you want to include the fix here or do it in a separate jira?
              </div></li><li><div>
                Looks like the failure is caused by HADOOP-11847. I will commit the patch.
              </div></li><li><div>
                I've committed this. Thanks again Zhe for the contribution!
              </div></li><li><div>
                Thanks Jing. I was about the include the following change:
{code}
  /**
   * Decode based on the given input buffers and schema
   */
  public static void decodeAndFillBuffer(final byte[][] decodeInputs, byte[] buf,
      AlignedStripe alignedStripe, int dataBlkNum, int parityBlkNum) {
    int[] decodeIndices = new int[parityBlkNum];
    int pos = 0;
    for (int i = 0; i &lt; alignedStripe.chunks.length; i++) {
      if (alignedStripe.chunks[i].state != StripingChunk.FETCHED &amp;&amp;
          alignedStripe.chunks[i].state != StripingChunk.ALLZERO) {
        decodeIndices[pos++] = i;
        decodeInputs[i] = null;
      }
    }
{code}

Basically,  HADOOP-11847 requires us to leave to-be-decoded slots as null.
              </div></li><li><div><div><b>body:</b> Maybe we can open a new jira to include this change and also fix all the workaround for decoding?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Good idea Jing. I just filed HDFS-8481

---
Zhe Zhang



              </div></li><li><div>
                \\
\\
| (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | pre-patch |  14m 34s | Pre-patch HDFS-7285 compilation is healthy. |
| {color:green}+1{color} | @author |   0m  0s | The patch does not contain any @author tags. |
| {color:green}+1{color} | tests included |   0m  0s | The patch appears to include 1 new or modified test files. |
| {color:green}+1{color} | javac |   7m 28s | There were no new javac warning messages. |
| {color:green}+1{color} | javadoc |   9m 36s | There were no new javadoc warning messages. |
| {color:red}-1{color} | release audit |   0m 15s | The applied patch generated 1 release audit warnings. |
| {color:green}+1{color} | checkstyle |   0m 37s | There were no new checkstyle issues. |
| {color:green}+1{color} | whitespace |   0m  0s | The patch has no lines that end in whitespace. |
| {color:green}+1{color} | install |   1m 36s | mvn install still works. |
| {color:green}+1{color} | eclipse:eclipse |   0m 32s | The patch built with eclipse:eclipse. |
| {color:red}-1{color} | findbugs |   3m 16s | The patch appears to introduce 1 new Findbugs (version 3.0.0) warnings. |
| {color:green}+1{color} | native |   3m 14s | Pre-build of native portion |
| {color:red}-1{color} | hdfs tests | 172m 22s | Tests failed in hadoop-hdfs. |
| | | 213m 38s | |
\\
\\
|| Reason || Tests ||
| FindBugs | module:hadoop-hdfs |
|  |  Inconsistent synchronization of org.apache.hadoop.hdfs.DFSOutputStream.streamer; locked 88% of time  Unsynchronized access at DFSOutputStream.java:88% of time  Unsynchronized access at DFSOutputStream.java:[line 146] |
| Failed unit tests | hadoop.hdfs.TestEncryptedTransfer |
|   | hadoop.hdfs.server.namenode.TestFileTruncate |
|   | hadoop.hdfs.TestRecoverStripedFile |
|   | hadoop.hdfs.TestDFSStripedInputStream |
|   | hadoop.hdfs.server.namenode.TestAuditLogs |
|   | hadoop.hdfs.server.blockmanagement.TestBlockInfo |
|   | hadoop.hdfs.server.blockmanagement.TestBlockTokenWithDFS |
\\
\\
|| Subsystem || Report/Notes ||
| Patch URL | http://issues.apache.org/jira/secure/attachment/12735404/HDFS-8479-HDFS-7285.0.patch |
| Optional Tests | javadoc javac unit findbugs checkstyle |
| git revision | HDFS-7285 / c9e0268 |
| Release Audit | https://builds.apache.org/job/PreCommit-HDFS-Build/11132/artifact/patchprocess/patchReleaseAuditProblems.txt |
| Findbugs warnings | https://builds.apache.org/job/PreCommit-HDFS-Build/11132/artifact/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html |
| hadoop-hdfs test log | https://builds.apache.org/job/PreCommit-HDFS-Build/11132/artifact/patchprocess/testrun_hadoop-hdfs.txt |
| Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/11132/testReport/ |
| Java | 1.7.0_55 |
| uname | Linux asf906.gq1.ygridcore.net 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/11132/console |


This message was automatically generated.
              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Hdfs-trunk #2379 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2379/])
HDFS-8479. Erasure coding: fix striping related logic in (jing9: rev 1299357a05c52ad45513ed0ea854edc9c7ec3de8)
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestReplicationPolicy.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES-HDFS-EC-7285.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirWriteFileOp.java

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-trunk-Commit #8548 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/8548/])
HDFS-8479. Erasure coding: fix striping related logic in (jing9: rev 1299357a05c52ad45513ed0ea854edc9c7ec3de8)
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestReplicationPolicy.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirWriteFileOp.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES-HDFS-EC-7285.txt

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Yarn-trunk #1203 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/1203/])
HDFS-8479. Erasure coding: fix striping related logic in (jing9: rev 1299357a05c52ad45513ed0ea854edc9c7ec3de8)
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestReplicationPolicy.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirWriteFileOp.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES-HDFS-EC-7285.txt

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #473 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/473/])
HDFS-8479. Erasure coding: fix striping related logic in (jing9: rev 1299357a05c52ad45513ed0ea854edc9c7ec3de8)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES-HDFS-EC-7285.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestReplicationPolicy.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirWriteFileOp.java

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #439 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/439/])
HDFS-8479. Erasure coding: fix striping related logic in (jing9: rev 1299357a05c52ad45513ed0ea854edc9c7ec3de8)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestReplicationPolicy.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirWriteFileOp.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES-HDFS-EC-7285.txt

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Mapreduce-trunk #2408 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2408/])
HDFS-8479. Erasure coding: fix striping related logic in (jing9: rev 1299357a05c52ad45513ed0ea854edc9c7ec3de8)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES-HDFS-EC-7285.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirWriteFileOp.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestReplicationPolicy.java

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #465 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/465/])
HDFS-8479. Erasure coding: fix striping related logic in (jing9: rev 1299357a05c52ad45513ed0ea854edc9c7ec3de8)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirWriteFileOp.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSDirectory.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/blockmanagement/TestReplicationPolicy.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES-HDFS-EC-7285.txt

              </div></li></ol></div></div></html>