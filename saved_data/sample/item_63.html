<!DOCTYPE html><html><div class="item-title">
        Item 63
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
   * This method checks if there are any ConfigGroup with empty or null service name field
   
              </div></li><li><div>
                *
   * Fix inconsistencies found by @collectConfigGroupsWithoutServiceName
   
              </div></li><li><div>
                 Lookup by hostname - It does have a unique constraint
              </div></li><li><div>
                 Ignore if cluster not found
              </div></li><li><div>
                *
   * This method checks if there are any ConfigGroup host mappings with hosts
   * that are not longer a part of the cluster.
   
              </div></li><li><div>
                 Based on current implementation of ConfigGroupImpl the
 host mapping would be loaded only if the host actually exists
 in the host table
              </div></li><li><div>
                *
   * Fix inconsistencies found by @checkConfigGroupHostMapping
   
              </div></li><li><div>
                 This call does not thrown Authorization Exception
              </div></li><li><div>
                *
   * This method collects the ConfigGroups with empty or null service name field
   
              </div></li><li><div>
                 Force the clusters object to reload to ensure the renamed service is accounted for
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> AMBARI-24283 - DB consistency warning due to config group without service name (#1915) (#1928)
                </div><div><b>message:</b> AMBARI-24283 - DB consistency warning due to config group without service name (#1915) (#1928)


                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> AMBARI-24283 - DB consistency warning due to config group without service name
                </div><div><b>body:</b> ## What changes were proposed in this pull request?

A subset of these changes are included in this pr #1876
Adding a configuration group to any services in Ambari 2.5 do not populate the service name in the configuration group record.
In Ambari 2.6 and 2.7 DB consistency check warns these configuration groups and indicates that they are not related to any of the services in the cluster. Auto-fix-db also deletes them however they can be used by customer.
Fix.: configuration group records stores the related service name in the tag field. Auto-fix-db copies tag field values to service name fields before checking for configuration group of deleted services if the text in the tag field is an existing service name in the cluster.

Also the service Ambari Infra was renamed to Ambari Infra Solr in Ambari 2.7 and this patch include the renaming of the service name and tag fields in the config group table while upgrading.

## How was this patch tested?

ambari-server
mvn clean install

manually:

1. Deploy ZooKeeper and Ambari Infra with Ambari 2.5.2
2. Create config group on UI for both services.
3. Upgrade to Ambari 2.6.2
4. Upgrade to Ambari 2.7.1
5. Start ambari-server -&gt; warning in the ambari-server-check-database.log: WARN - You have config groups present in the database with no corresponding service found
6. Stop ambari-server
7. Run --auto-fix-database
8. Start ambari-server -&gt; no warnings in the ambari-server-check-database.log and the configuration group remained. 
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/Ambari-Github-PullRequest-Builder/3364/
Test FAILed.
Test FAILured.

              </div></li><li><div>
                Retest this please
              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/Ambari-Github-PullRequest-Builder/3365/
Test PASSed.

              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/Ambari-Github-PullRequest-Builder/3369/
Test PASSed.

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Could you please add curly braces?
              </div></li><li><div>
                You could use a Guava Joiner (works with Java 7 too) or String.join (Java 8+) here.
              </div></li><li><div>
                Please consider creating an else case just for logging.
              </div></li><li><div>
                These two lines could be made one.
              </div></li><li><div>
                You could use Map.computeIfAbsent (Java 8+) to create the collection in the map in case it does not yet exist.
              </div></li><li><div>
                Looks like this case is not handled:
- A config group has its service name in the tag field and the service is deleted. Neither checkConfigGroupsHasServiceName() nor checkConfigGroupsForDeletedServices() detects it.
              </div></li><li><div>
                I had two config groups before upgrade from 2.5:
I upgraded to 2.6 than 2.7 and deleted the service ambari_infra_solr. The configgroup table looks like:

group_name|tag|service_name
----------|---|--------------
cfg1|ZOOKEEPER|(null)	
cfg_infra|AMBARI_INFRA_SOLR|(null)	

When stating ambari server both methods warns:

    WARN - You have config groups present in the database with no service name, [(ConfigGroup) =&gt; ( cfg1 ), ( cfg_infra )]
    WARN - You have config groups present in the database with no corresponding service found, [(ConfigGroup, Service) =&gt; ( cfg1, null ), ( cfg_infra, null )]

After restarting ambari-server using `--auto-fix-database`

group_name|tag|service_name
----------|---|--------------
cfg1|ZOOKEEPER|ZOOKEEPER	
cfg_infra|AMBARI_INFRA_SOLR|(null)	

    WARN - You have config groups present in the database with no service name, [(ConfigGroup) =&gt; ( cfg_infra )]
    WARN - You have config groups present in the database with no corresponding service found, [(ConfigGroup, Service) =&gt; ( cfg_infra, null )]
              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>