<!DOCTYPE html><html><div class="item-title">
        Item 54
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                 partial update
              </div></li><li><div>
                 this chain is valid even though the signature field is not
         indexed, because we are not asking for dups to be overwritten
      
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> SOLR-4016: Deduplication does not work with atomic/partial updates so disallow atomic update requests which change signature generating fields.
                </div><div><b>message:</b> SOLR-4016: Deduplication does not work with atomic/partial updates so disallow atomic update requests which change signature generating fields.

git-svn-id: https://svn.apache.org/repos/asf/lucene/dev/trunk@1433013 13f79535-47bb-0310-9956-ffa450edef68

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Deduplication is broken by partial update
                </div><div><b>description:</b> The SignatureUpdateProcessorFactory used (primarily?) for deduplication does not consider partial update semantics.

The below uses the following solrconfig.xml excerpt:

{noformat}
     &lt;updateRequestProcessorChain name="text_hash"&gt;
       &lt;processor class="solr.processor.SignatureUpdateProcessorFactory"&gt;
         &lt;bool name="enabled"&gt;true&lt;/bool&gt;
         &lt;str name="signatureField"&gt;text_hash&lt;/str&gt;
         &lt;bool name="overwriteDupes"&gt;false&lt;/bool&gt;
         &lt;str name="fields"&gt;text&lt;/str&gt;
         &lt;str name="signatureClass"&gt;solr.processor.TextProfileSignature&lt;/str&gt;
       &lt;/processor&gt;
       &lt;processor class="solr.LogUpdateProcessorFactory" /&gt;
       &lt;processor class="solr.RunUpdateProcessorFactory" /&gt;
     &lt;/updateRequestProcessorChain&gt;
{noformat}

Firstly, the processor treats {noformat}{"set": "value"}{noformat} as a string and hashes it, instead of the value alone:

{noformat}
$ curl '$URL/update?commit=true' -H 'Content-type:application/json' -d '{"add":{"doc":{"id": "abcde", "text": {"set": "hello world"}}}}' &amp;&amp; curl '$URL/select?q=id:abcde'
{"responseHeader":{"status":0,"QTime":30}}
&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;response&gt;&lt;lst name="responseHeader"&gt;&lt;int name="status"&gt;0&lt;/int&gt;&lt;int name="QTime"&gt;1&lt;/int&gt;&lt;lst name="params"&gt;&lt;str name="q"&gt;id:abcde&lt;/str&gt;&lt;/lst&gt;&lt;/lst&gt;&lt;result name="response" numFound="1" start="0"&gt;&lt;doc&gt;&lt;str name="id"&gt;abcde&lt;/str&gt;&lt;str name="text"&gt;hello world&lt;/str&gt;&lt;str name="text_hash"&gt;ad48c7ad60ac22cc&lt;/str&gt;&lt;long name="_version_"&gt;1417247434224959488&lt;/long&gt;&lt;/doc&gt;&lt;/result&gt;
&lt;/response&gt;
$
$ curl '$URL/update?commit=true' -H 'Content-type:application/json' -d '{"add":{"doc":{"id": "abcde", "text": "hello world"}}}' &amp;&amp; curl '$URL/select?q=id:abcde'
{"responseHeader":{"status":0,"QTime":27}}
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;response&gt;
&lt;lst name="responseHeader"&gt;&lt;int name="status"&gt;0&lt;/int&gt;&lt;int name="QTime"&gt;1&lt;/int&gt;&lt;lst name="params"&gt;&lt;str name="q"&gt;id:abcde&lt;/str&gt;&lt;/lst&gt;&lt;/lst&gt;&lt;result name="response" numFound="1" start="0"&gt;&lt;doc&gt;&lt;str name="id"&gt;abcde&lt;/str&gt;&lt;str name="text"&gt;hello world&lt;/str&gt;&lt;str name="text_hash"&gt;b169c743d220da8d&lt;/str&gt;&lt;long name="_version_"&gt;1417248022215000064&lt;/long&gt;&lt;/doc&gt;&lt;/result&gt;
&lt;/response&gt;
{noformat}

Note the different text_hash value.

Secondly, when updating a field other than those used to create the signature (which I imagine is a more common use-case), the signature is recalculated from no values:

{noformat}
$ curl '$URL/update?commit=true' -H 'Content-type:application/json' -d '{"add":{"doc":{"id": "abcde", "title": {"set": "new title"}}}}' &amp;&amp; curl '$URL/select?q=id:abcde'
{"responseHeader":{"status":0,"QTime":39}}
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;response&gt;
&lt;lst name="responseHeader"&gt;&lt;int name="status"&gt;0&lt;/int&gt;&lt;int name="QTime"&gt;1&lt;/int&gt;&lt;lst name="params"&gt;&lt;str name="q"&gt;id:abcde&lt;/str&gt;&lt;/lst&gt;&lt;/lst&gt;&lt;result name="response" numFound="1" start="0"&gt;&lt;doc&gt;&lt;str name="id"&gt;abcde&lt;/str&gt;&lt;str name="text"&gt;hello world&lt;/str&gt;&lt;str name="text_hash"&gt;0000000000000000&lt;/str&gt;&lt;str name="title"&gt;new title&lt;/str&gt;&lt;long name="_version_"&gt;1417248120480202752&lt;/long&gt;&lt;/doc&gt;&lt;/result&gt;
&lt;/response&gt;
{noformat}
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                All these problems go away if we add the DistributedUpdateProcessorFactory ahead of all other processors instead of adding it just before RunUpdateProcessorFactory by default.

[~yonik@apache.org], is there a reason why we add DUPF at the last? It seems that other processors such as RegexReplaceProcessorFactory will also be affected.
              </div></li><li><div>
                If the SignatureUpdateProcessorFactory is generating the unique id, it must come before the distributed code
SOLR-2822 is a good starting place for related issues / discussions (I know there were more discussions but I can't find them now).

              </div></li><li><div><div><b>body:</b> This patch expands the document before computing signature.

I'm not convinced that it is the right solution. The DUPF gets the updated document in a synchronized (bucket) block which we don't. We could set the original document back (after adding signature to it) and let DUPF do its thing but that could lead to race conditions.

Perhaps we should decouple the document expansion for partial updates from DistributedUpdateRequestProcessor and apply it at the start of the request so that all UpdateRequestProcessors can work on the full document.

I don't fully comprehend the race conditions that may happen so I'll let someone more knowledgeable about this code to comment before proceeding any further.
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                I think we should simply skip the "generate signature" logic of the processor if it's an atomic update.

If one did want to do a full-blown solution, one way would probably involve using realtime-get to get the latest version of the document and then use optimistic concurrency when making the update.  But I don't think it's that big of a restriction to say that atomic updates won't change the signature generated.

              </div></li><li><div>
                bq. I think we should simply skip the "generate signature" logic of the processor if it's an atomic update.

I see why you suggested that. The signature is like a unique key and modifying it seems like a rare use-case. But, if we do go that way, we should throw an exception and explicitly disallow partial update of signature generating fields. Otherwise you end up with documents containing a wrong signature.

bq. If one did want to do a full-blown solution, one way would probably involve using realtime-get to get the latest version of the document and then use optimistic concurrency when making the update.

DUPF code says that it synchronizes on the bucket so that realtime-get works reliably. Is that necessary inside DedupUPF? If so, how do I get access to the VersionInfo? If not, is this  patch an appropriate solution?
              </div></li><li><div>
                Patch which disallows partial updates on signature generating fields
              </div></li><li><div><div><b>body:</b> Patch with a better test.
                </div><div><b>label:</b> test
                </div></div></li><li><div>
                [trunk commit] Shalin Shekhar Mangar
http://svn.apache.org/viewvc?view=revision&amp;revision=1433013

SOLR-4016: Deduplication does not work with atomic/partial updates so disallow atomic update requests which change signature generating fields.

              </div></li><li><div>
                bq. I see why you suggested that. The signature is like a unique key and modifying it seems like a rare use-case. But, if we do go that way, we should throw an exception and explicitly disallow partial update of signature generating fields.

There are different use-cases here.  If the signature being generated was the unique key, then atomic updates should be able to proceed fine as long as the id field is specified (as should always be the case with atomic updates).
              </div></li><li><div><div><b>body:</b> bq. If the signature being generated was the unique key, then atomic updates should be able to proceed fine as long as the id field is specified (as should always be the case with atomic updates).

The patch that I committed throws an exception if an atomic update request contains fields that are used to compute the signature. An atomic update request which does not modify the signature, proceeds as normal. This way we make sure that a document never contains a wrong signature.

Do you agree that this is an acceptable compromise until a proper fix is in place?
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                [branch_4x commit] Shalin Shekhar Mangar
http://svn.apache.org/viewvc?view=revision&amp;revision=1433530

SOLR-4016: Deduplication does not work with atomic/partial updates so disallow atomic update requests which change signature generating fields.

              </div></li><li><div>
                Shalin, this can be resolved as fixed, right?
              </div></li><li><div>
                Fixed in 4.1 and trunk.

Thanks Joel and Yonik.
              </div></li></ol></div></div></html>