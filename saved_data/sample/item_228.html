<!DOCTYPE html><html><div class="item-title">
        Item 228
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>message:</b> KAFKA-3581: add timeouts to joins in background thread services

This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

Author: Geoff Anderson &lt;geoff@confluent.io&gt;

Reviewers: Jason Gustafson &lt;jason@confluent.io&gt;, Ewen Cheslack-Postava &lt;ewen@confluent.io&gt;

Closes #1297 from granders/KAFKA-3581-systest-add-join-timeout

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li><li><div><div><b>title:</b> KAFKA-3581: add timeouts to joins in background thread services
                </div><div><b>body:</b> This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.

This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                @hachikuji Mind taking a look?

It's possible some default timeouts will need tuning, so I'm doing a full run here: https://jenkins.confluent.io/job/system-test-kafka-branch-builder-2/53/console

              </div></li><li><div><div><b>body:</b> @granders Thanks for taking this. Left a couple minor comments, but overall LGTM.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                @ewencp ping for final review
ideally double commit, since we think this prevents the hang in offset validation tests during teardown

Running another branch builder job here: 
https://jenkins.confluent.io/job/system-test-kafka-branch-builder-2/57/console

              </div></li><li><div>
                @granders Since you've taken "class" out of the events in VerifiableProducer, maybe we should do the same for VerifiableConsumer? 

              </div></li><li><div>
                @hachikuji Good point - updated

              </div></li><li><div>
                LGTM

              </div></li><li><div>
                Results from full run:
http://confluent-kafka-branch-builder-system-test-results.s3-us-west-2.amazonaws.com/2016-05-04--001.1462425703--confluentinc--KAFKA-3581-systest-add-join-timeout--0729736/report.html

              </div></li><li><div>
                @granders One of the sanity checks failed, is it unrelated?

              </div></li><li><div><div><b>body:</b> @ewencp Yes and no - as I think you may have pointed out elsewhere, the success of the verifiable producer sanity check is actually somewhat timing dependent - it relies on the `ps` command running while the producer process is still alive, and therefore before all of the messages have been produced.

The error message said the `ps` command said "this is not the process you are looking for", so my suspicion is that reducing the message size made the producer process finish more quickly. That's why I increased the number of messages (~1 second worth) to give more headroom. This passes consistently locally

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> @granders This looks good. Two thoughts. First, ConsoleConsumer looks like the one BackgroundThreadService that has potentially fixed work to do that didn't get this treatment. It's stop_node is pretty straightforward already, is that why we didn't make it consistent? Second, the fact that the same pattern repeats across all these classes suggests we might want to provide this functionality in a base class at some point. Doesn't have to happen now, but adding a class in either ducktape or kafkatest probably makes sense (and would get rid of quite a bit of common boilerplate I think, basically just leaving things like the actual command line construction and process name to kill to the subclasses).

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                @ewencp console consumer may have been an oversight; updated
Ran sanity checks and a subset of tests here: https://jenkins.confluent.io/job/system-test-kafka-branch-builder-2/59/console
1. I definitely agree that there is quite a bit of fairly similar boilerplate between services, although I don't think this PR is the place for consolidation

              </div></li><li><div>
                LGTM

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Is there any information from the node itself that we could add to this message so that we have an idea which instance failed to shutdown properly?

              </div></li><li><div><div><b>body:</b> Is 300 a typo or do we need a lot more time for the producer to finish?

                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>body:</b> nitpick: we seem to use spaces before and after the '=' in other cases.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                It can take a while - though 5 minutes may be more than necessary 

              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Use timeout when joining threads in system test services
                </div><div><b>description:</b> We have several instances in our system test services where we invoke Thread.join() in the stop_node() function to stop the service. It probably makes sense to use a timeout in join() to ensure that the process eventually has a chance to do unclean shutdown when the process becomes unresponsive. We have seen several cases in our daily runs (with the verifiable consumer in particular) where the process seems to hang on this join.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                GitHub user granders opened a pull request:

    https://github.com/apache/kafka/pull/1297

    KAFKA-3581: add timeouts to joins in background thread services

    This actually removes joins altogether, as well as references to self.worker_threads, which is best left as an implementation detail in BackgroundThreadService.
    
    This makes use of @hachikuji 's recent ducktape patch, and updates ducktape dependency to 0.5.0.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/confluentinc/kafka KAFKA-3581-systest-add-join-timeout

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/kafka/pull/1297.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #1297
    
----
commit a9108e8867afa44bdecbe760d47deccab0b94975
Author: Geoff Anderson &lt;geoff@confluent.io&gt;
Date:   2016-04-29T22:54:07Z

    Removed expicit references to worker_threads, and added wait_node with timeouts

----

              </div></li><li><div>
                Issue resolved by pull request 1297
[https://github.com/apache/kafka/pull/1297]
              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/kafka/pull/1297

              </div></li></ol></div></div></html>