<!DOCTYPE html><html><div class="item-title">
        Item 342
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                
 * Copyright (C) 2015 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                 Register the (now validated) context info
              </div></li><li><div>
                 Now, iterate over all the discovered interfaces
              </div></li><li><div>
                *
 * Utility implementing the necessary reflection for working with {@link DoFnWithContext}s.
 
              </div></li><li><div>
                 First, find all declared methods on the startClass and parents (up to stopClass)
              </div></li><li><div>
                *
   * Invoke the reflected {@link StartBundle} method on the given instance.
   *
   * @param fn an instance of the {@link DoFnWithContext} to invoke {@link StartBundle} on.
   * @param c the {@link com.google.cloud.dataflow.sdk.transforms.DoFnWithContext.Context}
   *     to pass to {@link StartBundle}.
   
              </div></li><li><div>
                 If we have at least one match, then either it should be the only match
 or it should be an extension of the other matches (which came from parent
 classes).
              </div></li><li><div>
                 The DoFnWithContext doesn't allow us to ask for these outside ProcessElements, so this
 should be unreachable.
              </div></li><li><div>
                *
   * @return true if the reflected {@link DoFnWithContext} uses Keyed State.
   
              </div></li><li><div>
                 Exception in user code.
              </div></li><li><div>
                 Verify that their method arguments satisfy our conditions.
              </div></li><li><div>
                *
   * Invoke the reflected {@link ProcessElement} method on the given instance.
   *
   * @param fn an instance of the {@link DoFnWithContext} to invoke {@link ProcessElement} on.
   * @param c the {@link com.google.cloud.dataflow.sdk.transforms.DoFnWithContext.ProcessContext}
   *     to pass to {@link ProcessElement}.
   
              </div></li><li><div>
                *
   * Verify the method arguments for a given {@link DoFnWithContext} method.
   *
   * &lt;p&gt;The requirements for a method to be valid, are:
   * &lt;ol&gt;
   * &lt;li&gt;The method has at least one argument.
   * &lt;li&gt;The first argument is of type firstContextArg.
   * &lt;li&gt;The remaining arguments have raw types that appear in {@code contexts}
   * &lt;li&gt;Any generics on the extra context arguments match what is expected. Eg.,
   *     {@code WindowingInternals&lt;I, O&gt;} either matches the {@code I} and {@code O} parameters of
   *     the {@code DoFn&lt;I, O&gt;.ProcessContext}, or it uses a wildcard, etc.
   * &lt;/ol&gt;
   *
   * @param m the method to verify
   * @param contexts mapping from raw classes to the {@link ExtraContextInfo} used
   *     to create new instances.
   * @param firstContextArg the expected type of the first context argument
   * @param iParam TypeParameter representing the input type
   * @param oParam TypeParameter representing the output type
   
              </div></li><li><div>
                *
   * @return true if the reflected {@link DoFnWithContext} uses a Single Window.
   
              </div></li><li><div>
                *
   * Invoke the reflected {@link FinishBundle} method on the given instance.
   *
   * @param fn an instance of the {@link DoFnWithContext} to invoke {@link FinishBundle} on.
   * @param c the {@link com.google.cloud.dataflow.sdk.transforms.DoFnWithContext.Context}
   *     to pass to {@link FinishBundle}.
   
              </div></li><li><div>
                 If we get here, the class matches, but maybe the generics don't:
              </div></li><li><div>
                *
     * Create an instance of the given instance using the instance factory.
     
              </div></li><li><div>
                 Exception in our code.
              </div></li><li><div>
                *
   * Implementation of {@link DoFnReflector} for the arbitrary {@link DoFnWithContext}.
   
              </div></li><li><div>
                 Locate the annotated methods
              </div></li><li><div>
                *
   * @return the {@link DoFnReflector} for the given {@link DoFnWithContext}.
   
              </div></li><li><div>
                *
   * Create a {@link DoFn} that the {@link DoFnWithContext}.
   
              </div></li><li><div>
                 We actually want the owner, since ProcessContext and Context are owned by DoFnWithContext.
              </div></li><li><div>
                 All of the remaining parameters must be a super-interface of allExtraContextArgs
 that is not listed in the EXCLUDED_INTERFACES set.
              </div></li><li><div>
                 We need to be able to call it. We require it is public.
              </div></li><li><div>
                *
     * Create the type token for the given type, filling in the generics.
     
              </div></li><li><div>
                 The first parameter must be present, and must be the specified type
              </div></li><li><div>
                 And make sure its not static.
              </div></li><li><div>
                 Fill in the generics in the allExtraContextArgs interface from the types in the
 Context or ProcessContext DoFn.
              </div></li><li><div>
                
 * Copyright (C) 2015 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                *
   * Returns a {@link TypeToken} capturing what is known statically
   * about the output type of this {@code DoFnWithContext} instance's
   * most-derived class.
   *
   * &lt;p&gt; In the normal case of a concrete {@code DoFnWithContext} subclass with
   * no generic type parameters of its own (including anonymous inner
   * classes), this will be a complete non-generic type, which is good
   * for choosing a default output {@code Coder&lt;O&gt;} for the output
   * {@code PCollection&lt;O&gt;}.
   
              </div></li><li><div>
                *
   * Annotation for the method to use for processing elements. A subclass of
   * {@link DoFnWithContext} must have a method with this annotation satisfying
   * the following constraints in order for it to be executable:
   * &lt;ul&gt;
   *   &lt;li&gt;It must have at least one argument.
   *   &lt;li&gt;Its first argument must be a {@link DoFnWithContext.ProcessContext}.
   *   &lt;li&gt;Its remaining arguments must be {@link KeyedState}, {@link BoundedWindow}, or
   *   {@link WindowingInternals WindowingInternals&lt;I, O&gt;}.
   * &lt;/ul&gt;
   
              </div></li><li><div>
                *
     * Adds the given element to the side output {@code PCollection} with the
     * given tag.
     *
     * &lt;p&gt; The caller of {@code ParDo} uses {@link ParDo#withOutputTags} to
     * specify the tags of side outputs that it consumes. Non-consumed side
     * outputs, e.g., outputs for monitoring purposes only, don't necessarily
     * need to be specified.
     *
     * &lt;p&gt; The output element will have the same timestamp and be in the same
     * windows as the input element passed to {@link ProcessElement}).
     *
     * &lt;p&gt; If invoked from {@link StartBundle} or {@link FinishBundle},
     * this will attempt to use the
     * {@link com.google.cloud.dataflow.sdk.transforms.windowing.WindowFn}
     * of the input {@code PCollection} to determine what windows the element
     * should be in, throwing an exception if the {@code WindowFn} attempts
     * to access any information about the input element. The output element
     * will have a timestamp of negative infinity.
     *
     * @throws IllegalArgumentException if the number of outputs exceeds
     * the limit of 1,000 outputs per DoFn
     * @see ParDo#withOutputTags
     
              </div></li><li><div>
                *
   * Returns a {@link TypeToken} capturing what is known statically
   * about the input type of this {@code DoFnWithContext} instance's most-derived
   * class.
   *
   * &lt;p&gt; See {@link #getOutputTypeToken} for more discussion.
   
              </div></li><li><div>
                *
   * Annotation for the method to use to prepare an instance for processing a batch of elements.
   * The method annotated with this must satisfy the following constraints:
   * &lt;ul&gt;
   *   &lt;li&gt;It must have at least one argument.
   *   &lt;li&gt;Its first (and only) argument must be a {@link DoFnWithContext.Context}.
   * &lt;/ul&gt;
   
              </div></li><li><div>
                ///////////////////////////////////////////////////////////////////////////
              </div></li><li><div>
                *
     * Construct the {@link KeyedState} interface for use within a {@link DoFnWithContext} that
     * needs it. This is called if the {@link ProcessElement} method has a parameter of type
     * {@link KeyedState}.
     *
     * @return {@link KeyedState} interface for interacting with keyed state.
     
              </div></li><li><div>
                *
   * Interface for runner implementors to provide implementations of extra context information.
   *
   * &lt;p&gt;The methods on this interface are called by {@link DoFnReflector} before invoking an
   * annotated {@link StartBundle}, {@link ProcessElement} or {@link FinishBundle} method that
   * has indicated it needs the given extra context.
   *
   * &lt;p&gt;In the case of {@link ProcessElement} it is called once per invocation of
   * {@link ProcessElement}.
   
              </div></li><li><div>
                *
     * Returns the {@code PipelineOptions} specified with the
     * {@link com.google.cloud.dataflow.sdk.runners.PipelineRunner}
     * invoking this {@code DoFnWithContext}.  The {@code PipelineOptions} will
     * be the default running via {@link DoFnTester}.
     
              </div></li><li><div>
                *
     * Construct the {@link WindowingInternals} to use within a {@link DoFnWithContext} that
     * needs it. This is called if the {@link ProcessElement} method has a parameter of type
     * {@link WindowingInternals}.
     
              </div></li><li><div>
                *
     * Adds the given element to the main output {@code PCollection}.
     *
     * &lt;p&gt; If invoked from {@link ProcessElement}, the output
     * element will have the same timestamp and be in the same windows
     * as the input element passed to {@link @ProcessElement}).
     *
     * &lt;p&gt; If invoked from {@link StartBundle} or {@link FinishBundle},
     * this will attempt to use the
     * {@link com.google.cloud.dataflow.sdk.transforms.windowing.WindowFn}
     * of the input {@code PCollection} to determine what windows the element
     * should be in, throwing an exception if the {@code WindowFn} attempts
     * to access any information about the input element. The output element
     * will have a timestamp of negative infinity.
     
              </div></li><li><div>
                *
   * Returns an {@link Aggregator} with the aggregation logic specified by the
   * {@link SerializableFunction} argument. The name provided must be unique
   * across {@link Aggregator}s created within the DoFn.
   *
   * @param name the name of the aggregator
   * @param combiner the {@link SerializableFunction} to use in the aggregator
   * @return an aggregator for the provided name and combiner in the scope of
   *         this DoFn
   * @throws NullPointerException if the name or combiner is null
   * @throws IllegalArgumentException if the given name collides with another
   *         aggregator in this scope
   
              </div></li><li><div>
                *
     * Returns the timestamp of the input element.
     *
     * &lt;p&gt; See {@link com.google.cloud.dataflow.sdk.transforms.windowing.Window}
     * for more information.
     
              </div></li><li><div>
                *
     * Construct the {@link BoundedWindow} to use within a {@link DoFnWithContext} that
     * needs it. This is called if the {@link ProcessElement} method has a parameter of type
     * {@link BoundedWindow}.
     *
     * @return {@link BoundedWindow} of the element currently being processed.
     
              </div></li><li><div>
                *
   * Information accessible when running {@link DoFn#processElement}.
   
              </div></li><li><div>
                *
   * Returns the allowed timestamp skew duration, which is the maximum
   * duration that timestamps can be shifted backward in
   * {@link DoFnWithContext.Context#outputWithTimestamp}.
   *
   * The default value is {@code Duration.ZERO}, in which case
   * timestamps can only be shifted forward to future.  For infinite
   * skew, return {@code Duration.millis(Long.MAX_VALUE)}.
   
              </div></li><li><div>
                *
     * Returns the input element to be processed.
     
              </div></li><li><div>
                * Information accessible to all methods in this {@code DoFnWithContext}. 
              </div></li><li><div>
                *
     * Returns the value of the side input.
     *
     * @throws IllegalArgumentException if this is not a side input
     * @see ParDo#withSideInputs
     
              </div></li><li><div>
                *
   * Returns an {@link Aggregator} with aggregation logic specified by the
   * {@link CombineFn} argument. The name provided must be unique across
   * {@link Aggregator}s created within the DoFn.
   *
   * @param name the name of the aggregator
   * @param combiner the {@link CombineFn} to use in the aggregator
   * @return an aggregator for the provided name and combiner in the scope of
   *         this DoFn
   * @throws NullPointerException if the name or combiner is null
   * @throws IllegalArgumentException if the given name collides with another
   *         aggregator in this scope
   
              </div></li><li><div>
                *
     * Adds the given element to the specified side output {@code PCollection},
     * with the given timestamp.
     *
     * &lt;p&gt; If invoked from {@link ProcessElement}), the timestamp
     * must not be older than the input element's timestamp minus
     * {@link DoFn#getAllowedTimestampSkew}.  The output element will
     * be in the same windows as the input element.
     *
     * &lt;p&gt; If invoked from {@link StartBundle} or {@link FinishBundle},
     * this will attempt to use the
     * {@link com.google.cloud.dataflow.sdk.transforms.windowing.WindowFn}
     * of the input {@code PCollection} to determine what windows the element
     * should be in, throwing an exception if the {@code WindowFn} attempts
     * to access any information about the input element except for the
     * timestamp.
     *
     * @throws IllegalArgumentException if the number of outputs exceeds
     * the limit of 1,000 outputs per DoFn
     * @see ParDo#withOutputTags
     
              </div></li><li><div>
                *
     * Adds the given element to the main output {@code PCollection},
     * with the given timestamp.
     *
     * &lt;p&gt; If invoked from {@link ProcessElement}), the timestamp
     * must not be older than the input element's timestamp minus
     * {@link DoFn#getAllowedTimestampSkew}.  The output element will
     * be in the same windows as the input element.
     *
     * &lt;p&gt; If invoked from {@link StartBundle} or {@link FinishBundle},
     * this will attempt to use the
     * {@link com.google.cloud.dataflow.sdk.transforms.windowing.WindowFn}
     * of the input {@code PCollection} to determine what windows the element
     * should be in, throwing an exception if the {@code WindowFn} attempts
     * to access any information about the input element except for the
     * timestamp.
     
              </div></li><li><div>
                *
 * The argument to {@link ParDo} providing the code to use to process
 * elements of the input
 * {@link com.google.cloud.dataflow.sdk.values.PCollection}.
 *
 * &lt;p&gt; See {@link ParDo} for more explanation, examples of use, and
 * discussion of constraints on {@code DoFnWithContext}s, including their
 * serializability, lack of access to global shared mutable state,
 * requirements for failure tolerance, and benefits of optimization.
 *
 * &lt;p&gt; {@code DoFnWithContext}s can be tested in a particular
 * {@code Pipeline} by running that {@code Pipeline} on sample input
 * and then checking its output.  Unit testing of a {@code DoFnWithContext},
 * separately from any {@code ParDo} transform or {@code Pipeline},
 * can be done via the {@link DoFnTester} harness.
 *
 * &lt;p&gt;Implementations must define a method annotated with {@link ProcessElement}
 * that satisfies the requirements described there. See the {@link ProcessElement}
 * for details.
 *
 * &lt;p&gt; This functionality is experimental and likely to change.
 *
 * &lt;p&gt; Example usage:
 *
 * &lt;pre&gt; {@code
 * PCollection&lt;String&gt; lines = ... ;
 * PCollection&lt;String&gt; words =
 *     lines.apply(ParDo.of(new DoFnWithContext&lt;String, String&gt;() {
 *         @ProcessElement
 *         public void processElement(ProcessContext c, BoundedWindow window) {
 *
 *         }}));
 * } &lt;/pre&gt;
 *
 * @param &lt;I&gt; the type of the (main) input elements
 * @param &lt;O&gt; the type of the (main) output elements
 
              </div></li><li><div>
                
 * Copyright (C) 2015 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                *
 * Tests for {@link DoFnReflector}.
 
              </div></li><li><div>
                
 * Copyright (C) 2015 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                * Tests for {@link DoFnWithContext}. 
              </div></li><li><div>
                *
     * @param c context
     
              </div></li><li><div>
                *
   * Returns a {@code DoFnTester} supporting unit-testing of the given
   * {@link DoFn}.
   
              </div></li><li><div>
                *
     * Returns a new {@code ParDo} {@code PTransform} that's like this
     * transform but which will invoke the given {@link DoFnWithContext}
     * function, and which has its input and output types bound.  Does
     * not modify this transform.  The resulting {@code PTransform} is
     * sufficiently specified to be applied, but more properties can
     * still be specified.
     
              </div></li><li><div>
                *
     * Returns a new multi-output {@code ParDo} {@code PTransform}
     * that's like this transform but which will invoke the given
     * {@link DoFnWithContext} function, and which has its input type bound.
     * Does not modify this transform.  The resulting
     * {@code PTransform} is sufficiently specified to be applied, but
     * more properties can still be specified.
     
              </div></li><li><div>
                *
   * Creates a {@code ParDo} {@code PTransform} that will invoke the
   * given {@link DoFnWithContext} function.
   *
   * &lt;p&gt; The resulting {@code PTransform}'s types have been bound, with the
   * input being a {@code PCollection&lt;I&gt;} and the output a
   * {@code PCollection&lt;O&gt;}, inferred from the types of the argument
   * {@code DoFn&lt;I, O&gt;}.  It is ready to be applied, or further
   * properties can be set on it first.
   *
   * &lt;p&gt; {@link DoFnWithContext} is an experimental alternative to
   * {@link DoFn} which simplifies accessing {@code KeyedState} and
   * the window of the element.
   
              </div></li><li><div>
                *
   * Returns all interfaces of the given clazz.
   * @param clazz
   * @return
   
              </div></li><li><div>
                *
   * Returns all the methods visible from the provided interfaces.
   *
   * @param interfaces The interfaces to use when searching for all their methods.
   * @return An iterable of {@link Method}s which interfaces expose.
   
              </div></li><li><div>
                *
   * Returns all the methods visible from {@code iface}.
   *
   * @param iface The interface to use when searching for all its methods.
   * @return An iterable of {@link Method}s which {@code iface} exposes.
   
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Introduce DoFnWithContext, an annotation based version of DoFn.
                </div><div><b>message:</b> Introduce DoFnWithContext, an annotation based version of DoFn.

Current implementation is via DoFnReflector and an adaptor to turn a
DoFnWithContext into a DoFn.

----Release Notes----
Introduce DoFnWithContext, an experimental way to simplify accessing
extra information such as KeyedState and the current window for a DoFn.
Consider using DoFnWithContext rather than creating a DoFn that
implements the RequiresKeyedState or RequiresWindowAccess.

[]
-------------
Created by MOE: http://code.google.com/p/moe-java
MOE_MIGRATED_REVID=92189663

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>