<!DOCTYPE html><html><div class="item-title">
        Item 85
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                
 This script connects to the system vm socket and writes the
 authorized_keys and cmdline data to it. The system VM then
 reads it from /dev/vport0p1 in cloud_early_config

              </div></li><li><div>
                 Success
              </div></li><li><div>
                !/usr/bin/env python
 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.
              </div></li><li><div>
                 Keep old substitution from perl code:
              </div></li><li><div>
                !/usr/bin/env python
 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.
              </div></li><li><div>
                 timeout
              </div></li><li><div>
                 Testing substitution
              </div></li><li><div>
                 Very short time for tests that don't write to socket.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Merge pull request #1533 from greenqloud/pr-patchviasocket-convert-to-python
                </div><div><b>message:</b> Merge pull request #1533 from greenqloud/pr-patchviasocket-convert-to-python

Convert patchviasocket to python (removes perl dependency for KVM agent)As requested here: https://github.com/apache/cloudstack/pull/1495

No scripts are using perl so that install requirement can be removed.
The new scripts are using standard python packages only.
Includes extensive unit test.
Note: perl-modules requirement is missing (fixed in mentioned PR) so do not merge that onto master.

* pr/1533:
  Revert "Add perl-modules as install dependency for cloudstack-agent"
  patchviasocket improve error handling
  Convert patchviasocket to python (removes perl dependency for KVM agent)

Signed-off-by: Will Stevens &lt;williamstevens@gmail.com&gt;

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> Convert patchviasocket to python (removes perl dependency for KVM agent)
                </div><div><b>body:</b> As requested here: https://github.com/apache/cloudstack/pull/1495

No scripts are using perl so that install requirement can be removed.
The new scripts are using standard python packages only.
Includes extensive unit test.
Note: perl-modules requirement is missing (fixed in mentioned PR) so do not merge that onto master.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                Thanks for this! In the future I'd like to see this done through the Qemu Guest Agent, but that is still waiting for something, see: #985

              </div></li><li><div>
                I hadn't looked into the code yet so for what it's worth and pending response to the comments:
CI RESULTS
[1533.results.internal_lb.txt](https://github.com/apache/cloudstack/files/253034/1533.results.internal_lb.txt)
[1533.results.network.txt](https://github.com/apache/cloudstack/files/253035/1533.results.network.txt)
[1533.results.vpc_routers.txt](https://github.com/apache/cloudstack/files/253037/1533.results.vpc_routers.txt)
[1533.results.vpc_vpn.txt](https://github.com/apache/cloudstack/files/253036/1533.results.vpc_vpn.txt)

I didn't bother with the known ping problem in test_02_redundant_VPC_default_routes

              </div></li><li><div>
                @DaanHoogland can you post a 'summary' of the results when you post this.  I don't want to have to download each of these files to know that they ran successfully.  Can you just say something like "CI Passed" or something like that?  "Here are the results" without telling me if it is a success for failure requires me to download and review every file.  I understand from your "dont bother with" comment that everything passed except that, but if you can just let me know that status, that will help me.  Thanks for testing this.  üëç 

              </div></li><li><div>
                I am missing some code review on this one, but otherwise this is looking good so far.

              </div></li><li><div>
                Sorry Will, Yes all passed, some after retest.

              </div></li><li><div>
                Can @sverrirab look at the comments of @jburwell ?

              </div></li><li><div>
                @wido I just pushed an update that addresses the comments from @jburwell 

tested this locally as well of course

              </div></li><li><div>
                Thanks! code-wise this looks good to me now

              </div></li><li><div>
                @sverrirab thank you.  Would you mind adding the revert of #1495 into this commit in order to clean up unnecessary packages once this PR is accepted?  I think we are missing one code review on this one and it is pretty much ready to go.  Thanks...

              </div></li><li><div>
                Rebased the PR to latest master and reverted the relevant commit (64b72a5c5a410f41bd869cc9d40807d888e05055.).  I think we should be good to go @swill ?

              </div></li><li><div>
                ### CI RESULTS

```
Tests Run: 85
  Skipped: 0
   Failed: 0
   Errors: 0
 Duration: 8h 55m 29s
```

**Associated Uploads**

**`/tmp/MarvinLogs/DeployDataCenter__May_21_2016_01_21_56_QYQ9XC:`**
- [dc_entries.obj](https://objects-east.cloud.ca/v1/e465abe2f9ae4478b9fff416eab61bd9/PR1533/tmp/MarvinLogs/DeployDataCenter__May_21_2016_01_21_56_QYQ9XC/dc_entries.obj)
- [failed_plus_exceptions.txt](https://objects-east.cloud.ca/v1/e465abe2f9ae4478b9fff416eab61bd9/PR1533/tmp/MarvinLogs/DeployDataCenter__May_21_2016_01_21_56_QYQ9XC/failed_plus_exceptions.txt)
- [runinfo.txt](https://objects-east.cloud.ca/v1/e465abe2f9ae4478b9fff416eab61bd9/PR1533/tmp/MarvinLogs/DeployDataCenter__May_21_2016_01_21_56_QYQ9XC/runinfo.txt)

**`/tmp/MarvinLogs/test_network_T2P1UQ:`**
- [failed_plus_exceptions.txt](https://objects-east.cloud.ca/v1/e465abe2f9ae4478b9fff416eab61bd9/PR1533/tmp/MarvinLogs/test_network_T2P1UQ/failed_plus_exceptions.txt)
- [results.txt](https://objects-east.cloud.ca/v1/e465abe2f9ae4478b9fff416eab61bd9/PR1533/tmp/MarvinLogs/test_network_T2P1UQ/results.txt)
- [runinfo.txt](https://objects-east.cloud.ca/v1/e465abe2f9ae4478b9fff416eab61bd9/PR1533/tmp/MarvinLogs/test_network_T2P1UQ/runinfo.txt)

**`/tmp/MarvinLogs/test_vpc_routers_U3WSE5:`**
- [failed_plus_exceptions.txt](https://objects-east.cloud.ca/v1/e465abe2f9ae4478b9fff416eab61bd9/PR1533/tmp/MarvinLogs/test_vpc_routers_U3WSE5/failed_plus_exceptions.txt)
- [results.txt](https://objects-east.cloud.ca/v1/e465abe2f9ae4478b9fff416eab61bd9/PR1533/tmp/MarvinLogs/test_vpc_routers_U3WSE5/results.txt)
- [runinfo.txt](https://objects-east.cloud.ca/v1/e465abe2f9ae4478b9fff416eab61bd9/PR1533/tmp/MarvinLogs/test_vpc_routers_U3WSE5/runinfo.txt)

Uploads will be available until `2016-07-22 02:00:00 +0200 CEST`

_Comment created by [`upr comment`](https://github.com/cloudops/upr)._

              </div></li><li><div>
                This is coming back clean.  Would you mind trying to rebase and re-push or close and reopen to see if we can kick off travis one more time.  Thanks...

              </div></li><li><div>
                everything looking good now it seems - time to merge @swill ?

              </div></li><li><div>
                Yes, ready now.  Thank you.  :)

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Is IOError the only exception which can occur here?

Wouldn't it be safer to but a 'return 0' in a 'finally' statement and otherwise return 1?

              </div></li><li><div>
                IOError is the parent of socket.error so this will catch all socket related errors.
The code as it stands returns 1 on any error and 0 on success - so there is no benefit of adding a finally statement there that I can see.

              </div></li><li><div>
                Would it be helpful to print/log the details of the `IOError` for debugging purposes?  For example, understanding whether the file was not found or the user lacked sufficient permissions.

              </div></li><li><div>
                Why throw this error out of `read_pub_key` and consolidate the error handling/return in the exception handler on line 64?

              </div></li><li><div>
                Should this be bounded by a maximum wait time?  For example, if the ulimits are exceeded, this function could turn into an infinite loop.

              </div></li><li><div>
                According to the [Python API document for `tempfile.mktemp`](https://docs.python.org/2/library/tempfile.html), this method has been deprecated since Python 2.3.  `tempfile.mkstemp` should be used instead.

              </div></li><li><div>
                According to the [Python API document for `tempfile.mktemp`](https://docs.python.org/2/library/tempfile.html), this method has been deprecated since Python 2.3.  `tempfile.mkstemp` should be used instead.

              </div></li><li><div>
                Line 73-74 should be in a `finally` block to ensure the resources are properly closed when an exception occurs.

              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>