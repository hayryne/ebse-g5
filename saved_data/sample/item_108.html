<!DOCTYPE html><html><div class="item-title">
        Item 108
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div><div><b>comment:</b>  Clean up, terminate the created accounts
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 Random characters are appended for unique
 username
              </div></li><li><div><div><b>comment:</b>  Cleanup resources used
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.
              </div></li><li><div>
                 Create an account, domain etc
              </div></li><li><div>
                 Import Local Modules
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> CLOUDSTACK-3009: Fix resource calculation CPU, RAM for accounts. (#3012)
                </div><div><b>message:</b> CLOUDSTACK-3009: Fix resource calculation CPU, RAM for accounts. (#3012)

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:

4.12
4.11
Fixes: #3009
                </div></div></li></ol></div><div><b>github_issues:</b> <ol><li><div><div><b>title:</b> BUG: Account Resource Count is incorred when removed Service Offerings used
                </div><div><b>body:</b> &lt;!--
Verify first that your issue/request is not already reported on GitHub.
Also test if the latest release and master branch are affected too.
Always add information AFTER of these HTML comments, but no need to delete the comments.
--&gt;

##### ISSUE TYPE
&lt;!-- Pick one below and delete the rest --&gt;
 * Bug Report

##### COMPONENT NAME
&lt;!--
Categorize the issue, e.g. API, VR, VPN, UI, etc.
--&gt;
~~~
Management Server
~~~

##### CLOUDSTACK VERSION
&lt;!--
New line separated list of affected versions, commit ID for issues on master branch.
--&gt;

~~~
4.11.1
~~~

##### CONFIGURATION
&lt;!--
Information about the configuration if relevant, e.g. basic network, advanced networking, etc.  N/A otherwise
--&gt;
Basic Networking, Domain ROOT/users, user: user

##### OS / ENVIRONMENT
&lt;!--
Information about the environment if relevant, N/A otherwise
--&gt;

Ubuntu 16.04 Server

##### SUMMARY
&lt;!-- Explain the problem/feature briefly --&gt;
When you use in the account VM with SO removed, its resources are not accounted. Maybe specific only for accounts inside domains, but unsure. Bug found for env with domains. The bug was found when our engineer developed the feature for CSUI.

Maybe DOs also affected somehow.

##### STEPS TO REPRODUCE
&lt;!--
For bugs, show exactly how to reproduce the problem, using a minimal test-case. Use Screenshots if accurate. The bug is important as it breaks the resource allocation/calculation model which can be used for billing purposes.

For new features, show how the feature would be used.
--&gt;

1. admin: create an account.
2. admin: create SO which the account may use.
3. user: create VM with the SO.
4. admin: request account resource counters (correct).
4. admin: remove SO.
5. admin: request account resource counters (incorrect).

&lt;!-- Paste example playbooks or commands between quotes below --&gt;
~~~

~~~

&lt;!-- You can also paste gist.github.com links for larger files --&gt;

##### EXPECTED RESULTS
&lt;!-- What did you expect to happen when running the steps above? --&gt;

~~~
Resource calculation must be correct even when VMs with removed SOs are used.
~~~

##### ACTUAL RESULTS
&lt;!-- What actually happened? --&gt;

&lt;!-- Paste verbatim command output between quotes below --&gt;
~~~
Resources are calculated incorrectly. VM is accounted in VM count, but RAM and CPU is not accounted.
~~~

                </div></div></li><li><div><div><b>title:</b> BUG: Account Resource Count is incorred when removed Service Offerings used
                </div><div><b>body:</b> &lt;!--
Verify first that your issue/request is not already reported on GitHub.
Also test if the latest release and master branch are affected too.
Always add information AFTER of these HTML comments, but no need to delete the comments.
--&gt;

##### ISSUE TYPE
&lt;!-- Pick one below and delete the rest --&gt;
 * Bug Report

##### COMPONENT NAME
&lt;!--
Categorize the issue, e.g. API, VR, VPN, UI, etc.
--&gt;
~~~
Management Server
~~~

##### CLOUDSTACK VERSION
&lt;!--
New line separated list of affected versions, commit ID for issues on master branch.
--&gt;

~~~
4.11.1
~~~

##### CONFIGURATION
&lt;!--
Information about the configuration if relevant, e.g. basic network, advanced networking, etc.  N/A otherwise
--&gt;
Basic Networking, Domain ROOT/users, user: user

##### OS / ENVIRONMENT
&lt;!--
Information about the environment if relevant, N/A otherwise
--&gt;

Ubuntu 16.04 Server

##### SUMMARY
&lt;!-- Explain the problem/feature briefly --&gt;
When you use in the account VM with SO removed, its resources are not accounted. Maybe specific only for accounts inside domains, but unsure. Bug found for env with domains. The bug was found when our engineer developed the feature for CSUI.

Maybe DOs also affected somehow.

##### STEPS TO REPRODUCE
&lt;!--
For bugs, show exactly how to reproduce the problem, using a minimal test-case. Use Screenshots if accurate. The bug is important as it breaks the resource allocation/calculation model which can be used for billing purposes.

For new features, show how the feature would be used.
--&gt;

1. admin: create an account.
2. admin: create SO which the account may use.
3. user: create VM with the SO.
4. admin: request account resource counters (correct).
4. admin: remove SO.
5. admin: request account resource counters (incorrect).

&lt;!-- Paste example playbooks or commands between quotes below --&gt;
~~~

~~~

&lt;!-- You can also paste gist.github.com links for larger files --&gt;

##### EXPECTED RESULTS
&lt;!-- What did you expect to happen when running the steps above? --&gt;

~~~
Resource calculation must be correct even when VMs with removed SOs are used.
~~~

##### ACTUAL RESULTS
&lt;!-- What actually happened? --&gt;

&lt;!-- Paste verbatim command output between quotes below --&gt;
~~~
Resources are calculated incorrectly. VM is accounted in VM count, but RAM and CPU is not accounted.
~~~

                </div></div></li><li><div><div><b>title:</b> BUG: Account Resource Count is incorred when removed Service Offerings used
                </div><div><b>body:</b> &lt;!--
Verify first that your issue/request is not already reported on GitHub.
Also test if the latest release and master branch are affected too.
Always add information AFTER of these HTML comments, but no need to delete the comments.
--&gt;

##### ISSUE TYPE
&lt;!-- Pick one below and delete the rest --&gt;
 * Bug Report

##### COMPONENT NAME
&lt;!--
Categorize the issue, e.g. API, VR, VPN, UI, etc.
--&gt;
~~~
Management Server
~~~

##### CLOUDSTACK VERSION
&lt;!--
New line separated list of affected versions, commit ID for issues on master branch.
--&gt;

~~~
4.11.1
~~~

##### CONFIGURATION
&lt;!--
Information about the configuration if relevant, e.g. basic network, advanced networking, etc.  N/A otherwise
--&gt;
Basic Networking, Domain ROOT/users, user: user

##### OS / ENVIRONMENT
&lt;!--
Information about the environment if relevant, N/A otherwise
--&gt;

Ubuntu 16.04 Server

##### SUMMARY
&lt;!-- Explain the problem/feature briefly --&gt;
When you use in the account VM with SO removed, its resources are not accounted. Maybe specific only for accounts inside domains, but unsure. Bug found for env with domains. The bug was found when our engineer developed the feature for CSUI.

Maybe DOs also affected somehow.

##### STEPS TO REPRODUCE
&lt;!--
For bugs, show exactly how to reproduce the problem, using a minimal test-case. Use Screenshots if accurate. The bug is important as it breaks the resource allocation/calculation model which can be used for billing purposes.

For new features, show how the feature would be used.
--&gt;

1. admin: create an account.
2. admin: create SO which the account may use.
3. user: create VM with the SO.
4. admin: request account resource counters (correct).
4. admin: remove SO.
5. admin: request account resource counters (incorrect).

&lt;!-- Paste example playbooks or commands between quotes below --&gt;
~~~

~~~

&lt;!-- You can also paste gist.github.com links for larger files --&gt;

##### EXPECTED RESULTS
&lt;!-- What did you expect to happen when running the steps above? --&gt;

~~~
Resource calculation must be correct even when VMs with removed SOs are used.
~~~

##### ACTUAL RESULTS
&lt;!-- What actually happened? --&gt;

&lt;!-- Paste verbatim command output between quotes below --&gt;
~~~
Resources are calculated incorrectly. VM is accounted in VM count, but RAM and CPU is not accounted.
~~~

                </div></div></li></ol></div><div><b>github_issues_comments:</b> <ol><li><div>
                PR merged, closing. 
              </div></li></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li><li><div><div><b>title:</b> CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
                </div><div><b>body:</b> ## Description
&lt;!--- Describe your changes in detail --&gt;
Bug fix for #3009 

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:
- 4.12
- 4.11

&lt;!-- For new features, provide link to FS, dev ML discussion etc. --&gt;
&lt;!-- In case of bug fix, the expected and actual behaviours, steps to reproduce. --&gt;

&lt;!-- When "Fixes: #&lt;id&gt;" is specified, the issue/PR will automatically be closed when this PR gets merged --&gt;
&lt;!-- For addressing multiple issues/PRs, use multiple "Fixes: #&lt;id&gt;" --&gt;
&lt;!-- Fixes: # --&gt;

Fixes: #3009 

## Types of changes
&lt;!--- What types of changes does your code introduce? Put an `x` in all the boxes that apply: --&gt;
- [ ] Breaking change (fix or feature that would cause existing functionality to change)
- [ ] New feature (non-breaking change which adds functionality)
- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] Enhancement (improves an existing feature and functionality)
- [ ] Cleanup (Code refactoring and cleanup, that may add test cases)

## Screenshots (if appropriate):

## How Has This Been Tested?
&lt;!-- Please describe in detail how you tested your changes. --&gt;
&lt;!-- Include details of your testing environment, and the tests you ran to --&gt;
&lt;!-- see how your change affects other areas of the code, etc. --&gt;

The code was tested manually by running SQL inside MySQL console.
Marvin tests should be done.

&lt;!-- Please read the [CONTRIBUTING](https://github.com/apache/cloudstack/blob/master/CONTRIBUTING.md) document --&gt;

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                I think you should change the view to include this even when it is deleted, instead of changing the joining table/view. What do you think?
              </div></li><li><div><div><b>body:</b>  @rafaelweingartner potentially it could lead to many bugs. I think the change could some other places to fix. Now it's a small fix, but can transform into a large one.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Can you explain further why (your concerns)?I mean, if logically the result is the same when finding the physical interface, why would this affect other places?
              </div></li><li><div>
                @rafaelweingartner it's not thst issue. It's for resource accounting.
              </div></li><li><div>
                Ops, I was with the other issue in the cache... Sorry ;)
Let me load this one out of the HDD again... 
              </div></li><li><div><div><b>body:</b> Ok, I looked in the code, and the table is used in some other places, specially the `ServiceOfferingJoinVO`. Therefore, the impacts might be big. It makes sense to use the `service_offering` if it has everything you need in that context.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                @rafaelweingartner may we add to 4.11.3 as well?
              </div></li><li><div>
                Sure, but then the process is a little bit different. You need to target 4.11 branch. This will require you to cherry pick your current commit into 4.11. 
              </div></li><li><div>
                @rafaelweingartner Ok. then I leave this one too? Or close this one and open for 4.11?
              </div></li><li><div>
                Actually, you can keep using this one. You only need to change the target branch here, and then update your `bwsw:bug/accounting-bug-3009` branch to use 4.11 + the commit introduced here
              </div></li><li><div>
                @rafaelweingartner Ok. Got it. I'll try. Not a git pro, thought...
              </div></li><li><div>
                Ping me on Slack if you get lost.

              </div></li><li><div>
                @rafaelweingartner Please, take a look. Looks like I managed it.
              </div></li><li><div>
                Looks like Jenkins is unhappy with moving merge branch from master to 4.11.
              </div></li><li><div>
                It is a coincidence. It was not a problem because of the changes, but rather a worker that was working as it should.
              </div></li><li><div>
                @bwsw what happened with this PR? I mean, there are now a lot of docker files, and other things that are not related to the change I reviewed.
              </div></li><li><div>
                @rafaelweingartner I want to write additional E2E tests for the code. Thus, I started with Marvin and improved the Dockerfile for the simulator to fit Marvin development needs. It's a WIP work. Please, take a look at the email list for details.
              </div></li><li><div>
                @rafaelweingartner Sorry about that)
              </div></li><li><div>
                @rafaelweingartner please review again,
@borisstoyanov please review smoke test implemented.
              </div></li><li><div>
                @blueorangutan package
              </div></li><li><div>
                @rhtyd a Jenkins job has been kicked to build packages. I'll keep you posted as I make progress.
              </div></li><li><div>
                Moved to 4.11.2.0 as it sounds like a critical business issue if resource counts are wrong.
              </div></li><li><div>
                Packaging result: ✔centos6 ✔centos7 ✖debian. JID-2425
              </div></li><li><div>
                @blueorangutan test
              </div></li><li><div>
                @rhtyd a Trillian-Jenkins test job (centos7 mgmt + kvm-centos7) has been kicked to run smoke tests
              </div></li><li><div>
                Nevermind, I needed to run test quickly - have implemented minor fixes.
              </div></li><li><div>
                &lt;b&gt;Trillian test result (tid-3164)&lt;/b&gt;
Environment: kvm-centos7 (x2), Advanced Networking with Mgmt server 7
Total time taken: 23884 seconds
Marvin logs: https://github.com/blueorangutan/acs-prs/releases/download/trillian/pr3012-t3164-kvm-centos7.zip
Intermittent failure detected: /marvin/tests/smoke/test_deploy_virtio_scsi_vm.py
Intermittent failure detected: /marvin/tests/smoke/test_internal_lb.py
Intermittent failure detected: /marvin/tests/smoke/test_resource_accounting.py
Intermittent failure detected: /marvin/tests/smoke/test_vpc_vpn.py
Intermittent failure detected: /marvin/tests/smoke/test_host_maintenance.py
Smoke tests completed. 67 look OK, 1 have error(s)
Only failed tests results shown below:


Test | Result | Time (s) | Test File
--- | --- | --- | ---
test_01_so_removal_resource_update | `Error` | 26.67 | test_resource_accounting.py

              </div></li><li><div>
                ```
2018-11-12 10:24:59,254 INFO  [o.a.c.a.c.a.v.DeployVMCmdByAdmin] (API-Job-Executor-39:ctx-cda190fb job-1365 ctx-88aeda9f) (logid:7faecac3) Unable to create a deployment
 for VM[User|i-127-159-VM]
com.cloud.exception.InsufficientServerCapacityException: Unable to create a deployment for VM[User|i-127-159-VM]Scope=interface com.cloud.dc.DataCenter; id=1
        at org.apache.cloudstack.engine.cloud.entity.api.VMEntityManagerImpl.reserveVirtualMachine(VMEntityManagerImpl.java:215)
        at org.apache.cloudstack.engine.cloud.entity.api.VirtualMachineEntityImpl.reserve(VirtualMachineEntityImpl.java:200)
        at com.cloud.vm.UserVmManagerImpl.startVirtualMachine(UserVmManagerImpl.java:4492)
        at com.cloud.vm.UserVmManagerImpl.startVirtualMachine(UserVmManagerImpl.java:4057)
        at com.cloud.vm.UserVmManagerImpl.startVirtualMachine(UserVmManagerImpl.java:4044)
        at sun.reflect.GeneratedMethodAccessor535.invoke(Unknown Source)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:338)
        at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:197)
        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
        at org.apache.cloudstack.network.contrail.management.EventUtils$EventInterceptor.invoke(EventUtils.java:107)
        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:174)
        at com.cloud.event.ActionEventInterceptor.invoke(ActionEventInterceptor.java:51)
        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:174)
        at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:92)
        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:185)
        at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:212)
        at com.sun.proxy.$Proxy164.startVirtualMachine(Unknown Source)
        at org.apache.cloudstack.api.command.admin.vm.DeployVMCmdByAdmin.execute(DeployVMCmdByAdmin.java:50)
        at com.cloud.api.ApiDispatcher.dispatch(ApiDispatcher.java:150)
        at com.cloud.api.ApiAsyncJobDispatcher.runJob(ApiAsyncJobDispatcher.java:108)
        at org.apache.cloudstack.framework.jobs.impl.AsyncJobManagerImpl$5.runInContext(AsyncJobManagerImpl.java:581)
        at org.apache.cloudstack.managed.context.ManagedContextRunnable$1.run(ManagedContextRunnable.java:49)
        at org.apache.cloudstack.managed.context.impl.DefaultManagedContext$1.call(DefaultManagedContext.java:56)
        at org.apache.cloudstack.managed.context.impl.DefaultManagedContext.callWithContext(DefaultManagedContext.java:103)
        at org.apache.cloudstack.managed.context.impl.DefaultManagedContext.runWithContext(DefaultManagedContext.java:53)
        at org.apache.cloudstack.managed.context.ManagedContextRunnable.run(ManagedContextRunnable.java:46)
        at org.apache.cloudstack.framework.jobs.impl.AsyncJobManagerImpl$5.run(AsyncJobManagerImpl.java:529)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
        at java.lang.Thread.run(Thread.java:748)
2018-11-12 10:24:59,255 DEBUG [o.a.c.f.j.i.AsyncJobManagerImpl] (API-Job-Executor-39:ctx-cda190fb job-1365) (logid:7faecac3) Complete async job-1365, jobStatus: FAILED, resultCode: 530, result: org.apache.cloudstack.api.response.ExceptionResponse/null/{"uuidList":[],"errorcode":533,"errortext":"Unable to create a deployment for VM[User|i-127-159-VM]"}
```
Doesn't looks like connected with the test itself, rather an env problem.
              </div></li><li><div>
                @borisstoyanov I don't care, just wanted SOs to vary.
              </div></li><li><div>
                @bwsw yes, you're right, issue is that blueorangutan's environment has hosts with 3 cores and we're requesting 4. Perhaps you could just change the offering to request 3? 
              </div></li><li><div>
                @borisstoyanov Done
              </div></li><li><div>
                @blueorangutan package 
              </div></li><li><div>
                @rhtyd a Jenkins job has been kicked to build packages. I'll keep you posted as I make progress.
              </div></li><li><div>
                Packaging result: ✔centos6 ✔centos7 ✖debian. JID-2431
              </div></li><li><div>
                @blueorangutan test 
              </div></li><li><div>
                @rhtyd a Trillian-Jenkins test job (centos7 mgmt + kvm-centos7) has been kicked to run smoke tests
              </div></li><li><div>
                &lt;b&gt;Trillian test result (tid-3169)&lt;/b&gt;
Environment: kvm-centos7 (x2), Advanced Networking with Mgmt server 7
Total time taken: 22024 seconds
Marvin logs: https://github.com/blueorangutan/acs-prs/releases/download/trillian/pr3012-t3169-kvm-centos7.zip
Intermittent failure detected: /marvin/tests/smoke/test_outofbandmanagement.py
Intermittent failure detected: /marvin/tests/smoke/test_vpc_vpn.py
Smoke tests completed. 68 look OK, 0 have error(s)
Only failed tests results shown below:


Test | Result | Time (s) | Test File
--- | --- | --- | ---

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Can you add this to .travis.yml as well?
              </div></li><li><div>
                Test LGMT, let's wait for the results 
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> [VPC][VMware]Unable to execute NetworkUsage command on DomR (10.147.40.181), domR may not be ready yet. failure due to Exception: java.lang.Exception—when VPC/VPC VR is rebooted
                </div><div><b>description:</b> Steps:
1.	Have a CS with advanced zone and with VMware host.
2.	Create VPC .
3.	Create a private gateway and a static route to it.
4.	Reboot  the VPC VR.
5.	After successful reboot of VR, now restart the VPC.
           OR
After step 3 Restart the VPC and after successful restart, now reboot VR.

Observation:


Observed the following exception when VPC is restarted/VR is rebooted.

2013-06-14 20:11:28,390 ERROR [vmware.resource.VmwareResource] (DirectAgent-142:10.147.40.29) Unable to execute NetworkUsage command on DomR (10.147.40.184), domR may not be ready yet. failure due to Exception: java.lang.Exception
Message:  vpc network usage get returns empty

java.lang.Exception:  vpc network usage get returns empty
        at com.cloud.hypervisor.vmware.resource.VmwareResource.VPCNetworkUsage(VmwareResource.java:676)
        at com.cloud.hypervisor.vmware.resource.VmwareResource.execute(VmwareResource.java:622)
        at com.cloud.hypervisor.vmware.resource.VmwareResource.executeRequest(VmwareResource.java:472)
        at com.cloud.agent.manager.DirectAgentAttache$Task.run(DirectAgentAttache.java:186)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
        at java.util.concurrent.FutureTask.run(FutureTask.java:166)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:165)
        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
        at java.lang.Thread.run(Thread.java:679)
2013-06-14 20:11:28,400 DEBUG [agent.manager.DirectAgentAttache] (DirectAgent-142:null) Seq 1-519307624: Response Received:

Attaching the MS log.

                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                This blocker/ critcal was created before July please review and resolve, we are approaching 4.2 code freeze in 7 days 
              </div></li><li><div>
                This error is logged when Network usage command is sent when the VR is rebooting. This is a corner case. Command is sent only to the VRs in up state, but the state changed in this case before it was executed. Network usage stats collection is also not impacted since the answer is ignored.
              </div></li><li><div>
                Closing the issue as per Kishan comments
              </div></li><li><div>
                bwsw commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437598240
 
 
   @rafaelweingartner please review again,
   @borisstoyanov please review smoke test implemented.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                rhtyd commented on a change in pull request #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#discussion_r232542802
 
 

 ##########
 File path: test/integration/smoke/test_resource_accounting.py
 ##########
 @@ -0,0 +1,252 @@
+# Licensed to the Apache Software Foundation (ASF) under one
 
 Review comment:
   Can you add this to .travis.yml as well?

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                rhtyd commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437767351
 
 
   @blueorangutan package

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                blueorangutan commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437767408
 
 
   @rhtyd a Jenkins job has been kicked to build packages. I'll keep you posted as I make progress.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                rhtyd commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437768688
 
 
   Moved to 4.11.2.0 as it sounds like a critical business issue if resource counts are wrong.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                blueorangutan commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437774766
 
 
   Packaging result: ✔centos6 ✔centos7 ✖debian. JID-2425

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                rhtyd commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437777904
 
 
   @blueorangutan test

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                blueorangutan commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437778142
 
 
   @rhtyd a Trillian-Jenkins test job (centos7 mgmt + kvm-centos7) has been kicked to run smoke tests

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                rhtyd commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437804208
 
 
   Nevermind, I needed to run test quickly - have implemented minor fixes.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                borisstoyanov commented on a change in pull request #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#discussion_r232662467
 
 

 ##########
 File path: test/integration/smoke/test_resource_accounting.py
 ##########
 @@ -0,0 +1,243 @@
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#   http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing,
+# software distributed under the License is distributed on an
+# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+# KIND, either express or implied.  See the License for the
+# specific language governing permissions and limitations
+# under the License.
+
+from nose.plugins.attrib import attr
+
+# Import Local Modules
+from marvin.cloudstackTestCase import cloudstackTestCase
+from marvin.lib.base import (Domain,
+                             Account,
+                             ServiceOffering,
+                             VirtualMachine, updateResourceCount)
+from marvin.lib.common import (get_zone,
+                               get_test_template)
+from marvin.lib.utils import (cleanup_resources)
+
+
+class Services:
+    """Test Account Services
+    """
+
+    def __init__(self):
+        self.services = {
+            "domain": {
+                "name": "Domain",
+            },
+            "account": {
+                "email": "test@test.com",
+                "firstname": "Test",
+                "lastname": "User",
+                "username": "test",
+                # Random characters are appended for unique
+                # username
+                "password": "fr3sca",
+            },
+            "user": {
+                "email": "user@test.com",
+                "firstname": "User",
+                "lastname": "User",
+                "username": "User",
+                # Random characters are appended for unique
+                # username
+                "password": "fr3sca",
+            },
+            "service_offering_it_1": {
+                "name": "InstanceType-1",
+                "displaytext": "Tiny Instance",
+                "cpunumber": 1,
+                "cpuspeed": 100,
+                "memory": 128,
+            },
+            "service_offering_it_2": {
+                "name": "InstanceType-2",
+                "displaytext": "Tiny Instance",
+                "cpunumber": 4,
+                "cpuspeed": 100,
+                "memory": 512,
+            },
+            "virtual_machine_1": {
+                "displayname": "Test VM1",
+                "username": "root",
+                "password": "password",
+                "ssh_port": 22,
+                "hypervisor": 'XenServer',
+                "privateport": 22,
+                "publicport": 22,
+                "protocol": 'TCP',
+            },
+            "virtual_machine_2": {
+                "displayname": "Test VM2",
+                "username": "root",
+                "password": "password",
+                "ssh_port": 22,
+                "hypervisor": 'XenServer',
+                "privateport": 22,
+                "publicport": 22,
+                "protocol": 'TCP',
+            },
+            "template": {
+                "displaytext": "Public Template",
+                "name": "Public template",
+                "ostype": 'CentOS 5.6 (64-bit)',
+                "url": "",
+                "hypervisor": '',
+                "format": '',
+                "isfeatured": True,
+                "ispublic": True,
+                "isextractable": True,
+                "templatefilter": "self"
+            },
+            "natrule": {
+                "publicport": 22,
+                "privateport": 22,
+                "protocol": 'TCP',
+            },
+            "ostype": 'CentOS 5.6 (64-bit)',
+            "sleep": 60,
+            "timeout": 10,
+        }
+
+
+class TestRAMCPUResourceAccounting(cloudstackTestCase):
+
+    @classmethod
+    def setUpClass(cls):
+        cls.testClient = super(
+            TestRAMCPUResourceAccounting,
+            cls).getClsTestClient()
+        cls.api_client = cls.testClient.getApiClient()
+
+        cls.services = Services().services
+        cls.zone = get_zone(cls.api_client, cls.testClient.getZoneForTests())
+        cls.services['mode'] = cls.zone.networktype
+        cls.hypervisor = cls.testClient.getHypervisorInfo()
+        # Create an account, domain etc
+        cls.domain = Domain.create(
+            cls.api_client,
+            cls.services["domain"],
+        )
+        cls.account = Account.create(
+            cls.api_client,
+            cls.services["account"],
+            admin=True,
+            domainid=cls.domain.id
+        )
+
+        cls.template = get_test_template(
+            cls.api_client,
+            cls.zone.id,
+            cls.hypervisor)
+
+        cls.services["virtual_machine_1"]["zoneid"] = cls.zone.id
+        cls.services["virtual_machine_1"]["template"] = cls.template.id
+
+        cls.services["virtual_machine_2"]["zoneid"] = cls.zone.id
+        cls.services["virtual_machine_2"]["template"] = cls.template.id
+
+        cls._cleanup = [
+            cls.account,
+            cls.domain
+        ]
+
+    @classmethod
+    def tearDownClass(cls):
+        try:
+            # Cleanup resources used
+            cleanup_resources(cls.api_client, cls._cleanup)
+        except Exception as e:
+            raise Exception("Warning: Exception during cleanup : %s" % e)
+
+    def setUp(self):
+        self.apiclient = self.testClient.getApiClient()
+        self.dbclient = self.testClient.getDbConnection()
+        self.cleanup = []
+
+    def tearDown(self):
+        try:
+            # Clean up, terminate the created accounts
+            cleanup_resources(self.apiclient, self.cleanup)
+        except Exception as e:
+            raise Exception("Warning: Exception during cleanup : %s" % e)
+
+    def get_resource_amount(self, resource_type):
+        cmd = updateResourceCount.updateResourceCountCmd()
+        cmd.account = self.account.name
+        cmd.domainid = self.domain.id
+        cmd.resourcetype = resource_type
+        response = self.apiclient.updateResourceCount(cmd)
+        amount = response[0].resourcecount
+        return amount
+
+    @attr(tags=["advanced", "basic"], required_hardware="false")
+    def test_01_so_removal_resource_update(self):
+
+        self.service_offering_it_1 = ServiceOffering.create(
+            self.api_client,
+            self.services["service_offering_it_1"],
+            domainid=self.domain.id
+        )
+
+        self.cleanup.append(self.service_offering_it_1)
+
+        self.service_offering_it_2 = ServiceOffering.create(
+            self.api_client,
+            self.services["service_offering_it_2"],
+            domainid=self.domain.id
+        )
+
+        self.cleanup.append(self.service_offering_it_2)
+
+        vm_1 = VirtualMachine.create(
+            self.apiclient,
+            self.services["virtual_machine_1"],
+            accountid=self.account.name,
+            domainid=self.account.domainid,
+            serviceofferingid=self.service_offering_it_1.id
+        )
+
+        self.debug("Deployed VM in account: %s, ID: %s" % (self.account.name, vm_1.id))
+        self.cleanup.append(vm_1)
+
+        vm_2 = VirtualMachine.create(
+            self.apiclient,
+            self.services["virtual_machine_2"],
+            accountid=self.account.name,
+            domainid=self.account.domainid,
+            serviceofferingid=self.service_offering_it_2.id
+        )
+
+        self.debug("Deployed VM in account: %s, ID: %s" % (self.account.name, vm_2.id))
+        self.cleanup.append(vm_2)
+
+        CPU_RESOURCE_ID = 8
+        RAM_RESOURCE_ID = 9
+
+        cores = int(self.get_resource_amount(CPU_RESOURCE_ID))
+        ram = int(self.get_resource_amount(RAM_RESOURCE_ID))
+
+        self.assertEqual(cores, self.services['service_offering_it_1']['cpunumber'] + self.services['service_offering_it_2']['cpunumber'])
+        self.assertEqual(ram, self.services['service_offering_it_1']['memory'] + self.services['service_offering_it_2']['memory'])
+
+        self.service_offering_it_2.delete(self.apiclient)
+
+        self.cleanup = self.cleanup[0:-1]
+
+        cores = int(self.get_resource_amount(CPU_RESOURCE_ID))
+        ram = int(self.get_resource_amount(RAM_RESOURCE_ID))
+
+        self.assertEqual(cores, self.services['service_offering_it_1']['cpunumber'] + self.services['service_offering_it_2']['cpunumber'])
+        self.assertEqual(ram, self.services['service_offering_it_1']['memory'] + self.services['service_offering_it_2']['memory'])
 
 Review comment:
   Test LGMT, let's wait for the results 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                blueorangutan commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437895320
 
 
   &lt;b&gt;Trillian test result (tid-3164)&lt;/b&gt;
   Environment: kvm-centos7 (x2), Advanced Networking with Mgmt server 7
   Total time taken: 23884 seconds
   Marvin logs: https://github.com/blueorangutan/acs-prs/releases/download/trillian/pr3012-t3164-kvm-centos7.zip
   Intermittent failure detected: /marvin/tests/smoke/test_deploy_virtio_scsi_vm.py
   Intermittent failure detected: /marvin/tests/smoke/test_internal_lb.py
   Intermittent failure detected: /marvin/tests/smoke/test_resource_accounting.py
   Intermittent failure detected: /marvin/tests/smoke/test_vpc_vpn.py
   Intermittent failure detected: /marvin/tests/smoke/test_host_maintenance.py
   Smoke tests completed. 67 look OK, 1 have error(s)
   Only failed tests results shown below:
   
   
   Test | Result | Time (s) | Test File
   --- | --- | --- | ---
   test_01_so_removal_resource_update | `Error` | 26.67 | test_resource_accounting.py
   

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                bwsw commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437902499
 
 
   ```
   2018-11-12 10:24:59,254 INFO  [o.a.c.a.c.a.v.DeployVMCmdByAdmin] (API-Job-Executor-39:ctx-cda190fb job-1365 ctx-88aeda9f) (logid:7faecac3) Unable to create a deployment
    for VM[User|i-127-159-VM]
   com.cloud.exception.InsufficientServerCapacityException: Unable to create a deployment for VM[User|i-127-159-VM]Scope=interface com.cloud.dc.DataCenter; id=1
           at org.apache.cloudstack.engine.cloud.entity.api.VMEntityManagerImpl.reserveVirtualMachine(VMEntityManagerImpl.java:215)
           at org.apache.cloudstack.engine.cloud.entity.api.VirtualMachineEntityImpl.reserve(VirtualMachineEntityImpl.java:200)
           at com.cloud.vm.UserVmManagerImpl.startVirtualMachine(UserVmManagerImpl.java:4492)
           at com.cloud.vm.UserVmManagerImpl.startVirtualMachine(UserVmManagerImpl.java:4057)
           at com.cloud.vm.UserVmManagerImpl.startVirtualMachine(UserVmManagerImpl.java:4044)
           at sun.reflect.GeneratedMethodAccessor535.invoke(Unknown Source)
           at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
           at java.lang.reflect.Method.invoke(Method.java:498)
           at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:338)
           at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:197)
           at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)
           at org.apache.cloudstack.network.contrail.management.EventUtils$EventInterceptor.invoke(EventUtils.java:107)
           at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:174)
           at com.cloud.event.ActionEventInterceptor.invoke(ActionEventInterceptor.java:51)
           at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:174)
           at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:92)
           at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:185)
           at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:212)
           at com.sun.proxy.$Proxy164.startVirtualMachine(Unknown Source)
           at org.apache.cloudstack.api.command.admin.vm.DeployVMCmdByAdmin.execute(DeployVMCmdByAdmin.java:50)
           at com.cloud.api.ApiDispatcher.dispatch(ApiDispatcher.java:150)
           at com.cloud.api.ApiAsyncJobDispatcher.runJob(ApiAsyncJobDispatcher.java:108)
           at org.apache.cloudstack.framework.jobs.impl.AsyncJobManagerImpl$5.runInContext(AsyncJobManagerImpl.java:581)
           at org.apache.cloudstack.managed.context.ManagedContextRunnable$1.run(ManagedContextRunnable.java:49)
           at org.apache.cloudstack.managed.context.impl.DefaultManagedContext$1.call(DefaultManagedContext.java:56)
           at org.apache.cloudstack.managed.context.impl.DefaultManagedContext.callWithContext(DefaultManagedContext.java:103)
           at org.apache.cloudstack.managed.context.impl.DefaultManagedContext.runWithContext(DefaultManagedContext.java:53)
           at org.apache.cloudstack.managed.context.ManagedContextRunnable.run(ManagedContextRunnable.java:46)
           at org.apache.cloudstack.framework.jobs.impl.AsyncJobManagerImpl$5.run(AsyncJobManagerImpl.java:529)
           at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
           at java.util.concurrent.FutureTask.run(FutureTask.java:266)
           at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
           at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
           at java.lang.Thread.run(Thread.java:748)
   2018-11-12 10:24:59,255 DEBUG [o.a.c.f.j.i.AsyncJobManagerImpl] (API-Job-Executor-39:ctx-cda190fb job-1365) (logid:7faecac3) Complete async job-1365, jobStatus: FAILED, resultCode: 530, result: org.apache.cloudstack.api.response.ExceptionResponse/null/{"uuidList":[],"errorcode":533,"errortext":"Unable to create a deployment for VM[User|i-127-159-VM]"}
   ```
   Doesn't looks like connected with the test itself, rather an env problem.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                bwsw commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437902787
 
 
   @borisstoyanov I don't care, just wanted to have the SO different.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                borisstoyanov commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437903405
 
 
   @bwsw yes, you're right, issue is that blueorangutan's environment has hosts with 3 cores and we're requesting 4. Perhaps you could just change the offering to request 3? 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                bwsw edited a comment on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437902787
 
 
   @borisstoyanov I don't care, just wanted SO vary.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                bwsw commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437904492
 
 
   @borisstoyanov Done

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                bwsw edited a comment on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437902787
 
 
   @borisstoyanov I don't care, just wanted SOs to vary.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                rhtyd commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437939315
 
 
   @blueorangutan package 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                blueorangutan commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437939645
 
 
   @rhtyd a Jenkins job has been kicked to build packages. I'll keep you posted as I make progress.

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                blueorangutan commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437949714
 
 
   Packaging result: ✔centos6 ✔centos7 ✖debian. JID-2431

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                rhtyd commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437950448
 
 
   @blueorangutan package 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                rhtyd commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437950560
 
 
   @blueorangutan test 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                blueorangutan commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437950580
 
 
   @rhtyd a Trillian-Jenkins test job (centos7 mgmt + kvm-centos7) has been kicked to run smoke tests

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                rhtyd removed a comment on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-437950448
 
 
   @blueorangutan package 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                blueorangutan commented on issue #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012#issuecomment-438065912
 
 
   &lt;b&gt;Trillian test result (tid-3169)&lt;/b&gt;
   Environment: kvm-centos7 (x2), Advanced Networking with Mgmt server 7
   Total time taken: 22024 seconds
   Marvin logs: https://github.com/blueorangutan/acs-prs/releases/download/trillian/pr3012-t3169-kvm-centos7.zip
   Intermittent failure detected: /marvin/tests/smoke/test_outofbandmanagement.py
   Intermittent failure detected: /marvin/tests/smoke/test_vpc_vpn.py
   Smoke tests completed. 68 look OK, 0 have error(s)
   Only failed tests results shown below:
   
   
   Test | Result | Time (s) | Test File
   --- | --- | --- | ---
   

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                rhtyd closed pull request #3012: CLOUDSTACK-3009: Fixed resource calculation CPU, RAM for accounts.
URL: https://github.com/apache/cloudstack/pull/3012
 
 
   

This is a PR merged from a forked repository.
As GitHub hides the original diff on merge, it is displayed below for
the sake of provenance:

As this is a foreign pull request (from a fork), the diff is supplied
below (as it won't show otherwise due to GitHub magic):

diff --git a/.dockerignore b/.dockerignore
new file mode 100644
index 00000000000..6ca3ad4aa23
--- /dev/null
+++ b/.dockerignore
@@ -0,0 +1,22 @@
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#   http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing,
+# software distributed under the License is distributed on an
+# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+# KIND, either express or implied.  See the License for the
+# specific language governing permissions and limitations
+# under the License.
+
+cloudstack/tools/docker/Dockerfile
+.dockerignore
+.idea
+.git
+venv
diff --git a/.gitignore b/.gitignore
index 1a73724c117..2f5c5167e2d 100644
--- a/.gitignore
+++ b/.gitignore
@@ -99,3 +99,4 @@ plugins/hypervisors/kvm/.pydevproject
 scripts/.pydevproject
 *.qcow2
 *.raw
+venv
diff --git a/.travis.yml b/.travis.yml
index d5fd173d71e..43f2bb29035 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -78,6 +78,7 @@ env:
              smoke/test_pvlan
              smoke/test_regions
              smoke/test_reset_vm_on_reboot
+             smoke/test_resource_accounting
              smoke/test_resource_detail
              smoke/test_router_dhcphosts
              smoke/test_router_dns
diff --git a/engine/schema/src/com/cloud/configuration/dao/ResourceCountDaoImpl.java b/engine/schema/src/com/cloud/configuration/dao/ResourceCountDaoImpl.java
index 9cc8913f8fa..1de2b65aed1 100644
--- a/engine/schema/src/com/cloud/configuration/dao/ResourceCountDaoImpl.java
+++ b/engine/schema/src/com/cloud/configuration/dao/ResourceCountDaoImpl.java
@@ -258,7 +258,7 @@ public long removeEntriesByOwner(long ownerId, ResourceOwnerType ownerType) {
             + "        ELSE CONVERT(vmd.value, UNSIGNED INTEGER) "
             + "    END)) as total "
             + " from vm_instance vm "
-            + " join service_offering_view so on so.id = vm.service_offering_id "
+            + " join service_offering so on so.id = vm.service_offering_id "
             + " left join user_vm_details vmd on vmd.vm_id = vm.id and vmd.name = '%s' "
             + " where vm.type = 'User' and state not in ('Destroyed', 'Error', 'Expunging') and display_vm = true and account_id = ? ";
 
diff --git a/test/integration/component/test_browse_templates.py b/test/integration/component/test_browse_templates.py
index 80e9a135b80..4340092b9a0 100644
--- a/test/integration/component/test_browse_templates.py
+++ b/test/integration/component/test_browse_templates.py
@@ -230,7 +230,7 @@ def gettemplatelimts(self):
 
         return(totaltemplates)
 
-    def getstoragelimts(self,rtype):
+    def getstoragelimits(self, rtype):
 
         cmd=updateResourceCount.updateResourceCountCmd()
         cmd.account=self.account.name
@@ -1652,7 +1652,7 @@ def test_07_Browser_Upload_template_secondary_storage_resource_limits(self):
 
             self.debug("========================= Test 22 Upload template and verify secondary storage limits========================")
 
-            initialsecondarystoragelimit=self.getstoragelimts(11)
+            initialsecondarystoragelimit=self.getstoragelimits(11)
             browseup_template1=self.browse_upload_template()
 
             tmpldetails=Template.list(
@@ -1662,7 +1662,7 @@ def test_07_Browser_Upload_template_secondary_storage_resource_limits(self):
                                      zoneid=self.zone.id)
 
 
-            afteruploadsecondarystoragelimit=self.getstoragelimts(11)
+            afteruploadsecondarystoragelimit=self.getstoragelimits(11)
 
             if afteruploadsecondarystoragelimit!=(initialsecondarystoragelimit+tmpldetails[0].size):
                 self.fail("Secondary Storage Resouce Count is not updated")
@@ -1709,10 +1709,10 @@ def test_09_Browser_Upload_Volume_secondary_storage_resource_limits_after_deleti
                                      templatefilter="all",
                                      zoneid=self.zone.id)
 
-            initialuploadprimarystoragelimit=self.getstoragelimts(11)
+            initialuploadprimarystoragelimit=self.getstoragelimits(11)
             self.delete_template(browseup_template1)
 
-            afteruploadprimarystoragelimit=self.getstoragelimts(11)
+            afteruploadprimarystoragelimit=self.getstoragelimits(11)
 
             if afteruploadprimarystoragelimit!=(initialuploadprimarystoragelimit-tmpldetails[0].size):
                 self.fail("Secondary Storage Resource Count is not updated after deletion")
diff --git a/test/integration/smoke/test_resource_accounting.py b/test/integration/smoke/test_resource_accounting.py
new file mode 100644
index 00000000000..043a7af86df
--- /dev/null
+++ b/test/integration/smoke/test_resource_accounting.py
@@ -0,0 +1,243 @@
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#   http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing,
+# software distributed under the License is distributed on an
+# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+# KIND, either express or implied.  See the License for the
+# specific language governing permissions and limitations
+# under the License.
+
+from nose.plugins.attrib import attr
+
+# Import Local Modules
+from marvin.cloudstackTestCase import cloudstackTestCase
+from marvin.lib.base import (Domain,
+                             Account,
+                             ServiceOffering,
+                             VirtualMachine, updateResourceCount)
+from marvin.lib.common import (get_zone,
+                               get_test_template)
+from marvin.lib.utils import (cleanup_resources)
+
+
+class Services:
+    """Test Account Services
+    """
+
+    def __init__(self):
+        self.services = {
+            "domain": {
+                "name": "Domain",
+            },
+            "account": {
+                "email": "test@test.com",
+                "firstname": "Test",
+                "lastname": "User",
+                "username": "test",
+                # Random characters are appended for unique
+                # username
+                "password": "fr3sca",
+            },
+            "user": {
+                "email": "user@test.com",
+                "firstname": "User",
+                "lastname": "User",
+                "username": "User",
+                # Random characters are appended for unique
+                # username
+                "password": "fr3sca",
+            },
+            "service_offering_it_1": {
+                "name": "InstanceType-1",
+                "displaytext": "Tiny Instance",
+                "cpunumber": 1,
+                "cpuspeed": 100,
+                "memory": 128,
+            },
+            "service_offering_it_2": {
+                "name": "InstanceType-2",
+                "displaytext": "Tiny Instance",
+                "cpunumber": 2,
+                "cpuspeed": 100,
+                "memory": 512,
+            },
+            "virtual_machine_1": {
+                "displayname": "Test VM1",
+                "username": "root",
+                "password": "password",
+                "ssh_port": 22,
+                "hypervisor": 'XenServer',
+                "privateport": 22,
+                "publicport": 22,
+                "protocol": 'TCP',
+            },
+            "virtual_machine_2": {
+                "displayname": "Test VM2",
+                "username": "root",
+                "password": "password",
+                "ssh_port": 22,
+                "hypervisor": 'XenServer',
+                "privateport": 22,
+                "publicport": 22,
+                "protocol": 'TCP',
+            },
+            "template": {
+                "displaytext": "Public Template",
+                "name": "Public template",
+                "ostype": 'CentOS 5.6 (64-bit)',
+                "url": "",
+                "hypervisor": '',
+                "format": '',
+                "isfeatured": True,
+                "ispublic": True,
+                "isextractable": True,
+                "templatefilter": "self"
+            },
+            "natrule": {
+                "publicport": 22,
+                "privateport": 22,
+                "protocol": 'TCP',
+            },
+            "ostype": 'CentOS 5.6 (64-bit)',
+            "sleep": 60,
+            "timeout": 10,
+        }
+
+
+class TestRAMCPUResourceAccounting(cloudstackTestCase):
+
+    @classmethod
+    def setUpClass(cls):
+        cls.testClient = super(
+            TestRAMCPUResourceAccounting,
+            cls).getClsTestClient()
+        cls.api_client = cls.testClient.getApiClient()
+
+        cls.services = Services().services
+        cls.zone = get_zone(cls.api_client, cls.testClient.getZoneForTests())
+        cls.services['mode'] = cls.zone.networktype
+        cls.hypervisor = cls.testClient.getHypervisorInfo()
+        # Create an account, domain etc
+        cls.domain = Domain.create(
+            cls.api_client,
+            cls.services["domain"],
+        )
+        cls.account = Account.create(
+            cls.api_client,
+            cls.services["account"],
+            admin=True,
+            domainid=cls.domain.id
+        )
+
+        cls.template = get_test_template(
+            cls.api_client,
+            cls.zone.id,
+            cls.hypervisor)
+
+        cls.services["virtual_machine_1"]["zoneid"] = cls.zone.id
+        cls.services["virtual_machine_1"]["template"] = cls.template.id
+
+        cls.services["virtual_machine_2"]["zoneid"] = cls.zone.id
+        cls.services["virtual_machine_2"]["template"] = cls.template.id
+
+        cls._cleanup = [
+            cls.account,
+            cls.domain
+        ]
+
+    @classmethod
+    def tearDownClass(cls):
+        try:
+            # Cleanup resources used
+            cleanup_resources(cls.api_client, cls._cleanup)
+        except Exception as e:
+            raise Exception("Warning: Exception during cleanup : %s" % e)
+
+    def setUp(self):
+        self.apiclient = self.testClient.getApiClient()
+        self.dbclient = self.testClient.getDbConnection()
+        self.cleanup = []
+
+    def tearDown(self):
+        try:
+            # Clean up, terminate the created accounts
+            cleanup_resources(self.apiclient, self.cleanup)
+        except Exception as e:
+            raise Exception("Warning: Exception during cleanup : %s" % e)
+
+    def get_resource_amount(self, resource_type):
+        cmd = updateResourceCount.updateResourceCountCmd()
+        cmd.account = self.account.name
+        cmd.domainid = self.domain.id
+        cmd.resourcetype = resource_type
+        response = self.apiclient.updateResourceCount(cmd)
+        amount = response[0].resourcecount
+        return amount
+
+    @attr(tags=["advanced", "basic"], required_hardware="false")
+    def test_01_so_removal_resource_update(self):
+
+        self.service_offering_it_1 = ServiceOffering.create(
+            self.api_client,
+            self.services["service_offering_it_1"],
+            domainid=self.domain.id
+        )
+
+        self.cleanup.append(self.service_offering_it_1)
+
+        self.service_offering_it_2 = ServiceOffering.create(
+            self.api_client,
+            self.services["service_offering_it_2"],
+            domainid=self.domain.id
+        )
+
+        self.cleanup.append(self.service_offering_it_2)
+
+        vm_1 = VirtualMachine.create(
+            self.apiclient,
+            self.services["virtual_machine_1"],
+            accountid=self.account.name,
+            domainid=self.account.domainid,
+            serviceofferingid=self.service_offering_it_1.id
+        )
+
+        self.debug("Deployed VM in account: %s, ID: %s" % (self.account.name, vm_1.id))
+        self.cleanup.append(vm_1)
+
+        vm_2 = VirtualMachine.create(
+            self.apiclient,
+            self.services["virtual_machine_2"],
+            accountid=self.account.name,
+            domainid=self.account.domainid,
+            serviceofferingid=self.service_offering_it_2.id
+        )
+
+        self.debug("Deployed VM in account: %s, ID: %s" % (self.account.name, vm_2.id))
+        self.cleanup.append(vm_2)
+
+        CPU_RESOURCE_ID = 8
+        RAM_RESOURCE_ID = 9
+
+        cores = int(self.get_resource_amount(CPU_RESOURCE_ID))
+        ram = int(self.get_resource_amount(RAM_RESOURCE_ID))
+
+        self.assertEqual(cores, self.services['service_offering_it_1']['cpunumber'] + self.services['service_offering_it_2']['cpunumber'])
+        self.assertEqual(ram, self.services['service_offering_it_1']['memory'] + self.services['service_offering_it_2']['memory'])
+
+        self.service_offering_it_2.delete(self.apiclient)
+
+        self.cleanup = self.cleanup[0:-1]
+
+        cores = int(self.get_resource_amount(CPU_RESOURCE_ID))
+        ram = int(self.get_resource_amount(RAM_RESOURCE_ID))
+
+        self.assertEqual(cores, self.services['service_offering_it_1']['cpunumber'] + self.services['service_offering_it_2']['cpunumber'])
+        self.assertEqual(ram, self.services['service_offering_it_1']['memory'] + self.services['service_offering_it_2']['memory'])


 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                Commit f6e600e4d8134dd317ec8444ccf259285932dd50 in cloudstack's branch refs/heads/4.11 from Bitworks LLC
[ https://gitbox.apache.org/repos/asf?p=cloudstack.git;h=f6e600e ]

CLOUDSTACK-3009: Fix resource calculation CPU, RAM for accounts. (#3012)

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:

4.12
4.11
Fixes: #3009
              </div></li><li><div>
                Commit f6e600e4d8134dd317ec8444ccf259285932dd50 in cloudstack's branch refs/heads/master from Bitworks LLC
[ https://gitbox.apache.org/repos/asf?p=cloudstack.git;h=f6e600e ]

CLOUDSTACK-3009: Fix resource calculation CPU, RAM for accounts. (#3012)

The view "service_offering_view" doesn't include removed SOs, as a result when SO is removed, the bug happens. The PR introduces a change for resource calculation changing "service_offering_view" to "service_offering" table which has all service offerings.

Must be fixed in:

4.12
4.11
Fixes: #3009
              </div></li></ol></div></div></html>