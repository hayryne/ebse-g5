<!DOCTYPE html><html><div class="item-title">
        Item 49
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 include dependencies required by filesystems 
              </div></li><li><div>
                 Runner which will be used for running the tests. Possible values: dataflow/direct.
 PerfKitBenchmarker will have trouble reading 'null' value. It expects empty string if no config file is expected.
              </div></li><li><div>
                 When applied in a module's build.gradle file, this closure adds task providing
 additional dependencies that might be needed while running integration tests.
              </div></li><li><div>
                if (runner?.contains('dataflow')) {
              </div></li><li><div>
                 Always required properties: 
              </div></li><li><div>
                 Add runners needed to run integration tests on
              </div></li><li><div>
                 Use the implicit it parameter of the closure to handle zero argument or one argument map calls.
 See: http://groovy-lang.org/closures.html#implicit-it
              </div></li><li><div>
                 Task for running integration tests
              </div></li><li><div><div><b>comment:</b>  Reads and contains all necessary performance test parameters
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 When applied in a module's build.gradle file, this closure provides task for running
 IO integration tests (manually, without PerfKitBenchmarker).
              </div></li><li><div>
                 include dependencies required by runners 
              </div></li><li><div>
                 Optional properties (set only if needed in your case): 
              </div></li><li><div>
                 Filesystem which will be used for running the tests. Possible values: hdfs.
 if not specified runner's local filesystem will be used.
              </div></li><li><div>
                 Pipeline options to be used by the tested pipeline.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [BEAM-3942] Add Tasks for running IOITs manually using gradle 
                </div><div><b>message:</b> [BEAM-3942] Add Tasks for running IOITs manually using gradle 

This commit adds two gradle tasks:
 - "integrationTest": for running integration tests using gradle
 - "packageIntegrationTests": for supplying the build with necessary test 
dependencies

The tasks are wrapped in closures that were be included in every module that 
needs IT to be run. 

The direct runner dependency was deledet from file-based-io-tests because:
- it causes error: "Could not get unknown property 'sourceSets' for project
	':beam-runners-direct-java' of type org.gradle.api.Project."
- it is redundant in file-based-io-tests because we add this dependency in
	"packageIntegrationTests" task and no other test types use it.
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div></div></li><li><div><div><b>summary:</b> Update performance testing framework to use Gradle.
                </div><div><b>description:</b> This requires performing updates to PerfKitBenchmarker and Beam so that we can execute performance tests using Gradle.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Assigning to&nbsp;≈Åukasz who has a PoC for this.
              </div></li><li><div>
                Thanks!

FYI: Despite introducing necessary changes in beam's&nbsp;gradle scripts we&nbsp;will need a person from PerfkitBenchmarker project to merge changes in perfkit too. Currently perfkit uses maven to build and run IOITs, so this must be changed too.&nbsp;I'll submit all necessary PRs bot to beam and perfkit.&nbsp;
              </div></li><li><div>
                Can you provide more details as to why an external project needs to change?

It seems like we just invoke perfkitbenchmarker with maven-exec (treating it like an executable) for example here: https://github.com/apache/beam/blob/b6e95a0dc3f78b4961003d44cbb43456faef60c1/sdks/java/io/file-based-io-tests/pom.xml#L101
              </div></li><li><div>
                Sure, sorry for being so laconic.&nbsp;&nbsp;

This command runs perfkit with&nbsp;all the command line arguments it needs. After that perfkit downloads beam repository, performs the "setup" phase (kubernetes and so on) and then,&nbsp;using the above mentioned arguments it, constructs&nbsp;*maven*&nbsp;commands to build beam and run the tests. Build is optional but still possible - "beamPrebuilt" flag turns it on/off.

If we want to leave this flow as is, we need to modify this perfkit class to&nbsp;construct gradle commands instead of maven ones: [https://github.com/GoogleCloudPlatform/PerfKitBenchmarker/blob/master/perfkitbenchmarker/beam_benchmark_helper.py]Please notice that the code you mentioned is only for&nbsp;running ITs manually. Jenkins jobs run Perfkit directly:&nbsp;[https://github.com/apache/beam/blob/397688a62b1f9f0f9840a43ed4ad1a59ba77b981/.test-infra/jenkins/common_job_properties.groovy#L311]&nbsp;

As for modifying perfkit - I see&nbsp;three ways of doing this:&nbsp;
 1. Fully drop maven and use gradle instead at once.&nbsp;
 2.&nbsp;Add logic to perfkit to support both maven and gradle for some time. This&nbsp;is in case of obstacles preventing us from migrating to gradle in one day but will take more time and energy.&nbsp;

3. Migrate perfkit after the 3rd. This would require&nbsp;not deleting&nbsp;maven poms for a few days after fixit day (to be able to use them until perfkit migrates to gradle).&nbsp;

Also, please note that for both ways, Perfkit needs to "know" what gradle command to construct to run the tests. This is why I planned to start with submitting PR&nbsp;to beam and then modify perfkit accordingly.

WDYT of all this?
              </div></li><li><div>
                Also, my&nbsp;experience with perfikt is that, their community is responsive. But this obviously doesn't&nbsp;solve&nbsp;the fact that the effort probably needs to be coordinated between&nbsp;beam and perfkit project maintainers if we want to migrate in one day (imo).&nbsp;
              </div></li><li><div>
                CC:&nbsp;[~reuvenlax]
              </div></li><li><div>
                I think it makes sense for a few people to work together to target some of these bigger migrations like perfkit and would prefer to target option 1 that you suggest. I think co-ordination with GoogleCloudPlatform (owners of PerfkitBenchmarker) should be reasonable to do within a single day effort.

I'll reach out to them now about our intended fixit day.
              </div></li><li><div>
                added a blocker:&nbsp;BEAM-3964

FYI #2 (just to track things more easily):&nbsp;currently we are not able to run any IOITs successfully due to this issue. I already reached [~tgroh] and we agreed that the issue will be fixed or reverted until tuesday, but for now it's a blocker.
              </div></li><li><div>
                Reached out to PerfkitBenchmarker folks here: https://github.com/GoogleCloudPlatform/PerfKitBenchmarker/issues/1617
              </div></li><li><div>
                [asaksena|https://github.com/asaksena] has volunteered to help review stuff during our fixit promptly PerfkitBenchmarker.
              </div></li><li><div>
                Thanks! I'll be reaching him on tuesday.&nbsp;
              </div></li><li><div>
                How is this going? Is this task a blocker for the Gradle migration?
              </div></li><li><div>
                I think it is. The PR is currently being reveiwed. After it is&nbsp;merged another PR must be done to PerfKitBenchmarker (as descirbed above) to be able to drop maven (perfkit uses beam's mvn commands).&nbsp;
              </div></li><li><div>
                I've added a sub-task for updating website documentation. [~≈ÅukaszG] would you mind filling in the new gradle commands?
              </div></li><li><div>
                Sure, I'll gladly do that. :)
              </div></li><li><div>
                fyi: migrating to gradle on "the PerfKitBenchmarker side" is happening here:&nbsp;https://github.com/GoogleCloudPlatform/PerfKitBenchmarker/pull/1648
              </div></li></ol></div></div></html>