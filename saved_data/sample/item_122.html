<!DOCTYPE html><html><div class="item-title">
        Item 122
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
     * Whether to send an message if the web-socket listener received an error.
     
              </div></li><li><div>
                 ensure we are connected
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> CAMEL-9566: Improved camel-ahc-ws to better re-connect in case of ws failures.
                </div><div><b>message:</b> CAMEL-9566: Improved camel-ahc-ws to better re-connect in case of ws failures.

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> camel-asf-ws component does not reconnect to the web socket 
                </div><div><b>description:</b> Create a web socket consumer route 
Ensure that the web socket provider is available
Create connection to the web socket provider from the consumer
Send a message from the provider (send to all)
Message gets consumed in the consumer route
Bring down the producer
Bring up the producer 
Create connection to the web socket provider from the consumer
Send a message from the provider (send to all)
Message is not printed as reconnect was not done


                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Can you build a sample project that can reproduce this?
              </div></li><li><div>
                Are you sure its camel-ahc-ws and not camel-websocket ?
              </div></li><li><div>
                I'm having the same issue.

Take a look at the WsListener class.  The onClose() and onError() methods only log the issue and never raise the exception to the camel route.  https://github.com/apache/camel/blob/master/components/camel-ahc-ws/src/main/java/org/apache/camel/component/ahc/ws/WsEndpoint.java

              </div></li><li><div>
                I pushed some code changes to master branch. Feel free to build and give that a test.
              </div></li><li><div>
                Thank you Claus.  In order to test I did have to clone the 2.16.x branch and migrate your changes to 2.16.3-SNAPSHOT since all my other dependencies required 2.16.  However, this did not resolve the issue.  There simply is no detection of the lost socket connection.  When I shutdown the websocket server (i.e another camel endpoint using the camel-websocket component) I don't think the onClose() method is ever invoked.

Perhaps we could add a condition in the WsProducer for sendMessage() to check the connection state and throw an Exception if the connection is closed.

Question:  Is there a way to enable debugging for a single bundle in Karaf? 
              </div></li><li><div><div><b>body:</b> Ah okay, what exception does the producer throw? Maybe we can detect a ConnectionException or somerhing and then use that to force a re-connection?

In karaf you can set log levels from the karaf shell

something like:
log:level set org.apache.camel.xxx INFO

There should be some --help on the log command
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                As of right now there is no exception thrown by the WsProducer when the connection is closed.  Right now I'm testing adding a condition in the process() method of WsProducer to check getWebsocket().isOpen and throw ConnectionException.  However, I'm unsure how to trigger the reconnect...

Thanks for the debug info.
              </div></li><li><div>
                Ah I figured how to trigger reconnect...

this.getEndpoint().reConnect();

Testing it now.
              </div></li><li><div>
                Actually my test was invalid.  For some reason when I copied the camel-ahc-ws component into the deploy folder it didn't install.  Although the log said it did.  When I do a feature:list it still shows 2.16 instead of 2.16.3-SNAPSHOT.  I tried uninstalling the 2.16 version but that didn't work.  What's the preferred way to install a particular dependency?
              </div></li><li><div>
                Claus - I was able to successfully test your changes and they worked perfectly without any of my modifications.  The changes you've committed to 2.17, could they be released under rev 2.16.3 of Camel? 

If not, do you have a suggested method of using a different component version?  Currently I'm deploying to Karaf 3 using Camel 2.16.  Thank you!
              </div></li><li><div>
                Thanks for testing. I backported to 2.16.x
              </div></li><li><div>
                Claus - The change didn't got into last night's 2.16.3-SNAPSHOT build.  I see that the maven metadata xml files where updated but not the JAR.  Is there a process that I should know about for changes to the repo to go into the build?
https://repository.apache.org/content/groups/snapshots/org/apache/camel/camel-ahc/2.16.3-SNAPSHOT/

Thanks again
              </div></li><li><div>
                Build from source manually as those mvn servers are not reliable building
              </div></li></ol></div></div></html>