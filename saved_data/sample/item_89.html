<!DOCTYPE html><html><div class="item-title">
        Item 89
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 No need to check for null unixUser as in case of failure we will not reach here.
              </div></li><li><div>
                *
 * Implement {@link org.apache.drill.exec.rpc.user.security.UserAuthenticator} based on Pluggable Authentication
 * Module (PAM) configuration. Configure the PAM profiles using "drill.exec.security.user.auth.pam_profiles" BOOT
 * option. Ex. value  &lt;i&gt;[ "login", "sudo" ]&lt;/i&gt; (value is an array of strings).
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                 No-op as no resources are occupied by PAM authenticator.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>message:</b> DRILL-5820: Add support for libpam4j Pam Authenticator

closes #962

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> DRILL-5820: Add support for libpam4j Pam Authenticator
                </div><div><b>body:</b> 
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                @parthchandra - Please help to review
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div><div><b>body:</b> As discussed in person, perhaps explain how the `impl` property here related to the implementation class. (Evidently via an annotation. So, maybe just name the annotation used.)
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                `final`?
              </div></li><li><div>
                `equals` or `equalsIgnoreCase`? That is, should "Fred" match "fred"?
              </div></li><li><div>
                Can omit this if statement, `logger.trace()` will do teh right thing.
              </div></li><li><div>
                The module above throws an exception. Here we get a `boolean`. Does this mean that the exception was mapped to `false`, then mapped back to an exception?
              </div></li><li><div>
                No the exceptions thrown here is directly mapped to Sasl Exception and sent back to client with AUTH_FAILED status.
              </div></li><li><div><div><b>body:</b> Updated the comment here to reflect the Annotation name `UserAuthenticatorTemplate`
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                cannot be final since it is initialized in `setup(..)` method
              </div></li><li><div>
                Removed.
              </div></li><li><div><div><b>body:</b> Some *Nix systems supports case sensitive usernames and some doesn't. Like Mac is case insensitive while linux is case sensitive. So I think username should be then treated as case sensitive. I will remove this check since looks like it's redundant and the pam module authenticate should take care of this.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Add support for libpam4j Pam Authenticator
                </div><div><b>description:</b> Drill uses JPAM as the PAM authenticator module for username/password verification for PLAIN mechanism. There are some known issues with JPAM which leads to JVM crash and memory leaks. JPAM also requires a manual step in copying the native library. 

Also based on the [HIVE-16529|https://issues.apache.org/jira/browse/HIVE-16529] there have been mention of these issues with JPAM which is resolved in the libpam4j. Also libpam4j avoids the need to install native library explicitly. It would be good to provide support for libpam4j in Drill to avoid these issues.

Some other reported problems with JPAM:
* https://wiki.dlib.indiana.edu/display/V3/Pam+Authentication+through+JPam
* https://bugzilla.redhat.com/show_bug.cgi?id=860119#c12
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                GitHub user sohami opened a pull request:

    https://github.com/apache/drill/pull/962

    DRILL-5820: Add support for libpam4j Pam Authenticator

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/sohami/drill DRILL-5820

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/drill/pull/962.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #962
    
----
commit 6efa28f63e56e7996d76cba19c577fadca3d9d1f
Author: Sorabh Hamirwasia &lt;shamirwasia@maprtech.com&gt;
Date:   2017-09-21T00:38:08Z

    DRILL-5820: Add support for libpam4j Pam Authenticator

----

              </div></li><li><div>
                Github user sohami commented on the issue:

    https://github.com/apache/drill/pull/962
  
    @parthchandra - Please help to review

              </div></li><li><div>
                Github user paul-rogers commented on a diff in the pull request:

    https://github.com/apache/drill/pull/962#discussion_r141197203
  
    --- Diff: exec/java-exec/src/main/java/org/apache/drill/exec/rpc/user/security/Pam4jUserAuthenticator.java ---
    @@ -0,0 +1,81 @@
    +/*
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *    http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +package org.apache.drill.exec.rpc.user.security;
    +
    +import org.apache.drill.common.config.DrillConfig;
    +import org.apache.drill.exec.ExecConstants;
    +import org.apache.drill.exec.exception.DrillbitStartupException;
    +import org.jvnet.libpam.PAM;
    +import org.jvnet.libpam.PAMException;
    +import org.jvnet.libpam.UnixUser;
    +
    +import java.io.IOException;
    +import java.util.List;
    +
    +/**
    + * Implement {@link org.apache.drill.exec.rpc.user.security.UserAuthenticator} based on Pluggable Authentication
    + * Module (PAM) configuration. Configure the PAM profiles using "drill.exec.security.user.auth.pam_profiles" BOOT
    + * option. Ex. value  &lt;i&gt;[ "login", "sudo" ]&lt;/i&gt; (value is an array of strings).
    + */
    +@UserAuthenticatorTemplate(type = "pam4j")
    +public class Pam4jUserAuthenticator implements UserAuthenticator {
    +  private static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(Pam4jUserAuthenticator.class);
    +
    +  private List&lt;String&gt; profiles;
    --- End diff --
    
    `final`?

              </div></li><li><div>
                Github user paul-rogers commented on a diff in the pull request:

    https://github.com/apache/drill/pull/962#discussion_r141198653
  
    --- Diff: exec/java-exec/src/main/java/org/apache/drill/exec/rpc/user/security/Pam4jUserAuthenticator.java ---
    @@ -0,0 +1,81 @@
    +/*
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *    http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +package org.apache.drill.exec.rpc.user.security;
    +
    +import org.apache.drill.common.config.DrillConfig;
    +import org.apache.drill.exec.ExecConstants;
    +import org.apache.drill.exec.exception.DrillbitStartupException;
    +import org.jvnet.libpam.PAM;
    +import org.jvnet.libpam.PAMException;
    +import org.jvnet.libpam.UnixUser;
    +
    +import java.io.IOException;
    +import java.util.List;
    +
    +/**
    + * Implement {@link org.apache.drill.exec.rpc.user.security.UserAuthenticator} based on Pluggable Authentication
    + * Module (PAM) configuration. Configure the PAM profiles using "drill.exec.security.user.auth.pam_profiles" BOOT
    + * option. Ex. value  &lt;i&gt;[ "login", "sudo" ]&lt;/i&gt; (value is an array of strings).
    + */
    +@UserAuthenticatorTemplate(type = "pam4j")
    +public class Pam4jUserAuthenticator implements UserAuthenticator {
    +  private static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(Pam4jUserAuthenticator.class);
    +
    +  private List&lt;String&gt; profiles;
    +
    +  @Override
    +  public void setup(DrillConfig drillConfig) throws DrillbitStartupException {
    +    profiles = drillConfig.getStringList(ExecConstants.PAM_AUTHENTICATOR_PROFILES);
    +  }
    +
    +  @Override
    +  public void authenticate(String user, String password) throws UserAuthenticationException {
    +    for (String profile : profiles) {
    +      PAM pam = null;
    +      UnixUser unixUser;
    +      try {
    +        pam = new PAM(profile);
    +        unixUser = pam.authenticate(user, password);
    +      } catch (PAMException ex) {
    +        logger.error("PAM auth failed for user: {} against {} profile. Exception: {}", user, profile, ex.getMessage());
    +        throw new UserAuthenticationException(String.format("PAM auth failed for user: %s using profile: %s",
    +            user, profile));
    +      } finally {
    +        if (pam != null) {
    +          pam.dispose();
    +        }
    +      }
    +
    +      if (!user.equals(unixUser.getUserName())) {
    --- End diff --
    
    `equals` or `equalsIgnoreCase`? That is, should "Fred" match "fred"?

              </div></li><li><div>
                Github user paul-rogers commented on a diff in the pull request:

    https://github.com/apache/drill/pull/962#discussion_r141199041
  
    --- Diff: exec/java-exec/src/main/java/org/apache/drill/exec/rpc/user/security/PamUserAuthenticator.java ---
    @@ -59,7 +59,8 @@ public void authenticate(String user, String password) throws UserAuthentication
         for (String pamProfile : profiles) {
           Pam pam = new Pam(pamProfile);
           if (!pam.authenticateSuccessful(user, password)) {
    -        throw new UserAuthenticationException(String.format("PAM profile '%s' validation failed", pamProfile));
    +        throw new UserAuthenticationException(String.format("PAM profile '%s' validation failed for user %s",
    --- End diff --
    
    The module above throws an exception. Here we get a `boolean`. Does this mean that the exception was mapped to `false`, then mapped back to an exception?

              </div></li><li><div>
                Github user paul-rogers commented on a diff in the pull request:

    https://github.com/apache/drill/pull/962#discussion_r141198807
  
    --- Diff: exec/java-exec/src/main/java/org/apache/drill/exec/rpc/user/security/Pam4jUserAuthenticator.java ---
    @@ -0,0 +1,81 @@
    +/*
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *    http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +package org.apache.drill.exec.rpc.user.security;
    +
    +import org.apache.drill.common.config.DrillConfig;
    +import org.apache.drill.exec.ExecConstants;
    +import org.apache.drill.exec.exception.DrillbitStartupException;
    +import org.jvnet.libpam.PAM;
    +import org.jvnet.libpam.PAMException;
    +import org.jvnet.libpam.UnixUser;
    +
    +import java.io.IOException;
    +import java.util.List;
    +
    +/**
    + * Implement {@link org.apache.drill.exec.rpc.user.security.UserAuthenticator} based on Pluggable Authentication
    + * Module (PAM) configuration. Configure the PAM profiles using "drill.exec.security.user.auth.pam_profiles" BOOT
    + * option. Ex. value  &lt;i&gt;[ "login", "sudo" ]&lt;/i&gt; (value is an array of strings).
    + */
    +@UserAuthenticatorTemplate(type = "pam4j")
    +public class Pam4jUserAuthenticator implements UserAuthenticator {
    +  private static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(Pam4jUserAuthenticator.class);
    +
    +  private List&lt;String&gt; profiles;
    +
    +  @Override
    +  public void setup(DrillConfig drillConfig) throws DrillbitStartupException {
    +    profiles = drillConfig.getStringList(ExecConstants.PAM_AUTHENTICATOR_PROFILES);
    +  }
    +
    +  @Override
    +  public void authenticate(String user, String password) throws UserAuthenticationException {
    +    for (String profile : profiles) {
    +      PAM pam = null;
    +      UnixUser unixUser;
    +      try {
    +        pam = new PAM(profile);
    +        unixUser = pam.authenticate(user, password);
    +      } catch (PAMException ex) {
    +        logger.error("PAM auth failed for user: {} against {} profile. Exception: {}", user, profile, ex.getMessage());
    +        throw new UserAuthenticationException(String.format("PAM auth failed for user: %s using profile: %s",
    +            user, profile));
    +      } finally {
    +        if (pam != null) {
    +          pam.dispose();
    +        }
    +      }
    +
    +      if (!user.equals(unixUser.getUserName())) {
    +        throw new UserAuthenticationException(String.format("Unexpected error from pam module. Input user %s is " +
    +            "different from authenticated output user %s of pam module libpam4j", user, unixUser.getUserName()));
    +      }
    +
    +      if (logger.isTraceEnabled()) {
    --- End diff --
    
    Can omit this if statement, `logger.trace()` will do teh right thing.

              </div></li><li><div>
                Github user paul-rogers commented on a diff in the pull request:

    https://github.com/apache/drill/pull/962#discussion_r141196893
  
    --- Diff: distribution/src/resources/drill-override-example.conf ---
    @@ -133,6 +133,8 @@ drill.exec: {
       security.user.auth {
         enabled: false,
         packages += "org.apache.drill.exec.rpc.user.security",
    +    # There are 2 implementations available "pam" using JPAM
    +    # and "pam4j" using libpam4j
    --- End diff --
    
    As discussed in person, perhaps explain how the `impl` property here related to the implementation class. (Evidently via an annotation. So, maybe just name the annotation used.)

              </div></li><li><div>
                Github user sohami commented on a diff in the pull request:

    https://github.com/apache/drill/pull/962#discussion_r141405678
  
    --- Diff: exec/java-exec/src/main/java/org/apache/drill/exec/rpc/user/security/PamUserAuthenticator.java ---
    @@ -59,7 +59,8 @@ public void authenticate(String user, String password) throws UserAuthentication
         for (String pamProfile : profiles) {
           Pam pam = new Pam(pamProfile);
           if (!pam.authenticateSuccessful(user, password)) {
    -        throw new UserAuthenticationException(String.format("PAM profile '%s' validation failed", pamProfile));
    +        throw new UserAuthenticationException(String.format("PAM profile '%s' validation failed for user %s",
    --- End diff --
    
    No the exceptions thrown here is directly mapped to Sasl Exception and sent back to client with AUTH_FAILED status.

              </div></li><li><div>
                Github user sohami commented on a diff in the pull request:

    https://github.com/apache/drill/pull/962#discussion_r141411850
  
    --- Diff: exec/java-exec/src/main/java/org/apache/drill/exec/rpc/user/security/Pam4jUserAuthenticator.java ---
    @@ -0,0 +1,81 @@
    +/*
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *    http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +package org.apache.drill.exec.rpc.user.security;
    +
    +import org.apache.drill.common.config.DrillConfig;
    +import org.apache.drill.exec.ExecConstants;
    +import org.apache.drill.exec.exception.DrillbitStartupException;
    +import org.jvnet.libpam.PAM;
    +import org.jvnet.libpam.PAMException;
    +import org.jvnet.libpam.UnixUser;
    +
    +import java.io.IOException;
    +import java.util.List;
    +
    +/**
    + * Implement {@link org.apache.drill.exec.rpc.user.security.UserAuthenticator} based on Pluggable Authentication
    + * Module (PAM) configuration. Configure the PAM profiles using "drill.exec.security.user.auth.pam_profiles" BOOT
    + * option. Ex. value  &lt;i&gt;[ "login", "sudo" ]&lt;/i&gt; (value is an array of strings).
    + */
    +@UserAuthenticatorTemplate(type = "pam4j")
    +public class Pam4jUserAuthenticator implements UserAuthenticator {
    +  private static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(Pam4jUserAuthenticator.class);
    +
    +  private List&lt;String&gt; profiles;
    +
    +  @Override
    +  public void setup(DrillConfig drillConfig) throws DrillbitStartupException {
    +    profiles = drillConfig.getStringList(ExecConstants.PAM_AUTHENTICATOR_PROFILES);
    +  }
    +
    +  @Override
    +  public void authenticate(String user, String password) throws UserAuthenticationException {
    +    for (String profile : profiles) {
    +      PAM pam = null;
    +      UnixUser unixUser;
    +      try {
    +        pam = new PAM(profile);
    +        unixUser = pam.authenticate(user, password);
    +      } catch (PAMException ex) {
    +        logger.error("PAM auth failed for user: {} against {} profile. Exception: {}", user, profile, ex.getMessage());
    +        throw new UserAuthenticationException(String.format("PAM auth failed for user: %s using profile: %s",
    +            user, profile));
    +      } finally {
    +        if (pam != null) {
    +          pam.dispose();
    +        }
    +      }
    +
    +      if (!user.equals(unixUser.getUserName())) {
    --- End diff --
    
    Some *Nix systems supports case sensitive usernames and some doesn't. Like Mac is case insensitive while linux is case sensitive. So I think username should be then treated as case sensitive. I will remove this check since looks like it's redundant and the pam module authenticate should take care of this.

              </div></li><li><div>
                Github user sohami commented on a diff in the pull request:

    https://github.com/apache/drill/pull/962#discussion_r141406449
  
    --- Diff: exec/java-exec/src/main/java/org/apache/drill/exec/rpc/user/security/Pam4jUserAuthenticator.java ---
    @@ -0,0 +1,81 @@
    +/*
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *    http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +package org.apache.drill.exec.rpc.user.security;
    +
    +import org.apache.drill.common.config.DrillConfig;
    +import org.apache.drill.exec.ExecConstants;
    +import org.apache.drill.exec.exception.DrillbitStartupException;
    +import org.jvnet.libpam.PAM;
    +import org.jvnet.libpam.PAMException;
    +import org.jvnet.libpam.UnixUser;
    +
    +import java.io.IOException;
    +import java.util.List;
    +
    +/**
    + * Implement {@link org.apache.drill.exec.rpc.user.security.UserAuthenticator} based on Pluggable Authentication
    + * Module (PAM) configuration. Configure the PAM profiles using "drill.exec.security.user.auth.pam_profiles" BOOT
    + * option. Ex. value  &lt;i&gt;[ "login", "sudo" ]&lt;/i&gt; (value is an array of strings).
    + */
    +@UserAuthenticatorTemplate(type = "pam4j")
    +public class Pam4jUserAuthenticator implements UserAuthenticator {
    +  private static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(Pam4jUserAuthenticator.class);
    +
    +  private List&lt;String&gt; profiles;
    --- End diff --
    
    cannot be final since it is initialized in `setup(..)` method

              </div></li><li><div>
                Github user sohami commented on a diff in the pull request:

    https://github.com/apache/drill/pull/962#discussion_r141406080
  
    --- Diff: distribution/src/resources/drill-override-example.conf ---
    @@ -133,6 +133,8 @@ drill.exec: {
       security.user.auth {
         enabled: false,
         packages += "org.apache.drill.exec.rpc.user.security",
    +    # There are 2 implementations available "pam" using JPAM
    +    # and "pam4j" using libpam4j
    --- End diff --
    
    Updated the comment here to reflect the Annotation name `UserAuthenticatorTemplate`

              </div></li><li><div>
                Github user sohami commented on a diff in the pull request:

    https://github.com/apache/drill/pull/962#discussion_r141411354
  
    --- Diff: exec/java-exec/src/main/java/org/apache/drill/exec/rpc/user/security/Pam4jUserAuthenticator.java ---
    @@ -0,0 +1,81 @@
    +/*
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + *    http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +package org.apache.drill.exec.rpc.user.security;
    +
    +import org.apache.drill.common.config.DrillConfig;
    +import org.apache.drill.exec.ExecConstants;
    +import org.apache.drill.exec.exception.DrillbitStartupException;
    +import org.jvnet.libpam.PAM;
    +import org.jvnet.libpam.PAMException;
    +import org.jvnet.libpam.UnixUser;
    +
    +import java.io.IOException;
    +import java.util.List;
    +
    +/**
    + * Implement {@link org.apache.drill.exec.rpc.user.security.UserAuthenticator} based on Pluggable Authentication
    + * Module (PAM) configuration. Configure the PAM profiles using "drill.exec.security.user.auth.pam_profiles" BOOT
    + * option. Ex. value  &lt;i&gt;[ "login", "sudo" ]&lt;/i&gt; (value is an array of strings).
    + */
    +@UserAuthenticatorTemplate(type = "pam4j")
    +public class Pam4jUserAuthenticator implements UserAuthenticator {
    +  private static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger(Pam4jUserAuthenticator.class);
    +
    +  private List&lt;String&gt; profiles;
    +
    +  @Override
    +  public void setup(DrillConfig drillConfig) throws DrillbitStartupException {
    +    profiles = drillConfig.getStringList(ExecConstants.PAM_AUTHENTICATOR_PROFILES);
    +  }
    +
    +  @Override
    +  public void authenticate(String user, String password) throws UserAuthenticationException {
    +    for (String profile : profiles) {
    +      PAM pam = null;
    +      UnixUser unixUser;
    +      try {
    +        pam = new PAM(profile);
    +        unixUser = pam.authenticate(user, password);
    +      } catch (PAMException ex) {
    +        logger.error("PAM auth failed for user: {} against {} profile. Exception: {}", user, profile, ex.getMessage());
    +        throw new UserAuthenticationException(String.format("PAM auth failed for user: %s using profile: %s",
    +            user, profile));
    +      } finally {
    +        if (pam != null) {
    +          pam.dispose();
    +        }
    +      }
    +
    +      if (!user.equals(unixUser.getUserName())) {
    +        throw new UserAuthenticationException(String.format("Unexpected error from pam module. Input user %s is " +
    +            "different from authenticated output user %s of pam module libpam4j", user, unixUser.getUserName()));
    +      }
    +
    +      if (logger.isTraceEnabled()) {
    --- End diff --
    
    Removed.

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/drill/pull/962

              </div></li><li><div>
                Merged into master with commit id 0cff5f7a7cb4f35a836bf02df159d993df4bcb00
              </div></li><li><div>
                Updated the following page to remove jpam instructions:
https://drill.apache.org/docs/configuring-plain-security/

Added the following pages:
https://drill.apache.org/docs/using-libpam4j-as-the-pam-authenticator/ 
https://drill.apache.org/docs/using-jpam-as-the-pam-authenticator/

~Bridget
              </div></li></ol></div></div></html>