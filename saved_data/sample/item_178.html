<!DOCTYPE html><html><div class="item-title">
        Item 178
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
   * A set of evaluatorIds for "closed" (failed and returned) evaluators.
   
              </div></li><li><div>
                *
   * Moves evaluator from map of active evaluators to set of closed evaluators.
   
              </div></li><li><div>
                *
   * @param evaluatorId
   * @return true if evaluator with this id has already been closed.
   
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> REEF-1250] Fix memory leak in Evaluators
                </div><div><b>message:</b> REEF-1250] Fix memory leak in Evaluators

This change:
 * introduces a set of closed evaluator ids,
 * moves evaluator to this set whenever resource manager
   sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #995

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [REEF-1250] Fix memory leak in Evaluators
                </div><div><b>body:</b> This change:
- introduces a set of closed evaluator ids,
- moves evaluator to this set whenever resource manager
  sends resource status indicating that evaluator is closed.

JIRA:
  [REEF-1250](https://issues.apache.org/jira/browse/REEF-1250)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                I've done a pass.

              </div></li><li><div>
                I have completed a pass. 

              </div></li><li><div>
                I've addressed the comments and updated PR

              </div></li><li><div>
                AppVeyor build has test failure but I think it's transient, the same build succeeded on [my branch](https://ci.appveyor.com/project/tcNickolas/reef/build/89-REEF-1250)

              </div></li><li><div>
                Is there any way we can test it? 

              </div></li><li><div>
                I've verified normal scenarios (removing evaluator in case of evaluator completion or failure) by running tests with increased logging and looking for relevant log entries. It's a bit tricky to write a good test for this.

              </div></li><li><div>
                I am fine with it. Other changes look good to me. 

              </div></li><li><div>
                LGTM, will test and merge.

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                This could indicate an error. So maybe elevate the log level to `WARNING`.

              </div></li><li><div>
                replace with `wasClosed()`

              </div></li><li><div>
                We should make sure that we have it in `closedEvaluators`, though?

              </div></li><li><div>
                This should also be a `WARNING`

              </div></li><li><div>
                Should it still be a warning? 

              </div></li><li><div>
                This should be a monotonic set. Turns out we have one in [Tang](https://github.com/apache/reef/blob/master/lang/java/reef-tang/tang/src/main/java/org/apache/reef/tang/util/MonotonicHashSet.java)

              </div></li><li><div>
                Isn't this an error case?

              </div></li><li><div>
                rename to closedEvaluatorIds 

              </div></li><li><div>
                At least log a warning in this case. 

              </div></li><li><div>
                Probably yes, since in the normal scenario exception would happen first, causing evaluator close. Same as in other places in this PR, is anything happens to evaluator after it's closed, it's suspicious.

              </div></li><li><div><div><b>body:</b> On line 150 we check that if it's neither in `evaluators` nor in `closedEvaluators` we throw exception. So by now if it's not in `evaluators`, it must be in `closedEvaluators` (being in synchronized method).
I'll add condition to improve readability

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Fix memory leak in Evaluators
                </div><div><b>description:</b> In {{Evaluators}}, we keep track of all the Evaluators that ever existed. Including the ones that have failed or been returned. For very long running Drivers, this is a memory leak.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                We have an issue which might be caused by this. A long-running driver requests thousands of evaluators but promptly returns most of them, since it needs only around 250 (which have to be on distinct machines, so most evaluators granted are not suitable). As a result, REEF AM crashes with {{java.lang.OutOfMemoryError}} after about 1 hour of running.

How to verify that this is the actual root cause? And how do we want to fix this (regardless of whether it is)? Is it safe for us to forget about evaluators which have been returned?

{noformat}
Application failed due to:
Java heap space
With stack trace:
java.lang.OutOfMemoryError: Java heap space
at org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:84)
at org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:59)
at org.apache.hadoop.io.IOUtils.copyBytes(IOUtils.java:119)
at org.apache.hadoop.fs.FileUtil.copy(FileUtil.java:366)
at org.apache.hadoop.fs.FileUtil.copy(FileUtil.java:338)
at org.apache.hadoop.fs.FileSystem.copyFromLocalFile(FileSystem.java:1965)
at org.apache.reef.runtime.yarn.driver.UploaderToJobFolder.uploadToJobFolder(UploaderToJobfolder.java:73)
at org.apache.reef.runtime.yarn.driver.EvaluatorSetupHelper.getResources(EvaluatorSetupHelper.java:116)
at org.apache.reef.runtime.yarn.driver.YARNResourceLaunchHandler.onNext(YARNResourceLaunchHandler.java:83)
at org.apache.reef.runtime.yarn.driver.YARNResourceLaunchHandler.onNext(YARNResourceLaunchHandler.java:47)
at org.apache.reef.runtime.common.driver.evaluator.EvaluatorManager.onResourceLaunch(EvaluatorManager.java:474)
at org.apache.reef.runtime.common.driver.evaluator.AllocatedEvaluatorImpl.resourceBuildAndLaunch(AllocatedEvaluatorImpl.java:251)
at org.apache.reef.runtime.common.driver.evaluator.AllocatedEvaluatorImpl.launchWithConfigurationString(AllocatedEvaluatorImpl.java:236)
at org.apache.reef.runtime.common.driver.evaluator.AllocatedEvaluatorImpl.submitContextAndTask(AllocatedEvaluatorImpl.java:170)
at org.apache.reef.javabridge.AllocatedEvaluatorBridge.submitContextAndTaskString(AllocatedEvaluatorBridge.java:71)
at org.apache.reef.javabridge.NativeInterop.clrSystemAllocatedEvaluatorHandlerOnNext(Native Method)
at org.apache.reef.javabridge.generic.JobDriver.submitEvaluator(JobDriver.java:238)
at org.apache.reef.javabridge.generic.JobDriver.access$600(JobDriver.java:66)
at org.apache.reef.javabridge.generic.JobDriver$AllocatedEvaluatorHandler.onNext(JobDriver.java:347)
at org.apache.reef.javabridge.generic.JobDriver$AllocatedEvaluatorHandler.onNext(JobDriver.java:341)
at org.apache.reef.runtime.common.utils.BroadCastEventHandler.onNext(BroadCastEventHandler.java:40)
at org.apache.reef.util.ExceptionHandlingEventHandler.onNext(ExceptionHandlingEventHandler.java:46)
at org.apache.reef.runtime.common.utils.DispatchingEStage$1.onNext(DispatchingEStage.java:68)
at org.apache.reef.runtime.common.utils.DispatchingEStage$1.onNext(DispatchingEStage.java:65)
at org.apache.reef.wake.impl.ThreadPoolStage$1.run(ThreadPoolStage.java:182)
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
at java.util.concurrent.FutureTask.run(FutureTask.java:262)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
at java.lang.Thread.run(Thread.java:745) 
{noformat}
              </div></li><li><div>
                {quote}
How to verify that this is the actual root cause? 
{quote}

That is really tricky. Maybe mock-out the surrounding and test {{Evaluators}} in isolation?

{quote}
And how do we want to fix this (regardless of whether it is)? Is it safe for us to forget about evaluators which have been returned?
{quote}

Yes, for the most part. We should keep their ID around to throw proper exceptions if they check in again later. That might happen due to a network partitioning.

              </div></li><li><div>
                [~MariiaMykhailova] [~markus.weimer] Note that an Evaluator that sends a heartbeat after sending a {{FailedEvaluator}} or {{DoneEvaluator}} message due to a bug may trigger a {{RuntimeException}} if it is not in {{Evaluators}}, if we remove the Evaluator immediately after it is finished. An example where this may happen is REEF-1374. As of now, an Evaluator that is {{DONE}} is still kept in {{Evaluators}}, so the {{EvaluatorManager}} is fetched and the heartbeat with the {{FailedTask}} is subsequently ignored.

Personally, I think the best fix is to only remove the Evaluator from {{Evaluators}} after the Resource Manager tells us that the Evaluator is done, rather than after our Evaluator sends a {{DONE}} heartbeat.
              </div></li><li><div>
                +1

Also, we should keep the IDs of closed Evaluators around. That way, we can detect that sort of situation reliably.
              </div></li><li><div>
                PR https://github.com/apache/reef/pull/995
              </div></li><li><div>
                Resolved via [#995|https://github.com/apache/reef/pull/995]
              </div></li></ol></div></div></html>