<!DOCTYPE html><html><div class="item-title">
        Item 281
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 eat the interrupt and check for exit conditions
              </div></li><li><div>
                 there should be a transaction timeout that keeps this thread
 from sitting around forever if the client goes away
 The above was done by setting afterCompletionCancelled in txState
 during cleanup. When client departed, the transaction/JTA
 will be timed out and cleanup code will be executed.
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional information regarding
 * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the License. You may obtain a
 * copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                 eat the interrupt and check for exit conditions
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional information regarding
 * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the License. You may obtain a
 * copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                *
 * This class ensures that beforeCompletion and afterCompletion are executed in the same thread.
 *
 * @since Geode 1.7.0
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional information regarding
 * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the License. You may obtain a
 * copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                *
   * stop waiting for an afterCompletion to arrive and just exit
   
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional information regarding
 * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the License. You may obtain a
 * copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional information regarding
 * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the License. You may obtain a
 * copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                 give the thread a chance to get past the "finished" check by waiting until
 checkCancelInProgress is called
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional information regarding
 * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the License. You may obtain a
 * copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                *
   * for client/server JTA transactions we need to have a single thread handle both beforeCompletion
   * and afterCompletion so that beforeCompletion can obtain locks for the afterCompletion step.
   * This is that thread
   
              </div></li><li><div>
                 if there was a beforeCompletion call then there will be a thread
 sitting in the waiting pool to execute afterCompletion. Otherwise
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Feature/geode 5624 Use a single thread to ensure beforeCompletion and afterCompletion are executed by the same thread. (#2388)
                </div><div><b>message:</b> Feature/geode 5624 Use a single thread to ensure beforeCompletion and afterCompletion are executed by the same thread. (#2388)





                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> Feature/geode 5624 Use a single thread to ensure beforeCompletion and afterCompletion are executed by the same thread.
                </div><div><b>body:</b> 

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                change this to "while (!condition.getAsBoolean())" so the impl match the method name "waitForCondition".
So you will need to change the callers to flip the logic of the expressions they pass in.
change: "!finished" to "finished"
change: "status == -1 &amp;&amp; !cancelled" to "status != -1 || cancelled".

              </div></li><li><div>
                this can be simplified to "() -&gt; status == -1 &amp;&amp; !cancelled"
No need for the "return" or the "{();}"
              </div></li><li><div>
                this can be simplified to "() -&gt; !finished"
              </div></li><li><div>
                Move this up to the first line of the method. It should be before we call "executeBeforeCompletion".
              </div></li><li><div>
                "this" refers to the "InOrder" line.
              </div></li><li><div>
                verify that execute was called first. This happens synchronously so it should have already happened.
executeBeforeCompletion does not return until beforeCompletion.doOp is called (and completed). So remove the await on beforeCompletion.doOp. Also add verification of beforeCompletion.isFinished() is true. 
The 4th line of verification should be that we did afterCompletion.doOp and you need an await on that line
              </div></li><li><div>
                I was wrong about this. We have a mocked beforeCompletion and afterCompletion so calling beforeCompletion.execute does not wait for doOp to finish
              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>