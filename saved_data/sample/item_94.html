<!DOCTYPE html><html><div class="item-title">
        Item 94
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
 * Unit test for InternalDistributedMember
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional information regarding
 * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the License. You may obtain a
 * copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                 else they're the same, so continue
              </div></li><li><div><div><b>comment:</b>  purposely avoid checking roles
 @todo Add durableClientAttributes to equals
                </div><div><b>label:</b> requirement
                </div></div></li><li><div>
                 not loners, so look at P2P view ID
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> GEODE-6702: optimize equals by not calling compareTo (#3524)
                </div><div><b>message:</b> GEODE-6702: optimize equals by not calling compareTo (#3524)

* added unit test for InternalDistributedMember.equals

* InternalDistributedMember equals no longer uses compareTo
to avoid array allocations needed by the compare code.

* simplified equals code by using Objects.equals

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> GEODE-6702: optimize equals by not calling compareTo
                </div><div><b>body:</b> The compareTo implementation needs to get the InetAddress as a byte array
which causes to byte array allocations.
By changing InternalDistributedMember.equals to not call compareTo InetAddress.equals
can be used instead which prevents the byte array allocations.

Thank you for submitting a contribution to Apache Geode.

In order to streamline the review of the contribution we ask you
to ensure the following steps have been taken:

### For all changes:
- [ ] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?

- [ ] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?

- [ ] Is your initial contribution a single, squashed commit?

- [ ] Does `gradlew build` run cleanly?

- [ ] Have you written or updated unit tests to verify your changes?

- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?

### Note:
Please ensure that once the PR is submitted, check Concourse for build issues and
submit an update to your PR as soon as possible. If you need help, please send an
email to dev@geode.apache.org.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> GEODE-6702: optimize equals by not calling compareTo
                </div><div><b>body:</b> The compareTo implementation needs to get the InetAddress as a byte array
which causes to byte array allocations.
By changing InternalDistributedMember.equals to not call compareTo InetAddress.equals
can be used instead which prevents the byte array allocations.

Thank you for submitting a contribution to Apache Geode.

In order to streamline the review of the contribution we ask you
to ensure the following steps have been taken:

### For all changes:
- [ ] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?

- [ ] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?

- [ ] Is your initial contribution a single, squashed commit?

- [ ] Does `gradlew build` run cleanly?

- [ ] Have you written or updated unit tests to verify your changes?

- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?

### Note:
Please ensure that once the PR is submitted, check Concourse for build issues and
submit an update to your PR as soon as possible. If you need help, please send an
email to dev@geode.apache.org.

                </div></div></li><li><div><div><b>title:</b> GEODE-6702: optimize equals by not calling compareTo
                </div><div><b>body:</b> The compareTo implementation needs to get the InetAddress as a byte array
which causes to byte array allocations.
By changing InternalDistributedMember.equals to not call compareTo InetAddress.equals
can be used instead which prevents the byte array allocations.

Thank you for submitting a contribution to Apache Geode.

In order to streamline the review of the contribution we ask you
to ensure the following steps have been taken:

### For all changes:
- [ ] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?

- [ ] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?

- [ ] Is your initial contribution a single, squashed commit?

- [ ] Does `gradlew build` run cleanly?

- [ ] Have you written or updated unit tests to verify your changes?

- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?

### Note:
Please ensure that once the PR is submitted, check Concourse for build issues and
submit an update to your PR as soon as possible. If you need help, please send an
email to dev@geode.apache.org.

                </div></div></li><li><div><div><b>title:</b> GEODE-6702: optimize equals by not calling compareTo
                </div><div><b>body:</b> The compareTo implementation needs to get the InetAddress as a byte array
which causes to byte array allocations.
By changing InternalDistributedMember.equals to not call compareTo InetAddress.equals
can be used instead which prevents the byte array allocations.

Thank you for submitting a contribution to Apache Geode.

In order to streamline the review of the contribution we ask you
to ensure the following steps have been taken:

### For all changes:
- [ ] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?

- [ ] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?

- [ ] Is your initial contribution a single, squashed commit?

- [ ] Does `gradlew build` run cleanly?

- [ ] Have you written or updated unit tests to verify your changes?

- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?

### Note:
Please ensure that once the PR is submitted, check Concourse for build issues and
submit an update to your PR as soon as possible. If you need help, please send an
email to dev@geode.apache.org.

                </div></div></li><li><div><div><b>title:</b> GEODE-6702: optimize equals by not calling compareTo
                </div><div><b>body:</b> The compareTo implementation needs to get the InetAddress as a byte array
which causes to byte array allocations.
By changing InternalDistributedMember.equals to not call compareTo InetAddress.equals
can be used instead which prevents the byte array allocations.

Thank you for submitting a contribution to Apache Geode.

In order to streamline the review of the contribution we ask you
to ensure the following steps have been taken:

### For all changes:
- [ ] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?

- [ ] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?

- [ ] Is your initial contribution a single, squashed commit?

- [ ] Does `gradlew build` run cleanly?

- [ ] Have you written or updated unit tests to verify your changes?

- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?

### Note:
Please ensure that once the PR is submitted, check Concourse for build issues and
submit an update to your PR as soon as possible. If you need help, please send an
email to dev@geode.apache.org.

                </div></div></li><li><div><div><b>title:</b> GEODE-6702: optimize equals by not calling compareTo
                </div><div><b>body:</b> The compareTo implementation needs to get the InetAddress as a byte array
which causes to byte array allocations.
By changing InternalDistributedMember.equals to not call compareTo InetAddress.equals
can be used instead which prevents the byte array allocations.

Thank you for submitting a contribution to Apache Geode.

In order to streamline the review of the contribution we ask you
to ensure the following steps have been taken:

### For all changes:
- [ ] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?

- [ ] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?

- [ ] Is your initial contribution a single, squashed commit?

- [ ] Does `gradlew build` run cleanly?

- [ ] Have you written or updated unit tests to verify your changes?

- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?

### Note:
Please ensure that once the PR is submitted, check Concourse for build issues and
submit an update to your PR as soon as possible. If you need help, please send an
email to dev@geode.apache.org.

                </div></div></li><li><div><div><b>title:</b> GEODE-6702: optimize equals by not calling compareTo
                </div><div><b>body:</b> The compareTo implementation needs to get the InetAddress as a byte array
which causes to byte array allocations.
By changing InternalDistributedMember.equals to not call compareTo InetAddress.equals
can be used instead which prevents the byte array allocations.

Thank you for submitting a contribution to Apache Geode.

In order to streamline the review of the contribution we ask you
to ensure the following steps have been taken:

### For all changes:
- [ ] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?

- [ ] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?

- [ ] Is your initial contribution a single, squashed commit?

- [ ] Does `gradlew build` run cleanly?

- [ ] Have you written or updated unit tests to verify your changes?

- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?

### Note:
Please ensure that once the PR is submitted, check Concourse for build issues and
submit an update to your PR as soon as possible. If you need help, please send an
email to dev@geode.apache.org.

                </div></div></li><li><div><div><b>title:</b> GEODE-6702: optimize equals by not calling compareTo
                </div><div><b>body:</b> The compareTo implementation needs to get the InetAddress as a byte array
which causes to byte array allocations.
By changing InternalDistributedMember.equals to not call compareTo InetAddress.equals
can be used instead which prevents the byte array allocations.

Thank you for submitting a contribution to Apache Geode.

In order to streamline the review of the contribution we ask you
to ensure the following steps have been taken:

### For all changes:
- [ ] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?

- [ ] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?

- [ ] Is your initial contribution a single, squashed commit?

- [ ] Does `gradlew build` run cleanly?

- [ ] Have you written or updated unit tests to verify your changes?

- [ ] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?

### Note:
Please ensure that once the PR is submitted, check Concourse for build issues and
submit an update to your PR as soon as possible. If you need help, please send an
email to dev@geode.apache.org.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div><div><b>body:</b> &gt; Won't the runtime optimize the compareTo call?

I don't know. I know that compareTo has to ask the InetAddress for a byte array representation of the address so that it can figure out if one address is greater or lessor than the other. It was these byte array allocations that showed up in the profiler. I think this would be garbage that the collector has to deal with. The new equals logic also has fewer conditions that it needs to test for but that was not the reason for this pull request and I doubt it would be much of a difference. If I could have found a way to change compareTo to not do the byte array allocations (by calling InetAddress.getAddress) I would have made that change add kept equals implemented by calling compareTo.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Could we replace may of these blocks of code with.
```
if (!Object.equals(getInetAddress(), other.getInetAddress())) {
  return false;
}
              </div></li><li><div>
                That is a good idea. We would not want to use it on primitive fields (like the ports) and the inetAddress comparison has a special case that if they are both null then we return true immediately. I will make the change to use Objects.equals where possible and update this PR. 
              </div></li><li><div>
                Object.equals handles the `null` case as well.
              </div></li><li><div>
                I don't think so. Objects.equals(null, null) returns true. But so does other non-null InetAddresses. But we are only willing to stop here if either they are not equal OR they are both null. If the addresses are non-null and equal then we continue on and compare other things. This logic was derived from the compareTo logic that I did not want to change. I'm not sure why it did not treat "null, null" as equal and just continue to compare other things. 
              </div></li><li><div>
                Oh I see... yeah that is odd.
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> InternalDistributedMember equals could be optimized
                </div><div><b>description:</b> In a partitioned region client/server put benchmark, I saw lots of calls to InternalDistributedMember equals. Each call was allocating two byte arrays.

This is because equals is implemented by calling compareTo, and compare needs to get the InetAddress as a byte array. But if instead it just wanted to know if they were equal, then it could instead call InetAddress.equals.

I have a prototype fix for this in:&nbsp;

4298ad678f3bc7621b6a566442e358f1ed34030a
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Commit 30c23401daecdbe4a8f63aed415b80574bd92941 in geode's branch refs/heads/develop from Darrel Schneider
[ https://gitbox.apache.org/repos/asf?p=geode.git;h=30c2340 ]

GEODE-6702: optimize equals by not calling compareTo (#3524)

* added unit test for InternalDistributedMember.equals

* InternalDistributedMember equals no longer uses compareTo
to avoid array allocations needed by the compare code.

* simplified equals code by using Objects.equals

              </div></li><li><div>
                Commit 30c23401daecdbe4a8f63aed415b80574bd92941 in geode's branch refs/heads/feature/GEODE-6583 from Darrel Schneider
[ https://gitbox.apache.org/repos/asf?p=geode.git;h=30c2340 ]

GEODE-6702: optimize equals by not calling compareTo (#3524)

* added unit test for InternalDistributedMember.equals

* InternalDistributedMember equals no longer uses compareTo
to avoid array allocations needed by the compare code.

* simplified equals code by using Objects.equals

              </div></li></ol></div></div></html>