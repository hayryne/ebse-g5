<!DOCTYPE html><html><div class="item-title">
        Item 286
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional information regarding
 * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the License. You may obtain a
 * copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more contributor license
 * agreements. See the NOTICE file distributed with this work for additional information regarding
 * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the License. You may obtain a
 * copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License
 * is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing permissions and limitations under
 * the License.
 
              </div></li><li><div>
                 TODO: better shutdown.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> GEODE-3170: Closed socket doesn't result in an infinite loop. This closes #633
                </div><div><b>message:</b> GEODE-3170: Closed socket doesn't result in an infinite loop. This closes #633

* Protobuf deserialization returning null is handled.
* IOException causes GenericProtocolServerConnection to close.
* Added a couple of JUnit tests.

Signed-off-by: Hitesh Khamesra &lt;hkameshra@pivotal.io&gt;
Signed-off-by: Galen O'Sullivan &lt;gosullivan@pivotal.io&gt;

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> GEODE-3170: Closed socket doesn't result in an infinite loop.
                </div><div><b>body:</b> * Protobuf deserialization returning null is handled.
* IOException causes GenericProtocolServerConnection to close.
* Added a couple of JUnit tests.

Signed-off-by: Hitesh Khamesra &lt;hkameshra@pivotal.io&gt;
Signed-off-by: Galen O'Sullivan &lt;gosullivan@pivotal.io&gt;

Thank you for submitting a contribution to Apache Geode.

In order to streamline the review of the contribution we ask you
to ensure the following steps have been taken:

### For all changes:
- [x] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?

- [x] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?

- [x] Is your initial contribution a single, squashed commit?

- [x] Does `gradlew build` run cleanly?

- [x] Have you written or updated unit tests to verify your changes?

- [n/a] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?

### Note:
Please ensure that once the PR is submitted, you check travis-ci for build issues and
submit an update to your PR as soon as possible. If you need help, please send an
email to dev@geode.apache.org.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                @hiteshk25 @pivotal-amurmann 
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Can we raise a ticket for this to complete this TODO
              </div></li><li><div>
                https://issues.apache.org/jira/browse/GEODE-3079 should cover it.
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Geode keeps logging org.apache.geode.protocol.exception.InvalidProtocolMessageException
                </div><div><b>description:</b> We've been seeing the logs getting filled up with exceptions if the new binary protocol is enabled. This quickly fills up the hard drive.

See attached file for example log
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Hitesh came up with the very likely theory that this is caused by `/gemfire/open/geode-core/src/main/java/org/apache/geode/internal/cache/tier/sockets/GenericProtocolServerConnection.java:61` taking messages off the socket in a while lop regardless of their being new messages or not.
              </div></li><li><div>
                This issue is caused by a socket that's closed on the client side, which causes a SocketException to be thrown in ProtobufProtocolSerializer.deserialize . This throws a InvalidProtocolMessageException wrapping the SocketException (as an IOException), which is then rethrown as an IOException (whew!).

We need to implement shutdown properly to have the shutdown method to call when the socket is no longer readable (hence the dependency on GEODE-3079).

I think it's reasonable to close a socket if we ever get an IOException from it. Are there other cases of IOException I'm missing?
              </div></li><li><div>
                GitHub user galen-pivotal opened a pull request:

    https://github.com/apache/geode/pull/633

    GEODE-3170: Closed socket doesn't result in an infinite loop.

    * Protobuf deserialization returning null is handled.
    * IOException causes GenericProtocolServerConnection to close.
    * Added a couple of JUnit tests.
    
    Signed-off-by: Hitesh Khamesra &lt;hkameshra@pivotal.io&gt;
    Signed-off-by: Galen O'Sullivan &lt;gosullivan@pivotal.io&gt;
    
    Thank you for submitting a contribution to Apache Geode.
    
    In order to streamline the review of the contribution we ask you
    to ensure the following steps have been taken:
    
    ### For all changes:
    - [x] Is there a JIRA ticket associated with this PR? Is it referenced in the commit message?
    
    - [x] Has your PR been rebased against the latest commit within the target branch (typically `develop`)?
    
    - [x] Is your initial contribution a single, squashed commit?
    
    - [x] Does `gradlew build` run cleanly?
    
    - [x] Have you written or updated unit tests to verify your changes?
    
    - [n/a] If adding new dependencies to the code, are these dependencies licensed in a way that is compatible for inclusion under [ASF 2.0](http://www.apache.org/legal/resolved.html#category-a)?
    
    ### Note:
    Please ensure that once the PR is submitted, you check travis-ci for build issues and
    submit an update to your PR as soon as possible. If you need help, please send an
    email to dev@geode.apache.org.


You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/galen-pivotal/geode feature/GEODE-3170

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/geode/pull/633.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #633
    
----
commit c13797630d4a7825e8ab7c668a521fd3a3aeff77
Author: Galen O'Sullivan &lt;gosullivan@pivotal.io&gt;
Date:   2017-07-13T18:26:09Z

    GEODE-3170: Closed socket doesn't result in an infinite loop.
    
    * Protobuf deserialization returning null is handled.
    * IOException causes GenericProtocolServerConnection to close.
    * Added a couple of JUnit tests.
    
    Signed-off-by: Hitesh Khamesra &lt;hkameshra@pivotal.io&gt;
    Signed-off-by: Galen O'Sullivan &lt;gosullivan@pivotal.io&gt;

----

              </div></li><li><div>
                Github user kohlmu-pivotal commented on a diff in the pull request:

    https://github.com/apache/geode/pull/633#discussion_r127540044
  
    --- Diff: geode-core/src/main/java/org/apache/geode/internal/cache/tier/sockets/GenericProtocolServerConnection.java ---
    @@ -68,9 +56,8 @@ protected void doOneMessage() {
           messageHandler.receiveMessage(inputStream, outputStream, this.getCache());
         } catch (IOException e) {
           logger.warn(e);
    -      // TODO?
    +      this.setFlagProcessMessagesAsFalse(); // TODO: better shutdown.
    --- End diff --
    
    Can we raise a ticket for this to complete this TODO

              </div></li><li><div>
                Github user kohlmu-pivotal commented on the issue:

    https://github.com/apache/geode/pull/633
  
    @hiteshk25 @pivotal-amurmann 

              </div></li><li><div>
                Github user galen-pivotal commented on a diff in the pull request:

    https://github.com/apache/geode/pull/633#discussion_r127550540
  
    --- Diff: geode-core/src/main/java/org/apache/geode/internal/cache/tier/sockets/GenericProtocolServerConnection.java ---
    @@ -68,9 +56,8 @@ protected void doOneMessage() {
           messageHandler.receiveMessage(inputStream, outputStream, this.getCache());
         } catch (IOException e) {
           logger.warn(e);
    -      // TODO?
    +      this.setFlagProcessMessagesAsFalse(); // TODO: better shutdown.
    --- End diff --
    
    https://issues.apache.org/jira/browse/GEODE-3079 should cover it.

              </div></li><li><div>
                Commit 9905794eb0412f881c9e373852b463ef3f132ea3 in geode's branch refs/heads/develop from [~gosullivan]
[ https://git-wip-us.apache.org/repos/asf?p=geode.git;h=9905794 ]

GEODE-3170: Closed socket doesn't result in an infinite loop. This closes #633

* Protobuf deserialization returning null is handled.
* IOException causes GenericProtocolServerConnection to close.
* Added a couple of JUnit tests.

Signed-off-by: Hitesh Khamesra &lt;hkameshra@pivotal.io&gt;
Signed-off-by: Galen O'Sullivan &lt;gosullivan@pivotal.io&gt;

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/geode/pull/633

              </div></li></ol></div></div></html>