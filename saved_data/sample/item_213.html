<!DOCTYPE html><html><div class="item-title">
        Item 213
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Replicating the behavior of how logging module was loaded
 in logging_config.py
              </div></li><li><div>
                 Create the directory structure
              </div></li><li><div>
                 Replace slashes by dots
              </div></li><li><div>
                 Add the __init__ for the directories
 This is required for Python 2.7
              </div></li><li><div>
                 Launch a process through DagFileProcessorAgent, which will try
 reload the logging module.
              </div></li><li><div>
                 shutil.rmtree(self.settings_root)
 Reset config
              </div></li><li><div><div><b>comment:</b>  Since we are reloading logging config not creating this file,
 we should expect it to be nonexistent.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>comment:</b>  Starting dag processing with 0 max_runs to avoid redundant operations.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent (#4253)
                </div><div><b>message:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent (#4253)


                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li><li><div><div><b>title:</b> [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
                </div><div><b>body:</b> ### Jira

- [x] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW-3414) issues and references them in the PR title.
  - https://issues.apache.org/jira/browse/AIRFLOW-3414

### Description

- [x] Here are some details about my PR, including screenshots of any UI changes:
`six.moves.reload_module` will throw exception if the module it is trying to reload has not been loaded yet. This will be the case if we loaded custom logging class and then try to reload the default logging module. This change will make sure we always load the already loaded logging module.

### Tests

- [x] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
tests/utils/test_dag_processing.py

Note that the unit test covers the case where we loaded BOTH default logging module and are trying to reload custom logging module but not the case where default logging module is not loaded. This is because the test env already has the default logging module loaded and it would be risky to modify the loaded module list. The case is instead covered in local tests( using custom logging and the cluster is healthy).

### Commits

- [x] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
  1. Subject is separated from body by a blank line
  1. Subject is limited to 50 characters (not including Jira issue reference)
  1. Subject does not end with a period
  1. Subject uses the imperative mood ("add", not "adding")
  1. Body wraps at 72 characters
  1. Body explains "what" and "why", not "how"

### Documentation

- [ ] In case of new functionality, my PR adds documentation that describes how to use it.
  - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.

### Code Quality

- [x] Passes `flake8`

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                # [Codecov](https://codecov.io/gh/apache/incubator-airflow/pull/4253?src=pr&amp;el=h1) Report
&gt; Merging [#4253](https://codecov.io/gh/apache/incubator-airflow/pull/4253?src=pr&amp;el=desc) into [master](https://codecov.io/gh/apache/incubator-airflow/commit/d1d612e5c78c89487a05ab3cc86f7d3472ac2a5d?src=pr&amp;el=desc) will **decrease** coverage by `&lt;.01%`.
&gt; The diff coverage is `85.71%`.

[![Impacted file tree graph](https://codecov.io/gh/apache/incubator-airflow/pull/4253/graphs/tree.svg?width=650&amp;token=WdLKlKHOAU&amp;height=150&amp;src=pr)](https://codecov.io/gh/apache/incubator-airflow/pull/4253?src=pr&amp;el=tree)

```diff
@@            Coverage Diff             @@
##           master    #4253      +/-   ##
==========================================
- Coverage   78.07%   78.07%   -0.01%     
==========================================
  Files         201      201              
  Lines       16455    16458       +3     
==========================================
+ Hits        12848    12850       +2     
- Misses       3607     3608       +1
```


| [Impacted Files](https://codecov.io/gh/apache/incubator-airflow/pull/4253?src=pr&amp;el=tree) | Coverage Δ | |
|---|---|---|
| [airflow/settings.py](https://codecov.io/gh/apache/incubator-airflow/pull/4253/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9zZXR0aW5ncy5weQ==) | `80.41% &lt;100%&gt; (ø)` | :arrow_up: |
| [airflow/logging\_config.py](https://codecov.io/gh/apache/incubator-airflow/pull/4253/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9sb2dnaW5nX2NvbmZpZy5weQ==) | `97.56% &lt;100%&gt; (+0.06%)` | :arrow_up: |
| [airflow/utils/dag\_processing.py](https://codecov.io/gh/apache/incubator-airflow/pull/4253/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy91dGlscy9kYWdfcHJvY2Vzc2luZy5weQ==) | `59.67% &lt;66.66%&gt; (+0.14%)` | :arrow_up: |
| [airflow/models.py](https://codecov.io/gh/apache/incubator-airflow/pull/4253/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9tb2RlbHMucHk=) | `92.29% &lt;0%&gt; (-0.05%)` | :arrow_down: |

------

[Continue to review full report at Codecov](https://codecov.io/gh/apache/incubator-airflow/pull/4253?src=pr&amp;el=continue).
&gt; **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)
&gt; `Δ = absolute &lt;relative&gt; (impact)`, `ø = not affected`, `? = missing data`
&gt; Powered by [Codecov](https://codecov.io/gh/apache/incubator-airflow/pull/4253?src=pr&amp;el=footer). Last update [d1d612e...eecc75a](https://codecov.io/gh/apache/incubator-airflow/pull/4253?src=pr&amp;el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).

              </div></li><li><div>
                @Fokko @ashb @feng-tao @XD-DENG @kaxil @saguziel @aoen @YingboWang PTAL
              </div></li><li><div>
                @KevinYang21, I am oncall this week. will take a look next week if this pr is still open
              </div></li><li><div>
                @feng-tao lol I'm oncall too :D Don't worry about it, we got plenty of committers ;) Ty for being caring.
              </div></li><li><div>
                @kaxil Thank you for reviewing! Replied the comments in their own thread.
              </div></li><li><div>
                Looks sensible to me. 

@feng-tao @ashb any comments?
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Thanks @KevinYang21 !

Is there any specific reason that we need to return `logging_config`?

----------------------------------

**Before this PR**:

`configure_logging()` is invoked in `airflow/settings.py`, but seems what it returns is not used (its return value is not passed to any variable actually, https://github.com/apache/incubator-airflow/pull/4253/files#diff-535b21d0d7b5e33649e0eb521b41f157L264).

**After this PR**:

`logging_class_path` is returned by `configure_logging()`, then used in `airflow/utils/dag_processing.py`.

But `logging_config` is still not used anywhere.

----------------------------------
So I'm thinking if we really need to include `logging_config` in the return values?

Kindly let me know if I missed anything (quite likely). Thanks!
              </div></li><li><div>
                @XD-DENG Thank you for reviewing. I actually don't think the return value is used anywhere. I was playing it safe by keep the original return value. After you mentioned, I think we can just remove that return value--we can always add it back if it is needed in the future.
              </div></li><li><div>
                Do we need `[0]` here ?? `.rsplit('.',1)` would just have one item right??
              </div></li><li><div>
                Do we need to assign this to a variable ?? 
              </div></li><li><div>
                It will actually [return a list as split](https://docs.python.org/2/library/string.html#string.rsplit). If not it will fail the newly added unit test :D
              </div></li><li><div>
                Ya the logging_class_path is used [here](https://github.com/apache/incubator-airflow/pull/4253/files#diff-ced4fd65ce02db58eed692eef6e01d05R546). Just trying to keep it consistent between two usage.
              </div></li><li><div><div><b>body:</b> Oh yes, my bad 😄 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                👍 
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> reload_module not working with custom logging class
                </div><div><b>description:</b> If using custom logging class, the reload_module in dag_processing.py will fail because it will try to reload default logging class, which is not loaded at the first place.
                </div></div></li><li><div><div><b>summary:</b> reload_module not working with custom logging class
                </div><div><b>description:</b> If using custom logging class, the reload_module in dag_processing.py will fail because it will try to reload default logging class, which is not loaded at the first place.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                KevinYang21 opened a new pull request #4253: [WIP][AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
URL: https://github.com/apache/incubator-airflow/pull/4253
 
 
   Make sure you have checked _all_ steps below.
   
   ### Jira
   
   - [ ] My PR addresses the following [Airflow Jira](https://issues.apache.org/jira/browse/AIRFLOW/) issues and references them in the PR title. For example, "\[AIRFLOW-XXX\] My Airflow PR"
     - https://issues.apache.org/jira/browse/AIRFLOW-XXX
     - In case you are fixing a typo in the documentation you can prepend your commit with \[AIRFLOW-XXX\], code changes always need a Jira issue.
   
   ### Description
   
   - [ ] Here are some details about my PR, including screenshots of any UI changes:
   
   ### Tests
   
   - [ ] My PR adds the following unit tests __OR__ does not need testing for this extremely good reason:
   
   ### Commits
   
   - [ ] My commits all reference Jira issues in their subject lines, and I have squashed multiple commits if they address the same issue. In addition, my commits follow the guidelines from "[How to write a good git commit message](http://chris.beams.io/posts/git-commit/)":
     1. Subject is separated from body by a blank line
     1. Subject is limited to 50 characters (not including Jira issue reference)
     1. Subject does not end with a period
     1. Subject uses the imperative mood ("add", not "adding")
     1. Body wraps at 72 characters
     1. Body explains "what" and "why", not "how"
   
   ### Documentation
   
   - [ ] In case of new functionality, my PR adds documentation that describes how to use it.
     - When adding new operators/hooks/sensors, the autoclass documentation generation needs to be added.
   
   ### Code Quality
   
   - [ ] Passes `flake8`
   

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                kaxil closed pull request #4253: [AIRFLOW-3414] Fix reload_module in DagFileProcessorAgent
URL: https://github.com/apache/incubator-airflow/pull/4253
 
 
   

This is a PR merged from a forked repository.
As GitHub hides the original diff on merge, it is displayed below for
the sake of provenance:

As this is a foreign pull request (from a fork), the diff is supplied
below (as it won't show otherwise due to GitHub magic):

diff --git a/airflow/logging_config.py b/airflow/logging_config.py
index 84850b4f82..4865f0567a 100644
--- a/airflow/logging_config.py
+++ b/airflow/logging_config.py
@@ -57,9 +57,9 @@ def configure_logging():
                 .format(logging_class_path, err)
             )
     else:
-        from airflow.config_templates.airflow_local_settings import (
-            DEFAULT_LOGGING_CONFIG as logging_config
-        )
+        logging_class_path = 'airflow.config_templates.' \
+                             'airflow_local_settings.DEFAULT_LOGGING_CONFIG'
+        logging_config = import_string(logging_class_path)
         log.debug('Unable to load custom logging, using default config instead')
 
     try:
@@ -73,7 +73,7 @@ def configure_logging():
 
     validate_logging_config(logging_config)
 
-    return logging_config
+    return logging_class_path
 
 
 def validate_logging_config(logging_config):
diff --git a/airflow/settings.py b/airflow/settings.py
index 8f8420ea22..8691fe4e75 100644
--- a/airflow/settings.py
+++ b/airflow/settings.py
@@ -261,7 +261,7 @@ def configure_action_logging():
 except Exception:
     pass
 
-configure_logging()
+logging_class_path = configure_logging()
 configure_vars()
 configure_adapters()
 # The webservers import this file from models.py with the default settings.
diff --git a/airflow/utils/dag_processing.py b/airflow/utils/dag_processing.py
index 0fe9e917ef..6425f77745 100644
--- a/airflow/utils/dag_processing.py
+++ b/airflow/utils/dag_processing.py
@@ -34,6 +34,7 @@
 from collections import defaultdict
 from collections import namedtuple
 from datetime import timedelta
+from importlib import import_module
 
 import psutil
 from six.moves import range, reload_module
@@ -45,6 +46,7 @@
 from airflow import configuration as conf
 from airflow.dag.base_dag import BaseDag, BaseDagBag
 from airflow.exceptions import AirflowException
+from airflow.settings import logging_class_path
 from airflow.utils import timezone
 from airflow.utils.db import provide_session
 from airflow.utils.log.logging_mixin import LoggingMixin
@@ -539,7 +541,9 @@ def helper():
             # e.g. RotatingFileHandler. And it can cause connection corruption if we
             # do not recreate the SQLA connection pool.
             os.environ['CONFIG_PROCESSOR_MANAGER_LOGGER'] = 'True'
-            reload_module(airflow.config_templates.airflow_local_settings)
+            # Replicating the behavior of how logging module was loaded
+            # in logging_config.py
+            reload_module(import_module(logging_class_path.rsplit('.', 1)[0]))
             reload_module(airflow.settings)
             del os.environ['CONFIG_PROCESSOR_MANAGER_LOGGER']
             processor_manager = DagFileProcessorManager(dag_directory,
diff --git a/tests/utils/test_dag_processing.py b/tests/utils/test_dag_processing.py
index 4043caec56..9c85b66c57 100644
--- a/tests/utils/test_dag_processing.py
+++ b/tests/utils/test_dag_processing.py
@@ -18,12 +18,15 @@
 # under the License.
 
 import os
+import sys
+import tempfile
 import unittest
 from datetime import timedelta
 
 from mock import MagicMock
 
 from airflow import configuration as conf
+from airflow.configuration import mkdir_p
 from airflow.jobs import DagFileProcessor
 from airflow.jobs import LocalTaskJob as LJ
 from airflow.models import DagBag, TaskInstance as TI
@@ -38,6 +41,96 @@
 
 DEFAULT_DATE = timezone.datetime(2016, 1, 1)
 
+SETTINGS_FILE_VALID = """
+LOGGING_CONFIG = {
+    'version': 1,
+    'disable_existing_loggers': False,
+    'formatters': {
+        'airflow.task': {
+            'format': '[%%(asctime)s] {{%%(filename)s:%%(lineno)d}} %%(levelname)s - %%(message)s'
+        },
+    },
+    'handlers': {
+        'console': {
+            'class': 'logging.StreamHandler',
+            'formatter': 'airflow.task',
+            'stream': 'ext://sys.stdout'
+        },
+        'task': {
+            'class': 'logging.StreamHandler',
+            'formatter': 'airflow.task',
+            'stream': 'ext://sys.stdout'
+        },
+    },
+    'loggers': {
+        'airflow': {
+            'handlers': ['console'],
+            'level': 'INFO',
+            'propagate': False
+        },
+        'airflow.task': {
+            'handlers': ['task'],
+            'level': 'INFO',
+            'propagate': False,
+        },
+    }
+}
+"""
+
+SETTINGS_DEFAULT_NAME = 'custom_airflow_local_settings'
+
+
+class settings_context(object):
+    """
+    Sets a settings file and puts it in the Python classpath
+
+    :param content:
+          The content of the settings file
+    """
+
+    def __init__(self, content, dir=None, name='LOGGING_CONFIG'):
+        self.content = content
+        self.settings_root = tempfile.mkdtemp()
+        filename = "{}.py".format(SETTINGS_DEFAULT_NAME)
+
+        if dir:
+            # Replace slashes by dots
+            self.module = dir.replace('/', '.') + '.' + SETTINGS_DEFAULT_NAME + '.' + name
+
+            # Create the directory structure
+            dir_path = os.path.join(self.settings_root, dir)
+            mkdir_p(dir_path)
+
+            # Add the __init__ for the directories
+            # This is required for Python 2.7
+            basedir = self.settings_root
+            for part in dir.split('/'):
+                open(os.path.join(basedir, '__init__.py'), 'w').close()
+                basedir = os.path.join(basedir, part)
+            open(os.path.join(basedir, '__init__.py'), 'w').close()
+
+            self.settings_file = os.path.join(dir_path, filename)
+        else:
+            self.module = SETTINGS_DEFAULT_NAME + '.' + name
+            self.settings_file = os.path.join(self.settings_root, filename)
+
+    def __enter__(self):
+        with open(self.settings_file, 'w') as handle:
+            handle.writelines(self.content)
+        sys.path.append(self.settings_root)
+        conf.set(
+            'core',
+            'logging_config_class',
+            self.module
+        )
+        return self.settings_file
+
+    def __exit__(self, *exc_info):
+        # shutil.rmtree(self.settings_root)
+        # Reset config
+        conf.set('core', 'logging_config_class', '')
+        sys.path.remove(self.settings_root)
+
 
 class TestDagFileProcessorManager(unittest.TestCase):
     def test_set_file_paths_when_processor_file_path_not_in_new_file_paths(self):
@@ -123,6 +216,54 @@ def test_find_zombies(self):
 
 
 class TestDagFileProcessorAgent(unittest.TestCase):
+    def test_reload_module(self):
+        """
+        Configure the context to have core.logging_config_class set to a fake logging
+        class path, thus when reloading logging module the airflow.processor_manager
+        logger should not be configured.
+        """
+        with settings_context(SETTINGS_FILE_VALID):
+            # Launch a process through DagFileProcessorAgent, which will try
+            # reload the logging module.
+            def processor_factory(file_path, zombies):
+                return DagFileProcessor(file_path,
+                                        False,
+                                        [],
+                                        zombies)
+
+            test_dag_path = os.path.join(TEST_DAG_FOLDER, 'test_scheduler_dags.py')
+            async_mode = 'sqlite' not in conf.get('core', 'sql_alchemy_conn')
+
+            log_file_loc = conf.get('core', 'DAG_PROCESSOR_MANAGER_LOG_LOCATION')
+            try:
+                os.remove(log_file_loc)
+            except OSError:
+                pass
+
+            # Starting dag processing with 0 max_runs to avoid redundant operations.
+            processor_agent = DagFileProcessorAgent(test_dag_path,
+                                                    [],
+                                                    0,
+                                                    processor_factory,
+                                                    async_mode)
+            manager_process = \
+                processor_agent._launch_process(processor_agent._dag_directory,
+                                                processor_agent._file_paths,
+                                                processor_agent._max_runs,
+                                                processor_agent._processor_factory,
+                                                processor_agent._child_signal_conn,
+                                                processor_agent._stat_queue,
+                                                processor_agent._result_queue,
+                                                processor_agent._async_mode)
+            if not async_mode:
+                processor_agent.heartbeat()
+
+            manager_process.join()
+
+            # Since we are reloading logging config not creating this file,
+            # we should expect it to be nonexistent.
+            self.assertFalse(os.path.isfile(log_file_loc))
+
     def test_parse_once(self):
         def processor_factory(file_path, zombies):
             return DagFileProcessor(file_path,
@@ -164,7 +305,7 @@ def processor_factory(file_path, zombies):
         except OSError:
             pass
 
-        # Starting dag processing with 0 max_runs to avoid redundent operations.
+        # Starting dag processing with 0 max_runs to avoid redundant operations.
         processor_agent = DagFileProcessorAgent(test_dag_path,
                                                 [],
                                                 0,


 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li></ol></div></div></html>