<!DOCTYPE html><html><div class="item-title">
        Item 216
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 [START tutorial]
 [START import_module]
              </div></li><li><div>
                 [END extract]
              </div></li><li><div>
                 [END instantiate_dag]
              </div></li><li><div>
                 [END default_args]
              </div></li><li><div>
                 [START transform]
              </div></li><li><div>
                 [START extract]
              </div></li><li><div>
                 [START instantiate_dag]
              </div></li><li><div><div><b>comment:</b>  [START documentation]
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                 The DAG object; we'll need this to instantiate a DAG
              </div></li><li><div><div><b>comment:</b>  [END documentation]
                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>comment:</b>  [END tutorial]
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                 [START default_args]
 These args will get passed on to each operator
 You can override them on a per-task basis during operator initialization
              </div></li><li><div>
                
 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.
              </div></li><li><div>
                 [END load]
              </div></li><li><div>
                 pylint: disable=missing-function-docstring
              </div></li><li><div>
                 [START load]
              </div></li><li><div>
                 [START main_flow]
              </div></li><li><div>
                 [END main_flow]
              </div></li><li><div>
                 [END import_module]
              </div></li><li><div>
                 [END transform]
              </div></li><li><div>
                 [START tutorial]
 [START import_module]
              </div></li><li><div>
                 [END default_args]
              </div></li><li><div>
                 [START instantiate_dag]
              </div></li><li><div>
                 Operators; we need this to operate!
              </div></li><li><div>
                 [END load_function]
              </div></li><li><div>
                 The DAG object; we'll need this to instantiate a DAG
              </div></li><li><div><div><b>comment:</b>  [END documentation]
                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>comment:</b>  [END instantiate_dag]
 [START documentation]
                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>comment:</b>  [END tutorial]
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                 [END extract_function]
              </div></li><li><div>
                 [START default_args]
 These args will get passed on to each operator
 You can override them on a per-task basis during operator initialization
              </div></li><li><div>
                
 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.
              </div></li><li><div>
                 [END transform_function]
              </div></li><li><div>
                 [START transform_function]
              </div></li><li><div>
                 [START load_function]
              </div></li><li><div>
                 pylint: disable=missing-function-docstring
              </div></li><li><div>
                 [START main_flow]
              </div></li><li><div>
                 [END main_flow]
              </div></li><li><div>
                 [START extract_function]
              </div></li><li><div>
                 [END import_module]
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Airflow tutorial to use Decorated Flows (#11308)
                </div><div><b>message:</b> Airflow tutorial to use Decorated Flows (#11308)

Created a new Airflow tutorial to use Decorated Flows (a.k.a. functional
DAGs). Also created a DAG to perform the same operations without using
functional DAGs to be compatible with Airflow 1.10.x and to show the
difference.

* Apply suggestions from code review

It makes sense to simplify the return variables being passed around without needlessly converting to JSON and then reconverting back.

* Update tutorial_functional_etl_dag.py

Fixed data passing between tasks to be more natural without converting to JSON and converting back to variables.

* Updated dag options and task doc formating

Based on feedback on the PR, updated the DAG options (including schedule) and the fixed the task documentation to avoid indentation.

* Added documentation file for functional dag tutorial

Added the tutorial documentation to the docs directory. Fixed linting errors in the example dags.
Tweaked some doc references in the example dags for inclusion into the tutorial documentation.
Added the example dags to example tests.

* Removed multiple_outputs from task defn

Had a multiple_outputs=True defined in the Extract task defn, which was unnecessary. - Removed based on feedback.

Co-authored-by: Gerard Casas Saez &lt;casassg@users.noreply.github.com&gt;
Co-authored-by: Kaxil Naik &lt;kaxilnaik@gmail.com&gt;
Co-authored-by: Ash Berlin-Taylor &lt;ash_github@firemirror.com&gt;
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol><li><div><div><b>title:</b> [AIP-31] Update Airflow tutorial to use functional DAGs
                </div><div><b>body:</b> 
**Description**

Change Airflow tutorial (or create new tutorial) using the new functional layer.

**Use case / motivation**

Help users onboard Airflow by reducing the complexity of the tutorial by adopting the new functional DAG definition layer.

**Related Issues**

Blocked by #8057

                </div></div></li><li><div><div><b>title:</b> [AIP-31] Update Airflow tutorial to use functional DAGs
                </div><div><b>body:</b> 
**Description**

Change Airflow tutorial (or create new tutorial) using the new functional layer.

**Use case / motivation**

Help users onboard Airflow by reducing the complexity of the tutorial by adopting the new functional DAG definition layer.

**Related Issues**

Blocked by #8057

                </div></div></li><li><div><div><b>title:</b> [AIP-31] Update Airflow tutorial to use functional DAGs
                </div><div><b>body:</b> 
**Description**

Change Airflow tutorial (or create new tutorial) using the new functional layer.

**Use case / motivation**

Help users onboard Airflow by reducing the complexity of the tutorial by adopting the new functional DAG definition layer.

**Related Issues**

Blocked by #8057

                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>title:</b> [AIP-31] Update Airflow tutorial to use functional DAGs
                </div><div><b>body:</b> 
**Description**

Change Airflow tutorial (or create new tutorial) using the new functional layer.

**Use case / motivation**

Help users onboard Airflow by reducing the complexity of the tutorial by adopting the new functional DAG definition layer.

**Related Issues**

Blocked by #8057

                </div></div></li><li><div><div><b>title:</b> [AIP-31] Update Airflow tutorial to use functional DAGs
                </div><div><b>body:</b> 
**Description**

Change Airflow tutorial (or create new tutorial) using the new functional layer.

**Use case / motivation**

Help users onboard Airflow by reducing the complexity of the tutorial by adopting the new functional DAG definition layer.

**Related Issues**

Blocked by #8057

                </div></div></li><li><div><div><b>title:</b> [AIP-31] Update Airflow tutorial to use functional DAGs
                </div><div><b>body:</b> 
**Description**

Change Airflow tutorial (or create new tutorial) using the new functional layer.

**Use case / motivation**

Help users onboard Airflow by reducing the complexity of the tutorial by adopting the new functional DAG definition layer.

**Related Issues**

Blocked by #8057

                </div><div><b>label:</b> documentation
                </div></div></li></ol></div><div><b>github_issues_comments:</b> <ol><li><div>
                @casassg @turbaszek Can one you create a Github issue for the "dag" decorator -- looks like that is the only other pieces missing for Airflow 2.0 with regards to Functional DAGs apart from other tickets mentioned in https://github.com/apache/airflow/labels/AIP-31
              </div></li><li><div>
                I think the guide should present a functional and functional approach. These are two different approaches and have different use cases. This is not a 1 to 1 alternative.
              </div></li><li><div><div><b>body:</b> This specific issue is about the main tutorial. I think that one benefits from having a unique style (I prefer functional as its easier). We should add a guide for both styles though
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                Vikram has volunteered to tackle this
              </div></li></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> Airflow tutorial to use functional DAGs
                </div><div><b>body:</b> Created a new Airflow ETL tutorial to use functional DAGs. Also created a DAG to perform the same operations without using functional DAGs to be compatible with Airflow 1.10.x and to show the difference between the "functional" and the "classic" ways side by side to illustrate the differences. 

I tried to make this simple and not rely on any operators. I will create the html documentation page to cover this as soon as I get confirmation from @casassg and @turbaszek that this is in the right general direction. Also tagging @ashb for general review. 

closes: #9041 

&lt;!--
Thank you for contributing! Please make sure that your code changes
are covered with tests. And in case of new features or big changes
remember to adjust the documentation.

Feel free to ping committers for the review!

In case of existing issue, reference it using one of the following:

How to write a good git commit message:
http://chris.beams.io/posts/git-commit/
--&gt;

---
**^ Add meaningful description above**

Read the **[Pull Request Guidelines](https://github.com/apache/airflow/blob/master/CONTRIBUTING.rst#pull-request-guidelines)** for more information.
In case of fundamental code change, Airflow Improvement Proposal ([AIP](https://cwiki.apache.org/confluence/display/AIRFLOW/Airflow+Improvements+Proposals)) is needed.
In case of a new dependency, check compliance with the [ASF 3rd Party License Policy](https://www.apache.org/legal/resolved.html#category-x).
In case of backwards incompatible changes please leave a note in [UPDATING.md](https://github.com/apache/airflow/blob/master/UPDATING.md).

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                [The Build Workflow run](https://github.com/apache/airflow/actions/runs/291706945) is cancelling this PR. It has some failed jobs matching ^Pylint$,^Static checks$,^Build docs$,^Spell check docs$,^Backport packages$,^Checks: Helm tests$,^Test OpenAPI*.
              </div></li><li><div>
                @vikramkoka I think this a good example 👍 
              </div></li><li><div><div><b>body:</b> Looks good. I would try to use multiple outputs better instead of json dumping and such. That feels against what we have been trying to do. Lets return dictionary and load the number directly
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> A thought: should add somewhere the `get_current_context` function, just to showcase? 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                &gt; Looks good. I would try to use multiple outputs better instead of json dumping and such. That feels against what we have been trying to do. Lets return dictionary and load the number directly

Thank you both for the detailed, prompt feedback! I really appreciate it and will make the changes.
              </div></li><li><div><div><b>body:</b> (note that you may need to clean up code, my code suggestions was mostly to point how to use it)

Also, may be interesting to add a unit test that executes the DAG end to end?
                </div><div><b>label:</b> test
                </div></div></li><li><div>
                &gt; (note that you may need to clean up code, my code suggestions was mostly to point how to use it)
&gt; 
&gt; Also, may be interesting to add a unit test that executes the DAG end to end?

Yes, absolutely. Will make the changes and keep updating the PR, just so that you have the visibility. 
              </div></li><li><div>
                &gt; A thought: should add somewhere the `get_current_context` function, just to showcase?

Your point is well taken and I should have stated up front, that I would like to add one more example which is more complex which contains both the 'get_current_context', as well as a BashOperator to demonstrate how to use functional Dags with non-python (more classic) operators. 

              </div></li><li><div>
                &gt; Also, may be interesting to add a unit test that executes the DAG end to end?

Plus +1 for that, this should be simple as adding this DAG id to:
https://github.com/apache/airflow/blob/b0fcf675595494b306800e1a516548dc0dc671f8/tests/test_example_dags_system.py#L24-L31

              </div></li><li><div>
                [The Workflow run](https://github.com/apache/airflow/actions/runs/296218970) is cancelling this PR. It has some failed jobs matching ^Pylint$,^Static checks$,^Build docs$,^Spell check docs$,^Backport packages$,^Checks: Helm tests$,^Test OpenAPI*.
              </div></li><li><div>
                [The Workflow run](https://github.com/apache/airflow/actions/runs/297764608) is cancelling this PR. It has some failed jobs matching ^Pylint$,^Static checks$,^Build docs$,^Spell check docs$,^Backport packages$,^Checks: Helm tests$,^Test OpenAPI*.
              </div></li><li><div>
                [The Workflow run](https://github.com/apache/airflow/actions/runs/297870967) is cancelling this PR. It has some failed jobs matching ^Pylint$,^Static checks$,^Build docs$,^Spell check docs$,^Backport packages$,^Checks: Helm tests$,^Test OpenAPI*.
              </div></li><li><div>
                [The Workflow run](https://github.com/apache/airflow/actions/runs/297929320) is cancelling this PR. It has some failed jobs matching ^Pylint$,^Static checks$,^Build docs$,^Spell check docs$,^Backport packages$,^Checks: Helm tests$,^Test OpenAPI*.
              </div></li><li><div>
                [The Workflow run](https://github.com/apache/airflow/actions/runs/297982033) is cancelling this PR. It has some failed jobs matching ^Pylint$,^Static checks$,^Build docs$,^Spell check docs$,^Backport packages$,^Checks: Helm tests$,^Test OpenAPI*.
              </div></li><li><div>
                [The Workflow run](https://github.com/apache/airflow/actions/runs/297983787) is cancelling this PR. It has some failed jobs matching ^Pylint$,^Static checks$,^Build docs$,^Spell check docs$,^Backport packages$,^Checks: Helm tests$,^Test OpenAPI*.
              </div></li><li><div>
                Ran tests local (this time on the _right_ commit) so merging.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Will we use the whole example in docs? If yes this is ok 👌 
              </div></li><li><div>
                Should we limit this to minimum? 
              </div></li><li><div>
                I'm personally in favor of using `None` as schedule in most of examples because when users turn on one the example DAG scheduler will not try to create multiple runs
              </div></li><li><div>
                Should we move this to DAG invocation?
              </div></li><li><div>
                We should use `@task()` decorator instead of `PythonOperator`, that was the main point of functional DAGs
              </div></li><li><div>
                If I'm not mistaken we should be able to do:
```
@task(doc_md="here goes the docs")
def extract(**kwargs):
    ...
```

              </div></li><li><div>
                If we want to show the functional approach in full swing we should use:
```python
from airflow.operators.python import get_current_context

def extract():
    ctx = get_current_context()
    ti = ctx['ti']
    ...
```
              </div></li><li><div>
                Ok, I see it 😄 
              </div></li><li><div>
                If I'm not mistaken we should be able to do:
```
@task(doc_md="here goes the docs")
def extract(**kwargs):
    ...
```

              </div></li><li><div><div><b>body:</b> I'm wondering if it would be better to define the task before DAG so they can be reusable? No strong opinion here
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> And there will be indentation unless we do:
```suggestion
#### Transform task
A simple Transform task which takes in the collection of order data and computes
the total order value.
"""
```
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I would return directly the dictionary and use `multiple_outputs=True` instead. See: https://github.com/apache/airflow/blob/master/tests/operators/test_python.py#L357 
              </div></li><li><div>
                ```suggestion
    @dag.task(multiple_outputs=True)
```
              </div></li><li><div>
                ```suggestion
        return {"total_order_value": total_order_value}
```
              </div></li><li><div>
                ```suggestion
    load(order_summary["total_order_value"])
```
              </div></li><li><div><div><b>body:</b> Yes, I was planning on using the whole example in the docs, unless there were objections to that. 
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                I am fine with that. 
              </div></li><li><div>
                That sentiment makes sense to me, I am fine with that. Will make the change
              </div></li><li><div>
                That makes sense. I will make the change. 
              </div></li><li><div>
                I just did a commit with these changes for both files. 
              </div></li><li><div>
                I just did a commit with these changes for both files. 
              </div></li><li><div>
                I just did a commit with these changes for all tasks in both files. 
              </div></li><li><div>
                I would prefer to leave it inside the DAG, if that's ok with you. 
              </div></li><li><div>
                ```suggestion
```

Since we are using `@dag.task`
              </div></li><li><div><div><b>body:</b> These two lines are the source of the `expected an indented block (comment)` error -- I don't know if we can indent them without messing up the inclusion in docs. Hmmm
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                This one doesn't need multiple_outputs
              </div></li><li><div><div><b>body:</b> Thanks @casassg , got a little confused on this when reading the code in PythonOperator - changed this now. 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> You can do 
```suggestion
    @dag.task
```
which is cleaner imo
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                ```suggestion
    @dag.task
```
              </div></li><li><div>
                Would be nice to have this point to https://github.com/apache/airflow/blob/master/docs/concepts.rst#functional-dags and https://github.com/apache/airflow/blob/master/docs/concepts.rst#functional-dags more specifically. 

Also, it may be interesting to link the AIP-31 for more insight into this and potentially my talk and Jonathan's article as learn more resources? CC @turbaszek for thoughts
              </div></li><li><div>
                I think this creates mypy issues https://github.com/apache/airflow/pull/10930#discussion_r489375827 :&lt;
              </div></li><li><div>
                +1 for linking AIP and this article for more insight:
https://medium.com/databand-ai/aip-31-airflow-functional-dag-definition-b34852a632d0
              </div></li><li><div><div><b>body:</b> I added the links to the AIP and to the Functional DAGs section of the Concept doc. 

I was not sure if it was ok to add a link to an external site which has a paywall (Medium) from the Apache open source docs, so did not add that. 
                </div><div><b>label:</b> documentation
                </div></div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>