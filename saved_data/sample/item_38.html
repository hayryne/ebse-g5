<!DOCTYPE html><html><div class="item-title">
        Item 38
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 make sure its just over; verify it'll split
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HBASE-13412 Region split decisions should have jitter
                </div><div><b>message:</b> HBASE-13412 Region split decisions should have jitter

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Region split decisions should have jitter
                </div><div><b>description:</b> Whenever a region splits it causes lots of IO (compactions are queued for a while). Because of this it's important to make sure that well distributed tables don't have all of their regions split at exactly the same time.

This is basically the same as our compaction jitter.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Use ThreadLocalRandom rather than make your own?

Having regions split at different sizes is going to confuse operators?
              </div></li><li><div><div><b>body:</b> {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12723391/HBASE-13412.patch
  against master branch at commit 057499474c346b28ad5ac3ab7da420814eba547d.
  ATTACHMENT ID: 12723391

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 hadoop versions{color}. The patch compiles with all supported hadoop versions (2.4.1 2.5.2 2.6.0)

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 protoc{color}.  The applied patch does not increase the total number of protoc compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 checkstyle{color}.  The applied patch does not increase the total number of checkstyle errors

    {color:green}+1 findbugs{color}.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 lineLengths{color}.  The patch does not introduce lines longer than 100

  {color:green}+1 site{color}.  The mvn site goal succeeds with this patch.

     {color:red}-1 core tests{color}.  The patch failed these unit tests:
                       org.apache.hadoop.hbase.regionserver.TestRegionSplitPolicy

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/13583//testReport/
Release Findbugs (version 2.0.3) 	warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/13583//artifact/patchprocess/newFindbugsWarnings.html
Checkstyle Errors: https://builds.apache.org/job/PreCommit-HBASE-Build/13583//artifact/patchprocess/checkstyle-aggregate.html

  Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/13583//console

This message is automatically generated.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> [~stack] Not a fan of ThreadLocals. These tend to hang around. You concerned about the overhead of creating one?
[~eclark] Is the logic correct?
{code}
+    double sizeJitter = conf.getDouble("hbase.hregion.max.filesize.jitter", 0.02D);
+    this.desiredMaxFileSize = (long)(desiredMaxFileSize * (RANDOM.nextFloat() - 0.5D) * sizeJitter);
{code}

You mean:
{code}
+    double sizeJitter = conf.getDouble("hbase.hregion.max.filesize.jitter", 0.02D);
+    this.desiredMaxFileSize += (long)(desiredMaxFileSize * (RANDOM.nextFloat() - 0.5D) * sizeJitter);
{code}
(note the +=)
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                bq. stack Not a fan of ThreadLocals. These tend to hang around. You concerned about the overhead of creating one?

This suggestion is a mistake on my part. I misunderstood. Please ignore.
              </div></li><li><div><div><b>body:</b> You are correct the logic is missing the +.... Just a typo.
Patch coming with tests.
                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>body:</b> Patch without the embarrassing typo :-)
Also fixed the test to account for jitter. Submitting to see if any other tests rely on exact number for splits.
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                Hamcrest sometimes works and other times doesn't.
Seems like an issue with ordering of classpath of test dependencies. So this doesn't use hamcrest at all.
              </div></li><li><div><div><b>body:</b> {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12723503/HBASE-13412-v1.patch
  against master branch at commit 8c740f43093671cfd4cc2b1052d8556e0d492c13.
  ATTACHMENT ID: 12723503

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 4 new or modified tests.

    {color:green}+1 hadoop versions{color}. The patch compiles with all supported hadoop versions (2.4.1 2.5.2 2.6.0)

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 protoc{color}.  The applied patch does not increase the total number of protoc compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

                {color:red}-1 checkstyle{color}.  The applied patch generated 1922 checkstyle errors (more than the master's current 1921 errors).

    {color:green}+1 findbugs{color}.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 lineLengths{color}.  The patch does not introduce lines longer than 100

  {color:green}+1 site{color}.  The mvn site goal succeeds with this patch.

     {color:red}-1 core tests{color}.  The patch failed these unit tests:
                       org.apache.hadoop.hbase.regionserver.TestRegionSplitPolicy

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/13588//testReport/
Release Findbugs (version 2.0.3) 	warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/13588//artifact/patchprocess/newFindbugsWarnings.html
Checkstyle Errors: https://builds.apache.org/job/PreCommit-HBASE-Build/13588//artifact/patchprocess/checkstyle-aggregate.html

                Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/13588//console

This message is automatically generated.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12723505/HBASE-13412-v2.patch
  against master branch at commit 8c740f43093671cfd4cc2b1052d8556e0d492c13.
  ATTACHMENT ID: 12723505

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 4 new or modified tests.

    {color:green}+1 hadoop versions{color}. The patch compiles with all supported hadoop versions (2.4.1 2.5.2 2.6.0)

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 protoc{color}.  The applied patch does not increase the total number of protoc compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

                {color:red}-1 checkstyle{color}.  The applied patch generated 1922 checkstyle errors (more than the master's current 1921 errors).

    {color:green}+1 findbugs{color}.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 lineLengths{color}.  The patch does not introduce lines longer than 100

  {color:green}+1 site{color}.  The mvn site goal succeeds with this patch.

    {color:green}+1 core tests{color}.  The patch passed unit tests in .

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/13589//testReport/
Release Findbugs (version 2.0.3) 	warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/13589//artifact/patchprocess/newFindbugsWarnings.html
Checkstyle Errors: https://builds.apache.org/job/PreCommit-HBASE-Build/13589//artifact/patchprocess/checkstyle-aggregate.html

                Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/13589//console

This message is automatically generated.
              </div></li><li><div><div><b>body:</b> Patch to make checkstyle happy.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12723532/HBASE-13412-v3.patch
  against master branch at commit 8c740f43093671cfd4cc2b1052d8556e0d492c13.
  ATTACHMENT ID: 12723532

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 4 new or modified tests.

    {color:green}+1 hadoop versions{color}. The patch compiles with all supported hadoop versions (2.4.1 2.5.2 2.6.0)

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 protoc{color}.  The applied patch does not increase the total number of protoc compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 checkstyle{color}.  The applied patch does not increase the total number of checkstyle errors

    {color:green}+1 findbugs{color}.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 lineLengths{color}.  The patch does not introduce lines longer than 100

  {color:green}+1 site{color}.  The mvn site goal succeeds with this patch.

    {color:green}+1 core tests{color}.  The patch passed unit tests in .

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/13590//testReport/
Release Findbugs (version 2.0.3) 	warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/13590//artifact/patchprocess/newFindbugsWarnings.html
Checkstyle Errors: https://builds.apache.org/job/PreCommit-HBASE-Build/13590//artifact/patchprocess/checkstyle-aggregate.html

  Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/13590//console

This message is automatically generated.
              </div></li><li><div><div><b>body:</b> bq.Having regions split at different sizes is going to confuse operators?
Since regions split on the size of a single store file it's already pretty hard to tell exactly when a region will split. So I don't think that adding a little more uncertainty around the timing of an already background process is too awful. Though it is configurable if someone would ever want to turn it off.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Ok. +1. Test is a little anemic but will do.
              </div></li><li><div>
                Thanks for review. I'll try and get a better test for this together.
              </div></li><li><div>
                FAILURE: Integrated in HBase-1.1 #374 (See [https://builds.apache.org/job/HBase-1.1/374/])
HBASE-13412 Region split decisions should have jitter (eclark: rev bbdd50b9c5ad958bfb56f21ef2fdbc057de22f54)
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java
* hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java

              </div></li><li><div>
                FAILURE: Integrated in HBase-TRUNK #6355 (See [https://builds.apache.org/job/HBase-TRUNK/6355/])
HBASE-13412 Region split decisions should have jitter (eclark: rev b6756b39c2ff5675f96a6e82dc4d68ec437f01c4)
* hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java

              </div></li><li><div>
                hey [~eclark] --  this patch may have made trunk flakey.  3 of the last 4 last the jenkins builds [1] [2] [3] hitting TestRegionSplitPolicy.testIncreasingToupperBoundRegionSplitPolicy failures.  

I've run local and it is flakey, and after reverting locally it seems to pass consistently. 

[1] https://builds.apache.org/view/H-L/view/HBase/job/HBase-TRUNK/6356/testReport/
[2]https://builds.apache.org/view/H-L/view/HBase/job/HBase-TRUNK/6357/testReport/
[3]https://builds.apache.org/view/H-L/view/HBase/job/HBase-TRUNK/6358/testReport/


              </div></li><li><div>
                Yep looking now.
              </div></li><li><div>
                I think it is a test problem 

Based on :

{code}
Mockito.doReturn((long)(maxSplitSize * 1.025 + 1)).when(mockStore).getSize();
{code}


{code}
   double jitter = conf.getDouble("hbase.hregion.max.filesize.jitter", 0.25D);
   this.desiredMaxFileSize += (long)(desiredMaxFileSize * (RANDOM.nextFloat() - 0.5D) * jitter);
{code}

I think 1.025 should be 1.25.
              </div></li><li><div>
                with the addendum patch, the failing unit test passed for me 5x in a row.
              </div></li><li><div>
                You guys found this too. Let me close HBASE-13432. Thanks.
              </div></li><li><div>
                [~eclark] - look good to you?  
              </div></li><li><div>
                lgtm thanks. Sorry I didn't catch this the first time.
              </div></li><li><div>
                Want me to commit or are you?
              </div></li><li><div>
                I got it.
              </div></li><li><div>
                I've committed the addendum to branch-1 and master.
              </div></li><li><div>
                Thanks for the help [~jmhsieh] and [~ndimiduk]
              </div></li><li><div>
                FAILURE: Integrated in HBase-TRUNK #6360 (See [https://builds.apache.org/job/HBase-TRUNK/6360/])
HBASE-13412 ADDENDUM Region split decisions should have jitter (jmhsieh: rev e2a90a71143f480621ccd935a0b9477d7ee4016f)
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java

              </div></li><li><div>
                FAILURE: Integrated in HBase-1.1 #381 (See [https://builds.apache.org/job/HBase-1.1/381/])
HBASE-13412 ADDENDUM Region split decisions should have jitter (jmhsieh: rev c2bfddac136008ca1be00031aaf83f6f35792476)
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java

              </div></li><li><div>
                Both the original commit and addendum picked back to 0.98 cleanly and the new test passes repeatedly (ran it 10 times)

This change introduces a new configuration parameter and a behavioral change for ConstantSizeRegionSplitPolicy and policies that inherit from it. The change is desirable (it's the raison d'etre of this issue) but to alleviate any compatibility concerns I committed an addendum to 0.98 only that will not apply jitter unless the new configuration parameter is explicitly set.
              </div></li><li><div>
                FAILURE: Integrated in HBase-0.98 #983 (See [https://builds.apache.org/job/HBase-0.98/983/])
HBASE-13412 Region split decisions should have jitter (apurtell: rev d19b5cdae378bcbaa5e7b248359d6251d115ed83)
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java
* hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java
HBASE-13412 ADDENDUM Region split decisions should have jitter (apurtell: rev ee725689641d6e61146cb3be77e3f29fa5f54606)
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java
HBASE-13412 ADDENDUM Region split decisions should have jitter (apurtell: rev dfc066ee83243695b27231af2a0be5cddefa4fb1)
* hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java

              </div></li><li><div>
                FAILURE: Integrated in HBase-0.98-on-Hadoop-1.1 #935 (See [https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/935/])
HBASE-13412 Region split decisions should have jitter (apurtell: rev d19b5cdae378bcbaa5e7b248359d6251d115ed83)
* hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java
HBASE-13412 ADDENDUM Region split decisions should have jitter (apurtell: rev ee725689641d6e61146cb3be77e3f29fa5f54606)
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java
HBASE-13412 ADDENDUM Region split decisions should have jitter (apurtell: rev dfc066ee83243695b27231af2a0be5cddefa4fb1)
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java
* hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java

              </div></li><li><div>
                Hadoop 1 doesn't have Configuration#getDouble, use floats instead to fix the Hadoop 1 build.
              </div></li><li><div>
                FAILURE: Integrated in HBase-0.98 #985 (See [https://builds.apache.org/job/HBase-0.98/985/])
HBASE-13412 ADDENDUM Region split decisions should have jitter (apurtell: rev 06e0e47cab8cab09725dd850a65264f2f2317465)
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java
* hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java

              </div></li><li><div>
                SUCCESS: Integrated in HBase-0.98-on-Hadoop-1.1 #936 (See [https://builds.apache.org/job/HBase-0.98-on-Hadoop-1.1/936/])
HBASE-13412 ADDENDUM Region split decisions should have jitter (apurtell: rev 06e0e47cab8cab09725dd850a65264f2f2317465)
* hbase-server/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionSplitPolicy.java
* hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java

              </div></li><li><div>
                Closing issues released in 1.1.0.
              </div></li></ol></div></div></html>