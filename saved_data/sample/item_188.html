<!DOCTYPE html><html><div class="item-title">
        Item 188
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
	 * Notifies a partition created.
	 
              </div></li><li><div>
                 repeat partition 1
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [FLINK-20213][fs-connector] Partition commit is delayed when records keep coming
                </div><div><b>message:</b> [FLINK-20213][fs-connector] Partition commit is delayed when records keep coming

This closes #14442
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [FLINK-20213][fs-connector] Partition commit is delayed when records keep coming
                </div><div><b>body:</b> ## What is the purpose of the change

When set partition-commit.delay=0, Users expect partitions to be committed immediately.

However, if the record of this partition continues to flow in, the bucket for the partition will be activated, and no inactive bucket will appear.

## Brief change log

Consider listening to bucket created.

Collect partitions from bucket created listener. Emit partitions when notify checkpoint complete.

## Verifying this change

`StreamingFileWriterTest`

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): no
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no
  - The serializers: no
  - The runtime per-record code paths (performance sensitive): no
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no
  - The S3 file system connector: no

## Documentation

  - Does this pull request introduce a new feature? no
                </div></div></li><li><div><div><b>title:</b> [FLINK-20213][fs-connector] Partition commit is delayed when records keep coming
                </div><div><b>body:</b> ## What is the purpose of the change

When set partition-commit.delay=0, Users expect partitions to be committed immediately.

However, if the record of this partition continues to flow in, the bucket for the partition will be activated, and no inactive bucket will appear.

## Brief change log

Consider listening to bucket created.

Collect partitions from bucket created listener. Emit partitions when notify checkpoint complete.

## Verifying this change

`StreamingFileWriterTest`

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): no
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no
  - The serializers: no
  - The runtime per-record code paths (performance sensitive): no
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no
  - The S3 file system connector: no

## Documentation

  - Does this pull request introduce a new feature? no
                </div></div></li><li><div><div><b>title:</b> [FLINK-20213][fs-connector] Partition commit is delayed when records keep coming
                </div><div><b>body:</b> ## What is the purpose of the change

When set partition-commit.delay=0, Users expect partitions to be committed immediately.

However, if the record of this partition continues to flow in, the bucket for the partition will be activated, and no inactive bucket will appear.

## Brief change log

Consider listening to bucket created.

Collect partitions from bucket created listener. Emit partitions when notify checkpoint complete.

## Verifying this change

`StreamingFileWriterTest`

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): no
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no
  - The serializers: no
  - The runtime per-record code paths (performance sensitive): no
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Kubernetes/Yarn/Mesos, ZooKeeper: no
  - The S3 file system connector: no

## Documentation

  - Does this pull request introduce a new feature? no
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                cherry-pick from: https://github.com/apache/flink/pull/14116
              </div></li><li><div>
                Thanks a lot for your contribution to the Apache Flink project. I'm the @flinkbot. I help the community
to review your pull request. We will use this comment to track the progress of the review.


## Automated Checks
Last check on commit 52804c37471c684b18d828d79338e443e1cbe1f1 (Mon Dec 21 07:23:52 UTC 2020)

**Warnings:**
 * No documentation files were touched! Remember to keep the Flink docs up to date!


&lt;sub&gt;Mention the bot in a comment to re-run the automated checks.&lt;/sub&gt;
## Review Progress

* ❓ 1. The [description] looks good.
* ❓ 2. There is [consensus] that the contribution should go into to Flink.
* ❓ 3. Needs [attention] from.
* ❓ 4. The change fits into the overall [architecture].
* ❓ 5. Overall code [quality] is good.

Please see the [Pull Request Review Guide](https://flink.apache.org/contributing/reviewing-prs.html) for a full explanation of the review process.&lt;details&gt;
 The Bot is tracking the review progress through labels. Labels are applied according to the order of the review items. For consensus, approval by a Flink committer of PMC member is required &lt;summary&gt;Bot commands&lt;/summary&gt;
  The @flinkbot bot supports the following commands:

 - `@flinkbot approve description` to approve one or more aspects (aspects: `description`, `consensus`, `architecture` and `quality`)
 - `@flinkbot approve all` to approve all aspects
 - `@flinkbot approve-until architecture` to approve everything until `architecture`
 - `@flinkbot attention @username1 [@username2 ..]` to require somebody's attention
 - `@flinkbot disapprove architecture` to remove an approval you gave earlier
&lt;/details&gt;
              </div></li><li><div>
                &lt;!--
Meta data
{
  "version" : 1,
  "metaDataEntries" : [ {
    "hash" : "99b3b8824b9991e9906cd6ab4e38a6766e34f0cf",
    "status" : "SUCCESS",
    "url" : "https://dev.azure.com/apache-flink/98463496-1af2-4620-8eab-a2ecc1a2e6fe/_build/results?buildId=11100",
    "triggerID" : "99b3b8824b9991e9906cd6ab4e38a6766e34f0cf",
    "triggerType" : "PUSH"
  } ]
}--&gt;
## CI report:

* 99b3b8824b9991e9906cd6ab4e38a6766e34f0cf Azure: [SUCCESS](https://dev.azure.com/apache-flink/98463496-1af2-4620-8eab-a2ecc1a2e6fe/_build/results?buildId=11100) 

&lt;details&gt;
&lt;summary&gt;Bot commands&lt;/summary&gt;
  The @flinkbot bot supports the following commands:

 - `@flinkbot run travis` re-run the last Travis build
 - `@flinkbot run azure` re-run the last Azure build
&lt;/details&gt;
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Partition commit is delayed when records keep coming
                </div><div><b>description:</b> When set partition-commit.delay=0,&nbsp;Users expect partitions to be committed immediately.

However, if the record of this partition continues to flow in, the bucket for the partition will be activated, and no inactive bucket will appear.

We need to consider listening to bucket created.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                [~lzljs3620320]&nbsp;Hello, we get your PR&nbsp; and&nbsp; test it in Partition-Time tigger ,&nbsp; and we find that the hive partition is commited before the data is written finished .

perhaps it has some other problems.
              </div></li><li><div>
                [~zouyunhe]&nbsp;Thanks for you feedback, Can you check the watermark is correct?
              </div></li><li><div><div><b>body:</b> [~lzljs3620320]&nbsp; We found the watermark as below, the time is about 2020-11-25 21:53:02

!image-2020-11-26-12-00-23-542.png!

&nbsp;

And we see the data write in hive partition , the _SUCCESS file has been writeen finished.

!image-2020-11-26-12-00-55-829.png!

But Some in-progress file was not finished, which mean this paritition is not finished.
                </div><div><b>label:</b> requirement
                </div></div></li><li><div>
                [~zouyunhe] What is the delay?
              </div></li><li><div>
                [~lzljs3620320]&nbsp;the commit delay is 1 min, the tblproperties&nbsp;

'partition.time-extractor.timestamp-pattern'='$day $hour:00:00', 
 'sink.partition-commit.delay'='1 min', 
 'sink.partition-commit.policy.kind'='metastore,success-file', 
 'sink.partition-commit.trigger'='partition-time',
              </div></li><li><div>
                Hi [~zouyunhe], I think your correct commit delay should be 1 hour plus 1min
              </div></li><li><div>
                [~lzljs3620320]&nbsp;OK
              </div></li><li><div>
                release-1.11:&nbsp;75b759d6a3a7e193521ab7f0c738b9faf908601c

release-1.12:&nbsp;8a9b632dfc41e20b35c85b357f9ae5cfc2f70fff

master (1.13):&nbsp;a046ee8f2d1944d3c1f45f24bb14eb53682a3b09
              </div></li></ol></div></div></html>