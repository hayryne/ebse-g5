<!DOCTYPE html><html><div class="item-title">
        Item 273
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> PHOENIX-930 duplicated columns cause query exception and drop table exception (Junegunn Choi, Kalyan Hadoop)
                </div><div><b>message:</b> PHOENIX-930 duplicated columns cause query exception and drop table exception (Junegunn Choi, Kalyan Hadoop)

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> duplicated columns cause query exception and drop table exception
                </div><div><b>description:</b> when I create table like this: "create table test (id varchar not null primary key, f.name varchar, f.email varchar, f.email varchar)", this will cause an org.apache.phoenix.schema.ColumnAlreadyExistsException, but the table is successful created.

Then I run a query like "select * from test", an exception is threw:
Caused by: java.lang.ArrayIndexOutOfBoundsException: 3
        at org.apache.phoenix.schema.PTableImpl.init(PTableImpl.java:283)
        at org.apache.phoenix.schema.PTableImpl.&lt;init&gt;(PTableImpl.java:216)
        at org.apache.phoenix.schema.PTableImpl.makePTable(PTableImpl.java:209)
        at org.apache.phoenix.coprocessor.MetaDataEndpointImpl.getTable(MetaDataEndpointImpl.java:443)
        at org.apache.phoenix.coprocessor.MetaDataEndpointImpl.buildTable(MetaDataEndpointImpl.java:254)
        at org.apache.phoenix.coprocessor.MetaDataEndpointImpl.doGetTable(MetaDataEndpointImpl.java:1077)
        at org.apache.phoenix.coprocessor.MetaDataEndpointImpl.getTable(MetaDataEndpointImpl.java:1023)
        ... 10 more

then I try to drop the table: "drop table test", an exception is also threw:
Caused by: java.lang.ArrayIndexOutOfBoundsException: 3
        at org.apache.phoenix.schema.PTableImpl.init(PTableImpl.java:283)
        at org.apache.phoenix.schema.PTableImpl.&lt;init&gt;(PTableImpl.java:216)
        at org.apache.phoenix.schema.PTableImpl.makePTable(PTableImpl.java:209)
        at org.apache.phoenix.coprocessor.MetaDataEndpointImpl.getTable(MetaDataEndpointImpl.java:443)
        at org.apache.phoenix.coprocessor.MetaDataEndpointImpl.buildTable(MetaDataEndpointImpl.java:254)
        at org.apache.phoenix.coprocessor.MetaDataEndpointImpl.doGetTable(MetaDataEndpointImpl.java:1077)
        at org.apache.phoenix.coprocessor.MetaDataEndpointImpl.getTable(MetaDataEndpointImpl.java:1023)
        ... 10 more

So I have to drop SYSTEM.CATALOG, SYSTEM.SEQUENCE from hbase shell……

The ArrayIndexOutOfBoundsException is threw out because the position of f.email column in CATALOG table is not correct. I think it's better to check  columns before creating table.



                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Please reopen if this is still occurring.
              </div></li><li><div>
                Reopening as it's reproducible with the current master.

{code:sql}
create table a (id integer primary key, dupe integer, dupe integer);
drop table a;
{code}

And I can confirm that the suggested patch, which is fairly straightforward, prevents the anomaly. Let me revise the patch with a test case.
              </div></li><li><div><div><b>body:</b> {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12807198/PHOENIX-930.patch
  against master branch at commit 95c004112bae47624f4764154e90cc36a54827f1.
  ATTACHMENT ID: 12807198

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:red}-1 javadoc{color}.  The javadoc tool appears to have generated 31 warning messages.

    {color:red}-1 release audit{color}.  The applied patch generated 4 release audit warnings (more than the master's current 0 warnings).

    {color:green}+1 lineLengths{color}.  The patch does not introduce lines longer than 100

    {color:green}+1 core tests{color}.  The patch passed unit tests in .

Test results: https://builds.apache.org/job/PreCommit-PHOENIX-Build/376//testReport/
Release audit warnings: https://builds.apache.org/job/PreCommit-PHOENIX-Build/376//artifact/patchprocess/patchReleaseAuditWarnings.txt
Javadoc warnings: https://builds.apache.org/job/PreCommit-PHOENIX-Build/376//artifact/patchprocess/patchJavadocWarnings.txt
Console output: https://builds.apache.org/job/PreCommit-PHOENIX-Build/376//console

This message is automatically generated.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> [~junegunn], Why not move hasColumnWithSameNameAndFamily to CreateTableCompiler and check for duplicate columns at compilation time (CreateTableCompiler#compile())? I think this is more straightforward.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                [~william yang] Good point. I'll update the patch shortly.
              </div></li><li><div>
                New patch to address [~yhxx511]'s comment.
              </div></li><li><div>
                New patch without irrelevant EOL change.
              </div></li><li><div>
                {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12807325/PHOENIX-930-v3.patch
  against master branch at commit 386cbbbf7a5dd736888e8e0bfe16e513d54e215c.
  ATTACHMENT ID: 12807325

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 3 new or modified tests.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:red}-1 javadoc{color}.  The javadoc tool appears to have generated 34 warning messages.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 lineLengths{color}.  The patch does not introduce lines longer than 100

    {color:green}+1 core tests{color}.  The patch passed unit tests in .

Test results: https://builds.apache.org/job/PreCommit-PHOENIX-Build/521//testReport/
Javadoc warnings: https://builds.apache.org/job/PreCommit-PHOENIX-Build/521//artifact/patchprocess/patchJavadocWarnings.txt
Console output: https://builds.apache.org/job/PreCommit-PHOENIX-Build/521//console

This message is automatically generated.
              </div></li><li><div>
                Thanks for the patches, [~yhxx511] and [~kalyanhadoop]. Please feel free to remind the community that there's a patch available on an issue, especially before a new RC goes out - would have been happy to lobby for getting this fix into 4.8.0. FYI, I tweaked it a bit to just use a LinkedHashMap to detect if there's a duplicate.

Would you mind review, [~samarthjain]?
              </div></li><li><div>
                Reattaching to get test run
              </div></li><li><div><div><b>body:</b> {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12824663/PHOENIX-930_v4.patch
  against master branch at commit 386cbbbf7a5dd736888e8e0bfe16e513d54e215c.
  ATTACHMENT ID: 12824663

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 2 new or modified tests.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:red}-1 javadoc{color}.  The javadoc tool appears to have generated 34 warning messages.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 lineLengths{color}.  The patch introduces the following lines longer than 100:
    +                    columns = new LinkedHashMap&lt;PColumn,PColumn&gt;(allColumns.size() + colDefs.size());
+                        PNameFactory.newName(QueryConstants.SYSTEM_TABLE_PK_NAME), null, columns.values(), null, null,
+                    final PColumn autoPartitionCol = parent.getPKColumns().get(MetaDataUtil.getAutoPartitionColIndex(parent));
+                        PTable.INITIAL_SEQ_NUM, pkName == null ? null : PNameFactory.newName(pkName), saltBucketNum, columns.values(),
+            Collection&lt;PColumn&gt; columns, PName dataSchemaName, PName dataTableName, List&lt;PTable&gt; indexes,
+            Collection&lt;PColumn&gt; columns, PName dataSchemaName, PName dataTableName, List&lt;PTable&gt; indexes,
+            long timeStamp, long sequenceNumber, PName pkName, Integer bucketNum, Collection&lt;PColumn&gt; columns,
+            PName pkName, Integer bucketNum, Collection&lt;PColumn&gt; columns, PName parentSchemaName, PName parentTableName,
+        PhoenixConnection conn = DriverManager.getConnection(getUrl(), props).unwrap(PhoenixConnection.class);

    {color:green}+1 core tests{color}.  The patch passed unit tests in .

Test results: https://builds.apache.org/job/PreCommit-PHOENIX-Build/525//testReport/
Javadoc warnings: https://builds.apache.org/job/PreCommit-PHOENIX-Build/525//artifact/patchprocess/patchJavadocWarnings.txt
Console output: https://builds.apache.org/job/PreCommit-PHOENIX-Build/525//console

This message is automatically generated.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12824664/PHOENIX-930_v5.patch
  against master branch at commit 386cbbbf7a5dd736888e8e0bfe16e513d54e215c.
  ATTACHMENT ID: 12824664

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 3 new or modified tests.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:red}-1 javadoc{color}.  The javadoc tool appears to have generated 34 warning messages.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 lineLengths{color}.  The patch introduces the following lines longer than 100:
    +                    columns = new LinkedHashMap&lt;PColumn,PColumn&gt;(allColumns.size() + colDefs.size());
+                        PNameFactory.newName(QueryConstants.SYSTEM_TABLE_PK_NAME), null, columns.values(), null, null,
+                    final PColumn autoPartitionCol = parent.getPKColumns().get(MetaDataUtil.getAutoPartitionColIndex(parent));
+                        PTable.INITIAL_SEQ_NUM, pkName == null ? null : PNameFactory.newName(pkName), saltBucketNum, columns.values(),
+            Collection&lt;PColumn&gt; columns, PName dataSchemaName, PName dataTableName, List&lt;PTable&gt; indexes,
+            Collection&lt;PColumn&gt; columns, PName dataSchemaName, PName dataTableName, List&lt;PTable&gt; indexes,
+            long timeStamp, long sequenceNumber, PName pkName, Integer bucketNum, Collection&lt;PColumn&gt; columns,
+            PName pkName, Integer bucketNum, Collection&lt;PColumn&gt; columns, PName parentSchemaName, PName parentTableName,
+        PhoenixConnection conn = DriverManager.getConnection(getUrl(), props).unwrap(PhoenixConnection.class);

    {color:green}+1 core tests{color}.  The patch passed unit tests in .

Test results: https://builds.apache.org/job/PreCommit-PHOENIX-Build/526//testReport/
Javadoc warnings: https://builds.apache.org/job/PreCommit-PHOENIX-Build/526//artifact/patchprocess/patchJavadocWarnings.txt
Console output: https://builds.apache.org/job/PreCommit-PHOENIX-Build/526//console

This message is automatically generated.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                [~samarthjain]?
              </div></li><li><div>
                +1
              </div></li><li><div>
                SUCCESS: Integrated in Jenkins build Phoenix-master #1368 (See [https://builds.apache.org/job/Phoenix-master/1368/])
PHOENIX-930 duplicated columns cause query exception and drop table (jamestaylor: rev b36bb31fe42cb7bf5b6de5bfab63bcad424998a4)
* (edit) phoenix-core/src/main/java/org/apache/phoenix/schema/PTableImpl.java
* (edit) phoenix-core/src/main/java/org/apache/phoenix/schema/MetaDataClient.java
* (edit) phoenix-core/src/it/java/org/apache/phoenix/end2end/index/IndexMetadataIT.java
* (add) phoenix-core/src/test/java/org/apache/phoenix/compile/CreateTableCompilerTest.java

              </div></li><li><div>
                Thanks for the patches, [~yhxx511] and [~kalyanhadoop]. I've pushed the fix to 4.8 and 4.x branches. It'll appear in our 4.8.1 patch release.
              </div></li></ol></div></div></html>