<!DOCTYPE html><html><div class="item-title">
        Item 273
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 menu item should exist matching appbuilder_mitem
              </div></li><li><div>
                 menu link should also have a link matching the name of the package.
              </div></li><li><div>
                 view should have a menu item matching category of v_appbuilder_package
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [AIRFLOW-2744] Allow RBAC to accept plugins for views and links. (#4036)
                </div><div><b>message:</b> [AIRFLOW-2744] Allow RBAC to accept plugins for views and links. (#4036)

Airflow Users that wish to create plugins for the new www_rbac UI
can not add plugin views or links. This PR fixes that by letting
a user specify their plugins for www_rbac and maintains backwards
compatibility with the existing plugins system.
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [AIRFLOW-2744] Allow RBAC to accept plugins for views and links.
                </div><div><b>body:</b> ### Description

Airflow Users that wish to create plugins for the new www_rbac UI can not add plugin views or links. This PR fixes that by letting a user specify their plugins for www_rbac and maintains backwards compatibility with the existing plugins system.

Adds two additional members of an AirflowPlugin class to cover role based views and role based menu items. Specifies that the user can create a dictionary which has the metadata necessary to create a FlaskAppBuilder BaseView or MenuItem. This lets the plugins manager extend to the new www_rbac GUI.

### Tests

Adds unit tests under the plugins manager to test that the www_rbac views and menu links get added successfully.

### Documentation

Demonstrates in the plugins page how a user would create plugins for the new UI with an example. 


                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                # [Codecov](https://codecov.io/gh/apache/incubator-airflow/pull/4036?src=pr&amp;el=h1) Report
&gt; Merging [#4036](https://codecov.io/gh/apache/incubator-airflow/pull/4036?src=pr&amp;el=desc) into [master](https://codecov.io/gh/apache/incubator-airflow/commit/7df4405aa5a0c99e51722321caa7af660d35794b?src=pr&amp;el=desc) will **increase** coverage by `0.02%`.
&gt; The diff coverage is `100%`.

[![Impacted file tree graph](https://codecov.io/gh/apache/incubator-airflow/pull/4036/graphs/tree.svg?width=650&amp;token=WdLKlKHOAU&amp;height=150&amp;src=pr)](https://codecov.io/gh/apache/incubator-airflow/pull/4036?src=pr&amp;el=tree)

```diff
@@            Coverage Diff             @@
##           master    #4036      +/-   ##
==========================================
+ Coverage    77.9%   77.93%   +0.02%     
==========================================
  Files         199      199              
  Lines       15957    15974      +17     
==========================================
+ Hits        12431    12449      +18     
+ Misses       3526     3525       -1
```


| [Impacted Files](https://codecov.io/gh/apache/incubator-airflow/pull/4036?src=pr&amp;el=tree) | Coverage Δ | |
|---|---|---|
| [airflow/plugins\_manager.py](https://codecov.io/gh/apache/incubator-airflow/pull/4036/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9wbHVnaW5zX21hbmFnZXIucHk=) | `91.95% &lt;100%&gt; (+0.59%)` | :arrow_up: |
| [airflow/www\_rbac/app.py](https://codecov.io/gh/apache/incubator-airflow/pull/4036/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy93d3dfcmJhYy9hcHAucHk=) | `97.05% &lt;100%&gt; (+0.35%)` | :arrow_up: |
| [airflow/configuration.py](https://codecov.io/gh/apache/incubator-airflow/pull/4036/diff?src=pr&amp;el=tree#diff-YWlyZmxvdy9jb25maWd1cmF0aW9uLnB5) | `88.84% &lt;0%&gt; (+0.35%)` | :arrow_up: |

------

[Continue to review full report at Codecov](https://codecov.io/gh/apache/incubator-airflow/pull/4036?src=pr&amp;el=continue).
&gt; **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)
&gt; `Δ = absolute &lt;relative&gt; (impact)`, `ø = not affected`, `? = missing data`
&gt; Powered by [Codecov](https://codecov.io/gh/apache/incubator-airflow/pull/4036?src=pr&amp;el=footer). Last update [7df4405...3d6ba68](https://codecov.io/gh/apache/incubator-airflow/pull/4036?src=pr&amp;el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).

              </div></li><li><div>
                not sure why the code coverage has changed so drastically, I added some test cases but it looks like the hits and misses are changing abnormally? Did I miss something?
              </div></li><li><div>
                @oliviersm199 It could be that you've worked from an old master.
              </div></li><li><div>
                @jgao54 Any thoughts on this? :)
              </div></li><li><div>
                Yes merging in master helped fix the code coverage report! Thank you @Fokko.
              </div></li><li><div>
                Hello have the core committers had time to look at this? I know @Fokko requested input from @jgao54, let me know if you need anything from me.  
              </div></li><li><div>
                hey guys,

is there any ETA for this PR?

Btw, could you also update the documentation and release notes for 1.10 to clarify that plugins are not supported at this moment on the new RBAC UI? 
I put some effort on the migration to 1.10 only to rollback because of the lack of support for plugins.
              </div></li><li><div>
                Made the requested changes.
              </div></li><li><div>
                Tests failed due to flake8 style violation:

&gt; ./tests/plugins/test_plugin.py:96:33: E261 at least two spaces before inline comment
              </div></li><li><div>
                @ashb would it be possible to backport this PR into 1.10.x? It would be ideal for us. 
              </div></li><li><div>
                @c4milo yeah it will be in 1.10.1 - check the "Fix Version" on a Jira to see what will be back-ported https://issues.apache.org/jira/browse/AIRFLOW-2744
              </div></li><li><div>
                @oliviersm199 , it seems that PluginRBACTest fails(currently it is disabled) if re-enable. Do you think you have time to fix the test?
              </div></li><li><div>
                We also need to fix the example in the documentation (https://airflow.apache.org/plugins.html#example). It is currently broken: import fails, wrong method name in the view and missing path for templates.

I made a sample project to make this plugin integration work: https://github.com/felipegasparini/airflow_plugin_rbac_test/blob/dbaa049a9996df275b1d90f74b93ffbf206bb1d5/airflow/plugins/test_plugin/test_plugin.py

I will submit a PR to fix the doc later, but just posting it here since it may be useful for others.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Lets call these `appbuilder_views` etc. The "role" is just the reason we switched to FAB.
              </div></li><li><div>
                Changed it to use appbuilder_views etc. 
              </div></li><li><div>
                Style nit: please remove un-related changes like this from the PR.
              </div></li><li><div>
                Style nit: please remove un-related changes like this from the PR.
              </div></li><li><div>
                Remove empty lines.
              </div></li><li><div>
                Please say here what the fields are.
              </div></li><li><div>
                The `-----` should match the length of the line above otherwise RST will complain at us.
              </div></li><li><div>
                This one still needs doing I think?
              </div></li><li><div>
                Hey I thought I changed it but must have made a mistake with git. Please check again :)
              </div></li><li><div>
                This double space is required by flake8.
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> RBAC app doesn't integrate plugins (blueprints etc)
                </div><div><b>description:</b> In the current 1.10.0rc tag, the new RBAC app doesn't integrate any plugins created by a user extending Airflow. In the old www/app.py you had the [integrate_plugins|https://github.com/apache/incubator-airflow/blob/f1083cbada337731ed0b7e27b09eee7a26c8189a/airflow/www/app.py#L126] function. But currently the [www_rbac/app.py|https://github.com/apache/incubator-airflow/blob/f1083cbada337731ed0b7e27b09eee7a26c8189a/airflow/www_rbac/app.py] doesn't pull in any plugins from the plugin_manager. So nothing you do to extend Airflow's webapp will work.

I think adding the code for registering the blueprints and menu links is a pretty simple fix. I'm not sure how the FAB system is handling the same functionality as Flask-Admin views though.

&nbsp;
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                I created a fix&nbsp;in a forked private repo which will allow you to create plugins for the www_rbac UI if you define your&nbsp;plugin views using the flask_appbuilder BaseView or some subclass. It also supports links. However, I feel it doesn't tie the old and new plugins system well together. How should we design this so that both the old plugins and new plugins work? Or should we drop support for the old plugins all together?

I would love to work on this and submit a pull request back to the old project since this is very important for me to get working. However, I'm new to the Airflow project and would like someone to let me know what's the best way to precede with my fix. Should I just make A PR even though I know it's not a perfect solution yet and get some feedback early?
              </div></li><li><div>
                Yes, I'd suggest to submit the PR, you may mark it as "WIP".

Please also note the (short) discussion on the dev mailing list, I don't know if Ian is also already working on it. If possible please also comment there (I can also do if you are not subscribed).
https://lists.apache.org/thread.html/30b9f524ab72743f72c397ea7ee2a8f22e263cbbf4d6c048f4079124@%3Cdev.airflow.apache.org%3E

              </div></li><li><div>
                oliviersm199 opened a new pull request #4036: [AIRFLOW-2744] Allow RBAC to accept plugins for views and links.
URL: https://github.com/apache/incubator-airflow/pull/4036
 
 
   ### Description
   
   Airflow Users that wish to create plugins for the new www_rbac UI can not add plugin views or links. This PR fixes that by letting a user specify their plugins for www_rbac and maintains backwards compatibility with the existing plugins system.
   
   Adds two additional members of an AirflowPlugin class to cover role based views and role based menu items. Specifies that the user can create a dictionary which has the metadata necessary to create a FlaskAppBuilder BaseView or MenuItem. This lets the plugins manager extend to the new www_rbac GUI.
   
   ### Tests
   
   Adds unit tests under the plugins manager to test that the www_rbac views and menu links get added successfully.
   
   ### Documentation
   
   Demonstrates in the plugins page how a user would create plugins for the new UI with an example. 
   
   

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                ashb closed pull request #4036: [AIRFLOW-2744] Allow RBAC to accept plugins for views and links.
URL: https://github.com/apache/incubator-airflow/pull/4036
 
 
   

This is a PR merged from a forked repository.
As GitHub hides the original diff on merge, it is displayed below for
the sake of provenance:

As this is a foreign pull request (from a fork), the diff is supplied
below (as it won't show otherwise due to GitHub magic):

diff --git a/airflow/plugins_manager.py b/airflow/plugins_manager.py
index ad630701de..c589e9b5a9 100644
--- a/airflow/plugins_manager.py
+++ b/airflow/plugins_manager.py
@@ -49,6 +49,8 @@ class AirflowPlugin(object):
     admin_views = []
     flask_blueprints = []
     menu_links = []
+    appbuilder_views = []
+    appbuilder_menu_items = []
 
     @classmethod
     def validate(cls):
@@ -120,6 +122,8 @@ def make_module(name, objects):
 admin_views = []
 flask_blueprints = []
 menu_links = []
+flask_appbuilder_views = []
+flask_appbuilder_menu_links = []
 
 for p in plugins:
     operators_modules.append(
@@ -135,3 +139,5 @@ def make_module(name, objects):
     admin_views.extend(p.admin_views)
     flask_blueprints.extend(p.flask_blueprints)
     menu_links.extend(p.menu_links)
+    flask_appbuilder_views.extend(p.appbuilder_views)
+    flask_appbuilder_menu_links.extend(p.appbuilder_menu_items)
diff --git a/airflow/www_rbac/app.py b/airflow/www_rbac/app.py
index 392dce1b31..e7f5a1e976 100644
--- a/airflow/www_rbac/app.py
+++ b/airflow/www_rbac/app.py
@@ -17,6 +17,7 @@
 # specific language governing permissions and limitations
 # under the License.
 #
+import logging
 import socket
 import six
 
@@ -37,6 +38,7 @@
 appbuilder = None
 csrf = CSRFProtect()
 
+log = logging.getLogger(__name__)
 
 def create_app(config=None, session=None, testing=False, app_name="Airflow"):
     global app, appbuilder
@@ -135,6 +137,24 @@ def init_views(appbuilder):
                                 category='About',
                                 category_icon='fa-th')
 
+            def integrate_plugins():
+                """Integrate plugins to the context"""
+                from airflow.plugins_manager import (
+                    flask_appbuilder_views, flask_appbuilder_menu_links)
+
+                for v in flask_appbuilder_views:
+                    log.debug("Adding view %s", v["name"])
+                    appbuilder.add_view(v["view"],
+                                        v["name"],
+                                        category=v["category"])
+                for ml in sorted(flask_appbuilder_menu_links, key=lambda x: x["name"]):
+                    log.debug("Adding menu link %s", ml["name"])
+                    appbuilder.add_link(ml["name"],
+                                        href=ml["href"],
+                                        category=ml["category"],
+                                        category_icon=ml["category_icon"])
+
+            integrate_plugins()
             # Garbage collect old permissions/views after they have been modified.
             # Otherwise, when the name of a view or menu is changed, the framework
             # will add the new Views and Menus names to the backend, but will not
diff --git a/docs/plugins.rst b/docs/plugins.rst
index 3f1f7ee804..eb44247950 100644
--- a/docs/plugins.rst
+++ b/docs/plugins.rst
@@ -72,10 +72,15 @@ looks like:
         # A list of objects created from a class derived
         # from flask_admin.BaseView
         admin_views = []
-        # A list of Blueprint object created from flask.Blueprint
+        # A list of Blueprint object created from flask.Blueprint. For use with the flask_admin based GUI
         flask_blueprints = []
-        # A list of menu links (flask_admin.base.MenuLink)
+        # A list of menu links (flask_admin.base.MenuLink). For use with the flask_admin based GUI
         menu_links = []
+        # A list of dictionaries containing FlaskAppBuilder BaseView object and some metadata. See example below
+        appbuilder_views = []
+        # A list of dictionaries containing FlaskAppBuilder BaseView object and some metadata. See example below
+        appbuilder_menu_items = []
+
 
 
 You can derive it by inheritance (please refer to the example below).
@@ -159,6 +164,22 @@ definitions in Airflow.
         name='Test Menu Link',
         url='https://airflow.incubator.apache.org/')
 
+    # Creating a flask appbuilder BaseView
+    class TestAppBuilderBaseView(AppBuilderBaseView):
+        @expose("/")
+        def test(self):
+            return self.render("test_plugin/test.html", content="Hello galaxy!")
+    v_appbuilder_view = TestAppBuilderBaseView()
+    v_appbuilder_package = {"name": "Test View",
+                            "category": "Test Plugin",
+                            "view": v_appbuilder_view}
+
+    # Creating a flask appbuilder Menu Item
+    appbuilder_mitem = {"name": "Google",
+                        "category": "Search",
+                        "category_icon": "fa-th",
+                        "href": "https://www.google.com"}
+
     # Defining the plugin class
     class AirflowTestPlugin(AirflowPlugin):
         name = "test_plugin"
@@ -170,3 +191,13 @@ definitions in Airflow.
         admin_views = [v]
         flask_blueprints = [bp]
         menu_links = [ml]
+        appbuilder_views = [v_appbuilder_package]
+        appbuilder_menu_items = [appbuilder_mitem]
+
+
+Note on role based views
+------------------------
+
+Airflow 1.10 introduced role based views using FlaskAppBuilder. You can configure which UI is used by setting
+rbac = True. To support plugin views and links for both versions of the UI and maintain backwards compatibility,
+the fields appbuilder_views and appbuilder_menu_items were added to the AirflowTestPlugin class.
diff --git a/tests/plugins/test_plugin.py b/tests/plugins/test_plugin.py
index 7b8bc4f61c..aaf1796e68 100644
--- a/tests/plugins/test_plugin.py
+++ b/tests/plugins/test_plugin.py
@@ -23,6 +23,7 @@
 from flask import Blueprint
 from flask_admin import BaseView, expose
 from flask_admin.base import MenuLink
+from flask_appbuilder import BaseView as AppBuilderBaseView
 
 # Importing base classes that we need to derive
 from airflow.hooks.base_hook import BaseHook
@@ -67,6 +68,28 @@ def test(self):
 
 v = TestView(category="Test Plugin", name="Test View")
 
+
+# Creating a flask appbuilder BaseView
+class TestAppBuilderBaseView(AppBuilderBaseView):
+    default_view = "test"
+
+    @expose("/")
+    def test(self):
+        return self.render("test_plugin/test.html", content="Hello galaxy!")
+
+
+v_appbuilder_view = TestAppBuilderBaseView()
+v_appbuilder_package = {"name": "Test View",
+                        "category": "Test Plugin",
+                        "view": v_appbuilder_view}
+
+# Creating a flask appbuilder Menu Item
+appbuilder_mitem = {"name": "Google",
+                    "category": "Search",
+                    "category_icon": "fa-th",
+                    "href": "https://www.google.com"}
+
+
 # Creating a flask blueprint to intergrate the templates and static folder
 bp = Blueprint(
     "test_plugin", __name__,
@@ -74,10 +97,11 @@ def test(self):
     static_folder='static',
     static_url_path='/static/test_plugin')
 
+
 ml = MenuLink(
     category='Test Plugin',
-    name='Test Menu Link',
-    url='https://airflow.incubator.apache.org/')
+    name="Test Menu Link",
+    url="https://airflow.incubator.apache.org/")
 
 
 # Defining the plugin class
@@ -91,3 +115,5 @@ class AirflowTestPlugin(AirflowPlugin):
     admin_views = [v]
     flask_blueprints = [bp]
     menu_links = [ml]
+    appbuilder_views = [v_appbuilder_package]
+    appbuilder_menu_items = [appbuilder_mitem]
diff --git a/tests/plugins_manager.py b/tests/plugins_manager.py
index 9f939c37a0..eeb6494100 100644
--- a/tests/plugins_manager.py
+++ b/tests/plugins_manager.py
@@ -27,11 +27,13 @@
 from flask.blueprints import Blueprint
 from flask_admin.menu import MenuLink, MenuView
 
+from airflow.configuration import conf
 from airflow.hooks.base_hook import BaseHook
 from airflow.models import BaseOperator
 from airflow.sensors.base_sensor_operator import BaseSensorOperator
 from airflow.executors.base_executor import BaseExecutor
 from airflow.www.app import cached_app
+from airflow.www_rbac import app as application
 
 
 class PluginsTest(unittest.TestCase):
@@ -83,3 +85,42 @@ def test_menu_links(self):
         [menu_link] = [ml for ml in category.get_children()
                        if isinstance(ml, MenuLink)]
         self.assertEqual('Test Menu Link', menu_link.name)
+
+
+class PluginsTestRBAC(unittest.TestCase):
+    def setUp(self):
+        conf.load_test_config()
+        self.app, self.appbuilder = application.create_app(testing=True)
+
+    def test_flaskappbuilder_views(self):
+        from tests.plugins.test_plugin import v_appbuilder_package
+        appbuilder_class_name = str(v_appbuilder_package['view'].__class__.__name__)
+        plugin_views = [view for view in self.appbuilder.baseviews
+                        if view.blueprint.name == appbuilder_class_name]
+
+        self.assertTrue(len(plugin_views) == 1)
+
+        # view should have a menu item matching category of v_appbuilder_package
+        links = [menu_item for menu_item in self.appbuilder.menu.menu
+                 if menu_item.name == v_appbuilder_package['category']]
+
+        self.assertTrue(len(links) == 1)
+
+        # menu link should also have a link matching the name of the package.
+        link = links[0]
+        self.assertEqual(link.name, v_appbuilder_package['category'])
+        self.assertEqual(link.childs[0].name, v_appbuilder_package['name'])
+
+    def test_flaskappbuilder_menu_links(self):
+        from tests.plugins.test_plugin import appbuilder_mitem
+
+        # menu item should exist matching appbuilder_mitem
+        links = [menu_item for menu_item in self.appbuilder.menu.menu
+                 if menu_item.name == appbuilder_mitem['category']]
+
+        self.assertTrue(len(links) == 1)
+
+        # menu link should also have a link matching the name of the package.
+        link = links[0]
+        self.assertEqual(link.name, appbuilder_mitem['category'])
+        self.assertEqual(link.childs[0].name, appbuilder_mitem['name'])


 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                Moving to ui component as part of component refactor. Webapp component will be removed.
              </div></li></ol></div></div></html>