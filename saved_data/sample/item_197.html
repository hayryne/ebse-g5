<!DOCTYPE html><html><div class="item-title">
        Item 197
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
 * Handler for exceptions that happen on checkpointing. The handler can reject and rethrow the offered exceptions.
 
              </div></li><li><div>
                *
	 * Offers the exception for handling. If the exception cannot be handled from this instance, it is rethrown.
	 *
	 * @param checkpointMetaData metadata for the checkpoint for which the exception occurred.
	 * @param exception  the exception to handle.
	 * @throws Exception rethrows the exception if it cannot be handled.
	 
              </div></li><li><div>
                *
	 * This handler makes the task fail by rethrowing a reported exception.
	 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
	 * This handler makes the task decline the checkpoint as reaction to the reported exception. The task is not failed.
	 
              </div></li><li><div>
                *
	 * Returns a {@link CheckpointExceptionHandler} that either causes a task to fail completely or to just declines
	 * checkpoint on exception, depending on the parameter flag.
	 
              </div></li><li><div>
                *
 * This factory produces {@link CheckpointExceptionHandler} instances that handle exceptions during checkpointing in a
 * {@link StreamTask}.
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
 * Test that the configuration mechanism for how tasks react on checkpoint errors works correctly.
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
 * Test for the current implementations of {@link CheckpointExceptionHandler} and their factory.
 
              </div></li><li><div>
                 start the task and wait until it is in "restore"
              </div></li><li><div>
                  test source operator that calls into the locking checkpoint output stream.
              </div></li><li><div>
                 ------------------------------------------------------------------------
  state backends that trigger errors in checkpointing.
 ------------------------------------------------------------------------
              </div></li><li><div>
                 ------------------------------------------------------------------------
  state backend with locking output stream.
 ------------------------------------------------------------------------
              </div></li><li><div>
                  checkpoint responder that records a call to decline.
              </div></li><li><div>
                *
	 * This method is visible because of the way the configuration is currently forwarded from the checkpoint config to
	 * the task. This should not be called by the user, please use CheckpointConfig.isFailTaskOnCheckpointError()
	 * instead.
	 
              </div></li><li><div>
                *
	 * This method is visible because of the way the configuration is currently forwarded from the checkpoint config to
	 * the task. This should not be called by the user, please use CheckpointConfig.setFailOnCheckpointingErrors(...)
	 * instead.
	 
              </div></li><li><div>
                * Determines if a task fails or not if there is an error in writing its checkpoint data. Default: true 
              </div></li><li><div>
                *
	 * This determines the behaviour of tasks if there is an error in their local checkpointing. If this returns true,
	 * tasks will fail as a reaction. If this returns false, task will only decline the failed checkpoint.
	 
              </div></li><li><div>
                * Determines if a tasks are failed or not if there is an error in their checkpointing. Default: true 
              </div></li><li><div>
                *
	 * Sets the expected behaviour for tasks in case that they encounter an error in their checkpointing procedure.
	 * If this is set to true, the task will fail on checkpointing error. If this is set to false, the task will only
	 * decline a the checkpoint and continue running. The default is true.
	 
              </div></li><li><div>
                 propagate the expected behaviour for checkpoint errors to task.
              </div></li><li><div>
                * Handler for exceptions during checkpointing in the stream task. Used in synchronous part of the checkpoint. 
              </div></li><li><div>
                *
	 * Wrapper for synchronous {@link CheckpointExceptionHandler}. This implementation catches unhandled, rethrown
	 * exceptions and reports them through {@link #handleAsyncException(String, Throwable)}. As this implementation
	 * always handles the exception in some way, it never rethrows.
	 
              </div></li><li><div><div><b>comment:</b>  we are transferring ownership over snapshotInProgressList for cleanup to the thread, active on submit
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                * Owning stream task to which we report async exceptions. 
              </div></li><li><div><div><b>comment:</b> * Wrapper for synchronousCheckpointExceptionHandler to deal with rethrown exceptions. Used in the async part. 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>comment:</b> * Synchronous exception handler to which we delegate. 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 start the task and wait until it is in "restore"
              </div></li><li><div>
                  test source operator that calls into the locking checkpoint output stream.
              </div></li><li><div>
                 ------------------------------------------------------------------------
  state backends that trigger errors in checkpointing.
 ------------------------------------------------------------------------
              </div></li><li><div>
                 ------------------------------------------------------------------------
  state backend with locking output stream.
 ------------------------------------------------------------------------
              </div></li><li><div>
                  checkpoint responder that records a call to decline.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [FLINK-4809] [checkpoints] Operators should tolerate checkpoint failures.
                </div><div><b>message:</b> [FLINK-4809] [checkpoints] Operators should tolerate checkpoint failures.

This closes #4883.

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [FLINK-4809] Operators should tolerate checkpoint failures.
                </div><div><b>body:</b> ## What is the purpose of the change

This PR implements FLINK-4809 and allows tasks to tolerate errors that happen in their checkpointing procedure. This tolerance is optional and can activated through `CheckpointOptions`,  the default behaviour is to fail the task, as before this PR.

When fault tolerance is activated, an error will not fail the task. Instead, the task will decline the checkpoint to the checkpoint coordinator.

## Brief change log

  - *Feature configuration through `CheckpointOptions` and `ExecutionConfig`.*
  - *Introduced `CheckpointExceptionHandler` and integrated with StreamTask. This handler will either transform the exception to a `declineCheckpoint` or rethrow to fail the task. *
  - *Tests for configuration forwarding and functionality.*

## Verifying this change

This change added tests and can be verified as follows:

  - *`CheckpointExceptionHandlerTest`: Unit test for the implementations of `CheckpointExceptionHandlerTest` and their factory.*
  - *`TaskCheckpointingBehaviourTest`: Tests the functionality to either fail tasks or only decline checkpoints in case of failure.*
  - *`CheckpointExceptionHandlerConfigurationTest`: Checks everything about configuration and configuration forwarding for the feature.*

## Does this pull request potentially affect one of the following parts:

  - Dependencies (does it add or upgrade a dependency): (no)
  - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes)
  - The serializers: (no)
  - The runtime per-record code paths (performance sensitive): (no)
  - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)

## Documentation

  - Does this pull request introduce a new feature? (yes)
  - If yes, how is the feature documented? (docs and JavaDocs)
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                CC @aljoscha 
              </div></li><li><div>
                @StefanRRichter do we have any update on this PR?
              </div></li><li><div>
                @PangZhi No updates, because I was on vacation and we currently give priority to the release 1.4 testing. After that I will finish this, but from the review comments, I would not expect that there are many changes to what I implemented and this can be merged as soon as there is time to do so.
              </div></li><li><div>
                @aljoscha Thanks for the review, I addressed your points. Will merge this.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Duplicate option in `ExecutionConfig` and `CheckpointingConfig`.
              </div></li><li><div>
                I think we typically don't talk about tasks in the user facing APIs. This could be `isFailOnCheckpointingErrors()`, for example.
              </div></li><li><div><div><b>body:</b> nit: "exception handles"
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Why don't we check for `failed` anymore?
              </div></li><li><div>
                Because this was moved from the `finally`-block into a `catch`-block where it is clear that the code failed.
              </div></li><li><div>
                After discussions with @aljoscha, we decided to keep this because it is the current way that Flink forwards the configuration. We add some `@Internal` annotation to the methods in `ExecutionConfig` so that the user will use the proper calls on `CheckpointingConfig` instead.
              </div></li><li><div>
                This line is missing from the Java tab.
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Operators should tolerate checkpoint failures
                </div><div><b>description:</b> Operators should try/catch exceptions in the synchronous and asynchronous part of the checkpoint and send a {{DeclineCheckpoint}} message as a result.

The decline message should have the failure cause attached to it.

The checkpoint barrier should be sent anyways as a first step before attempting to make a state checkpoint, to make sure that downstream operators do not block in alignment.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                GitHub user StefanRRichter opened a pull request:

    https://github.com/apache/flink/pull/4883

    [FLINK-4809] Operators should tolerate checkpoint failures.

    ## What is the purpose of the change
    
    This PR implements FLINK-4809 and allows tasks to tolerate errors that happen in their checkpointing procedure. This tolerance is optional and can activated through `CheckpointOptions`,  the default behaviour is to fail the task, as before this PR.
    
    When fault tolerance is activated, an error will not fail the task. Instead, the task will decline the checkpoint to the checkpoint coordinator.
    
    ## Brief change log
    
      - *Feature configuration through `CheckpointOptions` and `ExecutionConfig`.*
      - *Introduced `CheckpointExceptionHandler` and integrated with StreamTask. This handler will either transform the exception to a `declineCheckpoint` or rethrow to fail the task. *
      - *Tests for configuration forwarding and functionality.*
    
    ## Verifying this change
    
    This change added tests and can be verified as follows:
    
      - *`CheckpointExceptionHandlerTest`: Unit test for the implementations of `CheckpointExceptionHandlerTest` and their factory.*
      - *`TaskCheckpointingBehaviourTest`: Tests the functionality to either fail tasks or only decline checkpoints in case of failure.*
      - *`CheckpointExceptionHandlerConfigurationTest`: Checks everything about configuration and configuration forwarding for the feature.*
    
    ## Does this pull request potentially affect one of the following parts:
    
      - Dependencies (does it add or upgrade a dependency): (no)
      - The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes)
      - The serializers: (no)
      - The runtime per-record code paths (performance sensitive): (no)
      - Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)
    
    ## Documentation
    
      - Does this pull request introduce a new feature? (yes)
      - If yes, how is the feature documented? (docs and JavaDocs)

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/StefanRRichter/flink decline-on-checkpoint-exception

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/flink/pull/4883.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #4883
    
----
commit 9156a70319f4227b2a07edd9b07dae5fcfbaa01c
Author: Stefan Richter &lt;s.richter@data-artisans.com&gt;
Date:   2017-10-20T08:59:45Z

    [FLINK-4809] Operators should tolerate checkpoint failures.

----

              </div></li><li><div>
                Github user StefanRRichter commented on the issue:

    https://github.com/apache/flink/pull/4883
  
    CC @aljoscha 

              </div></li><li><div>
                Github user aljoscha commented on a diff in the pull request:

    https://github.com/apache/flink/pull/4883#discussion_r146544396
  
    --- Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java ---
    @@ -1041,27 +1065,27 @@ public void executeCheckpointing() throws Exception {
     						checkpointMetrics.getAlignmentDurationNanos() / 1_000_000,
     						checkpointMetrics.getSyncDurationMillis());
     				}
    -			} finally {
    -				if (failed) {
    -					// Cleanup to release resources
    -					for (OperatorSnapshotResult operatorSnapshotResult : operatorSnapshotsInProgress.values()) {
    -						if (null != operatorSnapshotResult) {
    -							try {
    -								operatorSnapshotResult.cancel();
    -							} catch (Exception e) {
    -								LOG.warn("Could not properly cancel an operator snapshot result.", e);
    -							}
    +			} catch (Exception ex) {
    +				// Cleanup to release resources
    --- End diff --
    
    Why don't we check for `failed` anymore?

              </div></li><li><div>
                Github user aljoscha commented on a diff in the pull request:

    https://github.com/apache/flink/pull/4883#discussion_r146543421
  
    --- Diff: flink-core/src/main/java/org/apache/flink/api/common/ExecutionConfig.java ---
    @@ -150,6 +150,9 @@
     	/** This flag defines if we use compression for the state snapshot data or not. Default: false */
     	private boolean useSnapshotCompression = false;
     
    +	/** Determines if a task fails or not if there is an error in writing its checkpoint data. Default: true */
    --- End diff --
    
    Duplicate option in `ExecutionConfig` and `CheckpointingConfig`.

              </div></li><li><div>
                Github user aljoscha commented on a diff in the pull request:

    https://github.com/apache/flink/pull/4883#discussion_r146543822
  
    --- Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/CheckpointExceptionHandlerFactory.java ---
    @@ -0,0 +1,78 @@
    +/*
    + * Licensed to the Apache Software Foundation (ASF) under one
    + * or more contributor license agreements.  See the NOTICE file
    + * distributed with this work for additional information
    + * regarding copyright ownership.  The ASF licenses this file
    + * to you under the Apache License, Version 2.0 (the
    + * "License"); you may not use this file except in compliance
    + * with the License.  You may obtain a copy of the License at
    + *
    + * http://www.apache.org/licenses/LICENSE-2.0
    + *
    + * Unless required by applicable law or agreed to in writing, software
    + * distributed under the License is distributed on an "AS IS" BASIS,
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    + * See the License for the specific language governing permissions and
    + * limitations under the License.
    + */
    +
    +package org.apache.flink.streaming.runtime.tasks;
    +
    +import org.apache.flink.runtime.checkpoint.CheckpointMetaData;
    +import org.apache.flink.runtime.execution.Environment;
    +import org.apache.flink.util.Preconditions;
    +
    +/**
    + * This factory produces exception handles that handle exceptions during checkpointing in a {@link StreamTask}.
    --- End diff --
    
    nit: "exception handles"

              </div></li><li><div>
                Github user aljoscha commented on a diff in the pull request:

    https://github.com/apache/flink/pull/4883#discussion_r146543640
  
    --- Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/CheckpointConfig.java ---
    @@ -231,6 +234,23 @@ public void setForceCheckpointing(boolean forceCheckpointing) {
     	}
     
     	/**
    +	 * This determines the behaviour of tasks if there is an error in their checkpointing. If this returns true,
    +	 * tasks will fail as a reaction. If this returns false, task will only decline the failed checkpoint.
    +	 */
    +	public boolean isFailTasksOnCheckpointingErrors() {
    --- End diff --
    
    I think we typically don't talk about tasks in the user facing APIs. This could be `isFailOnCheckpointingErrors()`, for example.

              </div></li><li><div>
                Do we have any update on the PR? It has been hanging for weeks.
              </div></li><li><div>
                Github user PangZhi commented on the issue:

    https://github.com/apache/flink/pull/4883
  
    @StefanRRichter do we have any update on this PR?

              </div></li><li><div>
                Github user StefanRRichter commented on the issue:

    https://github.com/apache/flink/pull/4883
  
    @PangZhi No updates, because I was on vacation and we currently give priority to the release 1.4 testing. After that I will finish this, but from the review comments, I would not expect that there are many changes to what I implemented and this can be merged as soon as there is time to do so.

              </div></li><li><div>
                Github user StefanRRichter commented on a diff in the pull request:

    https://github.com/apache/flink/pull/4883#discussion_r151940619
  
    --- Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/StreamTask.java ---
    @@ -1041,27 +1065,27 @@ public void executeCheckpointing() throws Exception {
     						checkpointMetrics.getAlignmentDurationNanos() / 1_000_000,
     						checkpointMetrics.getSyncDurationMillis());
     				}
    -			} finally {
    -				if (failed) {
    -					// Cleanup to release resources
    -					for (OperatorSnapshotResult operatorSnapshotResult : operatorSnapshotsInProgress.values()) {
    -						if (null != operatorSnapshotResult) {
    -							try {
    -								operatorSnapshotResult.cancel();
    -							} catch (Exception e) {
    -								LOG.warn("Could not properly cancel an operator snapshot result.", e);
    -							}
    +			} catch (Exception ex) {
    +				// Cleanup to release resources
    --- End diff --
    
    Because this was moved from the `finally`-block into a `catch`-block where it is clear that the code failed.

              </div></li><li><div>
                Github user StefanRRichter commented on a diff in the pull request:

    https://github.com/apache/flink/pull/4883#discussion_r151948416
  
    --- Diff: flink-core/src/main/java/org/apache/flink/api/common/ExecutionConfig.java ---
    @@ -150,6 +150,9 @@
     	/** This flag defines if we use compression for the state snapshot data or not. Default: false */
     	private boolean useSnapshotCompression = false;
     
    +	/** Determines if a task fails or not if there is an error in writing its checkpoint data. Default: true */
    --- End diff --
    
    After discussions with @aljoscha, we decided to keep this because it is the current way that Flink forwards the configuration. We add some `@Internal` and `@Deprecated` annotations to the methods in `ExecutionConfig` so that the user will use the proper calls on `CheckpointingConfig` instead.

              </div></li><li><div>
                Github user StefanRRichter commented on the issue:

    https://github.com/apache/flink/pull/4883
  
    @aljoscha Thanks for the review, I addressed your points. Will merge this.

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/flink/pull/4883

              </div></li><li><div>
                Merged in&nbsp;{{[7c63526|https://github.com/apache/flink/commit/7c63526ad6f27c6f15625b8b6c48359d9532890b].}}
              </div></li><li><div>
                Merged in&nbsp;{{[7c63526|https://github.com/apache/flink/commit/7c63526ad6f27c6f15625b8b6c48359d9532890b].}}
              </div></li><li><div>
                Github user rmetzger commented on a diff in the pull request:

    https://github.com/apache/flink/pull/4883#discussion_r182155763
  
    --- Diff: docs/dev/stream/state/checkpointing.md ---
    @@ -118,6 +120,9 @@ env.getCheckpointConfig.setMinPauseBetweenCheckpoints(500)
     // checkpoints have to complete within one minute, or are discarded
     env.getCheckpointConfig.setCheckpointTimeout(60000)
     
    +// prevent the tasks from failing if an error happens in their checkpointing, the checkpoint will just be declined.
    +env.getCheckpointConfig.setFailTasksOnCheckpointingErrors(false)
    --- End diff --
    
    This line is missing from the Java tab.

              </div></li></ol></div></div></html>