<!DOCTYPE html><html><div class="item-title">
        Item 6
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 marker size
 previous unfiltered size
              </div></li><li><div>
                 Skip row size
 previous unfiltered size
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Add row size to sstable format for faster skipping
                </div><div><b>message:</b> Add row size to sstable format for faster skipping

patch by slebresne; reviewed by benedict for CASSANDRA-10378

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Make skipping more efficient
                </div><div><b>description:</b> Following on from the impact of CASSANDRA-10322, we can improve the efficiency of our calls to skipping methods. CASSANDRA-10326 is showing our performance to be in-and-around the same ballpark except for seeks into the middle of a large partition, which suggests (possibly) that the higher density of data we're storing may simply be resulting in a more significant CPU burden as we have more data to skip over (and since CASSANDRA-10322 improves performance here really dramatically, further improvements are likely to be of similar benefit).

I propose doing our best to flatten the skipping of macro data items into as few skip invocations as necessary. One way of doing this would be to introduce a special {{skipUnsignedVInts(int)}} method, that can efficiently skip a number of unsigned vints. Almost the entire body of a cell and row consist of vints now, each data component with their own special {{skipX}} method that invokes {{readUnsignedVint}}. This would permit more efficient despatch.

We could also potentially avoid the construction of a new {{Columns}} instance for each row skip, since all we need is an iterator over the columns, and share the temporary space used for storing them, which should further reduce the GC burden for skipping many rows.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                I wonder if a simple solution wouldn't be to store the size of the row as first thing after the clustering so we can skip it all easily. We can do it only for sstable and using a vint, it will almost
always cost us just 1 byte and since, as you say, we do a shitload of row skipping within an index block so it might be worth it.
              </div></li><li><div>
                I would be in favour of that, as we could at the same time encode the _prior_ row's size as well, and this would permit us scanning both forwards and backwards.
              </div></li><li><div>
                I agree. And I might have some time to give that a shot to it in the next few days if your plate is full (just assign me if that's the case).
              </div></li><li><div>
                I pushed a quick patch implementing the idea above [here|https://github.com/pcmanus/cassandra/commits/10378]. The result on point queries can be point on [this graph|http://cstar.datastax.com/graph?stats=399e6124-616e-11e5-b8f9-42010af0688f&amp;metric=op_rate&amp;operation=3_user&amp;smoothing=1&amp;show_aggregates=true&amp;xmin=0&amp;xmax=152.68&amp;ymin=0&amp;ymax=110790.9]: basically, we get way much closer to 2.2 on those queries.
              </div></li><li><div>
                Marking this for RC2 as this is a very simple fix that get us a fairly good improvement, and it's a file format change so it's probably to get it in 3.0 proper if possible.
              </div></li><li><div><div><b>body:</b> * The {{previousUnfilteredSize}} is not propagated to {{serializedRowBodySize}} in {{serializedSize}}
* A static method for deciding if we have an extension byte would be nice
* {{skipRowBody}} and {{skipMarkerBody}} have unused parameters
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Thanks. Pushed an additional commit to the branch to address those.

bq. A static method for deciding if we have an extension byte would be nice

There was a {{isExtended()}} method already, though I added a {{readExtendedFlags}} that does the reading conditionally as that's probably cleaner. Or did I misunderstood what you meant?
              </div></li><li><div>
                I was referring to [this|https://github.com/pcmanus/cassandra/commit/60f311dbea3315ee61b9169d3fbb425dd3ff76c6#diff-c06541855022eca5fd794dd24ff02f89R221]. Not essential, but feel free to ninja on commit.
              </div></li><li><div>
                Committed, thanks.

bq. I was referring to [this|https://github.com/pcmanus/cassandra/commit/60f311dbea3315ee61b9169d3fbb425dd3ff76c6#diff-c06541855022eca5fd794dd24ff02f89R221].

Make sense, ninja-added on commit.

              </div></li></ol></div></div></html>