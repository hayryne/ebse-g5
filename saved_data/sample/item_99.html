<!DOCTYPE html><html><div class="item-title">
        Item 99
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [SPARK-4790][STREAMING] Fix ReceivedBlockTrackerSuite waits for old file...
                </div><div><b>message:</b> [SPARK-4790][STREAMING] Fix ReceivedBlockTrackerSuite waits for old file...

...s to get deleted before continuing.

Since the deletes are happening asynchronously, the getFileStatus call might throw an exception in older HDFS
versions, if the delete happens between the time listFiles is called on the directory and getFileStatus is called
on the file in the getFileStatus method.

This PR addresses this by adding an option to delete the files synchronously and then waiting for the deletion to
complete before proceeding.

Author: Hari Shreedharan &lt;hshreedharan@apache.org&gt;

Closes #3726 from harishreedharan/spark-4790 and squashes the following commits:

bbbacd1 [Hari Shreedharan] Call cleanUpOldLogs only once in the tests.
3255f17 [Hari Shreedharan] Add test for async deletion. Remove method from ReceiverTracker that does not take waitForCompletion.
e4c83ec [Hari Shreedharan] Making waitForCompletion a mandatory param. Remove eventually from WALSuite since the cleanup method returns only after all files are deleted.
af00fd1 [Hari Shreedharan] [SPARK-4790][STREAMING] Fix ReceivedBlockTrackerSuite waits for old files to get deleted before continuing.

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [SPARK-4790][STREAMING] Fix ReceivedBlockTrackerSuite waits for old file...
                </div><div><b>body:</b> ...s to get deleted before continuing.

Since the deletes are happening asynchronously, the getFileStatus call might throw an exception in older HDFS
versions, if the delete happens between the time listFiles is called on the directory and getFileStatus is called
on the file in the getFileStatus method.

This PR addresses this by adding an option to delete the files synchronously and then waiting for the deletion to
complete before proceeding.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                  [Test build #24556 has started](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24556/consoleFull) for   PR 3726 at commit [`af00fd1`](https://github.com/apache/spark/commit/af00fd145f05cb7bee2474ee37f366e1fd56912d).
- This patch merges cleanly.

              </div></li><li><div>
                  [Test build #24556 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24556/consoleFull) for   PR 3726 at commit [`af00fd1`](https://github.com/apache/spark/commit/af00fd145f05cb7bee2474ee37f366e1fd56912d).
- This patch **fails Spark unit tests**.
- This patch merges cleanly.
- This patch adds the following public classes _(experimental)_:
  - `class HiveThriftServer2Listener(val server: HiveServer2) extends SparkListener`

              </div></li><li><div>
                Test FAILed.
Refer to this link for build results (access rights to CI server needed): 
https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/24556/
Test FAILed.

              </div></li><li><div>
                Failures are in the parquet suite - I don't think it is related to this PR.

              </div></li><li><div>
                Jenkins, retest this please

              </div></li><li><div>
                  [Test build #24560 has started](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24560/consoleFull) for   PR 3726 at commit [`af00fd1`](https://github.com/apache/spark/commit/af00fd145f05cb7bee2474ee37f366e1fd56912d).
- This patch merges cleanly.

              </div></li><li><div>
                  [Test build #24560 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24560/consoleFull) for   PR 3726 at commit [`af00fd1`](https://github.com/apache/spark/commit/af00fd145f05cb7bee2474ee37f366e1fd56912d).
- This patch **fails Spark unit tests**.
- This patch merges cleanly.
- This patch adds the following public classes _(experimental)_:
  - `class HiveThriftServer2Listener(val server: HiveServer2) extends SparkListener`

              </div></li><li><div>
                Test FAILed.
Refer to this link for build results (access rights to CI server needed): 
https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/24560/
Test FAILed.

              </div></li><li><div>
                Jenkins, retest this please.

              </div></li><li><div>
                  [Test build #24562 has started](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24562/consoleFull) for   PR 3726 at commit [`af00fd1`](https://github.com/apache/spark/commit/af00fd145f05cb7bee2474ee37f366e1fd56912d).
- This patch merges cleanly.

              </div></li><li><div>
                  [Test build #24562 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24562/consoleFull) for   PR 3726 at commit [`af00fd1`](https://github.com/apache/spark/commit/af00fd145f05cb7bee2474ee37f366e1fd56912d).
- This patch **passes all tests**.
- This patch merges cleanly.
- This patch adds no public classes.

              </div></li><li><div>
                Test PASSed.
Refer to this link for build results (access rights to CI server needed): 
https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/24562/
Test PASSed.

              </div></li><li><div>
                Rather than changing the code to accommodate the tests, i think its better to tweak the test to make it account for the laziness. I would simply change the test [here](https://github.com/apache/spark/pull/3726/files#diff-f623a1fd0c6039bd6eb1746f9cc692c5L173) by making the test in a `eventually` block.

              </div></li><li><div>
                &gt; Rather than changing the code to accommodate the tests, i think its better to tweak the test to make it account for the laziness. I would simply change the test here by making the test in a eventually block.

In  #3721, I used a `eventually` block previously. It was override by the current fix with `Future`.

              </div></li><li><div>
                 Eventually is pretty much trying a test in a loop and that encourages flakey tests - I am in general not a very big fan of using eventually. 
The correct approach is to fix the non-determinism. Being able to detect that all files have been deleted has value - and gives easy debuggability. Being able to deterministically to know that all files are gone before proceeding does help debuggability.

I don't really believe we are actually a accommodating  the test - we are really fixing the code to allow deterministic testing. 

              </div></li><li><div>
                  [Test build #24791 has started](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24791/consoleFull) for   PR 3726 at commit [`e4c83ec`](https://github.com/apache/spark/commit/e4c83eca17c660644216b6d8cc862f8b1654649c).
- This patch merges cleanly.

              </div></li><li><div>
                  [Test build #24791 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24791/consoleFull) for   PR 3726 at commit [`e4c83ec`](https://github.com/apache/spark/commit/e4c83eca17c660644216b6d8cc862f8b1654649c).
- This patch **fails PySpark unit tests**.
- This patch merges cleanly.
- This patch adds no public classes.

              </div></li><li><div>
                Test FAILed.
Refer to this link for build results (access rights to CI server needed): 
https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/24791/
Test FAILed.

              </div></li><li><div>
                Jenkins, retest this please

              </div></li><li><div>
                  [Test build #24806 has started](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24806/consoleFull) for   PR 3726 at commit [`e4c83ec`](https://github.com/apache/spark/commit/e4c83eca17c660644216b6d8cc862f8b1654649c).
- This patch merges cleanly.

              </div></li><li><div>
                  [Test build #24806 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24806/consoleFull) for   PR 3726 at commit [`e4c83ec`](https://github.com/apache/spark/commit/e4c83eca17c660644216b6d8cc862f8b1654649c).
- This patch **passes all tests**.
- This patch merges cleanly.
- This patch adds no public classes.

              </div></li><li><div>
                Test PASSed.
Refer to this link for build results (access rights to CI server needed): 
https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/24806/
Test PASSed.

              </div></li><li><div>
                  [Test build #24807 has started](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24807/consoleFull) for   PR 3726 at commit [`3255f17`](https://github.com/apache/spark/commit/3255f1710d7ffbbbd2de4b098eb444885b2aad36).
- This patch merges cleanly.

              </div></li><li><div>
                  [Test build #24807 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24807/consoleFull) for   PR 3726 at commit [`3255f17`](https://github.com/apache/spark/commit/3255f1710d7ffbbbd2de4b098eb444885b2aad36).
- This patch **fails Spark unit tests**.
- This patch merges cleanly.
- This patch adds no public classes.

              </div></li><li><div>
                Test FAILed.
Refer to this link for build results (access rights to CI server needed): 
https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/24807/
Test FAILed.

              </div></li><li><div>
                Jenkins, retest this please

              </div></li><li><div>
                  [Test build #24811 has started](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24811/consoleFull) for   PR 3726 at commit [`3255f17`](https://github.com/apache/spark/commit/3255f1710d7ffbbbd2de4b098eb444885b2aad36).
- This patch merges cleanly.

              </div></li><li><div>
                  [Test build #24811 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24811/consoleFull) for   PR 3726 at commit [`3255f17`](https://github.com/apache/spark/commit/3255f1710d7ffbbbd2de4b098eb444885b2aad36).
- This patch **passes all tests**.
- This patch merges cleanly.
- This patch adds no public classes.

              </div></li><li><div>
                Test PASSed.
Refer to this link for build results (access rights to CI server needed): 
https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/24811/
Test PASSed.

              </div></li><li><div>
                Looking good, except one comment in the testsuite (and another optional comment) . 

              </div></li><li><div>
                  [Test build #24869 has started](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24869/consoleFull) for   PR 3726 at commit [`bbbacd1`](https://github.com/apache/spark/commit/bbbacd1a441e43ce46e49bea6c85c6d7834c5487).
- This patch merges cleanly.

              </div></li><li><div>
                  [Test build #24869 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/24869/consoleFull) for   PR 3726 at commit [`bbbacd1`](https://github.com/apache/spark/commit/bbbacd1a441e43ce46e49bea6c85c6d7834c5487).
- This patch **passes all tests**.
- This patch merges cleanly.
- This patch adds no public classes.

              </div></li><li><div>
                Test PASSed.
Refer to this link for build results (access rights to CI server needed): 
https://amplab.cs.berkeley.edu/jenkins//job/SparkPullRequestBuilder/24869/
Test PASSed.

              </div></li><li><div>
                Hey @tdas, is this good to go now?  It would be nice to eliminate this cause of test flakiness, since this seems to be causing a decent number of failures today.

              </div></li><li><div>
                Yeah, LGTM. Merging this. 

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                `1 second` may be not enough. Why not return Future to the user so that they can use it to wait by themselves?

              </div></li><li><div>
                I fixed it using `Future` in #3721. Could you take a look?

              </div></li><li><div>
                These two signatures can be merged into a single method with default parameters. In fact it is probably okay to make the second parameter non-optional, which would take care of @zsxwing valid concern of the method not being obvious that it does stuff asynchronously.

              </div></li><li><div>
                I think its better to not expose implementation details like asynchronous-ness in the signature (i.e. returning `Future`) unless absolutely necessary. 

Also, the timeout is only for testing, so this is not for actual usage. So its okay to have 1 second. @harishreedharan Could you document that in the scala doc of the method that the 2nd parameter = true is only for testing?

              </div></li><li><div>
                Yep, sound good. I will update the PR.

              </div></li><li><div>
                Why do we need two methods still? We can just have this version, and update the usages everywhere.

              </div></li><li><div>
                Can you extend this unit test to test for `waitForComplete = false` as well. Basically call `manager.cleanupOldLogs(manualClock.currentTime, waitForCompletion = false)` and see with `eventually` that more files gets deleted.

              </div></li><li><div>
                Its worth testing both code paths because the async code path is what is going to be used in production.

              </div></li><li><div>
                Hmm..I thought I pushed the commit that removed this one. Let me check. Anyway I agree we don't need both, will remove the other one.

              </div></li><li><div>
                This call should be made only once (as in real use), instead of being called multiple times from within a `eventually` block.

              </div></li><li><div>
                Actually, mind renaming this method to `cleanupOldBlocks`? Realized that it was inconsistent with `cleanupOldBatches` and `cleanupOldLogs`. I know its not your code :)

              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>