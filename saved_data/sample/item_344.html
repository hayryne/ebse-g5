<!DOCTYPE html><html><div class="item-title">
        Item 344
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Fix DatafileManager MajC for empty files. Closes #1535 (#1538)
                </div><div><b>message:</b> Fix DatafileManager MajC for empty files. Closes #1535 (#1538)

* Don't rename the file if it is empty
* Don't add the file to the list of files if it is empty


Co-authored-by: Keith Turner &lt;kturner@apache.org&gt;
                </div></div></li></ol></div><div><b>github_issues:</b> <ol><li><div><div><b>title:</b> Investigate empty files in Major Compactions
                </div><div><b>body:</b> I noticed while working on #1519 that if a Major compaction produces an empty file that it will still be added to the list of majorCompactingFiles.  This happens [here](https://github.com/apache/accumulo/blob/1.9/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java#L596). This is different from the rest of the code which checks if ```DataFileValue.getNumEntries() &gt; 0```.  This file will be deleted towards the beginning of ```bringMajorCompactionOnline()``` [here](https://github.com/apache/accumulo/blob/1.9/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java#L541).  The list files is cleared at the end of the MajC but there parts of the code which check the size of the list that this could effect.

If there is no reason why we care about an empty file that is already deleted, then this is a bug and the file shouldn't be added to the list.

The place were this file is deleted for MajC also seems sub-optimal since we are renaming the file immediately before removing it.  Minor compactions will do one or the other.
                </div></div></li><li><div><div><b>title:</b> Investigate empty files in Major Compactions
                </div><div><b>body:</b> I noticed while working on #1519 that if a Major compaction produces an empty file that it will still be added to the list of majorCompactingFiles.  This happens [here](https://github.com/apache/accumulo/blob/1.9/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java#L596). This is different from the rest of the code which checks if ```DataFileValue.getNumEntries() &gt; 0```.  This file will be deleted towards the beginning of ```bringMajorCompactionOnline()``` [here](https://github.com/apache/accumulo/blob/1.9/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java#L541).  The list files is cleared at the end of the MajC but there parts of the code which check the size of the list that this could effect.

If there is no reason why we care about an empty file that is already deleted, then this is a bug and the file shouldn't be added to the list.

The place were this file is deleted for MajC also seems sub-optimal since we are renaming the file immediately before removing it.  Minor compactions will do one or the other.
                </div></div></li></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li><li><div><div><b>title:</b> Create StoredTabletFile to use in different situations
                </div><div><b>body:</b> * Created methods for read/insert/updateDel and have them called
throughout the code for the appropriate situation
* Throw exception if we try to get metadata for update or delete and one
does not exist
* Call inserted() method on TabletFile to update metadata entry when a
file is new and inserted
* Drop FileUtil.toPathStrings() and use object collections instead
* Replace String path with TabletFile in FileUtil
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                @milleruntime I can't tell if you're still working on this or if it's ready for re-review. If you want a re-review, feel free to tag me.
              </div></li><li><div>
                &gt; @milleruntime I can't tell if you're still working on this or if it's ready for re-review. If you want a re-review, feel free to tag me.

I am still working on this...  I started another branch since these changes are involved.  I will merge it with this branch and ping you when its ready.
              </div></li><li><div>
                @ctubbsii I made the updates you and @keith-turner suggested so this PR can be reviewed.  I know of at least 1 IT that is failing, SplitRecoveryIT that i am still trying to fix. 
              </div></li><li><div><div><b>body:</b> @keith-turner I added a TODO to take a close look at the compaction code [here](https://github.com/apache/accumulo/blob/95b92c555b8e78bfc1577eccd59a55f12fa80708/server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java#L548).  I noticed a difference in the order metadata is updated between minor and major compactions.  During minor compactions, we update the metadata table first and then update the Tablet data in memory.  Major compactions update the tablet data in memory first (with the tablet lock) then outside the lock wait for scans and then finally update the metadata table.  Do you know why the metadata isn't updated first during major compaction? 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                https://issues.apache.org/jira/browse/ACCUMULO-18
              </div></li><li><div>
                Seeing a failure in BadIteratorMincIT:
```
2020-02-26 16:13:35,689 [tablet.Compactor] ERROR: null
java.lang.NullPointerException
        at org.apache.accumulo.test.functional.BadIterator.hasTop(BadIterator.java:36)
        at org.apache.accumulo.tserver.tablet.Compactor.compactLocalityGroup(Compactor.java:380)
        at org.apache.accumulo.tserver.tablet.Compactor.call(Compactor.java:231)
        at org.apache.accumulo.tserver.tablet.MinorCompactor.call(MinorCompactor.java:128)
        at org.apache.accumulo.tserver.tablet.Tablet.minorCompact(Tablet.java:820)
        at org.apache.accumulo.tserver.tablet.MinorCompactionTask.run(MinorCompactionTask.java:94)
        at org.apache.accumulo.fate.util.LoggingRunnable.run(LoggingRunnable.java:37)
        at org.apache.htrace.wrappers.TraceRunnable.run(TraceRunnable.java:57)
        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
        at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
        at org.apache.accumulo.fate.util.LoggingRunnable.run(LoggingRunnable.java:37)
        at java.base/java.lang.Thread.run(Thread.java:834)
```
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div><div><b>body:</b> Recently, I've come to appreciate the use of static methods with a private constructor, rather than overloaded constructors.

For example:

```java
    var tabletFile = TabletFile.fromMetaPath(metaPath);
    var tabletFile = TabletFile.fromMetadataEntry(strEntry);
```

I recommend this over the overloaded constructors because you get to have very clear parameter semantics communicated via the method name, vs. trying to infer that from overloaded constructors. It's less error prone when parameter numbers mismatch, and easier to handle overloading when you have the same parameter type (usually String) with different semantics.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Should resolve this before merge, or create follow-on task.
              </div></li><li><div><div><b>body:</b> Most of the time I would agree, especially with multiple String parameters a static method is a lot more clear.  But I don't think we need them in this case since the objects being passed are essentially the same thing just in different form.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I don't see any downside, even if we don't "need" them, but I'll defer to your preference.
              </div></li><li><div>
                I think Optional.of will throw an exception if null, so could drop the reqNonNull.

```suggestion
    this(new Path(metadataEntry), Optional.of(metadataEntry));
```
              </div></li><li><div>
                It would be nice to keep this object immutable.  Could possibly have this method return a new object instead of mutating itself, but I am not sure if that is easy to do.  If my suggestion is really cumbersome to implement, please ignore this comment. 
              </div></li><li><div>
                ```suggestion
   * Return a string for opening and reading the tablet file. Doesn't have to be exact string in metadata.
```
              </div></li><li><div>
                The javadoc comment say its does not have to be the exact path in meta, but the method name has Meta in it.  I feel like Meta should be dropped from the name.  
              </div></li><li><div>
                I will give it a try since I think it is worth exploring.
              </div></li><li><div><div><b>body:</b> This seems to be protecting against programming errors, where the TabletFile on which this method is being called was not constructed from a metadata entry. However, a better way to protect against these kinds of programming errors is to put this method on a subclass. So, by the type hierarchy, you enforce the fact that this method can *only* ever be called on a subclass, which is a type where construction requires a metadata entry.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I think this is OK since it is only called by the 2 bulk import methods.  And each has a corresponding CleanupBulkImport FATE operations which calls```MetadataTableUtil.removeBulkLoadEntries()```
              </div></li><li><div>
                This is a good idea too, and may work well with @keith-turner 's suggestion.  I will update the PR with the other minor suggestions before attempting this change. 
              </div></li><li><div>
                @keith-turner I am not sure how returning a new immutable object will work with TabletMutatorBase [here](https://github.com/apache/accumulo/blob/def68d4593cfaac1bc4b82194440a2f80e6643d4/server/base/src/main/java/org/apache/accumulo/server/metadata/TabletMutatorBase.java#L76)...  any ideas?
              </div></li><li><div>
                It looks like I will just have to find a good spot in the code to call ```insert()``` which will return the new StoredTabletFile object.  Thankfully a lot of the util methods we use for mutations return void so I was thinking to make them return collections of the new StoredTabletFiles, such as [here](https://github.com/apache/accumulo/blob/def68d4593cfaac1bc4b82194440a2f80e6643d4/server/base/src/main/java/org/apache/accumulo/server/util/MasterMetadataUtil.java#L65).
              </div></li><li><div>
                It looks like these can all be lambdas, but that can be a follow-on issue.
              </div></li><li><div>
                If you wanted to, you could use `var` keyword :smiley_cat:
              </div></li><li><div>
                Opened #1533 
              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>