<!DOCTYPE html><html><div class="item-title">
        Item 225
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Allow the connectors to startup, recover, and exit cleanly before
 ending the test. It's possible for the source connector to make
 uncommitted progress, and for the sink connector to read messages that
 have not been committed yet, and fail a later assertion.
              </div></li><li><div>
                 Wait at least scheduled.rebalance.max.delay.ms to expire and rebalance
              </div></li><li><div>
                 Ensure that the sink connector has an opportunity to read all
 committed messages from the source connector.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> KAFKA-10295: Wait for connector recovery in test_bounce (#9043)
                </div><div><b>message:</b> KAFKA-10295: Wait for connector recovery in test_bounce (#9043)

Signed-off-by: Greg Harris &lt;gregh@confluent.io&gt;
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> KAFKA-10295: Wait for connector recovery in test_bounce
                </div><div><b>body:</b> Signed-off-by: Greg Harris &lt;gregh@confluent.io&gt;

This additional waiting is for:
* The scheduled.rebalance.max.time.ms to expire and for tasks to be reassigned
* The source connector to start and commit offsets at least once beyond it's last commit
* The sink connector to have adequate time to read any of the messages written by the source

Prevents flakey test failures with messages like "Found sink sequence number greater than any generated sink sequence number for task %d: %d &gt; %d" when test_bounce is running with hard bounces and Incremental Cooperative Rebalancing enabled.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-10295: Wait for connector recovery in test_bounce
                </div><div><b>body:</b> Signed-off-by: Greg Harris &lt;gregh@confluent.io&gt;

This additional waiting is for:
* The scheduled.rebalance.max.time.ms to expire and for tasks to be reassigned
* The source connector to start and commit offsets at least once beyond it's last commit
* The sink connector to have adequate time to read any of the messages written by the source

Prevents flakey test failures with messages like "Found sink sequence number greater than any generated sink sequence number for task %d: %d &gt; %d" when test_bounce is running with hard bounces and Incremental Cooperative Rebalancing enabled.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-10295: Wait for connector recovery in test_bounce
                </div><div><b>body:</b> Signed-off-by: Greg Harris &lt;gregh@confluent.io&gt;

This additional waiting is for:
* The scheduled.rebalance.max.time.ms to expire and for tasks to be reassigned
* The source connector to start and commit offsets at least once beyond it's last commit
* The sink connector to have adequate time to read any of the messages written by the source

Prevents flakey test failures with messages like "Found sink sequence number greater than any generated sink sequence number for task %d: %d &gt; %d" when test_bounce is running with hard bounces and Incremental Cooperative Rebalancing enabled.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-10295: Wait for connector recovery in test_bounce
                </div><div><b>body:</b> Signed-off-by: Greg Harris &lt;gregh@confluent.io&gt;

This additional waiting is for:
* The scheduled.rebalance.max.time.ms to expire and for tasks to be reassigned
* The source connector to start and commit offsets at least once beyond it's last commit
* The sink connector to have adequate time to read any of the messages written by the source

Prevents flakey test failures with messages like "Found sink sequence number greater than any generated sink sequence number for task %d: %d &gt; %d" when test_bounce is running with hard bounces and Incremental Cooperative Rebalancing enabled.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div><div><b>label:</b> test
                </div></div></li><li><div><div><b>title:</b> KAFKA-10295: Wait for connector recovery in test_bounce
                </div><div><b>body:</b> Signed-off-by: Greg Harris &lt;gregh@confluent.io&gt;

This additional waiting is for:
* The scheduled.rebalance.max.time.ms to expire and for tasks to be reassigned
* The source connector to start and commit offsets at least once beyond it's last commit
* The sink connector to have adequate time to read any of the messages written by the source

Prevents flakey test failures with messages like "Found sink sequence number greater than any generated sink sequence number for task %d: %d &gt; %d" when test_bounce is running with hard bounces and Incremental Cooperative Rebalancing enabled.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                cc @rhauch for review
              </div></li><li><div>
                @gharris1727 Thanks for the proposed fix. I've started a system test build for this branch: https://jenkins.confluent.io/job/system-test-kafka-branch-builder/4046/
              </div></li><li><div>
                All 69 Connect system tests passed: http://confluent-kafka-branch-builder-system-test-results.s3-us-west-2.amazonaws.com/2020-07-20--001.1595250965--gharris1727--bounce-recovery--c00de2d82/report.html
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> ConnectDistributedTest.test_bounce should wait for graceful stop
                </div><div><b>description:</b> In ConnectDistributedTest.test_bounce, there are flakey failures that appear to follow this pattern:
 # The test is parameterized for hard bounces, and with Incremental Cooperative Rebalancing enabled (does not appear for protocol=eager)
 # A source task is on a worker that will experience a hard bounce
 # The source task has written records which it has not yet committed in source offsets
 # The worker is hard-bounced, and the source task is lost
 # Incremental Cooperative Rebalance starts it's scheduled.rebalance.max.delay.ms delay before recovering the task
 # The test ends, connectors and Connect are stopped
 # The test verifies that the sink connector has only written records that have been committed by the source connector
 # This verification fails because the source offsets are stale, and there are un-committed records in the topic, and the sink connector has written at least one of them.

This can be addressed by ensuring that the test waits for the rebalance delay to expire, and for the lost task to recover and commit offsets past the progress it made before the bounce.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>