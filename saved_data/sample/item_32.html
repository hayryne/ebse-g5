<!DOCTYPE html><html><div class="item-title">
        Item 32
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                * @file

  This file implements the rolled log deletion.

  @section license License

  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
 
              </div></li><li><div>
                *
     * A min_count of zero indicates a request to try to keep all rotated logs
     * around. By setting min_count to INT_MAX in these cases, we make the rolled
     * log deletion priority small.
     *
     * @note This cannot have a zero value because it is used as the denominator
     * in a division operation when calculating the log deletion preference.
     
              </div></li><li><div>
                 Return the highest priority candidate among the candidates of that type.
              </div></li><li><div>
                 Select the highest priority type (diags.log, traffic.out, etc.) from which
 to select a candidate.
              </div></li><li><div>
                *
   * @param[in] logname The unrolled log name.
   *
   * @param[in] min_count The minimum number of rolled files to try to keep
   * around when deleting rolled logs. A zero indicates a desire to keep all
   * rolled logs around.
   *
   * @note The min_count is used as a part of a calculation to determine which
   * set of deletion candidates should be used for selecting a rolled log file
   * to delete. If space is particularly constrained, even LogDeletingInfo
   * instances with a min_count of 0 may be selected for deletion.
   
              </div></li><li><div>
                * The owning references to the set of LogDeletingInfo added to the below
   * hash map. 
              </div></li><li><div>
                * @file

  This contains the rotated log deletion mechanism.

  @section license License

  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
 
              </div></li><li><div>
                *
 * RolledLogDeleter is responsible for keeping track of rolled log candidates
 * and presenting them for deletion in a prioritized order based on size and
 * last modified time stamp.
 *
 * Terminology:
 *
 * log type: An unrolled log name that represents a category of rolled log
 * files that are candidates for deletion. This may be something like
 * diags.log, traffic.out, etc.
 *
 * candidate: A rolled log file which is a candidate for deletion at some
 * point. This may be something like:
 *   squid.log_some.hostname.com.20191125.19h00m04s-20191125.19h15m04s.old.
 
              </div></li><li><div>
                * The minimum number of rolled log files to try to keep around.
   *
   * @note This is guaranteed to be a positive (non-zero) value.
   
              </div></li><li><div>
                * Register a new log type for candidates for log deletion.
   *
   * @param[in] log_type The unrolled name for a set of rolled log files to
   * consider for deletion. This may be something like diags.log, for example.
   *
   * @param[in] rolling_min_count The minimum number of rolled log files to
   * keep around.
   
              </div></li><li><div>
                * Configure rolled log deletion for a set of logs.
 *
 * This contains the configuration and set of log deletion candidates for a set
 * of log files associated with logname. There will be an instance of this for
 * diags.log and its associated rolled log files, one for traffic.out, etc.
 
              </div></li><li><div>
                * Evaluate a rolled log file to see whether it is a candidate for deletion.
   *
   * If the rolled log file is a valid candidate, it will be stored and considered
   * for deletion upon later calls to deleteALogFile.
   *
   * @param[in] log_path The rolled log file path.
   *
   * @param[in] file_size The size of the rolled log file.
   *
   * @param[in] modification_time The time the rolled log file was last modified.
   * candidate for deletion.
   *
   * @return True if the rolled log file is a deletion candidate, false otherwise.
   
              </div></li><li><div>
                * The unrolled log name (such as "diags.log"). 
              </div></li><li><div>
                * Whether there are any candidates for possible deletion.
   *
   * @return True if there are candidates for deletion, false otherwise.
   
              </div></li><li><div>
                * The number of tracked candidates. 
              </div></li><li><div>
                * The set of candidates for deletion keyed by log_type. 
              </div></li><li><div>
                * Clear the internal candidates array.
   
              </div></li><li><div>
                * Retrieve the next rolled log file to delete.
   *
   * This removes the returned rolled file from the candidates list.
   *
   * @return The next rolled log candidate to delete or nullptr if there is no
   * such candidate.
   
              </div></li><li><div>
                * Retrieve the number of rolled log deletion candidates.
   *
   * @return The number of rolled logs that are candidates for deletion.
   
              </div></li><li><div>
                * The filename for this rolled log deletion candidate.
   *
   * For example: /var/log/my_log.log_a_host_name.20191122.20h18m35s-20191122.20h18m51s.old
   
              </div></li><li><div>
                 The second candidate should be the second oldest.
              </div></li><li><div>
                 Everything has been taken.
              </div></li><li><div>
                 Add some candidates.
              </div></li><li><div>
                 Even with so many diags.log files, the traffic.out one should be
 selected first because the min_count of diags.log is 0.
              </div></li><li><div>
                
 Stub

              </div></li><li><div>
                 The first candidate should be the oldest modified one.
              </div></li><li><div>
                 The user has requested a higher number of traffic.out files, but since
 there are so many of them, the oldest of them should be selected next.
              </div></li><li><div>
                 Now, there's only traffic.out files.
              </div></li><li><div>
                * @file

  Catch-based tests for RolledLogDeleter.

  @section license License

  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
 
              </div></li><li><div>
                 The second candidate should be the remaining one.
              </div></li><li><div>
                 Intentionally insert them out of order (that is the first one to delete
 is the second added).
              </div></li><li><div>
                 The previous tests verify selection within a log_type which is done based
   * upon last modified time stamp. These tests focus on selection of
   * candidates across log types, which is based upon number of candidates and
   * the desired min_count. 
              </div></li><li><div>
                 Since the time stamps of both are the same, selection should be made
 based upon min_count.
              </div></li><li><div>
                 Now there's only diags.log files.
              </div></li><li><div>
                 Next, squid.log should be chosen.
              </div></li><li><div>
                 Intentionally insert them out of order.
              </div></li><li><div>
                 The third candidate should be the remaining one.
              </div></li><li><div>
                * @file

  Test a plugin's interaction with the logging interface.

  @section license License

  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
 
              </div></li><li><div>
                 This is made to match the std::filesystem::path::filename behavior:
   https://en.cppreference.com/w/cpp/filesystem/path/filename

              </div></li><li><div>
                 auto create 
              </div></li><li><div>
                 auto_created 
              </div></li><li><div>
                 The majority of register_rolled_log_auto_delete() updates come in
 through LogObject. However, not all ATS logs are managed by LogObject.
 The following register these other core logs for log rotation deletion.
              </div></li><li><div>
                 The set of files in the logs dir may change between iterations to check
 for logs to delete. To deal with this, we simply clear our internal
 candidates metadata and regenerate it on each iteration.
              </div></li><li><div>
                 Nothing to do if auto-deletion is not configured.
              </div></li><li><div>
                * Register rolled logs of logname for auto-deletion when there are space
   * constraints.
   *
   * @param[in] logname The name of the unrolled log to register, such as
   * "diags.log".
   *
   * @param[in] rolling_min_count The minimum amount of rolled logs of logname
   * to try to keep around. A value of 0 expresses a desire to keep all rolled
   * files, if possible.
   
              </div></li><li><div>
                 auto_created 
              </div></li><li><div>
                 minimum number of rolled logs to be kept, 0 no limit
              </div></li><li><div>
                 rolling_min_count 
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> auto delete rolled log file fixes
                </div><div><b>message:</b> auto delete rolled log file fixes

This fixes auto delete registration for:

- core log files that were not getting deleted (such as error.log and
  manager.log) as well as...
- plugin log files.

To make log deletion registration more automatic, I placed it in LogObject
initialization so that it doesn't have to happen in as many disparate places.
By doing this, plugin log auto delete comes for free.  This is why nothing in
the core plugin implementation needed to be changed to register their log
files, for instance. Not all log objects are managed by LogObject, however, so
we still have some manual calls to registration in LogConfig for core log files
(such as traffic.out and diags.log, for example).

Before this change, LogConfig manipulated deleting_info to create and maintain
candidates. To encapsulate this logic, I created RolledLogDeleter and changed
LogConfig to interact with an instance of that. This simplified the LogConfig
logic while also enabling unit testability of the main log deletion feature.

This also:

- Adds a rolling_max_count autest.
- Fixes a shutdown leak concerning LogDeletingInfo.
- Fixes a paramater mismatch between TextLogObject and LogObject.

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>