<!DOCTYPE html><html><div class="item-title">
        Item 32
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Implementing:
 return new JobContext(jobConf, new JobID());
              </div></li><li><div>
                 Implementing:
 return Job.getInstance(jobConf);
              </div></li><li><div>
                *
 * This class provides shims for HBase to interact with the Hadoop 1.0.x and the
 * Hadoop 0.23.x series.
 * 
 * NOTE: No testing done against 0.22.x, or 0.21.x.
 
              </div></li><li><div>
                 static method, then arg
              </div></li><li><div>
                *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                 This class exists in hadoop 0.22+ but not in Hadoop 20.x/1.x
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HBASE-5861 ADDENDUM (missed new MapredcueTestingShim.java file)
                </div><div><b>message:</b> HBASE-5861 ADDENDUM (missed new MapredcueTestingShim.java file)


git-svn-id: https://svn.apache.org/repos/asf/hbase/branches/0.94@1330077 13f79535-47bb-0310-9956-ffa450edef68

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Hadoop 23 compilation broken due to tests introduced in HBASE-5604
                </div><div><b>description:</b> When attempting to compile HBase 0.94rc1 against hadoop 23, I got this set of compilation error messages:

{code}
jon@swoop:~/proj/hbase-0.94$ mvn clean test -Dhadoop.profile=23 -DskipTests
...
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 18.926s
[INFO] Finished at: Mon Apr 23 10:38:47 PDT 2012
[INFO] Final Memory: 55M/555M
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:2.0.2:testCompile (default-testCompile) on project hbase: Compilation failure: Compilation failure:
[ERROR] /home/jon/proj/hbase-0.94/src/test/java/org/apache/hadoop/hbase/mapreduce/TestHLogRecordReader.java:[147,46] org.apache.hadoop.mapreduce.JobContext is abstract; cannot be instantiated
[ERROR] 
[ERROR] /home/jon/proj/hbase-0.94/src/test/java/org/apache/hadoop/hbase/mapreduce/TestHLogRecordReader.java:[153,29] org.apache.hadoop.mapreduce.JobContext is abstract; cannot be instantiated
[ERROR] 
[ERROR] /home/jon/proj/hbase-0.94/src/test/java/org/apache/hadoop/hbase/mapreduce/TestHLogRecordReader.java:[194,46] org.apache.hadoop.mapreduce.JobContext is abstract; cannot be instantiated
[ERROR] 
[ERROR] /home/jon/proj/hbase-0.94/src/test/java/org/apache/hadoop/hbase/mapreduce/TestHLogRecordReader.java:[206,29] org.apache.hadoop.mapreduce.JobContext is abstract; cannot be instantiated
[ERROR] 
[ERROR] /home/jon/proj/hbase-0.94/src/test/java/org/apache/hadoop/hbase/mapreduce/TestHLogRecordReader.java:[213,29] org.apache.hadoop.mapreduce.JobContext is abstract; cannot be instantiated
[ERROR] 
[ERROR] /home/jon/proj/hbase-0.94/src/test/java/org/apache/hadoop/hbase/mapreduce/TestHLogRecordReader.java:[226,29] org.apache.hadoop.mapreduce.TaskAttemptContext is abstract; cannot be instantiated
[ERROR] -&gt; [Help 1]
{code}

Upon further investigation this issue is due to code introduced in HBASE-5064 and is also present in trunk.  
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                @Jon Which code breaks the build?  The hbase-5064 changes have been in there with a good while now.
              </div></li><li><div>
                In branch-1, JobContext is a class.

{code}
public class JobContext {
{code}

Now in hadoop trunk or hadoop-2, that is changed to interface.

{code}
@InterfaceAudience.Public
@InterfaceStability.Evolving
public interface JobContext extends MRJobConfig {
{code}
              </div></li><li><div>
                @Stack, I did some basic testing on 0.94rc0 and it compiled fine there.  Didn't try rc1 (might be there) but rc2 definitely got the issue.  I'm working on a shimming patch to handle this.
              </div></li><li><div>
                @Jon Good stuff.  Looks like our Andrew saw this before we did over in HBASE-5807: "JobContext and TaskAttemptContext are only interfaces in 0.23+. TestHLogRecordReader should be reimplemented with a different approach."  I'll mark that issue dup of this.
              </div></li><li><div>
                Just realized it was me who added this test as part of HBASE-5604... :(

I should fix it.

              </div></li><li><div>
                @Lars I'm pretty close now -- testing some reflection stuff, have one of the MR tests failing currently.
              </div></li><li><div>
                I have a fix. There's util method in MapReduceTestUtil to create a dummy TaskAttemptContext.
Will upload a patch momentarily.
              </div></li><li><div>
                Works fine for Hadoop 1.0.* and should work for 0.23.*.

For various other reasons I cannot currently build against hadoop 0.23, if somebody could quick verify, that'd be great.

              </div></li><li><div>
                Ah nope, there's the JobContext too.
              </div></li><li><div>
                @Lars you can verify your fix via 'mvn clean test -Dhadoop.profile=23 -DskipTests'.  It will download the hadoop 23 version of the world and test against it.
              </div></li><li><div>
                @Jon: Tried that. For some reason I get 100's of compilation errors complaining about missing hadoop packages.
              </div></li><li><div>
                Here's where I am currently.  TestImportExport fails -- doesn't seem to copy jars into mr distributed cache properly.
              </div></li><li><div>
                Did you forget to include HadoopShim?
              </div></li><li><div><div><b>body:</b> Lars you are right, I missed the HadoopShim file.  It ends up that some of the mr tests seem to be flakey on my vm -- TestImportExport passes sometime.

Note - v2 is a sketch -- I've got another version that refactors this slightly to be cleaner.
                </div><div><b>label:</b> test
                </div></div></li><li><div><div><b>body:</b> For TaskAttemptContext we could use Hadoop's MapReduceTestUtil class, right? I.e. HadoopShim could use MapReduceTestUtil.createDummyMapTaskAttemptContext(...)
For JobContext, why not use JobContextImpl in hadoop2?

Rest looks good.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I'm less familiar with the MR API and didn't know those existed.  Sound like good suggestions.  I'll try it on the next version I post.  (likely late tonight).
              </div></li><li><div>
                Problem above was due to Maven 2... Grrrr.
              </div></li><li><div>
                How about this one. (slight variation of Jon's patch).
              </div></li><li><div>
                You uploaded wrong patch boss?
              </div></li><li><div>
                Whoops... Removed.
              </div></li><li><div>
                My patch didn't work anyway, since MapReduceTestUtil is a test class in Hadoop.

This brings to another point: Some of the HBase tests need this lower layer for UnitTests, but the "production" part of HBase should not operate at this layer.

So whatever fix we have for this, should only involve test code. If folks agree with this then HadoopShim should be a test class.

              </div></li><li><div>
                I'll have a sketch of what I mean a bit later.
              </div></li><li><div>
                Does HBASE-5853 need to get fixed too?  It looks like a 0.23 issue also?
              </div></li><li><div>
                Seems that way. And that is not just a test issue. So going from that HadoopShim needs to be part of "production" HBase.

              </div></li><li><div>
                I am generally a bit unclear at what point we require a recompile of HBase against a specific version of Hadoop and when we make it "just work" via reflection.

              </div></li><li><div><div><b>body:</b> There are two classes of changes I'm aware of currently:

1) Class becomes Interface -&gt; which means constructors for some things have moved to be impls.  Seems to be ok with reflection.
2) Enum moved to different new class, and original class exists for compatibility as a subclass of new class.  This seems to require recompile because this confuses class loader.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                We shouldn't use JobContextImpl or TaskAttemptContextImpl since it is marked:

{code}
@InterfaceAudience.Private
{code}

My guess is that HBASE-5853 may be something else -- possibly a class path or jar compatibility problem.  At first glance it looks over there that only public apis are used.  

I'll move the previous patch to be a HadoopTestShim in hbase tests and use MapReduceTestUtil.  At the moment this seems to be isolated to tests.  If we need to have a shim for production code, we can make a new HadoopShim for those calls. 
              </div></li><li><div>
                Currently looks like InputSampler (a sampler for bulk loads) and friends are probably broken in 23 because it uses the  TaskAttemptContext constructor which is hadoop 1.x specific.  We didn't catch this because currently there are no tests exercising this code. If we use MapReduceTestUtil to get a dummy, we'd need to pull in the hadoop-test jar to compile.

Against hadoop 23, MapReduceTestUtil is included in the jars pulled in for compile and test.
              </div></li><li><div>
                The comment in InputSampler also says that one should use the actual Hadoop code in 0.23+ (not the backported code), so I would guess that this would be OK as long as there is no compile time error.

If the only problem is TestHLogRecordReader, I should just fix up the test and be done with this.

              </div></li><li><div><div><b>body:</b> v3 is a cleaned up version, and doesn't touch InputSampler.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I got the following with v3 using 0.23 profile:
{code}
[ERROR] /Users/zhihyu/trunk-hbase/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java:[1333,35] cannot find symbol
[ERROR] symbol  : method getJobTracker()
[ERROR] location: class org.apache.hadoop.mapred.MiniMRCluster.JobTrackerRunner
{code}
              </div></li><li><div>
                Sorry about that -- only tested the latest against 0.94.
              </div></li><li><div>
                -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12524020/hbase-5861-v3.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 5 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 findbugs.  The patch appears to introduce 5 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

     -1 core tests.  The patch failed these unit tests:
                       org.apache.hadoop.hbase.TestRegionRebalancing

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/1629//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/1629//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/1629//console

This message is automatically generated.
              </div></li><li><div>
                +1 on v3 for 0.94. JobTrackerRunner.getJobTracker is a separate issue for trunk.
              </div></li><li><div>
                The JobTrackerRunner.getJobTracker issue is a separate unrelated issue broken on trunk but not 0.94.
              </div></li><li><div>
                Yep. So let's get this issue into 0.94 and trunk.

+1 from me for v3 in 0.94 and trunk.

Then we file a separate issue for trunk to deal with JobTrackerRunner.getJobTracker.

              </div></li><li><div>
                Patch v4 adds support for obtaining JobConf.

TestHLogRecordReader passes using either hadoop 1.0 or 0.23 profile.
              </div></li><li><div>
                I'm going to commit v3 to 0.94 and trunk and then file a new issue for the additions in v4 since the problem only occurs on trunk and not 0.94.  Before committing the additions I'd want to spend some time figuring out why that new geTJobTracker issue showed up.




              </div></li><li><div>
                Thanks for review Lars.  Committed.


Create follow on issue for Ted's Addendum (since it only affects trunk).
              </div></li><li><div>
                -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12524083/5861-v4.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 9 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 findbugs.  The patch appears to introduce 5 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

     -1 core tests.  The patch failed these unit tests:
                       org.apache.hadoop.hbase.TestRegionRebalancing

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/1633//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/1633//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/1633//console

This message is automatically generated.
              </div></li><li><div>
                Awesome. Thanks Jon and Ted.
              </div></li><li><div>
                As Ted points out MapreduceTestingShim.java is missing :), build is broken (0.94 and trunk)
              </div></li><li><div>
                Oops.  I've added an addendum.  
              </div></li><li><div>
                Integrated in HBase-0.94-security #20 (See [https://builds.apache.org/job/HBase-0.94-security/20/])
    HBASE-5861 ADDENDUM (missed new MapredcueTestingShim.java file) (Revision 1330077)
HBASE-5861 Hadoop 23 compile broken due to tests introduced in HBASE-5064 (Revision 1330071)

     Result = SUCCESS
jmhsieh : 
Files : 
* /hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/mapreduce/MapreduceTestingShim.java

jmhsieh : 
Files : 
* /hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/mapreduce/TestHLogRecordReader.java

              </div></li><li><div>
                Integrated in HBase-0.94 #146 (See [https://builds.apache.org/job/HBase-0.94/146/])
    HBASE-5861 ADDENDUM (missed new MapredcueTestingShim.java file) (Revision 1330077)
HBASE-5861 Hadoop 23 compile broken due to tests introduced in HBASE-5064 (Revision 1330071)

     Result = FAILURE
jmhsieh : 
Files : 
* /hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/mapreduce/MapreduceTestingShim.java

jmhsieh : 
Files : 
* /hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/mapreduce/TestHLogRecordReader.java

              </div></li><li><div>
                Integrated in HBase-TRUNK #2809 (See [https://builds.apache.org/job/HBase-TRUNK/2809/])
    HBASE-5861 ADDENDUM (missed new MapredcueTestingShim.java file) (Revision 1330078)
HBASE-5861 Hadoop 23 compile broken due to tests introduced in HBASE-5064 (Revision 1330072)

     Result = FAILURE
jmhsieh : 
Files : 
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/mapreduce/MapreduceTestingShim.java

jmhsieh : 
Files : 
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/mapreduce/TestHLogRecordReader.java

              </div></li><li><div>
                Integrated in HBase-TRUNK-security #183 (See [https://builds.apache.org/job/HBase-TRUNK-security/183/])
    HBASE-5861 ADDENDUM (missed new MapredcueTestingShim.java file) (Revision 1330078)
HBASE-5861 Hadoop 23 compile broken due to tests introduced in HBASE-5064 (Revision 1330072)

     Result = FAILURE
jmhsieh : 
Files : 
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/mapreduce/MapreduceTestingShim.java

jmhsieh : 
Files : 
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/mapreduce/TestHLogRecordReader.java

              </div></li><li><div>
                Oops, commit message should say HBASE-5604 instead of HBASE-5064.
              </div></li></ol></div></div></html>