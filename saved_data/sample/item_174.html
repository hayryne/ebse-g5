<!DOCTYPE html><html><div class="item-title">
        Item 174
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div><div><b>comment:</b>  Maven-to-Aether Artifact cache, as parsing strings is expensive
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                *
     * Convert PAX URL mvn format to an aether Artifact.
     * N.B. we do not handle repository-url in mvn urls.
     * N.B. version is required in mvn urls.
     *
     * @param name PAX URL mvn format: mvn-uri := [ 'wrap:' ] 'mvn:' [ repository-url '!' ] group-id '/' artifact-id [ '/' [version] [ '/' [type] [ '/' classifier ] ] ] ]
     * @return aether Artifact
     
              </div></li><li><div>
                *
     * Convert Aether coordinate format to an aether Artifact.
     * N.B. we do not handle repository-url in mvn urls.
     * N.B. version is required in mvn urls.
     *
     * @param name aether coordinate format: &amp;lt;groupId&amp;gt;:&amp;lt;artifactId&amp;gt;[:&amp;lt;extension&amp;gt;[:&amp;lt;classifier&amp;gt;]]:&amp;lt;version&amp;gt;
     * @return aether Artifact
     
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [KARAF-5604] Speed up descriptor generation (#446)
                </div><div><b>message:</b> [KARAF-5604] Speed up descriptor generation (#446)

* KARAF-5604: Check log.isDebugEnabled() before string concat &amp; cache aether Artifacts

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [KARAF-5604] Speed up descriptor generation
                </div><div><b>body:</b> Profiling has turned out two more inefficiencies:
- calling log.debug() with a concatenated string -- we end up wasting time constructing the string, which is never logged
- aether's DefaultArtifact(String) is extremely slow due to Pattern.compile() it contains

                </div></div></li><li><div><div><b>title:</b> [KARAF-5604] Speed up descriptor generation
                </div><div><b>body:</b> Profiling has turned out two more inefficiencies:
- calling log.debug() with a concatenated string -- we end up wasting time constructing the string, which is never logged
- aether's DefaultArtifact(String) is extremely slow due to Pattern.compile() it contains

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [KARAF-5604] Speed up descriptor generation
                </div><div><b>body:</b> Profiling has turned out two more inefficiencies:
- calling log.debug() with a concatenated string -- we end up wasting time constructing the string, which is never logged
- aether's DefaultArtifact(String) is extremely slow due to Pattern.compile() it contains

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                retest this please
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> karaf:features-generate-descriptor takes long when faced with complex feature dependencies
                </div><div><b>description:</b> Opendaylight's distribution-check jobs generate features which have complex feature dependencies, which exposes scaling issues in karaf:features-generate-descriptor.

[https://github.com/opendaylight/integration-distribution/tree/master/features/singles/odl-integration-all] takes ~270 seconds to generate:

real 4m28.834s
user 3m40.287s
sys 1m23.629s

[https://github.com/opendaylight/integration-distribution/tree/master/features/repos/index] takes ~638 seconds to generate:

real 10m38.859s
user 7m55.004s
sys 3m17.269s

Running profiling shows that this time is dominated by short-lived FileInputStreams being generated at a rate of 7K-8Kps â€“ which are coming from both feature reading and from artifact resolution.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                rovarga opened a new pull request #444: KARAF-5604: Speed up features-generate-descriptor
URL: https://github.com/apache/karaf/pull/444
 
 
   OpenDaylight uses features-generate-descriptor to process a rather
   large set (~196) of features being used as dependencies of a generated
   feature. These features also contain a large number of bundles.
   
   This patch introduces an explicit SimplLRUCache based on LinkedHashMap,
   and places it into both GenerateDescriptorMojo and Dependency31Helper.
   The size of the two cache instances can be controlled via plugin configuration
   and default to 256 and 1024 entries respectively.
   
   Signed-off-by: Robert Varga &lt;nite@hq.sk&gt;

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                With [https://github.com/apache/karaf/pull/444] these get reduced to:

real&nbsp;&nbsp;&nbsp; 1m13.746s
user&nbsp;&nbsp;&nbsp; 1m30.977s
sys&nbsp;&nbsp;&nbsp;&nbsp; 0m11.720s

&nbsp;

and

real&nbsp;&nbsp;&nbsp; 2m57.660s
user&nbsp;&nbsp;&nbsp; 3m8.552s
sys&nbsp;&nbsp;&nbsp;&nbsp; 0m28.247s
              </div></li><li><div>
                jbonofre closed pull request #444: [KARAF-5604] Speed up features-generate-descriptor
URL: https://github.com/apache/karaf/pull/444
 
 
   

This is a PR merged from a forked repository.
As GitHub hides the original diff on merge, it is displayed below for
the sake of provenance:

As this is a foreign pull request (from a fork), the diff is supplied
below (as it won't show otherwise due to GitHub magic):

diff --git a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/features/GenerateDescriptorMojo.java b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/features/GenerateDescriptorMojo.java
index 896c12834e..f38c2be9be 100644
--- a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/features/GenerateDescriptorMojo.java
+++ b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/features/GenerateDescriptorMojo.java
@@ -38,7 +38,6 @@
 import java.util.LinkedHashSet;
 import java.util.List;
 import java.util.Map;
-import java.util.WeakHashMap;
 import java.util.jar.JarInputStream;
 import java.util.jar.Manifest;
 
@@ -59,6 +58,7 @@
 import org.apache.karaf.tooling.utils.ManifestUtils;
 import org.apache.karaf.tooling.utils.MavenUtil;
 import org.apache.karaf.tooling.utils.MojoSupport;
+import org.apache.karaf.tooling.utils.SimpleLRUCache;
 import org.apache.maven.artifact.Artifact;
 import org.apache.maven.artifact.resolver.ArtifactNotFoundException;
 import org.apache.maven.artifact.resolver.ArtifactResolutionException;
@@ -90,7 +90,7 @@
 /**
  * Generates the features XML file starting with an optional source feature.xml and adding
  * project dependencies as bundles and feature/car dependencies.
- * 
+ *
  * NB this requires a recent maven-install-plugin such as 2.3.1
  */
 @Mojo(name = "features-generate-descriptor", defaultPhase = LifecyclePhase.COMPILE, requiresDependencyResolution = ResolutionScope.RUNTIME, threadSafe = true)
@@ -234,14 +234,14 @@
      */
     @Parameter(defaultValue = "${project.artifactId}")
     private String primaryFeatureName;
-    
+
     /**
      * Flag indicating whether bundles should use the version range declared in the POM. If &lt;code&gt;false&lt;/code&gt;,
      * the actual version of the resolved artifacts will be used.
      */
     @Parameter(defaultValue = "false")
     private boolean useVersionRange;
-    
+
     /**
      * Flag indicating whether the plugin should determine whether transitive dependencies are declared with
      * a version range. If this flag is set to &lt;code&gt;true&lt;/code&gt; and a transitive dependency has been found
@@ -263,6 +263,19 @@
     @Parameter(defaultValue = "false")
     private boolean simplifyBundleDependencies;
 
+    /**
+     * Maximum size of the artifact LRU cache. This cache is used to prevent repeated artifact-to-file resolution.
+     */
+    @Parameter(defaultValue = "1024")
+    private int artifactCacheSize;
+
+    /**
+     * Maximum size of the Features LRU cache. This cache is used to prevent repeated deserialization of features
+     * XML files.
+     */
+    @Parameter(defaultValue = "256")
+    private int featuresCacheSize;
+
     /**
      * Name of features which are prerequisites (they still need to be defined separately).
      */
@@ -285,7 +298,7 @@
      */
     @Component
     private PlexusContainer container;
-    
+
     @Component
     private RepositorySystem repoSystem;
 
@@ -294,7 +307,7 @@
 
     @Component
     protected MavenFileFilter mavenFileFilter;
-    
+
 	@Component
 	private ProjectBuilder mavenProjectBuilder;
 
@@ -309,11 +322,12 @@
 
     // maven log
     private Log log;
-    
+
     // If useVersionRange is true, this map will be used to cache
     // resolved MavenProjects
     private final Map&lt;Artifact, MavenProject&gt; resolvedProjects = new HashMap&lt;&gt;();
 
+    @Override
     public void execute() throws MojoExecutionException, MojoFailureException {
         try {
             if (enableGeneration == null) {
@@ -333,7 +347,8 @@ public void execute() throws MojoExecutionException, MojoFailureException {
                 }
             }
 
-            this.dependencyHelper = DependencyHelperFactory.createDependencyHelper(this.container, this.project, this.mavenSession, getLog());
+            this.dependencyHelper = DependencyHelperFactory.createDependencyHelper(this.container, this.project,
+                this.mavenSession, this.artifactCacheSize, getLog());
             this.dependencyHelper.getDependencies(project, includeTransitiveDependency);
             this.localDependencies = dependencyHelper.getLocalDependencies();
             this.treeListing = dependencyHelper.getTreeListing();
@@ -359,11 +374,11 @@ private MavenProject resolveProject(final Object artifact) throws MojoExecutionE
 			resolvedProject = resolvedProjects.get(artifact);
 			if (resolvedProject == null) {
 				final ProjectBuildingRequest request = new DefaultProjectBuildingRequest();
-				
-				// Fixes KARAF-4626; if the system properties are not transferred to the request, 
+
+				// Fixes KARAF-4626; if the system properties are not transferred to the request,
 				// test-feature-use-version-range-transfer-properties will fail
 				request.setSystemProperties(System.getProperties());
-				
+
 				request.setResolveDependencies(true);
 				request.setRemoteRepositories(project.getPluginArtifactRepositories());
 				request.setLocalRepository(localRepo);
@@ -398,7 +413,7 @@ private String getVersionOrRange(final Object parent, final Object artifact) thr
 		}
 		return versionOrRange;
 	}
-    
+
     /*
      * Write all project dependencies as feature
      */
@@ -456,7 +471,7 @@ private void writeFeatures(PrintStream out) throws ArtifactResolutionException,
         // TODO Initialise the repositories from the existing feature file if any
         Map&lt;Dependency, Feature&gt; otherFeatures = new HashMap&lt;&gt;();
         Map&lt;Feature, String&gt; featureRepositories = new HashMap&lt;&gt;();
-        FeaturesCache cache = new FeaturesCache();
+        FeaturesCache cache = new FeaturesCache(featuresCacheSize);
         for (final LocalDependency entry : localDependencies) {
             Object artifact = entry.getArtifact();
 
@@ -532,7 +547,7 @@ private void writeFeatures(PrintStream out) throws ArtifactResolutionException,
             wrapDependency.setPrerequisite(true);
             feature.getFeature().add(wrapDependency);
         }
-        
+
         if ((!feature.getBundle().isEmpty() || !feature.getFeature().isEmpty()) &amp;&amp; !features.getFeature().contains(feature)) {
             features.getFeature().add(feature);
         }
@@ -668,14 +683,16 @@ private Manifest getManifest(File file) throws IOException {
         }
     }
 
-    private static Features readFeaturesFile(File featuresFile) throws XMLStreamException, JAXBException, IOException {
+    static Features readFeaturesFile(File featuresFile) throws XMLStreamException, JAXBException, IOException {
         return JaxbUtil.unmarshal(featuresFile.toURI().toASCIIString(), false);
     }
 
+    @Override
     public void setLog(Log log) {
         this.log = log;
     }
 
+    @Override
     public Log getLog() {
         if (log == null) {
             setLog(new SystemStreamLog());
@@ -927,16 +944,20 @@ protected String saveTreeListing() throws IOException {
     }
 
     private static final class FeaturesCache {
-        private final Map&lt;File, Features&gt; map = new WeakHashMap&lt;&gt;();
+        private final SimpleLRUCache&lt;File, Features&gt; cache;
+
+        FeaturesCache(int featuresCacheSize) {
+            cache = new SimpleLRUCache&lt;&gt;(featuresCacheSize);
+        }
 
         Features get(final File featuresFile) throws XMLStreamException, JAXBException, IOException {
-            final Features existing = map.get(featuresFile);
+            final Features existing = cache.get(featuresFile);
             if (existing != null) {
                 return existing;
             }
 
             final Features computed = readFeaturesFile(featuresFile);
-            map.put(featuresFile, computed);
+            cache.put(featuresFile, computed);
             return computed;
         }
     }
diff --git a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/Dependency31Helper.java b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/Dependency31Helper.java
index d1bfb7055b..3c139008ff 100644
--- a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/Dependency31Helper.java
+++ b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/Dependency31Helper.java
@@ -71,25 +71,32 @@
      */
     private final List&lt;RemoteRepository&gt; projectRepositories;
 
+    private final SimpleLRUCache&lt;Artifact, ArtifactResult&gt; artifactCache;
+
     // dependencies we are interested in
     protected Map&lt;Artifact, LocalDependency&gt; localDependencies;
     // log of what happened during search
     protected String treeListing;
 
     @SuppressWarnings("unchecked")
-    public Dependency31Helper(List&lt;?&gt; repositories, Object session, RepositorySystem repositorySystem) {
+    public Dependency31Helper(List&lt;?&gt; repositories, Object session, RepositorySystem repositorySystem, int cacheSize) {
         this.projectRepositories = (List&lt;RemoteRepository&gt;) repositories;
         this.repositorySystemSession = (RepositorySystemSession) session;
         this.repositorySystem = repositorySystem;
+        this.artifactCache = new SimpleLRUCache&lt;&gt;(cacheSize);
+    }
+
+    public Dependency31Helper(List&lt;?&gt; repositories, Object session, RepositorySystem repositorySystem) {
+        this(repositories, session, repositorySystem, 32);
+    }
+
+    public void setRepositorySession(final ProjectBuildingRequest request) throws MojoExecutionException {
+        try {
+            invokeMethod(request, "setRepositorySession", repositorySystemSession);
+        } catch (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) {
+            throw new MojoExecutionException("Cannot set repository session on project building request", e);
+        }
     }
-    
-	public void setRepositorySession(final ProjectBuildingRequest request) throws MojoExecutionException {
-		try {
-			invokeMethod(request, "setRepositorySession", repositorySystemSession);
-		} catch (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) {
-			throw new MojoExecutionException("Cannot set repository session on project building request", e);
-		}
-	}
 
     @Override
     public Collection&lt;LocalDependency&gt; getLocalDependencies() {
@@ -281,7 +288,7 @@ public static boolean isFeature(Artifact artifact) {
     public boolean isArtifactAFeature(Object artifact) {
         return Dependency31Helper.isFeature((Artifact) artifact);
     }
-    
+
 	@Override
 	public String getBaseVersion(Object artifact) {
 		return ((Artifact) artifact).getBaseVersion();
@@ -302,17 +309,30 @@ public String getClassifier(Object artifact) {
         return ((Artifact) artifact).getClassifier();
     }
 
-    @Override
-    public File resolve(Object artifact, Log log) {
+    private ArtifactResult resolveArtifact(Artifact artifact) throws ArtifactResolutionException {
+        ArtifactResult result = artifactCache.get(artifact);
+        if (result != null) {
+            return result;
+        }
+
         ArtifactRequest request = new ArtifactRequest();
-        request.setArtifact((Artifact) artifact);
+        request.setArtifact(artifact);
         request.setRepositories(projectRepositories);
 
+        result = repositorySystem.resolveArtifact(repositorySystemSession, request);
+        if (result != null) {
+            artifactCache.put(artifact, result);
+        }
+        return result;
+    }
+
+    @Override
+    public File resolve(Object artifact, Log log) {
         log.debug("Resolving artifact " + artifact + " from " + projectRepositories);
 
         ArtifactResult result;
         try {
-            result = repositorySystem.resolveArtifact(repositorySystemSession, request);
+            result = resolveArtifact((Artifact) artifact);
         } catch (ArtifactResolutionException e) {
             log.warn("Cound not resolve " + artifact, e);
             return null;
@@ -334,15 +354,12 @@ public File resolveById(String id, Log log) throws MojoFailureException {
             }
         }
         id = MavenUtil.mvnToAether(id);
-        ArtifactRequest request = new ArtifactRequest();
-        request.setArtifact(new DefaultArtifact(id));
-        request.setRepositories(projectRepositories);
 
         log.debug("Resolving artifact " + id + " from " + projectRepositories);
 
         ArtifactResult result;
         try {
-            result = repositorySystem.resolveArtifact(repositorySystemSession, request);
+            result = resolveArtifact(new DefaultArtifact(id));
         } catch (ArtifactResolutionException e) {
             log.warn("Could not resolve " + id, e);
             throw new MojoFailureException(format("Couldn't resolve artifact %s", id), e);
diff --git a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/DependencyHelperFactory.java b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/DependencyHelperFactory.java
index d091c960ea..52bea523f6 100644
--- a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/DependencyHelperFactory.java
+++ b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/DependencyHelperFactory.java
@@ -44,6 +44,7 @@
      * @param container    The Maven Plexus container to use.
      * @param mavenProject The Maven project to use.
      * @param mavenSession The Maven session.
+     * @param cacheSize    Size of the artifact-&gt;file LRU cache
      * @param log          The log to use for the messages.
      *
      * @return The {@link DependencyHelper} depending of the Maven version used.
@@ -51,13 +52,13 @@
      * @throws MojoExecutionException If the plugin execution fails.
      */
     public static DependencyHelper createDependencyHelper(
-            PlexusContainer container, MavenProject mavenProject, MavenSession mavenSession, Log log
-                                                         ) throws MojoExecutionException {
+            PlexusContainer container, MavenProject mavenProject, MavenSession mavenSession, int cacheSize, Log log
+            ) throws MojoExecutionException {
         try {
             final RepositorySystem system = container.lookup(RepositorySystem.class);
             final RepositorySystemSession session = mavenSession.getRepositorySession();
             final List&lt;RemoteRepository&gt; repositories = mavenProject.getRemoteProjectRepositories();
-            return new Dependency31Helper(repositories, session, system);
+            return new Dependency31Helper(repositories, session, system, cacheSize);
         } catch (ComponentLookupException e) {
             throw new MojoExecutionException(e.getMessage(), e);
         }
diff --git a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/SimpleLRUCache.java b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/SimpleLRUCache.java
new file mode 100644
index 0000000000..98ad90f494
--- /dev/null
+++ b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/SimpleLRUCache.java
@@ -0,0 +1,45 @@
+/**
+ *
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.karaf.tooling.utils;
+
+import java.util.LinkedHashMap;
+import java.util.Map.Entry;
+
+/**
+ * A very simplistic LRU cache based on LinkedHashMap. It grows up to the size specified in the constructor,
+ * evicting least recently accessed entries to keep the size there.
+ */
+public final class SimpleLRUCache&lt;K, V&gt; extends LinkedHashMap&lt;K, V&gt; {
+    private static final long serialVersionUID = 1L;
+
+    private final int maxEntries;
+
+    public SimpleLRUCache(int maxEntries) {
+        this(16, 0.75f, maxEntries);
+    }
+
+    public SimpleLRUCache(int initialSize, float loadFactor, int maxEntries) {
+        super(initialSize, loadFactor, true);
+        this.maxEntries = maxEntries;
+    }
+
+    @Override
+    protected boolean removeEldestEntry(Entry&lt;K, V&gt; eldest) {
+        return size() &gt; maxEntries;
+    }
+}


 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                Commit 6d10058da48fe9846fb673aabd39a98dcadb2506 in karaf's branch refs/heads/master from [~nite]
[ https://gitbox.apache.org/repos/asf?p=karaf.git;h=6d10058 ]

KARAF-5604: Speed up features-generate-descriptor

OpenDaylight uses features-generate-descriptor to process a rather
large set (~196) of features being used as dependencies of a generated
feature. These features also contain a large number of bundles.

This patch introduces an explicit SimplLRUCache based on LinkedHashMap,
and places it into both GenerateDescriptorMojo and Dependency31Helper.
The size of the two cache instances can be controlled via plugin configuration
and default to 256 and 1024 entries respectively.

Signed-off-by: Robert Varga &lt;nite@hq.sk&gt;

              </div></li><li><div>
                Commit b9a899749163529ac188f0562693d231991c30a7 in karaf's branch refs/heads/karaf-4.1.x from [~nite]
[ https://gitbox.apache.org/repos/asf?p=karaf.git;h=b9a8997 ]

[KARAF-5604] Speed up features-generate-descriptor

OpenDaylight uses features-generate-descriptor to process a rather
large set (~196) of features being used as dependencies of a generated
feature. These features also contain a large number of bundles.

This patch introduces an explicit SimplLRUCache based on LinkedHashMap,
and places it into both GenerateDescriptorMojo and Dependency31Helper.
The size of the two cache instances can be controlled via plugin configuration
and default to 256 and 1024 entries respectively.

Signed-off-by: Robert Varga &lt;nite@hq.sk&gt;

              </div></li><li><div><div><b>body:</b> Actually, based on profiling I think we can do a lot better with just two more patches.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Waiting your PRs to do the review ;)
              </div></li><li><div>
                rovarga opened a new pull request #446: KARAF-5604: Speed up descriptor generation
URL: https://github.com/apache/karaf/pull/446
 
 
   Profiling has turned out two more inefficiencies:
   - calling log.debug() with a concatenated string -- we end up wasting time constructing the string, which is never logged
   - aether's DefaultArtifact(String) is extremely slow due to Pattern.compile() it contains
   

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                jbonofre closed pull request #446: [KARAF-5604] Speed up descriptor generation
URL: https://github.com/apache/karaf/pull/446
 
 
   

This is a PR merged from a forked repository.
As GitHub hides the original diff on merge, it is displayed below for
the sake of provenance:

As this is a foreign pull request (from a fork), the diff is supplied
below (as it won't show otherwise due to GitHub magic):

diff --git a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/features/GenerateDescriptorMojo.java b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/features/GenerateDescriptorMojo.java
index f38c2be9be..b644540d93 100644
--- a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/features/GenerateDescriptorMojo.java
+++ b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/features/GenerateDescriptorMojo.java
@@ -471,7 +471,7 @@ private void writeFeatures(PrintStream out) throws ArtifactResolutionException,
         // TODO Initialise the repositories from the existing feature file if any
         Map&lt;Dependency, Feature&gt; otherFeatures = new HashMap&lt;&gt;();
         Map&lt;Feature, String&gt; featureRepositories = new HashMap&lt;&gt;();
-        FeaturesCache cache = new FeaturesCache(featuresCacheSize);
+        FeaturesCache cache = new FeaturesCache(featuresCacheSize, artifactCacheSize);
         for (final LocalDependency entry : localDependencies) {
             Object artifact = entry.getArtifact();
 
@@ -585,10 +585,10 @@ private void processFeatureArtifact(Features features, Feature feature, Map&lt;Depe
                 throw new MojoExecutionException(
                         "Cannot locate file for feature: " + artifact + " at " + featuresFile);
             }
-            Features includedFeatures = cache.get(featuresFile);
+            Features includedFeatures = cache.getFeature(featuresFile);
             for (String repository : includedFeatures.getRepository()) {
                 processFeatureArtifact(features, feature, otherFeatures, featureRepositories, cache,
-                        new DefaultArtifact(MavenUtil.mvnToAether(repository)), parent, false);
+                        cache.getArtifact(repository), parent, false);
             }
             for (Feature includedFeature : includedFeatures.getFeature()) {
                 Dependency dependency = new Dependency(includedFeature.getName(), includedFeature.getVersion());
@@ -944,20 +944,27 @@ protected String saveTreeListing() throws IOException {
     }
 
     private static final class FeaturesCache {
-        private final SimpleLRUCache&lt;File, Features&gt; cache;
+        // Maven-to-Aether Artifact cache, as parsing strings is expensive
+        private final SimpleLRUCache&lt;String, DefaultArtifact&gt; artifactCache;
+        private final SimpleLRUCache&lt;File, Features&gt; featuresCache;
 
-        FeaturesCache(int featuresCacheSize) {
-            cache = new SimpleLRUCache&lt;&gt;(featuresCacheSize);
+        FeaturesCache(int featuresCacheSize, int artifactCacheSize) {
+            featuresCache = new SimpleLRUCache&lt;&gt;(featuresCacheSize);
+            artifactCache = new SimpleLRUCache&lt;&gt;(artifactCacheSize);
         }
 
-        Features get(final File featuresFile) throws XMLStreamException, JAXBException, IOException {
-            final Features existing = cache.get(featuresFile);
+        DefaultArtifact getArtifact(String mavenName) {
+            return artifactCache.computeIfAbsent(mavenName, MavenUtil::mvnToArtifact);
+        }
+
+        Features getFeature(final File featuresFile) throws XMLStreamException, JAXBException, IOException {
+            final Features existing = featuresCache.get(featuresFile);
             if (existing != null) {
                 return existing;
             }
 
             final Features computed = readFeaturesFile(featuresFile);
-            cache.put(featuresFile, computed);
+            featuresCache.put(featuresFile, computed);
             return computed;
         }
     }
diff --git a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/Dependency31Helper.java b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/Dependency31Helper.java
index 3c139008ff..29c25d0732 100644
--- a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/Dependency31Helper.java
+++ b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/Dependency31Helper.java
@@ -328,7 +328,9 @@ private ArtifactResult resolveArtifact(Artifact artifact) throws ArtifactResolut
 
     @Override
     public File resolve(Object artifact, Log log) {
-        log.debug("Resolving artifact " + artifact + " from " + projectRepositories);
+        if (log.isDebugEnabled()) {
+            log.debug("Resolving artifact " + artifact + " from " + projectRepositories);
+        }
 
         ArtifactResult result;
         try {
@@ -338,7 +340,10 @@ public File resolve(Object artifact, Log log) {
             return null;
         }
 
-        log.debug("Resolved artifact " + artifact + " to " + result.getArtifact().getFile() + " from " + result.getRepository());
+        if (log.isDebugEnabled()) {
+            log.debug("Resolved artifact " + artifact + " to " + result.getArtifact().getFile() + " from "
+                    + result.getRepository());
+        }
 
         return result.getArtifact().getFile();
     }
@@ -355,17 +360,22 @@ public File resolveById(String id, Log log) throws MojoFailureException {
         }
         id = MavenUtil.mvnToAether(id);
 
-        log.debug("Resolving artifact " + id + " from " + projectRepositories);
+        if (log.isDebugEnabled()) {
+            log.debug("Resolving artifact " + id + " from " + projectRepositories);
+        }
 
         ArtifactResult result;
         try {
-            result = resolveArtifact(new DefaultArtifact(id));
+            result = resolveArtifact(MavenUtil.aetherToArtifact(id));
         } catch (ArtifactResolutionException e) {
             log.warn("Could not resolve " + id, e);
             throw new MojoFailureException(format("Couldn't resolve artifact %s", id), e);
         }
 
-        log.debug("Resolved artifact " + id + " to " + result.getArtifact().getFile() + " from " + result.getRepository());
+        if (log.isDebugEnabled()) {
+            log.debug("Resolved artifact " + id + " to " + result.getArtifact().getFile() + " from "
+                    + result.getRepository());
+        }
 
         return result.getArtifact().getFile();
     }
@@ -411,8 +421,7 @@ private static Artifact toArtifact(org.apache.maven.artifact.Artifact artifact)
 
     @Override
     public org.apache.maven.artifact.Artifact mvnToArtifact(String name) throws MojoExecutionException {
-        name = MavenUtil.mvnToAether(name);
-        DefaultArtifact artifact = new DefaultArtifact(name);
+        DefaultArtifact artifact = MavenUtil.mvnToArtifact(name);
         org.apache.maven.artifact.Artifact mavenArtifact = toArtifact(artifact);
         return mavenArtifact;
     }
@@ -431,7 +440,7 @@ public String pathFromMaven(String name) throws MojoExecutionException {
 
     @Override
     public String pathFromAether(String name) throws MojoExecutionException {
-        DefaultArtifact artifact = new DefaultArtifact(name);
+        DefaultArtifact artifact = MavenUtil.aetherToArtifact(name);
         org.apache.maven.artifact.Artifact mavenArtifact = toArtifact(artifact);
         return MavenUtil.layout.pathOf(mavenArtifact);
     }
diff --git a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/MavenUtil.java b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/MavenUtil.java
index 13fcd80538..1803e866ed 100644
--- a/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/MavenUtil.java
+++ b/tooling/karaf-maven-plugin/src/main/java/org/apache/karaf/tooling/utils/MavenUtil.java
@@ -34,6 +34,7 @@
 import org.apache.maven.artifact.repository.metadata.SnapshotVersion;
 import org.apache.maven.artifact.repository.metadata.Versioning;
 import org.apache.maven.artifact.repository.metadata.io.xpp3.MetadataXpp3Writer;
+import org.eclipse.aether.artifact.DefaultArtifact;
 import org.eclipse.aether.repository.RemoteRepository;
 
 /**
@@ -79,6 +80,58 @@ public static String mvnToAether(String name) {
         return b.toString();
     }
 
+    /**
+     * Convert PAX URL mvn format to an aether Artifact.
+     * N.B. we do not handle repository-url in mvn urls.
+     * N.B. version is required in mvn urls.
+     *
+     * @param name PAX URL mvn format: mvn-uri := [ 'wrap:' ] 'mvn:' [ repository-url '!' ] group-id '/' artifact-id [ '/' [version] [ '/' [type] [ '/' classifier ] ] ] ]
+     * @return aether Artifact
+     */
+    public static DefaultArtifact mvnToArtifact(String name) {
+        Matcher m = mvnPattern.matcher(name);
+        if (!m.matches()) {
+            return new DefaultArtifact(name);
+        }
+
+        String groupId = m.group(1);
+        String artifactId = m.group(2);
+        String version = m.group(3);
+        String extension = m.group(5);
+        if (!present(extension)) {
+            extension = "jar";
+        }
+        String classifier = m.group(7);
+
+        return new DefaultArtifact(groupId, artifactId, present(classifier) ? classifier : "", extension, version);
+    }
+
+    /**
+     * Convert Aether coordinate format to an aether Artifact.
+     * N.B. we do not handle repository-url in mvn urls.
+     * N.B. version is required in mvn urls.
+     *
+     * @param name aether coordinate format: &amp;lt;groupId&amp;gt;:&amp;lt;artifactId&amp;gt;[:&amp;lt;extension&amp;gt;[:&amp;lt;classifier&amp;gt;]]:&amp;lt;version&amp;gt;
+     * @return aether Artifact
+     */
+    public static DefaultArtifact aetherToArtifact(String name) {
+        Matcher m = aetherPattern.matcher(name);
+        if (!m.matches()) {
+            return new DefaultArtifact(name);
+        }
+
+        String groupId = m.group(1);
+        String artifactId = m.group(2);
+        String version = m.group(7);
+        String extension = m.group(4);
+        if (!present(extension)) {
+            extension = "jar";
+        }
+        String classifier = m.group(6);
+
+        return new DefaultArtifact(groupId, artifactId, present(classifier) ? classifier : "", extension, version);
+    }
+
     private static boolean present(String part) {
         return part != null &amp;&amp; !part.isEmpty();
     }


 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                Commit cbc97ec20499a5d08f419cdd91c775dd219b4fe1 in karaf's branch refs/heads/master from [~nite]
[ https://gitbox.apache.org/repos/asf?p=karaf.git;h=cbc97ec ]

[KARAF-5604] Speed up descriptor generation (#446)

* KARAF-5604: Check log.isDebugEnabled() before string concat &amp; cache aether Artifacts

              </div></li><li><div>
                Commit cbc97ec20499a5d08f419cdd91c775dd219b4fe1 in karaf's branch refs/heads/master from [~nite]
[ https://gitbox.apache.org/repos/asf?p=karaf.git;h=cbc97ec ]

[KARAF-5604] Speed up descriptor generation (#446)

* KARAF-5604: Check log.isDebugEnabled() before string concat &amp; cache aether Artifacts

              </div></li><li><div>
                Commit 89de305e4747abc1cbf1d4805ae0da92a22bd315 in karaf's branch refs/heads/karaf-4.1.x from [~nite]
[ https://gitbox.apache.org/repos/asf?p=karaf.git;h=89de305 ]

[KARAF-5604] Speed up descriptor generation (#446)

* KARAF-5604: Check log.isDebugEnabled() before string concat &amp; cache aether Artifacts

              </div></li><li><div>
                Commit 89de305e4747abc1cbf1d4805ae0da92a22bd315 in karaf's branch refs/heads/karaf-4.1.x from [~nite]
[ https://gitbox.apache.org/repos/asf?p=karaf.git;h=89de305 ]

[KARAF-5604] Speed up descriptor generation (#446)

* KARAF-5604: Check log.isDebugEnabled() before string concat &amp; cache aether Artifacts

              </div></li></ol></div></div></html>