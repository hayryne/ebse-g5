<!DOCTYPE html><html><div class="item-title">
        Item 160
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Make it look like the block report was scheduled to be sent between 1-3
 intervals ago but sent just now.
              </div></li><li><div>
                *
   * If resetBlockReportTime is false then the next block report must be scheduled
   * exactly at (now + BLOCK_REPORT_INTERVAL_SEC).
   
              </div></li><li><div>
                 5 seconds
 10 seconds
              </div></li><li><div>
                *
 * Verify the block report and heartbeat scheduling logic of BPServiceActor
 * using a few different values .
 
              </div></li><li><div>
                 test boundaries
 test integer overflow
 positive random
 negative random
              </div></li><li><div>
                *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * &lt;p/&gt;
 * http://www.apache.org/licenses/LICENSE-2.0
 * &lt;p/&gt;
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                *
   * Tests the case when a block report was delayed past its scheduled time.
   * In that case the next block report should not be delayed for a full interval.
   
              </div></li><li><div>
                *
   * If resetBlockReportTime is true then the next block report must be scheduled
   * in the range [now, now + BLOCK_REPORT_INTERVAL_SEC).
   
              </div></li><li><div>
                 send BR after random delay
 Numerical overflow is possible here and is okay.
              </div></li><li><div>
                 say the last block report was at 8:20:14. The current report
         * should have started around 9:20:14 (default 1 hour interval).
         * If current time is :
         *   1) normal like 9:20:18, next report should be at 10:20:14
         *   2) unexpected like 11:35:43, next report should be at 12:20:14
         
              </div></li><li><div>
                *
     * Wrapped for testing.
     * @return
     
              </div></li><li><div>
                 nextBlockReportTime and nextHeartbeatTime may be assigned/read
 by testing threads (through BPServiceActor#triggerXXX), while also
 assigned/read by the actor thread.
              </div></li><li><div>
                *
     * This methods  arranges for the data node to send the block report at
     * the next heartbeat.
     
              </div></li><li><div>
                *
   * Utility class that wraps the timestamp computations for scheduling
   * heartbeats and block reports.
   
              </div></li><li><div>
                *
     * Schedule the next block report after the block report interval. If the
     * current block report was delayed then the next block report is sent per
     * the original schedule.
     * Numerical overflow is possible here.
     
              </div></li><li><div>
                 Numerical overflow is possible here and is okay.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HDFS-8163. Using monotonicNow for block report scheduling causes test failures on recently restarted systems. (Arpit Agarwal)
                </div><div><b>message:</b> HDFS-8163. Using monotonicNow for block report scheduling causes test failures on recently restarted systems. (Arpit Agarwal)

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Using monotonicNow for block report scheduling causes test failures on recently restarted systems
                </div><div><b>description:</b> {{BPServiceActor#blockReport}} has the following check:

{code}
  List&lt;DatanodeCommand&gt; blockReport() throws IOException {
    // send block report if timer has expired.
    final long startTime = monotonicNow();
    if (startTime - lastBlockReport &lt;= dnConf.blockReportInterval) {
      return null;
    }
{code}

Many tests trigger an immediate block report via {{BPServiceActor#triggerBlockReportForTests}} which sets {{lastBlockReport = 0}}. However if the machine was restarted recently then startTime may be less than {{dnConf.blockReportInterval}} and the block report is not sent.

{{Time#monotonicNow}} uses {{System#nanoTime}} which represents time elapsed since an arbitrary origin. The time should be used only for comparison with other values returned by {{System#nanoTime}}.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Preliminary v01 patch for Jenkins. Not ready for review yet.
              </div></li><li><div><div><b>body:</b> {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12725980/HDFS-8163.01.patch
  against trunk revision 9595cc0.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.
                        Please justify why no new tests are needed for this patch.
                        Also please list what manual steps were performed to verify this patch.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/10292//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/10292//console

This message is automatically generated.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12726045/HDFS-8163.02.patch
  against trunk revision 9595cc0.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:

                  org.apache.hadoop.hdfs.util.TestByteArrayManager

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/10293//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/10293//console

This message is automatically generated.
              </div></li><li><div>
                {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12726045/HDFS-8163.02.patch
  against trunk revision 76e7264.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/10295//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/10295//console

This message is automatically generated.
              </div></li><li><div>
                While working on more tests I found some more issues with the timestamp usage. The [System.nanotime|https://docs.oracle.com/javase/7/docs/api/java/lang/System.html#nanoTime()] docs state that it can return a negative value and can overflow between successive invocations. So two values should never be compared directly but diffed to handle overflow.

My guess is that negative values/overflow are unlikely on the platforms we care about but we should be handling them correctly anyway. I plan to split out the timestamp handling logic of BPServiceActor into a separate utility class for clarity and ease of unit testing. Will post an updated patch later today.
              </div></li><li><div>
                Updated v03 patch to handle negative values and overflows. Split out the timestamp manipulation into a nested class Scheduler.

Reviews welcome!
              </div></li><li><div>
                {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12726311/HDFS-8163.03.patch
  against trunk revision f47a576.

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-common-project/hadoop-common hadoop-hdfs-project/hadoop-hdfs.

Test results: https://builds.apache.org/job/PreCommit-HDFS-Build/10308//testReport/
Console output: https://builds.apache.org/job/PreCommit-HDFS-Build/10308//console

This message is automatically generated.
              </div></li><li><div><div><b>body:</b> Thanks for working on this, [~arpitagarwal]! The patch looks pretty good to me. The only nits is that the following code can be reformatted:
{code}
+    @VisibleForTesting volatile long nextBlockReportTime = monotonicNow();
+    @VisibleForTesting volatile long nextHeartbeatTime = monotonicNow();
+    @VisibleForTesting boolean resetBlockReportTime = true;
{code}

I think you can address this while committing the patch. +1.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Thanks for the review Jing.

Fixed the formatting and committed to trunk, branch-2 and branch-2.7. Here is the delta:

{code:java}
-    // assigned/read by the actor thread. Thus they should be declared as vol
-    // to make sure the "happens-before" consistency.
-    @VisibleForTesting volatile long nextBlockReportTime = monotonicNow();
-    @VisibleForTesting volatile long nextHeartbeatTime = monotonicNow();
-    @VisibleForTesting boolean resetBlockReportTime = true;
+    // assigned/read by the actor thread.
+    @VisibleForTesting
+    volatile long nextBlockReportTime = monotonicNow();
+
+    @VisibleForTesting
+    volatile long nextHeartbeatTime = monotonicNow();
+
+    @VisibleForTesting
+    boolean resetBlockReportTime = true;
{code}

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-trunk-Commit #7624 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/7624/])
HDFS-8163. Using monotonicNow for block report scheduling causes test failures on recently restarted systems. (Arpit Agarwal) (arp: rev dfc1c4c303cf15afc6c3361ed9d3238562f73cbd)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPOfferService.java
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/Time.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBpServiceActorScheduler.java

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Hdfs-trunk #2103 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/2103/])
HDFS-8163. Using monotonicNow for block report scheduling causes test failures on recently restarted systems. (Arpit Agarwal) (arp: rev dfc1c4c303cf15afc6c3361ed9d3238562f73cbd)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPOfferService.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBpServiceActorScheduler.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/Time.java

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Hdfs-trunk-Java8 #162 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/162/])
HDFS-8163. Using monotonicNow for block report scheduling causes test failures on recently restarted systems. (Arpit Agarwal) (arp: rev dfc1c4c303cf15afc6c3361ed9d3238562f73cbd)
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPOfferService.java
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/Time.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBpServiceActorScheduler.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #171 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/171/])
HDFS-8163. Using monotonicNow for block report scheduling causes test failures on recently restarted systems. (Arpit Agarwal) (arp: rev dfc1c4c303cf15afc6c3361ed9d3238562f73cbd)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPOfferService.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBpServiceActorScheduler.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/Time.java

              </div></li><li><div>
                SUCCESS: Integrated in Hadoop-Yarn-trunk #905 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/905/])
HDFS-8163. Using monotonicNow for block report scheduling causes test failures on recently restarted systems. (Arpit Agarwal) (arp: rev dfc1c4c303cf15afc6c3361ed9d3238562f73cbd)
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPOfferService.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/Time.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBpServiceActorScheduler.java

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #172 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/172/])
HDFS-8163. Using monotonicNow for block report scheduling causes test failures on recently restarted systems. (Arpit Agarwal) (arp: rev dfc1c4c303cf15afc6c3361ed9d3238562f73cbd)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/Time.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBpServiceActorScheduler.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPOfferService.java

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Mapreduce-trunk #2121 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/2121/])
HDFS-8163. Using monotonicNow for block report scheduling causes test failures on recently restarted systems. (Arpit Agarwal) (arp: rev dfc1c4c303cf15afc6c3361ed9d3238562f73cbd)
* hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/util/Time.java
* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/datanode/TestBpServiceActorScheduler.java
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPOfferService.java
* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt
* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/datanode/BPServiceActor.java

              </div></li></ol></div></div></html>