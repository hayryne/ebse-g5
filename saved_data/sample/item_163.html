<!DOCTYPE html><html><div class="item-title">
        Item 163
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HADOOP-13684. Snappy may complain Hadoop is built without snappy if libhadoop is not found. Contributed by Wei-Chiu Chuang.
                </div><div><b>message:</b> HADOOP-13684. Snappy may complain Hadoop is built without snappy if libhadoop is not found. Contributed by Wei-Chiu Chuang.

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Snappy may complain Hadoop is built without snappy if libhadoop is not found.
                </div><div><b>description:</b> If for some reason libhadoop can not be found/loaded, Snappy complains Hadoop is not built with Snappy but it actually is.

{code:title=SnappyCodec.java}
public static void checkNativeCodeLoaded() {
      if (!NativeCodeLoader.isNativeCodeLoaded() ||
          !NativeCodeLoader.buildSupportsSnappy()) {
        throw new RuntimeException("native snappy library not available: " +
            "this version of libhadoop was built without " +
            "snappy support.");
      }
{code}
This case may happen with MAPREDUCE-6577.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Attach a simple fix.
              </div></li><li><div>
                | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 16s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  8m 47s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  9m  2s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 26s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  3s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 13s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 40s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 56s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 49s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  9m  5s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  9m  5s{color} | {color:green} the patch passed {color} |
| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 32s{color} | {color:orange} hadoop-common-project/hadoop-common: The patch generated 4 new + 13 unchanged - 1 fixed = 17 total (was 14) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  9s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 15s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 49s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 54s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} unit {color} | {color:red} 17m 27s{color} | {color:red} hadoop-common in the patch failed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 24s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 56m 17s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| Failed junit tests | hadoop.net.TestDNS |
| Timed out junit tests | org.apache.hadoop.http.TestHttpServerLifecycle |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:9560f25 |
| JIRA Issue | HADOOP-13684 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12831780/HADOOP-13684.001.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux dbb4dadfcfab 3.13.0-36-lowlatency #63-Ubuntu SMP PREEMPT Wed Sep 3 21:56:12 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / d6be1e7 |
| Default Java | 1.8.0_101 |
| findbugs | v3.0.0 |
| checkstyle | https://builds.apache.org/job/PreCommit-HADOOP-Build/10675/artifact/patchprocess/diff-checkstyle-hadoop-common-project_hadoop-common.txt |
| unit | https://builds.apache.org/job/PreCommit-HADOOP-Build/10675/artifact/patchprocess/patch-unit-hadoop-common-project_hadoop-common.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/10675/testReport/ |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/10675/console |
| Powered by | Apache Yetus 0.4.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.


              </div></li><li><div><div><b>body:</b> Attach v2 patch to clean up checkstyle warning. The test failure is unrelated.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Nice improvement Wei-Chiu. +1 pending jenkins.
              </div></li><li><div>
                | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 13s{color} | {color:blue} Docker mode activated. {color} |
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  7m 38s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  8m 16s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 25s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  4s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 14s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 33s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 47s{color} | {color:green} trunk passed {color} |
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 41s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  7m 58s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  7m 58s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 25s{color} | {color:green} hadoop-common-project/hadoop-common: The patch generated 0 new + 4 unchanged - 9 fixed = 4 total (was 13) {color} |
| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  1s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} mvneclipse {color} | {color:green}  0m 14s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 44s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 47s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} unit {color} | {color:red} 10m 19s{color} | {color:red} hadoop-common in the patch failed. {color} |
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 23s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 45m 11s{color} | {color:black} {color} |
\\
\\
|| Reason || Tests ||
| Failed junit tests | hadoop.ha.TestZKFailoverController |
\\
\\
|| Subsystem || Report/Notes ||
| Docker |  Image:yetus/hadoop:9560f25 |
| JIRA Issue | HADOOP-13684 |
| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12832150/HADOOP-13684.002.patch |
| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  findbugs  checkstyle  |
| uname | Linux 44e56d540bb2 3.13.0-93-generic #140-Ubuntu SMP Mon Jul 18 21:21:05 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |
| git revision | trunk / 3059b25 |
| Default Java | 1.8.0_101 |
| findbugs | v3.0.0 |
| unit | https://builds.apache.org/job/PreCommit-HADOOP-Build/10701/artifact/patchprocess/patch-unit-hadoop-common-project_hadoop-common.txt |
|  Test Results | https://builds.apache.org/job/PreCommit-HADOOP-Build/10701/testReport/ |
| modules | C: hadoop-common-project/hadoop-common U: hadoop-common-project/hadoop-common |
| Console output | https://builds.apache.org/job/PreCommit-HADOOP-Build/10701/console |
| Powered by | Apache Yetus 0.4.0-SNAPSHOT   http://yetus.apache.org |


This message was automatically generated.


              </div></li><li><div>
                Test failure is unrelated.
              </div></li><li><div>
                Committing this based on [~xiaochen]'s +1.
              </div></li><li><div>
                Committed v2 patch to trunk, branch-2 and branch-2.8. Thanks [~xiaochen] for reviewing the patch!
              </div></li><li><div>
                SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #10588 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/10588/])
HADOOP-13684. Snappy may complain Hadoop is built without snappy if (weichiu: rev 4b32b1420d98ea23460d05ae94f2698109b3d6f7)
* (edit) hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/io/compress/SnappyCodec.java

              </div></li><li><div>
                I've just opened HADOOP-14981. Essentially, I don't think this fix fixed anything.

How was it originally tested? 
              </div></li><li><div><div><b>body:</b> Thanks [~stevel@apache.org].

[~weichiu] could you provide more details?
I recall Wei-Chiu verified this internally with an escalation, where a confusing error message was seen.
{quote}. Wei-Chiu Chuang added a comment - Aug/29/17 08:32 AM
 HADOOP-13684 did not fix a bug. It simply corrects an incorrect log message more precise.
{quote}

Looking at HADOOP-14981 and this one, one possible fix could be moving the {{isNativeCodeLoaded}} check before {{buildSupportsSnappy}}.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> I think the original problem is that if snappy is present, but libhadooop missing, the error message is "no native lib". But the patch calls {{NativeCodeLoader.buildSupportsSnappy()}}, which triggers a native code load, which triggers the link exception if the native lib isn't there. Whatever was intended, the latest patch doesn't fix.

so this doesn't fix the underlying problem, merely makes the error message even less informative than before. 

The only way to fix the original problem is to have a probe for snappy being present which doesn't depend on the native lib at all
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> The regression of this commit is because it changed 
{code}
if (!NativeCodeLoader.isNativeCodeLoaded() ||		
	          !NativeCodeLoader.buildSupportsSnappy()) {		
	        throw 
	      }
{code}
to 
{code}
	    if (!NativeCodeLoader.buildSupportsSnappy()) {
	      throw
	    }
	    if (!NativeCodeLoader.isNativeCodeLoaded()) {
	      throw 
	    }
{code}.

So, I was proposing we could fix this in HADOOP-14981 by doing
{code}
	    if (!NativeCodeLoader.isNativeCodeLoaded()) {
	      throw 
	    }
	    if (!NativeCodeLoader.buildSupportsSnappy()) {
	      throw
	    }
{code}
which is behaviorally identical to before this commit, but with a different exception message. This should solve the 'original problem' IMO.

We can continue this on HADOOP-14981. I believe [~weichiu] will have cycles on this soon. :)
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> Before doing that, is it possible to have the setup: no native libhadoop, but snappy native code around and accessible. If so, it should be bypassing the native lib check; it just needs some other check
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div></div></html>