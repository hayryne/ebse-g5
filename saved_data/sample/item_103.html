<!DOCTYPE html><html><div class="item-title">
        Item 103
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 LSB 3 bits is used to locate offset within the block
              </div></li><li><div>
                *
   * Serialize a bloom filter
   *
   * @param out         output stream to write to
   * @param bloomFilter BloomKFilter that needs to be seralized
   
              </div></li><li><div>
                 Next 6 bits are used to locate offset within a long/word
              </div></li><li><div><div><b>comment:</b>  puts long in little endian order
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 first hash is used to locate start of the block (blockBaseOffset)
 subsequent K hashes are used to generate K bits within a block of words
 To avoid branches during probe, a separate masks array is used for each longs/words within a block.
 data array and masks array are then traversed together and checked for corresponding set bits.
              </div></li><li><div>
                 Validation on the bitset size/3 hash functions.
              </div></li><li><div>
                *
   * A constructor to support rebuilding the BloomFilter from a serialized representation.
   *
   * @param bits
   * @param numFuncs
   
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 
              </div></li><li><div><div><b>comment:</b>  We use the trick mentioned in "Less Hashing, Same Performance: Building a Better Bloom Filter"
 by Kirsch et.al. From abstract 'only two hash functions are necessary to effectively
 implement a Bloom filter without any loss in the asymptotic false positive probability'
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                *
     * Serialized BloomKFilter format:
     * 1 byte for the number of hash functions.
     * 1 big endian int(That is how OutputStream works) for the number of longs in the bitset
     * big endina longs in the BloomKFilter bitset
     
              </div></li><li><div>
                 Lets split up 64-bit hashcode into two 32-bit hash codes and employ the technique mentioned
 in the above paper
              </div></li><li><div><div><b>comment:</b>  puts int in little endian order
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                *
 * This is a direct modification of the Apache Hive 'BloomKFilter', found at:
 * https://github.com/apache/hive/blob/master/storage-api/src/java/org/apache/hive/common/util/BloomKFilter.java
 * modified to store variables which are re-used instead of re-allocated per call as {@link ThreadLocal} so multiple
 * threads can share the same filter object. Note that this is snapshot at hive-storag-api version 2.7.0, latest
 * versions break compatibility with how int/float are stored in a bloom filter in this commit:
 * https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238
 * and this linked issue https://issues.apache.org/jira/browse/HIVE-20101.
 *
 * Todo: remove this and begin using hive-storage-api version again once https://issues.apache.org/jira/browse/HIVE-20893 is released
 *
 * begin copy-pasta:
 *
 * BloomKFilter is variation of {@link org.apache.hive.common.util.BloomFilter}. Unlike BloomFilter, BloomKFilter will spread
 * 'k' hash bits within same cache line for better L1 cache performance. The way it works is,
 * First hash code is computed from key which is used to locate the block offset (n-longs in bitset constitute a block)
 * Subsequent 'k' hash codes are used to spread hash bits within the block. By default block size is chosen as 8,
 * which is to match cache line size (8 longs = 64 bytes = cache line size).
 * Refer {@link BloomKFilter#addBytes(byte[])} for more info.
 *
 * This implementation has much lesser L1 data cache misses than {@link org.apache.hive.common.util.BloomFilter}.
 
              </div></li><li><div>
                *
     * Clear the bit set.
     
              </div></li><li><div>
                *
     * Deserialize long array as bit set.
     *
     * @param data - bit array
     
              </div></li><li><div>
                 additional bits to pad long array to block size
              </div></li><li><div>
                 spread k-1 bits to adjacent longs, default is 8
 spreading hash bits within blockSize * longs will make bloom filter L1 cache friendly
 default block size is set to 8 as most cache line sizes are 64 bytes and also AVX512 friendly
              </div></li><li><div>
                 first hash is used to locate start of the block (blockBaseOffset)
 subsequent K hashes are used to generate K bits within a block of words
              </div></li><li><div>
                *
     * Combines the two BitArrays using bitwise OR.
     
              </div></li><li><div>
                *
     * Number of bits
     
              </div></li><li><div>
                *
     * Sets the bit at specified index.
     *
     * @param index - position
     
              </div></li><li><div>
                 iterate and update masks array
              </div></li><li><div>
                *
   * Bare metal bit set implementation. For performance reasons, this implementation does not check
   * for index bounds nor expand the bit set size if the specified index is greater than the size.
   
              </div></li><li><div>
                *
   * Deserialize a bloom filter
   * Read a byte stream, which was written by {@linkplain #serialize(OutputStream, BloomKFilter)}
   * into a {@code BloomKFilter}
   *
   * @param in input bytestream
   *
   * @return deserialized BloomKFilter
   
              </div></li><li><div>
                 Given a byte array consisting of a serialized BloomKFilter, gives the offset (from 0)
 for the start of the serialized long values that make up the bitset.
 NumHashFunctions (1 byte) + bitset array length (4 bytes)
              </div></li><li><div>
                *
     * Returns true if the bit is set in the specified index.
     *
     * @param index - position
     *
     * @return - value at the bit position
     
              </div></li><li><div>
                 Just bitwise-OR the bits together - size/# functions should be the same,
 rest of the data is serialized long values for the bitset which are supposed to be bitwise-ORed.
              </div></li><li><div>
                *
   * Merge the specified bloom filter with current bloom filter.
   *
   * @param that - bloom filter to merge
   
              </div></li><li><div>
                *
   * Merges BloomKFilter bf2 into bf1.
   * Assumes 2 BloomKFilters with the same size/hash functions are serialized to byte arrays
   *
   * @param bf1Bytes
   * @param bf1Start
   * @param bf1Length
   * @param bf2Bytes
   * @param bf2Start
   * @param bf2Length
   
              </div></li><li><div>
                 hashcode should be positive, flip all the bits if it's negative
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> fix druid-bloom-filter thread-safety (#6584) (#6619)
                </div><div><b>message:</b> fix druid-bloom-filter thread-safety (#6584) (#6619)

* use BloomFilter instead of BloomKFilter since the latters test method is not threadsafe

* fix formatting

* style and forbidden api

* remove redundant hive notice entry

* add todo with note to delete copied implementation and link to related hive jira

* better fix for masks than ThreadLocal
                </div></div></li></ol></div><div><b>github_issues:</b> <ol><li><div><div><b>title:</b> BloomKFilter used by BloomDimFilter not thread-safe leading to unstable results
                </div><div><b>body:</b> Experienced unstable results from using `BloomDimFilter` - after investigating it would appear that the [`test` method of the `BloomKFilter` is stateful and not thread-safe](https://github.com/apache/hive/blob/master/storage-api/src/java/org/apache/hive/common/util/BloomKFilter.java#L210) leading to understandably very bizarre behavior when querying a large number of segments.

The hive `BloomFilter` implementation does not seem to have that problem with it's `test` methods, which [only read from the `BitSet`](https://github.com/apache/hive/blob/master/storage-api/src/java/org/apache/hive/common/util/BloomFilter.java#L167), and produces stable results in my testing.
                </div></div></li><li><div><div><b>title:</b> BloomKFilter used by BloomDimFilter not thread-safe leading to unstable results
                </div><div><b>body:</b> Experienced unstable results from using `BloomDimFilter` - after investigating it would appear that the [`test` method of the `BloomKFilter` is stateful and not thread-safe](https://github.com/apache/hive/blob/master/storage-api/src/java/org/apache/hive/common/util/BloomKFilter.java#L210) leading to understandably very bizarre behavior when querying a large number of segments.

The hive `BloomFilter` implementation does not seem to have that problem with it's `test` methods, which [only read from the `BitSet`](https://github.com/apache/hive/blob/master/storage-api/src/java/org/apache/hive/common/util/BloomFilter.java#L167), and produces stable results in my testing.
                </div><div><b>label:</b> requirement
                </div></div></li></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div><div><b>label:</b> test
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div></div></li><li><div><div><b>title:</b> fix druid-bloom-filter thread-safety
                </div><div><b>body:</b> Alternate approach to what was taken in #6547, instead embedding the `BloomKFilter` implementation in `druid-bloom-filters` extension, applying a fix from [HIVE-20893](https://issues.apache.org/jira/browse/HIVE-20893) and wrapping `BYTE_ARRAY_4` which is re-used instead of re-allocated per function call, for ints/floats, with `ThreadLocal` to fix the thread safety issues. 

Fixes #6546

The copied `BloomKFilter` is from `hive-storage-api` as of verison 2.7.0 instead of master, since [this commit](https://github.com/apache/hive/commit/87ce36b458350db141c4cb4b6336a9a01796370f#diff-e65fc506757ee058dc951d15a9a526c3L238) seems to have broken backwards compatibility by using 8 bytes instead of 4 to store and test ints/floats. I went with this version specifically to maintain compatibility with the hive version used in the original PR, #6222, despite I think the latest implementation being a bit better since it doesn't use the static variable.

The copied implementation should be removed once the linked hive ticket is resolved and the fix is released so we can update `hive-storage-api`.
                </div><div><b>label:</b> requirement
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                Confirmed working as expected on test cluster
              </div></li><li><div><div><b>body:</b> The original intent of PR #6222 , is to build the BloomK sketch in Hive and handed it over to Druid (via the wire as a filter) to filter down the scan, therefore, for this to work we need to make sure that both Hive and Druid are **using the same algorithm for building sketch and probing it**.
This implies that the best way to fix this is to push the fix to Hive Storage API  and drive a storage API release (FYI storage API release is independent from Hive release life cycle hence goes faster). 
In the meantime to not block 0.13  I think we can go with this option where the code is copied over to Druid it self waiting on the release with the bug fix but for the longer term it is better to have it in one place to avoid issues.
@clintropolis if your goal is to build your own bloom filter sketch from scratch for performance reasons or any other goal, then it is better to introduce a new kind of filter.  The other way to do it is to introduce a version blob within the sketch it self to pick the correct serde/probing implementation but this will need way more work...
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I don't particularly have a goal at this point other than fixing the thread safety issue that is blocking 0.13. FWIW I did add a [handful of tests](https://github.com/apache/incubator-druid/pull/6584/files#diff-f648c52597a4eada30b95b03337cb918R364) to ensure the copied `BloomKFilter` implementation is compatible with the hive implementation.

The thing that makes it ambiguous of what is the best path forward to me is that I'm not certain the thread safety issues faced here necessarily are concerns with how hive is using this stuff (they may be, but I have no idea and don't want to depend on that). In other words, I'm unsure if the thread safety issue is a hive issue or a druid issue (and also I haven't yet even found how to open an issue on hive yet😛)

Also as I mentioned, the other issue is that the latest version of `BloomKFilter` in hive is incompatible with the current version we are using, which my hive compat test on 'floats' caught because I initially copied `BloomKFilter` from master. I don't know if this is intended or not, the jira associated with the change makes no mention of breaking compatibility so maybe it was accidental.

I agree that if for whatever reason I need to break hive compatibility it will be more appropriate to put in another extension, or yeah, rework this one to support multiple implementations.
              </div></li><li><div><div><b>body:</b> @clintropolis: Can you also submit a bug and patch against hive for fixing the same in hive-storage-api. I think its ok to have the code copied over here until these changes are merged on hive side and we get a new release. 

Have looked at the code changes, they seem good, will do some more testing internally and update here.
                </div><div><b>label:</b> test
                </div></div></li><li><div>
                Sure, I should be able to do that. Is this information at https://cwiki.apache.org/confluence/display/Hive/HowToContribute#HowToContribute still accurate? It looks like I send something to the dev mailing list, then jira, then patch? I can bring up the int/float incompatibility I saw between 2.7.0 and latest as well.
              </div></li><li><div>
                @clintropolis there is 2 ways to submit your contribution.
Option 1 open a pull request against https://github.com/apache/hive with `HIVE-20893: Your_PR_Title XXX`.
Option 2 is to submit a diff using https://reviews.apache.org/r/new/ against `hive-git`

              </div></li><li><div>
                Thanks @b-slim I will open a PR on github today :+1:
              </div></li><li><div>
                Updated the PR description to match what was merged
              </div></li><li><div>
                @clintropolis could you do a backport to 0.13.0 for this?
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div><div><b>body:</b> there is already one entry for Hive above, to make this more relevant maybe need to add what is copied and commit or release version.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> Heh, oops I'm dumb and didn't actually read the `NOTICE` file, just knew i should add something since I copied it from elsewhere, will remove this extra :+1:
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Particular reason why Murmur3 is used? xxHash from https://github.com/OpenHFT/Zero-Allocation-Hashing is much faster and allows to hash for example integers directly garbage-free, without resorting to ThreadLocals such as `BYTE_ARRAY_4`
              </div></li><li><div>
                I don't know why specifically this is implemented the way it is here (since this code is copied from hive), but [in the latest version of `BloomKFilter`](https://github.com/apache/hive/blob/master/storage-api/src/java/org/apache/hive/common/util/BloomKFilter.java#L236) `BYTE_ARRAY_4` is no longer used and it uses Murmur3 directly, 

```
public boolean testInt(int val) {
  return testHash(Murmur3.hash64(val));
}
```

However, this seems to be what breaks compatibility with `BloomKFilters` generated with the current version of the hive storage library used by this extension. I suspect this is perhaps an unintended consequence of the modification, as I see [no mention of it in the jira ticket](https://issues.apache.org/jira/browse/HIVE-20101). I haven't looked closely [at the Murmur3 implementation yet](https://github.com/apache/hive/blob/master/storage-api/src/java/org/apache/hive/common/util/Murmur3.java), but it at least looks like it avoids using any patterns like `BYTE_ARRAY_4` in this version of `BloomKFilter`.
              </div></li><li><div>
                And to clarify, my modifications to `BloomKFilter` besides formatting changes to make it adhere to style stuff, is limited to using [`ThreadLocal` for the `masks` and `BYTE_ARRAY_4` variables](https://github.com/apache/incubator-druid/pull/6584/files#diff-a7f65879f15d075395ac94c754e1c60cR62).
              </div></li><li><div><div><b>body:</b> am not aware of 3.2.0 release, therefore maybe it is better to reframe this statement or remove 3.2.0.
FYI The incompatibility you are referring too it is not released yet.
Also i recommend adding a TODO, statement to clarify that this is a temporary solution and to remove this class as soon as[ HIVE-20893 ](https://issues.apache.org/jira/browse/HIVE-20893) is fixed and released.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                @leventov Do you have any Java Benchmarks that compares XXHash to Murmur3 or 2?  

              </div></li><li><div>
                @b-slim https://github.com/OpenHFT/Zero-Allocation-Hashing#performance. xxHash is ~2 times faster on a long run, with ~2 times shorter bootstrap (6 vs 12 ns) too. Please create issues in Druid or Hive for replacing the algo.
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> BloomK Filter probing method is not thread safe
                </div><div><b>description:</b> As far i can tell this is not an issue for Hive yet (most of the usage of probing seems to be done by one thread at a time) but it is an issue of other users like Druid as per the following issue.[https://github.com/apache/incubator-druid/issues/6546]

The fix is proposed by the author of [https://github.com/apache/incubator-druid/pull/6584]&nbsp;is to make couple of local fields as ThreadLocals.

Idea looks good to me and doesn't have any perf drawbacks.

&nbsp;
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div><div><b>body:</b> [~bslim]: The masks array loop can be unrolled to remove the array variable entirely - the array variable made more sense when the cache width was not hard-coded as 8. 

You might get the performance back, without invoking a synchronized instruction there (the thread local .get).
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                [~gopalv]: I'm throwing together a PR for this, but it's non obvious to me how to properly unroll the masks loop, what did you have in mind for the refactor?&nbsp;
              </div></li><li><div>
                The masks object was rough place-holder for an eventual Long8 type to be allocated locally (the jdk value types), to stand in for the __m512i variables

Talked to [~bslim] about this and I'm thinking an even simpler solution than unrolling might work out just fine.

{code}
-      masks[wordOffset] |= (1L &lt;&lt; bitPos);
+     final long bloomWord = bitSet.data[wordOffset + i];
+     if (0 == (bloomWord &amp; (1L &lt;&lt; bitPos))) return false;
+   }
+   return true;
{code}

And re-run your benchmark?

That makes it similar to the original bloom implementation and better than the ThreadLocal at rejecting rows.

If you do have a linux box with libhsdis, then the output of JMH -prof perfasm would be super useful to look into.
              </div></li><li><div>
                Thanks for the explanation! I'll see what I can do about getting perfasm output.
              </div></li><li><div>
                Unfortunately the suggested fix is failing most tests when I run them locally.
              </div></li><li><div>
                [~cwylie]: I think I munged up that change - attached a proper patch, instead of a comment
              </div></li><li><div>
                Ah, this one works, thanks! I'll apply these changes to the version I've copied into Druid until&nbsp;this is properly released.
              </div></li><li><div><div><b>body:</b> I did test this locally and added some tests for float case.&nbsp;[^HIVE-20893.patch]

Will run some Benchmark soon on our internal Cluster while tests will run on the patch.
                </div><div><b>label:</b> test
                </div></div></li><li><div>
                | (x) *{color:red}-1 overall{color}* |
\\
\\
|| Vote || Subsystem || Runtime || Comment ||
|| || || || {color:brown} Prechecks {color} ||
| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |
|| || || || {color:brown} master Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  7m 40s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 10s{color} | {color:green} master passed {color} |
| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 10s{color} | {color:green} master passed {color} |
| {color:blue}0{color} | {color:blue} findbugs {color} | {color:blue}  0m 24s{color} | {color:blue} storage-api in master has 48 extant Findbugs warnings. {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 10s{color} | {color:green} master passed {color} |
|| || || || {color:brown} Patch Compile Tests {color} ||
| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 10s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m  9s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m  9s{color} | {color:green} the patch passed {color} |
| {color:red}-1{color} | {color:red} checkstyle {color} | {color:red}  0m 12s{color} | {color:red} storage-api: The patch generated 299 new + 31 unchanged - 3 fixed = 330 total (was 34) {color} |
| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |
| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  0m 27s{color} | {color:green} the patch passed {color} |
| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m  9s{color} | {color:green} the patch passed {color} |
|| || || || {color:brown} Other Tests {color} ||
| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 12s{color} | {color:green} The patch does not generate ASF License warnings. {color} |
| {color:black}{color} | {color:black} {color} | {color:black} 10m 17s{color} | {color:black} {color} |
\\
\\
|| Subsystem || Report/Notes ||
| Optional Tests |  asflicense  javac  javadoc  findbugs  checkstyle  compile  |
| uname | Linux hiveptest-server-upstream 3.16.0-4-amd64 #1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03) x86_64 GNU/Linux |
| Build tool | maven |
| Personality | /data/hiveptest/working/yetus_PreCommit-HIVE-Build-14863/dev-support/hive-personality.sh |
| git revision | master / 7ae4a2c |
| Default Java | 1.8.0_111 |
| findbugs | v3.0.1 |
| checkstyle | http://104.198.109.242/logs//PreCommit-HIVE-Build-14863/yetus/diff-checkstyle-storage-api.txt |
| modules | C: storage-api U: storage-api |
| Console output | http://104.198.109.242/logs//PreCommit-HIVE-Build-14863/yetus.txt |
| Powered by | Apache Yetus    http://yetus.apache.org |


This message was automatically generated.


              </div></li><li><div>
                

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12947658/HIVE-20893.patch

{color:green}SUCCESS:{color} +1 due to 2 test(s) being added or modified.

{color:green}SUCCESS:{color} +1 due to 15538 tests passed

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/14863/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/14863/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-14863/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.YetusPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12947658 - PreCommit-HIVE-Build
              </div></li><li><div>
                Thanks [~gopalv] pushed this to master, will follow up with some Cluster based benchmark.
              </div></li></ol></div></div></html>