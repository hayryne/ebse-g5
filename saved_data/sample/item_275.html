<!DOCTYPE html><html><div class="item-title">
        Item 275
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application (fixed check null, trace table name, webapp path, column names) and traceserver.py
                </div><div><b>message:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application (fixed check null, trace table name, webapp path, column names) and traceserver.py

Closes #311

Signed-off-by: Josh Elser &lt;elserj@apache.org&gt;

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li><li><div><div><b>title:</b> PHOENIX-4817 Fixed Phoenix Tracing Web Application
                </div><div><b>body:</b> Fixed check null, trace table name, webapp path, column names. Fixed traceserver.py
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                Fixed Phoenix Tracing Web Application, fixed traceserver.py
              </div></li><li><div>
                traceserver.py start        NO JSP Support for /, did not find org.apache.jasper.servlet.JspServlet
 
![2018-07-20 18-33-36](https://user-images.githubusercontent.com/8455464/42998108-a008041e-8c4b-11e8-8015-88bf9bee58c2.png)
@MrSandmanRUS 
              </div></li><li><div>
                It's ok, just info message, try to open localhost:8864
@mygood 
              </div></li><li><div>
                Tracing List is ok  but  Trace Count Chart Graph 
Request URL: http://192.168.178.31:8864/trace/?action=getCount
Request Method: GET
Status Code: 500 Unknown tracename: description
![image](https://user-images.githubusercontent.com/8455464/42999258-a07728ea-8c4f-11e8-8110-75d6f5e95eae.png)
see trace log 
![image](https://user-images.githubusercontent.com/8455464/42999272-b426b518-8c4f-11e8-9491-f6df5af9f489.png)
@MrSandmanRUS 
              </div></li><li><div>
                Can you show me your trace table? Column “description” is standard column of this table, if you start tracing via hbase-site.xml
@mygood
              </div></li><li><div>
                hbase-site.xml  default SYSTEM.TRACING_STATS
 CREATE TABLE SYSTEM.TRACING_STATS (
      trace_id BIGINT NOT NULL,
      parent_id BIGINT NOT NULL,
      span_id BIGINT NOT NULL,
      description VARCHAR,
      start_time BIGINT,
      end_time BIGINT,
      hostname VARCHAR,
      tags.count SMALLINT,
      annotations.count SMALLINT,
      CONSTRAINT pk PRIMARY KEY (trace_id, parent_id, span_id)
      )
Phoenix Tracing List
![image](https://user-images.githubusercontent.com/8455464/42999737-8c7c6cae-8c51-11e8-842d-334ffcf3b69e.png)
Is it caused by this problem? NO JSP Support for /, did not find org.apache.jasper.servlet.JspServlet 

@MrSandmanRUS 
              </div></li><li><div>
                You use version from apache phoenix, I fixed this bug and some others, just compile my sources
@mygood 
              </div></li><li><div>
                apache-phoenix-4.11.0-HBase-1.1-bin 、hadoop-2.7.1
@MrSandmanRUS 
              </div></li><li><div>
                It's ok, clone my branch and compile only web application, then rename jars for your version, then replace it with web application phoenix jars
@mygood 
              </div></li><li><div>
                
Thank you very much for the problem.

@MrSandmanRUS 
              </div></li><li><div>
                You use version from apache phoenix 、hbase 、hadoop
@MrSandmanRUS 

              </div></li><li><div>
                Yes
@mygood
              </div></li><li><div>
                I have a problem that the data does not into SYSTEM.TRACING_STATS
0: jdbc:phoenix:localhost:2181:/hbase&gt; trace on;
+----------------------+
|       trace_id       |
+----------------------+
| 2701156331755118993  |
+----------------------+
1 row selected (0.001 seconds)
0: jdbc:phoenix:localhost:2181:/hbase&gt; upsert into T(a,b) values(2,2);
1 row affected (0.015 seconds)
0: jdbc:phoenix:localhost:2181:/hbase&gt; trace off;
+----------------------+
|       trace_id       |
+----------------------+
| 2701156331755118993  |
+----------------------+
1 row selected (0.001 seconds)
0: jdbc:phoenix:localhost:2181:/hbase&gt; trace off;
+-----------+
| trace_id  |
+-----------+
+-----------+
No rows selected (0 seconds)
0: jdbc:phoenix:localhost:2181:/hbase&gt; select * from SYSTEM.TRACING_STATS where trace_id=2701156331755118993;
+-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
| TRACE_ID  | PARENT_ID  | SPAN_ID  | DESCRIPTION  | START_TIME  | END_TIME  | HOSTNAME  | COUNT  | COUNT  |
+-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
+-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
No rows selected (0.109 seconds)
0: jdbc:phoenix:localhost:2181:/hbase&gt; select * from SYSTEM.TRACING_STATS;
+-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
| TRACE_ID  | PARENT_ID  | SPAN_ID  | DESCRIPTION  | START_TIME  | END_TIME  | HOSTNAME  | COUNT  | COUNT  |
+-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
| 2         | 2          | 2        | upsert       | 20180720    | 20180721  | host1     | 20     | 30     |
| 3         | 3          | 3        | upsert       | 20180720    | 20180721  | host1     | 10     | 30     |
+-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
2 rows selected (0.098 seconds)
@MrSandmanRUS 
              </div></li><li><div>
                Add to hbase-site.xml:
	  &lt;property&gt;
	    &lt;name&gt;phoenix.trace.enabled&lt;/name&gt;
	    &lt;value&gt;true&lt;/value&gt;
	  &lt;/property&gt;
@mygood 
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Seems like `$PHOENIX_OPTS` was dropped. Was this not being interpolated correctly? Is this environment variable propagated into the traceserver java process?
              </div></li><li><div>
                Suggest dropping `webappDirLocation` and just using `DEFAULT_WEBAPP_DIR_LOCATION` since this is not configurable anyways.
              </div></li><li><div>
                Import `org.apache.hadoop.conf.Configuration` please.
              </div></li><li><div><div><b>body:</b> Parenthesis around `(!logic.equals(LOGIC_AND) &amp;&amp; !logic.equals(LOGIC_OR))` are unnecessary, please drop them.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Fixed
              </div></li><li><div>
                Fixed
              </div></li><li><div>
                Fixed
              </div></li><li><div>
                https://issues.apache.org/jira/browse/PHOENIX-2659
 I think it's your comment:
"Josh Elser added a comment - 12/Feb/16 03:23
ok, PHOENIX_OPTS isn't working because subprocess isn't popping a shell like sqlline does. It will automatically get added to PQS's environment already. We can just remove that.
Steve is spot-on for the argument parsing. It's just busted."
So, I just remove it.
              </div></li><li><div>
                All in all, when I remove it, the server successfully starts and works correctly.
              </div></li><li><div><div><b>body:</b> The issue is that subprocess doesn't handle shell variable expansion "in the command". Subprocess has API to provide an environment to the process being run.

`$PHOENIX_OPTS` and `$PHOENIX_TRACESERVER_OPTS` should be placed into the subprocess's environment, not just dropped.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Do I need to add something like this?

phoenix_opts= os.getenv('PHOENIX_OPTS', '')
......
if hbase_env.has_key('PHOENIX_OPTS'):
    phoenix_opts= hbase_env['PHOENIX_OPTS']
.....
java_cmd = '%(java)s  ' + phoenix_opts + \
....
              </div></li><li><div>
                Actually, looks like queryserver.py doesn't include `$PHOENIX_OPTS` so let's just leave that to clients. `$PHOENIX_TRACESERVER_OPTS` is inlined, so you're good. Sorry for the confusion.
              </div></li><li><div>
                Ok, thank you
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Phoenix Tracing Web Application
                </div><div><b>description:</b> # Phoenix Tracing Web Application can not be started, because traceserver.py&nbsp;does not contain required dependencies.
 # The path to the folder webapp is incorrectly specified, so&nbsp;Phoenix Tracing Web Application can not find this folder.
 # Phoenix Tracing Web Application does not check null value&nbsp;where it is needed, so&nbsp;the application can not load List, Dependency Tree and Features.
 # Phoenix Tracing Web Application&nbsp;creates a query with the wrong table column names.
 # Phoenix Tracing Web Application has only the default tracing-table name (SYSTEM.TRACING_STATS) and&nbsp;does not get&nbsp;tracing-table name via hbase-site.xml.
                </div></div></li><li><div><div><b>summary:</b> Phoenix Tracing Web Application
                </div><div><b>description:</b> # Phoenix Tracing Web Application can not be started, because traceserver.py&nbsp;does not contain required dependencies.
 # The path to the folder webapp is incorrectly specified, so&nbsp;Phoenix Tracing Web Application can not find this folder.
 # Phoenix Tracing Web Application does not check null value&nbsp;where it is needed, so&nbsp;the application can not load List, Dependency Tree and Features.
 # Phoenix Tracing Web Application&nbsp;creates a query with the wrong table column names.
 # Phoenix Tracing Web Application has only the default tracing-table name (SYSTEM.TRACING_STATS) and&nbsp;does not get&nbsp;tracing-table name via hbase-site.xml.
                </div></div></li><li><div><div><b>summary:</b> Phoenix Tracing Web Application
                </div><div><b>description:</b> # Phoenix Tracing Web Application can not be started, because traceserver.py&nbsp;does not contain required dependencies.
 # The path to the folder webapp is incorrectly specified, so&nbsp;Phoenix Tracing Web Application can not find this folder.
 # Phoenix Tracing Web Application does not check null value&nbsp;where it is needed, so&nbsp;the application can not load List, Dependency Tree and Features.
 # Phoenix Tracing Web Application&nbsp;creates a query with the wrong table column names.
 # Phoenix Tracing Web Application has only the default tracing-table name (SYSTEM.TRACING_STATS) and&nbsp;does not get&nbsp;tracing-table name via hbase-site.xml.
                </div></div></li><li><div><div><b>summary:</b> Phoenix Tracing Web Application
                </div><div><b>description:</b> # Phoenix Tracing Web Application can not be started, because traceserver.py&nbsp;does not contain required dependencies.
 # The path to the folder webapp is incorrectly specified, so&nbsp;Phoenix Tracing Web Application can not find this folder.
 # Phoenix Tracing Web Application does not check null value&nbsp;where it is needed, so&nbsp;the application can not load List, Dependency Tree and Features.
 # Phoenix Tracing Web Application&nbsp;creates a query with the wrong table column names.
 # Phoenix Tracing Web Application has only the default tracing-table name (SYSTEM.TRACING_STATS) and&nbsp;does not get&nbsp;tracing-table name via hbase-site.xml.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Pull request:&nbsp;https://github.com/apache/phoenix/pull/311
              </div></li><li><div>
                Github user joshelser commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r203446437
  
    --- Diff: phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/Main.java ---
    @@ -62,15 +63,18 @@ public int run(String[] arg0) throws Exception {
             final String home = getConf().get(TRACE_SERVER_HTTP_JETTY_HOME_KEY,
                     DEFAULT_HTTP_HOME);
             //setting up the embedded server
    -        ProtectionDomain domain = Main.class.getProtectionDomain();
    -        URL location = domain.getCodeSource().getLocation();
    -        String webappDirLocation = location.toString().split("target")[0] +"src/main/webapp";
    +        String webappDirLocation = DEFAULT_WEBAPP_DIR_LOCATION;
    --- End diff --
    
    Suggest dropping `webappDirLocation` and just using `DEFAULT_WEBAPP_DIR_LOCATION` since this is not configurable anyways.

              </div></li><li><div>
                Github user joshelser commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r203446592
  
    --- Diff: phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/TraceServlet.java ---
    @@ -42,14 +45,21 @@
       private static Connection con;
       protected String DEFAULT_LIMIT = "25";
       protected String DEFAULT_COUNTBY = "hostname";
    +  protected String DEFAULT_DESCRIPTION = "description";
       protected String LOGIC_AND = "AND";
       protected String LOGIC_OR = "OR";
       protected String TRACING_TABLE = "SYSTEM.TRACING_STATS";
     
    -
    +  @Override
    +  public void init() {
    +    org.apache.hadoop.conf.Configuration conf = HBaseConfiguration.create();
    --- End diff --
    
    Import `org.apache.hadoop.conf.Configuration` please.

              </div></li><li><div>
                Github user joshelser commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r203445596
  
    --- Diff: bin/traceserver.py ---
    @@ -116,8 +116,10 @@
     
     #    " -Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=n " + \
     #    " -XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:FlightRecorderOptions=defaultrecording=true,dumponexit=true" + \
    -java_cmd = '%(java)s $PHOENIX_OPTS ' + \
    -    '-cp ' + hbase_config_path + os.pathsep + phoenix_utils.phoenix_traceserver_jar + os.pathsep + phoenix_utils.phoenix_client_jar + \
    +java_cmd = '%(java)s  ' + \
    --- End diff --
    
    Seems like `$PHOENIX_OPTS` was dropped. Was this not being interpolated correctly? Is this environment variable propagated into the traceserver java process?

              </div></li><li><div>
                Github user joshelser commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r203447995
  
    --- Diff: phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/TraceServlet.java ---
    @@ -98,33 +108,36 @@ protected String getCount(String countby) {
         if(countby == null) {
           countby = DEFAULT_COUNTBY;
         }
    -    // Throws exception if the column not present in the trace table.
    -    MetricInfo.getColumnName(countby.toLowerCase());
         String sqlQuery = "SELECT "+countby+", COUNT(*) AS count FROM " + TRACING_TABLE + " GROUP BY "+countby+" HAVING COUNT(*) &gt; 1 ";
         json = getResults(sqlQuery);
         return json;
       }
     
       //search the trace over parent id or trace id
    -  protected String searchTrace(String parentId, String traceId,String logic) {
    +  protected String searchTrace(String parentId, String traceId, String logic) {
    +
         String json = null;
         String query = null;
         // Check the parent Id, trace id type or long or not.
         try {
    +      if (parentId != null) {
             Long.parseLong(parentId);
    +      }
    +      if (traceId != null) {
             Long.parseLong(traceId);
    +      }
         } catch (NumberFormatException e) {
    -    	throw new RuntimeException("The passed parentId/traceId is not a number.", e);
    +      throw new RuntimeException("The passed parentId/traceId is not a number.", e);
         }
    -    if(!logic.equals(LOGIC_AND) || !logic.equals(LOGIC_OR)) {
    -    	throw new RuntimeException("Wrong logical operator passed to the query. Only "+ LOGIC_AND+","+LOGIC_OR+" are allowed.") ;
    +    if (logic != null &amp;&amp; (!logic.equals(LOGIC_AND) &amp;&amp; !logic.equals(LOGIC_OR))) {
    --- End diff --
    
    Parenthesis around `(!logic.equals(LOGIC_AND) &amp;&amp; !logic.equals(LOGIC_OR))` are unnecessary, please drop them.

              </div></li><li><div>
                Github user MrSandmanRUS commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r203550218
  
    --- Diff: phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/Main.java ---
    @@ -62,15 +63,18 @@ public int run(String[] arg0) throws Exception {
             final String home = getConf().get(TRACE_SERVER_HTTP_JETTY_HOME_KEY,
                     DEFAULT_HTTP_HOME);
             //setting up the embedded server
    -        ProtectionDomain domain = Main.class.getProtectionDomain();
    -        URL location = domain.getCodeSource().getLocation();
    -        String webappDirLocation = location.toString().split("target")[0] +"src/main/webapp";
    +        String webappDirLocation = DEFAULT_WEBAPP_DIR_LOCATION;
    --- End diff --
    
    Fixed

              </div></li><li><div>
                Github user MrSandmanRUS commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r203550254
  
    --- Diff: phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/TraceServlet.java ---
    @@ -42,14 +45,21 @@
       private static Connection con;
       protected String DEFAULT_LIMIT = "25";
       protected String DEFAULT_COUNTBY = "hostname";
    +  protected String DEFAULT_DESCRIPTION = "description";
       protected String LOGIC_AND = "AND";
       protected String LOGIC_OR = "OR";
       protected String TRACING_TABLE = "SYSTEM.TRACING_STATS";
     
    -
    +  @Override
    +  public void init() {
    +    org.apache.hadoop.conf.Configuration conf = HBaseConfiguration.create();
    --- End diff --
    
    Fixed

              </div></li><li><div>
                Github user MrSandmanRUS commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r203550322
  
    --- Diff: phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/TraceServlet.java ---
    @@ -98,33 +108,36 @@ protected String getCount(String countby) {
         if(countby == null) {
           countby = DEFAULT_COUNTBY;
         }
    -    // Throws exception if the column not present in the trace table.
    -    MetricInfo.getColumnName(countby.toLowerCase());
         String sqlQuery = "SELECT "+countby+", COUNT(*) AS count FROM " + TRACING_TABLE + " GROUP BY "+countby+" HAVING COUNT(*) &gt; 1 ";
         json = getResults(sqlQuery);
         return json;
       }
     
       //search the trace over parent id or trace id
    -  protected String searchTrace(String parentId, String traceId,String logic) {
    +  protected String searchTrace(String parentId, String traceId, String logic) {
    +
         String json = null;
         String query = null;
         // Check the parent Id, trace id type or long or not.
         try {
    +      if (parentId != null) {
             Long.parseLong(parentId);
    +      }
    +      if (traceId != null) {
             Long.parseLong(traceId);
    +      }
         } catch (NumberFormatException e) {
    -    	throw new RuntimeException("The passed parentId/traceId is not a number.", e);
    +      throw new RuntimeException("The passed parentId/traceId is not a number.", e);
         }
    -    if(!logic.equals(LOGIC_AND) || !logic.equals(LOGIC_OR)) {
    -    	throw new RuntimeException("Wrong logical operator passed to the query. Only "+ LOGIC_AND+","+LOGIC_OR+" are allowed.") ;
    +    if (logic != null &amp;&amp; (!logic.equals(LOGIC_AND) &amp;&amp; !logic.equals(LOGIC_OR))) {
    --- End diff --
    
    Fixed

              </div></li><li><div>
                Github user MrSandmanRUS commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r203552153
  
    --- Diff: bin/traceserver.py ---
    @@ -116,8 +116,10 @@
     
     #    " -Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=n " + \
     #    " -XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:FlightRecorderOptions=defaultrecording=true,dumponexit=true" + \
    -java_cmd = '%(java)s $PHOENIX_OPTS ' + \
    -    '-cp ' + hbase_config_path + os.pathsep + phoenix_utils.phoenix_traceserver_jar + os.pathsep + phoenix_utils.phoenix_client_jar + \
    +java_cmd = '%(java)s  ' + \
    --- End diff --
    
    https://issues.apache.org/jira/browse/PHOENIX-2659
     I think it's your comment:
    "Josh Elser added a comment - 12/Feb/16 03:23
    ok, PHOENIX_OPTS isn't working because subprocess isn't popping a shell like sqlline does. It will automatically get added to PQS's environment already. We can just remove that.
    Steve is spot-on for the argument parsing. It's just busted."
    So, I just delete it.

              </div></li><li><div>
                Github user MrSandmanRUS commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r203552899
  
    --- Diff: bin/traceserver.py ---
    @@ -116,8 +116,10 @@
     
     #    " -Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=n " + \
     #    " -XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:FlightRecorderOptions=defaultrecording=true,dumponexit=true" + \
    -java_cmd = '%(java)s $PHOENIX_OPTS ' + \
    -    '-cp ' + hbase_config_path + os.pathsep + phoenix_utils.phoenix_traceserver_jar + os.pathsep + phoenix_utils.phoenix_client_jar + \
    +java_cmd = '%(java)s  ' + \
    --- End diff --
    
    All in all, the server successfully starts and works correctly.

              </div></li><li><div>
                Github user mygood commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    traceserver.py start        NO JSP Support for /, did not find org.apache.jasper.servlet.JspServlet
     
    ![2018-07-20 18-33-36](https://user-images.githubusercontent.com/8455464/42998108-a008041e-8c4b-11e8-8015-88bf9bee58c2.png)


              </div></li><li><div>
                Github user MrSandmanRUS commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    mygood, add libs jackson-mapper-asl-{someVersion}.jar, jackson-core-asl-{someVersion}.jar, jackson-jaxrs-{someVersion}.jar, jackson-xc-{someVersion}.jar to your hadoop_classpath

              </div></li><li><div>
                Github user MrSandmanRUS commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    It's ok, just info message, try to open localhost:8864
    @mygood 

              </div></li><li><div>
                Github user mygood commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    Tracing List is ok  but  Trace Count Chart Graph 
    Request URL: http://192.168.178.31:8864/trace/?action=getCount
    Request Method: GET
    Status Code: 500 Unknown tracename: description
    ![image](https://user-images.githubusercontent.com/8455464/42999258-a07728ea-8c4f-11e8-8110-75d6f5e95eae.png)
    see trace log 
    ![image](https://user-images.githubusercontent.com/8455464/42999272-b426b518-8c4f-11e8-9491-f6df5af9f489.png)


              </div></li><li><div>
                Github user MrSandmanRUS commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    Can you show me your trace table? Column “description” is standard column of this table, if you start tracing via base-site.xml

              </div></li><li><div>
                Github user mygood commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
     CREATE TABLE SYSTEM.TRACING_STATS (
          trace_id BIGINT NOT NULL,
          parent_id BIGINT NOT NULL,
          span_id BIGINT NOT NULL,
          description VARCHAR,
          start_time BIGINT,
          end_time BIGINT,
          hostname VARCHAR,
          tags.count SMALLINT,
          annotations.count SMALLINT,
          CONSTRAINT pk PRIMARY KEY (trace_id, parent_id, span_id)
          )
    Phoenix Tracing List
    ![image](https://user-images.githubusercontent.com/8455464/42999737-8c7c6cae-8c51-11e8-842d-334ffcf3b69e.png)
    Is it caused by this problem? NO JSP Support for /, did not find org.apache.jasper.servlet.JspServlet 
    


              </div></li><li><div>
                Github user MrSandmanRUS commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    You use version from apache phoenix, I fixed it back, just compile my sources
    @mygood 

              </div></li><li><div>
                Github user mygood commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    apache-phoenix-4.11.0-HBase-1.1-bin 、hadoop-2.7.1
    @MrSandmanRUS 

              </div></li><li><div>
                Github user MrSandmanRUS commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    It's ok, clone my branch and compile only web application, then rename jar for your version

              </div></li><li><div>
                Github user mygood commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    
    Thank you very much for the problem.
    
    @MrSandmanRUS 

              </div></li><li><div>
                Github user mygood commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    Hi @MrSandmanRUS  
    I have a problem apache-phoenix-4.11.0-HBase-1.1-bin, hadoop-2.7.1
    1.hbase-site.xml modification
    &lt;property&gt;
    &lt;name&gt;phoenix.trace.frequency&lt;/name&gt;
        &lt;value&gt;always&lt;/value&gt;
    &lt;/property&gt;
    2. Copy $PHOENIX_HOME/bin/hadoop-metrics2-hbase.properties to $HBASE_HOME/conf
    
    3. The client writes data but SYSTEM.TRACING_STATS has no data to write.

              </div></li><li><div>
                Github user joshelser commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r204795871
  
    --- Diff: bin/traceserver.py ---
    @@ -116,8 +116,10 @@
     
     #    " -Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=n " + \
     #    " -XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:FlightRecorderOptions=defaultrecording=true,dumponexit=true" + \
    -java_cmd = '%(java)s $PHOENIX_OPTS ' + \
    -    '-cp ' + hbase_config_path + os.pathsep + phoenix_utils.phoenix_traceserver_jar + os.pathsep + phoenix_utils.phoenix_client_jar + \
    +java_cmd = '%(java)s  ' + \
    --- End diff --
    
    The issue is that subprocess doesn't handle shell variable expansion "in the command". Subprocess has API to provide an environment to the process being run.
    
    `$PHOENIX_OPTS` and `$PHOENIX_TRACESERVER_OPTS` should be placed into the subprocess's environment, not just dropped.

              </div></li><li><div>
                Github user MrSandmanRUS commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r204807188
  
    --- Diff: bin/traceserver.py ---
    @@ -116,8 +116,10 @@
     
     #    " -Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=n " + \
     #    " -XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:FlightRecorderOptions=defaultrecording=true,dumponexit=true" + \
    -java_cmd = '%(java)s $PHOENIX_OPTS ' + \
    -    '-cp ' + hbase_config_path + os.pathsep + phoenix_utils.phoenix_traceserver_jar + os.pathsep + phoenix_utils.phoenix_client_jar + \
    +java_cmd = '%(java)s  ' + \
    --- End diff --
    
    Do I need to add something like this?
    
    phoenix_opts= os.getenv('PHOENIX_OPTS', '')
    ......
    if hbase_env.has_key('PHOENIX_OPTS'):
        opts = hbase_env['PHOENIX_OPTS']
    .....
    java_cmd = '%(java)s  ' + phoenix_opts + \
    ....

              </div></li><li><div>
                Github user joshelser commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r204818876
  
    --- Diff: bin/traceserver.py ---
    @@ -116,8 +116,10 @@
     
     #    " -Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=n " + \
     #    " -XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:FlightRecorderOptions=defaultrecording=true,dumponexit=true" + \
    -java_cmd = '%(java)s $PHOENIX_OPTS ' + \
    -    '-cp ' + hbase_config_path + os.pathsep + phoenix_utils.phoenix_traceserver_jar + os.pathsep + phoenix_utils.phoenix_client_jar + \
    +java_cmd = '%(java)s  ' + \
    --- End diff --
    
    Actually, looks like queryserver.py doesn't include `$PHOENIX_OPTS` so let's just leave that to clients. `$PHOENIX_TRACESERVER_OPTS` is inlined, so you're good. Sorry for the confusion.

              </div></li><li><div>
                Github user MrSandmanRUS commented on a diff in the pull request:

    https://github.com/apache/phoenix/pull/311#discussion_r204819321
  
    --- Diff: bin/traceserver.py ---
    @@ -116,8 +116,10 @@
     
     #    " -Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=n " + \
     #    " -XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:FlightRecorderOptions=defaultrecording=true,dumponexit=true" + \
    -java_cmd = '%(java)s $PHOENIX_OPTS ' + \
    -    '-cp ' + hbase_config_path + os.pathsep + phoenix_utils.phoenix_traceserver_jar + os.pathsep + phoenix_utils.phoenix_client_jar + \
    +java_cmd = '%(java)s  ' + \
    --- End diff --
    
    Ok, thank you

              </div></li><li><div>
                Github user mygood commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    You use version from apache phoenix 、hbase 、hadoop
    @MrSandmanRUS 


              </div></li><li><div>
                Github user MrSandmanRUS commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    Yes
    @mygood

              </div></li><li><div>
                Github user mygood commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    I have a problem that the data does not into SYSTEM.TRACING_STATS
    0: jdbc:phoenix:localhost:2181:/hbase&gt; trace on;
    +----------------------+
    |       trace_id       |
    +----------------------+
    | 2701156331755118993  |
    +----------------------+
    1 row selected (0.001 seconds)
    0: jdbc:phoenix:localhost:2181:/hbase&gt; upsert into T(a,b) values(2,2);
    1 row affected (0.015 seconds)
    0: jdbc:phoenix:localhost:2181:/hbase&gt; trace off;
    +----------------------+
    |       trace_id       |
    +----------------------+
    | 2701156331755118993  |
    +----------------------+
    1 row selected (0.001 seconds)
    0: jdbc:phoenix:localhost:2181:/hbase&gt; trace off;
    +-----------+
    | trace_id  |
    +-----------+
    +-----------+
    No rows selected (0 seconds)
    0: jdbc:phoenix:localhost:2181:/hbase&gt; select * from SYSTEM.TRACING_STATS where trace_id=2701156331755118993;
    +-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
    | TRACE_ID  | PARENT_ID  | SPAN_ID  | DESCRIPTION  | START_TIME  | END_TIME  | HOSTNAME  | COUNT  | COUNT  |
    +-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
    +-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
    No rows selected (0.109 seconds)
    0: jdbc:phoenix:localhost:2181:/hbase&gt; select * from SYSTEM.TRACING_STATS;
    +-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
    | TRACE_ID  | PARENT_ID  | SPAN_ID  | DESCRIPTION  | START_TIME  | END_TIME  | HOSTNAME  | COUNT  | COUNT  |
    +-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
    | 2         | 2          | 2        | upsert       | 20180720    | 20180721  | host1     | 20     | 30     |
    | 3         | 3          | 3        | upsert       | 20180720    | 20180721  | host1     | 10     | 30     |
    +-----------+------------+----------+--------------+-------------+-----------+-----------+--------+--------+
    2 rows selected (0.098 seconds)
    @MrSandmanRUS 

              </div></li><li><div>
                Github user MrSandmanRUS commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    Add to hbase-site.xml:
    	  &lt;property&gt;
    	    &lt;name&gt;phoenix.trace.enabled&lt;/name&gt;
    	    &lt;value&gt;true&lt;/value&gt;
    	  &lt;/property&gt;

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/phoenix/pull/311

              </div></li><li><div>
                I've gone ahead and merged your PR. Thanks for the contribution, Vitaly!
              </div></li><li><div>
                SUCCESS: Integrated in Jenkins build Phoenix-4.x-HBase-1.3 #171 (See [https://builds.apache.org/job/Phoenix-4.x-HBase-1.3/171/])
PHOENIX-4817 Fixed Phoenix Tracing Web Application (fixed check null, (elserj: rev 1f7e3206bc0b1039b4b8a5fa9a2c8d06eb64e9d3)
* (edit) bin/traceserver.py
* (edit) phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/TraceServlet.java
* (edit) phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/Main.java

              </div></li><li><div>
                ABORTED: Integrated in Jenkins build PreCommit-PHOENIX-Build #1929 (See [https://builds.apache.org/job/PreCommit-PHOENIX-Build/1929/])
PHOENIX-4817 Fixed Phoenix Tracing Web Application (fixed check null, (elserj: rev 6b363b3a25b024539052b12169402eff78e34719)
* (edit) phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/TraceServlet.java
* (edit) phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/Main.java
* (edit) bin/traceserver.py

              </div></li><li><div>
                FAILURE: Integrated in Jenkins build PreCommit-PHOENIX-Build #1930 (See [https://builds.apache.org/job/PreCommit-PHOENIX-Build/1930/])
PHOENIX-4817 Fixed Phoenix Tracing Web Application (fixed check null, (elserj: rev 8a874cc95c3365a566453fb9ebbe8e31b6d51b38)
* (edit) phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/TraceServlet.java
* (edit) bin/traceserver.py
* (edit) phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/Main.java

              </div></li><li><div>
                Github user mygood commented on the issue:

    https://github.com/apache/phoenix/pull/311
  
    trace on not data into trace table
    I use apache-phoenix-4.13.1-HBase-1.1-bin and hbase-1.1.6 and hadoop-2.7.1
    cp $PHOENIX_HOME/phoenix-4.13.1-HBase-1.1-server.jar $HBASE_HOME/lib
    cp $PHOENIX_HOME/bin/hadoop-metrics2-hbase.properties $HBASE_HOME/conf
    cp $PHOENIX_HOME/bin/hadoop-metrics2-phoenix.properties $HBASE_HOME/conf
    
    add hbase-sit.xml
    &lt;property&gt;
    &lt;name&gt;phoenix.trace.frequency&lt;/name&gt;
    &lt;value&gt;always&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
    &lt;name&gt;phoenix.trace.statsTableName&lt;/name&gt;
    &lt;value&gt;SYSTEM.TRACING_STATS&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt; 
    &lt;name&gt;phoenix.trace.frequency&lt;/name&gt;
    &lt;value&gt;true&lt;/value&gt;
    &lt;/property&gt;
    run sqlline.py
    create SYSTEM.TRACING_STATS
    CREATE TABLE SYSTEM.TRACING_STATS (
    trace_id BIGINT NOT NULL,
    parent_id BIGINT NOT NULL,
    span_id BIGINT NOT NULL,
    description VARCHAR,
    start_time BIGINT,
    end_time BIGINT,
    hostname VARCHAR,
    tags.count SMALLINT,
    annotations.count SMALLINT,
    CONSTRAINT pk PRIMARY KEY (trace_id, parent_id, span_id)
    )
    0: jdbc:phoenix:localhost:2181:/hbase&gt; trace on;
    -----------------------
    
    trace_id
    -----------------------
    
    -7450651397611882467
    -----------------------
    1 row selected (0.001 seconds)
    0: jdbc:phoenix:localhost:2181:/hbase&gt; create table t(a bigint not null PRIMARY key,b bigint);
    No rows affected (2.523 seconds)
    0: jdbc:phoenix:localhost:2181:/hbase&gt; !ta
    ------------------------------------------------------------------------------------------------------------+
    
    TABLE_CAT   TABLE_SCHEM TABLE_NAME  TABLE_TYPE  REMARKS     TYPE_NAME   SELF_REFERENCING_COL_NAME     REF_GENERATIO
    ------------------------------------------------------------------------------------------------------------+
    
          SYSTEM      CATALOG     SYSTEM TABLE                         
          SYSTEM      FUNCTION    SYSTEM TABLE                         
          SYSTEM      SEQUENCE    SYSTEM TABLE                         
          SYSTEM      STATS SYSTEM TABLE                         
          SYSTEM      TRACING_STATS     SYSTEM TABLE                         
                T     TABLE                    
    ------------------------------------------------------------------------------------------------------------+
    0: jdbc:phoenix:localhost:2181:/hbase&gt; upsert into t(a,b) values(1,1);
    1 row affected (0.046 seconds)
    0: jdbc:phoenix:localhost:2181:/hbase&gt; select * from SYSTEM.TRACING_STATS where trace_id=-7450651397611882467;
    ----------------------------------------------------------------------------------
    
    TRACE_ID    PARENT_ID   SPAN_ID     DESCRIPTION START_TIME  END_TIME    HOSTNAME    COUNT COUNT
    ----------------------------------------------------------------------------------
    ----------------------------------------------------------------------------------
    No rows selected (0.09 seconds)
    0: jdbc:phoenix:localhost:2181:/hbase&gt; select * from SYSTEM.TRACING_STATS;
    ----------------------------------------------------------------------------------
    
    TRACE_ID    PARENT_ID   SPAN_ID     DESCRIPTION START_TIME  END_TIME    HOSTNAME    COUNT COUNT
    ----------------------------------------------------------------------------------
    ----------------------------------------------------------------------------------
    No rows selected (0.09 seconds)
    @MrSandmanRUS @joshelser 

              </div></li><li><div>
                FAILURE: Integrated in Jenkins build Phoenix-omid2 #89 (See [https://builds.apache.org/job/Phoenix-omid2/89/])
PHOENIX-4817 Fixed Phoenix Tracing Web Application (fixed check null, (elserj: rev 1f7e3206bc0b1039b4b8a5fa9a2c8d06eb64e9d3)
* (edit) phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/TraceServlet.java
* (edit) phoenix-tracing-webapp/src/main/java/org/apache/phoenix/tracingwebapp/http/Main.java
* (edit) bin/traceserver.py

              </div></li></ol></div></div></html>