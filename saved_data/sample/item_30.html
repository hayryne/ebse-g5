<!DOCTYPE html><html><div class="item-title">
        Item 30
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Need to export this so the zombie subshell picks up current content
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HBASE-14772 Improve zombie detector; be more discerning; part2; addendum -- export JIRA_COMMENT so subshell zombie detector picks up current content
                </div><div><b>message:</b> HBASE-14772 Improve zombie detector; be more discerning; part2; addendum -- export JIRA_COMMENT so subshell zombie detector picks up current content

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Improve zombie detector; be more discerning
                </div><div><b>description:</b> Currently, any surefire process with the hbase flag is a potential zombie. Our zombie check currently takes a reading and if it finds candidate zombies, it waits 30 seconds and then does another reading. If a concurrent build going on, in both cases the zombie detector will come up positive though the adjacent test run may be making progress; i.e. the cast of surefire processes may have changed between readings but our detector just sees presence of  hbase surefire processes.

Here is example:

{code}
Suspicious java process found - waiting 30s to see if there are just slow to stop
There appear to be 5 zombie tests, they should have been killed by surefire but survived
12823 surefirebooter852180186418035480.jar -enableassertions -Dhbase.test -Xmx2800m -XX:MaxPermSize=256m -Djava.security.egd=file:/dev/./urandom -Djava.net.preferIPv4Stack=true -Djava.awt.headless=true
7653 surefirebooter8579074445899448699.jar -enableassertions -Dhbase.test -Xmx2800m -XX:MaxPermSize=256m -Djava.security.egd=file:/dev/./urandom -Djava.net.preferIPv4Stack=true -Djava.awt.headless=true
12614 surefirebooter136529596936417090.jar -enableassertions -Dhbase.test -Xmx2800m -XX:MaxPermSize=256m -Djava.security.egd=file:/dev/./urandom -Djava.net.preferIPv4Stack=true -Djava.awt.headless=true
7836 surefirebooter3217047564606450448.jar -enableassertions -Dhbase.test -Xmx2800m -XX:MaxPermSize=256m -Djava.security.egd=file:/dev/./urandom -Djava.net.preferIPv4Stack=true -Djava.awt.headless=true
13566 surefirebooter2084039411151963494.jar -enableassertions -Dhbase.test -Xmx2800m -XX:MaxPermSize=256m -Djava.security.egd=file:/dev/./urandom -Djava.net.preferIPv4Stack=true -Djava.awt.headless=true
************ BEGIN zombies jstack extract
************ END  zombies jstack extract
{code}

5 is the number of forked processes we allow when doing medium and large tests.... so an adjacent build will always show as '5 zombies'.

Need to add discerning if list of processes changes between readings.

Can I also add a tag per build run that all forked processes pick up so I can look at the current builds progeny only?
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                yeah, a UUID or some such specific to the current build would be perfect. on Jenkins at least, there's $\{BUILD_ID} that we can use.
              </div></li><li><div>
                Here's a start. It changes our tagging of surefire forked processes so instead of hbase.test, its now is hbase.build.id=BUILD_ID where BUILD_ID is whatever we pass maven on command line with -Dbuild.id. Was planning to pass in the jenkins BUILD_ID. If no BUILD_ID, it goes with the maven build time as ISO8601.

The zombie detector script in this patch takes recording of processes outstanding that have the current build id attached. It then waits 30 seconds. It then checks for presence of these process ids ... if they are still around (before, any surefire with the hbase.test flag would do... whether ours or not, whether it was a new test or not). So, more discerning.
              </div></li><li><div><div><b>body:</b> Some small improvement... more dogged at figuring what test we are running when zombie found. Let me add this and then massage in place.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Or, first, let me make sure the pom change goes over ok and doesn't break anything.
              </div></li><li><div><div><b>body:</b> {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12770968/zombiev2.patch
  against master branch at commit bfa36891901b96b95d82f5307642c35fd2b9f534.
  ATTACHMENT ID: 12770968

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified tests.

    {color:green}+1 hadoop versions{color}. The patch compiles with all supported hadoop versions (2.4.0 2.4.1 2.5.0 2.5.1 2.5.2 2.6.0 2.6.1 2.7.0 2.7.1)

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 protoc{color}.  The applied patch does not increase the total number of protoc compiler warnings.

    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.

    {color:green}+1 checkstyle{color}.  The applied patch does not increase the total number of checkstyle errors

    {color:green}+1 findbugs{color}.  The patch does not introduce any  new Findbugs (version 2.0.3) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 lineLengths{color}.  The patch introduces the following lines longer than 100:
    +    echo "Found ${ZOMBIE_TESTS_COUNT} suspicious java process(es); waiting ${wait}s to see if just slow to stop"
+      {color:red}-1 core zombie tests{color}.  There are ${ZOMBIE_TESTS_COUNT} possible zombie test(s): ${ZB_STACK}"
+    &lt;!--Mark our test runs with '-Dhbase.build.id' so we can identify a surefire test as ours in a process listing

  {color:green}+1 site{color}.  The mvn post-site goal succeeds with this patch.

    {color:green}+1 core tests{color}.  The patch passed unit tests in .

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/16425//testReport/
Release Findbugs (version 2.0.3) 	warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/16425//artifact/patchprocess/newFindbugsWarnings.html
Checkstyle Errors: https://builds.apache.org/job/PreCommit-HBASE-Build/16425//artifact/patchprocess/checkstyle-aggregate.html

  Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/16425//console

This message is automatically generated.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I pushed v2. This is part 1 of a few pushed I'd say till get it right. Let me hook it up now up in jenkins to run on trunk build. Will make for some messy output for a while ...  Will clean up in subsequent patches.
              </div></li><li><div>
                FAILURE: Integrated in HBase-Trunk_matrix #442 (See [https://builds.apache.org/job/HBase-Trunk_matrix/442/])
HBASE-14772 Improve zombie detector; be more discerning (stack: rev bea2f7feacd1a34d27ee17c201aaeacc32e8cdaf)
* pom.xml
* dev-support/zombie-detector.sh

              </div></li><li><div>
                SUCCESS: Integrated in HBase-Trunk_matrix #446 (See [https://builds.apache.org/job/HBase-Trunk_matrix/446/])
 HBASE-14772 Improve zombie detector; be more discerning; ADDENDUM set (stack: rev 305ecaf224340b0f6e248d4fdabf0b53e1cd3b03)
* dev-support/zombie-detector.sh

              </div></li><li><div>
                FAILURE: Integrated in HBase-Trunk_matrix #448 (See [https://builds.apache.org/job/HBase-Trunk_matrix/448/])
 HBASE-14772 Improve zombie detector; be more discerning; ADDENDUM some (stack: rev 1cbcf1175e6ce497936f12c60fb2e897833ace39)
* dev-support/test-patch.sh
* dev-support/zombie-detector.sh

              </div></li><li><div>
                SUCCESS: Integrated in HBase-Trunk_matrix #449 (See [https://builds.apache.org/job/HBase-Trunk_matrix/449/])
 HBASE-14772 Improve zombie detector; be more discerning; ADDENDUM Add  (stack: rev 4c2e0d95dc62ee42b3da820d751a11eb52ce0069)
* dev-support/zombie-detector.sh

              </div></li><li><div>
                FAILURE: Integrated in HBase-Trunk_matrix #452 (See [https://builds.apache.org/job/HBase-Trunk_matrix/452/])
  HBASE-14772 Improve zombie detector; be more discerning; ADDENDUM fix (stack: rev 44367f55e8bbd252ae824d1ddb626b5ce91fe75d)
* dev-support/zombie-detector.sh

              </div></li><li><div><div><b>body:</b> Here is some more cleanup in zombie detector... Better integration with the test-patch.sh. Pushed to master. Could break build.  Will keep an eye out.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                FAILURE: Integrated in HBase-Trunk_matrix #526 (See [https://builds.apache.org/job/HBase-Trunk_matrix/526/])
HBASE-14772 Improve zombie detector; be more discerning; part2 (stack: rev cf8d3bd641ef9f69dabecec1b9e87272493fe825)
* dev-support/zombie-detector.sh
* dev-support/test-patch.sh

              </div></li><li><div>
                FAILURE: Integrated in HBase-Trunk_matrix #527 (See [https://builds.apache.org/job/HBase-Trunk_matrix/527/])
 HBASE-14772 Improve zombie detector; be more discerning; part2; (stack: rev 69658ea4a916c8ea5e6dd7d056a548e8dce4e96d)
* dev-support/test-patch.sh

              </div></li><li><div>
                FAILURE: Integrated in HBase-Trunk_matrix #528 (See [https://builds.apache.org/job/HBase-Trunk_matrix/528/])
HBASE-14772 Improve zombie detector; be more discerning; part2; addendum (stack: rev a154ecda00d9d9a58e83d322dae7ffd3518b633c)
* dev-support/test-patch.sh

              </div></li><li><div>
                Resolving for now. I've done enough messing in here. Now the zombie detector shows up like any other attribute in the report and the zombie detector is shared by test-patch and jenkins branch builds.
              </div></li><li><div>
                FAILURE: Integrated in HBase-Trunk_matrix #529 (See [https://builds.apache.org/job/HBase-Trunk_matrix/529/])
 HBASE-14772 Improve zombie detector; be more discerning; part2; (stack: rev 5e430837d3e4a7d159e84964357297c8ab42430d)
* dev-support/test-patch.sh
* dev-support/zombie-detector.sh
 HBASE-14772 Improve zombie detector; be more discerning; part2; (stack: rev 7117a2e35d42ef4e3f17b0a8f891fc5200cd0890)
* dev-support/zombie-detector.sh

              </div></li></ol></div></div></html>