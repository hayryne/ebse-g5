<!DOCTYPE html><html><div class="item-title">
        Item 59
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                One extra for the backup on commit
First snapshot location
              </div></li><li><div>
                There will be 2 backups, otherwise 1
              </div></li><li><div>
                5 backups got created. 4 explicitly and one because a commit was called.
 Only the last two should still exist.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> SOLR-6214: Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>message:</b> SOLR-6214: Snapshots numberToKeep param only keeps n-1 backups

git-svn-id: https://svn.apache.org/repos/asf/lucene/dev/trunk@1659180 13f79535-47bb-0310-9956-ffa450edef68

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div><div><b>label:</b> test
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li><li><div><div><b>summary:</b> Snapshots numberToKeep param only keeps n-1 backups
                </div><div><b>description:</b> The numberToKeep param for snapshots doesn't work anymore. If you set the param to '2', only '1' backup is kept.

In the ReplicationHandler in line 377 snapShooter.validateCreateSnapshot(); creates an empty directory for the new snapshot. The deleteOldBackups() method in Snapshooter which will be executed before the backup is created, now sees the two directories an deletes the old one. But this is wrong because the empty directory for the new backup should not be considered.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Attached is the patch. Basically, "numberToKeep" is to indicate how many backups to retain (including this one). Reference http://wiki.apache.org/solr/SolrReplication

Now, we are not considering the new snapshot directory while comparing "numberToKeep" parameter with existing directories size.

if(numberToKeep &gt; dirs.size()-1) {
      return;
    }

with the changes in the patch, always "numbertokeep" parameter will be satisfied.

Please verify.



              </div></li><li><div><div><b>body:</b> Thanks Mathias and Ramana. We need a test as well before it can be committed.
                </div><div><b>label:</b> test
                </div></div></li><li><div>
                Shalin, Updated the patch with test case. Please verify.
              </div></li><li><div>
                {code}
File dir = new File(snapDir);
if (!dir.exists())  dir.mkdirs();
{code}

This is not needed because we call {{SimpleFSDirectory(destDir.toPath(), NoLockFactory.INSTANCE)}} which creates the snapDir if not present.

Secondly I moved deleteOldBackups after the snapshot gets created. That makes sense right?

Fixed the test to catch this regression. If you just run the test without making the fix to SnapShooter the test will fail.
              </div></li><li><div>
                Correct patch.
              </div></li><li><div>
                Thanks Mathias, Ramana and Varun!
              </div></li><li><div>
                Commit 1659180 from shalin@apache.org in branch 'dev/trunk'
[ https://svn.apache.org/r1659180 ]

SOLR-6214: Snapshots numberToKeep param only keeps n-1 backups
              </div></li><li><div>
                Commit 1659181 from shalin@apache.org in branch 'dev/branches/branch_5x'
[ https://svn.apache.org/r1659181 ]

SOLR-6214: Snapshots numberToKeep param only keeps n-1 backups
              </div></li><li><div><div><b>body:</b> Small typo in line 235 of TestReplicationHandlerBackup - 

{{fail("Backup should have been cleaned up because " + backupKeepParamName + " was set to 2.");}} should be
{{fail("Backup should have been cleaned up because " + backupKeepParamName + " was set to 1.");}}
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                Fixed, thanks!
              </div></li><li><div>
                Commit 1659203 from shalin@apache.org in branch 'dev/trunk'
[ https://svn.apache.org/r1659203 ]

SOLR-6214: Fix mistake in failure message
              </div></li><li><div>
                Commit 1659204 from shalin@apache.org in branch 'dev/branches/branch_5x'
[ https://svn.apache.org/r1659204 ]

SOLR-6214: Fix mistake in failure message
              </div></li><li><div>
                Bulk close after 5.1 release
              </div></li></ol></div></div></html>