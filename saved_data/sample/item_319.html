<!DOCTYPE html><html><div class="item-title">
        Item 319
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> LANG-799 - DateUtils#parseDate uses default locale; add Locale support
                </div><div><b>message:</b> LANG-799 - DateUtils#parseDate uses default locale; add Locale support
Show current default locale

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/lang/trunk@1388824 13f79535-47bb-0310-9956-ffa450edef68

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> DateUtils#parseDate uses default locale; add Locale support
                </div><div><b>description:</b> Similar issue as https://issues.apache.org/jira/browse/HTTPCLIENT-471

Following line throws an ParseException on a German system:
d = DateUtils.parseDate("Wed, 09 Apr 2008 23:55:38 GMT", new String[] {"EEE, dd MMM yyyy HH:mm:ss zzz"});

Reason: parseDate internally calls SimpleDateFormat without providing a locale. This causes "MMM" to be interpreted using the system locale. If the system is German, the date is trying to be interpreted as German date.

I see following solutions:
 A) Always instantiate SimpleDateFormat with Locale.ENGLISH
 B) Make two instances of SimpleDateFormat. One without providing a locale and one with Locale.ENGLISH. Try two parsings
 C) Make as many SimpleDateFormat instances as locales are availble iterate over all instances at the parsing attempts.
 D) provide an additional (optional) parameter to parseDate for providing a Locale

I would prefer B) as this seems the best trade-off between internationalization and local usage.

What do you think?
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                There seems no reason to treat Locale.ENGLISH specially here.

I think option D is the best.

i.e. leave the current behaviour as is (and make sure it's documented), but allow the Locale to be provided.
              </div></li><li><div>
                Attached is a patch that adds overloaded versions of parseDate and parseDateStrictly with a Locale parameter (option D), plus unit tests. 

If a locale is supplied, the patterns will be interpreted using the date format symbols for that locale.

The original issue would then be addressed by:

{code}
d = DateUtils.parseDate("Wed, 09 Apr 2008 23:55:38 GMT", Locale.ENGLISH, 
        new String[] {"EEE, dd MMM yyyy HH:mm:ss zzz"});
{code}
              </div></li><li><div>
                Added tests to show current behaviour, i.e. ParseException occurs if default Locale does not match date:

URL: http://svn.apache.org/viewvc?rev=1388787&amp;view=rev
Log:
LANG-799 Add tests to show ParseException when default Locale is wrong

Modified:
    commons/proper/lang/trunk/src/test/java/org/apache/commons/lang3/time/DateUtilsTest.java

Some of these would need to be changed if option D is not used.
              </div></li><li><div>
                Not sure it's necessary for the code to check that the Locale is supported.
Seems to me such a check should be done by the caller if required.
              </div></li><li><div>
                The patch breaks the tests I just added for UK and DE parsing.

This is because the patch now uses 
    parser.applyLocalizedPattern(pattern);
whereas previously it used
    parser.applyPattern(pattern);

I think it's wrong to assume that the patterns are localised; it will potentially break existing applications (just as it broke the tests I just added).
              </div></li><li><div>
                Applied patch with minor tweaks:
- dropped check for valid Locale
- use applyPattern not applyLocalizedPattern

URL: http://svn.apache.org/viewvc?rev=1388806&amp;view=rev
Log:
LANG-799 - DateUtils#parseDate uses default locale; add Locale support

Modified:
    commons/proper/lang/trunk/src/changes/changes.xml
    commons/proper/lang/trunk/src/main/java/org/apache/commons/lang3/time/DateUtils.java
    commons/proper/lang/trunk/src/test/java/org/apache/commons/lang3/time/DateUtilsTest.java

              </div></li><li><div><div><b>body:</b> That last commit now breaks the build, as my test {{testParseNonSystemLocale()}} assumed the localized pattern change and now fails.

I suggest you add a couple of tests, based on your new tests. E.g. you have:

{code}
    // Parse German date with English Locale
    @Test(expected=ParseException.class)
    public void testLANG799_EN_FAIL() throws ParseException {
        Locale dflt = Locale.getDefault();
        Locale.setDefault(Locale.ENGLISH);
        try {
            DateUtils.parseDate("Mi, 09 Apr 2008 23:55:38 GMT", "EEE, dd MMM yyyy HH:mm:ss zzz");
        } finally {
            Locale.setDefault(dflt);            
        }
    }
{code}

And so I would now add, for example:

{code}
    // Parse German date with English Locale, specifying German Locale override
    @Test
    public void testLANG799_EN_WITH_DE_LOCALE() throws ParseException {
        Locale dflt = Locale.getDefault();
        Locale.setDefault(Locale.ENGLISH);
        try {
            DateUtils.parseDate("Mi, 09 Apr 2008 23:55:38 GMT", Locale.GERMAN, "EEE, dd MMM yyyy HH:mm:ss zzz");
        } finally {
            Locale.setDefault(dflt);            
        }
    }
{code}

You can ditch my test {{testParseNonSystemLocale}} and the associated {{getLongDateFormatForLocale}}.
                </div><div><b>label:</b> test
                </div></div></li><li><div>
                Please, ensure the tests ruin with Java 5 as well as with newer ones. And note, that the JDK switched the behavior between Java 5 and 6. Java 5 always uses English time zone short cuts (e.g. "CET" for Central European Time), while they are localized since Java 6 ("MEZ" for Mitteleuropäische Zeit).
              </div></li><li><div>
                Also, we should now remove {{testParseBadLocale()}} as we are no longer checking the Locale upon entry to the method.
              </div></li><li><div>
                bq. That last commit now breaks the build, as my test testParseNonSystemLocale() assumed the localized pattern change and now fails.

Does not fail for me, even if I change the default Locale to Locale.GERMAN(Y)
              </div></li><li><div>
                URL: http://svn.apache.org/viewvc?rev=1388818&amp;view=rev
Log:
LANG-799 - DateUtils#parseDate uses default locale; add Locale support
Remove unnecessary test

Modified:
    commons/proper/lang/trunk/src/test/java/org/apache/commons/lang3/time/DateUtilsTest.java

URL: http://svn.apache.org/viewvc?rev=1388821&amp;view=rev
Log:
LANG-799 - DateUtils#parseDate uses default locale; add Locale support
Parse German date with English Locale, specifying German Locale override

Modified:
    commons/proper/lang/trunk/src/test/java/org/apache/commons/lang3/time/DateUtilsTest.java
              </div></li><li><div>
                bq. Please, ensure the tests ruin with Java 5 as well as with newer ones. 

The pom specifies Java 1.6 for Lang3

bq. And note, that the JDK switched the behavior between Java 5 and 6. Java 5 always uses English time zone short cuts (e.g. "CET" for Central European Time), while they are localized since Java 6 ("MEZ" for Mitteleuropäische Zeit).

Not sure what that refers to; sounds like a separate bug (if any).
              </div></li><li><div>
                bq. Does not fail for me, even if I change the default Locale to Locale.GERMAN(Y)

This appears to be related to Java version. I was inadvertently compiling and executing the tests with JDK 7 not 6. The test passes under 6 and fails under 7.
              </div></li><li><div>
                Java 7 has many more Locales. It so happens that the first different format string for Java 1.7 use formatting entries that are not in the standard pattern.

Removed the test, as it no longer applies (we don't use localized formats)

URL: http://svn.apache.org/viewvc?rev=1389172&amp;view=rev
Log:
LANG-799 - DateUtils#parseDate uses default locale; add Locale support
Remove inappropriate test - we don't use localized formats

Modified:
    commons/proper/lang/trunk/src/test/java/org/apache/commons/lang3/time/DateUtilsTest.java

              </div></li></ol></div></div></html>