<!DOCTYPE html><html><div class="item-title">
        Item 201
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Check if string tail is full ASCII (common case, fast)
              </div></li><li><div>
                 size == 0 
              </div></li><li><div>
                 Fall back to UTF8 validation of tail string.
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> ARROW-10313: [C++] Faster UTF8 validation for small strings
                </div><div><b>message:</b> ARROW-10313: [C++] Faster UTF8 validation for small strings

This improves CSV string conversion performance by about 30%.

Closes #8470 from pitrou/ARROW-10313-faster-utf8-validate

Authored-by: Antoine Pitrou &lt;antoine@python.org&gt;
Signed-off-by: Antoine Pitrou &lt;antoine@python.org&gt;

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> ARROW-10313: [C++] Faster UTF8 validation for small strings
                </div><div><b>body:</b> This improves CSV string conversion performance by about 30%.
                </div></div></li><li><div><div><b>title:</b> ARROW-10313: [C++] Faster UTF8 validation for small strings
                </div><div><b>body:</b> This improves CSV string conversion performance by about 30%.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> ARROW-10313: [C++] Faster UTF8 validation for small strings
                </div><div><b>body:</b> This improves CSV string conversion performance by about 30%.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> ARROW-10313: [C++] Faster UTF8 validation for small strings
                </div><div><b>body:</b> This improves CSV string conversion performance by about 30%.
                </div></div></li><li><div><div><b>title:</b> ARROW-10313: [C++] Faster UTF8 validation for small strings
                </div><div><b>body:</b> This improves CSV string conversion performance by about 30%.
                </div></div></li><li><div><div><b>title:</b> ARROW-10313: [C++] Faster UTF8 validation for small strings
                </div><div><b>body:</b> This improves CSV string conversion performance by about 30%.
                </div></div></li><li><div><div><b>title:</b> ARROW-10313: [C++] Faster UTF8 validation for small strings
                </div><div><b>body:</b> This improves CSV string conversion performance by about 30%.
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                https://issues.apache.org/jira/browse/ARROW-10313
              </div></li><li><div>
                This also improves the ARROW-10308 benchmark by about 9%.
              </div></li><li><div><div><b>body:</b> Another possibility would be to compute and store ASCIIness of values while parsing CSV (ideally this should not cost anything CPU-wise). Then we can reuse that information to skip UTF8 validation for most values.

Edit: actually, a quick attempt shows a significant decrease in CSV parsing speed. Too bad.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                ```suggestion
    uint32_t head_mask = internal::SafeLoadAs&lt;uint32_t&gt;(data);
    uint32_t tail_mask = internal::SafeLoadAs&lt;uint32_t&gt;(data + size - 4);
    if (ARROW_PREDICT_TRUE(((head_mask | tail_mask) &amp; high_bits_32) == 0)) {
      return true;
    } 
```
              </div></li><li><div>
                ```suggestion
    uint16_t tail_mask = SafeLoadAs&lt;uint16_t&gt;(data + size - 2);
    uint16_t head_mask = SafeLoadAs&lt;uint16_t&gt;(data);
```
              </div></li><li><div>
                ```suggestion
    uint64_t mask64 = SafeLoadAs&lt;uint64_t&gt;(data);
```
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> [C++] Improve UTF8 validation speed and CSV string conversion
                </div><div><b>description:</b> Based on profiling from ARROW-10308, UTF8 validation is a bottleneck of CSV string conversion.

This is because we must validate many small UTF8 strings individually.
                </div></div></li><li><div><div><b>summary:</b> [C++] Improve UTF8 validation speed and CSV string conversion
                </div><div><b>description:</b> Based on profiling from ARROW-10308, UTF8 validation is a bottleneck of CSV string conversion.

This is because we must validate many small UTF8 strings individually.
                </div></div></li><li><div><div><b>summary:</b> [C++] Improve UTF8 validation speed and CSV string conversion
                </div><div><b>description:</b> Based on profiling from ARROW-10308, UTF8 validation is a bottleneck of CSV string conversion.

This is because we must validate many small UTF8 strings individually.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Issue resolved by pull request 8470
[https://github.com/apache/arrow/pull/8470]
              </div></li></ol></div></div></html>