<!DOCTYPE html><html><div class="item-title">
        Item 58
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
   * Our own Random, seeded from LuceneTestCase on init, so that we can produce a consistent sequence 
   * of random chaos regardless of if/how othe threads access the test randomness in other threads
   * @see LuceneTestCase#random()
   
              </div></li><li><div>
                *
   * causes some randomly selected chaos
   
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> SOLR-8849: improve reproducibility in random order of chaosmonkey actions
                </div><div><b>message:</b> SOLR-8849: improve reproducibility in random order of chaosmonkey actions

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> ChaosMonkey should cuase chaos in a more reproducible manner
                </div><div><b>description:</b> Looking into the ChaosMonkey code a bit, and it seems like this class -- particularly the way {{monkeyThread}} is defined -- uses randomness in a way that makes it extremely unlikely that it will ever create reproducible failures.

Obviously in any test where there are multiple concurrent threads, timing issues might prevent test reproducibility -- but in this case, even the sequence of "chaos" actions the monkeyThread takes won't be reproducible if anyother concurrent test thread accesses {{LuceneTestCase.random()}} ...

{code}
      public void run() {
        while (!stop) {
          try {
    
            Random random = LuceneTestCase.random();
            // ... lots of stuff using random, or calling methods that use LuceneTestCase.random() directly
{code}

It seems like it would be a lot better if ChaosMonkey's constructor created it's own private {{Random chaosRand}} using {{LuceneTestCase.random()}} as a seed, and then used {{chaosRand}} to make all random choices in it's methods.

That way at least the sequence of chaotic operations made by ChaosMonkey would be consistent for a given test seed, even if the exact timing/interleaving of those operations relative to other operations by other threads couldn't be garunteed.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div><div><b>body:</b> i'm happy to work on this, but before i spend any time on it i'd appreciate if [~markrmiller@gmail.com] or someone else equally familiar with ChaosMonkey could sanity check my assessment (i can't imagine the current behavior is intentionally desired, but it also seems like it would have been totally obvious when initially written this way, so i'm not sure why it wasn't caught then)
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Makes sense to me. I don't see a problem with the change. 
              </div></li><li><div><div><b>body:</b> proposed patch.

in addition to cleaning up the random usage, this also refactors the non-loop/sleep portions of the monkeyThread into a new {{public void causeSomeChaos()}} method.

this way, it's possible to write a (single threaded) test with 100% reproducible chaos w/o needing to write your own random decision making about what chaos methods to call.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Commit 0bafb171083f58034900a31f83feb8f09b26bc04 in lucene-solr's branch refs/heads/branch_6_0 from [~hossman_lucene@fucit.org]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0bafb17 ]

SOLR-8849: improve reproducibility in random order of chaosmonkey actions

              </div></li><li><div>
                Commit 0739f9155b80fdacb90309159523258452b27484 in lucene-solr's branch refs/heads/branch_6x from [~hossman_lucene@fucit.org]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0739f91 ]

SOLR-8849: improve reproducibility in random order of chaosmonkey actions

              </div></li><li><div>
                Commit 0f78235b9450ed7a81313dd9c7b9d7dfa4b57ee3 in lucene-solr's branch refs/heads/master from [~hossman_lucene@fucit.org]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0f78235 ]

SOLR-8849: improve reproducibility in random order of chaosmonkey actions

              </div></li></ol></div></div></html>