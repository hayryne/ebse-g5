<!DOCTYPE html><html><div class="item-title">
        Item 313
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Script to build ccache for debian and ubuntu based images.
 Manually specify x86 gcc versions so that this script remains compatible with dockcross (which uses an ARM based gcc
 by default).
              </div></li><li><div>
                 Script to build ccache for debian and ubuntu based images.
 Manually specify x86 gcc versions so that this script remains compatible with dockcross (which uses an ARM based gcc
 by default).
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching (#11302)
                </div><div><b>message:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching (#11302)

* Add ccache reporting to CI

* Restructure dockcross dockerfiles to fix caching

                </div></div></li></ol></div><div><b>github_issues:</b> <ol><li><div><div><b>title:</b> Docker cache is not being used
                </div><div><b>body:</b> As can be seen for all [latest builds](http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11252/1/pipeline/70):  docker cache is not being reused and images are always getting rebuild. This is due to the ccache change https://github.com/apache/incubator-mxnet/pull/11151 

The problem is that due to [multiheaded docker build](https://github.com/apache/incubator-mxnet/blob/master/ci/docker/Dockerfile.build.armv7#L21-L31) the first build does not get a tag and is considered an intermediate layer.

The `--cache-from` parameter in [build.py](https://github.com/apache/incubator-mxnet/blob/master/ci/build.py#L79) restricts the cache only to tagged images and that leads to rebuilds.
                </div></div></li><li><div><div><b>title:</b> Docker cache is not being used
                </div><div><b>body:</b> As can be seen for all [latest builds](http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11252/1/pipeline/70):  docker cache is not being reused and images are always getting rebuild. This is due to the ccache change https://github.com/apache/incubator-mxnet/pull/11151 

The problem is that due to [multiheaded docker build](https://github.com/apache/incubator-mxnet/blob/master/ci/docker/Dockerfile.build.armv7#L21-L31) the first build does not get a tag and is considered an intermediate layer.

The `--cache-from` parameter in [build.py](https://github.com/apache/incubator-mxnet/blob/master/ci/build.py#L79) restricts the cache only to tagged images and that leads to rebuilds.
                </div></div></li><li><div><div><b>title:</b> Docker cache is not being used
                </div><div><b>body:</b> As can be seen for all [latest builds](http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11252/1/pipeline/70):  docker cache is not being reused and images are always getting rebuild. This is due to the ccache change https://github.com/apache/incubator-mxnet/pull/11151 

The problem is that due to [multiheaded docker build](https://github.com/apache/incubator-mxnet/blob/master/ci/docker/Dockerfile.build.armv7#L21-L31) the first build does not get a tag and is considered an intermediate layer.

The `--cache-from` parameter in [build.py](https://github.com/apache/incubator-mxnet/blob/master/ci/build.py#L79) restricts the cache only to tagged images and that leads to rebuilds.
                </div></div></li><li><div><div><b>title:</b> Docker cache is not being used
                </div><div><b>body:</b> As can be seen for all [latest builds](http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11252/1/pipeline/70):  docker cache is not being reused and images are always getting rebuild. This is due to the ccache change https://github.com/apache/incubator-mxnet/pull/11151 

The problem is that due to [multiheaded docker build](https://github.com/apache/incubator-mxnet/blob/master/ci/docker/Dockerfile.build.armv7#L21-L31) the first build does not get a tag and is considered an intermediate layer.

The `--cache-from` parameter in [build.py](https://github.com/apache/incubator-mxnet/blob/master/ci/build.py#L79) restricts the cache only to tagged images and that leads to rebuilds.
                </div></div></li><li><div><div><b>title:</b> Docker cache is not being used
                </div><div><b>body:</b> As can be seen for all [latest builds](http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11252/1/pipeline/70):  docker cache is not being reused and images are always getting rebuild. This is due to the ccache change https://github.com/apache/incubator-mxnet/pull/11151 

The problem is that due to [multiheaded docker build](https://github.com/apache/incubator-mxnet/blob/master/ci/docker/Dockerfile.build.armv7#L21-L31) the first build does not get a tag and is considered an intermediate layer.

The `--cache-from` parameter in [build.py](https://github.com/apache/incubator-mxnet/blob/master/ci/build.py#L79) restricts the cache only to tagged images and that leads to rebuilds.
                </div></div></li><li><div><div><b>title:</b> Docker cache is not being used
                </div><div><b>body:</b> As can be seen for all [latest builds](http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11252/1/pipeline/70):  docker cache is not being reused and images are always getting rebuild. This is due to the ccache change https://github.com/apache/incubator-mxnet/pull/11151 

The problem is that due to [multiheaded docker build](https://github.com/apache/incubator-mxnet/blob/master/ci/docker/Dockerfile.build.armv7#L21-L31) the first build does not get a tag and is considered an intermediate layer.

The `--cache-from` parameter in [build.py](https://github.com/apache/incubator-mxnet/blob/master/ci/build.py#L79) restricts the cache only to tagged images and that leads to rebuilds.
                </div></div></li><li><div><div><b>title:</b> Docker cache is not being used
                </div><div><b>body:</b> As can be seen for all [latest builds](http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11252/1/pipeline/70):  docker cache is not being reused and images are always getting rebuild. This is due to the ccache change https://github.com/apache/incubator-mxnet/pull/11151 

The problem is that due to [multiheaded docker build](https://github.com/apache/incubator-mxnet/blob/master/ci/docker/Dockerfile.build.armv7#L21-L31) the first build does not get a tag and is considered an intermediate layer.

The `--cache-from` parameter in [build.py](https://github.com/apache/incubator-mxnet/blob/master/ci/build.py#L79) restricts the cache only to tagged images and that leads to rebuilds.
                </div></div></li><li><div><div><b>title:</b> Docker cache is not being used
                </div><div><b>body:</b> As can be seen for all [latest builds](http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11252/1/pipeline/70):  docker cache is not being reused and images are always getting rebuild. This is due to the ccache change https://github.com/apache/incubator-mxnet/pull/11151 

The problem is that due to [multiheaded docker build](https://github.com/apache/incubator-mxnet/blob/master/ci/docker/Dockerfile.build.armv7#L21-L31) the first build does not get a tag and is considered an intermediate layer.

The `--cache-from` parameter in [build.py](https://github.com/apache/incubator-mxnet/blob/master/ci/build.py#L79) restricts the cache only to tagged images and that leads to rebuilds.
                </div></div></li></ol></div><div><b>github_issues_comments:</b> <ol><li><div>
                I don't have permissions to add labels, but I believe that this should be tagged with the `CI` label.
              </div></li><li><div>
                http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11210/8/pipeline something is happening with ccache is it related or a different issue?
              </div></li><li><div>
                @ThomasDelteil it is indeed related to ccache, but is a different error
              </div></li><li><div>
                thanks @ThomasDelteil for the link!
              </div></li><li><div>
                @sandeep-krishnamurthy could you add label "CI", "Docker" to this?
              </div></li><li><div>
                The issue should have been fixed by https://github.com/apache/incubator-mxnet/pull/11302
              </div></li></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [MXNET-553] Restructure dockcross dockerfiles to fix caching
                </div><div><b>body:</b> ## Description ##
This PR restructures the dockcross Dockerfiles to remove their multi-head components.  These multi-head components made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.   A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.  We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.

Should address #11257.

## Checklist ##
### Essentials ###
Please feel free to remove inapplicable items for your PR.
- [x] The PR title starts with [MXNET-$JIRA_ID], where $JIRA_ID refers to the relevant [JIRA issue](https://issues.apache.org/jira/projects/MXNET/issues) created (except PRs with tiny changes)
- [x] Changes are complete (i.e. I finished coding on this PR)
- [x] All changes have test coverage:
- Ran test_docker_cache.py, ensured both existing tests pass.
- [x] Code is well-documented: 
- [x] To the my best knowledge, examples are either not affected by this change, or have been fixed to be compatible with this change

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                Would appreciate a review from @marcoabreu and @lebeg.
              </div></li><li><div>
                Excellent work @KellenSunderland! Do you think there is any need to make the centos installations also robust to compiler changes? Maybe mentioning https://github.com/apache/incubator-mxnet/issues/11257 would be good as well.
              </div></li><li><div><div><b>body:</b> @lebeg I think calling the compiler with $CC should be sufficient for CentOS, at least for the time being.  We can always update in the future if needed.

@larroy I think there's a feature request that will make this easier in the future.  Hopefully v19 will include the feature req.  It is certainly a breaking change from versions prior to 17, but it's made as a response to some valid security concerns.  There's also a work around, but I think implementing this would add quite a lot of complexity.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Great job, Kellen! Thanks a lot!

I think the ccache is now not being applied to all builds. Examples:
http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11302/2/pipeline/59
http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11302/2/pipeline/54

On some others, it works:
http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11302/2/pipeline/52
http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11302/2/pipeline/51

Have a look at the execution durations to see whether ccache was actually used or not.

Things that still don't work and haven't worked before are GPU builds. Those are a separate issue.
              </div></li><li><div>
                LGTM I can try what I asked myself as I'm not sure my question was well understood.
              </div></li><li><div>
                @larroy Sounds good, we can also chat offline about if it in more detail if I've misunderstood.

@marcoabreu Not sure I fully understand the examples you've given.  Do they relate to the issue that this PR addresses (docker cache misses?).
              </div></li><li><div>
                Yes, I got the feeling that your changes are causing some builds to not use ccache anymore. It'd be good if you could verify that
              </div></li><li><div>
                @marcoabreu Gotcha.  I think what would be useful would be to include some more information about what ccache is doing into the logs.  I'll see if I can create a (separate) PR to do that, and then rebase.
              </div></li><li><div>
                That's an excellent idea! Maybe just printing the cache hit/miss statistics after a build (not globally using ccache -s as it will include everything).
              </div></li><li><div>
                Could you elaborate Pedro? Kellen removes the multi head in his PR while your log seems to be referencing a dockerfile that still has it. Could it be possible you checked out the wrong commit?
              </div></li><li><div>
                @marcoabreu @larroy: No actually the error Pedro pointed out was a valid error.  I've fixed it and am investigating why the build succeeded earlier.

Edit: looks like the earlier run didn't tests Android/64 so that would explain it.  Thanks for the testing Pedro.
              </div></li><li><div>
                Ah your PR did not change Android Arm64 because we just merged it and that caused the race condition in the git merge. Thanks for elaborating
              </div></li><li><div>
                Any other data you want to see here @marcoabreu ?  No rush on the merge but lmk if you need anything else.
              </div></li><li><div>
                I compared the two following runs:
http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11302/6/pipeline/58
http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/master/1012/pipeline/56/

I noticed the following slow downs - partially quite significantely:
CPU clang 3.9, CPU clang 3.9 MKLDNN, CPU clang 5.0, CPU clang 5.0 MKLDNN, CPU MKLDNN, CPU: Openblas, GPU CMake, GPU CMake MKLDNN, GPU CUDA 9.1, GPU MKLDNN, NVidia Jetson ARMv8

The other ones have not been slowed down or improved. 

I think we should investigate this before we merge. What I noticed is that the CentOS ones are still exactly the same while almost all other jobs got slower by up to factors like 10x
              </div></li><li><div>
                Right but why would we see speed ups before the docker cache is pushed?

On Tue, Jun 19, 2018, 7:48 AM Marco de Abreu &lt;notifications@github.com&gt;
wrote:

&gt; I compared the two following runs:
&gt;
&gt; http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/PR-11302/6/pipeline/58
&gt;
&gt; http://jenkins.mxnet-ci.amazon-ml.com/blue/organizations/jenkins/incubator-mxnet/detail/master/1012/pipeline/56/
&gt;
&gt; I noticed the following slow downs - partially quite significantely:
&gt; CPU clang 3.9, CPU clang 3.9 MKLDNN, CPU clang 5.0, CPU clang 5.0 MKLDNN,
&gt; CPU MKLDNN, CPU: Openblas, GPU CMake, GPU CMake MKLDNN, GPU CUDA 9.1, GPU
&gt; MKLDNN, NVidia Jetson ARMv8
&gt;
&gt; The other ones have not been slowed down or improved.
&gt;
&gt; I think we should investigate this before we merge. What I noticed is that
&gt; the CentOS ones are still exactly the same while almost all other jobs got
&gt; slower by up to factors like 10x
&gt;
&gt; —
&gt; You are receiving this because you were mentioned.
&gt; Reply to this email directly, view it on GitHub
&gt; &lt;https://github.com/apache/incubator-mxnet/pull/11302#issuecomment-398281560&gt;,
&gt; or mute the thread
&gt; &lt;https://github.com/notifications/unsubscribe-auth/AHGTE4B-l7x3IR7zmYuG7Xsri9n74YR4ks5t-JCxgaJpZM4Upb4P&gt;
&gt; .
&gt;

              </div></li><li><div>
                Oops, I forgot to take that time into account. Thank you and sorry for the inconvenience.
              </div></li><li><div>
                Thanks man, appreciate it.  I'll make sure and monitor master for a couple days and verify that the cache is being utilized.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Can't we set this environment variable in the docker file and then unset it? Since it's specific to dockcross.
              </div></li><li><div><div><b>body:</b> We want to ensure we're maintaining the CC and CXX env vars from the 'dockcross/linux-armv7' image, so to do this we'd have to store those and then restore them.  Seems more complicated than just overriding them for a single command to me.

What would be the advantage, readability?
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Restructure dockcross dockerfiles to fix caching
                </div><div><b>description:</b> Restructure the dockcross Dockerfiles to remove their multi-head components.&nbsp; This multi-head component made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.&nbsp;&nbsp; A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.&nbsp; We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Restructure dockcross dockerfiles to fix caching
                </div><div><b>description:</b> Restructure the dockcross Dockerfiles to remove their multi-head components.&nbsp; This multi-head component made it difficult to properly provide a remote cache for the Dockerfiles, and was slowing down builds.&nbsp;&nbsp; A simple work-around for this was to generalize the ubuntu_ccache.sh file such that it works with ubuntu, debian, and in cross-compilation containers.&nbsp; We can now use this script the same way in a variety of containers, which eliminates the need for a special multi-head docker stage.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>