<!DOCTYPE html><html><div class="item-title">
        Item 313
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
   * This test reproduces the issue of trying to delete zk-nodes that have the same length. (SOLR-14961).
   *
   * @throws InterruptedException when having trouble creating test nodes
   * @throws KeeperException error when talking to zookeeper
   * @throws SolrServerException when having trouble connecting to solr
   * @throws UnsupportedEncodingException when getBytes() uses unknown encoding
   *
   
              </div></li><li><div>
                 create zk nodes that have the same path length
              </div></li><li><div>
                 CHECK 
              </div></li><li><div>
                 RUN 
              </div></li><li><div>
                 delete all nodes that contain "file"
              </div></li><li><div>
                 PREPARE 
              </div></li><li><div>
                 list of node must not contain file1, file2 or some_longer_file2 because they where deleted
              </div></li><li><div>
                 sort the list in descending order to ensure that child entries are deleted first
              </div></li><li><div>
                *
   * This test reproduces the issue of trying to delete zk-nodes that have the same length. (SOLR-14961).
   *
   * @throws InterruptedException when having trouble creating test nodes
   * @throws KeeperException error when talking to zookeeper
   * @throws SolrServerException when having trouble connecting to solr
   * @throws UnsupportedEncodingException when getBytes() uses unknown encoding
   *
   
              </div></li><li><div>
                 create zk nodes that have the same path length
              </div></li><li><div>
                 CHECK 
              </div></li><li><div>
                 RUN 
              </div></li><li><div>
                 delete all nodes that contain "file"
              </div></li><li><div>
                 PREPARE 
              </div></li><li><div>
                 list of node must not contain file1, file2 or some_longer_file2 because they where deleted
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> SOLR-14961 ZkMaintenanceUtils.clean doesn't remove zk nodes with same length
                </div><div><b>message:</b> SOLR-14961 ZkMaintenanceUtils.clean doesn't remove zk nodes with same length

fixes #2042

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> SOLR-14961:  ZkMaintenanceUtils.clean doesn't remove zk-nodes with same path length
                </div><div><b>body:</b> &lt;!--
_(If you are a project committer then you may remove some/all of the following template.)_

Before creating a pull request, please file an issue in the ASF Jira system for Lucene or Solr:

* https://issues.apache.org/jira/projects/LUCENE
* https://issues.apache.org/jira/projects/SOLR

You will need to create an account in Jira in order to create an issue.

The title of the PR should reference the Jira issue number in the form:

* LUCENE-####: &lt;short description of problem or changes&gt;
* SOLR-####: &lt;short description of problem or changes&gt;

LUCENE and SOLR must be fully capitalized. A short description helps people scanning pull requests for items they can work on.

Properly referencing the issue in the title ensures that Jira is correctly updated with code review comments and commits. --&gt;


# Description

- use ArrayList instead of TreeSet to allow multiple entries that are equal (in this case of equal length)
- sort the ArrayList afterwards

# Solution

Usage of a data stucture that allows to store duplicates in terms of the comparator used.

# Tests

Added test method to SolrZkClientTest, that adds multiple nodes to zookeeper (some of equal length). Afterwards these nodes are deleted via the ZkMaintenanceUtils.clean(...) method. Then the nodes are queried again to check if all nodes that should have been deleted are gone.

# Checklist

Please review the following and check all that apply:

- [ x ] I have reviewed the guidelines for [How to Contribute](https://wiki.apache.org/solr/HowToContribute) and my code conforms to the standards described there to the best of my ability.
- [ x ] I have created a Jira issue and added the issue ID to my pull request title.
- [ ] I have given Solr maintainers [access](https://help.github.com/en/articles/allowing-changes-to-a-pull-request-branch-created-from-a-fork) to contribute to my PR branch. (optional but recommended)
- [ x ] I have developed this patch against the `master` branch.
- [ ] I have run `./gradlew check`.
- [ x ] I have added tests for my changes.
- [ ] I have added documentation for the [Ref Guide](https://github.com/apache/lucene-solr/tree/master/solr/solr-ref-guide) (for Solr changes only).

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                I added the changes recommended by @madrob 
              </div></li><li><div>
                Hmmm, I wasn't looking closely enough when I made some of those recommendations. You're right that the test should be in `org.apache.solr.common.cloud` but there is also already `o.a.s.common.util.TestZkMaintenanceUtil` - can you combine the two?
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                I... don't think this is right to include `/lucene/` and `/solr/`
              </div></li><li><div>
                Please don't leave this commented out line in the code.
              </div></li><li><div>
                Thank you for including this comment! It's really helpful to me!
              </div></li><li><div>
                nit: use StandardCharsets.UTF8
              </div></li><li><div>
                nit: assertFalse
              </div></li><li><div>
                A better place might be TestZkMaintenanceUtils
              </div></li><li><div>
                @dsmiley I don't use Eclipse so I don't know if we need this or not, can you PTAL?
              </div></li><li><div>
                nit: this should be list.sort
              </div></li><li><div>
                StandardCharsets here too
              </div></li><li><div>
                s/troublke/trouble
              </div></li><li><div>
                PTAL?
I don't use Eclipse either.  Let's not modify .gitignore in this PR.

These paths are for previous branches (branch_8x), but not master.  I don't think we should pollute the .gitignore of master branch with directories that should be ignored of previous release branches.  The contributor probably switched branches.  Different checkouts, ideally aided by `git worktree` should be used.
              </div></li><li><div>
                Maybe a comment at the bottom of this file could raise awareness of this to anyone who is tempted to touch it?
              </div></li><li><div>
                "Please take a look," maybe that's less common than I thought. Agree with not touching the file, I can add a comment/suggestion to it in a separate commit.
              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>