<!DOCTYPE html><html><div class="item-title">
        Item 306
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                github.com/apache/brooklyn-library/pull/39.
              </div></li><li><div>
                "testFetchApplicationsAndEntity",
              </div></li><li><div>
                 TODO BROOKLYN-272: testFetchApplicationsAndEntity is temporarily disabled; therefore removed from dependsOnMethod list
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> BROOKLYN-272: fix dependsOnMethods in ApplicationResourceTest
                </div><div><b>message:</b> BROOKLYN-272: fix dependsOnMethods in ApplicationResourceTest

This broke testDeleteApplicaiton, which had dependsOnMethods=...
that included the now-disabled testFetchApplicationsAndEntity
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Non-deterministic test failures in jenkins
                </div><div><b>description:</b> There are several non-deterministic tests that fail occasionally in the apache jenkins build. We should fix those tests: either the underlying bug if there is one, or the way to the test has been written to make it more deterministic.

Having build failures unrelated to the changes being made in a PR (and on master) is extremely disruptive for development. We must avoid that wherever possible.

I therefore suggest we disable these non-deterministic failing tests immediately, and use this jira issue to track fixing them. We can annotate the tests with
{noformat}
@Test(groups={"WIP", "Non-deterministic-failure"})
{noformat}
 to make them easy to find. (note the "Non-deterministic-failure" group is not used by any profiles, it's just there for searching purposes).

The tests I have identified from recent build failures are:

* {{BasicStartableTest.testTransitionsThroughLifecycles}} - see https://issues.apache.org/jira/browse/BROOKLYN-256

* {{AbstractGeoDnsServiceTest.testFiltersForRunningEntities}}, failing with:

{noformat}
    org.apache.brooklyn.util.exceptions.PropagatedRuntimeException: failed succeeds-eventually, 69 attempts, 30003ms elapsed: AssertionError: val={R48yHLqg=&lt;address-ignored&gt;, eBHFc4Qd=&lt;address-ignored&gt;}
            at org.apache.brooklyn.test.Asserts.fail(Asserts.java:721)
            at org.apache.brooklyn.test.Asserts.assertTrue(Asserts.java:703)
            at org.apache.brooklyn.core.entity.EntityAsserts$2.run(EntityAsserts.java:92)
            at org.apache.brooklyn.test.Asserts$RunnableAdapter.call(Asserts.java:1277)
            at org.apache.brooklyn.test.Asserts.succeedsEventually(Asserts.java:930)
            at org.apache.brooklyn.test.Asserts.succeedsEventually(Asserts.java:854)
            at org.apache.brooklyn.core.entity.EntityAsserts.assertAttributeEventually(EntityAsserts.java:89)
            at org.apache.brooklyn.core.entity.EntityAsserts.assertAttributeEventually(EntityAsserts.java:84)
            at org.apache.brooklyn.entity.dns.AbstractGeoDnsServiceTest.testFiltersForRunningEntities(AbstractGeoDnsServiceTest.java:263)
{noformat}

* {{LoadBalancingPolicyConcurrencyTest.testConcurrentlyAddContainers}}, failing with:

{noformat}
    org.apache.brooklyn.util.exceptions.PropagatedRuntimeException: failed succeeds-eventually, 29 attempts, 10002ms elapsed: AssertionError: actual=[18.0, 21.0, 19.0, 0.0, 20.0, 0.0, 20.0, 36.0, 19.0, 0.0, 19.0, 21.0, 21.0, 19.0, 21.0, 36.0, 21.0, 19.0, 18.0, 36.0]; expected=[20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0, 20.0] expected [20.0] but found [0.0]
            at org.testng.Assert.fail(Assert.java:94)
            at org.testng.Assert.failNotEquals(Assert.java:494)
            at org.testng.Assert.assertEquals(Assert.java:207)
            at org.apache.brooklyn.policy.loadbalancing.AbstractLoadBalancingPolicyTest.assertWorkrates(AbstractLoadBalancingPolicyTest.java:122)
            at org.apache.brooklyn.policy.loadbalancing.AbstractLoadBalancingPolicyTest$2.run(AbstractLoadBalancingPolicyTest.java:138)
            at org.apache.brooklyn.test.Asserts$RunnableAdapter.call(Asserts.java:1277)
            at org.apache.brooklyn.test.Asserts.succeedsEventually(Asserts.java:930)
            at org.apache.brooklyn.test.Asserts.succeedsEventually(Asserts.java:854)
            at org.apache.brooklyn.policy.loadbalancing.AbstractLoadBalancingPolicyTest.assertWorkratesEventually(AbstractLoadBalancingPolicyTest.java:136)
            at org.apache.brooklyn.policy.loadbalancing.LoadBalancingPolicyConcurrencyTest.testConcurrentlyAddContainers(LoadBalancingPolicyConcurrencyTest.java:101)
{noformat}

* {{PollerTest.testFeedContinuesWhenPollerThrows}}, failing with:

{noformat}
    testFeedContinuesWhenPollerThrows(org.apache.brooklyn.core.feed.PollerTest)  Time elapsed: 3.556 sec  &lt;&lt;&lt; FAILURE!
    org.apache.brooklyn.util.exceptions.PropagatedRuntimeException: failed succeeds-eventually, 4 attempts, 105ms elapsed: AssertionError: entity=FeedExceptionEntityImpl{id=dYG0SKbP}; attribute=Sensor: flag (java.lang.Boolean) expected [false] but found [true]
        at org.apache.brooklyn.test.Asserts.fail(Asserts.java:721)
        at org.apache.brooklyn.test.Asserts.failNotEquals(Asserts.java:114)
        at org.apache.brooklyn.test.Asserts.assertEquals(Asserts.java:436)
        at org.apache.brooklyn.core.entity.EntityAsserts.assertAttributeEquals(EntityAsserts.java:54)
        at org.apache.brooklyn.core.entity.EntityAsserts$1.run(EntityAsserts.java:70)
        at org.apache.brooklyn.test.Asserts$RunnableAdapter.call(Asserts.java:1277)
        at org.apache.brooklyn.test.Asserts.succeedsEventually(Asserts.java:930)
        at org.apache.brooklyn.test.Asserts.succeedsEventually(Asserts.java:854)
        at org.apache.brooklyn.core.entity.EntityAsserts.assertAttributeEqualsEventually(EntityAsserts.java:67)
        at org.apache.brooklyn.core.feed.PollerTest.testFeedContinuesWhenPollerThrows(PollerTest.java:65)
{noformat}
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                GitHub user aledsage opened a pull request:

    https://github.com/apache/brooklyn-server/pull/147

    BROOKLYN-272: disable failing non-deterministic tests

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/aledsage/brooklyn-server BROOKLYN-272/disable-failing-tests

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/brooklyn-server/pull/147.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #147
    
----
commit 335a197a26411ebdaa1a4ed4deba869856007f5e
Author: Aled Sage &lt;aled.sage@gmail.com&gt;
Date:   2016-05-20T11:21:25Z

    BROOKLYN-272: disable failing non-deterministic tests

----

              </div></li><li><div>
                GitHub user aledsage opened a pull request:

    https://github.com/apache/brooklyn-library/pull/39

    BROOKLYN-272: disable failing non-deterministic tests

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/aledsage/brooklyn-library BROOKLYN-272/disable-failing-tests

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/brooklyn-library/pull/39.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #39
    
----
commit 6c56ec88a993d174973c7c035125153afe0e2e77
Author: Aled Sage &lt;aled.sage@gmail.com&gt;
Date:   2016-05-20T11:22:21Z

    BROOKLYN-272: disable failing non-deterministic tests

----

              </div></li><li><div>
                Github user neykov commented on the pull request:

    https://github.com/apache/brooklyn-library/pull/39#issuecomment-220590558
  
    +1
    
    Can we include the tests failing in the windows build as well. Here are a couple of recent failures:
    
    * https://builds.apache.org/view/Brooklyn/job/brooklyn-master-windows/109
    
    ```
    testFetchApplicationsAndEntity(org.apache.brooklyn.rest.resources.ApplicationResourceTest)  Time elapsed: 0.073 sec  &lt;&lt;&lt; FAILURE!
    java.lang.AssertionError: expected [4] but found [3]
    	at org.testng.Assert.fail(Assert.java:94)
    	at org.testng.Assert.failNotEquals(Assert.java:494)
    	at org.testng.Assert.assertEquals(Assert.java:123)
    	at org.testng.Assert.assertEquals(Assert.java:370)
    	at org.testng.Assert.assertEquals(Assert.java:380)
    	at org.apache.brooklyn.rest.resources.ApplicationResourceTest.testFetchApplicationsAndEntity(ApplicationResourceTest.java:387)
    
    
    Results :
    
    Failed tests: 
      ApplicationResourceTest.testFetchApplicationsAndEntity:387 expected [4] but found [3]
    ```
    * https://builds.apache.org/view/Brooklyn/job/brooklyn-master-windows/117
    
    ```
    AssertionError: entity=FeedExceptionEntityImpl{id=dYG0SKbP}; attribute=Sensor: flag (java.lang.Boolean) expected [false] but found [true]
    	at org.apache.brooklyn.test.Asserts.fail(Asserts.java:721)
    	at org.apache.brooklyn.test.Asserts.failNotEquals(Asserts.java:114)
    	at org.apache.brooklyn.test.Asserts.assertEquals(Asserts.java:436)
    	at org.apache.brooklyn.core.entity.EntityAsserts.assertAttributeEquals(EntityAsserts.java:54)
    	at org.apache.brooklyn.core.entity.EntityAsserts$1.run(EntityAsserts.java:70)
    	at org.apache.brooklyn.test.Asserts$RunnableAdapter.call(Asserts.java:1277)
    	at org.apache.brooklyn.test.Asserts.succeedsEventually(Asserts.java:930)
    	at org.apache.brooklyn.test.Asserts.succeedsEventually(Asserts.java:854)
    	at org.apache.brooklyn.core.entity.EntityAsserts.assertAttributeEqualsEventually(EntityAsserts.java:67)
    	at org.apache.brooklyn.core.feed.PollerTest.testFeedContinuesWhenPollerThrows(PollerTest.java:65)
    
    2016-05-19 18:00:39,800 INFO  Brooklyn shutdown: stopping entities [TestEntityImpl{id=gMtZBj5M}, TestEntityImpl{id=KJ03W2e9}, BlockingEntityImpl{id=ATsLvkYo}]
    
    Results :
    
    Failed tests: 
    org.apache.brooklyn.core.feed.PollerTest.testFeedContinuesWhenPollerThrows(org.apache.brooklyn.core.feed.PollerTest)
      Run 1: PASS
      Run 2: PollerTest.testFeedContinuesWhenPollerThrows:65 Â» PropagatedRuntime failed suc...
    ```

              </div></li><li><div>
                Github user aledsage commented on the pull request:

    https://github.com/apache/brooklyn-server/pull/147#issuecomment-221220096
  
    Unfortunately have lost history of jenkins build failure, to be able to tell what went wrong. Closing and re-opening to kick off jenkins again.

              </div></li><li><div>
                Github user aledsage closed the pull request at:

    https://github.com/apache/brooklyn-server/pull/147

              </div></li><li><div>
                GitHub user aledsage reopened a pull request:

    https://github.com/apache/brooklyn-server/pull/147

    BROOKLYN-272: disable failing non-deterministic tests

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/aledsage/brooklyn-server BROOKLYN-272/disable-failing-tests

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/brooklyn-server/pull/147.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #147
    
----
commit 335a197a26411ebdaa1a4ed4deba869856007f5e
Author: Aled Sage &lt;aled.sage@gmail.com&gt;
Date:   2016-05-20T11:21:25Z

    BROOKLYN-272: disable failing non-deterministic tests

----

              </div></li><li><div>
                Github user aledsage commented on the pull request:

    https://github.com/apache/brooklyn-server/pull/147#issuecomment-221344950
  
    As discussed on mailing list, have changed this to `@Test(groups={"Broken"})`

              </div></li><li><div>
                Github user aledsage commented on the pull request:

    https://github.com/apache/brooklyn-library/pull/39#issuecomment-221346224
  
    Thanks @neykov 
    
    I've added the disabling of `ApplicationResourceTest.testFetchApplicationsAndEntity` to https://github.com/apache/brooklyn-server/pull/147. `PollerTest.testFeedContinuesWhenPollerThrows` was already disabled there.

              </div></li><li><div>
                Switched to using the "Broken" group, as that is already in use (as discussed on the mailing list).
{noformat}
@Test(groups={"Broken"})
{noformat}

Also adding {{ApplicationResourceTest.testFetchApplicationsAndEntity}}, as suggested by Svet in https://github.com/apache/brooklyn-library/pull/39. It fails with:

{noformat}
    testFetchApplicationsAndEntity(org.apache.brooklyn.rest.resources.ApplicationResourceTest)  Time elapsed: 0.073 sec  &lt;&lt;&lt; FAILURE!
    java.lang.AssertionError: expected [4] but found [3]
        at org.testng.Assert.fail(Assert.java:94)
        at org.testng.Assert.failNotEquals(Assert.java:494)
        at org.testng.Assert.assertEquals(Assert.java:123)
        at org.testng.Assert.assertEquals(Assert.java:370)
        at org.testng.Assert.assertEquals(Assert.java:380)
        at org.apache.brooklyn.rest.resources.ApplicationResourceTest.testFetchApplicationsAndEntity(ApplicationResourceTest.java:387)
{noformat}

              </div></li><li><div>
                Github user neykov commented on the pull request:

    https://github.com/apache/brooklyn-server/pull/147#issuecomment-221495392
  
    Thanks @aledsage, merging.

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/brooklyn-server/pull/147

              </div></li><li><div>
                Github user neykov commented on the pull request:

    https://github.com/apache/brooklyn-library/pull/39#issuecomment-221495680
  
    Thanks @aledsage. Could you change this one to the `Broken` group as well, then good to merge.

              </div></li><li><div>
                Disabling {{YamlTimeWeightedDeltaEnricherTest.testVariableTimeWeightedDeltaEnricher}}, which failed in brooklyn-server-master #84:

{noformat}
      testVariableTimeWeightedDeltaEnricher(org.apache.brooklyn.enricher.stock.YamlTimeWeightedDeltaEnricherTest)  Time elapsed: 0.005 sec  &lt;&lt;&lt; FAILURE!
      java.lang.AssertionError: expected [0.0] but found [null]
         at org.testng.Assert.fail(Assert.java:94)
         at org.testng.Assert.failNotEquals(Assert.java:494)
         at org.testng.Assert.assertEquals(Assert.java:123)
         at org.testng.Assert.assertEquals(Assert.java:165)
         at org.apache.brooklyn.enricher.stock.YamlTimeWeightedDeltaEnricherTest.testVariableTimeWeightedDeltaEnricher(YamlTimeWeightedDeltaEnricherTest.java:96)
{noformat}
              </div></li><li><div>
                GitHub user aledsage opened a pull request:

    https://github.com/apache/brooklyn-server/pull/156

    BROOKLYN-272: disable more failing non-deterministic tests

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/aledsage/brooklyn-server BROOKLYN-272/disable-failing-tests-more

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/brooklyn-server/pull/156.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #156
    
----
commit ddb8bf43f48e6f0bb0ce7a8d84ef6357fd21d859
Author: Aled Sage &lt;aled.sage@gmail.com&gt;
Date:   2016-05-25T08:27:50Z

    BROOKLYN-272: disable more failing non-deterministic tests

----

              </div></li><li><div>
                Github user aledsage commented on the pull request:

    https://github.com/apache/brooklyn-server/pull/156#issuecomment-221506952
  
    Only affects tests, disabling those that failed in apache jenkins. Merging now.

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/brooklyn-server/pull/156

              </div></li><li><div>
                Github user aledsage commented on the pull request:

    https://github.com/apache/brooklyn-library/pull/39#issuecomment-221515062
  
    Thanks @neykov - merging.

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/brooklyn-library/pull/39

              </div></li><li><div>
                GitHub user aledsage opened a pull request:

    https://github.com/apache/brooklyn-server/pull/158

    BROOKLYN-272: fix dependsOnMethods in ApplicationResourceTest

    This broke testDeleteApplicaiton, which had dependsOnMethods=...
    that included the now-disabled testFetchApplicationsAndEntity

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/aledsage/brooklyn-server BROOKLYN-272/fix-test-dependsOn

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/brooklyn-server/pull/158.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #158
    
----
commit e6c7cdad131a324db5dc6e905a980b35d77716bd
Author: Aled Sage &lt;aled.sage@gmail.com&gt;
Date:   2016-05-26T08:11:09Z

    BROOKLYN-272: fix dependsOnMethods in ApplicationResourceTest
    
    This broke testDeleteApplicaiton, which had dependsOnMethods=...
    that included the now-disabled testFetchApplicationsAndEntity

----

              </div></li><li><div>
                Github user sjcorbett commented on the pull request:

    https://github.com/apache/brooklyn-server/pull/158#issuecomment-221899222
  
    LGTM - failure occurred when Jenkins was cloning the project. The stability of Jenkins is a bit concerning at the moment. 
    ```
    FATAL: Error performing git command
    hudson.plugins.git.GitException: Error performing git command
    	at org.jenkinsci.plugins.gitclient.CliGitAPIImpl.launchCommandIn(CliGitAPIImpl.java:1704)
    ...
    Caused by: java.lang.OutOfMemoryError: unable to create new native thread
    	at java.lang.Thread.start0(Native Method)
    ```

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/brooklyn-server/pull/158

              </div></li><li><div>
                Also encountered a non-deterministic failure of `LoopOverGroupMembersTestCaseTest.testMultipleChildrenOneOfWhichFails` - see https://github.com/apache/brooklyn-server/pull/166 for details. I have not yet disabled that test.
              </div></li><li><div>
                GitHub user neykov opened a pull request:

    https://github.com/apache/brooklyn-server/pull/167

    [BROOKLYN-272] disable more failing non-deterministic tests

    Same problem as in https://github.com/apache/brooklyn-server/pull/147

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/neykov/brooklyn-server fix/disable-failing-test

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/brooklyn-server/pull/167.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #167
    
----
commit b49424878b17bcb18cf78d66ceb3227b306d5d9f
Author: Svetoslav Neykov &lt;svetoslav.neykov@cloudsoftcorp.com&gt;
Date:   2016-05-30T14:53:54Z

    [BROOKLYN-272] disable more failing non-deterministic tests

----

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/brooklyn-server/pull/167

              </div></li><li><div>
                Disabling {{ConfigYamlTest.testDeferredSupplierToAttributeWhenReady}} and {{ConfigYamlTest.testDeferredSupplierToAttributeWhenReadyInSpecialTypes}}.

The {{entity.config().getNonBlocking()}} can return absent. When it's called with 
a deferred supplier value, it will kick off a task and then wait just a few millis for that 
task to execute deferredSupplier.get(). If it times out, then it returns Maybe.absent. 
However, on apache jenkins the machine is often slow so the task doesn't complete in the 
given number of millis (even though deferredSupplier.get() doesn't need to block for anything).
              </div></li><li><div>
                GitHub user aledsage opened a pull request:

    https://github.com/apache/brooklyn-server/pull/251

    BROOKLYN-272: disable YamlTimeWeightedDeltaEnricherTest

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/aledsage/brooklyn-server BROOKLYN-272/disable-YamlTimeWeightedDeltaEnricherTest

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/brooklyn-server/pull/251.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #251
    
----
commit ba3241b376be69db3220147c5e370711b16be63b
Author: Aled Sage &lt;aled.sage@gmail.com&gt;
Date:   2016-07-12T13:19:59Z

    BROOKLYN-272: disable YamlTimeWeightedDeltaEnricherTest

----

              </div></li><li><div>
                Github user aledsage commented on the issue:

    https://github.com/apache/brooklyn-server/pull/251
  
    Only affects disabling of a non-deterministic test. Merging now.

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/brooklyn-server/pull/251

              </div></li><li><div>
                Many of the immediate-related timeout tests have been fixed to be deterministic and re-enabled, in https://github.com/apache/brooklyn-server/pull/565
              </div></li></ol></div></div></html>