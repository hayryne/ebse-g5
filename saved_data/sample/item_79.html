<!DOCTYPE html><html><div class="item-title">
        Item 79
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                create second core
              </div></li><li><div>
                 This test is invalid, as GET_FIELDS should not be executed in shard 2
              </div></li><li><div>
                add rid to the request so that shards see it
              </div></li><li><div>
                to see it in the response
to see it in the logs of the landing core
              </div></li><li><div>
                *
   * A counter to ensure that no RID is equal, even if they fall in the same millisecond
   
              </div></li><li><div>
                *
   * Map containing all the possible stages as key and
   * the corresponding readable purpose as value
   
              </div></li><li><div>
                *
   * Given the integer purpose of a request generates a readable value corresponding 
   * the request purposes (there can be more than one on a single request). If 
   * there is a purpose parameter present that's not known this method will 
   * return {@value #UNKNOWN_VALUE}
   * @param reqPurpose Numeric request purpose
   * @return a comma separated list of purposes or {@value #UNKNOWN_VALUE}
   
              </div></li><li><div>
                *
   * Map containing all the possible purposes codes of a request as key and
   * the corresponding readable purpose as value
   
              </div></li><li><div>
                track is not included in single node search
              </div></li><li><div>
                should not depend on other debug options
              </div></li><li><div>
                expecting the same results with debugQuery=true or debug=track
              </div></li><li><div>
                the rid must be added to be included in the shard logs
              </div></li><li><div>
                a generated request ID should be added to the request
              </div></li><li><div>
                the purpose must be added as readable param to be included in the shard logs
              </div></li><li><div>
                if the request has debugQuery=true or debug=track, the sreq should get debug=track always
              </div></li><li><div>
                The request ID is added to the debug/track section
              </div></li><li><div>
                RID must be added to the toLog, so that it's included in the main request log
              </div></li><li><div>
                *
   * Request ID parameter added to the request when using debug=track
   
              </div></li><li><div>
                *
   * Request Purpose parameter added to each internal shard request when using debug=track
   
              </div></li><li><div>
                *
   * {@link #DEBUG} value indicating an interest in debug output related to the distributed tracking
   
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> SOLR-5399: Add distributed request tracking information to DebugComponent
                </div><div><b>message:</b> SOLR-5399: Add distributed request tracking information to DebugComponent

git-svn-id: https://svn.apache.org/repos/asf/lucene/dev/branches/branch_4x@1541809 13f79535-47bb-0310-9956-ffa450edef68

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Improve DebugComponent for distributed requests
                </div><div><b>description:</b> I'm working on extending the DebugComponent for adding some useful information to be able to track distributed requests better. I'm adding two different things, first, the request can generate a "request ID" that will be printed in the logs for the main query and all the different internal requests to the different shards. This should make it easier to find the different parts of a single user request in the logs. It would also add the "purpose" of each internal request to the logs, like: RequestPurpose=GET_FIELDS,GET_DEBUG or RequestPurpose=GET_TOP_IDS. 

Also, I'm adding a "track" section to the debug info where to add information about the different phases of the distributed request (right now, I'm only including QTime, but could eventually include more information) like: 
{code:xml}
&lt;lst name="debug"&gt;
    &lt;lst name="track"&gt;
        &lt;lst name="EXECUTE_QUERY"&gt;
            &lt;str name="localhost:8985/solr"&gt;QTime: 10&lt;/str&gt;
            &lt;str name="localhost:8984/solr"&gt;QTime: 25&lt;/str&gt;
        &lt;/lst&gt;
        &lt;lst name="GET_FIELDS"&gt;
            &lt;str name="localhost:8985/solr"&gt;QTime: 1&lt;/str&gt;
        &lt;/lst&gt;
    &lt;/lst&gt;
&lt;/lst&gt;
{code}
To get this, debugQuery must be set to true, or debug must include "debug=track". This information is only added to distributed requests.  I would like to get feedback on this.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div><div><b>body:</b> Here is an raw patch with the idea. It still doesn't have any unit tests and I haven't tested it much with SolrCloud
                </div><div><b>label:</b> test
                </div></div></li><li><div>
                Added some unit tests. Also, I'm including for now the complete shard response in the track section.
              </div></li><li><div><div><b>body:</b> This looks very useful for debugging distributed requests!

A couple minor thoughts on the patch:
* It looks like there is a typo "tack" vs track, in DebugComponentTest.
* In testModifyRequestTrack() and testPrepare(), it would be nice to add a loop so a couple variations can be tested in a single test run (just less reliance on jenkins coming up with seeds that will hit possible bugs).
* The REQUEST_PURPOSE parameter name is in CamelCase, but it seems like the other request parameters are lowercase.  Maybe make it match stylistically?

+1 in general though.
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                Thanks Ryan. I added your suggestions. I changed RequestPurpose to requestPurpose, as other parameters we have. 
              </div></li><li><div>
                Commit 1541774 from [~rjernst] in branch 'dev/trunk'
[ https://svn.apache.org/r1541774 ]

SOLR-5399: Add distributed request tracking information to DebugComponent
              </div></li><li><div>
                Commit 1541809 from [~rjernst] in branch 'dev/branches/branch_4x'
[ https://svn.apache.org/r1541809 ]

SOLR-5399: Add distributed request tracking information to DebugComponent
              </div></li><li><div>
                Thanks Tom√°s!
              </div></li><li><div><div><b>body:</b> Looks like this is causing a transaction log leak on Windows.

http://jenkins.thetaphi.de/job/Lucene-Solr-4.x-Windows/3386/
http://jenkins.thetaphi.de/job/Lucene-Solr-trunk-Windows/3463/
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I think the problem is that the test tries to delete the solr home before stopping Jetty. I'm testing a fix now
              </div></li><li><div>
                Stopping Jetty before deleting the SolrHome directory fixes the problem in Windows
              </div></li><li><div>
                Commit 1542080 from [~rcmuir] in branch 'dev/trunk'
[ https://svn.apache.org/r1542080 ]

SOLR-5399: fix windows test issue
              </div></li><li><div>
                Thanks Tomas: I committed this.
              </div></li><li><div>
                Commit 1542082 from [~rcmuir] in branch 'dev/branches/branch_4x'
[ https://svn.apache.org/r1542082 ]

SOLR-5399: fix windows test issue
              </div></li></ol></div></div></html>