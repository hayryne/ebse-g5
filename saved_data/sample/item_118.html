<!DOCTYPE html><html><div class="item-title">
        Item 118
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [SPARK-23438][DSTREAMS] Fix DStreams data loss with WAL when driver crashes
                </div><div><b>message:</b> [SPARK-23438][DSTREAMS] Fix DStreams data loss with WAL when driver crashes

There is a race condition introduced in SPARK-11141 which could cause data loss.
The problem is that ReceivedBlockTracker.insertAllocatedBatch function assumes that all blocks from streamIdToUnallocatedBlockQueues allocated to the batch and clears the queue.

In this PR only the allocated blocks will be removed from the queue which will prevent data loss.

Additional unit test + manually.

Author: Gabor Somogyi &lt;gabor.g.somogyi@gmail.com&gt;

Closes #20620 from gaborgsomogyi/SPARK-23438.

(cherry picked from commit b308182f233b8840dfe0e6b5736d2f2746f40757)
Signed-off-by: Marcelo Vanzin &lt;vanzin@cloudera.com&gt;

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [SPARK-23438][DSTREAMS] Fix DStreams data loss with WAL when driver crashes
                </div><div><b>body:</b> ## What changes were proposed in this pull request?

There is a race condition introduced in SPARK-11141 which could cause data loss.
The problem is that ReceivedBlockTracker.insertAllocatedBatch function assumes that all blocks from streamIdToUnallocatedBlockQueues allocated to the batch and clears the queue.

In this PR only the allocated blocks will be removed from the queue which will prevent data loss.

## How was this patch tested?

Additional unit test + manually.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                @jose-torres @tdas @zsxwing could you take a look at this please?
              </div></li><li><div>
                ok to test
              </div></li><li><div>
                **[Test build #87489 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/87489/testReport)** for PR 20620 at commit [`152fec4`](https://github.com/apache/spark/commit/152fec431218161e538c377a6cb82753100dc70b).
 * This patch **fails Spark unit tests**.
 * This patch merges cleanly.
 * This patch adds no public classes.
              </div></li><li><div>
                **[Test build #87494 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/87494/testReport)** for PR 20620 at commit [`bd46d1c`](https://github.com/apache/spark/commit/bd46d1cb63e7a04e0236f7b1bf70b46fb55f3ea4).
 * This patch passes all tests.
 * This patch merges cleanly.
 * This patch adds no public classes.
              </div></li><li><div>
                **[Test build #87519 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/87519/testReport)** for PR 20620 at commit [`23e0204`](https://github.com/apache/spark/commit/23e020438c851502522f2328f01728e43c1fba99).
 * This patch **fails due to an unknown error code, -9**.
 * This patch merges cleanly.
 * This patch adds no public classes.
              </div></li><li><div>
                Seems like unrelated issue.
              </div></li><li><div>
                retest this please.
              </div></li><li><div>
                **[Test build #87522 has finished](https://amplab.cs.berkeley.edu/jenkins/job/SparkPullRequestBuilder/87522/testReport)** for PR 20620 at commit [`23e0204`](https://github.com/apache/spark/commit/23e020438c851502522f2328f01728e43c1fba99).
 * This patch passes all tests.
 * This patch merges cleanly.
 * This patch adds no public classes.
              </div></li><li><div>
                LGTM.
              </div></li><li><div>
                Merging to master, will try back to 2.0.
              </div></li><li><div>
                (Argh, the wifi here is horrible, I'll need to manually merge things, so hang on a sec...)
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                nit: Can we use another name (maybe `allocatedBlocksInStream`?) other than `allocatedBlocks` to avoid confusion?
              </div></li><li><div>
                Sure, fixed.
              </div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>