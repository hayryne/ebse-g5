<!DOCTYPE html><html><div class="item-title">
        Item 179
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Merge pull request #666 from Microsoft-CISL/weimer_removeConfFromJAR
                </div><div><b>message:</b> Merge pull request #666 from Microsoft-CISL/weimer_removeConfFromJAR

Merging this myself as it is really quite simple.
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div><div><b>label:</b> requirement
                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div></div></li><li><div><div><b>title:</b> [REEF-991] Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>body:</b> JIRA:
  [REEF-991](https://issues.apache.org/jira/browse/REEF-991)

Pull request:
  This closes #

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div><div><b>body:</b> I removed the deprecated `DefaultRemoteManagerImplementation` constructor, too.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I'll take a look at this.

              </div></li><li><div>
                @dafrista Can you take a look at this PR as well? Given that you filed [REEF-547](https://issues.apache.org/jira/browse/REEF-547).

              </div></li><li><div><div><b>body:</b> @dongjoon-hyun Overall this looks good to me, but I don't really like the liberal use of `bindVolatileParameter`; however, I'm not really sure if there are any better solutions at the moment.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Thank you for review, @afchung .
I update the code and rebased it.

              </div></li><li><div>
                @dafrista , could you review this?

              </div></li><li><div>
                Looks good to me. @dongjoon-hyun I'll test and merge after waiting for one more day. Thanks!

              </div></li><li><div>
                Sure, no problem. Thank you, @afchung . 

              </div></li><li><div><div><b>body:</b> Sorry, I'm late to the party.

I'm not sure about these changes. The basic pattern is to create an empty Tang injector, that creates a new instance. This gets us away from using public constructors, but it doesn't remove the underlying dependencies.

The code remains brittle. For example, let's say a constructor for the DefaultRemoteManagerImplementation is added that uses a new named parameter. If the Factory class wants to use this, an extra bindVolatileParameter has to be added anyway.

It also adds one more source of brittleness. The compiler can't check if the binded instances are enough to create an instance of DefaultRemoteManagerImplementation. Using public constructors at least allows the compiler to check if the passed in instances are the correct arguments for a constructor.

That being said, I don't have a great alternative. The best I can come up with is: make the RemoteManagerImplementation constructors package-private, and un-deprecate them. This removes exposure to clients without resorting to dynamic injection.

Thoughts?

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Thank you for a thoughtful advice, @dafrista !
Is that guideline applicable for general _Tang &amp; Factory_ patterns?
I'm just curious because we also use `bindVolatileParameter` in `CommunicationGroupDriverFactory`.

              </div></li><li><div>
                @dongjoon-hyun from what I understand, the usage in group comm is a bit problematic as well. [REEF-924](https://issues.apache.org/jira/browse/REEF-924) changed this to getting an injector injected instead. Maybe it makes sense to discuss these patterns more generally in dev@?

              </div></li><li><div>
                Oh, that would be great. Could you trigger that in @dev? 
Actually, what I hope to know is _the best practice_ for using `Factory` pattern with `Tang`.

By the way, isn't it Thanksgiving Day in USA? It might not be the best time to start discussion. Maybe, next week?

Thank you in any way, @dafrista . :)

              </div></li><li><div>
                You're right @dongjoon-hyun, thanksgiving is not ideal. Let's discuss more next week. Thanks!

              </div></li><li><div>
                Rebased.

              </div></li><li><div><div><b>body:</b> @dafrista @dongjoon-hyun An alternative is to create a ConfigurationModule class for `RemoteManager`, but I'm not sure if the complexity of `RemoteManager` is enough to justify this.
Overall though, I'm +1 for un-deprecating the constructor.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> A way we've dealt with this challenge in the past is the "Inject-a-Factory" pattern: That way, defaults for all the parameters of `DefaultRemoteManager` can be injected into the `DefaultRemoteManagerFactory`. And that factory can have methods to pass in additional parameters to overwrite those defaults.

That requires the class and its factory to be in the same package, though. And the class needs to have a package-private constructor used by the factory. And at some place, `DefaultRemoteManagerFactory` needs to be bound to the interface `RemoteManagerFactory`.

I thought RemoteManager was on the way to this design?

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Hi, all.
Sorry for late update. To trigger another round of reviews, I rebased and updated the code according to the advices. It means  **"Inject-a-Factory" pattern with a given Injector**. 

To implement `RemoteManagerFactory`,
- `DefaultRemoteManagerFactory` has a package-private constructor having all default parameters for a package-private constructor of `DefaultRemoteManagerImplementation` in the same package.
- `DefaultRemoteManagerFactory` receives `Injector` from Tang instead of creating by itself.
- In various `getInstance` functions, `DefaultRemoteManagerFactory` calls `forkInjector` and binds volatile variables.

I didn't make `ConfigurationModule` because I think the current pattern is enough. If I missed something except this, please let me know.

              </div></li><li><div>
                Thanks! I've done a pass. 

              </div></li><li><div>
                Thank you, @markusweimer . I changed the followings.
- Make `DefaultRemoteManagerFactory` class as package private class.
- Call `getInstance(TcpPortProvider.class)` instead of `getInstance(RangeTcpPortProvider.class)`.
- Make the private instance variable `injector` as a forked one in a constructor: `this.injector = injector.forkInjector();`

To use `Configuration` pattern, it seems to be necessary to use `String.valueOf` and `getClass` for all parameters of the following function in order to put them into `conf` instance and call `injector.forkInjector(conf)`. It looks like a little bit detour for this case.

```
  public &lt;T&gt; RemoteManager getInstance(final String name,
                                       final String hostAddress,
                                       final int listeningPort,
                                       final Codec&lt;T&gt; codec,
                                       final EventHandler&lt;Throwable&gt; errorHandler,
                                       final boolean orderingGuarantee,
                                       final int numberOfTries,
                                       final int retryTimeout,
                                       final LocalAddressProvider localAddressProvider,
                                       final TcpPortProvider tcpPortProvider) {
    try {
      final Injector newInjector = injector.forkInjector();
      newInjector.bindVolatileParameter(RemoteConfiguration.ManagerName.class, name);
      newInjector.bindVolatileParameter(RemoteConfiguration.HostAddress.class, hostAddress);
      newInjector.bindVolatileParameter(RemoteConfiguration.Port.class, listeningPort);
      newInjector.bindVolatileParameter(RemoteConfiguration.MessageCodec.class, codec);
      newInjector.bindVolatileParameter(RemoteConfiguration.ErrorHandler.class, errorHandler);
      newInjector.bindVolatileParameter(RemoteConfiguration.OrderingGuarantee.class, orderingGuarantee);
      newInjector.bindVolatileParameter(RemoteConfiguration.NumberOfTries.class, numberOfTries);
      newInjector.bindVolatileParameter(RemoteConfiguration.RetryTimeout.class, retryTimeout);
      newInjector.bindVolatileInstance(LocalAddressProvider.class, localAddressProvider);
      newInjector.bindVolatileInstance(TransportFactory.class, this.transportFactory);
      newInjector.bindVolatileInstance(TcpPortProvider.class, tcpPortProvider);
      return newInjector.getInstance(RemoteManager.class);
    } catch (InjectionException e) {
      throw new RuntimeException(e);
    }
  }
```

              </div></li><li><div>
                Agreed, for the case where instances are provided, `bindViolatile` is the right approach. Having such a method that completely sidesteps Tang is concerning, but let's leave that to future work. I will test and merge this.

              </div></li><li><div>
                Thank you, @markusweimer !

              </div></li><li><div>
                It looks like @markusweimer provided an "Inject-a-Factory" pattern that works for these situations. Thanks @markusweimer and @dongjoon-hyun !

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div><div><b>body:</b> In order to completely eliminate the `RangeTcpPortProvider.Default`, wouldn't we want to remove this constructor? That way, it has always to be injected.

@bgchun What's the long-term thinking on this?

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Thank you, @markusweimer . By the way, do you mean to include the deletion of the deprecated `DefaultRemoteManagerImplementation` constructors?

              </div></li><li><div><div><b>body:</b> Remove `TODO`.

                </div><div><b>label:</b> requirement
                </div></div></li><li><div>
                For these interfaces, I don't believe we need `NamedParameter` if their default class is not different from the annotation in their respective `.java` files.

              </div></li><li><div>
                Does `getInstance` with `TcpPortProvider` work?

              </div></li><li><div>
                Somewhat tangent to this PR, but this Factory class actually seems a bit suspect... It exposes parameters for us to inject at its creation, yet allows us to override those parameters explicitly when we call `getInstance()`. From my searches, it seems like two `getInstance()` methods are only used in tests, one method only used in the Mesos runtime, and one method not used at all. @dongjoon-hyun what are your opinions here?

              </div></li><li><div>
                Oh, thanks.

              </div></li><li><div>
                I'll change them.

              </div></li><li><div>
                I'll remove them and use bindVolitileInstance instead.

              </div></li><li><div><div><b>body:</b> I thought they are legacy. In long term plan, all `getInstance()` might be replaced.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> Have you considered creating a `Configuration` with the bindings and passing that into the `forkInjector()` call instead of using `bindVolatile`? That is somewhat safer.

Also, bindings to things injected into this `DefaultRemoteManagerFactory` should already be in the forked injector. I don't think you need to `bindVolatile` them. In fact, I am pretty sure those calls should throw exceptions.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> We should now be able to make this package private, as other code should be coded against `RemoteManagerFactory` anyhow, right?

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Can we avoid this and instead have a version of `TcpPortProvider` injected?

              </div></li><li><div>
                Right. I'll change that package private.

              </div></li><li><div>
                Oh, sure. I changed.

              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Remove deprecated RangeTcpPortProvider.Default and DefaultRemoteManagerImplementation constructor
                </div><div><b>description:</b> This issue resolves the followings:
* `RangeTcpPortProvider.Default` and its usage
* `DefaultRemoteManagerImplementation` constructor and its usage
* Make DefaultRemoteManagerImplementation class as `final`
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Add a link to PR.
              </div></li><li><div>
                Closed via [#666|https://github.com/apache/reef/pull/666]
              </div></li></ol></div></div></html>