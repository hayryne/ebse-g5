<!DOCTYPE html><html><div class="item-title">
        Item 55
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
   * Create a new AutomatonQuery from an {@link Automaton}.
   * 
   * @param term Term containing field and possibly some pattern structure. The
   *        term text is ignored.
   * @param automaton Automaton to run, terms that are accepted are considered a
   *        match.
   * @param maxDeterminizedStates maximum number of states in the resulting
   *   automata.  If the automata would need more than this many states
   *   TooComplextToDeterminizeException is thrown.  Higher number require more
   *   space but can process more complex automata.
   * @param isBinary if true, this automaton is already binary and
   *   will not go through the UTF32ToUTF8 conversion
   
              </div></li><li><div>
                * Build an automaton accepting all terms with the specified prefix. 
              </div></li><li><div>
                 It's OK to pass unlimited maxDeterminizedStates: the automaton is born small and determinized:
              </div></li><li><div>
                 super.equals() ensures we are the same class
              </div></li><li><div>
                * Just converts each int in the incoming {@link IntsRef} to each byte
   *  in the returned {@link BytesRef}, throwing {@code IllegalArgumentException}
   *  if any int value is out of bounds for a byte. 
              </div></li><li><div>
                 Incoming automaton is unicode, and we must convert to UTF8 to match what's in the index:
              </div></li><li><div>
                 Caller already built binary automaton themselves, e.g. PrefixQuery
 does this since it can be provided with a binary (not necessarily
 UTF8!) term:
              </div></li><li><div>
                 This will determinize the binary automaton for us:
              </div></li><li><div>
                *
   * Returns true if the given automaton accepts all strings for the specified min/max
   * range of the alphabet.  The automaton must be minimized.
   
              </div></li><li><div>
                 Automaton accepts more than one string:
              </div></li><li><div>
                * If this automaton accepts a single input, return it.  Else, return null.
   *  The automaton must be deterministic. 
              </div></li><li><div>
                 Necessary so our custom tokenStream is used by Field.tokenStream:
              </div></li><li><div>
                * Basically a StringField that accepts binary term. 
              </div></li><li><div>
                 no-op: the bytes was already filled by our owner's incrementToken
              </div></li><li><div>
                 LUCENE-6367
              </div></li><li><div>
                 This is just ascii so we can pretend it's binary:
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> LUCENE-6367: PrefixQuery now subclasses AutomatonQuery
                </div><div><b>message:</b> LUCENE-6367: PrefixQuery now subclasses AutomatonQuery

git-svn-id: https://svn.apache.org/repos/asf/lucene/dev/trunk@1669522 13f79535-47bb-0310-9956-ffa450edef68

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Can PrefixQuery subclass AutomatonQuery?
                </div><div><b>description:</b> Spinoff/blocker for LUCENE-5879.

It seems like PrefixQuery should "simply" be an AutomatonQuery rather than specializing its own TermsEnum ... with maybe some performance improvements to ByteRunAutomaton.run to short-circuit once it's in a "sink state", AutomatonTermsEnum could be just as fast as PrefixTermsEnum.

If we can do this it will make LUCENE-5879 simpler.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Patch, cutting over PrefixQuery to AutomatonQuery and removing
PrefixTermsEnum.

I explored the optimization of having Byte/CharRunAutomaton.run
optimize (short-circuit) when you're in a sink state but it became
quite difficult/invasive fixing all callers of .step to handle this.
With LUCENE-5879 we also need to know the sink state under-the-hood,
but that's separate from fixing .run to make use of it.

So I backed out that opto and tried just doing the PrefixQuery cutover
without optimizing for sink states.  I'm running a perf test w/
luceneutil and it looks like the impact is trivial (well within
noise).  Net/net I think it's fine to "just cutover" without the
invasive opto?

I also changed PrefixQuery's semantics to apply to full binary space
terms, not just UTF-8 space.  While this is technically a change in
behavior, it won't impact users who index only unicode terms.  It's
also necessary for LUCENE-5879, because if prefixing is done only in
unicode space (like today), then the resulting binary space automaton
will not have a sink state and auto-prefix can't apply.

If this part is somehow controversial I can revert and try to do it
only with LUCENE-5879 instead... if it's OK, I'll add some tests
showing that PrefixQuery on binary terms works.

              </div></li><li><div>
                i think the boolean is fine. For the other subclasses, they are taking "patterns" and inspecting characters for that reason, so thats different.
              </div></li><li><div><div><b>body:</b> New patch, adding tests for binary terms to PrefixQuery.

I also added a new Operations.getSingleton, to work for both unicode
and binary automata, and fixed CompiledAutomaton to use that when it's
trying to "simplify" the incoming automaton.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Commit 1669522 from [~mikemccand] in branch 'dev/trunk'
[ https://svn.apache.org/r1669522 ]

LUCENE-6367: PrefixQuery now subclasses AutomatonQuery
              </div></li><li><div>
                Commit 1669526 from [~mikemccand] in branch 'dev/branches/branch_5x'
[ https://svn.apache.org/r1669526 ]

LUCENE-6367: PrefixQuery now subclasses AutomatonQuery
              </div></li><li><div>
                Commit 1669577 from [~mikemccand] in branch 'dev/trunk'
[ https://svn.apache.org/r1669577 ]

LUCENE-6367: correct CHANGES entry: PrefixQuery already operated in binary term space
              </div></li><li><div>
                Commit 1669578 from [~mikemccand] in branch 'dev/branches/branch_5x'
[ https://svn.apache.org/r1669578 ]

LUCENE-6367: correct CHANGES entry: PrefixQuery already operated in binary term space
              </div></li><li><div>
                Bulk close after 5.1 release
              </div></li></ol></div></div></html>