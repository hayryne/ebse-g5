<!DOCTYPE html><html><div class="item-title">
        Item 320
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 screen out comments
              </div></li><li><div>
                 analyze code references
              </div></li><li><div>
                 replaces any text of the form "&lt;stuff&gt;"
              </div></li><li><div>
                 in C comment, look for '*'
              </div></li><li><div>
                 parse the SqlciErrors.txt file
              </div></li><li><div>
                print "Before&lt;: " + line
print "After&lt;: " + result
              </div></li><li><div>
                 these tests shouldn't be necessary but do make the following code safe
              </div></li><li><div>
                 check that $MY_SQROOT is set
              </div></li><li><div>
                 remove directory part of the name
              </div></li><li><div>
                 remove file name part and colon
 don't screen out comments
              </div></li><li><div>
                 requires Python 2.7
              </div></li><li><div>
                 print "analyzeTestReferences called for directory " + directory
              </div></li><li><div>
                 look for next heading
              </div></li><li><div>
                 analyze test references
              </div></li><li><div>
                
 We are looking for a particular enum. The format we expect
 is like this:

 enum &lt;enumname&gt; { &lt;symbol&gt; = &lt;value&gt;,
                   &lt;symbol&gt; = &lt;value&gt;,
                   ...
                   &lt;symbol&gt; = &lt;value&gt; } ;

 Of course this can freely flow across lines and there may be
 C or C++ comments to navigate past. So, we essentially have
 to tokenize and use a state machine to parse.
              </div></li><li><div>
                 break a line of text into a list of C-like tokens (not 
 precise, just good enough for our purposes)
              </div></li><li><div>
                 ignore enums for 0
              </div></li><li><div>
                 compare Messages Guide and code text
              </div></li><li><div>
                 remove directory part of the name and trailing '\n'
              </div></li><li><div>
                 look for first backticks
              </div></li><li><div>
                 parse the Messages Guide files
              </div></li><li><div>
                 continue capturing text until backticks
              </div></li><li><div>
                 we reached the end of the dollar text                  
              </div></li><li><div>
                 print "compareText called"
              </div></li><li><div>
                 remove any C or C++ comments from the line, returning the line
 (not precise; we don't check for C strings for example)
              </div></li><li><div>
                 seen '/'
              </div></li><li><div>
                 Iterating through a Python dictionary gets keys out in hash order
 which isn't useful to humans. This helper function gets the keys,
 and places them in a list in numeric order
              </div></li><li><div>
                 do the last one (if there was one)
              </div></li><li><div>
                
 Message entries look like this:

 [[SQL-1002]]
 == SQL 1002

 ```
 Catalog &lt;catalog&gt; does not exist.
 ```

 Where &lt;catalog&gt; is the ANSI name of the target catalog.

 *Cause:* The catalog does not exist.

 *Effect:* The operation fails.

 *Recovery:* Enter a valid catalog name and resubmit.

 The stuff we are interested in is the message number and
 the message text. We use a tiny state machine to figure
 out what lines to look for.
              </div></li><li><div>
                 we reached the end of the dollar text
              </div></li><li><div><div><b>comment:</b>  The script does the following:

 1. Parses the Messages Guide chapters into a table containing message number
 + message text.
 2. Parses the bin/SqlciErrors.txt file into a table containing message number
 + message text. Merges that into the table from item 1.
 3. Parses the various *.h files with error message enums. Merges that 
 information into the table from item 1.
 4. Compares the message texts in items 1 and 2. The comparison has to be
 smart; parameters appear as angle-bracketed items in the Messages Guide but
 contain $0-String0 notation in the SqlciErrors.txt text. When there are
 mismatches, this is noted. If one or the other text is missing, this notation
 is marked "false".
 5. Searches the sql *.cpp files for references to the error message number
 and/or enum, and when found, maintains a list for each, merged into the
 table from item 1. We only do this for mismatched messages as it takes a
 lot of time.
 6. Searches the regression tests LOG* files for examples of each message
 number, and when found, maintains a list for each, attached to the table
 constructed in 1. We only do this for mismatched messages as it takes a
 lot of time.
 7. Lists error messages that mismatch between Messages Guide and
 SqlciErrors.txt.
 8. Lists error messages that are missing from the Messages Guide but present
 in SqlciErrors.txt. Mentions whether these are actually used anywhere (in
 *.cpp files or regression tests).
 9. Lists error messages that are present in the Messages Guide or
 SqlciErrors.txt but apparently are no longer used (that is, don't appear in
 *.cpp files or regression tests).

 The table resulting from items 1 through 6 has the following shape:
 a. Message number (key)
 b. Messages Guide text (if any)
 c. SqlciErrors.txt message text (if any)
 d. Enum (if any)
 e. Enum *.h file name (if any)
 f. List of *.cpp files with references to message number
 g. List of *.cpp files with references to enum name
 h. List of regression tests with messages number examples
 i. Boolean indicating whether SqlciErrors.txt text matches Messages Guide

 Item 1 is implemented by a function that parses a single *.adoc file
 producing table entries. It is driven by a loop over the set of *.adoc file
 names. The function updates the table directly.
 Item 2 is implemented by a function that parses a *.txt file, driven by a
 caller supplying the bin/SqlciErrors.txt name. The function updates the table
 directly.
 Item 3 is implemented by a function that parses a *.h file looking for error
 message enums. It is driven by a loop over a hard-coded set of known *.h
 files, perhaps with the name of the enum passed in. The function updates the
 table directly.
 Item 4 is implemented by a function that does a grep of the *.cpp files, then
 processes the results. The function updates the table directly.
 Item 5 is implemented by a function that does a grep of the LOG* files, then
 processes the results. The function updates the table directly.
 Item 6 is implemented by a function that crawls the table, comparing the
 retrieved texts. The function updates the table directly.
 Items 7, 8, 9 are implemented by a function that reads the table and reports
 results.

 We model the table as a Python object and implement these functions as
 methods on that object.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 if we reached the end of the line after a '&lt;', put the
 throwaway text back in
              </div></li><li><div>
                 parse the enum files
              </div></li><li><div>
                 ignore rest of file
              </div></li><li><div><div><b>comment:</b>  TODO: remove this testing line
 for key in self.dict:
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 false alarm
              </div></li><li><div>
                 ignore rest of file
 probably a comma
              </div></li><li><div>
                 in C comment, look for '/' ending comment
              </div></li><li><div>
                 exits and prints help if args are incorrect
              </div></li><li><div>
                 report results
              </div></li><li><div>
                 in C++ comment, ignore rest of line
              </div></li><li><div>
                 removes text of the form $0~Datatype0 (where Datatype might
 be String, Int, TableName etc.)
              </div></li><li><div><div><b>comment:</b>  get rid of trailing return character
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 must exist only in an enum
              </div></li><li><div><div><b>comment:</b>  filter out "unused" messages
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 The structure of self.dict is a dictionary of dictionaries.
 The key to the top level dictionary is the message number.
 The value in each top level dictionary is essentially a
 relation, modeled by a Python dictionary. The key in this
 value is the attribute name, as follows:

 'messageGuideText'
 'errorMessageFileText'
 'enumSymbol'
 'enumFile'
 'listOfCodeReferences'
 'listOfEnumSymbolReferences'
 'listOfTestReferences'
 'textsMatch'
              </div></li><li><div>
                 so we don't glue two tokens together
              </div></li><li><div>
                 start capturing text
              </div></li><li><div>
                 if we reached the end of the line then put the throwaway text
 back in
              </div></li><li><div>
                 process command line arguments
              </div></li><li><div>
                 beginning of main
              </div></li><li><div>
                 @@@ START COPYRIGHT @@@

 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.

 @@@ END COPYRIGHT @@@

  This script checks the consistency of the Messages Guide
  against the code. It looks for messages whose text differs
  between the Messages Guide and code. It looks for messages
  that are no longer in use. It looks for messages that are
  in use but not in the Messages Guide. It produces a report
  of these.

  The report includes detailed information for each message
  that differs between the Messages Guide and code. It lists
  the enum used for the message if there is one. It lists
  the code modules that may have a reference to the message
  (it uses grep to determine this, so there may be false
  positives or more rarely false negatives). It lists the
  regression test expected files that contain examples of the
  error message.

              </div></li><li><div>
                print "Before$: " + line
print "After$: " + result
              </div></li><li><div>
                 remove C, C++ comments
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [TRAFODION-2380] New script to help automate Message Guide updating work
                </div><div><b>message:</b> [TRAFODION-2380] New script to help automate Message Guide updating work

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Create script to automate Messages Guide consistency checking
                </div><div><b>description:</b> Create a tool to automate consistency checking of the Messages Guide against the code base. This will be a simple Python script that a developer can run in their workspace. The result is a report detailing the following:

1. Messages where the text in the Messages Guide differs from the code.
2. Messages in the Message Guide that are no longer used in the code.
3. Messages in the code that are not documented in the Messages Guide.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                GitHub user DaveBirdsall opened a pull request:

    https://github.com/apache/incubator-trafodion/pull/866

    [TRAFODION-2380] New script to help automate Message Guide updating work

    This new script is designed to help automate development work on the Messages Guide. In its initial guise, the script does the following:
    
    1. Compares the text in SqlciErrors.txt with that in the Messages Guide
    2. Produces a report of mismatched messages. For each mismatched message it shows:
    a. The message text in each of SqlciErrors.txt and the Messages Guide
    b. Any enums used in the code to refer to the message number
    c. A list of regress tests whose expected files might have examples of the message
    d. Optionally, a list of all C++ source files with possible references to the message number (this option is very slow unfortunately)
    
    With this information a developer can quickly identify what messages in the Message Guide are out-of-date or missing. If the developer decides to change the text in SqlciErrors.txt, he/she can also see what regression test expected files need to be updated. If option d is specified (--codeRefs), the developer will also have a list of files in the code where the message is generated. But this option presently takes six or seven hours to run and so is best done overnight.

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/DaveBirdsall/incubator-trafodion Trafodion2380

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/incubator-trafodion/pull/866.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #866
    
----

----

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/incubator-trafodion/pull/866

              </div></li><li><div>
                Closing old tickets (bulk process in JIRA).
              </div></li></ol></div></div></html>