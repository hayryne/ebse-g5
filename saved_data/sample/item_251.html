<!DOCTYPE html><html><div class="item-title">
        Item 251
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HIVE-17237: HMS wastes 26.4% of memory due to dup strings in metastore.api.Partition.parameters (Misha Dmitriev, reviewed by Sahil Takiar)
                </div><div><b>message:</b> HIVE-17237: HMS wastes 26.4% of memory due to dup strings in metastore.api.Partition.parameters (Misha Dmitriev, reviewed by Sahil Takiar)

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> HMS wastes 26.4% of memory due to dup strings in metastore.api.Partition.parameters
                </div><div><b>description:</b> I've analyzed a heap dump from a production Hive installation using jxray (www.jxray.com) It turns out that there are a lot of duplicate strings in memory, that waste 26.4% of the heap. Most of them come from HashMaps referenced by org.apache.hadoop.hive.metastore.api.Partition.parameters. Below is the relevant section of the jxray report.

Looking at Partition.java, I see that in the past somebody has already added code to intern keys and values in the parameters table when it's first set up. However, when more key-value pairs are added, they are not interned, and that probably explains the reason for all these duplicate strings. Also when a Partition instance is deserialized, no interning of parameters is currently done.

{code}
6. DUPLICATE STRINGS

Total strings: 3,273,557  Unique strings: 460,390  Duplicate values: 110,232  Overhead: 3,220,458K (26.4%)
....

===================================================

7. REFERENCE CHAINS FOR DUPLICATE STRINGS

  2,326,150K (19.1%), 597058 dup strings (36386 unique), 597058 dup backing arrays:
39949 of "-1", 39088 of "true", 28959 of "8", 20987 of "1", 18437 of "10", 9583 of "9", 5908 of "269664", 5691 of "174528", 4598 of "133980", 4598 of "BgUGBQgFCAYFCgYIBgUEBgQHBgUGCwYGBwYHBgkKBwYGBggIBwUHBgYGCgUJCQUG ...[length 3560]"
... and 419200 more strings, of which 36376 are unique
Also contains one-char strings: 217 of "6", 147 of "7", 91 of "4", 28 of "5", 28 of "2", 21 of "0"
     &lt;--  {j.u.HashMap}.values &lt;-- org.apache.hadoop.hive.metastore.api.Partition.parameters &lt;--  {j.u.ArrayList} &lt;-- org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$get_partitions_result.success &lt;-- Java Local (org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$get_partitions_result) [@6e33618d8,@6eedb9a80,@6eedbad68,@6eedbc788] ... and 3 more GC roots
  463,060K (3.8%), 119644 dup strings (34075 unique), 119644 dup backing arrays:
7914 of "true", 7912 of "-1", 6578 of "8", 5606 of "1", 2302 of "10", 1626 of "174528", 1223 of "9", 970 of "171680", 837 of "269664", 657 of "133980"
... and 84009 more strings, of which 34065 are unique
Also contains one-char strings: 42 of "7", 31 of "6", 20 of "4", 8 of "5", 5 of "2", 3 of "0"
     &lt;--  {j.u.HashMap}.values &lt;-- org.apache.hadoop.hive.metastore.api.Partition.parameters &lt;--  {j.u.TreeMap}.values &lt;-- Java Local (j.u.TreeMap) [@6f084afa0,@73aac9e68]
  233,384K (1.9%), 64601 dup strings (27295 unique), 64601 dup backing arrays:
4472 of "true", 4173 of "-1", 3798 of "1", 3591 of "8", 813 of "174528", 684 of "10" ... and 44568 more strings, of which 27285 are unique
Also contains one-char strings: 305 of "7", 301 of "0", 277 of "4", 146 of "6", 29 of "2", 23 of "5", 19 of "9", 2 of "3"
     &lt;--  {j.u.HashMap}.values &lt;-- org.apache.hadoop.hive.metastore.api.Partition.parameters &lt;--  {j.u.ArrayList} &lt;-- Java Local (j.u.ArrayList) [@4f4cfbd10,@536122408,@726616778]
...
  52,916K (0.4%), 597058 dup strings (16 unique), 597058 dup backing arrays:
     &lt;--  {j.u.HashMap}.keys &lt;-- org.apache.hadoop.hive.metastore.api.Partition.parameters &lt;--  {j.u.ArrayList} &lt;-- org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$get_partitions_result.success &lt;-- Java Local (org.apache.hadoop.hive.metastore.api.ThriftHiveMetastore$get_partitions_result) [@6e33618d8,@6eedb9a80,@6eedbad68,@6eedbc788] ... and 3 more GC roots
{code}
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12880139/HIVE-17237.01.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 11 failed/errored test(s), 11138 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[create_merge_compressed] (batchId=241)
org.apache.hadoop.hive.cli.TestBeeLineDriver.testCliDriver[materialized_view_create_rewrite] (batchId=241)
org.apache.hadoop.hive.cli.TestCliDriver.testCliDriver[llap_uncompressed] (batchId=56)
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_vectorized_dynamic_partition_pruning] (batchId=168)
org.apache.hadoop.hive.cli.TestMiniTezCliDriver.testCliDriver[explainuser_3] (batchId=99)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=236)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query23] (batchId=236)
org.apache.hive.beeline.TestBeeLineWithArgs.testQueryProgress (batchId=223)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=179)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=179)
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=179)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6238/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6238/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6238/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 11 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12880139 - PreCommit-HIVE-Build
              </div></li><li><div>
                Why replace the use of {{Interners.newWeakInterner}} with {{String#intern()}}?
              </div></li><li><div><div><b>body:</b> This is to save memory and improve performance. String.intern() has always been an "official" solution to the string duplication problem. However, until JDK 7 it was not very scalable. This forced people to start using their own interners based on WeakHashMap or ConcurrentHashMap. But, as we know, these data structures are not economical at all in terms of memory - there is an overhead of 32 bytes or more per an interned string. Starting from JDK 7, Sun/Oracle finally paid attention and made several improvements to String.intern(), that greatly improved its performance. The internal hashtable used by String.intern() is also much more economical in terms of memory, and preallocated. So since JDK 7, it became counterproductive to use custom string interners. 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                +1
              </div></li><li><div>
                [~misha@cloudera.com] this need to be rebased. HIVE-17170 moved the location of all the Thrift generated files.
              </div></li><li><div>
                Just rebased the change and submitted the new patch.
              </div></li><li><div>
                

Here are the results of testing the latest attachment:
https://issues.apache.org/jira/secure/attachment/12882955/HIVE-17237.02.patch

{color:red}ERROR:{color} -1 due to no test(s) being added or modified.

{color:red}ERROR:{color} -1 due to 7 failed/errored test(s), 10994 tests executed
*Failed tests:*
{noformat}
org.apache.hadoop.hive.cli.TestMiniSparkOnYarnCliDriver.testCliDriver[spark_vectorized_dynamic_partition_pruning] (batchId=169)
org.apache.hadoop.hive.cli.TestPerfCliDriver.testCliDriver[query14] (batchId=235)
org.apache.hadoop.hive.common.TestFileUtils.testCopyWithDistCpAs (batchId=250)
org.apache.hadoop.hive.common.TestFileUtils.testCopyWithDistcp (batchId=250)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionRegistrationWithCustomSchema (batchId=180)
org.apache.hive.hcatalog.api.TestHCatClient.testPartitionSpecRegistrationWithCustomSchema (batchId=180)
org.apache.hive.hcatalog.api.TestHCatClient.testTableSchemaPropagation (batchId=180)
{noformat}

Test results: https://builds.apache.org/job/PreCommit-HIVE-Build/6477/testReport
Console output: https://builds.apache.org/job/PreCommit-HIVE-Build/6477/console
Test logs: http://104.198.109.242/logs/PreCommit-HIVE-Build-6477/

Messages:
{noformat}
Executing org.apache.hive.ptest.execution.TestCheckPhase
Executing org.apache.hive.ptest.execution.PrepPhase
Executing org.apache.hive.ptest.execution.ExecutionPhase
Executing org.apache.hive.ptest.execution.ReportingPhase
Tests exited with: TestsFailedException: 7 tests failed
{noformat}

This message is automatically generated.

ATTACHMENT ID: 12882955 - PreCommit-HIVE-Build
              </div></li><li><div>
                Thanks for the contribution [~misha@cloudera.com]. Merged to master.
              </div></li><li><div>
                Hive 3.0.0 has been released so closing this jira.
              </div></li></ol></div></div></html>