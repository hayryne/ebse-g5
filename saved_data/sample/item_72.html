<!DOCTYPE html><html><div class="item-title">
        Item 72
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
   * Reflection-based checker that exceptions thrown by JDBC interfaces'
   * implementation methods for unsupported-operation cases are SQLExceptions
   * (not UnsupportedOperationExceptions).
   *
   * @param  &lt;INTF&gt;  JDBC interface type
   
              </div></li><li><div>
                 class NoNonSqlExceptionsChecker&lt;INTF&gt;
              </div></li><li><div>
                *
     * Gets minimal value suitable for use as actual parameter value for given
     * formal parameter type.
     
              </div></li><li><div>
                 See if method throws exception:
              </div></li><li><div>
                 Uncomment to suppress calling DatabaseMetaData.getColumns(...), which
           sometimes takes about 2 minutes, and other DatabaseMetaData methods
           that query, collectively taking a while too:
        else if (DatabaseMetaData.class == jdbcIntf
                 &amp;&amp; "getColumns".equals(method.getName())) {
          logger.debug("Skipping (because really slow): " + methodLabel);
        }
        else if (DatabaseMetaData.class == jdbcIntf
                 &amp;&amp; ResultSet.class == method.getReturnType()) {
          logger.debug("Skipping (because a bit slow): " + methodLabel);
        }
        
              </div></li><li><div>
                 class PlainStatementChecker
              </div></li><li><div>
                 No CallableStatement.
              </div></li><li><div>
                *
     * Assembles (minimal) arguments array for given method.
     
              </div></li><li><div>
                 Not executed; for "final".
              </div></li><li><div>
                 If here, method didn't throw--check if it's an expected non-throwing
 method (e.g., an isClosed).  (If not, report error.)
              </div></li><li><div>
                *
 * Test that non-SQLException exceptions used by Drill's current version of
 * Avatica to indicate unsupported features are wrapped in or mapped to
 * SQLException exceptions.
 *
 * &lt;p&gt;
 *   As of 2015-08-24, Drill's version of Avatica used non-SQLException exception
 *   class to report that methods/features were not implemented.
 * &lt;/p&gt;
 * &lt;pre&gt;
 *   5 UnsupportedOperationException in ArrayImpl
 *  29 UnsupportedOperationException in AvaticaConnection
 *  10 Helper.todo() (RuntimeException) in AvaticaDatabaseMetaData
 *  21 UnsupportedOperationException in AvaticaStatement
 *   4 UnsupportedOperationException in AvaticaPreparedStatement
 * 103 UnsupportedOperationException in AvaticaResultSet
 * &lt;/pre&gt;
 
              </div></li><li><div>
                *
     * Hook/factory method to allow context to provide fresh object for each
     * method.  Needed for Statement and PrepareStatement, whose execute...
     * methods can close the statement (at least given our minimal dummy
     * argument values).
     
              </div></li><li><div>
                *
     * Assembles method signature text for given method.
     
              </div></li><li><div>
                 Self-check that member variables are set:
              </div></li><li><div>
                 ms 
              </div></li><li><div>
                *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                 Expected.
              </div></li><li><div>
                 (Note: Can't use JdbcTest's connect(...) for this test class.)
              </div></li><li><div>
                 (No ResultSetMetaData.isClosed() or DatabaseMetaData.isClosed():)
              </div></li><li><div>
                 Known good-enough case--these methods throw NullPointerException
 because of the way we call them (with null) and the way Avatica
 code implements them.
              </div></li><li><div>
                 Good case--almost any exception should be SQLException or subclass
 (but make sure not accidentally closed).
              </div></li><li><div>
                *
     * Tests one method.
     * (Disturbs members set by makeArgsAndLabel, but those shouldn't be used
     * except by this method.)
     
              </div></li><li><div>
                * "None" value for rowLastColumnOffset. 
              </div></li><li><div>
                *
   * Resets last-column-referenced information for {@link #wasNull}.
   * Must be called whenever row is advanced (when {@link ResultSet#next()}
   * is called).
   
              </div></li><li><div>
                 Update lastColumnIndexedInRow after indexing accessors to not touch
 lastColumnIndexedInRow in case of out-of-bounds exception.
              </div></li><li><div>
                *
   * @param  accessorOffset  0-based index of accessor array (not 1-based SQL
   *           column index/ordinal value)
   
              </div></li><li><div>
                 (Not -1, since -1 can result from 0 (bad 1-based index) minus 1 (offset
 from 1-based to 0-based indexing.)
              </div></li><li><div>
                * Zero-based offset of last column referenced in current row.
   *  For {@link #wasNull()}. 
              </div></li><li><div>
                 TODO(DRILL-xxxx):  Eliminate this test-specific hack from production code.
 If we're not going to have tests themselves explicitly handle making names
 unique, then at least move this logic into a test base class, and have it
 go through DrillConnection.getClient().
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> DRILL-2769: Fix most non-SQLException not-supported-yet exceptions.
                </div><div><b>message:</b> DRILL-2769: Fix most non-SQLException not-supported-yet exceptions.

Core:

Added (auto-scanning) unit test. [Drill2769UnsupportedReportsUseSqlExceptionTest]

Added translation of lots of UnsupportedOperationExceptions (and some
RuntimeExceptions) from Avatica code to SQLFeatureNotSupportedExceptions (tons
of method overrides).

Also:

Added explicit bounds checks in ResultSetMetaData methods and checking of
last-accessed column in DrillAccessorList.wasNull() (to fix other
RuntimeExceptions to SQLExceptions).

Added resetting of last-accessed column to fix latent bug in DrillAccessorList.

Hygiene:
- Renamed some zero-based index/ordinal-position parameters to "...Offset".
- Renamed some one-based index/ordinal-position parameters to "...Number".
- Renamed DrillAccessorList lastColumn to rowLastColumnOffset; declared
  explicit logical null value for rowLastColumnOffset.

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> many(?) JDBC methods throw non-SQLException exceptions (e.g., UnsupportedOperationException, RuntimeException)
                </div><div><b>description:</b> It seems that many JDBC methods throw exceptions of type {{UnsupportedOperationException}} or {{RuntimeException}} to indicate that they are not applicable (e.g., Drill's implementation of {{Connection.commit()}}, since Drill isn't transactional) or not implemented yet (and some throw other {{RuntimeException}}s to indicate other problems ).

However, these methods should be throwing exceptions of type {{SQLException}} (or subclasses thereof). 

The JDBC pattern is to throw {{SQLException}}s, not {{RuntimeException}}s, so JDBC client code is not likely to handle {{RuntimeException}}s well.

(For example, it is suspected that {{Connection.commit()}}'s throwing of {{UnsupportedOperationException}} is causing a hang in the JDBC client Spotfire.)


JDBC does provide a {{SQLFeatureNotSupportedException}}.  However, it is specified to be for when "the JDBC driver does does not support an optional JDBC feature."  It's not clear how risky it would be to use this exception when Drill does not support a _non_-optional JDBC feature. 


(Possibly, some methods that can't really do what JDBC specifies might need to just return silently without throwing any exception.)


                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Some Connection method cases: 
- isValid
- abort
- getClientInfo, setClientInfo
- commit, rollback; setSavepoint, releaseSavepoint
- prepareStatement, prepareCall
- getTypeMap,  setTypeMap
- nativeSql 
- createArrayOf, createBlob, createClob, createNClob, createSQLXML, createStruct

              </div></li><li><div>
                Note:  Reportedly, newer versions of the Avatica framework now use a SQLException rather than UnsupportedOperationException.
              </div></li><li><div>
                Notes on UnsupportedOperationExceptions (and related RuntimeExceptions) in current Avatica classes:
- 5 UnsupportedOperationException in ArrayImpl
- 29 UnsupportedOperationException  in AvaticaConnection
- 10 Helper.todo() (RuntimeException) in AvaticaDatabaseMetaData
- 21 UnsupportedOperationException  in AvaticaStatement
-  4 UnsupportedOperationException  in AvaticaPreparedStatement
- 103 UnsupportedOperationException  in AvaticaResultSet

(no UnsupportedOperationException or Helper.todo() in:  AvaticaFactory, AvaticaJdbc40Factory,  AvaticaJdbc41Factory, AvaticaParameter, AvaticaPrepareResult, AvaticaResultSetMetaData, BuiltInConnectionProperty, ByteString, Casing, ColumnMetaData, ConnectionConfig, ConnectionConfigImpl, ConnectionProperty, ConnectStringParser, Cursor, DriverVersion, Handler, HandlerImpl, Helper, InternalProperty, Meta, Quoting, UnregisteredDriver)

A few of the "throw new UnsupportedOperationException()" are not directly in JDBC-defined methods (although most are).

              </div></li><li><div>
                Pull request: https://github.com/apache/drill/pull/171  (see DRILL-2489).
              </div></li><li><div>
                Fixed by e4f257b1f0200d3f1e977d37b61bdc53fa60533a
              </div></li></ol></div></div></html>