<!DOCTYPE html><html><div class="item-title">
        Item 390
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 uploads defined but uploadId is not --&gt; this is the creation of the
 multi-part-upload requests.

In  AWS SDK for go uses application/octet-stream which also
should be fixed to route the request to the right jaxrs method.

Should be empty instead of XML as the body is empty which can not be
serialized as as CompleteMultipartUploadRequest
              </div></li><li><div>
                *
   * Default offset between two filters.
   
              </div></li><li><div>
                *
   * Initialize MultiPartUpload request.
   * &lt;p&gt;
   * Note: the specific content type is set by the HeaderPreprocessor.
   
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HDDS-1948. S3 MPU can't be created with octet-stream content-type  (#1266)
                </div><div><b>message:</b> HDDS-1948. S3 MPU can't be created with octet-stream content-type  (#1266)


                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> HDDS-4034. Add Unit Test for HadoopNestedDirGenerator.
                </div><div><b>body:</b> ## What changes were proposed in this pull request?

Added Unit Test for HadoopNestedDirGenerator.

## What is the link to the Apache JIRA

https://issues.apache.org/jira/browse/HDDS-4034

## How was this patch tested?

Tested Manually.

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                # [Codecov](https://codecov.io/gh/apache/hadoop-ozone/pull/1266?src=pr&amp;el=h1) Report
&gt; Merging [#1266](https://codecov.io/gh/apache/hadoop-ozone/pull/1266?src=pr&amp;el=desc) into [master](https://codecov.io/gh/apache/hadoop-ozone/commit/715aed2d158d2c6708af8b6a9b8270766103ee52&amp;el=desc) will **increase** coverage by `0.30%`.
&gt; The diff coverage is `n/a`.

[![Impacted file tree graph](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/graphs/tree.svg?width=650&amp;height=150&amp;src=pr&amp;token=5YeeptJMby)](https://codecov.io/gh/apache/hadoop-ozone/pull/1266?src=pr&amp;el=tree)

```diff
@@             Coverage Diff              @@
##             master    #1266      +/-   ##
============================================
+ Coverage     73.54%   73.85%   +0.30%     
- Complexity    10043    10148     +105     
============================================
  Files           978      974       -4     
  Lines         49894    50186     +292     
  Branches       4845     4891      +46     
============================================
+ Hits          36696    37066     +370     
+ Misses        10887    10781     -106     
- Partials       2311     2339      +28     
```


| [Impacted Files](https://codecov.io/gh/apache/hadoop-ozone/pull/1266?src=pr&amp;el=tree) | Coverage Δ | Complexity Δ | |
|---|---|---|---|
| [...x509/certificates/utils/SelfSignedCertificate.java](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/diff?src=pr&amp;el=tree#diff-aGFkb29wLWhkZHMvZnJhbWV3b3JrL3NyYy9tYWluL2phdmEvb3JnL2FwYWNoZS9oYWRvb3AvaGRkcy9zZWN1cml0eS94NTA5L2NlcnRpZmljYXRlcy91dGlscy9TZWxmU2lnbmVkQ2VydGlmaWNhdGUuamF2YQ==) | `76.59% &lt;0.00%&gt; (-15.95%)` | `7.00% &lt;0.00%&gt; (+1.00%)` | :arrow_down: |
| [...er/common/transport/server/GrpcXceiverService.java](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/diff?src=pr&amp;el=tree#diff-aGFkb29wLWhkZHMvY29udGFpbmVyLXNlcnZpY2Uvc3JjL21haW4vamF2YS9vcmcvYXBhY2hlL2hhZG9vcC9vem9uZS9jb250YWluZXIvY29tbW9uL3RyYW5zcG9ydC9zZXJ2ZXIvR3JwY1hjZWl2ZXJTZXJ2aWNlLmphdmE=) | `70.00% &lt;0.00%&gt; (-10.00%)` | `3.00% &lt;0.00%&gt; (ø%)` | |
| [...g/apache/hadoop/hdds/utils/ResourceLimitCache.java](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/diff?src=pr&amp;el=tree#diff-aGFkb29wLWhkZHMvY29tbW9uL3NyYy9tYWluL2phdmEvb3JnL2FwYWNoZS9oYWRvb3AvaGRkcy91dGlscy9SZXNvdXJjZUxpbWl0Q2FjaGUuamF2YQ==) | `84.37% &lt;0.00%&gt; (-9.38%)` | `7.00% &lt;0.00%&gt; (-1.00%)` | |
| [.../transport/server/ratis/ContainerStateMachine.java](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/diff?src=pr&amp;el=tree#diff-aGFkb29wLWhkZHMvY29udGFpbmVyLXNlcnZpY2Uvc3JjL21haW4vamF2YS9vcmcvYXBhY2hlL2hhZG9vcC9vem9uZS9jb250YWluZXIvY29tbW9uL3RyYW5zcG9ydC9zZXJ2ZXIvcmF0aXMvQ29udGFpbmVyU3RhdGVNYWNoaW5lLmphdmE=) | `71.07% &lt;0.00%&gt; (-5.61%)` | `62.00% &lt;0.00%&gt; (-4.00%)` | |
| [...ozone/container/ozoneimpl/ContainerController.java](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/diff?src=pr&amp;el=tree#diff-aGFkb29wLWhkZHMvY29udGFpbmVyLXNlcnZpY2Uvc3JjL21haW4vamF2YS9vcmcvYXBhY2hlL2hhZG9vcC9vem9uZS9jb250YWluZXIvb3pvbmVpbXBsL0NvbnRhaW5lckNvbnRyb2xsZXIuamF2YQ==) | `63.15% &lt;0.00%&gt; (-5.27%)` | `11.00% &lt;0.00%&gt; (-1.00%)` | |
| [...p/ozone/container/common/utils/ContainerCache.java](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/diff?src=pr&amp;el=tree#diff-aGFkb29wLWhkZHMvY29udGFpbmVyLXNlcnZpY2Uvc3JjL21haW4vamF2YS9vcmcvYXBhY2hlL2hhZG9vcC9vem9uZS9jb250YWluZXIvY29tbW9uL3V0aWxzL0NvbnRhaW5lckNhY2hlLmphdmE=) | `91.54% &lt;0.00%&gt; (-4.82%)` | `11.00% &lt;0.00%&gt; (ø%)` | |
| [.../common/volume/RoundRobinVolumeChoosingPolicy.java](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/diff?src=pr&amp;el=tree#diff-aGFkb29wLWhkZHMvY29udGFpbmVyLXNlcnZpY2Uvc3JjL21haW4vamF2YS9vcmcvYXBhY2hlL2hhZG9vcC9vem9uZS9jb250YWluZXIvY29tbW9uL3ZvbHVtZS9Sb3VuZFJvYmluVm9sdW1lQ2hvb3NpbmdQb2xpY3kuamF2YQ==) | `80.95% &lt;0.00%&gt; (-4.77%)` | `5.00% &lt;0.00%&gt; (-1.00%)` | |
| [...rg/apache/hadoop/hdds/client/ContainerBlockID.java](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/diff?src=pr&amp;el=tree#diff-aGFkb29wLWhkZHMvY29tbW9uL3NyYy9tYWluL2phdmEvb3JnL2FwYWNoZS9oYWRvb3AvaGRkcy9jbGllbnQvQ29udGFpbmVyQmxvY2tJRC5qYXZh) | `73.91% &lt;0.00%&gt; (-4.35%)` | `9.00% &lt;0.00%&gt; (-1.00%)` | |
| [...che/hadoop/ozone/om/helpers/OmKeyLocationInfo.java](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/diff?src=pr&amp;el=tree#diff-aGFkb29wLW96b25lL2NvbW1vbi9zcmMvbWFpbi9qYXZhL29yZy9hcGFjaGUvaGFkb29wL296b25lL29tL2hlbHBlcnMvT21LZXlMb2NhdGlvbkluZm8uamF2YQ==) | `80.95% &lt;0.00%&gt; (-4.24%)` | `24.00% &lt;0.00%&gt; (-2.00%)` | |
| [...apache/hadoop/hdds/server/events/EventWatcher.java](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/diff?src=pr&amp;el=tree#diff-aGFkb29wLWhkZHMvZnJhbWV3b3JrL3NyYy9tYWluL2phdmEvb3JnL2FwYWNoZS9oYWRvb3AvaGRkcy9zZXJ2ZXIvZXZlbnRzL0V2ZW50V2F0Y2hlci5qYXZh) | `77.77% &lt;0.00%&gt; (-4.17%)` | `14.00% &lt;0.00%&gt; (ø%)` | |
| ... and [76 more](https://codecov.io/gh/apache/hadoop-ozone/pull/1266/diff?src=pr&amp;el=tree-more) | |

------

[Continue to review full report at Codecov](https://codecov.io/gh/apache/hadoop-ozone/pull/1266?src=pr&amp;el=continue).
&gt; **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta)
&gt; `Δ = absolute &lt;relative&gt; (impact)`, `ø = not affected`, `? = missing data`
&gt; Powered by [Codecov](https://codecov.io/gh/apache/hadoop-ozone/pull/1266?src=pr&amp;el=footer). Last update [715aed2...a0430d2](https://codecov.io/gh/apache/hadoop-ozone/pull/1266?src=pr&amp;el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments).

              </div></li><li><div>
                Thanks @aryangupta1998 for the contribution.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                Thanks @aryangupta1998 . Why do the no of datanodes matter here? can you explain?
              </div></li><li><div>
                Thanks @bshashikant. Thanks for pointing out and sorry for the mistake. I have removed this javadoc.
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> S3 MPU can't be created with octet-stream content-type 
                </div><div><b>description:</b> This problem is reported offline by [~shanekumpf@gmail.com].

When aws-sdk-go is used to access to s3 gateway of Ozone it sends the Multi Part Upload initialize message with "application/octet-stream" Content-Type. 

This Content-Type is missing from the aws-cli which is used to reimplement s3 endpoint.

The problem is that we use the same rest endpoint for initialize and complete Multipart Upload request. For the completion we need the CompleteMultipartUploadRequest parameter which is parsed from the body.

For initialize we have an empty body which can't be serialized to CompleteMultipartUploadRequest.

The workaround is to set a specific content type from a filter which help up to create two different REST method for initialize and completion message.

Here is an example to test (using bogus AWS credentials).

{code}
curl -H 'Host:yourhost' -H 'User-Agent:aws-sdk-go/1.15.11 (go1.11.2; linux; amd64)' -H 'Content-Length:0' -H 'Authorization:AWS4-HMAC-SHA256 Credential=qwe/20190809/ozone/s3/aws4_request, SignedHeaders=content-type;host;x-amz-acl;x-amz-content-sha256;x-amz-date;x-amz-storage-class, Signature=7726ed63990ba3f4f1f796d4ab263f5d9c3374528840f5e49d106dbef491f22c' -H 'Content-Type:application/octet-stream' -H 'X-Amz-Acl:private' -H 'X-Amz-Content-Sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855' -H 'X-Amz-Date:20190809T070142Z' -H 'X-Amz-Storage-Class:STANDARD' -H 'Accept-Encoding:gzip' -X POST 'http://localhost:9999/docker/docker/registry/v2/repositories/apache/ozone-runner/_uploads/2173f019-09c3-466b-bb7d-c31ce749d826/data?uploads
{code}

Without the patch it returns with HTTP 405 (Not supported Media Type).
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                FAILURE: Integrated in Jenkins build Hadoop-trunk-Commit #17173 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/17173/])
HDDS-1948. S3 MPU can't be created with octet-stream content-type  (bharat: rev edd708527d34d0bf3b09dc35a7f645f49e7becb3)
* (edit) hadoop-ozone/s3gateway/src/test/java/org/apache/hadoop/ozone/s3/endpoint/TestInitiateMultipartUpload.java
* (edit) hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/VirtualHostStyleFilter.java
* (edit) hadoop-ozone/s3gateway/src/test/java/org/apache/hadoop/ozone/s3/endpoint/TestAbortMultipartUpload.java
* (edit) hadoop-ozone/s3gateway/src/test/java/org/apache/hadoop/ozone/s3/endpoint/TestMultipartUploadComplete.java
* (edit) hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/endpoint/ObjectEndpoint.java
* (edit) hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/HeaderPreprocessor.java
* (edit) hadoop-ozone/s3gateway/src/test/java/org/apache/hadoop/ozone/s3/endpoint/TestPartUpload.java
* (edit) hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/S3GatewayHttpServer.java
* (edit) hadoop-ozone/s3gateway/src/test/java/org/apache/hadoop/ozone/s3/endpoint/TestListParts.java

              </div></li><li><div>
                Cherry-picked this to ozone-0.4.1.
              </div></li></ol></div></div></html>