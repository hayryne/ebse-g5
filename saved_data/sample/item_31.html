<!DOCTYPE html><html><div class="item-title">
        Item 31
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HBASE-4247 Add isAborted method to the Abortable interface
                </div><div><b>message:</b> HBASE-4247 Add isAborted method to the Abortable interface

git-svn-id: https://svn.apache.org/repos/asf/hbase/trunk@1172040 13f79535-47bb-0310-9956-ffa450edef68

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Add isAborted method to the Abortable interface
                </div><div><b>description:</b> Add a new method isAborted() to the Abortable interface 
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div><div><b>body:</b> Firstly in the process of working on this. I have made the following assumptions

1. if abort() has a null implementation, then 
      a. isAborted() will have a null implementation ( returns false )

2. if abort() throws a RuntimeException(), then 
      a. create a boolean abort 
      b.set this to true in  abort()
      c. return abort in isAbort()

I hope this would be fine.


Secondly there are Instances where in abort() implementation this.stopped and this.closed are manipulated. Shouldn't this be done in stop() and close() methods of Stoppable and Closable interfaces? This is a little misleading isn't it ? 

If it really has to be stopped when aborted then why not call stop() from abort(). I feel it makes it more meaningful


                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> On 1., agree.  I agree on 2. too.

On your 'Secondly', yes.  That seems dirty.

Agree on calling stop from abort (Doesn't it do this in a few places?  IIRC).
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I just made the changes and ran tests. There's one issue. In HConnectionManagerImpl as I mentioned before this.closed is being set to true in the abort() method and I changed this to call close(stopProxy) method indeed instead of manipulating this.closed to true. But unfortunatly TestMergeTool started failing because of this change. So my question is that was this intended closed in the first place ??  
              </div></li><li><div>
                TestMergeTool passed in build 2155.
Can you publish your patch along with the test failure ?

Thanks
              </div></li><li><div>
                TestMerge tool is failing because of the changes I made I am sure. 

The change is basically this:

Original
&lt;code&gt;
   @Override
    public void abort(final String msg, Throwable t) {
      if (t instanceof KeeperException.SessionExpiredException) {
        try {
          LOG.info("This client just lost it's session with ZooKeeper, trying" +
              " to reconnect.");
          resetZooKeeperTrackers();
          LOG.info("Reconnected successfully. This disconnect could have been" +
              " caused by a network partition or a long-running GC pause," +
              " either way it's recommended that you verify your environment.");
          return;
        } catch (ZooKeeperConnectionException e) {
          LOG.error("Could not reconnect to ZooKeeper after session" +
              " expiration, aborting");
          t = e;
        }
      }
      if (t != null) LOG.fatal(msg, t);
      else LOG.fatal(msg);
      this.closed=true;
    }
&lt;/code&gt;

Changed
&lt;code&gt;
   @Override
    public void abort(final String msg, Throwable t) {
      if (t instanceof KeeperException.SessionExpiredException) {
        try {
          LOG.info("This client just lost it's session with ZooKeeper, trying" +
              " to reconnect.");
          resetZooKeeperTrackers();
          LOG.info("Reconnected successfully. This disconnect could have been" +
              " caused by a network partition or a long-running GC pause," +
              " either way it's recommended that you verify your environment.");
          return;
        } catch (ZooKeeperConnectionException e) {
          LOG.error("Could not reconnect to ZooKeeper after session" +
              " expiration, aborting");
          t = e;
        }
      }
      if (t != null) LOG.fatal(msg, t);
      else LOG.fatal(msg);
      close(false);
    }
&lt;/code&gt;

My question is close is closing zookeeper session and other thing. But does changing this leads to other test cases like TestMergeTool failing. 

Does setting this.closed=true have any meaning at all in abort without actually closing ?
              </div></li><li><div><div><b>body:</b> Plz excuse me about the formatting. I didn't know the Markup tags the codes should be placed under 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                See https://lists.secondlife.com/pipermail/jira-notify/2009-January/099415.html for Code formatting tags for JIRA

@Akash:
If you cannot edit your previous comment, I can format it for you.
              </div></li><li><div>
                HConnectionImplementation implements HConnection which inturn implements Abortable
              </div></li><li><div>
                According to the javadoc for Abortable:
{noformat}
 * This is used primarily for ZooKeeper usage when we could get an unexpected
 * and fatal exception, requiring an abort.
{noformat}
This means the first if block in the above abort() method is supposed to handle almost all calls to the method.

To try to validate the above judgement, I issued the following two searches among all test output files:
{code}
grep FATAL target/surefire-reports/* | grep ConnectionManager | grep -v TestMergeTool
grep 'Could not reconnect to ZooKeeper after session' target/surefire-reports/*
{code}
There was nothing returned.

TestMergeTool is a special case where HBase cluster is supposed to be unavailable.

Looking at getMaster() and locateRegion(), this.closed being true would make them return immediately.

Hope this helps with your question.
              </div></li><li><div>
                I agree with that. But on a more logical level doesn't setting this.closed = true mean that close() method was called on it and the zookeeper session itself was closed ? 
setting this.closed = true without executing close() shouldn't be done even for special cases right ?

If such is that case then this.aborted itself should be used instead of closed right ??
              </div></li><li><div>
                I thought abort executed close?
              </div></li><li><div>
                In HConnectionManager.java under the subclass HConnectionManagerImplementation

{code}
 @Override
    public void abort(final String msg, Throwable t) {
      if (t instanceof KeeperException.SessionExpiredException) {
        try {
          LOG.info("This client just lost it's session with ZooKeeper, trying" +
              " to reconnect.");
          resetZooKeeperTrackers();
          LOG.info("Reconnected successfully. This disconnect could have been" +
              " caused by a network partition or a long-running GC pause," +
              " either way it's recommended that you verify your environment.");
          return;
        } catch (ZooKeeperConnectionException e) {
          LOG.error("Could not reconnect to ZooKeeper after session" +
              " expiration, aborting");
          t = e;
        }
      }
      if (t != null) LOG.fatal(msg, t);
      else LOG.fatal(msg);
      this.closed = true;
    }
{code}

If we call close() instead of this tests are failing( one of them being TestMergeTools ). I was wondering if some change should be made out here. Somehow I feel its not right set this.closed out here? Or if this is some special case and could be left untouched. 

Thanks
              </div></li><li><div>
                I think this is special.  This is client-side.  I thought you were talking server-side.  I misunderstood.  Do what you think makes most sense Akash.  This client-side stuff is tricky.
              </div></li><li><div>
                Adding Javadoc to the isAbortable() method in Abortable Interface
              </div></li><li><div>
                Committed to TRUNK.  Thank you for the patch Akash.
              </div></li><li><div>
                Integrated in HBase-TRUNK #2227 (See [https://builds.apache.org/job/HBase-TRUNK/2227/])
    HBASE-4247 Add isAborted method to the Abortable interface
HBASE-4247 Add isAborted method to the Abortable interface

stack : 
Files : 
* /hbase/trunk/CHANGES.txt

stack : 
Files : 
* /hbase/trunk/CHANGES.txt
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/Abortable.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/HBaseAdmin.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/client/HConnectionManager.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/master/HMaster.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/replication/master/ReplicationLogCleaner.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/util/HBaseFsck.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/zookeeper/ZooKeeperWatcher.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTracker.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/catalog/TestCatalogTrackerOnCluster.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/catalog/TestMetaReaderEditor.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestActiveMasterManager.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestCatalogJanitor.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestClockSkewDetection.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestLogsCleaner.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/master/TestMasterFailover.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/handler/MockRegionServerServices.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/handler/MockServer.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSourceManager.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/zookeeper/TestZKTable.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/zookeeper/TestZooKeeperNodeTracker.java

              </div></li><li><div>
                This issue was closed as part of a bulk closing operation on 2015-11-20. All issues that have been resolved and where all fixVersions have been released have been closed (following discussions on the mailing list).
              </div></li></ol></div></div></html>