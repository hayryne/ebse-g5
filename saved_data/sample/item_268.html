<!DOCTYPE html><html><div class="item-title">
        Item 268
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Default implementation - do not filter anything
              </div></li><li><div>
                *
 * Implementations of CompactionFilter allows prioritizing and filtering certain type of
 * compactions over other compactions.
 *
 * e.g. Filter in-efficient compaction like compacting a very large old parquet file with a small avro file
 
              </div></li><li><div>
                
 *  Copyright (c) 2016 Uber Technologies, Inc. (hoodie-dev-group@uber.com)
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *           http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 
              </div></li><li><div>
                Only for serialization/de-serialization
              </div></li><li><div>
                *
 * Encapsulates all the needed information about a compaction
 * and make a decision whether this compaction is effective or not
 *
 * @see CompactionFilter
 
              </div></li><li><div>
                
 *  Copyright (c) 2016 Uber Technologies, Inc. (hoodie-dev-group@uber.com)
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *           http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 
              </div></li><li><div>
                *
 * Place holder for the compaction specific meta-data, uses all the details used in a normal HoodieCommitMetadata
 
              </div></li><li><div>
                
 *  Copyright (c) 2016 Uber Technologies, Inc. (hoodie-dev-group@uber.com)
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *           http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 
              </div></li><li><div>
                *
 * A HoodieCompactor runs compaction on a hoodie table
 
              </div></li><li><div>
                *
     * Compact the delta files with the data files
     * @throws Exception
     
              </div></li><li><div>
                 Helper methods
              </div></li><li><div>
                
 *  Copyright (c) 2016 Uber Technologies, Inc. (hoodie-dev-group@uber.com)
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *           http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 
              </div></li><li><div><div><b>comment:</b>  TODO - rollback any compactions in flight
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                *
 * HoodieRealtimeTableCompactor compacts a hoodie table with merge on read storage.
 * Computes all possible compactions, passes it through a CompactionFilter and executes
 * all the compactions and writes a new version of base files and make a normal commit
 *
 * @see HoodieCompactor
 
              </div></li><li><div>
                 Filter the compactions with the passed in filter. This lets us choose most effective compactions only
              </div></li><li><div>
                 2. naively loads all the delta records in memory to merge it,
 since we only need a iterator, we could implement a lazy iterator to load from one delta file at a time
              </div></li><li><div><div><b>comment:</b> TODO figure out a success factor for a compaction
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                noinspection ConstantConditions
              </div></li><li><div>
                
 *  Copyright (c) 2016 Uber Technologies, Inc. (hoodie-dev-group@uber.com)
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *           http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 
              </div></li><li><div><div><b>comment:</b>  TODO - FIX THIS
 1. Reads the entire avro file. Always only specific blocks should be read from the avro file (failure recover).
 Load all the delta commits since the last compaction commit and get all the blocks to be loaded and load it using CompositeAvroLogReader
 Since a DeltaCommit is not defined yet, reading all the records. revisit this soon.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                 Do a compaction
              </div></li><li><div>
                 Verify that all data file has one log file
              </div></li><li><div>
                 Initialize a local spark env
              </div></li><li><div><div><b>comment:</b>  TODO - after modifying HoodieReadClient to support realtime tables - add more tests to make sure the data read is the updated data (compaction correctness)
 TODO - add more test cases for compactions after a failed commit/compaction
                </div><div><b>label:</b> test
                </div></div></li><li><div>
                 Update all the 100 records
              </div></li><li><div>
                 insert 100 records
              </div></li><li><div>
                
 *  Copyright (c) 2016 Uber Technologies, Inc. (hoodie-dev-group@uber.com)
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *           http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 
              </div></li><li><div>
                 Write them to corresponding avro logfiles
              </div></li><li><div>
                 Create a temp folder as the base path
              </div></li><li><div>
                 Verify that recently written compacted data file has no log file
              </div></li><li><div>
                *
 * This is a payload to wrap a existing Hoodie Avro Record.
 * Useful to create a HoodieRecord over existing GenericRecords in a hoodie datasets (useful in compactions)
 
              </div></li><li><div>
                
 *  Copyright (c) 2016 Uber Technologies, Inc. (hoodie-dev-group@uber.com)
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *           http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 
              </div></li><li><div>
                *
 * Realtime Table View which includes both ROStorageformat files and RTStorageFormat files
 
              </div></li><li><div>
                 All the log files filtered from the above list, sorted by version numbers
              </div></li><li><div>
                
 *  Copyright (c) 2016 Uber Technologies, Inc. (hoodie-dev-group@uber.com)
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *           http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 
              </div></li><li><div>
                 All the files in the partition
              </div></li><li><div>
                 Filter the delta files by the commit time of the latest base fine and collect as a list
              </div></li><li><div>
                 For realtime table view, visibleActiveCommitTimeline is a merged timeline of all commits and compactions
              </div></li><li><div>
                 Set the expected schema to be the current schema to account for schema evolution
              </div></li><li><div>
                 also closes underlying FsInput
              </div></li><li><div>
                
 *  Copyright (c) 2016 Uber Technologies, Inc. (hoodie-dev-group@uber.com)
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *           http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 
              </div></li><li><div>
                
 *  Copyright (c) 2016 Uber Technologies, Inc. (hoodie-dev-group@uber.com)
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *           http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 
              </div></li><li><div>
                *
     * Get the Read Optimized Storage Format
     *
     * @return HoodieFileFormat for the Read Optimized Storage format
     
              </div></li><li><div>
                *
     * Get the FS implementation for this table
     * @return
     
              </div></li><li><div>
                 The base commit time for which the log files are accumulated
              </div></li><li><div>
                 reverse the order
              </div></li><li><div>
                *
     * Get a timeline of a specific set of actions. useful to create a merged timeline of multiple actions
     *
     * @param actions actions allowed in the timeline
     * @return
     
              </div></li><li><div>
                *
     * Get only the commits (inflight and completed) in the compaction timeline
     *
     * @return
     
              </div></li><li><div>
                 This is the commits that will be visible for all views extending this view
              </div></li><li><div>
                *
     * This method is only used when this object is deserialized in a spark executor.
     *
     * @deprecated
     
              </div></li><li><div>
                *
     * Get the first part of the file name in the log file. That will be the fileId.
     * Log file do not have commitTime in the file name.
     *
     * @param path
     * @return
     
              </div></li><li><div>
                 Log files are of this pattern - b5068208-e1a4-11e6-bf01-fe55135034f3_20170101134598.avro.delta.1
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor (#73)
                </div><div><b>message:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor (#73)


                </div></div></li></ol></div><div><b>github_issues:</b> <ol><li><div><div><b>title:</b> Introduce HoodieRealtimeTableView and implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> 
                </div></div></li><li><div><div><b>title:</b> Introduce HoodieRealtimeTableView and implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> 
                </div></div></li></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> this fixes #72

                </div></div></li><li><div><div><b>title:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> this fixes #72

                </div></div></li><li><div><div><b>title:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> this fixes #72

                </div></div></li><li><div><div><b>title:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> this fixes #72

                </div></div></li><li><div><div><b>title:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> this fixes #72

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> this fixes #72

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> this fixes #72

                </div></div></li><li><div><div><b>title:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> this fixes #72

                </div></div></li><li><div><div><b>title:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> this fixes #72

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Introduce RealtimeTableView and Implement HoodieRealtimeTableCompactor
                </div><div><b>body:</b> this fixes #72

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                Feel free to merge, after you look at the comments.. 
              </div></li><li><div>
                merge

Hanjun

On Wed, Feb 1, 2017 at 1:47 AM, vinoth chandar &lt;notifications@github.com&gt;
wrote:

&gt; Feel free to merge, after you look at the comments..
&gt;
&gt; —
&gt; You are receiving this because you are subscribed to this thread.
&gt; Reply to this email directly, view it on GitHub
&gt; &lt;https://github.com/uber/hoodie/pull/73#issuecomment-276437329&gt;, or mute
&gt; the thread
&gt; &lt;https://github.com/notifications/unsubscribe-auth/ACW3yxCI1qvU5NeArBOskzIIAsEEJn-Sks5rX3OUgaJpZM4Ly05i&gt;
&gt; .
&gt;

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                HoodieCompactionCommitMetadata? 
              </div></li><li><div><div><b>body:</b> CommitMetadata needs to be cleaned up carefully, to not affect the current production stuff/ 

But some naming/organization like below 
HoodieTimelineInstantMetadata 
   -&gt;  CommitInstantMetadata (this is new name for HoodieCommitMetadata) 
   -&gt;  CompactionInstantMetadata
   -&gt; CleanerInstantMetadata 

might be a better long term thing.. 


                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> Given this usage, CompactionTask is probably a better name than  CompactionOperation IMO 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Would this always fit into memory? 
              </div></li><li><div>
                Good point
              </div></li><li><div><div><b>body:</b> We should probably load the base files into memory and run the delta files through it? the other way around? 

May be just add a TODO, its okay for now.. 
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>jira_issues:</b> <ol></ol></div><div><b>jira_issues_comments:</b> <ol></ol></div></div></html>