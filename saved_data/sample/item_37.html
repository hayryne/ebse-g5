<!DOCTYPE html><html><div class="item-title">
        Item 37
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> HBASE-5862 After Region Close remove the Operation Metrics; ADDENDUM -- missing import
                </div><div><b>message:</b> HBASE-5862 After Region Close remove the Operation Metrics; ADDENDUM -- missing import

git-svn-id: https://svn.apache.org/repos/asf/hbase/branches/0.94@1331040 13f79535-47bb-0310-9956-ffa450edef68

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div><div><b>label:</b> test
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div><div><b>label:</b> documentation
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li><li><div><div><b>summary:</b> After Region Close remove the Operation Metrics.
                </div><div><b>description:</b> If a region is closed then Hadoop metrics shouldn't still be reporting about that region.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div><div><b>body:</b> {code}
+  public void closeMetrics() {
+    for (String m:metricsPut) {
{code}
Please insert spaces around the colon above.
{code}
+      RegionMetricsStorage.deleteTimeVaryingMetric(m);
+    }
+    this.metricsPut = new TreeSet&lt;String&gt;();
{code}
Calling this.metricsPut.clear() should be enough.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                So with the way hadoop metrics MetricsRegistry works it's not really possible to remove a metric.  So this won't do what's needed.

              </div></li><li><div>
                Log Hadoop JIRA to request this feature ?
              </div></li><li><div><div><b>body:</b> @Elliott What happens?  The region looks like its on a regionserver its no longer on?  The counters just don't change?  Whats that mean?  That our per-region metrics are going to be messy if regions move?  Good on you.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> @Stack yes our per region metrics will be messy if regions move or split or if tables are dropped.  

For operation metrics anything reading the jmx can just ignore metrics with _NumOps = 0.  That's messy but it works.  For something going forward that's a little more general would be nice.  I'll look into it.  
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Filed HADOOP-8313

I'm still looking into other ways of doing it.
              </div></li><li><div>
                Here's how I was able to do it.  It's not pretty.  But it works.

Basically remove all DynamicStatistics after a region is placed off-line.
              </div></li><li><div><div><b>body:</b> {code}
  @SuppressWarnings("unused")
  private RegionServerDynamicMetrics dynamicMetrics;
{code}
I tried to find out how HRegionServer.dynamicMetrics is used but wasn't able to.
{code}
+    //Clear all of the dynamic metrics as they are now probably useless
+    this.dynamicMetrics.clear();
{code}
Only encodedName is removed. Why do we clear dynamicMetrics ?
{code}
+      } catch (SecurityException e) {
+        LOG.debug("Unable to clear metricsRecord");
{code}
We don't need to stumble over the same exception(s) again and again. Why not set a boolean to indicate that reflection shouldn't be used in the future ?
{code}
+    if (this.recordMetricMapField != null || this.registryMetricMapField != null) {
+      try {
{code}
Please separate the above two conditions into two if blocks.
{code}
+import com.google.common.collect.Multiset.Entry;
{code}
Is the above import used ?
It's nice to have a test.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                HRegionServer.dynamicMetrics registers it's self with the Hadoop Metrics.  From then on the metrics are polled by a thread outside of hbase.

We clear everything in order to clear schema metrics and metrics about cf's.  It would be time consuming to iterate through all metrics and see if they are for column families that are still being served.  Since the metrics are reset by jmx every time it comes through removing them is not great but saves a lot of string comparisons and ensures that all edge cases are covered.

I added the bool to make sure that initializing is only tried once.

Changed the or to a &amp;&amp; since only clearing half doesn't get the job done so better not not try if one field was not accessible.
              </div></li><li><div><div><b>body:</b> I can write a more comprehensive test but that would require changing several fields to be more accessible.  Not sure what the general thought was on that.
                </div><div><b>label:</b> test
                </div></div></li><li><div><div><b>body:</b> MetricsRecord has become an interface in MRv2.

Please introduce Shim to make the solution work for both hadoop 1.0 and 2.0
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Testing on both 1.0 and 0.23 both work (after applying patch from HBASE-5870).  MetricsRecord has always been an interface as far as I can tell.  What did you think needed a shim ?
              </div></li><li><div>
                I didn't check MetricsRecord in hadoop 1.0
Thanks for the confirmation.
              </div></li><li><div>
                Thanks for the check.
              </div></li><li><div>
                +1 on patch v3.
              </div></li><li><div>
                Attaching 94 backport of v3
              </div></li><li><div>
                -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12524329/HBASE-5862-94-3.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/1651//console

This message is automatically generated.
              </div></li><li><div>
                The last QA failure was for the 94 branch patch.  It failed because QA only tries to patch trunk.
              </div></li><li><div>
                -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12524095/HBASE-5862-3.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    +1 javadoc.  The javadoc tool did not generate any warning messages.

    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.

    -1 findbugs.  The patch appears to introduce 5 new Findbugs (version 1.3.9) warnings.

    +1 release audit.  The applied patch does not increase the total number of release audit warnings.

    +1 core tests.  The patch passed unit tests in .

Test results: https://builds.apache.org/job/PreCommit-HBASE-Build/1650//testReport/
Findbugs warnings: https://builds.apache.org/job/PreCommit-HBASE-Build/1650//artifact/trunk/patchprocess/newPatchFindbugsWarnings.html
Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/1650//console

This message is automatically generated.
              </div></li><li><div>
                @Stack:
Do you have suggestions on further improvement for the latest patch ?
              </div></li><li><div><div><b>body:</b> +1 on patch.  Please add more comments around why you are hacking into hadoop metrics.  Please also paste some pretty pictures so Lars can see why this has to be in 0.94.
                </div><div><b>label:</b> documentation
                </div></div></li><li><div>
                Stack wanted a screen shot of what all the recent region metrics work has enabled.

Here's a shot of TSDB showing average time of a multi put over all the regions of a table.  It illustrates regions being split and new regions showing up.

stack had some comments about places that needed some extra info I'll ge those trivial patches up in a sec.
              </div></li><li><div>
                Patch with more comments.
Also added a return if reflection was un-successful as there is no need to try more.
              </div></li><li><div>
                -1 overall.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12524470/HBASE-5862-4.patch
  against trunk revision .

    +1 @author.  The patch does not contain any @author tags.

    +1 tests included.  The patch appears to include 3 new or modified tests.

    -1 patch.  The patch command could not apply the patch.

Console output: https://builds.apache.org/job/PreCommit-HBASE-Build/1658//console

This message is automatically generated.
              </div></li><li><div>
                Committed trunk and 0.94.  Thanks for the patch Elliott
              </div></li><li><div>
                {code}
+    //per hfile.  Figuring out which cfs, hfiles, ...
{code}
Should cfs be in expanded form (column families) ?
{code}
+    //and on the next tick of the metrics everything that is still relevant will be
+    //re-added.
{code}
're-added' -&gt; 'added' or 'added again'

The initialization work in clear() should be moved to RegionServerDynamicMetrics ctor because it is one time operation.
              </div></li><li><div><div><b>body:</b> I don't get the Hadoop private field accessor stuff. Why do we need to clear out private fields? Is there an API missing for this in Hadoop?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                @lars Yes there's a missing api.  Hadoop metrics keeps a copy of all metrics created.  That copy is used to expose the data to jmx and other consumers.
There is no remove function. HADOOP-8313 was filed to correct this.  However until that changes reflection was the only way.
              </div></li><li><div>
                Thanks Elliot.
              </div></li><li><div>
                Integrated in HBase-0.94 #151 (See [https://builds.apache.org/job/HBase-0.94/151/])
    HBASE-5862 After Region Close remove the Operation Metrics; ADDENDUM -- missing import (Revision 1331040)

     Result = ABORTED
stack : 
Files : 
* /hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java

              </div></li><li><div>
                Integrated in HBase-0.94-security #22 (See [https://builds.apache.org/job/HBase-0.94-security/22/])
    HBASE-5862 After Region Close remove the Operation Metrics; ADDENDUM -- missing import (Revision 1331040)
HBASE-5862 After Region Close remove the Operation Metrics (Revision 1330998)

     Result = FAILURE
stack : 
Files : 
* /hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java

stack : 
Files : 
* /hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java
* /hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java
* /hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/metrics/OperationMetrics.java
* /hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/metrics/RegionMetricsStorage.java
* /hbase/branches/0.94/src/main/java/org/apache/hadoop/hbase/regionserver/metrics/RegionServerDynamicMetrics.java
* /hbase/branches/0.94/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java

              </div></li><li><div>
                Integrated in HBase-TRUNK-security #186 (See [https://builds.apache.org/job/HBase-TRUNK-security/186/])
    HBASE-5862 After Region Close remove the Operation Metrics (Revision 1330997)

     Result = SUCCESS
stack : 
Files : 
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/metrics/OperationMetrics.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/metrics/RegionMetricsStorage.java
* /hbase/trunk/src/main/java/org/apache/hadoop/hbase/regionserver/metrics/RegionServerDynamicMetrics.java
* /hbase/trunk/src/test/java/org/apache/hadoop/hbase/regionserver/TestRegionServerMetrics.java

              </div></li><li><div>
                Elliott, 

I was working on adding some other region level metrics. I think your work around of clearing all dynamic metrics for all the regions when one region is closed works for most of the cases, but for metrics of "numericPersistentMetrics", seems not appropriate. Because clearing the metrics will lose the accumulated values which can never be recovered, especially for the live regions that are not to be closed.

I want to open a bug for addressing the numericPersistentMetrics metrics, and would like to hear comments from you.  Thanks 
              </div></li></ol></div></div></html>