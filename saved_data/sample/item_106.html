<!DOCTYPE html><html><div class="item-title">
        Item 106
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                keyIvPair.setKeyBytes(keyBytes);	
keyIvPair.setIvBytes(ivBytes);
              </div></li><li><div>
                 key/IV will be set in 128 bit strength
              </div></li><li><div>
                 if we failed after reset, something is definitely wrong
              </div></li><li><div>
                 although we may have race conditioning here, database transaction serialization should
              </div></li><li><div>
                keyIvPair.setKeyBytes(keyBytes);	
keyIvPair.setIvBytes(ivBytes);
              </div></li><li><div>
                 key/IV will be set in 128 bit strength
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> CLOUDSTACK-2039: Improve console access security with 128-bit AES encryption and securely-randomized key generation
                </div><div><b>message:</b> CLOUDSTACK-2039: Improve console access security with 128-bit AES encryption and securely-randomized key generation

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Improve console access security with 128-bit AES encryption and securely-randomized key generation
                </div><div><b>description:</b> Improve console access security with 128-bit AES encryption and securely-randomized key generation
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Commit 34f8f795e15b89477f72aa6f1e69f7797c930db4 in branch refs/heads/master from Kelven Yang &lt;kelveny@gmail.com&gt;
[ https://git-wip-us.apache.org/repos/asf?p=cloudstack.git;h=34f8f79 ]

CLOUDSTACK-2039: Improve console access security with 128-bit AES encryption and securely-randomized key generation

              </div></li><li><div>
                Master/4.1 has been diverged.  I created a patch for 4.1 rebased on top of the current 4.1 HEAD. Here is the review request of it

https://reviews.apache.org/r/10533/


              </div></li><li><div>
                Commit 73ed03baea3f6718f74703b752a61c4314246a69 in branch refs/heads/4.1 from Chip Childers &lt;chip.childers@gmail.com&gt;
[ https://git-wip-us.apache.org/repos/asf?p=cloudstack.git;h=73ed03b ]

CLOUDSTACK-2039: Improve console access security with 128-bit AES encryption and securely-randomized key generation

              </div></li><li><div>
                applied to 4.1 branch, and set fix version to include 4.1
              </div></li><li><div><div><b>body:</b> I think I encountered a bug with this.

My management server is 4.1 and my Console Proxy as well. The problem is that when I try to open a Console session I get this in my systemvm.log:

2013-05-15 12:05:21,908 ERROR [cloud.consoleproxy.ConsoleProxyPasswordBasedEncryptor] (Thread-43:) Unexpected exception
javax.crypto.BadPaddingException: Given final block not properly padded
        at com.sun.crypto.provider.SunJCE_f.b(DashoA13*..)
        at com.sun.crypto.provider.SunJCE_f.b(DashoA13*..)
        at com.sun.crypto.provider.DESCipher.engineDoFinal(DashoA13*..)
        at javax.crypto.Cipher.doFinal(DashoA13*..)
        at com.cloud.consoleproxy.ConsoleProxyPasswordBasedEncryptor.decryptText(ConsoleProxyPasswordBasedEncryptor.java:97)
        at com.cloud.consoleproxy.ConsoleProxyPasswordBasedEncryptor.decryptObject(ConsoleProxyPasswordBasedEncryptor.java:129)
        at com.cloud.consoleproxy.ConsoleProxyHttpHandlerHelper.getQueryMap(ConsoleProxyHttpHandlerHelper.java:53)
        at com.cloud.consoleproxy.ConsoleProxyAjaxHandler.doHandle(ConsoleProxyAjaxHandler.java:69)
        at com.cloud.consoleproxy.ConsoleProxyAjaxHandler.handle(ConsoleProxyAjaxHandler.java:47)
        at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:65)
        at sun.net.httpserver.AuthFilter.doFilter(AuthFilter.java:65)
        at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:68)
        at sun.net.httpserver.ServerImpl$Exchange$LinkHandler.handle(ServerImpl.java:555)
        at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:65)
        at sun.net.httpserver.ServerImpl$Exchange.run(ServerImpl.java:525)
        at java.lang.Thread.run(Thread.java:662)
2013-05-15 12:05:21,910 WARN  [cloud.consoleproxy.ConsoleProxyAjaxHandler] (Thread-43:) Exception,
java.lang.IllegalArgumentException
        at com.cloud.consoleproxy.ConsoleProxyAjaxHandler.doHandle(ConsoleProxyAjaxHandler.java:90)
        at com.cloud.consoleproxy.ConsoleProxyAjaxHandler.handle(ConsoleProxyAjaxHandler.java:47)
        at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:65)
        at sun.net.httpserver.AuthFilter.doFilter(AuthFilter.java:65)
        at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:68)
        at sun.net.httpserver.ServerImpl$Exchange$LinkHandler.handle(ServerImpl.java:555)
        at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:65)
        at sun.net.httpserver.ServerImpl$Exchange.run(ServerImpl.java:525)
        at java.lang.Thread.run(Thread.java:662)

Line 97 is:
cipher.init(Cipher.DECRYPT_MODE, keySpec, new IvParameterSpec(keyIvPair.getIvBytes()));

That throws a "BadPaddingException: Given final block not properly padded"

I'm not so familiar with this, so any ideas what this could be?
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Kelven,

Upgrading this to a blocker, since it is causing the issues described by Wido.
              </div></li><li><div>
                Seems like this one was caused by my management server running a newer commit from the 4.1 branch then my System VMs.

Wondering though what happens when you upgrade your mgmt server to 4.1 and the System VMs are still 4.0, that won't work I think. In that period you won't have console access.
              </div></li><li><div>
                Wido:

The issue you describe is covered in the upgrade instructions (Release Notes):

"Once you've upgraded the packages on your management servers, you'll need to restart the system VMs."

It's a required step for not just this issue, but other updates that the system VMs need after the upgrade.

Resolving based on the info you provided.  Re-open if you disagree!
              </div></li><li><div>
                Closing this record, since 4.1.0 is now released.
              </div></li></ol></div></div></html>