<!DOCTYPE html><html><div class="item-title">
        Item 88
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 keep increasing length until we find first row of next partition or we reach the very last batch
              </div></li><li><div>
                 we are only interested in the first batch's records
              </div></li><li><div>
                 true when at least one window function needs to process all batches of a partition before passing any batch downstream
              </div></li><li><div>
                 this is the last batch of current partition if
 partition ends before the end of the batch
 it's the last available batch
 next batch contains a different partition
              </div></li><li><div>
                 we didn't compute the whole partition length in the previous partition, we need to update the length now
              </div></li><li><div>
                 true if we don't know yet the full length of this partition
 size of this partition (if partial is true, then this is a partial length of the partition)
 remaining non-processed rows in this partition
 remaining non-processed peers in current frame
              </div></li><li><div>
                 we need at least 2 batches even when window functions only need one batch, so we can detect the end of the
 current partition
              </div></li><li><div>
                 isPeer also checks if it's the same partition
              </div></li><li><div>
                 true if window definition contains an order-by clause
              </div></li><li><div>
                *
   * @return true when all window functions are ready to process the current batch (it's the first batch currently
   * held in memory)
   
              </div></li><li><div>
                 Clear the memory for the incoming batch
              </div></li><li><div>
                *
   * compares two rows from different batches (can be the same), if they have the same value for the partition by
   * expression
   * @param b1Index index of first row
   * @param b1 batch for first row
   * @param b2Index index of second row
   * @param b2 batch for second row
   * @return true if the rows are in the same partition
   
              </div></li><li><div>
                *
   * compares two rows from different batches (can be the same), if they have the same value for the order by
   * expression
   * @param b1Index index of first row
   * @param b1 batch for first row
   * @param b2Index index of second row
   * @param b2 batch for second row
   * @return true if the rows are in the same partition
   
              </div></li><li><div>
                 CUME_DIST, PERCENT_RANK and NTILE require the length of current partition before processing it's first batch
              </div></li><li><div>
                *
   * @param numBatchesAvailable number of batches available for current partition
   * @param hasOrderBy window definition contains an ORDER BY clause
   * @param frameEndReached we found the last row of the first batch's frame
   * @param partitionEndReached all batches of current partition are available
   *
   * @return true if this window function can process the first batch immediately
   
              </div></li><li><div>
                 for CUME_DIST, PERCENT_RANK and NTILE we need the full partition
 otherwise we can process the first batch immediately
              </div></li><li><div>
                *
   * @param hasOrderBy window definition contains an ORDER BY clause
   * @return true if this window function requires all batches of current partition to be available before processing
   * the first batch
   
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> DRILL-3952: Improve Window Functions performance when not all batches are required to process the current batch
                </div><div><b>message:</b> DRILL-3952: Improve Window Functions performance when not all batches are required to process the current batch

this closes #222

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div></div></li><li><div><div><b>title:</b> Drill 3952
                </div><div><b>body:</b> Improve Window Functions performance when not all batches are required to process the current batch

This patch also improves how the window functions operator handles limits by avoiding processing anymore batches after the kill signal has been received

@amansinha100 can you please review ? 

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div><div><b>body:</b> Overall,  there are 2 categories of the window functions: one that require all batches of the partition before they can start processing and second that can start work with partial partition as long as we have all peer rows of the current row.   It seems to me that some refactoring is needed to have derived classes dedicated to the 2 categories, otherwise  the logic in the common code is getting complicated.  What do you think ?  This need not necessarily be done as part of this patch...but we should discuss. 

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Window operator has become increasingly complex. I already opened [DRILL-3662](https://issues.apache.org/jira/browse/DRILL-3662) to refactor the code.

              </div></li><li><div>
                +1.   Per previous comments, there is room for improvement in terms of code organization and reducing the number of passes which I understand will be covered by DRILL-3662.  

              </div></li><li><div>
                thanks @amansinha100 , I updated DRILL-3662 description with the new refactoring tasks

              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                This should be a long since the number of peers could easily be greater than Integer.MAX_VALUE.

              </div></li><li><div><div><b>body:</b> I think isPeer() could also check whether two rows are in the same partition...because the notion of peer is only valid within a partition.  This will simplify the generated code a bit. 

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> The performance could be pretty bad due to the sequential scan through the remaining rows.  The data is sorted right ? 

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                why not. We still need to have a separate `isSamePartition` though

              </div></li><li><div>
                will fix

              </div></li><li><div><div><b>body:</b> This may be a relic from early implementations. I should be able to remove it now.

I may also be able to get rid of `updatePartitionSize()` but this may require too much work for this patch and may do it in a separate patch

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                change to 'rows in the same partition and are peers'

              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Improve Window Functions performance when not all batches are required to process the current batch
                </div><div><b>description:</b> Currently, the window operator blocks until all batches of current partition to be available. For some queries it's necessary (e.g. aggregate with no order-by in the window definition), but for other cases the window operator can process and pass the current batch downstream sooner.

Implementing this should help the window operator use less memory and run faster, especially in the presence of a limit operator.

The purpose of this JIRA is to improve the window operator in the following cases:
- aggregate, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- lead can process current batch as soon as it receives 1 more batch
- lag can process current batch immediately
- first_value can process current batch immediately
- last_value, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- row_number, rank and dense_rank can process current batch immediately 
                </div></div></li><li><div><div><b>summary:</b> Improve Window Functions performance when not all batches are required to process the current batch
                </div><div><b>description:</b> Currently, the window operator blocks until all batches of current partition to be available. For some queries it's necessary (e.g. aggregate with no order-by in the window definition), but for other cases the window operator can process and pass the current batch downstream sooner.

Implementing this should help the window operator use less memory and run faster, especially in the presence of a limit operator.

The purpose of this JIRA is to improve the window operator in the following cases:
- aggregate, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- lead can process current batch as soon as it receives 1 more batch
- lag can process current batch immediately
- first_value can process current batch immediately
- last_value, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- row_number, rank and dense_rank can process current batch immediately 
                </div></div></li><li><div><div><b>summary:</b> Improve Window Functions performance when not all batches are required to process the current batch
                </div><div><b>description:</b> Currently, the window operator blocks until all batches of current partition to be available. For some queries it's necessary (e.g. aggregate with no order-by in the window definition), but for other cases the window operator can process and pass the current batch downstream sooner.

Implementing this should help the window operator use less memory and run faster, especially in the presence of a limit operator.

The purpose of this JIRA is to improve the window operator in the following cases:
- aggregate, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- lead can process current batch as soon as it receives 1 more batch
- lag can process current batch immediately
- first_value can process current batch immediately
- last_value, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- row_number, rank and dense_rank can process current batch immediately 
                </div></div></li><li><div><div><b>summary:</b> Improve Window Functions performance when not all batches are required to process the current batch
                </div><div><b>description:</b> Currently, the window operator blocks until all batches of current partition to be available. For some queries it's necessary (e.g. aggregate with no order-by in the window definition), but for other cases the window operator can process and pass the current batch downstream sooner.

Implementing this should help the window operator use less memory and run faster, especially in the presence of a limit operator.

The purpose of this JIRA is to improve the window operator in the following cases:
- aggregate, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- lead can process current batch as soon as it receives 1 more batch
- lag can process current batch immediately
- first_value can process current batch immediately
- last_value, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- row_number, rank and dense_rank can process current batch immediately 
                </div></div></li><li><div><div><b>summary:</b> Improve Window Functions performance when not all batches are required to process the current batch
                </div><div><b>description:</b> Currently, the window operator blocks until all batches of current partition to be available. For some queries it's necessary (e.g. aggregate with no order-by in the window definition), but for other cases the window operator can process and pass the current batch downstream sooner.

Implementing this should help the window operator use less memory and run faster, especially in the presence of a limit operator.

The purpose of this JIRA is to improve the window operator in the following cases:
- aggregate, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- lead can process current batch as soon as it receives 1 more batch
- lag can process current batch immediately
- first_value can process current batch immediately
- last_value, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- row_number, rank and dense_rank can process current batch immediately 
                </div></div></li><li><div><div><b>summary:</b> Improve Window Functions performance when not all batches are required to process the current batch
                </div><div><b>description:</b> Currently, the window operator blocks until all batches of current partition to be available. For some queries it's necessary (e.g. aggregate with no order-by in the window definition), but for other cases the window operator can process and pass the current batch downstream sooner.

Implementing this should help the window operator use less memory and run faster, especially in the presence of a limit operator.

The purpose of this JIRA is to improve the window operator in the following cases:
- aggregate, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- lead can process current batch as soon as it receives 1 more batch
- lag can process current batch immediately
- first_value can process current batch immediately
- last_value, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- row_number, rank and dense_rank can process current batch immediately 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Improve Window Functions performance when not all batches are required to process the current batch
                </div><div><b>description:</b> Currently, the window operator blocks until all batches of current partition to be available. For some queries it's necessary (e.g. aggregate with no order-by in the window definition), but for other cases the window operator can process and pass the current batch downstream sooner.

Implementing this should help the window operator use less memory and run faster, especially in the presence of a limit operator.

The purpose of this JIRA is to improve the window operator in the following cases:
- aggregate, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- lead can process current batch as soon as it receives 1 more batch
- lag can process current batch immediately
- first_value can process current batch immediately
- last_value, when order-by clause is available in window definition, can process current batch as soon as it receives the last peer row
- row_number, rank and dense_rank can process current batch immediately 
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                pull request created: https://github.com/apache/drill/pull/222
              </div></li><li><div>
                [~amansinha100] can you please review ? thx
              </div></li><li><div>
                pull request updated. thx
              </div></li><li><div>
                Merged in ef1cb72
              </div></li><li><div>
                Verified with 1.4.0 (gitId: 32b871b). LGTM.
              </div></li></ol></div></div></html>