<!DOCTYPE html><html><div class="item-title">
        Item 88
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> DRILL-1212: Propagate trait in 2 phase aggregation rule, to avoid adding unnecessary exchange operator.
                </div><div><b>message:</b> DRILL-1212: Propagate trait in 2 phase aggregation rule, to avoid adding unnecessary exchange operator.

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Remove extra exchange operator when generate a two phase aggregation plan.
                </div><div><b>description:</b> We may see an extra hash exchange operator, when optimizer choose a two phase aggregation plan, for a query with group by GB_Key order by OB_Key and GB_key is same as Ob_key.

One example of such plan with extra exchange is TPCH Q12:

select
  l.l_shipmode,
  sum(case
    when o.o_orderpriority = '1-URGENT'
      or o.o_orderpriority = '2-HIGH'
      then 1
    else 0
  end) as high_line_count,
  sum(case
    when o.o_orderpriority &lt;&gt; '1-URGENT'
      and o.o_orderpriority &lt;&gt; '2-HIGH'
      then 1
    else 0
  end) as low_line_count
from
  cp.`tpch/orders.parquet` o,
  cp.`tpch/lineitem.parquet` l
where
  o.o_orderkey = l.l_orderkey
  and l.l_shipmode in ('TRUCK', 'REG AIR')
  and l.l_commitdate &lt; l.l_receiptdate
  and l.l_shipdate &lt; l.l_commitdate
  and l.l_receiptdate &gt;= date '1994-01-01'
  and l.l_receiptdate &lt; date '1994-01-01' + interval '1' year
group by
  l.l_shipmode
order by
  l.l_shipmode;

The issue is caused by the rule does not propagate the hash distribution up, and hence introduce unnecessary hash exchange. 

 
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Here is part of plan containing one extra hash exchange operator.

01-02            Sort(sort0=[$0], dir0=[ASC])
01-03              HashToRandomExchange(dist0=[[$0]])
02-01                HashAgg(group=[{0}], high_line_count=[SUM($1)], low_line_count=[SUM($2)])
02-02                  HashToRandomExchange(dist0=[[$0]])
03-01                    HashAgg(group=[{0}], high_line_count=[SUM($1)], low_line_count=[SUM($2)])

Operator 01-03  is duplicate, since operator 02-02 will hash-distributed the data using the same keys. 
              </div></li><li><div>
                fixed by 0d6befc or earlier
              </div></li></ol></div></div></html>