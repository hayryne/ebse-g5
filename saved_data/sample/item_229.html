<!DOCTYPE html><html><div class="item-title">
        Item 229
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> KAFKA-6568; Log cleaner should check partition state before removal from inProgress map  (#4580)
                </div><div><b>message:</b> KAFKA-6568; Log cleaner should check partition state before removal from inProgress map  (#4580)

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang indefinitely.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div><div><b>label:</b> test
                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>title:</b> KAFKA-6568; The log cleaner should check the partition state before r…
                </div><div><b>body:</b> …emoving it from the inProgress map.

The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.

### Committer Checklist (excluded from commit message)
- [ ] Verify design and implementation 
- [ ] Verify test coverage and CI build status
- [ ] Verify documentation (including upgrade notes)

                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                ping @ijuma @hachikuji 
              </div></li><li><div><div><b>body:</b> @hachikuji Thanks for the review. Yes, I agree it would be cleaner to have a separate set to keep the paused partitions.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                @hachikuji Do you think we should backport this patch to 1.0 and 0.11? 0.10.1 and above are also impacted, but they might be a little too old. That said, our policy is 2 year's support, so maybe we still want to fix versions prior to 0.11.
              </div></li><li><div>
                @becketqin I think 1.0 and 0.11 are enough.
              </div></li><li><div>
                @ijuma Sounds good.
              </div></li><li><div>
                @becketqin I picked back to 0.11.0. Probably worth double-checking the commits to 0.11.0 and 1.0 since there were some trivial conflicts to resolve.
              </div></li><li><div>
                @hachikuji Thanks for merging and backporting. The commits look good to me.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div><div><b>body:</b> nit: remove space after `tp`. Same in `setCleaningState`.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Maybe we may as well assert the offset was checkpointed as well?
              </div></li><li><div>
                The other exceptional case is if `inProgress` does not contain the partition.
              </div></li><li><div>
                the inProgress should always contain the partition. Otherwise something is wrong and it is an IllegalStateException.
              </div></li><li><div><div><b>body:</b> Right. I'm saying we can add a test for this case.
                </div><div><b>label:</b> test
                </div></div></li><li><div>
                Ah, got it. Added the test.
              </div></li><li><div>
                You can replace 5 lines with something like:

```scala
intercept[IllegalStateException](cleanerManager.doneDeleting(tp))
```

Similar for the other 2 places.
              </div></li><li><div><div><b>body:</b> It would be a bit confusing if `s` is `None`. Maybe we'd want to have an explicit message for that case. Same for the other method.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> LogCleanerManager.doneDeleting() should check the partition state before deleting the in progress partition
                </div><div><b>description:</b> {{LogCleanerManager.doneDeleting()}} removes the partition from the {{inProgress}}&nbsp;map without checking if the partition is paused or not. This will cause the paused partition state to be lost, and may&nbsp;also cause another thread calling {{LogCleanerManager.abortAndPauseCleaning()}}&nbsp;to block indefinitely waiting on the partition state to become paused.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> LogCleanerManager.doneDeleting() should check the partition state before deleting the in progress partition
                </div><div><b>description:</b> {{LogCleanerManager.doneDeleting()}} removes the partition from the {{inProgress}}&nbsp;map without checking if the partition is paused or not. This will cause the paused partition state to be lost, and may&nbsp;also cause another thread calling {{LogCleanerManager.abortAndPauseCleaning()}}&nbsp;to block indefinitely waiting on the partition state to become paused.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                becketqin opened a new pull request #4580: KAFKA-6568; The log cleaner should check the partition state before r…
URL: https://github.com/apache/kafka/pull/4580
 
 
   …emoving it from the inProgress map.
   
   The log cleaner should not naively remove the partition from in progress map without checking the partition state. This may cause the other thread calling `LogCleanerManager.abortAndPauseCleaning()` to hang in definitely.
   
   ### Committer Checklist (excluded from commit message)
   - [ ] Verify design and implementation 
   - [ ] Verify test coverage and CI build status
   - [ ] Verify documentation (including upgrade notes)
   

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                hachikuji closed pull request #4580: KAFKA-6568; The log cleaner should check the partition state before r…
URL: https://github.com/apache/kafka/pull/4580
 
 
   

This is a PR merged from a forked repository.
As GitHub hides the original diff on merge, it is displayed below for
the sake of provenance:

As this is a foreign pull request (from a fork), the diff is supplied
below (as it won't show otherwise due to GitHub magic):

diff --git a/core/src/main/scala/kafka/log/LogCleanerManager.scala b/core/src/main/scala/kafka/log/LogCleanerManager.scala
index c3d3892aef9..b23107be491 100755
--- a/core/src/main/scala/kafka/log/LogCleanerManager.scala
+++ b/core/src/main/scala/kafka/log/LogCleanerManager.scala
@@ -96,6 +96,23 @@ private[log] class LogCleanerManager(val logDirs: Seq[File],
     }
   }
 
+  /**
+    * Package private for unit test. Get the cleaning state of the partition.
+    */
+  private[log] def cleaningState(tp: TopicPartition): Option[LogCleaningState] = {
+    inLock(lock) {
+      inProgress.get(tp)
+    }
+  }
+
+  /**
+    * Package private for unit test. Set the cleaning state of the partition.
+    */
+  private[log] def setCleaningState(tp: TopicPartition, state: LogCleaningState): Unit = {
+    inLock(lock) {
+      inProgress.put(tp, state)
+    }
+  }
 
    /**
     * Choose the log to clean next and add it to the in-progress set. We recompute this
@@ -290,11 +307,11 @@ private[log] class LogCleanerManager(val logDirs: Seq[File],
    */
   def doneCleaning(topicPartition: TopicPartition, dataDir: File, endOffset: Long) {
     inLock(lock) {
-      inProgress(topicPartition) match {
-        case LogCleaningInProgress =&gt;
+      inProgress.get(topicPartition) match {
+        case Some(LogCleaningInProgress) =&gt;
           updateCheckpoints(dataDir, Option(topicPartition, endOffset))
           inProgress.remove(topicPartition)
-        case LogCleaningAborted =&gt;
+        case Some(LogCleaningAborted) =&gt;
           inProgress.put(topicPartition, LogCleaningPaused)
           pausedCleaningCond.signalAll()
         case s =&gt;
@@ -305,7 +322,15 @@ private[log] class LogCleanerManager(val logDirs: Seq[File],
 
   def doneDeleting(topicPartition: TopicPartition): Unit = {
     inLock(lock) {
-      inProgress.remove(topicPartition)
+      inProgress.get(topicPartition) match {
+        case Some(LogCleaningInProgress) =&gt;
+          inProgress.remove(topicPartition)
+        case Some(LogCleaningAborted) =&gt;
+          inProgress.put(topicPartition, LogCleaningPaused)
+          pausedCleaningCond.signalAll()
+        case s =&gt;
+          throw new IllegalStateException(s"In-progress partition $topicPartition cannot be in $s state.")
+      }
     }
   }
 }
@@ -344,7 +369,7 @@ private[log] object LogCleanerManager extends Logging {
         offset
       }
     }
-    
+
     val compactionLagMs = math.max(log.config.compactionLagMs, 0L)
 
     // find first segment that cannot be cleaned
diff --git a/core/src/test/scala/unit/kafka/log/LogCleanerManagerTest.scala b/core/src/test/scala/unit/kafka/log/LogCleanerManagerTest.scala
index 114602919ea..42a447a2b16 100644
--- a/core/src/test/scala/unit/kafka/log/LogCleanerManagerTest.scala
+++ b/core/src/test/scala/unit/kafka/log/LogCleanerManagerTest.scala
@@ -215,6 +215,76 @@ class LogCleanerManagerTest extends JUnitSuite with Logging {
     assertEquals(4L, cleanableOffsets._2)
   }
 
+  @Test
+  def testDoneCleaning(): Unit = {
+    val logProps = new Properties()
+    logProps.put(LogConfig.SegmentBytesProp, 1024: java.lang.Integer)
+    val log = makeLog(config = LogConfig.fromProps(logConfig.originals, logProps))
+    while(log.numberOfSegments &lt; 8)
+      log.appendAsLeader(records(log.logEndOffset.toInt, log.logEndOffset.toInt, time.milliseconds()), leaderEpoch = 0)
+
+    val cleanerManager: LogCleanerManager = createCleanerManager(log)
+
+    val tp = new TopicPartition("log", 0)
+    try {
+      cleanerManager.doneCleaning(tp, log.dir, 1)
+    } catch {
+      case _ : IllegalStateException =&gt;
+      case _ : Throwable =&gt; fail("Should have thrown IllegalStateException.")
+    }
+
+    try {
+      cleanerManager.setCleaningState(tp, LogCleaningPaused)
+      cleanerManager.doneCleaning(tp, log.dir, 1)
+    } catch {
+      case _ : IllegalStateException =&gt;
+      case _ : Throwable =&gt; fail("Should have thrown IllegalStateException.")
+    }
+
+    cleanerManager.setCleaningState(tp, LogCleaningInProgress)
+    cleanerManager.doneCleaning(tp, log.dir, 1)
+    assertTrue(cleanerManager.cleaningState(tp).isEmpty)
+    assertTrue(cleanerManager.allCleanerCheckpoints.get(tp).nonEmpty)
+
+    cleanerManager.setCleaningState(tp, LogCleaningAborted)
+    cleanerManager.doneCleaning(tp, log.dir, 1)
+    assertEquals(LogCleaningPaused, cleanerManager.cleaningState(tp).get)
+    assertTrue(cleanerManager.allCleanerCheckpoints.get(tp).nonEmpty)
+  }
+
+  @Test
+  def testDoneDeleting(): Unit = {
+    val records = TestUtils.singletonRecords("test".getBytes, key="test".getBytes)
+    val log: Log = createLog(records.sizeInBytes * 5, LogConfig.Compact + "," + LogConfig.Delete)
+    val cleanerManager: LogCleanerManager = createCleanerManager(log)
+
+    val tp = new TopicPartition("log", 0)
+
+    try {
+      cleanerManager.doneDeleting(tp)
+    } catch {
+      case _ : IllegalStateException =&gt;
+      case _ : Throwable =&gt; fail("Should have thrown IllegalStateException.")
+    }
+
+    try {
+      cleanerManager.setCleaningState(tp, LogCleaningPaused)
+      cleanerManager.doneDeleting(tp)
+    } catch {
+      case _ : IllegalStateException =&gt;
+      case _ : Throwable =&gt; fail("Should have thrown IllegalStateException.")
+    }
+
+    cleanerManager.setCleaningState(tp, LogCleaningInProgress)
+    cleanerManager.doneDeleting(tp)
+    assertTrue(cleanerManager.cleaningState(tp).isEmpty)
+
+    cleanerManager.setCleaningState(tp, LogCleaningAborted)
+    cleanerManager.doneDeleting(tp)
+    assertEquals(LogCleaningPaused, cleanerManager.cleaningState(tp).get)
+
+  }
+
   private def createCleanerManager(log: Log): LogCleanerManager = {
     val logs = new Pool[TopicPartition, Log]()
     logs.put(new TopicPartition("log", 0), log)


 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                becketqin opened a new pull request #4592: MINOR follow-up for KAFKA-6568
URL: https://github.com/apache/kafka/pull/4592
 
 
   @ijuma This is the minor follow-up patch for #4580 to address your comments.
   
   ### Committer Checklist (excluded from commit message)
   - [ ] Verify design and implementation 
   - [ ] Verify test coverage and CI build status
   - [ ] Verify documentation (including upgrade notes)
   

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li><li><div>
                ijuma closed pull request #4592: MINOR follow-up for KAFKA-6568
URL: https://github.com/apache/kafka/pull/4592
 
 
   

This is a PR merged from a forked repository.
As GitHub hides the original diff on merge, it is displayed below for
the sake of provenance:

As this is a foreign pull request (from a fork), the diff is supplied
below (as it won't show otherwise due to GitHub magic):

diff --git a/core/src/main/scala/kafka/log/LogCleanerManager.scala b/core/src/main/scala/kafka/log/LogCleanerManager.scala
index b23107be491..223c6119654 100755
--- a/core/src/main/scala/kafka/log/LogCleanerManager.scala
+++ b/core/src/main/scala/kafka/log/LogCleanerManager.scala
@@ -314,6 +314,8 @@ private[log] class LogCleanerManager(val logDirs: Seq[File],
         case Some(LogCleaningAborted) =&gt;
           inProgress.put(topicPartition, LogCleaningPaused)
           pausedCleaningCond.signalAll()
+        case None =&gt;
+          throw new IllegalStateException(s"State for partition $topicPartition should exist.")
         case s =&gt;
           throw new IllegalStateException(s"In-progress partition $topicPartition cannot be in $s state.")
       }
@@ -328,6 +330,8 @@ private[log] class LogCleanerManager(val logDirs: Seq[File],
         case Some(LogCleaningAborted) =&gt;
           inProgress.put(topicPartition, LogCleaningPaused)
           pausedCleaningCond.signalAll()
+        case None =&gt;
+          throw new IllegalStateException(s"State for partition $topicPartition should exist.")
         case s =&gt;
           throw new IllegalStateException(s"In-progress partition $topicPartition cannot be in $s state.")
       }
diff --git a/core/src/test/scala/unit/kafka/log/LogCleanerManagerTest.scala b/core/src/test/scala/unit/kafka/log/LogCleanerManagerTest.scala
index 42a447a2b16..7455763f5b7 100644
--- a/core/src/test/scala/unit/kafka/log/LogCleanerManagerTest.scala
+++ b/core/src/test/scala/unit/kafka/log/LogCleanerManagerTest.scala
@@ -226,20 +226,10 @@ class LogCleanerManagerTest extends JUnitSuite with Logging {
     val cleanerManager: LogCleanerManager = createCleanerManager(log)
 
     val tp = new TopicPartition("log", 0)
-    try {
-      cleanerManager.doneCleaning(tp, log.dir, 1)
-    } catch {
-      case _ : IllegalStateException =&gt;
-      case _ : Throwable =&gt; fail("Should have thrown IllegalStateException.")
-    }
-
-    try {
-      cleanerManager.setCleaningState(tp, LogCleaningPaused)
-      cleanerManager.doneCleaning(tp, log.dir, 1)
-    } catch {
-      case _ : IllegalStateException =&gt;
-      case _ : Throwable =&gt; fail("Should have thrown IllegalStateException.")
-    }
+    intercept[IllegalStateException](cleanerManager.doneCleaning(tp, log.dir, 1))
+
+    cleanerManager.setCleaningState(tp, LogCleaningPaused)
+    intercept[IllegalStateException](cleanerManager.doneCleaning(tp, log.dir, 1))
 
     cleanerManager.setCleaningState(tp, LogCleaningInProgress)
     cleanerManager.doneCleaning(tp, log.dir, 1)
@@ -260,20 +250,10 @@ class LogCleanerManagerTest extends JUnitSuite with Logging {
 
     val tp = new TopicPartition("log", 0)
 
-    try {
-      cleanerManager.doneDeleting(tp)
-    } catch {
-      case _ : IllegalStateException =&gt;
-      case _ : Throwable =&gt; fail("Should have thrown IllegalStateException.")
-    }
-
-    try {
-      cleanerManager.setCleaningState(tp, LogCleaningPaused)
-      cleanerManager.doneDeleting(tp)
-    } catch {
-      case _ : IllegalStateException =&gt;
-      case _ : Throwable =&gt; fail("Should have thrown IllegalStateException.")
-    }
+    intercept[IllegalStateException](cleanerManager.doneDeleting(tp))
+
+    cleanerManager.setCleaningState(tp, LogCleaningPaused)
+    intercept[IllegalStateException](cleanerManager.doneDeleting(tp))
 
     cleanerManager.setCleaningState(tp, LogCleaningInProgress)
     cleanerManager.doneDeleting(tp)


 

----------------------------------------------------------------
This is an automated message from the Apache Git Service.
To respond to the message, please log on GitHub and use the
URL above to go to the specific comment.
 
For queries about this service, please contact Infrastructure at:
users@infra.apache.org

              </div></li></ol></div></div></html>