<!DOCTYPE html><html><div class="item-title">
        Item 136
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                *
   * Get the path specific to this auxiliary service to use for recovery.
   *
   * @return state storage path or null if recovery is not enabled
   
              </div></li><li><div>
                *
   * Set the path for this auxiliary service to use for storing state
   * that will be used during recovery.
   *
   * @param recoveryPath where recoverable state should be stored
   
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> YARN-1757. NM Recovery. Auxiliary service support. (Jason Lowe via kasha)
                </div><div><b>message:</b> YARN-1757. NM Recovery. Auxiliary service support. (Jason Lowe via kasha)

git-svn-id: https://svn.apache.org/repos/asf/hadoop/common/branches/branch-2@1585784 13f79535-47bb-0310-9956-ffa450edef68

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> NM Recovery. Auxiliary service support.
                </div><div><b>description:</b> There needs to be a mechanism for communicating to auxiliary services whether nodemanager recovery is enabled and where they should store their state.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Patch to have the nodemanager create an aux-service-specific path under the specified NM recovery directory where an aux service can store recoverable state.  The presence or absence of this path indicates whether NM recovery is enabled (or aux service could check conf directly).
              </div></li><li><div>
                {color:red}-1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12630989/YARN-1757.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager:

                  org.apache.hadoop.yarn.server.nodemanager.TestNodeManagerReboot
                  org.apache.hadoop.yarn.server.nodemanager.webapp.TestNMWebServer
                  org.apache.hadoop.yarn.server.nodemanager.containermanager.monitor.TestContainersMonitor
                  org.apache.hadoop.yarn.server.nodemanager.containermanager.launcher.TestContainerLaunch
                  org.apache.hadoop.yarn.server.nodemanager.containermanager.logaggregation.TestLogAggregationService
                  org.apache.hadoop.yarn.server.nodemanager.TestNodeManagerShutdown
                  org.apache.hadoop.yarn.server.nodemanager.TestNodeStatusUpdater
                  org.apache.hadoop.yarn.server.nodemanager.containermanager.TestContainerManager

                                      The following test timeouts occurred in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager:

org.apache.hadoop.yarn.server.nodemanager.TestNodeManagerResync

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/3175//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/3175//console

This message is automatically generated.
              </div></li><li><div>
                Test failures are of the "Bind address already in use" variety, and the NM tests run clean for me locally.  Uploading the same patch again to see if it was a sporadic failure.
              </div></li><li><div>
                {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12631035/YARN-1757.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/3178//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/3178//console

This message is automatically generated.
              </div></li><li><div><div><b>body:</b> Thanks Jason. Looks mostly good - minor comments and nits. Feel free to ignore nits you don't agree with. 

Comments:
# Nit: YarnConfiguration: We might want to add a NM_RECOVERY_PREFIX for all recovery related configs?
# The default recovery-dir should probably be something more specific to nm-recovery - {{/tmp/yarn-nm-recovery}}? 
# Nit: Should we add an NMUtils class for static helper methods like isRecoveryEnabled()?
# Nit: Rename variables to stateStore instead of stateStorage - that would go with the conventions used in RM better, and is shorter :)
{code}
    Path stateStorageRoot = null;
    FileSystem stateStorageFs = null;
{code}
# Nit: AuxServices#createStorageDir: May be add a comment to say control flow through FileNotFound is cheaper than explicitly checking if the file exists?
# NameNode should also use something similar, instead of directly creating the directory? May be, another candidate to move to NMUtils? 
# TestAuxServices: We should check if we have two directories created too?
{code}
      final AuxServices aux = new AuxServices();
      aux.init(conf);
      Assert.assertEquals(2, aux.getServices().size());
      aux.close();
{code}
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> Thanks for the review, Karthik!

bq. Nit: YarnConfiguration: We might want to add a NM_RECOVERY_PREFIX for all recovery related configs?

Done.

bq. The default recovery-dir should probably be something more specific to nm-recovery - /tmp/yarn-nm-recovery?

Yes, I did this in yarn-default.xml but forgot to update the default in YarnConfiguration.  Ended up removing the default and just rely on yarn-default.xml, much like the fs uri for RM's file system state store.

bq. Nit: Should we add an NMUtils class for static helper methods like isRecoveryEnabled()?

It's just a boolean config, very straightforward to access -- not sure an NMUtils method adds a lot of value here.

bq. Nit: Rename variables to stateStore instead of stateStorage - that would go with the conventions used in RM better, and is shorter

Done.

bq. Nit: AuxServices#createStorageDir: May be add a comment to say control flow through FileNotFound is cheaper than explicitly checking if the file exists?
bq. NameNode should also use something similar, instead of directly creating the directory? May be, another candidate to move to NMUtils?

Actually I ended up just using the straightforward mkdirs approach.  It already checks for existence and updates the permissions of the directory.  Since this is the local filesystem we're talking about, there shouldn't be any significant performance implications here and no need for a separate method to create directories.

bq. TestAuxServices: We should check if we have two directories created too?

It's already checking in each service init whether a directory specific to that service is being created, but I went ahead and added a check for two aux service recovery directories.

                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                {color:green}+1 overall{color}.  Here are the results of testing the latest attachment 
  http://issues.apache.org/jira/secure/attachment/12639033/YARN-1757-v2.patch
  against trunk revision .

    {color:green}+1 @author{color}.  The patch does not contain any @author tags.

    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.

    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.

    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.

    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.

    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.

    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.

    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager.

    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.

Test results: https://builds.apache.org/job/PreCommit-YARN-Build/3522//testReport/
Console output: https://builds.apache.org/job/PreCommit-YARN-Build/3522//console

This message is automatically generated.
              </div></li><li><div>
                Thanks Jason. Latest patch looks good to me.

+1. Will commit later today. We are doing all of YARN-1336 on trunk/branch-2 and not on a feature branch, right? 
              </div></li><li><div>
                bq. We are doing all of YARN-1336 on trunk/branch-2 and not on a feature branch, right? 

Yes, I was not planning on doing a feature branch.  Feature branches are easy to iterate on but difficult to keep current and get the final merge done.  I think this feature can be broken up into small enough pieces that they can be reviewed and committed on their own merits and provide useful functionality in the interim.  There's usefulness in recovering just aux services (e.g.: can keep shuffling for previous jobs) or just localized resources (don't have to relocalize across an NM reboot).
              </div></li><li><div>
                Committing this now. Changed summary to reflect commit message. Would be nice to have commit messages of all subtasks of YARN-1336 have a common prefix :)
              </div></li><li><div>
                Thanks Jason. Committed this to trunk and branch-2.
              </div></li><li><div>
                SUCCESS: Integrated in Hadoop-trunk-Commit #5469 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/5469/])
YARN-1757. NM Recovery. Auxiliary service support. (Jason Lowe via kasha) (kasha: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;view=rev&amp;rev=1585783)
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api/src/main/java/org/apache/hadoop/yarn/conf/YarnConfiguration.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api/src/main/java/org/apache/hadoop/yarn/server/api/AuxiliaryService.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common/src/main/resources/yarn-default.xml
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/NodeManager.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/AuxServices.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/TestAuxServices.java

              </div></li><li><div>
                SUCCESS: Integrated in Hadoop-Yarn-trunk #534 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/534/])
YARN-1757. NM Recovery. Auxiliary service support. (Jason Lowe via kasha) (kasha: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;view=rev&amp;rev=1585783)
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api/src/main/java/org/apache/hadoop/yarn/conf/YarnConfiguration.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api/src/main/java/org/apache/hadoop/yarn/server/api/AuxiliaryService.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common/src/main/resources/yarn-default.xml
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/NodeManager.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/AuxServices.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/TestAuxServices.java

              </div></li><li><div>
                FAILURE: Integrated in Hadoop-Mapreduce-trunk #1752 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1752/])
YARN-1757. NM Recovery. Auxiliary service support. (Jason Lowe via kasha) (kasha: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;view=rev&amp;rev=1585783)
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api/src/main/java/org/apache/hadoop/yarn/conf/YarnConfiguration.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api/src/main/java/org/apache/hadoop/yarn/server/api/AuxiliaryService.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common/src/main/resources/yarn-default.xml
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/NodeManager.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/AuxServices.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/TestAuxServices.java

              </div></li><li><div>
                SUCCESS: Integrated in Hadoop-Hdfs-trunk #1726 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1726/])
YARN-1757. NM Recovery. Auxiliary service support. (Jason Lowe via kasha) (kasha: http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;view=rev&amp;rev=1585783)
* /hadoop/common/trunk/hadoop-yarn-project/CHANGES.txt
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api/src/main/java/org/apache/hadoop/yarn/conf/YarnConfiguration.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-api/src/main/java/org/apache/hadoop/yarn/server/api/AuxiliaryService.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-common/src/main/resources/yarn-default.xml
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/NodeManager.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/AuxServices.java
* /hadoop/common/trunk/hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/test/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/TestAuxServices.java

              </div></li></ol></div></div></html>