<!DOCTYPE html><html><div class="item-title">
        Item 50
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 Package coderx contains coders for primitive types that aren't included
 in the beam model.
              </div></li><li><div>
                go:generate go install github.com/apache/beam/sdks/go/cmd/starcgen
go:generate starcgen --package=coderx --identifiers=encString,decString,encUint32,decUint32,encInt32,decInt32,encUint64,decUint64,encInt64,decInt64,encVarIntZ,decVarIntZ,encVarUintZ,decVarUintZ,encFloat,decFloat
              </div></li><li><div>
                 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.
 The ASF licenses this file to You under the Apache License, Version 2.0
 (the "License"); you may not use this file except in compliance with
 the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
              </div></li><li><div>
                 NewString returns a coder for the string type. It uses the native
 []byte to string conversion.
              </div></li><li><div>
                 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.
 The ASF licenses this file to You under the Apache License, Version 2.0
 (the "License"); you may not use this file except in compliance with
 the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
              </div></li><li><div>
                 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.
 The ASF licenses this file to You under the Apache License, Version 2.0
 (the "License"); you may not use this file except in compliance with
 the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
              </div></li><li><div>
                 TestMain invokes ptest.Main to allow running these tests on
 non-direct runners.
              </div></li><li><div>
                 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.
 The ASF licenses this file to You under the Apache License, Version 2.0
 (the "License"); you may not use this file except in compliance with
 the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
              </div></li><li><div><div><b>comment:</b>  FixedReStream is a simple in-memory ReStream.
 Open returns the a Stream from the start of the in-memory ReStream.
 Close releases the buffer, closing the stream.
 Arguably this should be:
   reflect.ValueOf(v).Convert(to).Interface()
 but this isn't desirable as it would add avoidable overhead to
 functions where it applies. A user will have better performance
 by explicitly doing the type conversion in their code, which
 the error will indicate. Slow Magic vs Fast &amp; Explicit.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> [BEAM-3580] Use a custom coder for strings.
                </div><div><b>message:</b> [BEAM-3580] Use a custom coder for strings.

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Do not use Go BytesCoder to encode string
                </div><div><b>description:</b> We should not use the same built-in coder for two different types. It creates the need for conversions at inopportune times in the runtime.

&nbsp;

One option would be to&nbsp;a custom coder that shares encoding with bytes, given that bytes are length prefixed.
                </div></div></li><li><div><div><b>summary:</b> Do not use Go BytesCoder to encode string
                </div><div><b>description:</b> We should not use the same built-in coder for two different types. It creates the need for conversions at inopportune times in the runtime.

&nbsp;

One option would be to&nbsp;a custom coder that shares encoding with bytes, given that bytes are length prefixed.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Do not use Go BytesCoder to encode string
                </div><div><b>description:</b> We should not use the same built-in coder for two different types. It creates the need for conversions at inopportune times in the runtime.

&nbsp;

One option would be to&nbsp;a custom coder that shares encoding with bytes, given that bytes are length prefixed.
                </div></div></li><li><div><div><b>summary:</b> Do not use Go BytesCoder to encode string
                </div><div><b>description:</b> We should not use the same built-in coder for two different types. It creates the need for conversions at inopportune times in the runtime.

&nbsp;

One option would be to&nbsp;a custom coder that shares encoding with bytes, given that bytes are length prefixed.
                </div></div></li><li><div><div><b>summary:</b> Do not use Go BytesCoder to encode string
                </div><div><b>description:</b> We should not use the same built-in coder for two different types. It creates the need for conversions at inopportune times in the runtime.

&nbsp;

One option would be to&nbsp;a custom coder that shares encoding with bytes, given that bytes are length prefixed.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>summary:</b> Do not use Go BytesCoder to encode string
                </div><div><b>description:</b> We should not use the same built-in coder for two different types. It creates the need for conversions at inopportune times in the runtime.

&nbsp;

One option would be to&nbsp;a custom coder that shares encoding with bytes, given that bytes are length prefixed.
                </div></div></li><li><div><div><b>summary:</b> Do not use Go BytesCoder to encode string
                </div><div><b>description:</b> We should not use the same built-in coder for two different types. It creates the need for conversions at inopportune times in the runtime.

&nbsp;

One option would be to&nbsp;a custom coder that shares encoding with bytes, given that bytes are length prefixed.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Seems that&nbsp;this breaks beam.Combine(s, combineFn, PCollection&lt;string&gt;)&nbsp;in&nbsp;certain cases.&nbsp;

When entering Combine.addInput(), the value is of type []byte.&nbsp;It's&nbsp;then converted to the specified input type, which is supposed to be "string"&nbsp;[1]. But that type&nbsp;could be a universal type, e.g.&nbsp;when we define: "AddInput(a accum, val beam.T) accum". In that case, the conversion is a no-op, and we&nbsp;call AddInput() with []byte, causing a type mismatch.

Using a separate&nbsp;coder that encodes string -&gt; []byte, and decodes []byte -&gt; string should solve this problem. I will try that and see if it works.

This also makes me thinking whether we should&nbsp;substitute universal types in CombineFn to concrete ones before/at runtime?

[1]&nbsp;[https://github.com/apache/beam/blob/master/sdks/go/pkg/beam/core/runtime/exec/combine.go#L219]
              </div></li><li><div><div><b>body:</b> You're right though, a dedicated custom coder for strings would resolve this. In principle this would also be solvable through the User Defined Coders work.
An alternative work around would be to do the converters, but those are likely unnecessary altogether if there was a dedicated coder for strings which would avoid using the converts on all the paths.

That can be fixed by adding conversions prior to the invocation of the combine operations which isn't currently done via the invoker in all instances (such as the binary merge fast path),

See here:

[https://github.com/apache/beam/blob/master/sdks/go/pkg/beam/core/runtime/exec/fn.go#L132]

Note: I'm likely going to be changing the combines soon so the code generator will be able to speed up combines for the AddInput and MergeAccumulators cases.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I'm in the process of fixing Top, and I ran into this, so I'm going to take this unless [~htyleo] has any objections. You'll get&nbsp;the review however once it's verified and tested properly
              </div></li><li><div>
                Sounds good. Sorry that I didn't get the time to fix this after your previous review.
              </div></li><li><div><div><b>body:</b> There may be one or two no longer necessary []byte -&gt; string conversions and vice versa that I missed, but they can be cleaned up as they're found.
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div></div></html>