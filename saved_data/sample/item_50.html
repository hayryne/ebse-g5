<!DOCTYPE html><html><div class="item-title">
        Item 50
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                suppress MavenModelInspection 
              </div></li><li><div>
                 Keep aligned with preqrequisite section below. 
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> This closes #2096
                </div><div><b>message:</b> This closes #2096

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol><li><div><div><b>title:</b> [BEAM-1092] Shade commonly used libraries (e.g. Guava) to avoid class conflicts
                </div><div><b>body:</b> Be sure to do all of the following to help us incorporate your contribution
quickly and easily:

 - [x] Make sure the PR title is formatted like:
   `[BEAM-&lt;Jira issue #&gt;] Description of pull request`
 - [x] Make sure tests pass via `mvn clean verify`. (Even better, enable
       Travis-CI on your fork and ensure the whole test matrix passes).
 - [x] Replace `&lt;Jira issue #&gt;` in the title with the actual Jira issue
       number, if there is one.
 - [ ] If this contribution is large, please file an Apache
       [Individual Contributor License Agreement](https://www.apache.org/licenses/icla.txt).

---

                </div></div></li></ol></div><div><b>github_pulls_comments:</b> <ol><li><div>
                R: @davorbonaci @dhalperi 
CC: @francesperry @jbonofre
              </div></li><li><div>
                
[![Coverage Status](https://coveralls.io/builds/10314239/badge)](https://coveralls.io/builds/10314239)

Coverage decreased (-0.01%) to 69.303% when pulling **ff322937ffddcf3f3b2333534327ff2d11a164ab on aviemzur:shade-guava-generically** into **3d0fe853941ec4a6190ea7891d063674b5eef067 on apache:master**.

              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/beam_PreCommit_Java_MavenInstall/7813/
--none--
              </div></li><li><div>
                We looked into this exact approach in the past, and rolled it back because `project.artifactId` is not a legal java package name (e.g., if it included `-`). Did you find a way to solve this?
              </div></li><li><div>
                (#744)
              </div></li><li><div>
                I can replace the `-` with `.` programatically using build helper maven plugin.
              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/beam_PreCommit_Java_MavenInstall/7831/&lt;h2&gt;Build result: ABORTED&lt;/span&gt;&lt;/h2&gt;[...truncated 833.54 KB...]	... 31 moreCaused by: java.lang.RuntimeException: The forked VM terminated without properly saying goodbye. VM crash or System.exit called?Command was /bin/sh -c cd /home/jenkins/jenkins-slave/workspace/beam_PreCommit_Java_MavenInstall@2/sdks/java/io/hbase &amp;&amp; /usr/local/asfpackages/java/jdk1.8.0_121/jre/bin/java org.apache.maven.surefire.booter.ForkedBooter /home/jenkins/jenkins-slave/workspace/beam_PreCommit_Java_MavenInstall@2/sdks/java/io/hbase/target/surefire/surefire7450086805414423461tmp /home/jenkins/jenkins-slave/workspace/beam_PreCommit_Java_MavenInstall@2/sdks/java/io/hbase/target/surefire/surefire_83942865920716290877tmp	at org.apache.maven.plugin.surefire.booterclient.ForkStarter.fork(ForkStarter.java:590)	at org.apache.maven.plugin.surefire.booterclient.ForkStarter.fork(ForkStarter.java:460)	at org.apache.maven.plugin.surefire.booterclient.ForkStarter.run(ForkStarter.java:229)	at org.apache.maven.plugin.surefire.booterclient.ForkStarter.run(ForkStarter.java:201)	at org.apache.maven.plugin.surefire.AbstractSurefireMojo.executeProvider(AbstractSurefireMojo.java:1026)	at org.apache.maven.plugin.surefire.AbstractSurefireMojo.executeAfterPreconditionsChecked(AbstractSurefireMojo.java:862)	at org.apache.maven.plugin.surefire.AbstractSurefireMojo.execute(AbstractSurefireMojo.java:755)	at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo(DefaultBuildPluginManager.java:134)	... 32 more2017-02-24T22:25:19.043 [ERROR] 2017-02-24T22:25:19.043 [ERROR] Re-run Maven using the -X switch to enable full debug logging.2017-02-24T22:25:19.043 [ERROR] 2017-02-24T22:25:19.043 [ERROR] For more information about the errors and possible solutions, please read the following articles:2017-02-24T22:25:19.043 [ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/PluginExecutionException2017-02-24T22:25:19.043 [ERROR] 2017-02-24T22:25:19.043 [ERROR] After correcting the problems, you can resume the build with the command2017-02-24T22:25:19.043 [ERROR]   mvn &lt;goals&gt; -rf :beam-sdks-java-io-hbaseBuild was abortedchannel stoppedSetting status of af0c88f43508c87052d0b9405102b6ff5b7b65c2 to FAILURE with url https://builds.apache.org/job/beam_PreCommit_Java_MavenInstall/7831/ and message: 'Build finished. 'Using context: Jenkins: Maven clean install
--none--
              </div></li><li><div>
                Retest this please.
              </div></li><li><div>
                
[![Coverage Status](https://coveralls.io/builds/10326524/badge)](https://coveralls.io/builds/10326524)

Coverage increased (+0.01%) to 69.327% when pulling **af0c88f43508c87052d0b9405102b6ff5b7b65c2 on aviemzur:shade-guava-generically** into **3d0fe853941ec4a6190ea7891d063674b5eef067 on apache:master**.

              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/beam_PreCommit_Java_MavenInstall/7857/
--none--
              </div></li><li><div>
                @dhalperi Addressed your comment in my latest commit. PTAL?
              </div></li><li><div>
                Re: testlib -- I did some GitHub blame/history diving and found JIRA https://issues.apache.org/jira/browse/BEAM-557 and https://github.com/apache/beam/pull/832 .

Maybe @swegner has more context about which specific ways the Guava testlib is a public dependency.
              </div></li><li><div><div><b>body:</b> Re: general approach.

I see two improvements:

1. Providing a simple, uniform way to name shaded artifacts by establishing a central rewritten `artifactId`. This is succeeding where #744 failed!
2. Providing a centralized way to ensure that Guava is not on the public API surface of any module.

I see two downsides:

1. Extra executions for modules that don't depend on Guava. This will slow the build.
2. Modules that need to shade more than just Guava will have to override the shading config. They may actually get it wrong after that, so Guava might still be exposed. -- Thus, while this reduces the amount of config necessary in common cases, does guarantee solution.

I would probably:
* move the shading config back into individual modules. build perf + accuracy. But use the new `artifactId` trick to make the config more uniform.
* find a better way to actually verify that the final output artifacts don't expose Guava. (out of scope for this PR.) This is in-line with prior PR comments.

In otherwords, I would probably take improvement 1, but not 2. 1 is a clear win, but 2 has some drawbacks and doesn't quite guarantee success to justify those drawbacks IMO.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Another good opinion to get would be @davorbonaci .
              </div></li><li><div>
                @dhalperi I understand the concerns you raise. I'll try to address them from my point of view.

&gt; 1. Extra executions for modules that don't depend on Guava. This will slow the build.

Many of the modules already shade, so regarding slowing down of the build Iâ€™m not sure this concern is that pertinent if new way of shading is an improvement.

&gt; 2. Modules that need to shade more than just Guava will have to override the shading config. They may 
&gt; actually get it wrong after that, so Guava might still be exposed. -- Thus, while this reduces the amount of config necessary in common cases, does guarantee solution.

I agree that human error could cause Guava to be forgotten from shading configuration added to child modules, but is this different than today? Can this human error not happen now?
              </div></li><li><div><div><b>body:</b> I'm not totally sold on the premise that we should shade Guava in every single module. A couple of reasons:
* We now have ~30 modules. We'll probably have 50+ sometime this year. Guava is not that small in size -- bringing in so many copies is just wasteful for a simple call to, say, `Preconditions`. Minimization could mitigate this concern, but I'm yet-to-be-convinced it works well for libraries.
* We care that Guava is not leaked to our users -- this is totally legit. On the other hand, we don't have a strong reason to avoid Guava on an internal interface between, say, `runners-core` and `core-sdk`. It just doesn't matter to users. Of course, taking a stronger stance can be fine, but I'm a little worried it will bite us (for no real reason).
* Build time.

Separately, the amount of "magic" worries me too. This will work perfectly in Maven, but what happens when someone imports it into Eclipse, IntelliJ or elsewhere? At least in some IDEs, it will fail.

On the other hand, I'm really strongly in favor of one common configuration. There's literally zero chance that this will work if this configuration is offloaded to every single module. This one outweighs them all for me. (And, I was bitten by Guava 19 vs. 20 just today -- so, I know the pain.)

In summary, I'm leaning towards +1 on this. However, I'd be more comfortable if we were explicit in saying:
* how much the build time has gone up
* how much the total bundled jar, across the project, has gone up
* to investigate minimization (separately from this PR)
* that we'll make enforcement that Guava in not brought in transitively (which is currently broken at least in one module).
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Build time (MacBook Pro, skipping tests)
-
**Before:** 02:13 min
**After:** 02:35 min

Jar size (Sum of all jars generated)
-
**Before:** 93.93 MB
**After:** 151.34 MB
              </div></li><li><div>
                Build time -- less than I would have forecasted. SGTM.

Jar size -- more than I would have forecasted -- it is 50% more. I think minimization is in order.
              </div></li><li><div>
                
[![Coverage Status](https://coveralls.io/builds/10580212/badge)](https://coveralls.io/builds/10580212)

Coverage decreased (-0.003%) to 70.14% when pulling **7eb64346005e31a31a52f6e616f8faff72cfe5d2 on aviemzur:shade-guava-generically** into **9ad01fb1501a5b40b80791d051c040a13224acf7 on apache:master**.

              </div></li><li><div>
                
Refer to this link for build results (access rights to CI server needed): 
https://builds.apache.org/job/beam_PreCommit_Java_MavenInstall/8378/
--none--
              </div></li><li><div>
                * Rebased on top of master.
* Added ServiceResourceTransformer to the common shading configuration to match what was done in #2182 

If there are modules which do not need to shade and relocate Guava - for example if they actively need to not do this and/or we feel that their file size has inflated without any reason - we can add the following &lt;plugin&gt; node to their `&lt;build&gt;&lt;plugins&gt;` to "opt-out" of the default shading configuration:
```xml
&lt;plugin&gt;
  &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
  &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;bundle-and-repackage&lt;/id&gt;
      &lt;phase&gt;none&lt;/phase&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;
```

Another way to tackle large file sizes would be to configure minimization by default.

I think we should start a minimization track separately from this change, as there are some issues with it:
1. There is a bug in shade-plugin where if minimization is declared on a project with pom packaging it fails. I have created a [ticket](https://issues.apache.org/jira/browse/MSHADE-253) and [PR](https://github.com/apache/maven-plugins/pull/107) with a fix for this but could take a while before it is available to us.
2. Minimization on all of our modules adds a significant amount of build time, which, as discussed, we wish to avoid. (Up from 02:30 mins for a build skipping tests on my laptop to over 5 mins)
              </div></li><li><div>
                @aviemzur, btw, I noticed the version of the shade plugin went down. Was this intentional? If yes, great. If not, perhaps push a separate PR to get it back up.
              </div></li></ol></div><div><b>github_pulls_reviews:</b> <ol><li><div>
                this looks like it's being lost. Is this right?
              </div></li><li><div>
                how do we ensure this only executes in the modules that use guava?

What happens in the modules that need to shade more than guava?
              </div></li><li><div>
                same q?
              </div></li><li><div>
                All the tests pass without this, so I'm not sure why this is needed?
              </div></li><li><div>
                This will execute in every module, to ensure forward compatability, when new modules are introduced, they will not need to know they should shade guava and add this shading to the pom, this will happen automatically. (If they don't depend on guava, no extra classes will be shaded into the resulting jar).

For modules that need to shade more than guava we should ask the following: 
Should this artifact be shaded in all modules that will use it?
If so: add it to the root pom
If not: override shading for that specific module.
              </div></li><li><div>
                This was added in PR #832 because the rules only shade `com.google.guava:guava` and not `com.google.guava:guava-testlib`. If we relocate symbols from `guava-testlib` without shading them, we can get runtime `ClassNotFoundException`s on projects which depend on our artifacts.

IIRC, this issue did not manifest within the the beam project structure because each project had equivalent repackaging rules and could source the repackaged `guava-testlib` symbols from its own local dependencies. I believe I ran into the issue when creating my own project that didn't have shading and consumed the shaded beam artifacts.

I've been away from Beam development for some months so unfortunately I don't have recent context on whether this is still needed.
              </div></li><li><div>
                Thanks @swegner  for your comment!

All dependencies on `guava-testlib` in the project currently are in scope `test`.

My change removes shading of test jars in modules which matched the shading rules that are in the root pom in my branch (They now do not shade their test jars)

The only test jar that remains with shading is the one of Dataflow runner, which still has this exclusion in its shade-plugin configuration: [google-cloud-dataflow-java/pom.xml](https://github.com/aviemzur/beam/blob/shade-guava-generically/runners/google-cloud-dataflow-java/pom.xml#L138)

Is this sufficient?
              </div></li><li><div>
                Sounds good to me; thanks for the thorough investigation!

(Please continue working with @dhalperi for the rest of the PR)
              </div></li></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Shade commonly used libraries (e.g. Guava) to avoid class conflicts
                </div><div><b>description:</b> Beam shades away some of its dependencies like Guava to avoid user classes from clashing with these dependencies. Some of the artifacts, e.g. KafkaIO, do not shade any classes and directly depend on potentially conflicting libraries (e.g. Guava). Also, users might manually add such libraries as dependencies.

Runners who add classes to the classpath (e.g. Hadoop) can run into conflict with multiple versions of the same class. To prevent that, we should adjust the Maven archetypes pom files used for the Quickstart to perform shading of commonly used libraries (again, Guava is often the culprit).

To prevent the problem in the first place, we should expand the shading of Guava and other libraries to all modules which make use of these. 

To solve both dimensions of the issue, we need to address:

1. Adding shading of commonly used libraries to the archetypes poms
2. Properly shade all commonly used libraries in the SDK modules

2) seems to be of highest priority since it affects users who simply use the provided IO modules.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div><div><b>body:</b> Is 1) necessary if we do 2)?

I think shading is very necessary (unfortunately) so I like this issue but I would also like to keep the example/archetype POMs as simple as possible.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> 2) is for avoiding user classes to clash with all SDK-related parts.

1) is for avoiding user classes to clash with other libraries added to the classpath which do not properly shade common libraries (e.g. Hadoop)

The archetype does not become more complicated because of 1). It should be more or less be transparent to the user who uses the archetype. 
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                Guava is one library that we should shade, but we have the same issue with Protobuf (with Hive or HBase for instance).
              </div></li><li><div>
                Maybe, more than maven-archetype we can have a "shade" module providing the shaded artifacts. Then, we use those artifacts even for our internal dependency.
              </div></li><li><div>
                Yes, Guava was just one example of a commonly used library which is backwards-incompatible.
              </div></li><li><div>
                Doesn't sound like a release blocker, so removing the Fix Versions field. This is a larger item, across all project modules -- we should definitely do this, but it requires some thought, I think.
              </div></li><li><div>
                [~davor] I agree that a general solution requires some thought.

Regarding KafkaIO this should probably be shaded in its pom for now as this is commonly used in clusters which may have a different version of guava.
I myself had my application crash in a Spark cluster due to KafkaIO not having its guava dependency shaded.

While it is true that users can shade their applications themselves it might be too much to expect them to go through this process, figure out that they have a transient dependency on a different version of guava then shade it.
              </div></li><li><div>
                [~aviemzur] I strongly agree that we should move to aggressive shading where we can. Send a PR for KafkaIO module?
              </div></li><li><div>
                [~dhalperi@google.com] Sure.
See: https://issues.apache.org/jira/browse/BEAM-1379 and https://github.com/apache/beam/pull/1906
              </div></li><li><div>
                GitHub user aviemzur opened a pull request:

    https://github.com/apache/beam/pull/2096

    [BEAM-1092] Shade commonly used libraries (e.g. Guava) to avoid class conflicts

    Be sure to do all of the following to help us incorporate your contribution
    quickly and easily:
    
     - [ ] Make sure the PR title is formatted like:
       `[BEAM-&lt;Jira issue #&gt;] Description of pull request`
     - [ ] Make sure tests pass via `mvn clean verify`. (Even better, enable
           Travis-CI on your fork and ensure the whole test matrix passes).
     - [ ] Replace `&lt;Jira issue #&gt;` in the title with the actual Jira issue
           number, if there is one.
     - [ ] If this contribution is large, please file an Apache
           [Individual Contributor License Agreement](https://www.apache.org/licenses/icla.txt).
    
    ---


You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/aviemzur/beam shade-guava-generically

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/beam/pull/2096.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #2096
    
----
commit ff322937ffddcf3f3b2333534327ff2d11a164ab
Author: Aviem Zur &lt;aviemzur@gmail.com&gt;
Date:   2017-02-24T12:42:27Z

    [BEAM-1092] Shade commonly used libraries (e.g. Guava) to avoid class conflicts

----

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/beam/pull/2096

              </div></li><li><div>
                GitHub user tgroh opened a pull request:

    https://github.com/apache/beam/pull/2256

    [BEAM-1092] Rollback global shading of Guava

    Be sure to do all of the following to help us incorporate your contribution
    quickly and easily:
    
     - [ ] Make sure the PR title is formatted like:
       `[BEAM-&lt;Jira issue #&gt;] Description of pull request`
     - [ ] Make sure tests pass via `mvn clean verify`. (Even better, enable
           Travis-CI on your fork and ensure the whole test matrix passes).
     - [ ] Replace `&lt;Jira issue #&gt;` in the title with the actual Jira issue
           number, if there is one.
     - [ ] If this contribution is large, please file an Apache
           [Individual Contributor License Agreement](https://www.apache.org/licenses/icla.txt).
    
    ---
    Revert PRs #2096 and #2249 
    
    PR #2096  has caused BigtableITs to fail, as of https://builds.apache.org/job/beam_PostCommit_Java_MavenInstall/2906/
    
    The `BigtableDataClient` has methods that return Guava types, e.g. `sampleRowKeys` returns an `ImmutableList`, and we rewrite those calls to reference the repackaged type, but we don't repackage the actual client libraries; as a result when the JVM tries to find the `sampleRowKeys(SampleRowKeysRequest) -&gt; ImmutableList&lt;SampleRowKeysResponse&gt;` it fails.
    
    We can certainly not shade guava in the google-cloud-platform IOs module; I believe it is also possible to repackage the appropriate Bigtable libraries to ensure the return types of those methods are also repackaged. However, `BigtableIO` uses classes that are defined in the `Bigtable` libraries, so we would have to force our version on users. 
    
    @davorbonaci @aviemzur 

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/tgroh/beam no_repackage_gcp_io

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/beam/pull/2256.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #2256
    
----
commit 506a2cfa0b730d9b1ec8ec07223797c697b061f1
Author: Thomas Groh &lt;tgroh@google.com&gt;
Date:   2017-03-15T22:28:45Z

    Revert "Increment shade-plugin version back to 3.0.0"
    
    This reverts commit 8f7c320846b598dc650a7b786182f7cecdd9c601.

commit dcfe32a14318d0daebad7319ba4143a25fc02be4
Author: Thomas Groh &lt;tgroh@google.com&gt;
Date:   2017-03-15T22:28:47Z

    Revert "[BEAM-1092] Replace hyphens in artifactId with dots in shading relocations"
    
    This reverts commit 2b55e0798f44e3fa644e7df1eaab43898ecf9c46.

commit 12873b9500c31b78d84ec6d52c0d9cf1a68edc39
Author: Thomas Groh &lt;tgroh@google.com&gt;
Date:   2017-03-15T22:28:49Z

    Revert "[BEAM-1092] Shade commonly used libraries (e.g. Guava) to avoid class conflicts"
    
    This reverts commit 03d78097ba0a2d55a9e8dcbaf11e0f8182f223c1.

----

              </div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/beam/pull/2256

              </div></li><li><div>
                IMO we've made Guava shaded everywhere by default, which is the biggest offender.

This bug is a little too abstract to be left unresolved (when would we close it?), so I think I'll call it resolved.

Thanks [~aviemzur]!
              </div></li></ol></div></div></html>