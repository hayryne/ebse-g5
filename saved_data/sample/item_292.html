<!DOCTYPE html><html><div class="item-title">
        Item 292
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 test writing of data to file
              </div></li><li><div>
                 parse schema, then convert back to string
              </div></li><li><div>
                 test serialization of random data
              </div></li><li><div>
                 test __eq__
              </div></li><li><div>
                 test that the round-trip didn't mess up anything
 NB: I don't think we should do this. Why enforce ordering?
              </div></li><li><div><div><b>comment:</b>  test hashcode doesn't generate infinite recursion
                </div><div><b>label:</b> code-design
                </div></div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> AVRO-199.  Make Python test schemas more readable.  Contributed by Jeff Hammerbacher.
                </div><div><b>message:</b> AVRO-199.  Make Python test schemas more readable.  Contributed by Jeff Hammerbacher.

git-svn-id: https://svn.apache.org/repos/asf/hadoop/avro/trunk@882253 13f79535-47bb-0310-9956-ffa450edef68

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Clean up schemas in testio.py
                </div><div><b>description:</b> As discussed on the mailing list, it would be nice to leverage Python's expressive string syntax to not perform lots of escaping of Avro schemas defined in code and make the schemas more readable.

This patch cleans up schemas in testio.py to make them more readable. Note that to get this to pass the tests, I had to implement a new "remove_whitespace()" helper function to replace the current naive approach to replacing whitespace (s.replace(" ", "") is not going to cut it). I also object to the round-trip string conversion test, as noted in the comments to this patch, but I'll save that change for another patch to better separate concerns.

If this code change is deemed useful, I'll convert the rest of the schemas in the Python code to leverage Python's string formatting. I have a ridiculously naive tool that I used for schema conversion that I threw up at http://github.com/hammer/avro-tools/blob/master/pprint_avsc for those interested.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                Patch for review.
              </div></li><li><div>
                Updated patch; changed "schema.__hash__()" to "schema_.__hash__()" in check()
              </div></li><li><div>
                Jeff, I haven't looked at your patch yet, but you might want to look at http://docs.python.org/library/textwrap.html#textwrap.dedent .  I bet it does something similar to "remove_whitespace", and it's in the stdlib since 2.3.

-- Philip
              </div></li><li><div>
                Nope. That only removes whitespace from the beginning of a string. The methodology I used is the most common that I have seen in other Python codebases; there's also the classic ''.join(s.split()); if you'd prefer to not import the re module, I can do that instead. I don't think this particular battery is included.
              </div></li><li><div><div><b>body:</b> One question on this patch: what do folks think of appending "_" to reserved words when you'd like to use them as variable names? In PEP 8 (), the relevant section states:

{noformat}
- single_trailing_underscore_: used by convention to avoid conflicts with
      Python keyword, e.g.

      Tkinter.Toplevel(master, class_='ClassName')
{noformat}

I changed "string" to "string_" and "schm" to "schema_" for improved readability here, but not everyone likes the trailing underscore. Happy to hear thoughts.

Thanks,
Jeff
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> This patch looks good to me in general, the use of '"xxx"' rather than "\"xxx\"" is def more readable. (still not
great but def better). Kudos on adding some comments.

I personally don't like the multi line use of """ for some of the schema definitions in this patch. I admit
this is my personal preference, but I find having these lines "stick out" of normal indentation to be 
"bad". 

Would you consider doing the following instead?

rather than:
+    expected_schema = """\
+{"type": "record",
+ "name": "Foo",
+ "fields": [{"name": "f", "type": %s, "default": %s}]}
+""" % (schemajson, defaultjson)
+    expected = schema.parse(expected_schema)

instead do:
+    expected_schema = (
+        '{"type": "record",'
+        '"name": "Foo",'
+        '"fields": [{"name": "f", "type": %s, "default": %s}]}'
+         )  % (schemajson, defaultjson)
+    expected = schema.parse(expected_schema)


                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> Unfort the indentation is lost in my prior comment ^^^, but if you look at this in the
source itself the "instead" block is properly indented, while the "rather than" block
sticks out all the way to the left.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> Yo,

Neither PEP 8 nor "Code Like a Pythonista" have an opinion on this matter. Google's python style guide says:

{noformat}
Use """ for multi-line strings rather than '''. Note, however, that it is often cleaner to use implicit line joining since multi-line strings do not flow with the indentation of the rest of the program:

No:

    print """This is pretty ugly.
Don't do this.
"""

Yes:

    print ("This is much nicer.\n"
           "Do it this way.\n")
{noformat}

I'm not sure I agree, in this case, because their "Yes" implementation destroys the natural indentation of the hierarchical data structure, as does your "instead" implementation.

I've tried to stick to two styles: single line and multi-line. You seem to be advocating a third style: multi-line, single indentation. I'm inclined to keep the number of styles to two. If you feel strongly about your preferred style, I am happy to make the change and not hold up further refactoring.

Thanks,
Jeff
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                as I said, my personal preference. I have many spoon types in the draw at home. Perhaps it's my ZK b/g, but I think a 3rd tie-breaker vote is needed. ;-) Doug usually has pretty strong opinions on this type of stuff (I know at least on the java side he has).
              </div></li><li><div><div><b>body:</b> +1 to this patch.

As for the style issue, I prefer """, but I think you can do it with good indentation.  In this case, the indentation can be fixed:

{noformat}
[0]doorstop::rubicon(231418)$python foo.py

    This is pretty clearly part of
    the print statement.
  

And you can even do trickery
to get rid of the extra spacing.

[0]doorstop::rubicon(231419)$cat foo.py
import textwrap

def f():
  print """
    This is pretty clearly part of
    the print statement.
  """

  print textwrap.dedent("""
    And you can even do trickery
    to get rid of the extra spacing.
  """)

f()
{noformat}
You don't have to do the dedent trick here, because it's JSON.  Who cares if there's a lot of spacing!

If this code wasn't testing the schema stuff so explicitly, I'd say you could just use dict(), {}, and [] to specify the schema and convert to json using simplejson.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div><div><b>body:</b> Philip, you're a genius! Removed backslashes, indented appropriately. I think this patch is good to go.
                </div><div><b>label:</b> code-design
                </div></div></li><li><div>
                I just committed this.  Thanks, Jeff.
              </div></li></ol></div></div></html>