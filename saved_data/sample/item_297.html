<!DOCTYPE html><html><div class="item-title">
        Item 297
      </div> <div class="item-details"><div><b>git_comments:</b> <ol></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> ARTEMIS-2017 Eliminate LRUCache from SelectorParser
                </div><div><b>message:</b> ARTEMIS-2017 Eliminate LRUCache from SelectorParser

The LRUCache is not thread-safe and it's usage in SelectorParser could
cause growth beyond its configured max size. Instead of modifying the
LRUCache to be thread-safe or synchronizing access to it in
SelectorParser it should just be removed since it's not on a hot path.

(cherry picked from commit 2d7c5322a79e0ffa45676e50f3453d5530af78c2)

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Eliminate LRUCache from SelectorParser
                </div><div><b>description:</b> The LRUCache is not thread-safe and it's usage in SelectorParser could cause growth beyond its configured max size. Instead of modifying the LRUCache to be thread-safe or synchronizing access to it in SelectorParser it should just be removed since it's not on a hot path.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                GitHub user jbertram opened a pull request:

    https://github.com/apache/activemq-artemis/pull/2228

    ARTEMIS-2017 SelectorParser cache not thread-safe

    

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/jbertram/activemq-artemis ARTEMIS-2017

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/activemq-artemis/pull/2228.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #2228
    
----
commit 0df3ee161194094d0adaf8e53325c4e4eec7fdcc
Author: Justin Bertram &lt;jbertram@...&gt;
Date:   2018-08-08T16:10:04Z

    ARTEMIS-2017 SelectorParser cache not thread-safe

----

              </div></li><li><div>
                Github user michaelandrepearce commented on a diff in the pull request:

    https://github.com/apache/activemq-artemis/pull/2228#discussion_r208655107
  
    --- Diff: artemis-selector/src/main/java/org/apache/activemq/artemis/selector/impl/SelectorParser.java ---
    @@ -80,11 +78,15 @@ public static BooleanExpression parse(String sql) throws FilterException {
                    StrictParser parser = new StrictParser(new StringReader(actual));
                    e = parser.JmsSelector();
                 }
    -            cache.put(sql, e);
    +            synchronized (cache) {
    --- End diff --
    
    Must be a better way than sync blocks.
    
    @franz1981 ideas? 

              </div></li><li><div>
                Github user jbertram commented on a diff in the pull request:

    https://github.com/apache/activemq-artemis/pull/2228#discussion_r208667762
  
    --- Diff: artemis-selector/src/main/java/org/apache/activemq/artemis/selector/impl/SelectorParser.java ---
    @@ -80,11 +78,15 @@ public static BooleanExpression parse(String sql) throws FilterException {
                    StrictParser parser = new StrictParser(new StringReader(actual));
                    e = parser.JmsSelector();
                 }
    -            cache.put(sql, e);
    +            synchronized (cache) {
    --- End diff --
    
    I imagine there might be a "better" option here in terms of performance than using `synchronized`, but then again this isn't exactly on the hot path.  This code is only executed when a selector/filter is first created (e.g. for a JMS consumer, for a bridge, etc.), and it is only executed once (i.e. execution isn't looped).  Most situations where cache growth is problematic (e.g. lots of consumers with lots of different selectors connecting and disconnecting often) are generally considered messaging anti-patterns anyway.  For such pathological cases using `synchronized` is potentially quite a bit faster than a complete lack of thread safety because it prevents unfettered cache growth.  In my opinion @franz1981's time is better spent elsewhere as this smacks of premature optimization.

              </div></li><li><div>
                Github user franz1981 commented on a diff in the pull request:

    https://github.com/apache/activemq-artemis/pull/2228#discussion_r208672703
  
    --- Diff: artemis-selector/src/main/java/org/apache/activemq/artemis/selector/impl/SelectorParser.java ---
    @@ -80,11 +78,15 @@ public static BooleanExpression parse(String sql) throws FilterException {
                    StrictParser parser = new StrictParser(new StringReader(actual));
                    e = parser.JmsSelector();
                 }
    -            cache.put(sql, e);
    +            synchronized (cache) {
    --- End diff --
    
    @jbertram @michaelandrepearce If it is not an hot path I thing that what Justin is suggesting makes totally sense: anyway if we can afford to put guava in place I believe that https://google.github.io/guava/releases/16.0/api/docs/com/google/common/cache/CacheBuilder.html#maximumSize(long) would be a good option too.
    It will scale with a factor specified by the concurrent level specified, but it could (I do not remember TBH) introduce some behavioural changes from the current impl.
    I understand both @michaelandrepearce and @jbertram opinions so I think that the general rule to balance changes vs effectiveness on common case apply here: I leave you decide how much this tradeoff apply here...
    I'm honored to be "summoned" :+1: 

              </div></li><li><div>
                Github user clebertsuconic commented on the issue:

    https://github.com/apache/activemq-artemis/pull/2228
  
    shouldn't you also protected get? I don't think it's thread safe.


              </div></li><li><div>
                Github user michaelandrepearce commented on a diff in the pull request:

    https://github.com/apache/activemq-artemis/pull/2228#discussion_r208765467
  
    --- Diff: artemis-selector/src/main/java/org/apache/activemq/artemis/selector/impl/SelectorParser.java ---
    @@ -80,11 +78,15 @@ public static BooleanExpression parse(String sql) throws FilterException {
                    StrictParser parser = new StrictParser(new StringReader(actual));
                    e = parser.JmsSelector();
                 }
    -            cache.put(sql, e);
    +            synchronized (cache) {
    --- End diff --
    
    I would have two points here then:
    
    If perf here isn't critical, why even bother then having an LRUCache? Removing it would remove any threading issues right.
    
    If it is critical:
    
    Then a more elegant option than sync blocks would look to update LRUCache to extend ConcurrentLinkedHashMap (https://github.com/ben-manes/concurrentlinkedhashmap) or even better full hog replace it entirely and migrate to using something like Caffeine (https://github.com/ben-manes/caffeine)

              </div></li><li><div>
                Github user jbertram commented on a diff in the pull request:

    https://github.com/apache/activemq-artemis/pull/2228#discussion_r208790685
  
    --- Diff: artemis-selector/src/main/java/org/apache/activemq/artemis/selector/impl/SelectorParser.java ---
    @@ -80,11 +78,15 @@ public static BooleanExpression parse(String sql) throws FilterException {
                    StrictParser parser = new StrictParser(new StringReader(actual));
                    e = parser.JmsSelector();
                 }
    -            cache.put(sql, e);
    +            synchronized (cache) {
    --- End diff --
    
    My guess is that the LRUCache is there mainly because it was used in Apollo and basically the whole selector implementation from Apollo was ported over to the Artemis code-base during the Apache donation process.  It is a simple mitigation against excessive parsing, but perhaps it is premature optimization as well.  I don't see a big problem with pulling it out.  It would simplify the code-base a bit and eliminate the threading problem as well.  I certainly don't see any reason to invest resources into a more robust/elegant/higher-performance cache implementation.

              </div></li><li><div>
                Github user jbertram commented on a diff in the pull request:

    https://github.com/apache/activemq-artemis/pull/2228#discussion_r208791390
  
    --- Diff: artemis-selector/src/main/java/org/apache/activemq/artemis/selector/impl/SelectorParser.java ---
    @@ -80,11 +78,15 @@ public static BooleanExpression parse(String sql) throws FilterException {
                    StrictParser parser = new StrictParser(new StringReader(actual));
                    e = parser.JmsSelector();
                 }
    -            cache.put(sql, e);
    +            synchronized (cache) {
    --- End diff --
    
    FWIW, the LRUCache is also used in `org.apache.activemq.artemis.core.protocol.openwire.OpenWireProtocolManager` and access is controlled with `synchronized` blocks.

              </div></li><li><div>
                Github user jbertram commented on the issue:

    https://github.com/apache/activemq-artemis/pull/2228
  
    @clebertsuconic, I updated to protect `get()` as well.

              </div></li><li><div>
                Github user michaelandrepearce commented on a diff in the pull request:

    https://github.com/apache/activemq-artemis/pull/2228#discussion_r208822183
  
    --- Diff: artemis-selector/src/main/java/org/apache/activemq/artemis/selector/impl/SelectorParser.java ---
    @@ -80,11 +78,15 @@ public static BooleanExpression parse(String sql) throws FilterException {
                    StrictParser parser = new StrictParser(new StringReader(actual));
                    e = parser.JmsSelector();
                 }
    -            cache.put(sql, e);
    +            synchronized (cache) {
    --- End diff --
    
    On that then, i would simply remove the use in the SelectorParser for this particular case.
    
    Re the actual class, if its used in OpenWireProtocolManager then it would suggest the LRUCache is being used beyond its original scope and should move out of its current location into common util, if it is to be re-used in other area's and then if it is to slowly be used in other areas such us the protocol manager, it may warrant some future efforts to harden it. 

              </div></li><li><div>
                Github user michaelandrepearce commented on the issue:

    https://github.com/apache/activemq-artemis/pull/2228
  
    LGTM

              </div></li><li><div><div><b>body:</b> Commit 2d7c5322a79e0ffa45676e50f3453d5530af78c2 in activemq-artemis's branch refs/heads/master from [~jbertram]
[ https://git-wip-us.apache.org/repos/asf?p=activemq-artemis.git;h=2d7c532 ]

ARTEMIS-2017 Eliminate LRUCache from SelectorParser

The LRUCache is not thread-safe and it's usage in SelectorParser could
cause growth beyond its configured max size. Instead of modifying the
LRUCache to be thread-safe or synchronizing access to it in
SelectorParser it should just be removed since it's not on a hot path.

                </div><div><b>label:</b> requirement
                </div></div></li><li><div>
                Github user asfgit closed the pull request at:

    https://github.com/apache/activemq-artemis/pull/2228

              </div></li><li><div>
                Commit b9a85bdaa52ef6cdc764278aad19e96a427d59de in activemq-artemis's branch refs/heads/2.6.x from [~jbertram]
[ https://git-wip-us.apache.org/repos/asf?p=activemq-artemis.git;h=b9a85bd ]

ARTEMIS-2017 Eliminate LRUCache from SelectorParser

The LRUCache is not thread-safe and it's usage in SelectorParser could
cause growth beyond its configured max size. Instead of modifying the
LRUCache to be thread-safe or synchronizing access to it in
SelectorParser it should just be removed since it's not on a hot path.

(cherry picked from commit 2d7c5322a79e0ffa45676e50f3453d5530af78c2)

              </div></li></ol></div></div></html>