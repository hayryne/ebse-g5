<!DOCTYPE html><html><div class="item-title">
        Item 328
      </div> <div class="item-details"><div><b>git_comments:</b> <ol><li><div>
                 for versioning 
              </div></li><li><div>
                
 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.
 The ASF licenses this file to You under the Apache License, Version 2.0
 (the "License"); you may not use this file except in compliance with
 the License.  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

              </div></li><li><div>
                 Minimal solrconfig.xml with /select, /admin and /update only 
              </div></li><li><div>
                
 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.
 The ASF licenses this file to You under the Apache License, Version 2.0
 (the "License"); you may not use this file except in compliance with
 the License.  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

              </div></li><li><div>
                 for versioning 
              </div></li><li><div>
                
 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.
 The ASF licenses this file to You under the Apache License, Version 2.0
 (the "License"); you may not use this file except in compliance with
 the License.  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

              </div></li><li><div>
                
 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.
 The ASF licenses this file to You under the Apache License, Version 2.0
 (the "License"); you may not use this file except in compliance with
 the License.  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

              </div></li><li><div>
                 Minimal solrconfig.xml with JMX enabled 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 
              </div></li><li><div>
                 delete the collection
              </div></li><li><div>
                 I have two replicas, one for each shard
              </div></li><li><div>
                 TODO: Isn't this a bug?
              </div></li><li><div>
                 And let's fail one more time because to ensure that the math doesn't do weird stuff it we have more replicas
              </div></li><li><div>
                 wait for recoveries to finish, for a clean shutdown - see SOLR-9645
              </div></li><li><div>
                 Adding a replica on a dead node should fail
              </div></li><li><div>
                 TODO - WTF? shouldn't this *not* contain the collection?
              </div></li><li><div>
                 create the collections node, but nothing else
              </div></li><li><div>
                 manually create a collections zknode
              </div></li><li><div>
                 delete via API - should remove collections node
              </div></li><li><div>
                 TODO - should we remove this behaviour?
              </div></li><li><div>
                 create a core that simulates something left over from a partially-deleted collection
              </div></li><li><div>
                 missing required collection parameter
              </div></li><li><div>
                 TODO - the local state is cached and causes the request to fail with 'unknown shard'
 assertEquals(1, cluster.getSolrClient().query(collection, new SolrQuery("*:*").setParam(_ROUTE_, "x")).getResults().getNumFound());
              </div></li><li><div>
                 nocommit improve this!
              </div></li><li><div>
                 need to close before the MiniDFSCluster
              </div></li><li><div>
                @Nightly
              </div></li><li><div>
                 need to close before the MiniDFSCluster
              </div></li><li><div>
                *
   * Gets all replicas that match a predicate
   
              </div></li><li><div>
                 non-final due to injectChaos()
              </div></li></ol></div><div><b>git_commits:</b> <ol><li><div><div><b>summary:</b> SOLR-9132: Cut over some collections API and recovery tests
                </div><div><b>message:</b> SOLR-9132: Cut over some collections API and recovery tests

                </div></div></li></ol></div><div><b>github_issues:</b> <ol></ol></div><div><b>github_issues_comments:</b> <ol></ol></div><div><b>github_pulls:</b> <ol></ol></div><div><b>github_pulls_comments:</b> <ol></ol></div><div><b>github_pulls_reviews:</b> <ol></ol></div><div><b>jira_issues:</b> <ol><li><div><div><b>summary:</b> Cut over AbstractDistribZkTestCase tests to SolrCloudTestCase
                </div><div><b>description:</b> We need to remove AbstractDistribZkTestCase if we want to move away from legacy cloud configurations.  This issue is for migrating tests to SolrCloudTestCase instead.
                </div></div></li></ol></div><div><b>jira_issues_comments:</b> <ol><li><div>
                This patch moves the following tests:
* ConnectionReuseTest
* CleanupOldIndexTest
* CloudExitableDirectoryTest
* ConfigSetsAPITest
* DistribDocExpirationUpdateProcessorTest
* DistributedVersionInfoTest
* DistributedQueryComponentOptimizationTest
* CloudMLTQParserTest

It also fixes a bug in the MLTQParser, whereby the qparser will throw an exception if it's given a dynamic field.
              </div></li><li><div>
                Should I create new JIRAs for all the test batches I do, or just use this as an umbrella JIRA?  There are a lot of tests to cut over, and the patches for each set will be pretty big.  I'm trying to keep things grokable.
              </div></li><li><div>
                IMO you need not create separate issues.  I also think you needn't upload patches and wait for review since you've already uploaded one for the first batch of tests you converted which got some feedback (Hoss).  So in a sense that's a bit of a template for what you're doing with the rest.  It's definitely nice to know, in advance, which batch of tests your tackling.
              </div></li><li><div>
                Commit ee5836746c53038621be09e886bc802b7eb2e7ae in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ee58367 ]

SOLR-9132: Move some tests to SolrCloudTestBase

              </div></li><li><div>
                Commit f1e870c016147e43c3ef4a6aab5851f69bc97c1c in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f1e870c ]

SOLR-9132: Move some tests to SolrCloudTestBase

              </div></li><li><div>
                Thanks David.  I'll comment on here with the contents of each batch, and include this JIRA number on all the commits.
              </div></li><li><div>
                Commit 0132d58e551e388a305fff336e062c8ebc9a1684 in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=0132d58 ]

SOLR-9132: Add some logging to ConnectionReuseTest for debugging

              </div></li><li><div>
                Commit 6c37541618b080e1d44607dd29d56626b7fd1ccc in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6c37541 ]

SOLR-9132: Fix request-counting logic in ConnectionReuseTest

              </div></li><li><div>
                Commit a35057fff278e25ad65a90d88ae85b8eec635b8b in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a35057f ]

SOLR-9132: Fix request-counting logic in ConnectionReuseTest

              </div></li><li><div>
                Commit 196f4530a29a95060bdd0ed464eebc177c5558f2 in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=196f453 ]

Revert "SOLR-9132: Fix request-counting logic in ConnectionReuseTest"

The logic for request-counting is different in master and 6.x, due to the
difference in HttpClient implementations.

This reverts commit a35057fff278e25ad65a90d88ae85b8eec635b8b.

              </div></li><li><div>
                Starting to work on these again.  Here's a patch cutting over DeleteReplicaTest and DeleteInactiveReplicaTest.  In addition to migrating the tests, it adds the following:
* static methods on CollectionAdminRequest for deleting replicas from a specific shard, or for deleting replicas on all shards
* a static method on CoreAdminRequest for getting the status of a particular core, and a CoreStatus object to encapsulate things
* the ability to assign cluster properties on configuration in SolrCloudTestCase
* helper methods to select random slices and replicas from a collection state
* helper methods to wait for specific collection states before continuing with a test
* a method on MiniSolrCloudCluster to get the jetty for a specific replica

I'll commit later on today
              </div></li><li><div>
                From CollectionAdminRequest.DeleteReplica:
{code}
-        params.set(COUNT_PROP, deleteIndexDir);
+        params.set(COUNT_PROP, count);
{code}

This was a bug with SOLR-9319, right? Can you please commit this separately and call out SOLR-9319 in the commit message?
              </div></li><li><div>
                Oh yes, good plan.
              </div></li><li><div>
                Looking at this further, it's not just the bug with the count parameter called out above, but a bunch of other problems with DeleteReplica (it expects a specific shard name, etc) - SOLR-9319 tests it using straight SolrParams rather than using a CollectionAdminRequest.  So maybe I should just commit the patch as a whole, but include SOLR-9319 in the commit message?
              </div></li><li><div>
                bq. So maybe I should just commit the patch as a whole, but include SOLR-9319 in the commit message?

+1
              </div></li><li><div>
                Commit 11a98a89fd63271f969ae1072159c410ad6417cc in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=11a98a8 ]

SOLR-9132: Cut over DeleteReplica tests

Also fixes some bugs in CollectionAdminRequest.DeleteReplica from SOLR-9319

              </div></li><li><div>
                Commit be4233cb567a8e65ef67d0fc1c8e47936e155a23 in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=be4233c ]

SOLR-9132: Cut over DeleteReplica tests

Also fixes some bugs in CollectionAdminRequest.DeleteReplica from SOLR-9319

              </div></li><li><div>
                Next batch, cutting over the following tests:
* AliasIntegrationTest
* AsyncCallRequestStatusResponseTest
* CollectionReloadTest
* CollectionStateFormat2Test
* MigrateRouteKeyTest
* AsyncMigrateRouteKeyTest (folded into the above)
* RulesTest

It also:
* adds static methods to CollectionAdminRequest to help creating collections using the default config, and collections using the implicit router
* adds getCoreStartTime to the CoreStatus object
* adds a method to MiniSolrCloudCluster to expire the ZK connection to a specific jetty
              </div></li><li><div>
                Commit 23485c33778da7520199aa0757d2bd02ef7b1a60 in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=23485c3 ]

SOLR-9132: Migrate some more tests

              </div></li><li><div>
                Commit a9dab0f25aaea903fe846f91ff0968f16b685851 in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=a9dab0f ]

SOLR-9132: Migrate some more tests

              </div></li><li><div>
                Commit 3bcecd9e55b191053f102fef64a26e1b88aa9ab3 in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3bcecd9 ]

SOLR-9132: Mark MigrateRouteKey test as slow

              </div></li><li><div>
                Commit d398617be891c9bc4ac72f85bf6ba4bff81f4f89 in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=d398617 ]

SOLR-9132: RulesTest must tear down collections at the end of each test

              </div></li><li><div>
                Commit 3d0f9425022b58337a96c2b9a347e16933ecc496 in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3d0f942 ]

SOLR-9132: RulesTest must tear down collections at the end of each test

              </div></li><li><div>
                New patch, cutting over:
* CollectionTooManyReplicasTest
* CollectionsAPIDistributedZkTest
* CustomCollectionTest
* RecoveryZkTest

Also adds some helper methods:
* UpdateRequest.withRoute()
* Slice.getReplicas(Predicate) to allow retrieval of replicas that match a predicate
* MiniSolrCloudCluster.injectChaos() to make tests that much more interesting
              </div></li><li><div>
                Commit 14cfb82bf799066b6bb91fa615b58ff4829423ba in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=14cfb82 ]

SOLR-9132: Cut over some collections API and recovery tests

              </div></li><li><div>
                Commit f56d111adf46e127c62a3fd11fdae9b9725c1024 in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=f56d111 ]

SOLR-9132: Cut over some collections API and recovery tests

              </div></li><li><div>
                [~romseygeek] you committed a "nocommit" in {{org.apache.solr.cloud.RecoveryZkTest#assertShardConsistency}} (line 143)

Also, separately, not sure if it's related to this but in my local test run, TestDeleteCollectionOnDownNodes failed due to "Timed out waiting for leader elections".  However it didn't reproduce for me -- seed B25E79F549CDBB64:2C6B1D0D6FEEF7EC
              </div></li><li><div>
                Commit bb33bb7d4c6f5547022abb2b61a844e8daaaf8fb in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=bb33bb7 ]

SOLR-9132: Fix precommit

              </div></li><li><div>
                Commit b6e0ab01743df112dd7ad49135bd33769b7773b7 in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=b6e0ab0 ]

SOLR-9132: Fix precommit

              </div></li><li><div>
                Thanks David - if it fails again, any chance you could attach the test-failures output to this issue?
              </div></li><li><div>
                Commit 6340f3b9b9902f2aaf04fd460d0ed91bd8da00e4 in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=6340f3b ]

SOLR-9132: Fix test bug

              </div></li><li><div>
                Commit cff2774a3749378a040ce417f00560b95c93e10f in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=cff2774 ]

SOLR-9132: Fix test bug

              </div></li><li><div>
                I'm attaching test failure details while I still have the file.  Feel free to ignore if you don't hear about this failure again.
              </div></li><li><div>
                Commit 9b669d72876a13221f49db09ba9f8e1a1f60487e in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=9b669d7 ]

SOLR-9132: Don't require indexInfo from corestatus over reloads

              </div></li><li><div>
                Commit 3b49705c43178fcd75dc85e56bcd2820cb35e166 in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=3b49705 ]

SOLR-9132: Don't require indexInfo from corestatus over reloads

              </div></li><li><div>
                Latest patch, cutting over some more tests.  This also fixes SOLR-9767.
              </div></li><li><div>
                Commit 183f998098b0764117d2f858df9909a4ee139cc0 in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=183f998 ]

SOLR-9132: Cut over some more tests

              </div></li><li><div>
                Commit 12aff1cfcc48d7c89008447d482bf610242e0431 in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=12aff1c ]

SOLR-9132: Cut over some more tests

              </div></li><li><div>
                Commit ed8d165350a312956b42160f033b4417a22b49f0 in lucene-solr's branch refs/heads/branch_6x from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=ed8d165 ]

SOLR-9132: Fix HDFS test

              </div></li><li><div>
                Commit 49fa7b0dd514fb9d4b7a508d80ae6f9b12cdf6b0 in lucene-solr's branch refs/heads/master from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=49fa7b0 ]

SOLR-9132: Fix HDFS test

              </div></li><li><div>
                Commit 49fa7b0dd514fb9d4b7a508d80ae6f9b12cdf6b0 in lucene-solr's branch refs/heads/apiv2 from [~romseygeek]
[ https://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=49fa7b0 ]

SOLR-9132: Fix HDFS test

              </div></li></ol></div></div></html>